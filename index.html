<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Moonberry Coffee | Y√∂netim Paneli</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- pdfmake - T√ºrk√ße karakter desteƒüi -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <style>
:root{
    /* Light Mode (Default) */
    --bg:#fafafa;--bg2:#ffffff;--bg3:#f5f5f5;--bg4:#ebebeb;
    --surface:#ffffff;--surface2:#fafafa;--surface3:#f5f5f5;
    --tx:#1a1a1a;--tx2:#555555;--tx3:#888888;
    --txdark:#1a1a1a;--txdark2:#555555;
    /* Marka Renkleri */
    --brand-coral:#ff8674;--brand-teal:#008c95;
    --accent:var(--brand-coral);--accent2:var(--brand-teal);--accentLight:rgba(255,134,116,.15);
    --green:#27ae60;--red:#e74c3c;--yellow:#f39c12;--blue:#3498db;
    --glass:rgba(255,255,255,.98);--glassBorder:rgba(0,0,0,.08);
    --shadow:0 4px 24px rgba(0,0,0,.08);--shadowSm:0 2px 8px rgba(0,0,0,.05);
    --radius:10px;--radiusSm:6px;--radiusLg:16px;
    --transition:.2s ease;
    --font:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;--mono:'JetBrains Mono',monospace;
    --cardBg:#ffffff;--cardBorder:rgba(0,0,0,.06);
    --sectionBg:#ffffff;
    --sidebarBg:#006d73;--sidebarTx:#ffffff;--sidebarTx2:#ffffff;--sidebarTx3:rgba(255,255,255,.7);
    /* Logolar */
    --logo-dark:url('https://static.wixstatic.com/media/760af2_0e846222ae5b4021930a757e498f30e9~mv2.png');
    --logo-light:url('https://static.wixstatic.com/media/760af2_755f54f13b654f1bb318c97f16a029a3~mv2.png/v1/fill/w_104,h_92,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/Moonberry%20Coffee%20Logo.png');
}
/* Dark Mode */
[data-theme="dark"]{
    --bg:#0f0f0f;--bg2:#1a1a1a;--bg3:#242424;--bg4:#333333;
    --surface:#1a1a1a;--surface2:#242424;--surface3:#2e2e2e;
    --tx:#f0f0f0;--tx2:#b0b0b0;--tx3:#707070;
    --txdark:#f0f0f0;--txdark2:#a0a0a0;
    --glass:rgba(30,30,30,.95);--glassBorder:rgba(255,255,255,.1);
    --shadow:0 8px 32px rgba(0,0,0,.4);--shadowSm:0 2px 8px rgba(0,0,0,.3);
    --cardBg:rgba(40,40,40,.95);--cardBorder:rgba(255,255,255,.08);
    --sectionBg:linear-gradient(135deg,rgba(30,30,30,.95),rgba(20,20,20,.9));
    --sidebarBg:#0f0f0f;--sidebarTx:#ffffff;--sidebarTx2:#ffffff;--sidebarTx3:rgba(255,255,255,.5);
}
[data-theme="dark"] .main{background:var(--bg)!important}
[data-theme="dark"] .page-title,[data-theme="dark"] .page-subtitle{color:var(--tx)!important}
[data-theme="dark"] .form-section{background:var(--bg2)!important;border-color:var(--bg4)!important}
[data-theme="dark"] .form-section-title{color:var(--tx)!important;border-color:var(--bg4)!important}
[data-theme="dark"] .form-label{color:var(--tx2)!important}
[data-theme="dark"] .form-input,[data-theme="dark"] .form-select,[data-theme="dark"] .form-textarea{background:var(--bg3)!important;border-color:var(--bg4)!important;color:var(--tx)!important}
[data-theme="dark"] .type-card{background:var(--bg3)!important;border-color:var(--bg4)!important}
[data-theme="dark"] .type-card-title{color:var(--tx)!important}
[data-theme="dark"] .type-card-sub{color:var(--tx2)!important}
[data-theme="dark"] .alert{background:var(--bg2)!important;border-color:var(--bg4)!important;color:var(--tx2)!important}
[data-theme="dark"] .back-link{color:var(--tx2)!important}
[data-theme="dark"] .admin-list-item{background:var(--bg3)!important;border-color:var(--bg4)!important}
[data-theme="dark"] .admin-list-item:hover{background:var(--bg4)!important}
[data-theme="dark"] .tabs{background:var(--bg3)!important}
[data-theme="dark"] .tab{color:var(--tx2)!important}
[data-theme="dark"] .tab.active{background:var(--bg2)!important;color:var(--accent)!important}
[data-theme="dark"] .dashboard-card{background:var(--cardBg)!important;border-color:var(--cardBorder)!important}
[data-theme="dark"] .dashboard-card-title{color:var(--tx)!important}
[data-theme="dark"] .dashboard-card-desc{color:var(--tx2)!important}
[data-theme="dark"] .section-card{background:var(--sectionBg)!important;border-color:var(--cardBorder)!important}
*{margin:0;padding:0;box-sizing:border-box}
html{font-size:15px}
body{font-family:var(--font);background:var(--bg);color:var(--tx);line-height:1.6;min-height:100vh;overflow-x:hidden}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--tx3)}

/* App Layout */
.app{display:flex;min-height:100vh;opacity:0;transition:opacity .3s}
.sidebar{width:260px;background:var(--sidebarBg);border-right:1px solid rgba(255,255,255,.1);display:flex;flex-direction:column;position:fixed;height:100vh;z-index:100;transition:var(--transition)}
.sidebar-header{padding:24px 20px;border-bottom:1px solid rgba(255,255,255,.1)}
.logo{display:flex;align-items:center;gap:12px}
.logo-icon{width:42px;height:42px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:var(--radius);display:flex;align-items:center;justify-content:center;font-size:1.4rem;box-shadow:0 4px 16px rgba(255,134,116,.3)}
.logo-text{font-size:1.1rem;font-weight:700;letter-spacing:-.02em;color:var(--sidebarTx)}
.logo-sub{font-size:.7rem;color:var(--sidebarTx3);margin-top:2px}
.nav{flex:1;padding:16px 12px;overflow-y:auto}
.nav-group{margin-bottom:8px}
.nav-label{font-size:.75rem;color:var(--sidebarTx2);padding:10px 14px;margin-bottom:0;font-weight:500;display:flex;align-items:center;justify-content:space-between;cursor:pointer;border-radius:var(--radiusSm);transition:var(--transition)}
.nav-label:hover{background:rgba(255,255,255,.1)}
.nav-label .nav-arrow{transition:transform .2s;font-size:.7rem}
.nav-label.collapsed .nav-arrow{transform:rotate(-90deg)}
.nav-items{overflow:hidden;transition:max-height .3s ease;max-height:500px}
.nav-items.collapsed{max-height:0}
.nav-item{display:flex;align-items:center;gap:12px;padding:10px 14px 10px 20px;border-radius:var(--radiusSm);cursor:pointer;transition:var(--transition);color:var(--sidebarTx2);font-weight:500;font-size:.85rem;margin-bottom:2px}
.nav-item:hover{background:rgba(255,134,116,.15);color:#fff}
.nav-item.active{background:linear-gradient(135deg,var(--accent),#ff6b5b);color:#fff;box-shadow:0 4px 20px rgba(255,134,116,.35);font-weight:600}
.nav-item .icon{font-size:1rem;width:20px;text-align:center;display:flex;align-items:center;justify-content:center}
.nav-item .icon svg{width:18px;height:18px;stroke:currentColor;stroke-width:2;fill:none}
.nav-divider{height:1px;background:rgba(255,255,255,.1);margin:12px 12px}

/* Main Content */
.main{flex:1;margin-left:260px;background:var(--bg);min-height:100vh;position:relative}
.main-header{position:sticky;top:0;right:0;z-index:50;display:flex;justify-content:flex-end;padding:16px 32px;background:var(--bg);border-bottom:1px solid var(--bg4)}
.page{display:none;padding:24px 32px;animation:fadeUp .3s}
.page.active{display:block}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.page-header{margin-bottom:28px}
.page-title{font-size:1.6rem;font-weight:700;color:var(--txdark);letter-spacing:-.02em}
.page-subtitle{color:var(--txdark2);font-size:.9rem;margin-top:4px}
.back-link{display:inline-flex;align-items:center;gap:6px;color:var(--txdark2);font-size:.85rem;font-weight:500;cursor:pointer;margin-bottom:16px;transition:var(--transition)}
.back-link:hover{color:var(--accent)}

/* Cards Grid */
.dashboard-section{margin-bottom:32px}
.section-title{font-size:.75rem;font-weight:600;color:var(--tx3);text-transform:uppercase;letter-spacing:.1em;margin-bottom:16px}
.cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px}
.card{background:rgba(255,255,255,.03);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:20px;cursor:pointer;transition:all .3s cubic-bezier(.4,0,.2,1);position:relative;display:flex;align-items:center;gap:16px}
.card:hover{transform:translateY(-2px);background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.12);box-shadow:0 20px 40px rgba(0,0,0,.3)}
.card-icon{width:48px;height:48px;border-radius:14px;display:flex;align-items:center;justify-content:center;color:#fff;flex-shrink:0}
.card-content{flex:1;min-width:0}
.card-title{font-size:.95rem;font-weight:600;color:var(--tx);margin-bottom:4px}
.card-desc{font-size:.8rem;color:var(--tx3);line-height:1.4}

/* Legacy card styles for other pages */
.card-icon.orange{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff}
.card-icon.coral{background:linear-gradient(135deg,#ff8674,#ff6b5b);color:#fff}
.card-icon.teal{background:linear-gradient(135deg,#008c95,#00a8a8);color:#fff}
.card-icon.green{background:linear-gradient(135deg,#27ae60,#2ecc71);color:#fff}
.card-icon.red{background:linear-gradient(135deg,#e74c3c,#c0392b);color:#fff}
.card-icon.blue{background:linear-gradient(135deg,#008c95,#4db6ac);color:#fff}
.card-icon.purple{background:linear-gradient(135deg,#ff8674,#008c95);color:#fff}

/* Form Elements */
.form-section{background:var(--surface);border:1px solid var(--surface3);border-radius:var(--radius);padding:24px;margin-bottom:20px}
.form-section-title{font-size:.95rem;font-weight:600;color:var(--txdark);margin-bottom:20px;padding-bottom:12px;border-bottom:1px solid var(--surface3);display:flex;align-items:center;gap:10px}
.form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
.form-group{display:flex;flex-direction:column;gap:6px}
.form-group.full{grid-column:span 2}
.form-label{font-size:.8rem;font-weight:500;color:var(--txdark2)}
.form-input,.form-select,.form-textarea{padding:12px 14px;background:var(--surface2);border:1.5px solid var(--surface3);border-radius:var(--radiusSm);color:var(--txdark);font-size:.9rem;font-family:var(--font);transition:var(--transition)}
.form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--accent);background:var(--surface);box-shadow:0 0 0 3px rgba(255,134,116,.15)}
.form-textarea{resize:vertical;min-height:100px}
.form-input::placeholder{color:var(--txdark2);opacity:.6}

/* Type Cards */
.type-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
.type-card{background:var(--surface2);border:2px solid transparent;border-radius:var(--radiusSm);padding:16px;cursor:pointer;transition:var(--transition);text-align:center}
.type-card:hover{border-color:var(--accent);background:var(--surface)}
.type-card.selected{border-color:var(--accent);background:var(--accentLight)}
.type-card-icon{font-size:1.5rem;margin-bottom:8px}
.type-card-title{font-size:.9rem;font-weight:600;color:var(--txdark)}
.type-card-sub{font-size:.75rem;color:var(--txdark2);margin-top:2px}

/* Buttons */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 24px;border-radius:var(--radiusSm);font-size:.9rem;font-weight:600;cursor:pointer;transition:var(--transition);border:none;font-family:var(--font)}
.btn:focus{outline:none;box-shadow:0 0 0 3px rgba(255,134,116,.3)}
.btn-primary{background:linear-gradient(135deg,var(--accent),#ff6b5b);color:#fff}
.btn-primary:hover{background:linear-gradient(135deg,var(--accent2),#007a82);box-shadow:0 4px 20px rgba(255,134,116,.35)}
.btn-secondary{background:var(--surface3);color:var(--txdark)}
.btn-secondary:hover{background:var(--surface2);border-color:var(--accent)}
.btn-danger{background:linear-gradient(135deg,#e74c3c,#c0392b);color:#fff}
.btn-danger:hover{background:linear-gradient(135deg,#c0392b,#a93226);box-shadow:0 4px 16px rgba(231,76,60,.3)}
.btn-ghost{background:transparent;color:var(--txdark2);border:1.5px solid var(--surface3)}
.btn-ghost:hover{border-color:var(--accent);color:var(--accent);background:rgba(255,134,116,.05)}
.btn-group{display:flex;gap:12px;margin-top:24px;flex-wrap:wrap}
.btn-sm{padding:8px 16px;font-size:.8rem}

/* Alert Boxes */
.alert{padding:16px 20px;border-radius:var(--radiusSm);margin-bottom:20px;display:flex;align-items:flex-start;gap:12px;font-size:.85rem}
.alert-icon{font-size:1.2rem;flex-shrink:0}
.alert-warning{background:#fef9e7;border:1px solid #f9e79f;color:#7d6608}
.alert-danger{background:#fdedec;border:1px solid #f5b7b1;color:#922b21}
.alert-info{background:#ebf5fb;border:1px solid #aed6f1;color:#1a5276}
.alert-success{background:#e9f7ef;border:1px solid #abebc6;color:#1e8449}

/* Tabs */
.tabs{display:flex;gap:4px;background:var(--surface3);padding:4px;border-radius:var(--radiusSm);margin-bottom:20px}
.tab{flex:1;padding:10px 16px;border:none;background:transparent;color:var(--txdark2);font-size:.85rem;font-weight:600;cursor:pointer;border-radius:6px;transition:var(--transition);font-family:var(--font)}
.tab:hover{color:var(--txdark);background:rgba(255,134,116,.08)}
.tab.active{background:linear-gradient(135deg,var(--accent),#ff6b5b);color:#fff;box-shadow:0 2px 8px rgba(255,134,116,.25)}

/* Violation List */
.violation-list{display:flex;flex-direction:column;gap:10px}
.violation-item{background:var(--surface2);border:1px solid var(--surface3);border-radius:var(--radiusSm);padding:16px;cursor:pointer;transition:var(--transition)}
.violation-item:hover{border-color:var(--accent);background:var(--surface)}
.violation-header{display:flex;align-items:center;justify-content:space-between}
.violation-title{font-weight:600;font-size:.9rem;color:var(--txdark)}
.violation-badge{padding:4px 10px;border-radius:20px;font-size:.7rem;font-weight:600;text-transform:uppercase}
.violation-badge.low{background:#d5f5e3;color:#1e8449}
.violation-badge.medium{background:#fef9e7;color:#7d6608}
.violation-badge.high{background:#fdedec;color:#922b21}
.violation-legal{font-size:.8rem;color:var(--txdark2);margin-top:6px}

/* Dashboard Cards */
.dashboard-card{transition:all .25s cubic-bezier(.4,0,.2,1)!important}
.dashboard-card:hover{transform:translateY(-4px);box-shadow:0 12px 28px rgba(255,134,116,.15)!important;border-color:var(--accent)!important}
.dashboard-section{margin-bottom:32px}

/* Preview */
.preview-container{background:var(--surface);border:1px solid var(--surface3);border-radius:var(--radius);overflow:hidden}
.preview-toolbar{background:var(--surface2);padding:14px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--surface3)}
.preview-title{font-weight:600;font-size:.9rem;color:var(--txdark)}
.preview-actions{display:flex;gap:8px}
.preview-content{padding:40px;background:#fff;min-height:500px}

/* Document Styles - PDF Optimized */
.doc{max-width:800px;margin:0 auto;font-size:10pt;line-height:1.6;color:#000;font-family:'Times New Roman',serif}
.doc-header{text-align:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #000}
.doc-company{font-size:10pt;font-weight:700}
.doc-company-info{font-size:8pt;color:#444;margin-top:2px}
.doc-title{font-size:12pt;font-weight:700;margin:15px 0;text-decoration:underline}
.doc-section{margin-bottom:12px}
.doc-section-title{font-size:10pt;font-weight:700;margin-bottom:6px;border-bottom:1px solid #ccc;padding-bottom:3px}
.doc-article{margin-bottom:8px}
.doc-article-title{font-weight:700;margin-bottom:2px;font-size:10pt}
.doc-article-content{margin-left:10px;text-align:justify;font-size:9.5pt;line-height:1.4}
.doc-article-content p{margin:4px 0}
.doc-signature-area{display:grid;grid-template-columns:1fr 1fr;gap:40px;margin-top:35px}
.doc-signature-block{text-align:center}
.doc-signature-title{font-weight:600;margin-bottom:40px;font-size:10pt}
.doc-signature-line{border-top:1px solid #000;padding-top:5px;font-size:9pt}
.doc p{margin:4px 0;font-size:9.5pt}
.no-break{page-break-inside:avoid}

/* Modal System */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);z-index:9000;display:flex;align-items:center;justify-content:center;opacity:0;visibility:hidden;transition:var(--transition)}
.modal-overlay.show{opacity:1;visibility:visible}
.modal{background:var(--surface);border-radius:var(--radiusLg);max-width:480px;width:90%;max-height:90vh;overflow:hidden;transform:scale(.9);transition:var(--transition);box-shadow:var(--shadow)}
.modal-overlay.show .modal{transform:scale(1)}
.modal-header{padding:20px 24px;border-bottom:1px solid var(--surface3);display:flex;align-items:center;justify-content:space-between}
.modal-title{font-size:1.1rem;font-weight:700;color:var(--txdark)}
.modal-close{width:32px;height:32px;border-radius:50%;border:none;background:var(--surface3);color:var(--txdark2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.2rem;transition:var(--transition)}
.modal-close:hover{background:var(--red);color:#fff}
.modal-body{padding:24px;max-height:60vh;overflow-y:auto}
.modal-footer{padding:16px 24px;border-top:1px solid var(--surface3);display:flex;justify-content:flex-end;gap:12px}
.modal-icon{width:64px;height:64px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:2rem;margin:0 auto 20px}
.modal-icon.success{background:#e9f7ef;color:var(--green)}
.modal-icon.warning{background:#fef9e7;color:var(--yellow)}
.modal-icon.danger{background:#fdedec;color:var(--red)}
.modal-icon.info{background:#ebf5fb;color:var(--blue)}
.modal-message{text-align:center;color:var(--txdark2);font-size:.95rem;line-height:1.6}

/* Toast */
.toast-container{position:fixed;bottom:24px;right:24px;z-index:9999;display:flex;flex-direction:column;gap:10px}
.toast{background:var(--bg2);color:var(--tx);padding:14px 20px;border-radius:var(--radiusSm);font-size:.85rem;font-weight:500;box-shadow:var(--shadow);display:flex;align-items:center;gap:10px;transform:translateX(120%);transition:var(--transition);border-left:3px solid var(--accent)}
.toast.show{transform:translateX(0)}
.toast.success{border-color:var(--green)}
.toast.error{border-color:var(--red)}
.toast-icon{font-size:1.1rem}

/* Admin Panel */
.admin-tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:24px}
.admin-tab{padding:10px 20px;background:var(--surface2);border:1.5px solid var(--surface3);border-radius:var(--radiusSm);color:var(--txdark2);font-size:.85rem;font-weight:600;cursor:pointer;transition:var(--transition)}
.admin-tab:hover{border-color:var(--accent);color:var(--accent);background:rgba(255,134,116,.05)}
.admin-tab.active{background:linear-gradient(135deg,var(--accent),#ff6b5b);border-color:var(--accent);color:#fff;box-shadow:0 2px 12px rgba(255,134,116,.25)}
.admin-section{display:none;animation:fadeUp .3s}
.admin-section.active{display:block}
.admin-card{background:var(--surface2);border:1px solid var(--surface3);border-radius:var(--radiusSm);padding:20px;margin-bottom:16px}
.admin-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.admin-card-title{font-weight:600;color:var(--txdark);font-size:.95rem}
.admin-list{display:flex;flex-direction:column;gap:8px}
.admin-list-item{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--surface);border:1px solid var(--surface3);border-radius:6px}
.admin-list-item-text{font-size:.9rem;color:var(--txdark)}
.admin-list-item-actions{display:flex;gap:8px}
.admin-btn-icon{width:32px;height:32px;border-radius:6px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--transition);font-size:.9rem}
.admin-btn-edit{background:var(--surface3);color:var(--txdark2)}
.admin-btn-edit:hover{background:var(--accent);color:#fff}
.admin-btn-delete{background:var(--surface3);color:var(--txdark2)}
.admin-btn-delete:hover{background:var(--red);color:#fff}
.sync-code-area{background:var(--bg2);border:1px solid var(--bg4);border-radius:var(--radiusSm);padding:16px;margin:16px 0}
.sync-code-text{width:100%;min-height:120px;background:var(--bg);border:1px solid var(--bg4);border-radius:6px;padding:12px;color:var(--tx);font-family:var(--mono);font-size:.8rem;resize:vertical}
.sync-actions{display:flex;gap:12px;margin-top:12px}

/* Permission Checkboxes */
.perm-cb{cursor:pointer;transition:transform .15s}
.perm-cb:hover{transform:scale(1.1)}
.perm-cb:checked{animation:checkPop .2s ease}
@keyframes checkPop{0%{transform:scale(.8)}50%{transform:scale(1.2)}100%{transform:scale(1)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

/* Responsive */
@media(max-width:768px){
    .sidebar{transform:translateX(-100%)}
    .sidebar.open{transform:translateX(0)}
    .main{margin-left:0}
    .form-grid{grid-template-columns:1fr}
    .form-group.full{grid-column:span 1}
    .cards{grid-template-columns:1fr}
}
@media print{
    .sidebar,.back-link,.preview-toolbar,.btn-group{display:none!important}
    .main{margin:0;background:#fff}
    .page{padding:0}
    .preview-container{border:none;box-shadow:none}
}
    </style>
</head>
<body>
    <!-- AUTH GUARD - Giri≈ü yapmamƒ±≈üsa login.html'e y√∂nlendir -->
    <script>
        (function() {
            const checkAuth = setInterval(() => {
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    clearInterval(checkAuth);
                    firebase.auth().onAuthStateChanged(user => {
                        if (!user) {
                            window.location.replace('login.html');
                        }
                    });
                }
            }, 50);
            setTimeout(() => {
                clearInterval(checkAuth);
                if (typeof firebase === 'undefined' || !firebase.auth().currentUser) {
                    window.location.replace('login.html');
                }
            }, 3000);
        })();
    </script>

    <!-- Modal System -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Modal</div>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- App -->
    <div class="app">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo" onclick="goTo('dashboard')" style="cursor:pointer" title="Ana Sayfaya D√∂n">
                    <img id="sidebarLogo" src="https://static.wixstatic.com/media/760af2_cb121a61291f4f07adb48cfb70f3e2d9~mv2.png/v1/fill/w_94,h_82,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/beyazwhitelogo-min1.png" alt="Logo" style="width:40px;height:auto">
                    <div>
                        <div class="logo-text">Moonberry</div>
                        <div class="logo-sub">Y√∂netim Paneli</div>
                    </div>
                </div>
            </div>
            <nav class="nav">
                <!-- Ana Sayfa -->
                <div class="nav-item active" data-page="dashboard" onclick="goTo('dashboard')">
                    <span class="icon"><svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></span> Ana Sayfa
                </div>
                
                <!-- Puantaj -->
                <div class="nav-item" data-page="puantaj" onclick="goTo('puantaj')">
                    <span class="icon"><svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></span> Puantaj
                </div>
                
                <!-- Shift Planƒ± -->
                <div class="nav-item" data-page="shift" onclick="goTo('shift')">
                    <span class="icon"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></span> Shift Planƒ±
                </div>
                
                <!-- Checklist -->
                <div class="nav-item" data-page="checklist" onclick="goTo('checklist')">
                    <span class="icon"><svg viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg></span> Checklist
                </div>
                
                <!-- Personel -->
                <div class="nav-item" data-page="personel" onclick="goTo('personel')">
                    <span class="icon"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></span> Personel
                </div>
                
                <div class="nav-divider"></div>
                
                <!-- Belgeler (Collapsible - Kapalƒ± ba≈üla) -->
                <div class="nav-group">
                    <div class="nav-label collapsed" onclick="toggleNavGroup(this)">
                        üìÑ Belgeler <span class="nav-arrow">‚ñº</span>
                    </div>
                    <div class="nav-items collapsed">
                        <div class="nav-item" data-page="sozlesme" onclick="goTo('sozlesme')">
                            <span class="icon"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></span> ƒ∞≈ü S√∂zle≈ümesi
                        </div>
                        <div class="nav-item" data-page="tutanak" onclick="goTo('tutanak')">
                            <span class="icon"><svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></span> Tutanak
                        </div>
                        <div class="nav-item" data-page="savunma" onclick="goTo('savunma')">
                            <span class="icon"><svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></span> Savunma ƒ∞steme
                        </div>
                        <div class="nav-item" data-page="fesih" onclick="goTo('fesih')">
                            <span class="icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg></span> Fesih
                        </div>
                        <div class="nav-item" data-page="istifa" onclick="goTo('istifa')">
                            <span class="icon"><svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></span> ƒ∞stifa
                        </div>
                        <div class="nav-item" data-page="ibraname" onclick="goTo('ibraname')">
                            <span class="icon"><svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></span> ƒ∞braname
                        </div>
                    </div>
                </div>
                
                <!-- Formlar (Collapsible - Kapalƒ± ba≈üla) -->
                <div class="nav-group">
                    <div class="nav-label collapsed" onclick="toggleNavGroup(this)">
                        üìë Formlar <span class="nav-arrow">‚ñº</span>
                    </div>
                    <div class="nav-items collapsed">
                        <div class="nav-item" data-page="borc" onclick="goTo('borc')">
                            <span class="icon"><svg viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></span> Bor√ß ƒ∞krar
                        </div>
                        <div class="nav-item" data-page="avans" onclick="goTo('avans')">
                            <span class="icon"><svg viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg></span> Avans Talebi
                        </div>
                        <div class="nav-item" data-page="zimmet" onclick="goTo('zimmet')">
                            <span class="icon"><svg viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg></span> Zimmet Formu
                        </div>
                    </div>
                </div>
                
                <div class="nav-divider"></div>
                
                <!-- ƒ∞hlal Kataloƒüu (tek ba≈üƒ±na) -->
                <div class="nav-item" data-page="katalog" onclick="goTo('katalog')">
                    <span class="icon"><svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg></span> ƒ∞hlal Kataloƒüu
                </div>
                
                <!-- Ayarlar (en altta) -->
                <div class="nav-item" data-page="admin" onclick="openAdminWithPin()">
                    <span class="icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></span> Ayarlar
                </div>
                <!-- Kullanƒ±cƒ± Bilgisi ve √áƒ±kƒ±≈ü -->
                <div style="margin-top:auto;padding:16px 20px;border-top:1px solid rgba(255,255,255,.1)">
                    <!-- Impersonation Banner -->
                    <div id="impersonationBanner" style="display:none;background:rgba(255,134,116,.2);border:1px solid var(--accent);border-radius:8px;padding:10px;margin-bottom:12px;text-align:center">
                        <div style="font-size:.75rem;color:var(--accent);font-weight:600">üëÅÔ∏è G√∂r√ºnt√ºleme Modu</div>
                        <div id="impersonatingAs" style="font-size:.8rem;color:#fff;margin:4px 0"></div>
                        <button onclick="exitImpersonation()" style="padding:6px 12px;background:var(--accent);border:none;border-radius:6px;color:#fff;font-size:.75rem;cursor:pointer;margin-top:4px">√áƒ±kƒ±≈ü</button>
                    </div>
                    <div id="userInfo" style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                        <div style="width:36px;height:36px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:.9rem;color:#fff;font-weight:600" id="userAvatar">üë§</div>
                        <div style="flex:1;overflow:hidden">
                            <div id="userName" style="color:var(--sidebarTx);font-size:.85rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">Y√ºkleniyor...</div>
                            <div id="userRole" style="color:var(--sidebarTx2);font-size:.7rem">-</div>
                        </div>
                    </div>
                    <!-- Kullanƒ±cƒ± Deƒüi≈ütir Butonu (Sadece Y√∂netici) -->
                    <button id="btnImpersonate" onclick="showImpersonationModal()" style="display:none;width:100%;padding:10px;background:rgba(0,140,149,.15);border:1px solid rgba(0,140,149,.3);border-radius:8px;color:var(--accent2);font-size:.8rem;cursor:pointer;transition:all .2s;margin-bottom:8px;align-items:center;justify-content:center;gap:8px" onmouseover="this.style.background='rgba(0,140,149,.25)'" onmouseout="this.style.background='rgba(0,140,149,.15)'">
                        üëÅÔ∏è Kullanƒ±cƒ± G√∂z√ºnden G√∂r
                    </button>
                    <button onclick="logout()" style="width:100%;padding:10px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);border-radius:8px;color:var(--sidebarTx2);font-size:.8rem;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:8px" onmouseover="this.style.background='rgba(231,76,60,.2)';this.style.borderColor='rgba(231,76,60,.4)';this.style.color='#e74c3c'" onmouseout="this.style.background='rgba(255,255,255,.1)';this.style.borderColor='rgba(255,255,255,.15)';this.style.color='var(--sidebarTx2)'">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                        √áƒ±kƒ±≈ü Yap
                    </button>
                </div>
            </nav>
        </aside>

        <main class="main">
            <!-- Global Header with Breadcrumb and Dark Mode -->
            <div class="main-header" style="display:flex;justify-content:space-between;align-items:center;padding:16px 32px;background:var(--bg2);border-bottom:1px solid var(--bg4)">
                <div id="breadcrumb" style="display:flex;align-items:center;gap:10px;font-size:.9rem">
                    <a onclick="goTo('dashboard')" style="color:var(--accent);font-weight:600;cursor:pointer;text-decoration:none;display:flex;align-items:center;gap:8px">
                        <img id="breadcrumbLogo" src="https://static.wixstatic.com/media/760af2_cb121a61291f4f07adb48cfb70f3e2d9~mv2.png" style="width:28px;height:24px;object-fit:contain" onerror="this.outerHTML='‚òï'"> Moonberry
                    </a>
                    <span style="color:var(--tx3);font-size:.8rem">‚Ä∫</span>
                    <span id="currentPageName" style="color:var(--tx);font-weight:500">Ana Sayfa</span>
                </div>
                <button onclick="toggleDarkMode()" id="darkModeBtn" style="background:var(--bg3);border:1px solid var(--bg4);border-radius:8px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s" title="Karanlƒ±k/Aydƒ±nlƒ±k Mod">
                    <svg id="darkModeIcon" width="18" height="18" fill="none" stroke="var(--tx)" stroke-width="2" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                </button>
            </div>
            
            <!-- Dashboard -->
            <div class="page active" id="page-dashboard">
                <div class="page-header" style="margin-bottom:24px">
                    <div class="page-title" style="display:flex;align-items:center;gap:10px">
                        <div style="width:36px;height:36px;background:linear-gradient(135deg,#ff8674,#008c95);border-radius:8px;display:flex;align-items:center;justify-content:center">
                            <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                        </div>
                        Y√∂netim Paneli
                    </div>
                    <div class="page-subtitle" id="companyName">Y√ºkleniyor...</div>
                </div>
                
                <!-- Personel Y√∂netimi -->
                <div class="dashboard-section" style="margin-bottom:28px">
                    <div style="font-size:.8rem;font-weight:600;color:var(--tx2);text-transform:uppercase;letter-spacing:.08em;margin-bottom:16px;padding-left:4px;display:flex;align-items:center;gap:8px">
                        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
                        Personel Y√∂netimi
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px">
                        <div class="dashboard-card" onclick="goTo('personel')" style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:20px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:16px">
                            <div style="width:40px;height:40px;background:linear-gradient(135deg,#ff8674,#ff6b5b);border-radius:10px;display:flex;align-items:center;justify-content:center">
                                <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
                            </div>
                            <div>
                                <div style="font-weight:600;color:var(--tx)">Personel</div>
                                <div style="font-size:.75rem;color:var(--tx2)">Liste & Y√∂netim</div>
                            </div>
                        </div>
                        <div class="dashboard-card" onclick="goTo('puantaj')" style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:20px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:16px">
                            <div style="width:40px;height:40px;background:linear-gradient(135deg,#ff8674,#008c95);border-radius:10px;display:flex;align-items:center;justify-content:center">
                                <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                            </div>
                            <div>
                                <div style="font-weight:600;color:var(--tx)">Puantaj</div>
                                <div style="font-size:.75rem;color:var(--tx2)">Performans</div>
                            </div>
                        </div>
                        <div class="dashboard-card" onclick="goTo('shift')" style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:20px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:16px">
                            <div style="width:40px;height:40px;background:linear-gradient(135deg,#008c95,#00a8a8);border-radius:10px;display:flex;align-items:center;justify-content:center">
                                <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                            </div>
                            <div>
                                <div style="font-weight:600;color:var(--tx)">Shift Planƒ±</div>
                                <div style="font-size:.75rem;color:var(--tx2)">Haftalƒ±k Vardiya</div>
                            </div>
                        </div>
                        <div class="dashboard-card" onclick="goTo('checklist')" style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:20px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:16px">
                            <div style="width:40px;height:40px;background:linear-gradient(135deg,#00c9a7,#008c95);border-radius:10px;display:flex;align-items:center;justify-content:center">
                                <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
                            </div>
                            <div>
                                <div style="font-weight:600;color:var(--tx)">Checklist</div>
                                <div style="font-size:.75rem;color:var(--tx2)">G√ºnl√ºk Kontrol</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Belgeler -->
                <div class="dashboard-section" style="margin-bottom:28px">
                    <div style="font-size:.8rem;font-weight:600;color:var(--tx2);text-transform:uppercase;letter-spacing:.08em;margin-bottom:16px;padding-left:4px;display:flex;align-items:center;gap:8px">
                        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                        Belgeler
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px">
                        <div class="dashboard-card" onclick="goTo('sozlesme')" style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:20px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:16px">
                            <div style="width:40px;height:40px;background:linear-gradient(135deg,#008c95,#00a8a8);border-radius:10px;display:flex;align-items:center;justify-content:center">
                                <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                            </div>
                            <div>
                                <div style="font-weight:600;color:var(--tx)">S√∂zle≈üme</div>
                                <div style="font-size:.75rem;color:var(--tx2)">ƒ∞≈ü S√∂zle≈ümesi</div>
                            </div>
                        </div>
                        <div class="dashboard-card" onclick="goTo('tutanak')" style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:20px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:16px">
                            <div style="width:40px;height:40px;background:linear-gradient(135deg,#ff8674,#ffa07a);border-radius:10px;display:flex;align-items:center;justify-content:center">
                                <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                            </div>
                            <div>
                                <div style="font-weight:600;color:var(--tx)">Tutanak</div>
                                <div style="font-size:.75rem;color:var(--tx2)">Olay Tespit</div>
                            </div>
                        </div>
                        <div class="dashboard-card" onclick="goTo('savunma')" style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:20px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:16px">
                            <div style="width:40px;height:40px;background:linear-gradient(135deg,#008c95,#4db6ac);border-radius:10px;display:flex;align-items:center;justify-content:center">
                                <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
                            </div>
                            <div>
                                <div style="font-weight:600;color:var(--tx)">Savunma</div>
                                <div style="font-size:.75rem;color:var(--tx2)">Savunma ƒ∞steme</div>
                            </div>
                        </div>
                        <div class="dashboard-card" onclick="goTo('fesih')" style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:20px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:16px">
                            <div style="width:40px;height:40px;background:linear-gradient(135deg,#e74c3c,#c0392b);border-radius:10px;display:flex;align-items:center;justify-content:center">
                                <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                            </div>
                            <div>
                                <div style="font-weight:600;color:var(--tx)">Fesih</div>
                                <div style="font-size:.75rem;color:var(--tx2)">ƒ∞≈ü Akdi Fesih</div>
                            </div>
                        </div>
                        <div class="dashboard-card" onclick="goTo('istifa')" style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:20px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:16px">
                            <div style="width:40px;height:40px;background:linear-gradient(135deg,#ff8674,#008c95);border-radius:10px;display:flex;align-items:center;justify-content:center">
                                <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                            </div>
                            <div>
                                <div style="font-weight:600;color:var(--tx)">ƒ∞stifa</div>
                                <div style="font-size:.75rem;color:var(--tx2)">ƒ∞stifa Dilek√ßesi</div>
                            </div>
                        </div>
                        <div class="dashboard-card" onclick="goTo('ibraname')" style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:20px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:16px">
                            <div style="width:40px;height:40px;background:linear-gradient(135deg,#27ae60,#2ecc71);border-radius:10px;display:flex;align-items:center;justify-content:center">
                                <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                            </div>
                            <div>
                                <div style="font-weight:600;color:var(--tx)">ƒ∞braname</div>
                                <div style="font-size:.75rem;color:var(--tx2)">ƒ∞bra Belgesi</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Formlar -->
                <div class="dashboard-section" style="margin-bottom:28px">
                    <div style="font-size:.8rem;font-weight:600;color:var(--tx2);text-transform:uppercase;letter-spacing:.08em;margin-bottom:16px;padding-left:4px">üìë Formlar</div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px">
                        <div class="dashboard-card" onclick="goTo('borc')" style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:20px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:16px">
                            <div style="width:40px;height:40px;background:rgba(0,140,149,.1);border-radius:10px;display:flex;align-items:center;justify-content:center"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--brand-teal)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div>
                            <div>
                                <div style="font-weight:600;color:var(--tx)">Bor√ß ƒ∞krar</div>
                                <div style="font-size:.75rem;color:var(--tx2)">Kesinti Onayƒ±</div>
                            </div>
                        </div>
                        <div class="dashboard-card" onclick="goTo('avans')" style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:20px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:16px">
                            <div style="width:40px;height:40px;background:rgba(255,134,116,.1);border-radius:10px;display:flex;align-items:center;justify-content:center"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--brand-coral)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="6" width="20" height="12" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/><line x1="6" y1="14" x2="8" y2="14"/><line x1="12" y1="14" x2="16" y2="14"/></svg></div>
                            <div>
                                <div style="font-weight:600;color:var(--tx)">Avans</div>
                                <div style="font-size:.75rem;color:var(--tx2)">Avans Talebi</div>
                            </div>
                        </div>
                        <div class="dashboard-card" onclick="goTo('zimmet')" style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:20px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:16px">
                            <div style="width:40px;height:40px;background:rgba(0,140,149,.1);border-radius:10px;display:flex;align-items:center;justify-content:center"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--brand-teal)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg></div>
                            <div>
                                <div style="font-weight:600;color:var(--tx)">Zimmet</div>
                                <div style="font-size:.75rem;color:var(--tx2)">Demirba≈ü Teslim</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Diƒüer -->
                <div class="dashboard-section">
                    <div style="font-size:.8rem;font-weight:600;color:var(--tx2);text-transform:uppercase;letter-spacing:.08em;margin-bottom:16px;padding-left:4px;display:flex;align-items:center;gap:8px">
                        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
                        Sistem
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px">
                        <div class="dashboard-card" onclick="goTo('katalog')" style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:20px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:16px">
                            <div style="width:40px;height:40px;background:linear-gradient(135deg,#008c95,#4db6ac);border-radius:10px;display:flex;align-items:center;justify-content:center">
                                <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>
                            </div>
                            <div>
                                <div style="font-weight:600;color:var(--tx)">ƒ∞hlal Kataloƒüu</div>
                                <div style="font-size:.75rem;color:var(--tx2)">Yasal Dayanaklar</div>
                            </div>
                        </div>
                        <div class="dashboard-card" onclick="openAdminWithPin()" style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:20px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:16px">
                            <div style="width:40px;height:40px;background:linear-gradient(135deg,#ff8674,#008c95);border-radius:10px;display:flex;align-items:center;justify-content:center">
                                <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
                            </div>
                            <div>
                                <div style="font-weight:600;color:var(--tx)">Y√∂netim</div>
                                <div style="font-size:.75rem;color:var(--tx2)">Sistem Ayarlarƒ±</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- S√∂zle≈üme -->
            <div class="page" id="page-sozlesme">
                <div class="back-link" onclick="goTo('dashboard')">‚Üê Ana Sayfa</div>
                <div class="page-header">
                    <div class="page-title">ƒ∞≈ü S√∂zle≈ümesi</div>
                    <div class="page-subtitle">Pozisyona √∂zel s√∂zle≈üme olu≈ütur</div>
                </div>
                <div class="form-section">
                    <div class="form-section-title">üë§ Pozisyon Se√ß</div>
                    <div class="type-cards" id="sozlesmePozisyonlar"></div>
                </div>
                <div class="form-section">
                    <div class="form-section-title" style="display:flex;align-items:center;gap:8px"><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg> Personel Bilgileri</div>
                    <div class="form-grid">
                        <div class="form-group"><label class="form-label">Ad Soyad</label><input type="text" id="soz_ad" class="form-input" placeholder="Personel adƒ±"></div>
                        <div class="form-group"><label class="form-label">TC Kimlik</label><input type="text" id="soz_tc" class="form-input" placeholder="11 hane" maxlength="11"></div>
                        <div class="form-group full"><label class="form-label">Adres</label><input type="text" id="soz_adres" class="form-input" placeholder="ƒ∞kametgah adresi"></div>
                        <div class="form-group"><label class="form-label">Cep Telefonu</label><input type="text" id="soz_telefon" class="form-input" placeholder="+90 5XX XXX XX XX"></div>
                        <div class="form-group"><label class="form-label">IBAN</label><input type="text" id="soz_iban" class="form-input" placeholder="TR..."></div>
                        <div class="form-group"><label class="form-label">ƒ∞≈üe Ba≈ülama</label><input type="date" id="soz_baslama" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Br√ºt √úcret (TL)</label><input type="text" id="soz_ucret" class="form-input" placeholder="25.000"></div>
                        <div class="form-group"><label class="form-label">≈ûube</label><select id="soz_sube" class="form-select"></select></div>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="generateSozlesme()">üìÑ S√∂zle≈üme Olu≈ütur</button>
                    <button class="btn btn-ghost" onclick="clearForm('soz')">Temizle</button>
                </div>
            </div>

            <!-- Tutanak -->
            <div class="page" id="page-tutanak">
                <div class="back-link" onclick="goTo('dashboard')">‚Üê Ana Sayfa</div>
                <div class="page-header">
                    <div class="page-title">Tutanak Olu≈ütur</div>
                </div>
                <div class="form-section">
                    <div class="form-section-title" style="display:flex;align-items:center;gap:8px"><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg> Tutanak T√ºr√º</div>
                    <div class="type-cards">
                        <div class="type-card" data-type="olay" onclick="selectType('tutanak','olay',this)"><div class="type-card-icon">üìù</div><div class="type-card-title">Olay Tespit</div></div>
                        <div class="type-card" data-type="devamsizlik" onclick="selectType('tutanak','devamsizlik',this)"><div class="type-card-icon">üìÖ</div><div class="type-card-title">Devamsƒ±zlƒ±k</div></div>
                        <div class="type-card" data-type="kasa" onclick="selectType('tutanak','kasa',this)"><div class="type-card-icon" style="color:var(--brand-teal)">‚Ç∫</div><div class="type-card-title">Kasa A√ßƒ±ƒüƒ±</div></div>
                        <div class="type-card" data-type="imza" onclick="selectType('tutanak','imza',this)"><div class="type-card-icon">‚úçÔ∏è</div><div class="type-card-title">ƒ∞mzadan ƒ∞mtina</div></div>
                    </div>
                </div>
                <div class="form-section">
                    <div class="form-section-title">üìù Bilgiler</div>
                    <div class="form-grid">
                        <div class="form-group"><label class="form-label">Personel</label><input type="text" id="tut_personel" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Pozisyon</label><select id="tut_pozisyon" class="form-select"></select></div>
                        <div class="form-group"><label class="form-label">Olay Tarihi</label><input type="date" id="tut_tarih" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Olay Saati</label><input type="time" id="tut_saat" class="form-input"></div>
                        <div class="form-group"><label class="form-label">D√ºzenleme Tarihi</label><input type="date" id="tut_duz_tarih" class="form-input"></div>
                        <div class="form-group"><label class="form-label">D√ºzenleme Saati</label><input type="time" id="tut_duz_saat" class="form-input"></div>
                        <div class="form-group"><label class="form-label">≈ûube</label><select id="tut_sube" class="form-select"></select></div>
                        <div class="form-group" id="tut_kasa_field" style="display:none"><label class="form-label">A√ßƒ±k Tutarƒ± (TL)</label><input type="text" id="tut_kasa" class="form-input"></div>
                        <div class="form-group full"><label class="form-label">A√ßƒ±klama</label><textarea id="tut_aciklama" class="form-textarea" placeholder="Olayƒ± a√ßƒ±klayƒ±n..."></textarea></div>
                        <div class="form-group"><label class="form-label">1. ≈ûahit</label><input type="text" id="tut_sahit1" class="form-input"></div>
                        <div class="form-group"><label class="form-label">2. ≈ûahit</label><input type="text" id="tut_sahit2" class="form-input"></div>
                        <div class="form-group"><label class="form-label">D√ºzenleyen</label><input type="text" id="tut_duzenleyen" class="form-input"></div>
                        <div class="form-group"><label class="form-label">G√∂revi</label><input type="text" id="tut_gorev" class="form-input"></div>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="generateTutanak()">üìÑ Tutanak Olu≈ütur</button>
                    <button class="btn btn-ghost" onclick="clearForm('tut')">Temizle</button>
                </div>
            </div>

            <!-- Savunma -->
            <div class="page" id="page-savunma">
                <div class="back-link" onclick="goTo('dashboard')">‚Üê Ana Sayfa</div>
                <div class="page-header">
                    <div class="page-title">Savunma ƒ∞steme</div>
                </div>
                <div class="alert alert-warning"><span class="alert-icon">‚ö†Ô∏è</span><div>ƒ∞≈ü Kanunu Md. 19: Fesih √∂ncesi savunma almak zorunludur.</div></div>
                <div class="form-section">
                    <div class="form-grid">
                        <div class="form-group"><label class="form-label">Personel</label><input type="text" id="sav_personel" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Pozisyon</label><select id="sav_pozisyon" class="form-select"></select></div>
                        <div class="form-group"><label class="form-label">ƒ∞hlal Tarihi</label><input type="date" id="sav_tarih" class="form-input"></div>
                        <div class="form-group"><label class="form-label">≈ûube</label><select id="sav_sube" class="form-select"></select></div>
                        <div class="form-group"><label class="form-label">D√ºzenleme Tarihi</label><input type="date" id="sav_duz_tarih" class="form-input"></div>
                        <div class="form-group"><label class="form-label">D√ºzenleme Saati</label><input type="time" id="sav_duz_saat" class="form-input"></div>
                        <div class="form-group full"><label class="form-label">ƒ∞snat Edilen Eylem</label><textarea id="sav_isnat" class="form-textarea" placeholder="Detaylƒ± a√ßƒ±klayƒ±n..."></textarea></div>
                        <div class="form-group"><label class="form-label">Savunma S√ºresi</label><select id="sav_sure" class="form-select"><option value="1" selected>1 ƒ∞≈ü G√ºn√º (Minimum)</option><option value="2">2 ƒ∞≈ü G√ºn√º</option><option value="3">3 ƒ∞≈ü G√ºn√º</option><option value="5">5 ƒ∞≈ü G√ºn√º</option></select></div>
                        <div class="form-group"><label class="form-label">Yetkili</label><input type="text" id="sav_yetkili" class="form-input"></div>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="generateSavunma()">üìÑ Belge Olu≈ütur</button>
                </div>
            </div>

            <!-- Fesih -->
            <div class="page" id="page-fesih">
                <div class="back-link" onclick="goTo('dashboard')">‚Üê Ana Sayfa</div>
                <div class="page-header">
                    <div class="page-title">Fesih ƒ∞≈ülemleri</div>
                </div>
                <div class="form-section">
                    <div class="form-section-title">‚öñÔ∏è Fesih T√ºr√º</div>
                    <div class="type-cards">
                        <div class="type-card" data-type="hakli" onclick="selectFesihType('hakli',this)"><div class="type-card-icon">‚ö†Ô∏è</div><div class="type-card-title">Haklƒ± Fesih</div><div class="type-card-sub">Md. 25/II - Tazminatsƒ±z</div></div>
                        <div class="type-card" data-type="gecerli" onclick="selectFesihType('gecerli',this)"><div class="type-card-icon">üìã</div><div class="type-card-title">Ge√ßerli Fesih</div><div class="type-card-sub">Md. 18 - Tazminatlƒ±</div></div>
                        <div class="type-card" data-type="deneme" onclick="selectFesihType('deneme',this)"><div class="type-card-icon">üîÑ</div><div class="type-card-title">Deneme Feshi</div><div class="type-card-sub">Bildirimsiz</div></div>
                    </div>
                </div>
                <div id="fesih_6gun_alert" class="alert alert-danger" style="display:none"><span class="alert-icon">üö®</span><div><strong>6 ƒ∞≈ü G√ºn√º Uyarƒ±sƒ±!</strong> Haklƒ± fesih i√ßin s√ºre dolmu≈ü olabilir. Yine de belge olu≈üturabilirsiniz.</div></div>
                <div class="form-section">
                    <div class="form-grid">
                        <div class="form-group"><label class="form-label">Personel</label><input type="text" id="fes_personel" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Pozisyon</label><select id="fes_pozisyon" class="form-select"></select></div>
                        <div class="form-group"><label class="form-label">≈ûube</label><select id="fes_sube" class="form-select"></select></div>
                        <div class="form-group" id="fes_ogrenme_field"><label class="form-label">√ñƒürenme Tarihi</label><input type="date" id="fes_ogrenme" class="form-input" onchange="check6Gun()"></div>
                        <div class="form-group"><label class="form-label">ƒ∞≈üe Giri≈ü</label><input type="date" id="fes_giris" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Fesih Tarihi</label><input type="date" id="fes_tarih" class="form-input"></div>
                        <div class="form-group full"><label class="form-label">Gerek√ße</label><textarea id="fes_gerekce" class="form-textarea"></textarea></div>
                        <div class="form-group"><label class="form-label">Dayanak</label><select id="fes_dayanak" class="form-select"></select></div>
                        <div class="form-group"><label class="form-label">Yetkili</label><input type="text" id="fes_yetkili" class="form-input"></div>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-danger" onclick="generateFesih()">‚õî Fesih Olu≈ütur</button>
                </div>
            </div>

            <!-- ƒ∞stifa Dilek√ßesi -->
            <div class="page" id="page-istifa">
                <div class="back-link" onclick="goTo('dashboard')">‚Üê Ana Sayfa</div>
                <div class="page-header">
                    <div class="page-title" style="display:flex;align-items:center;gap:10px">
                        <div style="width:36px;height:36px;background:linear-gradient(135deg,#a29bfe,#6c5ce7);border-radius:8px;display:flex;align-items:center;justify-content:center">
                            <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                        </div>
                        ƒ∞stifa Dilek√ßesi
                    </div>
                </div>
                <div class="alert alert-info"><span class="alert-icon">‚ÑπÔ∏è</span><div>ƒ∞≈ü Kanunu Md.17: ƒ∞≈ü√ßi istifa etmek istediƒüinde ihbar s√ºresine uymak zorundadƒ±r. Aksi halde i≈üveren tazminat talep edebilir.</div></div>
                <div class="form-section">
                    <div class="form-grid">
                        <div class="form-group"><label class="form-label">Personel Adƒ± Soyadƒ±</label><input type="text" id="istifa_personel" class="form-input"></div>
                        <div class="form-group"><label class="form-label">TC Kimlik No</label><input type="text" id="istifa_tc" class="form-input" maxlength="11"></div>
                        <div class="form-group"><label class="form-label">≈ûube</label><select id="istifa_sube" class="form-select"></select></div>
                        <div class="form-group"><label class="form-label">Pozisyon</label><select id="istifa_pozisyon" class="form-select"></select></div>
                        <div class="form-group"><label class="form-label">ƒ∞≈üe Giri≈ü Tarihi</label><input type="date" id="istifa_giris" class="form-input"></div>
                        <div class="form-group"><label class="form-label">ƒ∞stifa Tarihi</label><input type="date" id="istifa_tarih" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Son √áalƒ±≈üma Tarihi</label><input type="date" id="istifa_son_tarih" class="form-input"></div>
                        <div class="form-group">
                            <label class="form-label">ƒ∞hbar S√ºresi</label>
                            <select id="istifa_ihbar" class="form-select">
                                <option value="0">ƒ∞hbar S√ºresiz (Derhal)</option>
                                <option value="2">2 Hafta (6 aya kadar)</option>
                                <option value="4">4 Hafta (6 ay - 1.5 yƒ±l)</option>
                                <option value="6">6 Hafta (1.5 - 3 yƒ±l)</option>
                                <option value="8">8 Hafta (3 yƒ±l √ºzeri)</option>
                            </select>
                        </div>
                        <div class="form-group full"><label class="form-label">ƒ∞stifa Nedeni (ƒ∞steƒüe Baƒülƒ±)</label><textarea id="istifa_neden" class="form-textarea" placeholder="Ki≈üisel nedenlerden dolayƒ±... (bo≈ü bƒ±rakƒ±labilir)"></textarea></div>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="generateIstifa()">üìÑ ƒ∞stifa Dilek√ßesi Olu≈ütur</button>
                </div>
            </div>

            <!-- ƒ∞braname -->
            <div class="page" id="page-ibraname">
                <div class="back-link" onclick="goTo('dashboard')">‚Üê Ana Sayfa</div>
                <div class="page-header">
                    <div class="page-title" style="display:flex;align-items:center;gap:10px">
                        <div style="width:36px;height:36px;background:linear-gradient(135deg,#00b894,#00cec9);border-radius:8px;display:flex;align-items:center;justify-content:center">
                            <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                        </div>
                        ƒ∞braname
                    </div>
                </div>
                <div class="alert alert-warning"><span class="alert-icon">‚ö†Ô∏è</span><div>TBK Md.420: ƒ∞branamenin ge√ßerliliƒüi i√ßin i≈ü√ßinin yazƒ±lƒ± onayƒ± ve √∂demenin banka yoluyla yapƒ±lmasƒ± ≈üarttƒ±r.</div></div>
                <div class="form-section">
                    <div class="form-grid">
                        <div class="form-group"><label class="form-label">Personel Adƒ± Soyadƒ±</label><input type="text" id="ibra_personel" class="form-input"></div>
                        <div class="form-group"><label class="form-label">TC Kimlik No</label><input type="text" id="ibra_tc" class="form-input" maxlength="11"></div>
                        <div class="form-group"><label class="form-label">≈ûube</label><select id="ibra_sube" class="form-select"></select></div>
                        <div class="form-group"><label class="form-label">Pozisyon</label><select id="ibra_pozisyon" class="form-select"></select></div>
                        <div class="form-group"><label class="form-label">ƒ∞≈üe Giri≈ü Tarihi</label><input type="date" id="ibra_giris" class="form-input"></div>
                        <div class="form-group"><label class="form-label">ƒ∞≈üten Ayrƒ±lƒ±≈ü Tarihi</label><input type="date" id="ibra_cikis" class="form-input"></div>
                        <div class="form-group"><label class="form-label">ƒ∞braname Tarihi</label><input type="date" id="ibra_tarih" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Toplam √ñdeme (TL)</label><input type="text" id="ibra_tutar" class="form-input" placeholder="Net √∂denen tutar"></div>
                        <div class="form-group"><label class="form-label">IBAN</label><input type="text" id="ibra_iban" class="form-input" placeholder="TR00 0000 0000 0000 0000 0000 00"></div>
                        <div class="form-group"><label class="form-label">Yetkili</label><input type="text" id="ibra_yetkili" class="form-input"></div>
                        <div class="form-group full">
                            <label class="form-label">√ñdeme Kalemleri</label>
                            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px">
                                <label style="display:flex;align-items:center;gap:8px;font-size:.85rem"><input type="checkbox" id="ibra_maas" checked> Maa≈ü Alacaƒüƒ±</label>
                                <label style="display:flex;align-items:center;gap:8px;font-size:.85rem"><input type="checkbox" id="ibra_kidem"> Kƒ±dem Tazminatƒ±</label>
                                <label style="display:flex;align-items:center;gap:8px;font-size:.85rem"><input type="checkbox" id="ibra_ihbar"> ƒ∞hbar Tazminatƒ±</label>
                                <label style="display:flex;align-items:center;gap:8px;font-size:.85rem"><input type="checkbox" id="ibra_izin"> Kullanƒ±lmayan Yƒ±llƒ±k ƒ∞zin</label>
                                <label style="display:flex;align-items:center;gap:8px;font-size:.85rem"><input type="checkbox" id="ibra_fazla"> Fazla Mesai</label>
                                <label style="display:flex;align-items:center;gap:8px;font-size:.85rem"><input type="checkbox" id="ibra_diger"> Diƒüer Alacaklar</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="generateIbraname()">üìÑ ƒ∞braname Olu≈ütur</button>
                </div>
            </div>

            <!-- Bor√ß ƒ∞krar -->
            <div class="page" id="page-borc">
                <div class="back-link" onclick="goTo('dashboard')">‚Üê Ana Sayfa</div>
                <div class="page-header">
                    <div class="page-title">Bor√ß ƒ∞krar Muvafakatnamesi</div>
                </div>
                <div class="alert alert-info"><span class="alert-icon">‚ÑπÔ∏è</span><div>TBK 407/2: Her olay i√ßin ayrƒ± muvafakatname gerekir.</div></div>
                <div class="form-section">
                    <div class="form-grid">
                        <div class="form-group"><label class="form-label">Personel</label><input type="text" id="borc_personel" class="form-input"></div>
                        <div class="form-group"><label class="form-label">TC</label><input type="text" id="borc_tc" class="form-input" maxlength="11"></div>
                        <div class="form-group"><label class="form-label">≈ûube</label><select id="borc_sube" class="form-select"></select></div>
                        <div class="form-group"><label class="form-label">Bor√ß T√ºr√º</label><select id="borc_tur" class="form-select"><option value="kasa">Kasa A√ßƒ±ƒüƒ±</option><option value="zimmet">Zimmet Hasarƒ±</option><option value="stok">Stok Kaybƒ±</option></select></div>
                        <div class="form-group"><label class="form-label">Tutar (TL)</label><input type="text" id="borc_tutar" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Olay Tarihi</label><input type="date" id="borc_tarih" class="form-input"></div>
                        <div class="form-group"><label class="form-label">√ñdeme</label><select id="borc_odeme" class="form-select"><option value="tek">Tek Seferde</option><option value="taksit">Taksitle</option></select></div>
                        <div class="form-group"><label class="form-label">D√ºzenleme Tarihi</label><input type="date" id="borc_duz_tarih" class="form-input"></div>
                        <div class="form-group full"><label class="form-label">A√ßƒ±klama</label><textarea id="borc_aciklama" class="form-textarea"></textarea></div>
                        <div class="form-group"><label class="form-label">≈ûahit</label><input type="text" id="borc_sahit" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Yetkili</label><input type="text" id="borc_yetkili" class="form-input"></div>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="generateBorc()">üìÑ Muvafakatname Olu≈ütur</button>
                </div>
            </div>

            <!-- Avans Talebi -->
            <div class="page" id="page-avans">
                <div class="back-link" onclick="goTo('dashboard')">‚Üê Ana Sayfa</div>
                <div class="page-header">
                    <div class="page-title">Avans Talebi Formu</div>
                </div>
                <div class="alert alert-info"><span class="alert-icon">‚ÑπÔ∏è</span><div>Personel avans talebini bu form ile iletir. ƒ∞≈üveren onayƒ± ile √∂deme yapƒ±lƒ±r.</div></div>
                <div class="form-section">
                    <div class="form-grid">
                        <div class="form-group"><label class="form-label">Personel Adƒ± Soyadƒ±</label><input type="text" id="avans_personel" class="form-input"></div>
                        <div class="form-group"><label class="form-label">TC Kimlik No</label><input type="text" id="avans_tc" class="form-input" maxlength="11"></div>
                        <div class="form-group"><label class="form-label">≈ûube</label><select id="avans_sube" class="form-select"></select></div>
                        <div class="form-group"><label class="form-label">Pozisyon</label><select id="avans_pozisyon" class="form-select"></select></div>
                        <div class="form-group"><label class="form-label">IBAN</label><input type="text" id="avans_iban" class="form-input" placeholder="TR00 0000 0000 0000 0000 0000 00"></div>
                        <div class="form-group"><label class="form-label">Talep Edilen Tutar (TL)</label><input type="text" id="avans_tutar" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Talep Tarihi</label><input type="date" id="avans_tarih" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Geri √ñdeme ≈ûekli</label><input type="text" id="avans_odeme" class="form-input" value="Gelecek ay maa≈üƒ±ndan tek seferde kesilecektir" readonly style="background:#f5f5f5"></div>
                        <div class="form-group full"><label class="form-label">Avans Talebi Gerek√ßesi</label><textarea id="avans_gerekce" class="form-textarea" placeholder="Avans talebinizin nedenini kƒ±saca a√ßƒ±klayƒ±nƒ±z..."></textarea></div>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="generateAvans()">üìÑ Avans Talebi Olu≈ütur</button>
                </div>
            </div>

            <!-- Zimmet Formu -->
            <div class="page" id="page-zimmet">
                <div class="back-link" onclick="goTo('dashboard')">‚Üê Ana Sayfa</div>
                <div class="page-header">
                    <div class="page-title">Zimmet (Demirba≈ü Teslim) Formu</div>
                </div>
                <div class="alert alert-info"><span class="alert-icon">‚ÑπÔ∏è</span><div>TBK Md. 390 ve 462: ƒ∞≈ü√ßi, i≈üverenin mallarƒ±nƒ± √∂zenle korumakla y√ºk√ºml√ºd√ºr. Zimmet tutanaƒüƒ± ile teslim edilen e≈üyalar i√ßin personel mali sorumluluk ta≈üƒ±r.</div></div>
                <div class="form-section">
                    <div class="form-section-title" style="display:flex;align-items:center;gap:8px"><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg> Personel Bilgileri</div>
                    <div class="form-grid">
                        <div class="form-group"><label class="form-label">Personel Adƒ± Soyadƒ±</label><input type="text" id="zimmet_personel" class="form-input"></div>
                        <div class="form-group"><label class="form-label">TC Kimlik No</label><input type="text" id="zimmet_tc" class="form-input" maxlength="11"></div>
                        <div class="form-group"><label class="form-label">≈ûube</label><select id="zimmet_sube" class="form-select"></select></div>
                        <div class="form-group"><label class="form-label">Pozisyon</label><select id="zimmet_pozisyon" class="form-select"></select></div>
                        <div class="form-group"><label class="form-label">Teslim Tarihi</label><input type="date" id="zimmet_tarih" class="form-input"></div>
                        <div class="form-group"><label class="form-label">ƒ∞≈ülem T√ºr√º</label><select id="zimmet_islem" class="form-select"><option value="teslim">Teslim (Zimmet)</option><option value="iade">ƒ∞ade</option></select></div>
                    </div>
                </div>
                <div class="form-section">
                    <div class="form-section-title">üì¶ Zimmet Edilecek E≈üyalar</div>
                    <div id="zimmetListesi"></div>
                    <button class="btn btn-ghost" onclick="zimmetEkle()" style="margin-top:10px">+ E≈üya Ekle</button>
                </div>
                <div class="form-section">
                    <div class="form-group full"><label class="form-label">Ek Notlar / √ñzel Ko≈üullar</label><textarea id="zimmet_notlar" class="form-textarea" placeholder="Varsa √∂zel kullanƒ±m ko≈üullarƒ±, kƒ±sƒ±tlamalar..."></textarea></div>
                    <div class="form-group"><label class="form-label">Teslim Eden Yetkili</label><input type="text" id="zimmet_yetkili" class="form-input"></div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="generateZimmet()">üìÑ Zimmet Formu Olu≈ütur</button>
                </div>
            </div>

            <!-- Katalog -->
            <div class="page" id="page-katalog">
                <div class="back-link" onclick="goTo('dashboard')">‚Üê Ana Sayfa</div>
                <div class="page-header">
                    <div class="page-title">ƒ∞hlal Kataloƒüu</div>
                </div>
                <div class="tabs" id="katalogTabs">
                    <button class="tab active" onclick="filterKatalog('all',this)">T√ºm√º</button>
                    <button class="tab" onclick="filterKatalog('low',this)">D√º≈ü√ºk</button>
                    <button class="tab" onclick="filterKatalog('medium',this)">Orta</button>
                    <button class="tab" onclick="filterKatalog('high',this)">Y√ºksek</button>
                </div>
                <div class="violation-list" id="violationList"></div>
            </div>

            <!-- Personel Listesi -->
            <div class="page" id="page-personel">
                <div class="back-link" onclick="goTo('dashboard')">‚Üê Ana Sayfa</div>
                <div class="page-header">
                    <div class="page-title" style="display:flex;align-items:center;gap:10px">
                        <div style="width:36px;height:36px;background:linear-gradient(135deg,#ff8674,#ff6b5b);border-radius:8px;display:flex;align-items:center;justify-content:center">
                            <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
                        </div>
                        Personel Listesi
                    </div>
                    <div class="page-subtitle">T√ºm personeli g√∂r√ºnt√ºle ve y√∂net</div>
                </div>
                <div class="form-section">
                    <div class="form-section-title" style="justify-content:space-between">
                        <span>üìã Kayƒ±tlƒ± Personel</span>
                        <button class="btn btn-primary btn-sm" onclick="showAddPersonelModal()">+ Yeni Personel</button>
                    </div>
                    <div class="form-group">
                        <input type="text" id="personelSearch" class="form-input" placeholder="üîç ƒ∞sim, TC veya ≈üube ara..." oninput="filterPersonel()">
                    </div>
                    <div id="personelListContainer" style="margin-top:16px">
                        <p style="color:var(--tx2);text-align:center;padding:40px">Hen√ºz personel kaydƒ± yok. "Yeni Personel" butonuna tƒ±klayarak ekleyin.</p>
                    </div>
                </div>
            </div>

            <!-- Shift Planƒ± -->
            <div class="page" id="page-shift">
                <div class="back-link" onclick="goTo('dashboard')">‚Üê Ana Sayfa</div>
                <div class="page-header">
                    <div class="page-title" style="display:flex;align-items:center;gap:10px">
                        <div style="width:36px;height:36px;background:linear-gradient(135deg,#008c95,#00a8a8);border-radius:8px;display:flex;align-items:center;justify-content:center">
                            <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                        </div>
                        Shift Planƒ±
                    </div>
                    <div class="page-subtitle">Haftalƒ±k vardiya planlamasƒ±</div>
                </div>
                <div class="form-section">
                    <div class="form-section-title" style="display:flex;align-items:center;gap:8px">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>
                        Maƒüaza ve D√∂nem Se√ßimi
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Maƒüaza</label>
                            <select id="shiftSube" class="form-select" onchange="loadShiftList()"></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Hafta</label>
                            <select id="shiftHafta" class="form-select" onchange="loadShiftWeek()">
                                <option value="">-- √ñnce Maƒüaza Se√ßin --</option>
                            </select>
                        </div>
                    </div>
                    <!-- Aksiyon Butonlarƒ± - Modern Minimalist -->
                    <div id="shiftActionButtons" style="display:flex;gap:8px;margin-top:16px;flex-wrap:wrap">
                        <button class="btn" onclick="showNewShiftModal()" style="padding:10px 16px;background:var(--accent);color:#fff;border:none;border-radius:8px;display:flex;align-items:center;gap:6px;font-size:.85rem;font-weight:500;cursor:pointer">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
                            Yeni Hafta
                        </button>
                        <button class="btn" onclick="printShift()" style="padding:10px 16px;background:var(--bg3);color:var(--tx);border:1px solid var(--bg4);border-radius:8px;display:flex;align-items:center;gap:6px;font-size:.85rem;font-weight:500;cursor:pointer">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
                            Yazdƒ±r
                        </button>
                        <button class="btn" onclick="downloadShiftPDF()" style="padding:10px 16px;background:#ff8674;color:#fff;border:none;border-radius:8px;display:flex;align-items:center;gap:6px;font-size:.85rem;font-weight:500;cursor:pointer">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
                            PDF ƒ∞ndir
                        </button>
                        <button id="deleteShiftBtn" class="btn" onclick="deleteCurrentShift()" style="padding:10px 16px;background:#fff0f0;color:#dc3545;border:1px solid #ffcdd2;border-radius:8px;display:flex;align-items:center;gap:6px;font-size:.85rem;font-weight:500;cursor:pointer" title="Bu Haftayƒ± Sil">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                            Sil
                        </button>
                    </div>
                </div>
                
                <!-- Shift Tablosu -->
                <div class="form-section">
                    <div class="form-section-title" style="display:flex;align-items:center;gap:8px">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                        Shift Tablosu
                    </div>
                    <div id="shiftTableContainer">
                        <p style="color:var(--tx2);text-align:center;padding:40px">‚¨ÜÔ∏è Yukarƒ±dan maƒüaza ve hafta se√ßerek shift planƒ±nƒ± g√∂r√ºnt√ºleyin.</p>
                    </div>
                </div>
                
                <!-- Ge√ßmi≈ü Shiftler -->
                <div class="form-section">
                    <div class="form-section-title" style="display:flex;align-items:center;gap:8px">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        Ge√ßmi≈ü Shiftler
                    </div>
                    <div id="shiftHistoryContainer">
                        <p style="color:var(--tx2);text-align:center;padding:20px">Maƒüaza se√ßerek ge√ßmi≈ü shiftleri g√∂r√ºnt√ºleyin.</p>
                    </div>
                </div>
            </div>

            <!-- Checklist -->
            <div class="page" id="page-checklist">
                <div class="back-link" onclick="goTo('dashboard')">‚Üê Ana Sayfa</div>
                <div class="page-header">
                    <div class="page-title" style="display:flex;align-items:center;gap:10px">
                        <div style="width:36px;height:36px;background:linear-gradient(135deg,#00c9a7,#008c95);border-radius:8px;display:flex;align-items:center;justify-content:center">
                            <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
                        </div>
                        Checklist
                    </div>
                    <div class="page-subtitle">G√ºnl√ºk kontrol listeleri</div>
                </div>
                
                <!-- ≈ûube ve T√ºr Se√ßimi -->
                <div class="form-section" style="margin-bottom:20px">
                    <div style="display:flex;flex-wrap:wrap;gap:16px;align-items:flex-start">
                        <div class="form-group" style="margin-bottom:0;min-width:160px">
                            <label class="form-label">≈ûube</label>
                            <select id="checklistSube" class="form-select" onchange="loadChecklistTypes()"></select>
                        </div>
                        <div class="form-group" style="margin-bottom:0;min-width:140px">
                            <label class="form-label">Tarih</label>
                            <input type="date" id="checklistDate" class="form-input" disabled style="background:var(--bg3);cursor:not-allowed">
                        </div>
                        <div class="form-group" style="margin-bottom:0;min-width:120px;display:none" id="checklistTimeSlotGroup">
                            <label class="form-label">Saat Dilimi</label>
                            <select id="checklistTimeSlot" class="form-select" onchange="loadChecklist()">
                                <option value="">-- Se√ßin --</option>
                            </select>
                        </div>
                    </div>
                    <!-- Checklist T√ºr√º - Yan Yana Butonlar -->
                    <div style="margin-top:16px">
                        <label class="form-label" style="margin-bottom:10px">Checklist T√ºr√º</label>
                        <div id="checklistTypeButtons" style="display:flex;flex-wrap:wrap;gap:8px">
                            <div style="color:var(--tx3);font-size:.9rem;padding:10px">√ñnce ≈üube se√ßin</div>
                        </div>
                    </div>
                    <!-- Hidden select for compatibility -->
                    <select id="checklistType" style="display:none" onchange="loadChecklist()">
                        <option value="">-- Se√ßin --</option>
                    </select>
                </div>
                
                <!-- Y√∂netici Butonlarƒ± -->
                <div id="checklistAdminButtons" style="display:none;margin-bottom:16px">
                    <div style="display:flex;gap:8px;flex-wrap:wrap">
                        <button class="btn btn-sm btn-ghost" onclick="showChecklistHistory()">üìä Ge√ßmi≈ü Kayƒ±tlar</button>
                    </div>
                </div>
                
                <!-- Checklist Formu -->
                <div id="checklistFormContainer">
                    <div style="text-align:center;padding:60px;color:var(--tx2)">
                        <div style="font-size:4rem;margin-bottom:16px">üìã</div>
                        <div style="font-size:1.1rem;margin-bottom:8px">Checklist Se√ßin</div>
                        <div style="font-size:.9rem">Yukarƒ±dan ≈üube ve checklist t√ºr√º se√ßerek ba≈ülayƒ±n</div>
                    </div>
                </div>
            </div>

            <!-- Puantaj -->
            <div class="page" id="page-puantaj">
                <div class="back-link" onclick="goTo('dashboard')">‚Üê Ana Sayfa</div>
                <div class="page-header">
                    <div class="page-title" style="display:flex;align-items:center;gap:10px">
                        <div style="width:36px;height:36px;background:linear-gradient(135deg,#f093fb,#f5576c);border-radius:8px;display:flex;align-items:center;justify-content:center">
                            <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                        </div>
                        Puantaj Sistemi
                    </div>
                    <div class="page-subtitle">Personel performans ve olay takibi</div>
                </div>
                
                <!-- Sekmeler -->
                <div style="display:flex;gap:8px;margin-bottom:20px;border-bottom:1px solid var(--cardBorder);padding-bottom:12px">
                    <button class="puantaj-tab active" onclick="showPuantajTab('kayit', this)" style="padding:10px 20px;border:none;background:linear-gradient(135deg,var(--accent),#ff6b5b);color:#fff;border-radius:8px;cursor:pointer;font-weight:600;transition:all .2s;box-shadow:0 2px 12px rgba(255,134,116,.3)">üìù Kayƒ±t</button>
                    <button class="puantaj-tab" onclick="showPuantajTab('analiz', this)" style="padding:10px 20px;border:none;background:var(--bg3);color:var(--tx);border-radius:8px;cursor:pointer;font-weight:600;transition:all .2s">üìä Analiz</button>
                    <button class="puantaj-tab" onclick="showPuantajTab('arsiv', this)" style="padding:10px 20px;border:none;background:var(--bg3);color:var(--tx);border-radius:8px;cursor:pointer;font-weight:600;transition:all .2s">üìÅ Ar≈üiv</button>
                </div>
                
                <!-- KAYIT SEKMESƒ∞ -->
                <div id="puantajKayitTab">
                    <div class="form-section">
                        <div class="form-section-title">üìÖ D√∂nem Se√ßimi</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Ay</label>
                                <select id="puantajAy" class="form-select" onchange="loadPuantaj()">
                                    <option value="01">Ocak</option>
                                    <option value="02">≈ûubat</option>
                                    <option value="03">Mart</option>
                                    <option value="04">Nisan</option>
                                    <option value="05">Mayƒ±s</option>
                                    <option value="06">Haziran</option>
                                    <option value="07">Temmuz</option>
                                    <option value="08">Aƒüustos</option>
                                    <option value="09">Eyl√ºl</option>
                                    <option value="10">Ekim</option>
                                    <option value="11">Kasƒ±m</option>
                                    <option value="12">Aralƒ±k</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Yƒ±l</label>
                                <select id="puantajYil" class="form-select" onchange="loadPuantaj()">
                                    <option value="2027">2027</option>
                                    <option value="2026">2026</option>
                                    <option value="2025">2025</option>
                                    <option value="2024">2024</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">≈ûube</label>
                                <select id="puantajSube" class="form-select" onchange="loadPuantaj()"></select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Puan Sistemi A√ßƒ±klama -->
                    <div style="background:linear-gradient(135deg,rgba(255,134,116,.08),rgba(0,140,149,.08));border:1px solid var(--cardBorder);border-radius:16px;padding:20px;margin-bottom:24px">
                        <div style="font-weight:700;color:var(--tx);margin-bottom:14px;font-size:1rem;display:flex;align-items:center;gap:8px">
                            <span style="font-size:1.3rem">‚≠ê</span> Puantaj Sistemi
                        </div>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:16px">
                            <div style="background:rgba(192,57,43,.1);border-radius:10px;padding:12px;text-align:center">
                                <div style="font-size:1.1rem;margin-bottom:4px">‚≠ê</div>
                                <div style="font-size:.8rem;color:#c0392b;font-weight:600">Ciddi ƒ∞hlal</div>
                                <div style="font-size:.9rem;color:#e74c3c;font-weight:700">-3 Puan</div>
                            </div>
                            <div style="background:rgba(211,84,0,.1);border-radius:10px;padding:12px;text-align:center">
                                <div style="font-size:1.1rem;margin-bottom:4px">‚≠ê‚≠ê</div>
                                <div style="font-size:.8rem;color:#d35400;font-weight:600">Orta ƒ∞hlal</div>
                                <div style="font-size:.9rem;color:#e67e22;font-weight:700">-2 Puan</div>
                            </div>
                            <div style="background:rgba(241,196,15,.1);border-radius:10px;padding:12px;text-align:center">
                                <div style="font-size:1.1rem;margin-bottom:4px">‚≠ê‚≠ê‚≠ê</div>
                                <div style="font-size:.8rem;color:#f39c12;font-weight:600">Hafif Uyarƒ±</div>
                                <div style="font-size:.9rem;color:#f1c40f;font-weight:700">-1 Puan</div>
                            </div>
                            <div style="background:rgba(39,174,96,.1);border-radius:10px;padding:12px;text-align:center">
                                <div style="font-size:1.1rem;margin-bottom:4px">‚≠ê‚≠ê‚≠ê‚≠ê</div>
                                <div style="font-size:.8rem;color:#27ae60;font-weight:600">ƒ∞yi Performans</div>
                                <div style="font-size:.9rem;color:#2ecc71;font-weight:700">+1 Puan</div>
                            </div>
                            <div style="background:rgba(46,204,113,.1);border-radius:10px;padding:12px;text-align:center">
                                <div style="font-size:1.1rem;margin-bottom:4px">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                                <div style="font-size:.8rem;color:#2ecc71;font-weight:600">M√ºkemmel</div>
                                <div style="font-size:.9rem;color:#27ae60;font-weight:700">+2 Puan</div>
                            </div>
                        </div>
                        <div style="background:var(--bg3);border-radius:10px;padding:12px;display:flex;align-items:center;gap:10px">
                            <span style="font-size:1.2rem">‚ö†Ô∏è</span>
                            <div style="font-size:.85rem;color:var(--tx2)">
                                <strong style="color:var(--tx)">Prim Kuralƒ±:</strong> Toplam puan <strong style="color:#e74c3c">-5</strong>'e ula≈üƒ±rsa prim hakkƒ± kaybedilir. Her ay ba≈üƒ± puanlar sƒ±fƒ±rlanƒ±r.
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="form-section-title" style="justify-content:space-between">
                            <span>üë• Personel Durumu</span>
                            <button class="btn btn-sm btn-ghost" onclick="showPuantajRules()">üìã Kural Tanƒ±mlarƒ±</button>
                        </div>
                        <div id="puantajTableContainer">
                            <p style="color:var(--tx2);text-align:center;padding:40px">Puantaj verisi y√ºkleniyor...</p>
                        </div>
                    </div>
                </div>
                
                <!-- ANALƒ∞Z SEKMESƒ∞ -->
                <div id="puantajAnalizTab" style="display:none">
                    <div class="form-section">
                        <div class="form-section-title">üìä Performans Analizi</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">D√∂nem</label>
                                <select id="analizDonem" class="form-select" onchange="loadPuantajAnaliz()">
                                    <option value="current">Bu Ay</option>
                                    <option value="all">T√ºm Zamanlar</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">≈ûube</label>
                                <select id="analizSube" class="form-select" onchange="loadPuantajAnaliz()"></select>
                            </div>
                        </div>
                    </div>
                    <div id="puantajAnalizContainer">
                        <p style="color:var(--tx2);text-align:center;padding:40px">Analiz y√ºkleniyor...</p>
                    </div>
                </div>
                
                <!-- AR≈ûƒ∞V SEKMESƒ∞ -->
                <div id="puantajArsivTab" style="display:none">
                    <div class="form-section">
                        <div class="form-section-title">üìÅ Ge√ßmi≈ü D√∂nemler</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">≈ûube</label>
                                <select id="arsivSube" class="form-select" onchange="loadPuantajArsiv()"></select>
                            </div>
                        </div>
                    </div>
                    <div id="puantajArsivContainer">
                        <p style="color:var(--tx2);text-align:center;padding:40px">Ar≈üiv y√ºkleniyor...</p>
                    </div>
                </div>
            </div>

            <!-- Preview -->
            <div class="page" id="page-preview">
                <div class="back-link" onclick="goBack()">‚Üê Geri</div>
                <div class="preview-container">
                    <div class="preview-toolbar">
                        <div class="preview-title" id="previewTitle">√ñnizleme</div>
                        <div class="preview-actions">
                            <button class="btn btn-sm btn-ghost" onclick="printDoc()">üñ®Ô∏è Yazdƒ±r</button>
                            <button class="btn btn-sm btn-primary" onclick="downloadPDF()">üì• PDF</button>
                        </div>
                    </div>
                    <div class="preview-content" id="previewContent"></div>
                </div>
            </div>

            <!-- Admin Panel -->
            <div class="page" id="page-admin">
                <div class="back-link" onclick="goTo('dashboard')">‚Üê Ana Sayfa</div>
                <div class="page-header">
                    <div class="page-title">‚öôÔ∏è Y√∂netim Paneli</div>
                    <div class="page-subtitle">Sistem ayarlarƒ±nƒ± y√∂netin</div>
                </div>
                <div class="admin-tabs">
                    <button class="admin-tab active" onclick="showAdminTab('genel',this)">Genel</button>
                    <button class="admin-tab" id="tab-kullanicilar" onclick="showAdminTab('kullanicilar',this)">üë§ Kullanƒ±cƒ± Y√∂netimi</button>
                    <button class="admin-tab" id="tab-oturumlar" onclick="showAdminTab('oturumlar',this)">‚è±Ô∏è Oturumlar</button>
                    <button class="admin-tab" onclick="showAdminTab('puantajKurallar',this)">Puantaj Kurallarƒ±</button>
                    <button class="admin-tab" onclick="showAdminTab('subeler',this)">≈ûubeler</button>
                    <button class="admin-tab" onclick="showAdminTab('pozisyonlar',this)">Pozisyonlar</button>
                    <button class="admin-tab" onclick="showAdminTab('ihlaller',this)">ƒ∞hlaller</button>
                    <button class="admin-tab" onclick="showAdminTab('sablonlar',this)">S√∂zle≈üme ≈ûablonlarƒ±</button>
                    <button class="admin-tab" onclick="showAdminTab('belgeler',this)">Belge ≈ûablonlarƒ±</button>
                    <button class="admin-tab" id="tab-aktiviteler" onclick="showAdminTab('aktiviteler',this)">üìä Aktiviteler</button>
                </div>
                
                <!-- Genel -->
                <div class="admin-section active" id="admin-genel">
                    <div class="admin-card" id="companySettingsCard">
                        <div class="admin-card-header"><div class="admin-card-title">≈ûirket Bilgileri</div></div>
                        <div class="form-grid">
                            <div class="form-group full"><label class="form-label">≈ûirket Adƒ±</label><input type="text" id="admin_company_name" class="form-input"></div>
                            <div class="form-group"><label class="form-label">MERSƒ∞S No</label><input type="text" id="admin_mersis" class="form-input"></div>
                            <div class="form-group full"><label class="form-label">Adres</label><input type="text" id="admin_address" class="form-input"></div>
                        </div>
                        <div class="btn-group"><button class="btn btn-primary btn-sm" onclick="saveCompany()">Kaydet</button></div>
                    </div>
                    <!-- Admin ≈ûifre Deƒüi≈ütirme - Sadece admin g√∂recek -->
                    <div class="admin-card" id="adminPasswordCard" style="margin-top:20px;display:none">
                        <div class="admin-card-header"><div class="admin-card-title">üîê Y√∂netici Giri≈ü Bilgileri</div></div>
                        <p style="color:var(--tx2);font-size:.85rem;margin-bottom:16px">Y√∂netici hesabƒ±nƒ±n kullanƒ±cƒ± adƒ± ve ≈üifresini deƒüi≈ütirin.</p>
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Yeni Kullanƒ±cƒ± Adƒ±</label><input type="text" id="admin_new_username" class="form-input" placeholder="Mevcut: admin"></div>
                            <div class="form-group"><label class="form-label">Yeni ≈ûifre</label><input type="password" id="admin_new_password" class="form-input" placeholder="Yeni ≈üifre girin"></div>
                            <div class="form-group"><label class="form-label">≈ûifre Tekrar</label><input type="password" id="admin_confirm_password" class="form-input" placeholder="≈ûifreyi tekrar girin"></div>
                        </div>
                        <div class="btn-group"><button class="btn btn-primary btn-sm" onclick="updateAdminCredentials()">üîë G√ºncelle</button></div>
                    </div>
                    <!-- Veri Temizleme - Sadece admin g√∂recek -->
                    <div class="admin-card" id="dataCleanupCard" style="margin-top:20px;display:none">
                        <div class="admin-card-header"><div class="admin-card-title">üßπ Veri Y√∂netimi</div></div>
                        <p style="color:var(--tx2);font-size:.85rem;margin-bottom:16px">Verileri y√∂netin ve Firebase'e y√ºkleyin.</p>
                        <div style="display:flex;gap:12px;flex-wrap:wrap">
                            <button class="btn btn-primary btn-sm" onclick="window.open('seed.html', '_blank')">üìã Veri Y√ºkleme Programƒ±</button>
                            <button class="btn btn-ghost btn-sm" onclick="cleanDuplicatePersonel()">üë• Duplicate Personel Temizle</button>
                            <button class="btn btn-ghost btn-sm" onclick="cleanDuplicateShifts()">üìÖ Duplicate Shift Temizle</button>
                        </div>
                        <div id="cleanupResults" style="margin-top:12px;padding:12px;background:var(--bg3);border-radius:8px;display:none"></div>
                    </div>
                    <!-- Rol √ñnizleme - Sadece admin g√∂recek -->
                    <div class="admin-card" id="rolePreviewCard" style="margin-top:20px;display:none">
                        <div class="admin-card-header"><div class="admin-card-title">üëÅÔ∏è Rol √ñnizleme</div></div>
                        <p style="color:var(--tx2);font-size:.85rem;margin-bottom:16px">Diƒüer kullanƒ±cƒ± rollerinin aray√ºzde neleri g√∂rebileceƒüini √∂nizleyin.</p>
                        <div id="rolePreviewContent">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">√ñnizlenecek Rol</label>
                                    <select id="previewRoleSelect" class="form-input">
                                        <option value="">-- Rol Se√ßin --</option>
                                        <option value="barista">Barista (Salt Okunur)</option>
                                        <option value="bolge_muduru">B√∂lge M√ºd√ºr√º</option>
                                        <option value="magaza_muduru">Maƒüaza M√ºd√ºr√º</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">√ñnizleme ≈ûubesi</label>
                                    <select id="previewBranchSelect" class="form-input">
                                        <option value="">-- ≈ûube Se√ßin --</option>
                                        <option value="≈ûi≈üli">≈ûi≈üli</option>
                                        <option value="Tuzla">Tuzla</option>
                                    </select>
                                </div>
                            </div>
                            <div class="btn-group" style="margin-top:16px">
                                <button class="btn btn-primary btn-sm" onclick="startRolePreview()">üëÅÔ∏è √ñnizlemeyi Ba≈ülat</button>
                            </div>
                        </div>
                        <div id="rolePreviewActive" style="display:none;padding:16px;background:var(--accent);border-radius:10px;text-align:center">
                            <div style="color:#fff;font-weight:600;font-size:.95rem;margin-bottom:8px">üîç √ñnizleme Modu Aktif</div>
                            <div style="color:rgba(255,255,255,.8);font-size:.85rem;margin-bottom:12px">
                                <span id="previewRoleName">-</span> olarak g√∂r√ºnt√ºl√ºyorsunuz
                                (<span id="previewBranchName">-</span>)
                            </div>
                            <button class="btn btn-ghost btn-sm" style="background:rgba(255,255,255,.2);color:#fff;border-color:rgba(255,255,255,.3)" onclick="stopRolePreview()">‚úï √ñnizlemeyi Sonlandƒ±r</button>
                        </div>
                    </div>
                </div>

                <!-- Kullanƒ±cƒ± Y√∂netimi (Kullanƒ±cƒ±lar + ƒ∞zinler birle≈üik) -->
                <div class="admin-section" id="admin-kullanicilar">
                    <!-- Sistem Kullanƒ±cƒ±larƒ± -->
                    <div class="admin-card">
                        <div class="admin-card-header">
                            <div class="admin-card-title">üë§ Sistem Kullanƒ±cƒ±larƒ±</div>
                            <button class="btn btn-sm btn-primary" onclick="showAddUserModal()">+ Yeni Kullanƒ±cƒ±</button>
                        </div>
                        <p style="color:var(--tx2);font-size:.85rem;margin-bottom:16px">Sisteme giri≈ü yapabilecek kullanƒ±cƒ±larƒ± y√∂netin.</p>
                        <div class="admin-list" id="userList">
                            <p style="color:var(--tx2);text-align:center;padding:20px">Kullanƒ±cƒ±lar y√ºkleniyor...</p>
                        </div>
                    </div>
                    
                    <!-- Rol ƒ∞zinleri -->
                    <div class="admin-card" style="margin-top:20px">
                        <div class="admin-card-header">
                            <div class="admin-card-title">üîê Rol ƒ∞zinleri</div>
                        </div>
                        <p style="color:var(--tx2);font-size:.85rem;margin-bottom:16px">Her rol i√ßin sayfa, belge ve y√∂netim paneli eri≈üim izinlerini yapƒ±landƒ±rƒ±n.</p>
                        
                        <!-- Rol Se√ßimi -->
                        <div class="form-group" style="margin-bottom:20px">
                            <label class="form-label">Rol Se√ßin</label>
                            <select id="advRoleSelect" class="form-select" onchange="loadAdvancedPermissions()" style="max-width:300px">
                                <option value="">-- Rol Se√ßin --</option>
                                <option value="barista">üßë‚Äçüç≥ Barista</option>
                                <option value="magaza_muduru">üè™ Maƒüaza M√ºd√ºr√º</option>
                                <option value="bolge_muduru">üåç B√∂lge M√ºd√ºr√º</option>
                            </select>
                        </div>
                        
                        <!-- ƒ∞zin Paneli -->
                        <div id="advPermissionsPanel" style="display:none">
                            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px">
                                <!-- Sayfalar -->
                                <div style="background:var(--bg3);border-radius:12px;padding:16px">
                                    <div style="font-weight:600;color:var(--tx);margin-bottom:12px;font-size:.9rem">üìÑ Sayfalar</div>
                                    <div style="display:flex;flex-direction:column;gap:8px" id="pagePermissions"></div>
                                </div>
                                
                                <!-- Belgeler -->
                                <div style="background:var(--bg3);border-radius:12px;padding:16px">
                                    <div style="font-weight:600;color:var(--tx);margin-bottom:12px;font-size:.9rem">üìã Belgeler</div>
                                    <div style="display:flex;flex-direction:column;gap:8px" id="docPermissions"></div>
                                </div>
                                
                                <!-- Admin Panelleri -->
                                <div style="background:var(--bg3);border-radius:12px;padding:16px">
                                    <div style="font-weight:600;color:var(--tx);margin-bottom:12px;font-size:.9rem">‚öôÔ∏è Y√∂netim</div>
                                    <div style="display:flex;flex-direction:column;gap:8px" id="adminPermissions"></div>
                                </div>
                                
                                <!-- √ñzel ƒ∞zinler -->
                                <div style="background:var(--bg3);border-radius:12px;padding:16px">
                                    <div style="font-weight:600;color:var(--tx);margin-bottom:12px;font-size:.9rem">üéØ √ñzel</div>
                                    <div style="display:flex;flex-direction:column;gap:8px" id="specialPermissions"></div>
                                </div>
                            </div>
                            
                            <div class="btn-group" style="margin-top:16px">
                                <button class="btn btn-primary btn-sm" onclick="saveAdvancedPermissions()">üíæ Kaydet</button>
                                <button class="btn btn-ghost btn-sm" onclick="resetAdvancedPermissions()">üîÑ Varsayƒ±lan</button>
                            </div>
                        </div>
                        
                        <div id="advPermissionsEmpty" style="text-align:center;padding:30px;color:var(--tx2)">
                            <div style="font-size:2rem;margin-bottom:8px">üîê</div>
                            <div style="font-size:.85rem">D√ºzenlemek i√ßin yukarƒ±dan bir rol se√ßin</div>
                        </div>
                    </div>
                </div>

                <!-- Oturum Y√∂netimi -->
                <div class="admin-section" id="admin-oturumlar">
                    <div class="admin-card">
                        <div class="admin-card-header">
                            <div class="admin-card-title">‚è±Ô∏è Oturum Ayarlarƒ±</div>
                        </div>
                        <p style="color:var(--txdark2);font-size:.85rem;margin-bottom:20px">
                            G√ºvenlik i√ßin oturum zaman a≈üƒ±mƒ± ve otomatik √ßƒ±kƒ±≈ü ayarlarƒ±nƒ± yapƒ±landƒ±rƒ±n.
                        </p>
                        
                        <div class="form-grid" style="margin-bottom:24px">
                            <div class="form-group">
                                <label class="form-label">‚è∞ ƒ∞naktivite S√ºresi (dakika)</label>
                                <select id="sessionTimeout" class="form-select">
                                    <option value="15">15 dakika</option>
                                    <option value="30" selected>30 dakika</option>
                                    <option value="60">1 saat</option>
                                    <option value="120">2 saat</option>
                                    <option value="0">Devre Dƒ±≈üƒ±</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">üîî Uyarƒ± S√ºresi (saniye)</label>
                                <select id="sessionWarning" class="form-select">
                                    <option value="30">30 saniye √∂nce</option>
                                    <option value="60" selected>1 dakika √∂nce</option>
                                    <option value="120">2 dakika √∂nce</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:20px">
                            <label style="display:flex;align-items:center;gap:8px;padding:12px 16px;background:var(--bg3);border-radius:10px;cursor:pointer">
                                <input type="checkbox" id="sessionLogoutOnClose" style="width:18px;height:18px;accent-color:#ff8674">
                                <span style="font-size:.9rem;color:var(--tx)">Tarayƒ±cƒ± kapatƒ±lƒ±nca √ßƒ±kƒ±≈ü yap</span>
                            </label>
                            <label style="display:flex;align-items:center;gap:8px;padding:12px 16px;background:var(--bg3);border-radius:10px;cursor:pointer">
                                <input type="checkbox" id="sessionSingleDevice" style="width:18px;height:18px;accent-color:#ff8674">
                                <span style="font-size:.9rem;color:var(--tx)">Tek cihaz politikasƒ±</span>
                            </label>
                        </div>
                        
                        <div class="btn-group">
                            <button class="btn btn-primary btn-sm" onclick="saveSessionSettings()">üíæ Ayarlarƒ± Kaydet</button>
                        </div>
                    </div>
                    
                    <!-- Aktif Oturumlar -->
                    <div class="admin-card" style="margin-top:16px">
                        <div class="admin-card-header">
                            <div class="admin-card-title">üñ•Ô∏è Aktif Oturumlar</div>
                            <button class="btn btn-sm btn-ghost" onclick="loadActiveSessions()">üîÑ Yenile</button>
                        </div>
                        <p style="color:var(--txdark2);font-size:.85rem;margin-bottom:16px">
                            Sisteme giri≈ü yapmƒ±≈ü t√ºm kullanƒ±cƒ±larƒ±n aktif oturumlarƒ±nƒ± g√∂r√ºnt√ºleyin ve y√∂netin.
                        </p>
                        
                        <div id="activeSessionsList" style="margin-top:16px">
                            <div style="text-align:center;padding:40px;color:var(--tx2)">
                                <div style="font-size:2rem;margin-bottom:12px">üîÑ</div>
                                <div>Oturumlar y√ºkleniyor...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Oturum Ge√ßmi≈üi -->
                    <div class="admin-card" style="margin-top:16px">
                        <div class="admin-card-header">
                            <div class="admin-card-title">üìä Son Giri≈ü Aktiviteleri</div>
                        </div>
                        <div id="sessionHistoryList" style="margin-top:16px">
                            <div style="text-align:center;padding:40px;color:var(--tx2)">
                                <div style="font-size:2rem;margin-bottom:12px">üìä</div>
                                <div>Ge√ßmi≈ü y√ºkleniyor...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Puantaj Kurallarƒ± -->
                <div class="admin-section" id="admin-puantajKurallar">
                    <div class="admin-card">
                        <div class="admin-card-header">
                            <div class="admin-card-title">‚≠ê Puantaj Kurallarƒ±</div>
                            <button class="btn btn-sm btn-primary" onclick="showAddPuantajRuleModal()">+ Kural Ekle</button>
                        </div>
                        <p style="color:var(--txdark2);font-size:.85rem;margin-bottom:16px">Puantaj deƒüerlendirmesinde kullanƒ±lacak kurallarƒ± belirleyin. Kurallar otomatik olarak prim hesaplamasƒ±nƒ± etkiler.</p>
                        <div class="admin-list" id="puantajRulesList">
                            <p style="color:var(--tx2);text-align:center;padding:20px">Kurallar y√ºkleniyor...</p>
                        </div>
                    </div>
                </div>

                <!-- ≈ûubeler -->
                <div class="admin-section" id="admin-subeler">
                    <div class="admin-card">
                        <div class="admin-card-header">
                            <div class="admin-card-title">üìç ≈ûubeler</div>
                            <button class="btn btn-sm btn-primary" onclick="addBranch()">+ Ekle</button>
                        </div>
                        <div class="admin-list" id="branchList"></div>
                    </div>
                </div>

                <!-- Pozisyonlar -->
                <div class="admin-section" id="admin-pozisyonlar">
                    <div class="admin-card">
                        <div class="admin-card-header">
                            <div class="admin-card-title">üëî Pozisyonlar</div>
                            <button class="btn btn-sm btn-primary" onclick="addPosition()">+ Ekle</button>
                        </div>
                        <div class="admin-list" id="positionList"></div>
                    </div>
                </div>

                <!-- ƒ∞hlaller -->
                <div class="admin-section" id="admin-ihlaller">
                    <div class="admin-card">
                        <div class="admin-card-header">
                            <div class="admin-card-title">‚ö†Ô∏è ƒ∞hlal Kataloƒüu</div>
                            <button class="btn btn-sm btn-primary" onclick="addViolation()">+ Ekle</button>
                        </div>
                        <div class="admin-list" id="violationAdminList"></div>
                    </div>
                </div>

                <!-- ≈ûablonlar -->
                <div class="admin-section" id="admin-sablonlar">
                    <div class="admin-card">
                        <div class="admin-card-header"><div class="admin-card-title">üìÑ S√∂zle≈üme ≈ûablonlarƒ±</div></div>
                        <p style="color:var(--txdark2);font-size:.85rem;margin-bottom:16px">Her pozisyon i√ßin HTML ≈üablon d√ºzenleyin. Placeholder'lar: <code style="background:var(--surface3);padding:2px 6px;border-radius:4px">{{AD_SOYAD}}</code>, <code style="background:var(--surface3);padding:2px 6px;border-radius:4px">{{TC}}</code>, <code style="background:var(--surface3);padding:2px 6px;border-radius:4px">{{ADRES}}</code>, <code style="background:var(--surface3);padding:2px 6px;border-radius:4px">{{IBAN}}</code>, <code style="background:var(--surface3);padding:2px 6px;border-radius:4px">{{UCRET}}</code>, <code style="background:var(--surface3);padding:2px 6px;border-radius:4px">{{BASLAMA}}</code>, <code style="background:var(--surface3);padding:2px 6px;border-radius:4px">{{SUBE}}</code></p>
                        <div class="form-group">
                            <label class="form-label">Pozisyon Se√ß</label>
                            <select id="template_pozisyon" class="form-select" onchange="loadTemplate()"></select>
                        </div>
                        <div class="form-group" style="margin-top:16px">
                            <label class="form-label">≈ûablon ƒ∞√ßeriƒüi (HTML)</label>
                            <textarea id="template_content" class="form-textarea" style="min-height:300px;font-family:var(--mono);font-size:.8rem"></textarea>
                        </div>
                        <div class="btn-group"><button class="btn btn-primary btn-sm" onclick="saveTemplate()">≈ûablonu Kaydet</button></div>
                    </div>
                </div>

                <!-- Belge ≈ûablonlarƒ± -->
                <div class="admin-section" id="admin-belgeler">
                    <div class="admin-card">
                        <div class="admin-card-header">
                            <div class="admin-card-title">üìù Belge ≈ûablonlarƒ± D√ºzenleyici</div>
                            <div id="docTemplateUnsaved" style="display:none;color:var(--yellow);font-size:.8rem;font-weight:500">‚ö†Ô∏è Kaydedilmemi≈ü deƒüi≈üiklikler</div>
                        </div>
                        <p style="color:var(--txdark2);font-size:.85rem;margin-bottom:16px">Tutanak, savunma, fesih ve bor√ß ikrar belgelerinin i√ßeriklerini d√ºzenleyin. Deƒüi≈üiklikler kaydedilmezse varsayƒ±lan ≈üablonlar kullanƒ±lƒ±r.</p>
                        
                        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px">
                            <button class="btn btn-sm btn-primary" onclick="selectDocTemplateCategory('tutanak')">üìã Tutanak</button>
                            <button class="btn btn-sm btn-ghost" onclick="selectDocTemplateCategory('savunma')">üìù Savunma</button>
                            <button class="btn btn-sm btn-ghost" onclick="selectDocTemplateCategory('fesih')">‚ö†Ô∏è Fesih</button>
                            <button class="btn btn-sm btn-ghost" onclick="selectDocTemplateCategory('borc')">üí∞ Bor√ß ƒ∞krar</button>
                        </div>
                        
                        <!-- Tutanak Alt T√ºrleri -->
                        <div id="docTemplate-tutanak" class="doc-template-panel">
                            <div class="form-group">
                                <label class="form-label">Tutanak T√ºr√º</label>
                                <select class="form-select" id="tutanak_sub_type" onchange="loadDocTemplate('tutanak', this.value)">
                                    <option value="olay">Olay Tespit Tutanaƒüƒ±</option>
                                    <option value="devamsizlik">Devamsƒ±zlƒ±k Tutanaƒüƒ±</option>
                                    <option value="kasa">Kasa A√ßƒ±ƒüƒ± Tutanaƒüƒ±</option>
                                    <option value="imza">ƒ∞mzadan ƒ∞mtina Tutanaƒüƒ±</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Savunma -->
                        <div id="docTemplate-savunma" class="doc-template-panel" style="display:none">
                            <p style="color:var(--txdark2);font-size:.85rem">Savunma isteme yazƒ±sƒ± ≈üablonu</p>
                        </div>
                        
                        <!-- Fesih Alt T√ºrleri -->
                        <div id="docTemplate-fesih" class="doc-template-panel" style="display:none">
                            <div class="form-group">
                                <label class="form-label">Fesih T√ºr√º</label>
                                <select class="form-select" id="fesih_sub_type" onchange="loadDocTemplate('fesih', this.value)">
                                    <option value="hakli">Haklƒ± Fesih (25/II)</option>
                                    <option value="gecerli">Ge√ßerli Fesih (18)</option>
                                    <option value="deneme">Deneme S√ºresi Feshi</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Bor√ß ƒ∞krar -->
                        <div id="docTemplate-borc" class="doc-template-panel" style="display:none">
                            <p style="color:var(--txdark2);font-size:.85rem">Bor√ß ikrar ve mahsup muvafakatnamesi ≈üablonu</p>
                        </div>
                        
                        <div class="form-group" style="margin-top:16px">
                            <label class="form-label">≈ûablon A√ßƒ±klamasƒ± <span style="color:var(--txdark2);font-size:.75rem">(Yer tutucular: {{PERSONEL}}, {{TC}}, {{SUBE}}, {{TARIH}}, {{SAAT}}, {{ACIKLAMA}}, {{DAYANAK}})</span></label>
                            <textarea id="doc_template_content" class="form-textarea" style="min-height:250px;font-family:var(--mono);font-size:.8rem" oninput="trackDocTemplateChanges()"></textarea>
                        </div>
                        
                        <div class="btn-group" style="display:flex;gap:8px;flex-wrap:wrap">
                            <button class="btn btn-primary btn-sm" onclick="saveDocTemplate()">üíæ ≈ûablonu Kaydet</button>
                            <button class="btn btn-ghost btn-sm" onclick="previewDocTemplate()">üëÅÔ∏è √ñnizle</button>
                            <button class="btn btn-sm" style="background:var(--yellow);color:#000" onclick="resetDocTemplate()">üîÑ Varsayƒ±lana D√∂n</button>
                        </div>
                    </div>
                </div>

                <!-- Aktiviteler (Sadece Y√∂netici) -->
                <div class="admin-section" id="admin-aktiviteler">
                    <div class="admin-card">
                        <div class="admin-card-header">
                            <div class="admin-card-title">üìä Kullanƒ±cƒ± Aktiviteleri</div>
                            <button class="btn btn-sm btn-ghost" onclick="loadActivityLogs()">üîÑ Yenile</button>
                        </div>
                        <p style="color:var(--tx2);font-size:.85rem;margin-bottom:16px">Kullanƒ±cƒ±larƒ±n sistem √ºzerindeki hareketlerini takip edin.</p>
                        <div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap">
                            <select id="activityUserFilter" class="form-select" style="min-width:160px" onchange="loadActivityLogs()">
                                <option value="">T√ºm Kullanƒ±cƒ±lar</option>
                            </select>
                            <select id="activityTypeFilter" class="form-select" style="min-width:140px" onchange="loadActivityLogs()">
                                <option value="">T√ºm Aktiviteler</option>
                                <option value="login">Giri≈ü</option>
                                <option value="logout">√áƒ±kƒ±≈ü</option>
                                <option value="page_view">Sayfa G√∂r√ºnt√ºleme</option>
                                <option value="document_create">Belge Olu≈üturma</option>
                                <option value="data_edit">Veri D√ºzenleme</option>
                            </select>
                            <input type="date" id="activityDateFilter" class="form-input" style="width:160px" onchange="loadActivityLogs()">
                        </div>
                        <div class="admin-list" id="activityLogList" style="max-height:500px;overflow-y:auto">
                            <p style="color:var(--tx2);text-align:center;padding:20px">Aktiviteler y√ºkleniyor...</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script>
// ==================== FIREBASE CONFIG ====================
const firebaseConfig = {
    apiKey: "AIzaSyCbc-8oWwOj2eR0J19f3T-UYT9vGI8PL7M",
    authDomain: "moonberry-ik.firebaseapp.com",
    projectId: "moonberry-ik",
    storageBucket: "moonberry-ik.firebasestorage.app",
    messagingSenderId: "4872042742",
    appId: "1:4872042742:web:24a9e5935e2b5591a794d7"
};

// Firebase deƒüi≈ükenleri - DOMContentLoaded'da initialize edilecek
let db = null;

// ==================== AUTH & SESSION ====================
let currentUser = null;

// Varsayƒ±lan puantaj kurallarƒ±

// ==================== CONFIG FROM FIREBASE ====================
// T√ºm config verileri Firebase'den y√ºklenir
// HTML kaynaƒüƒ±nda hassas veri bulunmaz

let CONFIG = {
    company: {},
    branches: [],
    branchCodes: {},
    positions: [],
    violations: [],
    puantajRules: [],
    fesihDayanaklari: {},
    documentTemplates: {},
    contractTemplates: {}
};

// Firebase'den config y√ºkle
async function loadConfigFromFirebase() {
    try {
        const configDocs = [
            'company', 'branches', 'positions', 'violations',
            'puantajRules', 'fesihDayanaklari', 'documentTemplates',
            'contractTemplates', 'system', 'checklistTypes'
        ];
        
        const promises = configDocs.map(doc => 
            db.collection('config').doc(doc).get()
        );
        
        const results = await Promise.all(promises);
        
        results.forEach((snap, i) => {
            if (snap.exists) {
                const data = snap.data();
                const docName = configDocs[i];
                
                switch(docName) {
                    case 'company':
                        CONFIG.company = data;
                        break;
                    case 'branches':
                        CONFIG.branches = data.list || [];
                        CONFIG.branchCodes = data.codes || {};
                        break;
                    case 'positions':
                        CONFIG.positions = data.list || [];
                        break;
                    case 'violations':
                        CONFIG.violations = data.list || [];
                        break;
                    case 'puantajRules':
                        CONFIG.puantajRules = data.list || [];
                        break;
                    case 'fesihDayanaklari':
                        CONFIG.fesihDayanaklari = {
                            hakli: data.hakli || [],
                            gecerli: data.gecerli || [],
                            deneme: data.deneme || []
                        };
                        break;
                    case 'documentTemplates':
                        CONFIG.documentTemplates = data;
                        break;
                    case 'contractTemplates':
                        CONFIG.contractTemplates = data;
                        break;
                    case 'system':
                        SYSTEM_CONFIG = data;
                        PLATFORMS = data.platforms || [];
                        WHATSAPP_GROUPS = data.whatsappGroups || {};
                        break;
                    case 'checklistTypes':
                        CHECKLIST_TYPES = data;
                        break;
                }
            }
        });
        
        console.log('‚úÖ Config Firebase\'den y√ºklendi');
        return true;
    } catch (error) {
        console.error('‚ùå Config y√ºkleme hatasƒ±:', error);
        return false;
    }
}

// ==================== STATE MANAGEMENT ====================
let STATE = {};
let currentPage = 'dashboard';
let previousPage = 'dashboard';
let selectedTypes = {sozlesme: 'barista', tutanak: null, fesih: null};

function loadState() {
    // STATE artƒ±k CONFIG'dan besleniyor
    // CONFIG Firebase'den y√ºklendikten sonra STATE'e aktarƒ±lƒ±r
    STATE = {
        company: CONFIG.company || {},
        branches: CONFIG.branches || [],
        branchCodes: CONFIG.branchCodes || {},
        positions: CONFIG.positions || [],
        violations: CONFIG.violations || [],
        templates: CONFIG.contractTemplates || {},
        fesihDayanaklari: CONFIG.fesihDayanaklari || {},
        documentTemplates: CONFIG.documentTemplates || {}
    };
    
    // LocalStorage'dan kullanƒ±cƒ± tercihlerini y√ºkle
    const saved = localStorage.getItem('moonberry_state');
    if (saved) {
        try {
            const parsed = JSON.parse(saved);
            // Sadece kullanƒ±cƒ± tercihlerini merge et, config verilerini deƒüil
            if (parsed.preferences) {
                STATE.preferences = parsed.preferences;
            }
        } catch(e) {
            console.log('LocalStorage parse hatasƒ±');
        }
    }
}

function saveState() {
    localStorage.setItem('moonberry_state', JSON.stringify(STATE));
}

// ==================== INIT ====================
document.addEventListener('DOMContentLoaded', () => {
    // Firebase Initialize
    if (typeof firebase !== 'undefined') {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        console.log('Firebase initialized');
        
        // Auth State Listener - Kullanƒ±cƒ± oturum durumunu takip et
        firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                // Kullanƒ±cƒ± giri≈ü yapmƒ±≈ü
                console.log('User logged in:', user.email);
                
                // Kullanƒ±cƒ± bilgilerini Firestore'dan al
                try {
                    // √ñnce config'i y√ºkle (email mapping i√ßin)
                    await loadSystemConfig();
                    
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        currentUser = { id: user.uid, email: user.email, ...userDoc.data() };
                    } else {
                        // Email'den kullanƒ±cƒ± bilgisi al
                        const emailMatch = personnelMapping.find(p => p.email?.toLowerCase() === user.email?.toLowerCase());
                        const isAdmin = user.email === 'admin@moonberrycoffee.com' || user.email === 'tamer@moonberrycoffee.com';
                        
                        currentUser = {
                            id: user.uid,
                            email: user.email,
                            name: emailMatch?.name || (isAdmin ? 'Y√∂netici' : user.email.split('@')[0]),
                            role: emailMatch?.role || (isAdmin ? 'yonetici' : 'barista'),
                            branch: emailMatch?.branch || (isAdmin ? 'all' : '')
                        };
                    }
                    
                    // Kullanƒ±cƒ± adƒ±nƒ± sidebar'da g√∂ster
                    document.getElementById('userName').textContent = currentUser.name || currentUser.email;
                    document.getElementById('userRole').textContent = getRoleName(currentUser.role);
                    
                    // Session durumunu kontrol et
                    const sessionValid = await checkSessionValidity();
                    if (!sessionValid) {
                        console.log('Session invalid - logging out');
                        await firebase.auth().signOut();
                        window.location.replace('login.html');
                        return;
                    }
                    
                    // Uygulama g√∂r√ºn√ºr
                    document.querySelector('.app').style.opacity = '1';
                    applyUserPermissions();
                    loadFirebaseData();
                    
                    // √ñnizleme modunu kontrol et
                    checkPreviewMode();
                    
                    // Giri≈ü aktivitesini logla
                    logActivity('login', { device: navigator.userAgent });
                } catch (error) {
                    console.error('Error loading user data:', error);
                }
            } else {
                // Kullanƒ±cƒ± √ßƒ±kƒ±≈ü yapmƒ±≈ü - Login sayfasƒ±na y√∂nlendir
                console.log('User logged out - redirecting to login');
                window.location.replace('login.html');
            }
        });
    } else {
        console.error('Firebase SDK not loaded');
    }
    
    loadState();
    initDefaultData();
    initUI();
});

// √áƒ±kƒ±≈ü yap fonksiyonu
async function logout() {
    try {
        // √áƒ±kƒ±≈ü aktivitesini logla (currentUser silinmeden √∂nce)
        await logActivity('logout', { reason: 'user_initiated' });
        
        // Oturumu sonlandƒ±r
        if (currentUser?.sessionId) {
            try {
                await db.collection('sessions').doc(currentUser.sessionId).update({
                    status: 'ended',
                    endedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (e) {
                console.error('Oturum sonlandƒ±rma hatasƒ±:', e);
            }
        }
        
        // Session bilgilerini temizle
        localStorage.removeItem('mb_session_id');
        
        // Session timeout'larƒ± temizle
        if (sessionTimeoutId) clearTimeout(sessionTimeoutId);
        if (sessionWarningId) clearTimeout(sessionWarningId);
        
        await firebase.auth().signOut();
        currentUser = null;
        
        // Login sayfasƒ±na y√∂nlendir
        window.location.replace('login.html');
    } catch (error) {
        console.error('Logout error:', error);
        toast('√áƒ±kƒ±≈ü hatasƒ±', 'error');
    }
}

// Sidebar nav grup toggle
function toggleNavGroup(label) {
    label.classList.toggle('collapsed');
    const items = label.nextElementSibling;
    if (items) {
        items.classList.toggle('collapsed');
    }
}

function initUI() {
    document.getElementById('companyName').textContent = STATE.company.name;
    populateSelects();
    renderPositionCards();
    renderViolations();
    renderAdminLists();
    loadAdminFields();
    setDefaultDates();
    
    // Belge ≈üablonlarƒ± i√ßin varsayƒ±lanƒ± y√ºkle
    if (document.getElementById('doc_template_content')) {
        loadDocTemplate('tutanak', 'olay');
    }
}

function setDefaultDates() {
    const now = new Date();
    const dateStr = now.toISOString().split('T')[0];
    const timeStr = now.toTimeString().slice(0, 5);
    
    // Tutanak varsayƒ±lan tarih/saatleri
    const tutTarih = document.getElementById('tut_tarih');
    const tutSaat = document.getElementById('tut_saat');
    const tutDuzTarih = document.getElementById('tut_duz_tarih');
    const tutDuzSaat = document.getElementById('tut_duz_saat');
    if (tutTarih) tutTarih.value = dateStr;
    if (tutSaat) tutSaat.value = timeStr;
    if (tutDuzTarih) tutDuzTarih.value = dateStr;
    if (tutDuzSaat) tutDuzSaat.value = timeStr;
    
    // Savunma varsayƒ±lan tarih
    const savTarih = document.getElementById('sav_tarih');
    const savDuzTarih = document.getElementById('sav_duz_tarih');
    const savDuzSaat = document.getElementById('sav_duz_saat');
    if (savTarih) savTarih.value = dateStr;
    if (savDuzTarih) savDuzTarih.value = dateStr;
    if (savDuzSaat) savDuzSaat.value = timeStr;
    
    // Fesih varsayƒ±lan tarihler
    const fesOgrenme = document.getElementById('fes_ogrenme');
    const fesTarih = document.getElementById('fes_tarih');
    if (fesOgrenme) fesOgrenme.value = dateStr;
    if (fesTarih) fesTarih.value = dateStr;
    
    // Bor√ß varsayƒ±lan tarih
    const borcTarih = document.getElementById('borc_tarih');
    const borcDuzTarih = document.getElementById('borc_duz_tarih');
    if (borcTarih) borcTarih.value = dateStr;
    if (borcDuzTarih) borcDuzTarih.value = dateStr;
    
    // Avans varsayƒ±lan tarih
    const avansTarih = document.getElementById('avans_tarih');
    if (avansTarih) avansTarih.value = dateStr;
    
    // Zimmet varsayƒ±lan tarih
    const zimmetTarih = document.getElementById('zimmet_tarih');
    if (zimmetTarih) zimmetTarih.value = dateStr;
    
    // S√∂zle≈üme varsayƒ±lan ba≈ülama tarihi
    const sozBaslama = document.getElementById('soz_baslama');
    if (sozBaslama) sozBaslama.value = dateStr;
}

function populateSelects() {
    // ≈ûube selectleri
    const branchSelects = ['soz_sube', 'tut_sube', 'sav_sube', 'borc_sube', 'fes_sube', 'avans_sube', 'zimmet_sube'];
    branchSelects.forEach(id => {
        const sel = document.getElementById(id);
        if (sel) {
            sel.innerHTML = STATE.branches.map(b => `<option>${b}</option>`).join('');
        }
    });
    
    // Pozisyon selectleri
    const posSelects = ['tut_pozisyon', 'sav_pozisyon', 'fes_pozisyon', 'avans_pozisyon', 'zimmet_pozisyon'];
    posSelects.forEach(id => {
        const sel = document.getElementById(id);
        if (sel) {
            sel.innerHTML = STATE.positions.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        }
    });
    
    // Template select
    const tplSel = document.getElementById('template_pozisyon');
    if (tplSel) {
        tplSel.innerHTML = STATE.positions.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    }
}

// ≈ûube select populate - kullanƒ±cƒ± yetkisine g√∂re filtrele
function populateSubeSelect(selectId) {
    const sel = document.getElementById(selectId);
    if (!sel) return;
    
    const userBranch = currentUser?.branch;
    const isAdmin = currentUser?.role === 'yonetici' || currentUser?.role === 'bolge_muduru';
    
    let branches = STATE.branches || [];
    
    // Maƒüaza m√ºd√ºr√º sadece kendi ≈üubesini g√∂rs√ºn
    if (!isAdmin && userBranch) {
        branches = branches.filter(b => b === userBranch);
    }
    
    sel.innerHTML = branches.map(b => `<option value="${b}">${b}</option>`).join('');
    
    // Maƒüaza m√ºd√ºr√º ise kendi ≈üubesini se√ß
    if (!isAdmin && userBranch) {
        sel.value = userBranch;
    } else {
        // Admin/B√∂lge M√ºd√ºr√º i√ßin default: Tuzla Port
        const tuzlaOption = Array.from(sel.options).find(o => o.value.toLowerCase().includes('tuzla'));
        if (tuzlaOption) {
            sel.value = tuzlaOption.value;
        }
    }
}

function renderPositionCards() {
    const container = document.getElementById('sozlesmePozisyonlar');
    if (!container) return;
    container.innerHTML = STATE.positions.map((p, i) => `
        <div class="type-card${i === 0 ? ' selected' : ''}" data-type="${p.id}" onclick="selectType('sozlesme','${p.id}',this)">
            <div class="type-card-icon">${p.type === 'Mavi Yaka' ? '‚òï' : p.type === 'Gri Yaka' ? 'üìã' : p.type === 'Beyaz Yaka' ? 'üè™' : 'üåç'}</div>
            <div class="type-card-title">${p.name}</div>
            <div class="type-card-sub">${p.type}</div>
        </div>
    `).join('');
}

// ==================== VARSAYILAN VERƒ∞LERƒ∞ KONTROL ET ====================
function initDefaultData() {
    // Varsayƒ±lan verileri kontrol et ve olu≈ütur
    initializeDefaultData();
}

async function initializeDefaultData() {
    try {
        // Varsayƒ±lan puantaj kurallarƒ±nƒ± kontrol et
        const rulesRef = db.collection('puantajRules');
        const rulesSnapshot = await rulesRef.get();
        if (rulesSnapshot.empty) {
            for (const rule of CONFIG.puantajRules) {
                await rulesRef.doc(rule.id).set(rule);
            }
            console.log('Varsayƒ±lan puantaj kurallarƒ± olu≈üturuldu');
        }
        
        // Varsayƒ±lan geli≈ümi≈ü izinleri kontrol et
        const advPermsRef = db.collection('advancedPermissions');
        const advPermsSnapshot = await advPermsRef.get();
        if (advPermsSnapshot.empty) {
            for (const [role, perms] of Object.entries(DEFAULT_ROLE_PERMISSIONS)) {
                await advPermsRef.doc(role).set(perms);
            }
            console.log('Varsayƒ±lan geli≈ümi≈ü izinler olu≈üturuldu');
        }
    } catch (error) {
        console.error('Firebase initialization error:', error);
    }
}

async function handleLogin(event) {
    // Login artƒ±k login.html'de yapƒ±lƒ±yor
    if (event) event.preventDefault();
    window.location.replace('login.html');
}

// ≈ûifremi unuttum - login.html'e y√∂nlendir
function showForgotPassword(event) {
    if (event) event.preventDefault();
    window.location.replace('login.html');
}

async function sendPasswordReset() {
    const email = document.getElementById('resetEmail').value.trim();
    if (!email) {
        toast('E-posta adresi girin', 'error');
        return;
    }
    
    try {
        await firebase.auth().sendPasswordResetEmail(email);
        closeModal();
        toast('≈ûifre sƒ±fƒ±rlama baƒülantƒ±sƒ± g√∂nderildi', 'success');
    } catch (error) {
        console.error('Password reset error:', error);
        let msg = 'Hata olu≈ütu';
        if (error.code === 'auth/user-not-found') {
            msg = 'Bu e-posta ile kayƒ±tlƒ± kullanƒ±cƒ± bulunamadƒ±';
        }
        toast(msg, 'error');
    }
}

function applyUserPermissions() {
    if (!currentUser) return;
    
    // Sidebar'da kullanƒ±cƒ± bilgilerini g√ºncelle
    const userNameEl = document.getElementById('userName');
    const userRoleEl = document.getElementById('userRole');
    const userAvatarEl = document.getElementById('userAvatar');
    
    if (userNameEl) userNameEl.textContent = currentUser.name || currentUser.email;
    if (userRoleEl) {
        const roleNames = {
            'yonetici': 'Y√∂netici',
            'bolge_muduru': 'B√∂lge M√ºd√ºr√º',
            'magaza_muduru': 'Maƒüaza M√ºd√ºr√º',
            'barista': 'Barista'
        };
        userRoleEl.textContent = roleNames[currentUser.role] || currentUser.role;
    }
    if (userAvatarEl && currentUser.name) {
        userAvatarEl.textContent = currentUser.name.charAt(0).toUpperCase();
    }
    
    // Y√∂netici her ≈üeye eri≈üebilir + Kullanƒ±cƒ± G√∂z√ºnden G√∂r butonu
    if (currentUser.role === 'yonetici') {
        const btn = document.getElementById('btnImpersonate');
        if (btn) btn.style.display = 'flex';
        return;
    }
    
    // Barista kƒ±sƒ±tlamalarƒ±
    if (currentUser.role === 'barista') {
        applyBaristaRestrictions();
    }
    
    // Geli≈ümi≈ü izin sistemini y√ºkle ve uygula
    loadUserAdvancedPermissions();
}

// Barista kƒ±sƒ±tlamalarƒ± - Puantaj, Shift, Checklist (sadece g√∂r√ºnt√ºleme ve checklist doldurma)
function applyBaristaRestrictions() {
    // ƒ∞zin verilen sayfalar - Barista bunlarƒ± g√∂rebilir
    const allowedPages = ['dashboard', 'puantaj', 'shift', 'checklist'];
    
    // Navbar men√ºlerini kƒ±sƒ±tla
    document.querySelectorAll('.nav-item[data-page]').forEach(item => {
        const page = item.dataset.page;
        if (!allowedPages.includes(page)) {
            item.style.display = 'none';
        }
    });
    
    // Nav gruplarƒ±nƒ± kontrol et - bo≈ü olanlarƒ± gizle
    document.querySelectorAll('.nav-group').forEach(group => {
        const visibleItems = group.querySelectorAll('.nav-item:not([style*="display: none"])');
        if (visibleItems.length === 0) {
            group.style.display = 'none';
        }
    });
    
    // Dashboard kartlarƒ±nƒ± kƒ±sƒ±tla
    document.querySelectorAll('.dashboard-card').forEach(card => {
        const onclick = card.getAttribute('onclick') || '';
        const allowedCards = ['puantaj', 'shift', 'checklist'];
        const isAllowed = allowedCards.some(p => onclick.includes(`'${p}'`));
        if (!isAllowed && onclick.includes('goTo')) {
            card.style.display = 'none';
        }
    });
    
    // Dashboard section'larƒ± kontrol et - Belgeler ve Sistem b√∂l√ºmlerini gizle
    document.querySelectorAll('.dashboard-section').forEach(section => {
        const header = section.querySelector('div');
        if (header && header.textContent.includes('Belgeler')) {
            section.style.display = 'none';
        }
        if (header && header.textContent.includes('Sistem')) {
            section.style.display = 'none';
        }
    });
    
    // Barista badge'i ekle
    const userRoleEl = document.getElementById('userRole');
    if (userRoleEl) {
        userRoleEl.innerHTML = '<span style="background:var(--accent);color:#fff;padding:2px 8px;border-radius:10px;font-size:.65rem">SALT OKUNUR</span> Barista';
    }
}

async function loadFirebaseData() {
    // Personel listesini y√ºkle
    loadPersonelList();
    
    // Puantaj ≈üube se√ßeneklerini doldur - kullanƒ±cƒ± yetkisine g√∂re filtrele
    populateSubeSelect('puantajSube');
    
    // Mevcut ayƒ± se√ß
    const now = new Date();
    const aySelect = document.getElementById('puantajAy');
    if (aySelect) aySelect.value = String(now.getMonth() + 1).padStart(2, '0');
}

// ==================== NAVIGATION ====================
const PAGE_NAMES = {
    'dashboard': 'Ana Sayfa',
    'personel': 'Personel Listesi',
    'puantaj': 'Puantaj',
    'shift': 'Shift Planƒ±',
    'checklist': 'Checklist',
    'sozlesme': 'ƒ∞≈ü S√∂zle≈ümesi',
    'tutanak': 'Tutanak',
    'savunma': 'Savunma ƒ∞steme',
    'fesih': 'Fesih',
    'borc': 'Bor√ß ƒ∞krar',
    'avans': 'Avans Talebi',
    'zimmet': 'Zimmet Formu',
    'katalog': 'ƒ∞hlal Kataloƒüu',
    'admin': 'Y√∂netim'
};

function goTo(page) {
    // Aktivite logla
    logActivity('page_view', { page: page, from: currentPage });
    
    // Yetki kontrol√º
    if (currentUser && currentUser.role !== 'yonetici') {
        // Permission check from Firebase would go here
    }
    
    previousPage = currentPage;
    currentPage = page;
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-' + page).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    const navItem = document.querySelector(`.nav-item[data-page="${page}"]`);
    if (navItem) navItem.classList.add('active');
    
    // Breadcrumb g√ºncelle (tam sayfa adƒ±)
    const pageName = document.getElementById('currentPageName');
    if (pageName) pageName.textContent = PAGE_NAMES[page] || page;
    
    if (page === 'katalog') renderViolations();
    if (page === 'admin') renderAdminLists();
    if (page === 'personel') loadPersonelList();
    if (page === 'puantaj') { 
        populateSubeSelect('puantajSube'); 
        // ≈ûimdiki ay ve yƒ±lƒ± se√ß
        const now = new Date();
        const aySelect = document.getElementById('puantajAy');
        const yilSelect = document.getElementById('puantajYil');
        if (aySelect) aySelect.value = String(now.getMonth() + 1).padStart(2, '0');
        if (yilSelect) yilSelect.value = String(now.getFullYear());
        loadPuantaj(); 
    }
    if (page === 'shift') { 
        populateSubeSelect('shiftSube'); 
        loadShiftList();
        // Y√∂netici i√ßin Excel y√ºkleme butonunu g√∂ster
        const adminExcel = document.getElementById('adminExcelUpload');
        if (adminExcel) {
            adminExcel.style.display = currentUser?.role === 'yonetici' ? 'block' : 'none';
        }
    }
    // Yeni sayfalar i√ßin dropdown'larƒ± doldur
    if (page === 'istifa') { 
        populateSubeSelect('istifa_sube'); 
        populatePozisyonSelect('istifa_pozisyon');
    }
    if (page === 'ibraname') { 
        populateSubeSelect('ibra_sube'); 
        populatePozisyonSelect('ibra_pozisyon');
    }
    // T√ºm belgeler ve formlar i√ßin ≈üube se√ßimi (Tuzla Port default)
    if (page === 'sozlesme') populateSubeSelect('soz_sube');
    if (page === 'tutanak') populateSubeSelect('tut_sube');
    if (page === 'savunma') populateSubeSelect('sav_sube');
    if (page === 'fesih') populateSubeSelect('fes_sube');
    if (page === 'borc') populateSubeSelect('borc_sube');
    if (page === 'avans') populateSubeSelect('avans_sube');
    if (page === 'zimmet') populateSubeSelect('zimmet_sube');
    // Checklist sayfasƒ±
    if (page === 'checklist') {
        initChecklistPage();
    }
}

function goBack() { goTo(previousPage); }

// ==================== MODAL SYSTEM ====================
function showModal(title, body, footer) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalBody').innerHTML = body;
    document.getElementById('modalFooter').innerHTML = footer || '';
    document.getElementById('modalOverlay').classList.add('show');
}

function closeModal() {
    document.getElementById('modalOverlay').classList.remove('show');
}

function confirmModal(title, message, onConfirm, type = 'warning') {
    const icons = {warning: '‚ö†Ô∏è', danger: 'üóëÔ∏è', success: '‚úÖ', info: '‚ÑπÔ∏è'};
    showModal(title, `
        <div class="modal-icon ${type}">${icons[type]}</div>
        <div class="modal-message">${message}</div>
    `, `
        <button class="btn btn-ghost" onclick="closeModal()">ƒ∞ptal</button>
        <button class="btn ${type === 'danger' ? 'btn-danger' : 'btn-primary'}" onclick="closeModal(); (${onConfirm})()">Onayla</button>
    `);
}

function successModal(message) {
    showModal('Ba≈üarƒ±lƒ±', `
        <div class="modal-icon success">‚úÖ</div>
        <div class="modal-message">${message}</div>
    `, `<button class="btn btn-primary" onclick="closeModal()">Tamam</button>`);
}

// ==================== TOAST ====================
function toast(message, type = '') {
    const container = document.getElementById('toastContainer');
    const t = document.createElement('div');
    t.className = 'toast ' + type;
    const icons = {success: '‚úÖ', error: '‚ùå', '': 'üí°'};
    t.innerHTML = `<span class="toast-icon">${icons[type] || 'üí°'}</span>${message}`;
    container.appendChild(t);
    setTimeout(() => t.classList.add('show'), 10);
    setTimeout(() => {
        t.classList.remove('show');
        setTimeout(() => t.remove(), 300);
    }, 3000);
}

// ==================== TYPE SELECTION ====================
function selectType(form, type, el) {
    selectedTypes[form] = type;
    el.parentElement.querySelectorAll('.type-card').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    
    if (form === 'tutanak') {
        document.getElementById('tut_kasa_field').style.display = type === 'kasa' ? 'block' : 'none';
    }
}

function selectFesihType(type, el) {
    selectedTypes.fesih = type;
    el.parentElement.querySelectorAll('.type-card').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    
    document.getElementById('fes_ogrenme_field').style.display = type === 'hakli' ? 'block' : 'none';
    document.getElementById('fesih_6gun_alert').style.display = 'none';
    
    // Dayanak g√ºncelle
    const sel = document.getElementById('fes_dayanak');
    const opts = STATE.fesihDayanaklari[type] || [];
    sel.innerHTML = '<option value="">Se√ßiniz</option>' + opts.map(d => `<option value="${d.v}">${d.t}</option>`).join('');
}

function check6Gun() {
    if (selectedTypes.fesih !== 'hakli') return;
    const og = document.getElementById('fes_ogrenme').value;
    if (!og) return;
    const ogDate = new Date(og);
    const now = new Date();
    let gun = 0, tmp = new Date(ogDate);
    while (tmp <= now) {
        const d = tmp.getDay();
        if (d !== 0 && d !== 6) gun++;
        tmp.setDate(tmp.getDate() + 1);
    }
    document.getElementById('fesih_6gun_alert').style.display = gun > 6 ? 'flex' : 'none';
}

// ==================== FORM HELPERS ====================
function clearForm(prefix) {
    document.querySelectorAll(`[id^="${prefix}_"]`).forEach(el => {
        if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') el.value = '';
        if (el.tagName === 'SELECT') el.selectedIndex = 0;
    });
}

function getVal(id) {
    const el = document.getElementById(id);
    return el ? el.value.trim() : '';
}

function formatDate(d) {
    if (!d) return '___/___/______';
    return new Date(d).toLocaleDateString('tr-TR');
}

function today() {
    return new Date().toLocaleDateString('tr-TR');
}

function nowTime() {
    return new Date().toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'});
}

function nowDateTime() {
    const now = new Date();
    return now.toLocaleDateString('tr-TR') + ' ' + now.toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'});
}

// Benzersiz Belge Numaralandƒ±rma: YIL-≈ûUBEKODU-GGAASS
function docNo(prefix, sube) {
    const now = new Date();
    const yil = now.getFullYear().toString().slice(-2);
    const gun = now.getDate().toString().padStart(2, '0');
    const ay = (now.getMonth() + 1).toString().padStart(2, '0');
    const saat = now.getHours().toString().padStart(2, '0');
    const dakika = now.getMinutes().toString().padStart(2, '0');
    
    // ≈ûube kodunu bul
    let subeKod = 'MRK';
    if (sube && STATE.branchCodes) {
        subeKod = STATE.branchCodes[sube] || 'MRK';
    } else if (sube) {
        // Fallback: ƒ∞lk 3 harf
        subeKod = sube.replace(/[^A-Za-z√áƒûƒ∞√ñ≈û√ú√ßƒüƒ±√∂≈ü√º]/g, '').substring(0, 3).toUpperCase();
        if (subeKod === '≈ûƒ∞≈û' || subeKod === 'SIS') subeKod = 'SIS';
        if (subeKod === 'TUZ') subeKod = 'TZL';
    }
    
    return `${yil}-${subeKod}-${gun}${ay}${saat}${dakika}`;
}

// ==================== DOCUMENT GENERATION ====================
function showPreview(title, html) {
    document.getElementById('previewTitle').textContent = title;
    document.getElementById('previewContent').innerHTML = html;
    goTo('preview');
}

function printDoc() { window.print(); }

function downloadPDF() {
    const content = document.getElementById('previewContent');
    const title = document.getElementById('previewTitle').textContent;
    
    // PDF i√ßin wrapper olu≈ütur
    const wrapper = document.createElement('div');
    wrapper.style.fontFamily = "'Times New Roman', Times, serif";
    wrapper.style.fontSize = '11pt';
    wrapper.style.lineHeight = '1.6';
    wrapper.style.color = '#000';
    wrapper.style.backgroundColor = '#fff';
    
    // ƒ∞√ßeriƒüi kopyala
    const clone = content.cloneNode(true);
    clone.style.padding = '0';
    
    // T√ºm doc-article elementlerine page-break-inside: avoid ekle
    clone.querySelectorAll('.doc-article').forEach(el => {
        el.style.pageBreakInside = 'avoid';
        el.style.breakInside = 'avoid';
        el.style.marginBottom = '15px';
    });
    
    // T√ºm doc-article-title elementlerine page-break-after: avoid ekle
    clone.querySelectorAll('.doc-article-title').forEach(el => {
        el.style.pageBreakAfter = 'avoid';
        el.style.breakAfter = 'avoid';
    });
    
    wrapper.appendChild(clone);
    
    html2pdf().set({
        margin: [15, 15, 20, 15], // √ºst, saƒü, alt, sol
        filename: title.replace(/[^a-zA-Z0-9ƒü√º≈üƒ±√∂√ßƒû√ú≈ûƒ∞√ñ√á\s-]/g, '') + '.pdf',
        image: {type: 'jpeg', quality: 0.98},
        html2canvas: {scale: 2, useCORS: true, letterRendering: true, backgroundColor: null},
        jsPDF: {unit: 'mm', format: 'a4', orientation: 'portrait'},
        pagebreak: {mode: ['avoid-all', 'css', 'legacy'], avoid: ['.doc-article', '.doc-article-title', '.no-break']}
    }).from(wrapper).toPdf().get('pdf').then(function(pdf) {
        const totalPages = pdf.internal.getNumberOfPages();
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        
        for (let i = 1; i <= totalPages; i++) {
            pdf.setPage(i);
            
            // Alt √ßizgi
            pdf.setDrawColor(200);
            pdf.line(15, pageHeight - 15, pageWidth - 15, pageHeight - 15);
            
            // Sayfa numarasƒ± (orta alt)
            pdf.setFontSize(8);
            pdf.setTextColor(100);
            pdf.text('Sayfa ' + i + ' / ' + totalPages, pageWidth / 2, pageHeight - 8, {align: 'center'});
        }
    }).save();
}

// Logo Base64 (Yeni Moonberry Coffee Logo)
const LOGO_BASE64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAACwCAQAAADgIOm5AAAAAmJLR0QA/4ePzL8AAAAHdElNRQfpDB0CKim0QQKDAAAeIUlEQVR42u2deXwUVbbHv9XZ9xBCAlnAJEDYRSOjLCMqqCMoIDx1VNxQGZc3H2FwHYUZGRa38SkjIugAIijM4AIyuLKJIvuOJOxhCwlJyL531/sjlU5Xd1V1d3V3quPkdz8fPqTrVtW599S999xzzj1HwB8hEEEiXUgng84kE08sEYQRAoBIJTWUUkwepznBMU5ynlLMRpPtnab7EwSiSedyrqQPXWhPBIFO77FQwyXOcpjd7OEIRa2bMf7CEBMJZHEDg+hOO91UVXCKHWzkZ3KpM7pJ+uAPDIniKkYxnG7SlOQpzOSxjbVs4HTrHi0tD4EUJrKOckSvFzMnmM+NRBndyNYCE12ZyiEafMCM5lLBOh4i0S9mAj+GQDp/4RgWnzKjqdSzi6foZHSj/RcdmEx2CzGjeQLbzaPEGd10/0MIo9js42lKfaSs51YvCQ6/EmQwjzJDmNFUylhAptHd4B8IYhz7DWVGU8nmfsKM7g6j0YFXDR4btqWKBXQxukuMRF/WYjacDfKylev8URj2PUkCN/N3eum8u4oi8rlAPoWUUQaASAixxJJARzrSgRgCdD37PNP4yN9ULL5mSCD3MZtEN+8SKeEYe9nNYc5QTBX1iA6Umwglmo5kcDlX0Jtkgtx8TyVv8jrlPu4DP0IwUyh1ayKxkMcX/JGriMXkxptCSON25rCfGrfeV8984o3uppZCOC9T6UbnVLKJyfTxYKdgIpHRLOKsW5/Acjoa3VUtgTBmUOtytxTzMSOI9sqbA+nFVA65IUascHtSbXUIZprL7LjEYgZ7eQctkMJkDrmsoFn+62ZJAJOocKkjaljF9T5SZwhcxnTOuciSD4k1utt8h/FccqkTDvIAkT6lxEQWK1xa6M28+Wvdvw93aVGtZAEZLUJPBI9y3KXR+rTOHY1foyd7XWj8CR4gtMVoEujPGhcW+WLGGd193kZ7VrnAjvVkGUDZqy4I4Ue4wugu9CYCmen0O6xnEUmGUBfMRPKdsuSrX9NGcZzTfXk1s72029ADE6M56YRCCzN+LStJN6f2jkqeb8GVQxnDOep0JRlpdFd6A6F84JQdzxFsd5fJbYWg5xjqlCVbSTa6Oz3HXU6WzGpecGBHKHfS1wBab+SUE5bMcku16YdIZZdmAxt41WGySmAuq4gxhN6xXNSkt4Brje5STyAw3ckXt8Sh43uwlhruNYziJ6jSpHhVa/Z5zHKyN99Eqt0dV7Edkc0GekqF8Kam6rGG+4ztVP0I4n1NduQy0O6OQRxCpIGJhtKdwDeadG9rrXaSaynSXMwftat/hSQe7zNog9iM35CrQbmZSQbTpwvBLHGyeoTL6ndli3TlJaNJB/6XOg3aDzhMta0A12jKKzl2/ibt+Vy6cpY+RpMORGvq3iw8ZTSB7sLEOxoNqucJWe0gXrEupEtcOK7WEhiiqd/aQYLRBLqHTM0t1re0k9W+0+q9WOs3im4Tb2h+UuONJtA9/EmjMRXcJqvbjQM2s7M3zmt4R/GSyTGNVqyxWwP9GjH8oNGUf8tMosG8Z3Ntrldc9Dpxu1ee85JGKy4x2KDe1YEbNE4HlnOzrO4IG9V8nZcmrNF85xXXhK6aY+TVlu9YvXhVc6hH2NSMkW3CTpLmhbeH8jG13O7zluxtLS5C7dmh2og6fi+rO17mpbXaC44/QTxJJSI76O2FtlxFgWpbqluLfWSoxoS1WyYuxrJBdnWaR+8ViGIg71oltoM8RoaHLA7mXxpjZI7RXe0aXtRownRZzbEyz6g6RrvwdIFglQU7mLvZJrPdV/I5gz1c3u+hXrU1e+hgdGc7RyhrNCSTQTY1Q/i37Gq+S3v0MMaofPUCwaTxF6sGbSt30dHjbWZnjmgIKNcZ3d3OkabhLrBJZku40m5+3u/S95bBd3TVuG7iAUoR+cErAgKYWKgx4l9oqW7Vb6jM1NjabZQdgrnFjgHnpZNQ2hjOdQzXuG5hGUupZCYnvdITFtZhUb06yP+PUz+r+jVVcaNNvSg22l1f6MLTL2M3ItudOBsMZoUX7Xo9NByzT/j7IVGThtI9R9aNAxysJbOdPr0Dy6S68zU3frGytcpTRLBeQ/S9qaU6Vh8iNeb3gxTY/HW1g5m2UPPJQQziQ+6W/nqYRRpnR0rZ6sW+qGSP6rVQ+nnxTRrQK5vEaVj79lFv/X+Ag/kWqlXvbM9NjGEY7W3uH8P1bGYFayl2qC8i4k3sRVQVnkdwTvF3kWqqESnjLAU2LdcJvQxJsFOsN8PMLzZ/tVPYR9eqPrWBOiwOQcdKyKWwRUKRHaFc1dH1elXR14wZqCWfHazke2NO9Y5W3UZd4iqbev0pdKjxgOaTg7iST6xPr+NDerSY01qqS+dItEo1nxvjP/8HVZKOy+zQYxQY97jTp0cxFxERM//n4xNW9u/d4iFDRESO2Om53YLeb0/dsFko22WkKUyKzo1K5cxiJ7CRWVR4p69dQjV5XnhKN/7BlXpv1ssQ9b12oWzRTlGo0R7nOMdH1DCPi17oINfRIJMP9aMbL+i1M+pjiKCxOyimwebpSpYE16wL37GOn7zSPe6gyEvPuZmr9d2ojyEmjfOqFTYKiEBFxiU7eMEr4RRzvdY9rsNbE2QUw/TdqI8hARoD0rZJgYqKjVSX1B01fKch1Yeqit2ewRUtm2voo88BQy9D1M9BVTq9u5NLHiciDRrbvl6M1UW5M3gvWFO8PnWkEcdS4rwQ9XAME33iwua9cFUB+p7lfYY4P0MYyAAP3zGEhxjAYz7wffRefxRpaCS8TkCDxuJnq3oQbSQuWwz0QGkeyE3MIwWBZ3jW6/FJvHeeK1vf9KePIRYN7ofbDNV6ShXr9NE5aQUyhPdZIZmAI3mZNUz0qr3bW16K1azXd6M+hpg1pJE4m4mkQUFD21jnBl3vFSnmmM1msYZ8Cr0aNdFbJ7o2t/Qe6nVVTc5Psunob6pWd/2TQ0/J6e4sd3nZsBrAci/oskTydH5wHuAZDdWaraXkUZValfzOg7f34BefHIgLdzA36ykXuE+/tKZXqshT3SPEyeb0U9SoNP0eDzzXs1nEdj7Vfb8aYjx2Gq1nE/eyTL/hTK/geJ4aFfVJNJ3ZZ/0rlyIVR4VbuIqfdTd8Lfk+UKwkau5tLBrXGqimgD2s4hvP6NLLkDzKVBgSRE++tKl3SoUh8TzCTt0mzyNecv6RI10jMM4G3tW4s4IiznvDhKsX8exTnUOXyqLpzFGtV8T1RpGvgr9qrAzPtQwJeteQUk6oXusrEx63qFrD45jkV9ESgjWMrzUaHilehV6G1HNI9dpldLf5a6eKtwbA77irZZrpEjppHGzI40jLEKFfd7NP9cuP5hqbv3I1fKeCmeJH6VX6Kto3G/GLV4y7LkA/Qw5pmFevs1Ex1vMfDReeHvqNnV7HdRrbzG36VIUtiUg2aexUbaNgpfKLpuOMsRFPmhCvEWCqUtPt26vQP0IqNKaijrIGnGG1xnNCedGrHrp6kUUP1WsnOWg0ea5gpEbE6A0yif4KzmsqGzYb7lsu8K4GfR+0jvhySRpTUYXMWzxAcnxTL8sMjryeoeGzWM+dhtLmMkzM1+jixTJd1ZVOxoiZNw1d3Cdr0HaEzkZ3tasYozFp5fMbm5omXnEyRmqZatgppUSNA94i77eOCauxIVpx3ufJVChpTqP6VvFng1jysEbu0Wq7iC1+jpkaHZwv2yDCeCdhJ0WqmCGL/9Ay6Mg2DZq2ueT66jcYoBm+bKnMByWMfzphiEgd77b4mfBJmvHqW+z8rXcQohkBocIuEkk6O52yxMJqjR2B95FJjgY1p3VnYDQMozQnoi12R99uJM8pS0T2c1sLxZsLciKQz209C3oTYvhes0mzZUu7wESXslMVM7tFgrTerpmht1DhhGQrwO81czzZ5xpwNX+bhZ+4zcdSV5qTAOlLXPLT9zs4GyO77Y5Qh/Omiynuy1nCb3yWPyFcM5iGSCFDjO5avRjrJDPCJ3ZeWFG8pRkv17YUsIAhHuZPExTcckxMcjJS3/OTuKk6EMFKzaY1MNNu8EfwstNdSXO5xGoe5DIdHRRAAjcwQUGUHuUkP8JpLje6Wz3BYCfZnSp50k5eCeFJJ11iz9QTLGMiWcQ5TUlkIpI0hjGZpRzmKPc4yErXaARjaixTjcm27q2XmpjJ85o1inmKj2W+TSZG8IqbAfpESjhFDkc4yXmKqaCWWkAgjBCiiCORzqSRQWc6EAbs5RnWIXdc68dCJ3nitjKO817qG4OQwnYn39xFhS+1ByvcSGEsl8JqKOECuRzlKMc4RwFl1MpSUFTwHpc5UJrJj06eXcYYo7vTGxjtNEdbAeMdWBLFE5zQxRLtYmYrYxXE5n785PTeOQZkxvIBgjR84ptKIY87yPYCvXmfEq+y4xjPKW4sr3FBebO19dg/nKEj65w2t4LpCg6bwQzjc40op+6UXGbTXVHQHeU0P5tIviz8WqvH1U4TN4rUs1QxTmI4N/KRC7k4taapbP6mEqwmnEkuSHW1TGl92ittjNfUDjWVHdykKLwG05+X+FnHWLnEdzxGZ5XuTGOhS0m8Fxhgj/ExApmmEQG3uVzkryqWD4FYrmUqX3PahU6s5iT/4QWuUY0bFMzt7HaJqV97JWeDR/DF5ieSN5jowpMt/MgrrFM9IxhKEpn0pDtdSCCWMIIJAuqpo4oS8sklh8McIU/Vr1CgO5O41yWn7p3cz2Ef9IcfIN4udLJ6KeV9+jvZeQuE0I4UutOPAQygL91IJpYQp0xPZLILy3hjOaw3XEzrQBKrXZ79z/IGfbyeoTmBR9jholZZJKd1Z/Z0BZfxtRtL8lnmMthDnW4TAsjgT+x0aSX7r2EHQCpfuCknreFhMjxQegvEcwvzOKGZw9O+HPzvYAdAEss0PTocSwOnWMYE+hDllsARQhdu4+/sckOp31h+1h+OzxfwtYo5jmk85rYh1kIhR9jDHo5wjktUKYRqEjARSgyJpNOPK+ntYmA0W4h8yRSO+bgP3ILvdf5hPM6LOkNWiFRSRD4XyKeYEqtwG0AssSSQSEc6EK1TIKhmATNbOKqjXyCA0ZpHdowpZ/mDC6GkfrXozWduSD2+LmY2MMgYi6D/IIZnXHKS830pYmZrS6jqG5gYyH9c9jbxTWlgA8NbrzeJ9xHLE2Qbxo4TTCHe6C7wNwh05Q0DJq+LvEPP//Z1Qw0BZPGeR6Yo98olljLo12En9x0CGcAcTrul5NBTCljMUP9P6eUfCKAHL7DDJVuengU8m9fIahsZ7kEgntF8wDEv7lMs5LOKCaS2Pvu4vyxyAaRwNcO5hjSPUrg0cIE9rGcDOSrBBf0c/sKQRpiIpwdZDKAXycS6sV+ooZDj7GYrezjt/4Fi1OFfDGlCALEkk05X0kklkTgiCSXIZjWop54ayijiAqc4ylFOcIEqvJu1zQD4J0Ns6QsijEiiiCKUKGlNsFBONeWUU0EV5tbPhja0oQ1taEMb2tCGNvgWAm8DJs7wntMMZWncQTAmcljZIqmC9bTmToYoxGi3UEkNxRxkPyVGE+kMjdqfep51oveJsiadX+236joTH2vquCr4wes5R7yOZgPOLRq1BJ62Gl/9mSHLnCoeK5npN5GCFdCsLYpnFsc4qlJvOM/4LRsccZzv7SbVMOLpRjrBhPM0+cwxmkR12H49n6ika0iTHXn2/xGy2EElJBBEJx4hFxGRHNKNJlUdjfaDSmkleUFhJYmQgrSYJb/Z1siQJvyeSkQsPGI0qWponLLqmMOdpBPIFA6wRlZDYAL3ArCJs9yn+iSBdnQjjQ4EUMZJssnXzEkTQhe6k0Q4dZwnh5MK9osAUggDCikEouhLH9pRzUkOckYlR6I2vmIfAxHI4gPF3kghk85EUE8+xzlGuQJNnQkBCigGBOLoTVeq+YxaIIwUAjBzhhrARDJ9SOMo35NGBwTKyFGUUAUyiEeksnGE1HEL90oHLffZ5SsYyjlERE4ygOmqI6QTT7OdEquveyWHmGkXlsmWGSNYyTmrmFBPHp9yq4NrZxRfcZGL/Am4ka+tgQnqOMG79HMYB85HiMBiRES+cGiDiSzmc8JqTm6giI084pAEOY4NFFDARCCSR9hGBSI7pUDQ/TlKAdn0BpKZTg61iCxE4C0qKeeQSp/EsYFKytnYxJARCMySuvNfNsGUUqUwFOXcB8xQYchv2aLorHCYOxQcoeN5W/GUbTlz7Q77x0hr1wyepNCh/gnutJtgnTPExFJERFbY0RXC45xVoKmeNXbRWOI5gIjIU8TyvjUsSBNDBlCKSDH96GmT8W0hMIZqRESeVKTrNqoRqWdKs5Ql8jrdGQeMZT+zMQOh/JnBgIV3WI4abuAD6dx5Ifs4hYUULicJ6MF8olkos1fE8Rb3IAC1HOUIZUTQnUxCieQJknmMCw5vuJt4oqklm2xqSKA/nYA05lDCt7iDBClvw1HZxBHEZKYSDojk8Qt5BJJBbyIIZCSJPKiQviac6dJKVEEhR2QTqIVUpjCUxmA5xeQCP7CHgcBYljhMhIGMIxTI4bPmEQLQXQp5V8QoAB6VuPqFdJxAaYR0ZQ8iItX8kyzCEBAIoRevcQkRkQuyJIsBzJTG0g7uIoFABAKI5w5r7Ny3bJ4eYyPdHWA8HTAhEEIfPpC+zU2yqLpNI2SRyggJ5WUaECm1y341XhqxebxML8IQMBHLLXwjzRlrbd7SNEJ2U4FIEe8wlBSipTc2jpBytmBG5Dh/JouO0tn3KYiIlHGdA129OCPNBMgZAsOkGO0HyORqTiMisp+e0lVHhgRISb9qeNFuBQjgXmma+dpGmL5W+m0dGXZEpfMtIiIlNqkumhmyW5aRBCKYJ1F+hwJDlhJJOKEEE0wwIUQQTSdu5mPpA1soozWdQ4iIHGW4HSPbMw8zImYmOTBEROQ0t9tNfQNsAvD8RH/ZtUxOISLytsPn8iwiIvmNZ7nkDBF4TBJuv2KztINvDmLpyJB+EgMXKRzYNDENCyJV1icEskhqiFK0qv4SwR9Zn9/EkHJpxNqim5TP4H2b5jUxpIDNrOdb1rKWtXzND2zlsCTaN/C5XXCZ56Uvd5wCTXGsQURkj3V1a2ZIqUIGrWaGZDtEpDPxHiIiR+xCRsWxBRGRjxtPgMkZAiH8n80CLY/94ciQSRJvr0IJnaWDOu9If2dIXf6GypTSGLA/1yqJNDFko8LBf5MkL22xueaK6iSXobLnRPMDIiKfqxzf+R2ViNRaP4lmhsxXkDabGFKvuNMZRjkiZh6W/XorVYhUNcaYd9wG1jKLr6x/LeU9jd1EgJQBYRsHFK+f5nsAsqRJqzdJQAVrUHZL+IZKoJOUnrsZBxX2AxZ+kTrI0Y9LpI5aWamztqIzC3nURsGYLOWU245AlEOJ5BjngGCHT+4SizXSSO5jlcKv2/gZMDHWRpsWyP8QBuzix8Y/HXGR5+hCb+BH/kol6giXMuMcUPWE2o6IQDLxlAFpBAHnVVPQHeMCGQQ5yOqFirUbU5wGKbRhI6/Zbb9MxJDEFVxPKum8TRxvSDU6SR/Lw9ymOG4DpUyl6Zhkn+Y+lY+wERsUzy5W8G+GYWIQ/dki/dadYYDIv7ikxhA4yPMsppJnOYMWAiVO56vWaMyZGy7JGRFS7VKV2kWcJgMcznAoj1HR5l85cvlG8fcAejGbkYTxLLuk0Rsq9UGGg5ghRyQBMjoOUKFaV2SvypVvOEIPYhltZchIUoDjTfoRNRvIWqbxosvJg9U9DAW3PL/MXkpWr/ZOMwd4ioNAHA9IVFvQ59V1VuNarWrWw9NSnuCR0riLk9IVrOZUYwW1rrSwwAVCG6gC0IjSnkwIUC3VKwEggWiViTBaCo9UiO9wnJX0AbKI5wJQQi3BiPyTHRrHq02csJsEtT4drQ/rUybQnkyuYxkwiP5AMSubelv923ZFdVdFLoOAfoRRrXBd4GoE4JzUxSepJYRkeqh8Qd3oAtT7OM1pNhZMxEjCwAWKiEIghwVuPUVr5Fs0em8fP3A7gYxjJQ2MIwzY2Jxp1zN3fTPbAchykIsa0YVhAOyQVo3DnAciGaXSnFHEAOc18ux6AxGYaBT3AS5IOQpvsQuH3oRoutCFFDejRKjPLjWsoB74Lb3oynCgjuXNmm5Pz0+sJw+I53EFKd7EA2QCVayVfjnDRgDulCUMa0IW9wCwiVwPqdJCsKTKKZQ+khpWYwGGMF7hM4ngFTazmWVu5f0RNaf7DewH4rmNW0kB9rLBttM8wy98BsDdPGn3DZm4iz8CsL5RwgbMLKYYSOJVutk9KZ1XSQVK+FCXpUPeIWoI4SFpi7eVYum3L9kJBDOVO+1WkTAmMYFUUtnlVnJibVGmQOqz+3kUgJW2a6anJ7YbeJshXE4o00lnPkepQSCUy7ibx2kP5PG6zbZuCwt4DoGhfMzf2UAxDQTSjqE8LY2ahWz2kCZoTz8siJKYKmAiAAinOyO5hQjgPIusQuwFZrGIdiQyjytZxnGqEQmlJ09yDyHAPuZqGtuUWKKFVTxBsiRm58oT03p+hP4ok3mfDMJ5grEc4jyBJNGdjghAEc/LOriB10niPgSuYjHHOUYJMWTQVZryPuMVjf2vq7iZwYgyhggIBBEuzQil/EVa/RqxhqnMIpp2PMODZHMWM8n0keI95DKF4x7TZIscvuUh6f9r7R1L7HVZWlAzUA1kk2IwvcP8j4IoGcfrinGsy3mHRFnNJl3WNEVqJkhmqlTrL67osszs4w6HDzGQ8Sr5EnbZqeqbdFmTFWlqUr87S5X0O0nVWWKnWSOQfKDexUNgFRQiKPj+/cwd3MHv6UO0JMFUcpzVLFGMRVXMi3zFBK4lUVp36ilgCx/yvR0dFoooBJVdSwUXCKBAtuKUU6Vgsxapp4EGijjCetYo6B8aWMYOHmAkGYRLE04Vx/icRXYihoUiLqrS1EABNVQ4HeX7OEt34Ed2yC8IZAIi5zUUAc2IJx4o57zCsikQTTe6koBAMSfJoUhz3g0mlUxSCaeas+SQq7CZkjs52COKJKCWs1aWCCSThOMMbqGWOuopoUyzq0zEk8llxCFQygkOU+jQhgBSJSeHSwpPCCUVExbOKu7LmjGQNcTRwAQ+cqHf2+BjmCSz3t4WyUTXBqfoKTnsTTWakDY0YioiIudU9BttaGEkSXmzFyptOn4NobzacQVBbKIGSKQ/1fzkp+dXGjGCXkAFyz3WSLQATHTnMeawgJcZ5VKwsT58Rz37SAQGs5UGvvJShGzfIIYNiIh871KCAIMRyv+Si4Vy8rhEDVsZ4UTbFsRH1PIe1xFEBN9QzjSy/DrkTH9+YDe7JX9pv4aJKVSzmz9wJWn05UmOkW+XSdceCWSzUTINdyOfVX6fvTaYdsQSq3aCwJ/WkIE8z3Ye5KT09wF2sYzp7JEyCkaQRT8COcx2aVOWziA6UMowLFhIJxIzg7nIYcxAJH3pisAp2clCgRSuIJVS9pBjwCxe5yUztc9hYj5V3Gz36628JTk7Z/JvKqiiimrWcQ0Ab1KDiJlaaqihDpFaylhNGNCXLyijnHIqrfUhiIfIoZpyqslnhuQi3QYFdOAQ2xWsdo22hSQ2colZXMsQXuIih+gF9OJB8tnNeO7mLp6lilXcxAAEUthCKbP5LYN5kQsckmT+ByhnN/fzG0aykjpe89vDR4Yjk0KWqNoRnqOOP1qv3k8NbwLQieN8KXVqP0r5h1TjBcw8ba1/FzXMBTqxn2PW7VgMn3LJOnb8BP4jj5gQVONdRTCCo/zLevULdnG9w1GaZoRzI4XspSs96EEmp8jletrTl55so56e9KQnCfxErL3622j4z6JeSgmJBClqY6NIJttqcoUysrmJSEV9K0AY7enAcomBAgIxFBBNEoGMsVmngsDf1Hv+w5AiDjOADLJlv6bQnYM00EAoAVZmmQijQUO5b8ZMCUuolCYtEQvlFFOJyE42WecFC1g9CNvggImYmSOLsxDNCs7TnwC+IM/maFkq2awjHLU1JIBPuGTjHh1KDzoD/Slmuc1OJYHeKgfB2wB04HtqmEUqAUAA6bxLLa8RCNxLLR9KNu52zKFeOquntqiPoYpPJeNuJNMo5E9AKJ9QwSMS0/uxmf12R1zbIEMf1lHPUZYzjxWcoJK3pZ1CBHOpZQdv8Co/UccyaUlXY0gIM6jiIG8zg2+p5RuSpDfsoIIvmcEcjlPGY34fddJgJPEiv2BGpIHtjLc5RxHLS9IRuzPMsjpDdGAd86WVMJPdNiafCJ7gMBZECviHzZmlXiyVjs3s4V7/U7T8P68zDur5qie+AAAAHnRFWHRpY2M6Y29weXJpZ2h0AEdvb2dsZSBJbmMuIDIwMTasCzM4AAAAFHRFWHRpY2M6ZGVzY3JpcHRpb24Ac1JHQrqQcwcAAAAASUVORK5CYII=';

function docHeader(title) {
    return `<div class="doc-header" style="display:flex;align-items:center;justify-content:space-between;border-bottom:2px solid #000;padding-bottom:15px;margin-bottom:20px">
        <img src="${LOGO_BASE64}" alt="Moonberry Coffee" style="height:60px;width:auto">
        <div style="text-align:right;flex:1;margin-left:20px">
            <div class="doc-company" style="font-size:11pt;font-weight:700">${STATE.company.name}</div>
        </div>
    </div>
    <div class="doc-title" style="text-align:center;font-size:14pt;font-weight:700;margin:15px 0;text-decoration:underline">${title}</div>`;
}

function docSignature(left, right) {
    return `<div class="doc-signature-area">
        <div class="doc-signature-block"><div class="doc-signature-title">${left.title}</div><div class="doc-signature-line">${left.name}<br>${left.role || ''}</div></div>
        <div class="doc-signature-block"><div class="doc-signature-title">${right.title}</div><div class="doc-signature-line">${right.name}<br>${right.role || ''}</div></div>
    </div>`;
}

// ==================== S√ñZLE≈ûME ====================
function generateSozlesme() {
    const type = selectedTypes.sozlesme;
    const pos = STATE.positions.find(p => p.id === type);
    const posName = pos ? pos.name : (type || 'Pozisyon');
    
    const ad = getVal('soz_ad') || '______________________';
    const tc = getVal('soz_tc') || '___________';
    const adres = getVal('soz_adres') || '______________________';
    const iban = getVal('soz_iban') || '______________________';
    const telefon = getVal('soz_telefon') || '______________________';
    const baslama = formatDate(getVal('soz_baslama'));
    const ucret = getVal('soz_ucret') || '______';
    const sube = getVal('soz_sube') || STATE.branches[0] || '______';
    
    // Pozisyona g√∂re el yazƒ±sƒ± beyan metinleri
    const beyanlar = {
        barista: '"ƒ∞≈übu i≈ü s√∂zle≈ümesini, eklerini ve KVKK Aydƒ±nlatma Metnini elden teslim aldƒ±m, okudum, i√ßeriƒüini ve y√ºk√ºml√ºl√ºklerimi tam olarak anladƒ±m ve h√ºr irademle kabul ettim."',
        mudur_yardimcisi: '"ƒ∞≈übu i≈ü s√∂zle≈ümesini, eklerini ve KVKK Aydƒ±nlatma Metnini elden teslim aldƒ±m, okudum. ƒ∞≈üverenin i≈üleyi≈üini, g√∂rev tanƒ±mƒ±mƒ±, √ºcret ve fazla mesai uygulamalarƒ±nƒ±, gizlilik ve rekabet yasaƒüƒ± h√ºk√ºmlerini tam olarak anladƒ±m ve h√ºr irademle kabul ettim."',
        magaza_muduru: '"S√∂zle≈ümeyi okudum, bir suretini teslim aldƒ±m. ƒ∞≈üveren Vekili stat√ºs√ºn√º, fazla mesai d√ºzenlemesini ve rekabet yasaƒüƒ± h√ºk√ºmlerini anladƒ±m, h√ºr irademle kabul ediyorum."',
        bolge_muduru: '"ƒ∞≈übu s√∂zle≈ümeyi okudum, i√ßeriƒüini, ƒ∞≈üveren Vekili stat√ºm√ºn sonu√ßlarƒ±nƒ± ve rekabet yasaƒüƒ± y√ºk√ºml√ºl√ºklerimi anladƒ±m, bir suretini elden teslim aldƒ±m."'
    };
    const elYazisiMetni = beyanlar[type] || '"ƒ∞≈übu i≈ü s√∂zle≈ümesini okudum, anladƒ±m, bir suretini teslim aldƒ±m."';
    
    let template = STATE.templates[type] || '';
    template = template
        .replace(/\{\{AD_SOYAD\}\}/g, ad)
        .replace(/\{\{TC\}\}/g, tc)
        .replace(/\{\{ADRES\}\}/g, adres)
        .replace(/\{\{IBAN\}\}/g, iban)
        .replace(/\{\{TELEFON\}\}/g, telefon)
        .replace(/\{\{UCRET\}\}/g, ucret)
        .replace(/\{\{BASLAMA\}\}/g, baslama)
        .replace(/\{\{SUBE\}\}/g, sube);
    
    const html = `<div class="doc">
        ${docHeader('BELƒ∞RSƒ∞Z S√úRELƒ∞ ƒ∞≈û S√ñZLE≈ûMESƒ∞')}
        <p style="text-align:center;font-weight:bold;margin-top:-10px;margin-bottom:15px">(${posName})</p>
        <div class="doc-section" style="margin-bottom:15px;border-bottom:1px solid #ccc;padding-bottom:8px">
            <table style="width:100%;font-size:10pt">
                <tr><td><strong>S√∂zle≈üme Tarihi:</strong> ${baslama}</td><td style="text-align:right"><strong>S√∂zle≈üme No:</strong> ${docNo('SOZ', sube)}</td></tr>
            </table>
        </div>
        
        <div class="doc-article"><div class="doc-article-title">MADDE 1: TARAFLAR</div>
        <div class="doc-article-content" style="font-size:9pt">
            <p style="font-weight:bold;margin:8px 0 5px 0">1.1. ƒ∞≈ûVEREN:</p>
            <p style="margin:2px 0"><strong>√únvanƒ±:</strong> ${STATE.company.name}</p>
            <p style="margin:2px 0"><strong>Adres:</strong> ${STATE.company.address}</p>
            <p style="margin:2px 0"><strong>Tel:</strong> ${STATE.company.tel} | <strong>E-posta:</strong> ${STATE.company.email}</p>
            <p style="margin:2px 0"><strong>Vergi D./No:</strong> ${STATE.company.vergiDairesi} / ${STATE.company.vergiNo}</p>
            <p style="margin:2px 0"><strong>Mersis:</strong> ${STATE.company.mersis} | <strong>KEP:</strong> ${STATE.company.kep}</p>
            <p style="font-size:8pt;color:#666;margin:5px 0">(Bundan sonra "ƒ∞≈ûVEREN" olarak anƒ±lacaktƒ±r.)</p>
            
            <p style="font-weight:bold;margin:12px 0 5px 0">1.2. PERSONEL (ƒ∞≈û√áƒ∞):</p>
            <p style="margin:2px 0"><strong>Adƒ± Soyadƒ±:</strong> ${ad || '______________________'}</p>
            <p style="margin:2px 0"><strong>T.C. Kimlik No:</strong> ${tc || '______________________'}</p>
            <p style="margin:2px 0"><strong>Adres:</strong> ${adres || '______________________'}</p>
            <p style="margin:2px 0"><strong>Cep Tel:</strong> ${telefon || '______________________'}</p>
            <p style="margin:2px 0"><strong>IBAN:</strong> ${iban || '______________________'}</p>
            <p style="font-size:8pt;color:#666;margin:5px 0">(Bundan sonra "PERSONEL" olarak anƒ±lacaktƒ±r.)</p>
        </div></div>

        ${template}

        <div style="margin-top:30px;page-break-inside:avoid;">
            <table style="width:100%;border:none;">
                <tr>
                    <td style="width:50%;text-align:center;vertical-align:bottom;padding:15px;border:none;">
                        <p style="margin-bottom:50px">(Ka≈üe / ƒ∞mza)</p>
                        <div style="border-top:1px solid #000;width:70%;margin:0 auto;padding-top:8px">
                            <p style="font-weight:bold;margin:0">ƒ∞≈ûVEREN</p>
                        </div>
                    </td>
                    <td style="width:50%;text-align:center;vertical-align:bottom;padding:15px;border:none;">
                        <p style="margin-bottom:20px">(ƒ∞mza)</p>
                        <div style="border-top:1px solid #000;width:70%;margin:0 auto;padding-top:8px">
                            <p style="font-weight:bold;margin:0">PERSONEL</p>
                            <p style="font-size:9pt;margin:3px 0 0 0">(Adƒ± Soyadƒ±)</p>
                        </div>
                    </td>
                </tr>
            </table>
        </div>
        
        <div style="margin-top:25px;padding:15px;border:1px solid #000;page-break-inside:avoid;">
            <p style="font-size:9pt;margin-bottom:8px;font-style:italic">(A≈üaƒüƒ±daki alan Personel tarafƒ±ndan kendi el yazƒ±sƒ± ile doldurulacaktƒ±r)</p>
            <p style="font-weight:bold;margin-bottom:8px;font-size:10pt">EL YAZISI ƒ∞LE BEYAN:</p>
            <p style="background:#f5f5f5;padding:8px;margin:8px 0;font-style:italic;font-size:9pt;border-left:3px solid #ff8674">${elYazisiMetni}</p>
            <div style="margin-top:10px;border:1px solid #ccc;height:50px;background:#fafafa"></div>
            <table style="width:100%;margin-top:10px;border:none;font-size:10pt">
                <tr>
                    <td style="border:none"><strong>Tarih:</strong> ___/___/20___</td>
                    <td style="border:none;text-align:right"><strong>ƒ∞mza:</strong> ________________</td>
                </tr>
            </table>
        </div>
    </div>`;
    
    showPreview(posName + ' ƒ∞≈ü S√∂zle≈ümesi - ' + ad, html);
}

// ==================== TUTANAK ====================
function generateTutanak() {
    const type = selectedTypes.tutanak || 'olay';
    const titles = {olay: 'OLAY TESPƒ∞T TUTANAƒûI', devamsizlik: 'DEVAMSIZLIK TUTANAƒûI', kasa: 'KASA A√áIƒûI TUTANAƒûI', imza: 'ƒ∞MZADAN ƒ∞MTƒ∞NA TUTANAƒûI'};
    
    const personel = getVal('tut_personel') || '______________________';
    const pozisyon = document.getElementById('tut_pozisyon')?.selectedOptions[0]?.text || '______';
    const tarih = formatDate(getVal('tut_tarih'));
    const saat = getVal('tut_saat') || '__:__';
    const duzTarih = formatDate(getVal('tut_duz_tarih')) || today();
    const duzSaat = getVal('tut_duz_saat') || nowTime();
    const sube = getVal('tut_sube') || STATE.branches[0] || '______';
    const kasa = getVal('tut_kasa');
    const aciklama = getVal('tut_aciklama') || '______________________';
    const sahit1 = getVal('tut_sahit1') || '______________________';
    const sahit2 = getVal('tut_sahit2') || '______________________';
    const duzenleyen = getVal('tut_duzenleyen') || '______________________';
    const gorev = getVal('tut_gorev') || 'Yetkili';
    
    const html = `<div class="doc">
        ${docHeader(titles[type])}
        <div class="doc-section">
            <p><strong>Tutanak No:</strong> ${docNo('TUT', sube)} | <strong>D√ºzenleme:</strong> ${duzTarih} ${duzSaat} | <strong>≈ûube:</strong> ${sube}</p>
            <p><strong>Personel:</strong> ${personel} (${pozisyon})</p>
            <p><strong>Olay Tarihi:</strong> ${tarih} ${saat}${type === 'kasa' && kasa ? ' | <strong>A√ßƒ±k:</strong> ' + kasa + ' TL' : ''}</p>
        </div>
        <div class="doc-section">
            <div class="doc-section-title">OLAY A√áIKLAMASI</div>
            <p style="background:#f9f9f9;padding:15px;border-left:4px solid #ff8674">${aciklama}</p>
        </div>
        <p style="margin:20px 0">ƒ∞≈übu tutanak ≈üahitler huzurunda d√ºzenlenmi≈ütir.</p>
        <div class="doc-section">
            <div class="doc-section-title">≈ûAHƒ∞TLER</div>
            <p>1. ${sahit1} _________________ | 2. ${sahit2} _________________</p>
        </div>
        ${docSignature(
            {title: 'D√úZENLEYEN', name: duzenleyen, role: gorev},
            {title: 'PERSONEL', name: personel, role: '(ƒ∞mza / ƒ∞mtina)'}
        )}
        <p style="margin-top:20px;font-size:9pt;color:#666"><strong>NOT:</strong> ƒ∞mzadan imtina halinde ≈üahitler tarafƒ±ndan not edilir.</p>
    </div>`;
    
    showPreview(titles[type] + ' - ' + personel, html);
}

// ==================== SAVUNMA ====================
function generateSavunma() {
    const personel = getVal('sav_personel') || '______________________';
    const pozisyon = document.getElementById('sav_pozisyon')?.selectedOptions[0]?.text || '______';
    const tarih = formatDate(getVal('sav_tarih'));
    const sube = getVal('sav_sube') || STATE.branches[0] || '______';
    const duzTarih = formatDate(getVal('sav_duz_tarih')) || today();
    const duzSaat = getVal('sav_duz_saat') || nowTime();
    const isnat = getVal('sav_isnat') || '______________________';
    const sure = getVal('sav_sure') || '1';
    const yetkili = getVal('sav_yetkili') || 'ƒ∞nsan Kaynaklarƒ±';
    
    const html = `<div class="doc">
        ${docHeader('SAVUNMA ƒ∞STEME BELGESƒ∞')}
        <div class="doc-section">
            <p><strong>Tarih:</strong> ${duzTarih} ${duzSaat} | <strong>Belge No:</strong> ${docNo('SAV', sube)}</p>
            <p><strong>Sayƒ±n:</strong> ${personel} (${pozisyon}) - ${sube}</p>
        </div>
        <div class="doc-section">
            <p>4857 sayƒ±lƒ± ƒ∞≈ü Kanunu'nun 19. maddesi gereƒüince savunma hakkƒ±nƒ±z tanƒ±nmaktadƒ±r.</p>
            <p style="margin-top:15px"><strong>ƒ∞snat Edilen Eylem:</strong></p>
            <p style="background:#f9f9f9;padding:15px;border-left:4px solid #3498db">${isnat}</p>
            <p style="margin-top:15px"><strong>Olay Tarihi:</strong> ${tarih}</p>
            <p style="margin-top:15px"><strong>Savunma S√ºresi:</strong> Tebliƒüden itibaren <strong>${sure} i≈ü g√ºn√º</strong></p>
            <p style="margin-top:15px;background:#fef9e7;padding:12px;border-radius:6px">‚ö†Ô∏è S√ºre i√ßinde savunma verilmezse feragat edilmi≈ü sayƒ±lƒ±r.</p>
        </div>
        <div class="doc-section" style="margin-top:20px;font-size:10pt;color:#666">
            <strong>Yasal Dayanak:</strong> ƒ∞≈ü K. Md. 19: "Savunmasƒ± alƒ±nmadan i≈ü√ßinin s√∂zle≈ümesi feshedilemez."
        </div>
        ${docSignature(
            {title: 'TEBLƒ∞ƒû EDEN', name: yetkili, role: 'ƒ∞mza'},
            {title: 'PERSONEL', name: personel, role: 'Tebliƒü Tarihi: ___/___/___'}
        )}
    </div>`;
    
    showPreview('Savunma ƒ∞steme - ' + personel, html);
}

// ==================== FESƒ∞H ====================
function generateFesih() {
    const type = selectedTypes.fesih || 'hakli';
    const titles = {hakli: 'HAKLI NEDENLE FESƒ∞H Bƒ∞LDƒ∞Rƒ∞Mƒ∞', gecerli: 'GE√áERLƒ∞ NEDENLE FESƒ∞H Bƒ∞LDƒ∞Rƒ∞Mƒ∞', deneme: 'DENEME S√úRESƒ∞ FESHƒ∞'};
    const infos = {
        hakli: 'ƒ∞≈ü Kanunu 25/II uyarƒ±nca s√∂zle≈ümeniz derhal ve tazminatsƒ±z feshedilmi≈ütir.',
        gecerli: 'ƒ∞≈ü Kanunu 18. madde uyarƒ±nca ge√ßerli nedenle feshedilmi≈ütir. Tazminat haklarƒ± saklƒ±dƒ±r.',
        deneme: 'Deneme s√ºresi i√ßinde bildirimsiz ve tazminatsƒ±z feshedilmi≈ütir.'
    };
    
    const personel = getVal('fes_personel') || '______________________';
    const pozisyon = document.getElementById('fes_pozisyon')?.selectedOptions[0]?.text || '______';
    const sube = getVal('fes_sube') || STATE.branches[0] || '______';
    const giris = formatDate(getVal('fes_giris'));
    const fesTarih = formatDate(getVal('fes_tarih')) || today();
    const gerekce = getVal('fes_gerekce') || '______________________';
    const yetkili = getVal('fes_yetkili') || 'Yetkili';
    
    const html = `<div class="doc">
        ${docHeader(titles[type])}
        <div class="doc-section">
            <p><strong>Tarih:</strong> ${fesTarih} | <strong>Belge No:</strong> ${docNo('FES', sube)} | <strong>≈ûube:</strong> ${sube}</p>
            <p><strong>Sayƒ±n:</strong> ${personel} (${pozisyon})</p>
            <p><strong>ƒ∞≈üe Giri≈ü Tarihi:</strong> ${giris}</p>
        </div>
        <div class="doc-section">
            <div class="doc-section-title">FESƒ∞H GEREK√áESƒ∞</div>
            <p style="background:#fdedec;padding:15px;border-left:4px solid #e74c3c">${gerekce}</p>
        </div>
        <div class="doc-section">
            <p>${infos[type]}</p>
        </div>
        ${type === 'hakli' ? '<p style="background:#fef9e7;padding:12px;border-radius:6px;margin:20px 0">‚ö†Ô∏è ƒ∞≈ü Kanunu Md. 26 uyarƒ±nca 6 i≈ü g√ºn√º i√ßinde kullanƒ±lmƒ±≈ütƒ±r.</p>' : ''}
        ${docSignature(
            {title: 'ƒ∞≈ûVEREN', name: '(KA≈ûE)', role: 'ƒ∞mza'},
            {title: 'PERSONEL', name: personel, role: 'Tebliƒü: ___/___/___'}
        )}
    </div>`;
    
    showPreview(titles[type] + ' - ' + personel, html);
}

// ==================== ƒ∞STƒ∞FA Dƒ∞LEK√áESƒ∞ ====================
function generateIstifa() {
    const personel = getVal('istifa_personel') || '______________________';
    const tc = getVal('istifa_tc') || '___________';
    const sube = getVal('istifa_sube') || STATE.branches[0] || '______';
    const pozisyon = document.getElementById('istifa_pozisyon')?.selectedOptions[0]?.text || '______';
    const giris = formatDate(getVal('istifa_giris')) || '___/___/___';
    const tarih = formatDate(getVal('istifa_tarih')) || today();
    const sonTarih = formatDate(getVal('istifa_son_tarih')) || '___/___/___';
    const ihbar = getVal('istifa_ihbar') || '0';
    const neden = getVal('istifa_neden') || 'Ki≈üisel nedenlerden dolayƒ±';
    
    const ihbarText = {
        '0': 'derhal ge√ßerli olmak √ºzere',
        '2': '2 haftalƒ±k ihbar s√ºresine uyarak',
        '4': '4 haftalƒ±k ihbar s√ºresine uyarak',
        '6': '6 haftalƒ±k ihbar s√ºresine uyarak',
        '8': '8 haftalƒ±k ihbar s√ºresine uyarak'
    };
    
    const html = `<div class="doc">
        ${docHeader('ƒ∞STƒ∞FA Dƒ∞LEK√áESƒ∞')}
        <div class="doc-section" style="text-align:right;margin-bottom:20px">
            <p><strong>Tarih:</strong> ${tarih}</p>
        </div>
        <div class="doc-section">
            <p style="margin-bottom:20px"><strong>TAMASLAN KAFE RESTORAN VE GIDA Hƒ∞ZMETLERƒ∞ Tƒ∞C. LTD. ≈ûTƒ∞.</strong></p>
            <p><strong>≈ûube:</strong> ${sube}</p>
        </div>
        <div class="doc-section" style="margin-top:30px">
            <p>Sayƒ±n Yetkili,</p>
            <p style="margin-top:15px">≈ûirketinizde <strong>${giris}</strong> tarihinden beri <strong>${pozisyon}</strong> pozisyonunda √ßalƒ±≈ümaktayƒ±m.</p>
            <p style="margin-top:15px;background:#f8f9fa;padding:15px;border-radius:8px">${neden}</p>
            <p style="margin-top:15px">Yukarƒ±da belirttiƒüim nedenlerle, ƒ∞≈ü Kanunu h√ºk√ºmlerine uygun olarak <strong>${ihbarText[ihbar]}</strong> g√∂revimden istifa ediyorum.</p>
            <p style="margin-top:15px"><strong>Son √áalƒ±≈üma Tarihim:</strong> ${sonTarih}</p>
            <p style="margin-top:20px">Gereƒüini arz ederim.</p>
        </div>
        <div style="margin-top:40px;text-align:right">
            <p><strong>${personel}</strong></p>
            <p style="font-size:10pt;color:#666">TC: ${tc}</p>
            <p style="margin-top:30px">ƒ∞mza: _____________________</p>
        </div>
        <div style="margin-top:40px;padding-top:20px;border-top:1px dashed #ccc">
            <p><strong>ƒ∞≈üveren Onayƒ±:</strong></p>
            <p style="margin-top:10px">Tebliƒü Alan: _____________________ Tarih: ___/___/___</p>
        </div>
    </div>`;
    
    showPreview('ƒ∞stifa Dilek√ßesi - ' + personel, html);
}

// ==================== ƒ∞BRANAME ====================
function generateIbraname() {
    const personel = getVal('ibra_personel') || '______________________';
    const tc = getVal('ibra_tc') || '___________';
    const sube = getVal('ibra_sube') || STATE.branches[0] || '______';
    const pozisyon = document.getElementById('ibra_pozisyon')?.selectedOptions[0]?.text || '______';
    const giris = formatDate(getVal('ibra_giris')) || '___/___/___';
    const cikis = formatDate(getVal('ibra_cikis')) || '___/___/___';
    const tarih = formatDate(getVal('ibra_tarih')) || today();
    const tutar = getVal('ibra_tutar') || '______';
    const iban = getVal('ibra_iban') || '______________________';
    const yetkili = getVal('ibra_yetkili') || 'Yetkili';
    
    // √ñdeme kalemleri
    const kalemler = [];
    if (document.getElementById('ibra_maas')?.checked) kalemler.push('Maa≈ü Alacaƒüƒ±');
    if (document.getElementById('ibra_kidem')?.checked) kalemler.push('Kƒ±dem Tazminatƒ±');
    if (document.getElementById('ibra_ihbar')?.checked) kalemler.push('ƒ∞hbar Tazminatƒ±');
    if (document.getElementById('ibra_izin')?.checked) kalemler.push('Kullanƒ±lmayan Yƒ±llƒ±k ƒ∞zin');
    if (document.getElementById('ibra_fazla')?.checked) kalemler.push('Fazla Mesai √úcreti');
    if (document.getElementById('ibra_diger')?.checked) kalemler.push('Diƒüer Alacaklar');
    
    const kalemlerText = kalemler.length > 0 ? kalemler.join(', ') : 'T√ºm alacaklar';
    
    const html = `<div class="doc">
        ${docHeader('ƒ∞BRANAME')}
        <p style="text-align:center;color:#666;margin-top:-15px;margin-bottom:20px">TBK Md. 420 Uyarƒ±nca</p>
        <div class="doc-section">
            <p><strong>Tarih:</strong> ${tarih} | <strong>Belge No:</strong> ${docNo('IBR', sube)} | <strong>≈ûube:</strong> ${sube}</p>
        </div>
        <div class="doc-section">
            <table style="width:100%;border-collapse:collapse;margin:15px 0">
                <tr><td style="padding:8px;border:1px solid #ddd;background:#f9f9f9;width:30%"><strong>Personel</strong></td><td style="padding:8px;border:1px solid #ddd">${personel}</td></tr>
                <tr><td style="padding:8px;border:1px solid #ddd;background:#f9f9f9"><strong>TC Kimlik No</strong></td><td style="padding:8px;border:1px solid #ddd">${tc}</td></tr>
                <tr><td style="padding:8px;border:1px solid #ddd;background:#f9f9f9"><strong>Pozisyon</strong></td><td style="padding:8px;border:1px solid #ddd">${pozisyon}</td></tr>
                <tr><td style="padding:8px;border:1px solid #ddd;background:#f9f9f9"><strong>ƒ∞≈üe Giri≈ü</strong></td><td style="padding:8px;border:1px solid #ddd">${giris}</td></tr>
                <tr><td style="padding:8px;border:1px solid #ddd;background:#f9f9f9"><strong>ƒ∞≈üten Ayrƒ±lƒ±≈ü</strong></td><td style="padding:8px;border:1px solid #ddd">${cikis}</td></tr>
                <tr><td style="padding:8px;border:1px solid #ddd;background:#f9f9f9"><strong>IBAN</strong></td><td style="padding:8px;border:1px solid #ddd">${iban}</td></tr>
            </table>
        </div>
        <div class="doc-section">
            <div class="doc-section-title">√ñDEME KALEMLERƒ∞</div>
            <p style="background:#e8f5e9;padding:15px;border-radius:8px">${kalemlerText}</p>
            <p style="margin-top:15px;font-size:14pt"><strong>TOPLAM √ñDEME: ${tutar} TL</strong></p>
        </div>
        <div class="doc-section" style="background:#fff3e0;padding:15px;border-radius:8px;margin-top:20px">
            <p>Ben ${personel}, <strong>${giris}</strong> ile <strong>${cikis}</strong> tarihleri arasƒ±nda ${sube} ≈üubesinde √ßalƒ±≈ütƒ±m.</p>
            <p style="margin-top:10px">Yukarƒ±da belirtilen <strong>${kalemlerText}</strong> dahil t√ºm i≈ü√ßilik alacaklarƒ±mƒ±n toplamƒ± olan <strong>${tutar} TL</strong>'yi IBAN hesabƒ±ma aldƒ±m.</p>
            <p style="margin-top:10px">ƒ∞≈üverenden hi√ßbir alacaƒüƒ±m kalmadƒ±ƒüƒ±nƒ±, ibra ettiƒüimi beyan ederim.</p>
        </div>
        <div style="background:#e3f2fd;padding:12px;border-radius:6px;font-size:10pt;margin:20px 0">
            <strong>TBK Md. 420:</strong> ƒ∞≈ü√ßi ibrasƒ± yazƒ±lƒ± olmalƒ± ve banka kanalƒ±yla √∂denmelidir. ƒ∞mza tarihinden itibaren 1 ay i√ßinde itiraz hakkƒ± saklƒ±dƒ±r.
        </div>
        ${docSignature(
            {title: 'ƒ∞≈ûVEREN', name: yetkili, role: '(KA≈ûE / ƒ∞mza)'},
            {title: 'PERSONEL', name: personel, role: 'El yazƒ±sƒ±: Okudum, aldƒ±m, ibra ediyorum'}
        )}
    </div>`;
    
    showPreview('ƒ∞braname - ' + personel, html);
}

// ==================== BOR√á ƒ∞KRAR ====================
function generateBorc() {
    const turLabels = {kasa: 'Kasa A√ßƒ±ƒüƒ±', zimmet: 'Zimmet Hasarƒ±', stok: 'Stok Kaybƒ±'};
    const odemeLabels = {tek: 'maa≈ütan tek seferde mahsup edilmesini', taksit: 'maa≈ütan taksitlerle mahsup edilmesini'};
    
    const personel = getVal('borc_personel') || '______________________';
    const tc = getVal('borc_tc');
    const sube = getVal('borc_sube') || STATE.branches[0] || '______';
    const tur = getVal('borc_tur') || 'kasa';
    const tutar = getVal('borc_tutar') || '______';
    const tarih = formatDate(getVal('borc_tarih'));
    const duzTarih = formatDate(getVal('borc_duz_tarih')) || today();
    const odeme = getVal('borc_odeme') || 'tek';
    const aciklama = getVal('borc_aciklama') || '______________________';
    const sahit = getVal('borc_sahit');
    const yetkili = getVal('borc_yetkili') || 'Yetkili';
    
    const html = `<div class="doc">
        ${docHeader('BOR√á ƒ∞KRAR VE MAHSUP MUVAFAKATNAMESƒ∞')}
        <p style="text-align:center;color:#666;margin-top:-15px;margin-bottom:20px">TBK Md. 407/2 Uyarƒ±nca</p>
        <div class="doc-section">
            <p><strong>Tarih:</strong> ${duzTarih} | <strong>Belge No:</strong> ${docNo('BRC', sube)} | <strong>≈ûube:</strong> ${sube}</p>
            <p><strong>Personel:</strong> ${personel}${tc ? ' | TC: ' + tc : ''}</p>
            <p><strong>Bor√ß T√ºr√º:</strong> ${turLabels[tur]} | <strong>Tutar:</strong> ${tutar} TL | <strong>Olay:</strong> ${tarih}</p>
        </div>
        <div class="doc-section">
            <div class="doc-section-title">OLAY A√áIKLAMASI</div>
            <p style="background:#f9f9f9;padding:15px;border-left:4px solid #ff8674">${aciklama}</p>
        </div>
        <div class="doc-section">
            <p>Ben ${personel}, ${tarih} tarihli olayda kusurum nedeniyle <strong>${tutar} TL</strong> borcumu kabul ediyor, TBK 407/2 uyarƒ±nca ${odemeLabels[odeme]} kendi irademle taahh√ºt ediyorum.</p>
            <p style="margin-top:10px">Baskƒ± altƒ±nda deƒüilim, borcumu ve kesinti ko≈üullarƒ±nƒ± anladƒ±ƒüƒ±mƒ± beyan ederim.</p>
        </div>
        <div style="background:#ebf5fb;padding:12px;border-radius:6px;font-size:10pt;margin:20px 0">
            <strong>TBK 407/2:</strong> ƒ∞≈üveren, i≈ü√ßiden alacaƒüƒ±nƒ± i≈ü√ßi rƒ±zasƒ± olmadan takas edemez.
        </div>
        ${docSignature(
            {title: 'ƒ∞≈ûVEREN', name: '(KA≈ûE)', role: 'ƒ∞mza'},
            {title: 'PERSONEL', name: personel, role: 'El yazƒ±sƒ±: Okudum, kabul ediyorum'}
        )}
        ${sahit ? '<p style="margin-top:20px"><strong>≈ûahit:</strong> ' + sahit + ' _________________</p>' : ''}
    </div>`;
    
    showPreview('Bor√ß ƒ∞krar - ' + personel, html);
}

function generateAvans() {
    const personel = getVal('avans_personel') || '______________________';
    const tc = getVal('avans_tc') || '___________';
    const sube = getVal('avans_sube') || STATE.branches[0] || '______';
    const pozisyon = getVal('avans_pozisyon');
    const pozAd = STATE.positions.find(p => p.id === pozisyon)?.name || '______';
    const iban = getVal('avans_iban') || '______________________';
    const tutarRaw = getVal('avans_tutar') || '______';
    const tarih = formatDate(getVal('avans_tarih')) || today();
    const gerekce = getVal('avans_gerekce') || '______________________';
    
    // Tutar formatla ve yazƒ±ya √ßevir
    const tutarNum = parseInt(tutarRaw.replace(/\D/g, '')) || 0;
    const tutarFormat = tutarNum > 0 ? tutarNum.toLocaleString('tr-TR') : tutarRaw;
    const tutarYazi = tutarNum > 0 ? sayiyiYaziyaCevir(tutarNum) : '______';
    
    const html = `<div class="doc" style="font-size:11pt;line-height:1.5;-webkit-print-color-adjust:exact;print-color-adjust:exact">
        ${docHeader('AVANS TALEBƒ∞ FORMU')}
        <table style="width:100%;border-collapse:collapse;margin:15px 0">
            <tr>
                <td style="padding:8px;border:1px solid #ddd;background-color:#f9f9f9;-webkit-print-color-adjust:exact;width:25%"><strong>Ad Soyad</strong></td>
                <td style="padding:8px;border:1px solid #ddd;width:25%">${personel}</td>
                <td style="padding:8px;border:1px solid #ddd;background-color:#f9f9f9;-webkit-print-color-adjust:exact;width:25%"><strong>TC Kimlik No</strong></td>
                <td style="padding:8px;border:1px solid #ddd;width:25%">${tc}</td>
            </tr>
            <tr>
                <td style="padding:8px;border:1px solid #ddd;background-color:#f9f9f9;-webkit-print-color-adjust:exact"><strong>≈ûube</strong></td>
                <td style="padding:8px;border:1px solid #ddd">${sube}</td>
                <td style="padding:8px;border:1px solid #ddd;background-color:#f9f9f9;-webkit-print-color-adjust:exact"><strong>Pozisyon</strong></td>
                <td style="padding:8px;border:1px solid #ddd">${pozAd}</td>
            </tr>
            <tr>
                <td style="padding:8px;border:1px solid #ddd;background-color:#f9f9f9;-webkit-print-color-adjust:exact"><strong>IBAN</strong></td>
                <td style="padding:8px;border:1px solid #ddd" colspan="3">${iban}</td>
            </tr>
            <tr>
                <td style="padding:8px;border:1px solid #ddd;background-color:#f9f9f9;-webkit-print-color-adjust:exact"><strong>Talep Tarihi</strong></td>
                <td style="padding:8px;border:1px solid #ddd">${tarih}</td>
                <td style="padding:8px;border:1px solid #ddd;background-color:#f9f9f9;-webkit-print-color-adjust:exact"><strong>Belge No</strong></td>
                <td style="padding:8px;border:1px solid #ddd">${docNo('AVS', sube)}</td>
            </tr>
            <tr>
                <td style="padding:8px;border:1px solid #ddd;background-color:#f9f9f9;-webkit-print-color-adjust:exact"><strong>Talep Edilen Tutar</strong></td>
                <td style="padding:8px;border:1px solid #ddd" colspan="3"><strong>${tutarFormat} TL</strong> (${tutarYazi} T√ºrk Lirasƒ±)</td>
            </tr>
            <tr>
                <td style="padding:8px;border:1px solid #ddd;background-color:#f9f9f9;-webkit-print-color-adjust:exact"><strong>Geri √ñdeme</strong></td>
                <td style="padding:8px;border:1px solid #ddd" colspan="3">Gelecek ay maa≈üƒ±ndan tek seferde kesilecektir</td>
            </tr>
        </table>
        <div style="margin:15px 0">
            <strong>Talep Gerek√ßesi:</strong>
            <p style="background-color:#f9f9f9;-webkit-print-color-adjust:exact;padding:12px;border-left:3px solid #ff8674;margin:8px 0;min-height:50px">${gerekce}</p>
        </div>
        <div style="background-color:#f5f5f5;-webkit-print-color-adjust:exact;padding:10px;border-radius:4px;margin:15px 0">
            <strong>PERSONEL BEYANI:</strong> Ben ${personel}, yukarƒ±da belirtilen tutarda avans talep ettiƒüimi, bu avansƒ±n onaylanmasƒ± halinde gelecek ay maa≈üƒ±mdan tek seferde kesilerek mahsup edileceƒüini kabul ve taahh√ºt ederim.
        </div>
        <div style="background-color:#ebf5fb;-webkit-print-color-adjust:exact;padding:10px;border-radius:4px;font-size:10pt;margin:15px 0">
            <strong>YASAL Bƒ∞LGƒ∞LENDƒ∞RME:</strong> 4857 sayƒ±lƒ± ƒ∞≈ü Kanunu'nda avans √∂denmesine ili≈ükin herhangi bir d√ºzenleme bulunmamaktadƒ±r. Avans talebi tamamen i≈üverenin inisiyatifinde olup, i≈üveren avans verip vermemekte ve √∂deme zamanƒ±nƒ± belirlemekte serbesttir. Talep, 7 i≈ü g√ºn√º i√ßinde deƒüerlendirilecek olup; onaylanmasƒ± halinde en yakƒ±n √∂deme d√∂ng√ºs√ºnde, TBK Md. 407/2 uyarƒ±nca personelin yazƒ±lƒ± muvafakati ile maa≈üƒ±ndan mahsup edilecektir. ƒ∞≈üveren, gerek√ße g√∂stermeksizin talebi reddetme hakkƒ±nƒ± saklƒ± tutar.
        </div>
        <table style="width:100%;margin-top:20px">
            <tr>
                <td style="width:50%;text-align:center;padding:15px;vertical-align:bottom">
                    <div style="margin-bottom:40px">${personel}</div>
                    <div style="border-top:1px solid #000;padding-top:8px"><strong>PERSONEL</strong><br><span style="font-size:10pt">Ad Soyad / ƒ∞mza</span></div>
                </td>
                <td style="width:50%;text-align:center;padding:15px;vertical-align:bottom">
                    <div style="margin-bottom:15px">‚òê ONAYLANDI &nbsp; ‚òê REDDEDƒ∞LDƒ∞</div>
                    <div style="margin-bottom:15px;font-size:10pt">Tarih: ___/___/________</div>
                    <div style="border-top:1px solid #000;padding-top:8px"><strong>ƒ∞≈ûVEREN</strong><br><span style="font-size:10pt">Ka≈üe / ƒ∞mza</span></div>
                </td>
            </tr>
        </table>
    </div>`;
    
    showPreview('Avans Talebi - ' + personel, html);
}

// Sayƒ±yƒ± yazƒ±ya √ßevir fonksiyonu
function sayiyiYaziyaCevir(sayi) {
    if (sayi === 0) return 'sƒ±fƒ±r';
    if (sayi < 0) return 'eksi ' + sayiyiYaziyaCevir(-sayi);
    
    const birler = ['', 'bir', 'iki', '√º√ß', 'd√∂rt', 'be≈ü', 'altƒ±', 'yedi', 'sekiz', 'dokuz'];
    const onlar = ['', 'on', 'yirmi', 'otuz', 'kƒ±rk', 'elli', 'altmƒ±≈ü', 'yetmi≈ü', 'seksen', 'doksan'];
    
    let sonuc = '';
    
    if (sayi >= 1000000) {
        const milyon = Math.floor(sayi / 1000000);
        sonuc += (milyon === 1 ? '' : sayiyiYaziyaCevir(milyon) + ' ') + 'milyon ';
        sayi %= 1000000;
    }
    
    if (sayi >= 1000) {
        const bin = Math.floor(sayi / 1000);
        sonuc += (bin === 1 ? '' : sayiyiYaziyaCevir(bin) + ' ') + 'bin ';
        sayi %= 1000;
    }
    
    if (sayi >= 100) {
        const yuz = Math.floor(sayi / 100);
        sonuc += (yuz === 1 ? '' : birler[yuz] + ' ') + 'y√ºz ';
        sayi %= 100;
    }
    
    if (sayi >= 10) {
        sonuc += onlar[Math.floor(sayi / 10)] + ' ';
        sayi %= 10;
    }
    
    if (sayi > 0) {
        sonuc += birler[sayi] + ' ';
    }
    
    return sonuc.trim();
}

// ==================== Zƒ∞MMET ====================
let zimmetSayaci = 0;

function zimmetEkle() {
    zimmetSayaci++;
    const container = document.getElementById('zimmetListesi');
    const div = document.createElement('div');
    div.className = 'zimmet-item';
    div.id = `zimmet_item_${zimmetSayaci}`;
    div.style.cssText = 'display:grid;grid-template-columns:1fr 60px 1fr 1fr 1fr auto;gap:10px;padding:15px;background:#f9f9f9;border-radius:8px;margin-bottom:10px;align-items:end';
    div.innerHTML = `
        <div class="form-group" style="margin:0"><label class="form-label">E≈üya T√ºr√º</label>
            <select class="form-select" id="zimmet_tur_${zimmetSayaci}">
                <option value="telefon">Cep Telefonu</option>
                <option value="notebook">Notebook / Laptop</option>
                <option value="tablet">Tablet</option>
                <option value="pos">POS Cihazƒ±</option>
                <option value="anahtar">Anahtar</option>
                <option value="kart">Giri≈ü Kartƒ±</option>
                <option value="kiyafet">√úniforma / Kƒ±yafet</option>
                <option value="diger">Diƒüer</option>
            </select>
        </div>
        <div class="form-group" style="margin:0"><label class="form-label">Adet</label><input type="number" class="form-input" id="zimmet_adet_${zimmetSayaci}" value="1" min="1" style="text-align:center"></div>
        <div class="form-group" style="margin:0"><label class="form-label">Marka / Model</label><input type="text" class="form-input" id="zimmet_marka_${zimmetSayaci}" placeholder="√ñrn: iPhone 17 Pro"></div>
        <div class="form-group" style="margin:0"><label class="form-label">Seri No / IMEI</label><input type="text" class="form-input" id="zimmet_seri_${zimmetSayaci}" placeholder="Varsa seri numarasƒ±"></div>
        <div class="form-group" style="margin:0"><label class="form-label">Tahmini Deƒüer (TL)</label><input type="text" class="form-input" id="zimmet_deger_${zimmetSayaci}" placeholder="0"></div>
        <button class="btn btn-ghost" onclick="zimmetSil(${zimmetSayaci})" style="color:#e74c3c;padding:8px">üóëÔ∏è</button>
    `;
    container.appendChild(div);
}

function zimmetSil(id) {
    const item = document.getElementById(`zimmet_item_${id}`);
    if (item) item.remove();
}

function getZimmetListesi() {
    const items = document.querySelectorAll('[id^="zimmet_item_"]');
    const liste = [];
    items.forEach(item => {
        const id = item.id.replace('zimmet_item_', '');
        const turSelect = document.getElementById(`zimmet_tur_${id}`);
        const tur = turSelect ? turSelect.options[turSelect.selectedIndex].text : '';
        const adet = document.getElementById(`zimmet_adet_${id}`)?.value || '1';
        const marka = document.getElementById(`zimmet_marka_${id}`)?.value || '';
        const seri = document.getElementById(`zimmet_seri_${id}`)?.value || '-';
        const deger = document.getElementById(`zimmet_deger_${id}`)?.value || '0';
        if (tur || marka) {
            liste.push({ tur, adet, marka, seri, deger });
        }
    });
    return liste;
}

function generateZimmet() {
    const islemLabels = {teslim: 'TESLƒ∞M (Zƒ∞MMET)', iade: 'ƒ∞ADE'};
    
    const personel = getVal('zimmet_personel') || '______________________';
    const tc = getVal('zimmet_tc') || '___________';
    const sube = getVal('zimmet_sube') || STATE.branches[0] || '______';
    const pozisyon = getVal('zimmet_pozisyon');
    const pozAd = STATE.positions.find(p => p.id === pozisyon)?.name || '______';
    const tarih = formatDate(getVal('zimmet_tarih')) || today();
    const islem = getVal('zimmet_islem') || 'teslim';
    const notlar = getVal('zimmet_notlar') || '';
    const yetkili = getVal('zimmet_yetkili') || '______________________';
    
    const liste = getZimmetListesi();
    
    if (liste.length === 0) {
        alert('L√ºtfen en az bir e≈üya ekleyin.');
        return;
    }
    
    let toplamDeger = 0;
    const esyaRows = liste.map((item, idx) => {
        const degerNum = parseInt(item.deger.replace(/\D/g, '')) || 0;
        toplamDeger += degerNum;
        return `<tr>
            <td style="padding:8px;border:1px solid #ddd;text-align:center">${idx + 1}</td>
            <td style="padding:8px;border:1px solid #ddd">${item.tur}</td>
            <td style="padding:8px;border:1px solid #ddd;text-align:center">${item.adet}</td>
            <td style="padding:8px;border:1px solid #ddd">${item.marka}</td>
            <td style="padding:8px;border:1px solid #ddd">${item.seri}</td>
            <td style="padding:8px;border:1px solid #ddd;text-align:right">${degerNum.toLocaleString('tr-TR')} TL</td>
        </tr>`;
    }).join('');
    
    const html = `<div class="doc" style="font-size:11pt;line-height:1.5;-webkit-print-color-adjust:exact;print-color-adjust:exact">
        ${docHeader('DEMƒ∞RBA≈û TESLƒ∞M VE Zƒ∞MMET TUTANAƒûI')}
        <p style="text-align:center;font-weight:bold;margin-top:-10px;margin-bottom:20px;color:#ff8674">${islemLabels[islem]}</p>
        <div class="doc-section" style="margin-bottom:15px">
            <table style="width:100%;font-size:10pt">
                <tr><td><strong>Tarih:</strong> ${tarih}</td><td style="text-align:right"><strong>Belge No:</strong> ${docNo('ZMT', sube)}</td></tr>
            </table>
        </div>
        
        <table style="width:100%;border-collapse:collapse;margin:15px 0">
            <tr>
                <td style="padding:8px;border:1px solid #ddd;background-color:#f9f9f9;-webkit-print-color-adjust:exact;width:25%"><strong>Personel</strong></td>
                <td style="padding:8px;border:1px solid #ddd;width:25%">${personel}</td>
                <td style="padding:8px;border:1px solid #ddd;background-color:#f9f9f9;-webkit-print-color-adjust:exact;width:25%"><strong>TC Kimlik No</strong></td>
                <td style="padding:8px;border:1px solid #ddd;width:25%">${tc}</td>
            </tr>
            <tr>
                <td style="padding:8px;border:1px solid #ddd;background-color:#f9f9f9;-webkit-print-color-adjust:exact"><strong>≈ûube</strong></td>
                <td style="padding:8px;border:1px solid #ddd">${sube}</td>
                <td style="padding:8px;border:1px solid #ddd;background-color:#f9f9f9;-webkit-print-color-adjust:exact"><strong>Pozisyon</strong></td>
                <td style="padding:8px;border:1px solid #ddd">${pozAd}</td>
            </tr>
        </table>
        
        <div style="margin:20px 0">
            <strong style="font-size:12pt">Zƒ∞MMET EDƒ∞LEN E≈ûYALAR</strong>
            <table style="width:100%;border-collapse:collapse;margin:10px 0">
                <thead>
                    <tr style="background-color:#f0f0f0;-webkit-print-color-adjust:exact">
                        <th style="padding:10px;border:1px solid #ddd;width:40px">No</th>
                        <th style="padding:10px;border:1px solid #ddd">E≈üya T√ºr√º</th>
                        <th style="padding:10px;border:1px solid #ddd;width:50px">Adet</th>
                        <th style="padding:10px;border:1px solid #ddd">Marka / Model</th>
                        <th style="padding:10px;border:1px solid #ddd">Seri No / IMEI</th>
                        <th style="padding:10px;border:1px solid #ddd;width:100px">Deƒüer</th>
                    </tr>
                </thead>
                <tbody>
                    ${esyaRows}
                </tbody>
                <tfoot>
                    <tr style="background-color:#f9f9f9;-webkit-print-color-adjust:exact">
                        <td colspan="5" style="padding:10px;border:1px solid #ddd;text-align:right"><strong>TOPLAM DEƒûER:</strong></td>
                        <td style="padding:10px;border:1px solid #ddd;text-align:right"><strong>${toplamDeger.toLocaleString('tr-TR')} TL</strong></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        ${notlar ? `<div style="margin:15px 0"><strong>Ek Notlar:</strong><p style="background-color:#f9f9f9;-webkit-print-color-adjust:exact;padding:10px;border-left:3px solid #ff8674;margin:5px 0">${notlar}</p></div>` : ''}
        
        <div style="background-color:#ebf5fb;-webkit-print-color-adjust:exact;padding:12px;border-radius:6px;font-size:10pt;margin:20px 0">
            <strong>PERSONEL TAAHH√úD√ú:</strong><br>
            Yukarƒ±da belirtilen demirba≈ü/e≈üyalarƒ± eksiksiz ve √ßalƒ±≈üƒ±r durumda teslim aldƒ±ƒüƒ±mƒ±; bunlarƒ± √∂zenle kullanacaƒüƒ±mƒ±, i≈üveren izni olmaksƒ±zƒ±n √º√ß√ºnc√º ki≈üilere devretmeyeceƒüimi, i≈üten ayrƒ±lmam veya talep halinde derhal iade edeceƒüimi kabul ve taahh√ºt ederim.<br><br>
            <strong>Yasal Dayanak:</strong> TBK Md. 390 (√∂zen borcu), TBK Md. 462 (teslim edilen e≈üyalarƒ±n korunmasƒ±), 4857 sayƒ±lƒ± ƒ∞≈ü Kanunu Md. 25/II-e (g√ºveni k√∂t√ºye kullanma). Zimmet edilen e≈üyalarƒ±n kaybƒ±, hasarƒ± veya iadeden imtina halinde, g√ºncel rayi√ß bedeli √ºzerinden tazmin y√ºk√ºml√ºl√ºƒü√º doƒüar.
        </div>
        
        <table style="width:100%;margin-top:40px;border:none;">
            <tr>
                <td style="width:50%;text-align:center;vertical-align:bottom;padding:20px;border:none;">
                    <p style="margin-bottom:60px">(Ka≈üe / ƒ∞mza)</p>
                    <div style="border-top:1px solid #000;width:70%;margin:0 auto;padding-top:10px">
                        <p style="font-weight:bold">TESLƒ∞M EDEN</p>
                        <p style="font-size:10pt">${yetkili}</p>
                    </div>
                </td>
                <td style="width:50%;text-align:center;vertical-align:bottom;padding:20px;border:none;">
                    <p style="margin-bottom:40px">${personel}</p>
                    <p style="margin-bottom:20px">(ƒ∞mza)</p>
                    <div style="border-top:1px solid #000;width:70%;margin:0 auto;padding-top:10px">
                        <p style="font-weight:bold">TESLƒ∞M ALAN</p>
                    </div>
                </td>
            </tr>
        </table>
    </div>`;
    
    showPreview('Zimmet Formu - ' + personel, html);
}

// Sayfa y√ºklendiƒüinde varsayƒ±lan bir e≈üya satƒ±rƒ± ekle
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        if (document.getElementById('zimmetListesi') && document.getElementById('zimmetListesi').children.length === 0) {
            zimmetEkle();
        }
    }, 500);
});

// ==================== KATALOG ====================
function renderViolations(filter = 'all') {
    const list = document.getElementById('violationList');
    if (!list) return;
    let items = filter === 'all' ? STATE.violations : STATE.violations.filter(v => v.risk === filter);
    list.innerHTML = items.map(v => `
        <div class="violation-item" onclick="showViolation('${v.id}')">
            <div class="violation-header">
                <div class="violation-title">${v.id}: ${v.title}</div>
                <span class="violation-badge ${v.risk}">${v.risk === 'low' ? 'D√º≈ü√ºk' : v.risk === 'medium' ? 'Orta' : 'Y√ºksek'}</span>
            </div>
            <div class="violation-legal">${v.legal}</div>
        </div>
    `).join('');
}

function filterKatalog(filter, btn) {
    document.querySelectorAll('#katalogTabs .tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    renderViolations(filter);
}

function showViolation(id) {
    const v = STATE.violations.find(x => x.id === id);
    if (!v) return;
    const colors = {low: '#e9f7ef', medium: '#fef9e7', high: '#fdedec'};
    const html = `<div class="doc">
        <div class="doc-header" style="border-bottom-color:${v.risk === 'high' ? '#e74c3c' : v.risk === 'medium' ? '#f39c12' : '#2ecc71'}">
            <div class="doc-title" style="text-decoration:none">${v.title}</div>
            <div class="doc-company-info">${v.id}</div>
        </div>
        <div class="doc-section"><div class="doc-section-title">YASAL DAYANAK</div><p>${v.legal}</p></div>
        <div class="doc-section"><div class="doc-section-title">A√áIKLAMA</div><p>${v.desc}</p></div>
        <div class="doc-section"><div class="doc-section-title">ƒ∞ZLENECEK PROSED√úR</div><ol style="margin-left:20px;line-height:2">${v.steps.map(s => '<li>' + s + '</li>').join('')}</ol></div>
        <div style="background:${colors[v.risk]};padding:15px;border-radius:6px"><strong>Risk:</strong> ${v.risk === 'low' ? 'D√ú≈û√úK - Uyarƒ± ile √ß√∂z√ºlebilir' : v.risk === 'medium' ? 'ORTA - Savunma ve ihtar gerektirir' : 'Y√úKSEK - Haklƒ± fesih sebebi'}</div>
    </div>`;
    showPreview(v.title, html);
}

// ==================== ADMIN PANEL ====================
function openAdminWithPin() {
    // Artƒ±k PIN sormuyoruz, giri≈ü yapƒ±lmƒ±≈ü kullanƒ±cƒ±nƒ±n yetkisini kontrol ediyoruz
    if (!currentUser) {
        toast('L√ºtfen √∂nce giri≈ü yapƒ±n', 'error');
        return;
    }
    
    // Y√∂netici her zaman eri≈üebilir
    if (currentUser.role === 'yonetici') {
        goTo('admin');
        return;
    }
    
    // Diƒüer roller i√ßin geli≈ümi≈ü izin kontrol√º
    if (checkPermission('admin', 'admin_genel', 'access')) {
        goTo('admin');
    } else {
        toast('Bu sayfaya eri≈üim yetkiniz yok', 'error');
    }
}

function autoCheckAdminPin() {
    const input = document.getElementById('adminPinInput');
    if (input && input.value.length === 4) {
        if (input.value === STATE.pin) {
            input.style.borderColor = 'var(--green)';
            setTimeout(() => {
                closeModal();
                goTo('admin');
            }, 200);
        } else {
            input.style.borderColor = 'var(--red)';
            toast('Hatalƒ± PIN', 'error');
            setTimeout(() => {
                input.value = '';
                input.style.borderColor = '';
            }, 500);
        }
    }
}

function checkAdminPin() {
    const input = document.getElementById('adminPinInput');
    if (input && input.value === STATE.pin) {
        closeModal();
        goTo('admin');
    } else {
        toast('Hatalƒ± PIN', 'error');
        if (input) input.value = '';
    }
}

function showAdminTab(tab, btn) {
    // Kaydedilmemi≈ü belge ≈üablonu deƒüi≈üikliƒüi kontrol√º
    if (hasUnsavedDocChanges && currentPage === 'admin') {
        showUnsavedChangesModal(() => {
            saveDocTemplate();
            hasUnsavedDocChanges = false;
            switchAdminTab(tab, btn);
        }, () => {
            hasUnsavedDocChanges = false;
            switchAdminTab(tab, btn);
        });
        return;
    }
    switchAdminTab(tab, btn);
}

function switchAdminTab(tab, btn) {
    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
    document.getElementById('admin-' + tab).classList.add('active');
    if (tab === 'sablonlar') loadTemplate();
    if (tab === 'belgeler') loadDocTemplate('tutanak', 'olay');
    if (tab === 'oturumlar') {
        loadSessionSettings();
        loadActiveSessions();
        loadSessionHistory();
    }
    if (tab === 'aktiviteler') loadActivityLogs();
}

function loadAdminFields() {
    document.getElementById('admin_company_name').value = STATE.company.name;
    document.getElementById('admin_mersis').value = STATE.company.mersis;
    document.getElementById('admin_address').value = STATE.company.address;
}

function renderAdminLists() {
    // Y√∂netici-only tab'larƒ± kontrol et
    const adminOnlyTabs = ['tab-kullanicilar', 'tab-oturumlar', 'tab-aktiviteler'];
    const adminOnlySections = ['admin-kullanicilar', 'admin-oturumlar', 'admin-aktiviteler'];
    
    if (currentUser?.role !== 'yonetici') {
        // Tab butonlarƒ±nƒ± gizle
        adminOnlyTabs.forEach(tabId => {
            const tab = document.getElementById(tabId);
            if (tab) tab.style.display = 'none';
        });
        // B√∂l√ºmleri de gizle (g√ºvenlik)
        adminOnlySections.forEach(sectionId => {
            const section = document.getElementById(sectionId);
            if (section) section.style.display = 'none';
        });
    } else {
        // Y√∂netici i√ßin g√∂ster
        adminOnlyTabs.forEach(tabId => {
            const tab = document.getElementById(tabId);
            if (tab) tab.style.display = '';
        });
        adminOnlySections.forEach(sectionId => {
            const section = document.getElementById(sectionId);
            if (section) section.style.display = '';
        });
    }
    
    // Y√∂netici i√ßin √∂zel kartlarƒ± g√∂ster
    const adminPasswordCard = document.getElementById('adminPasswordCard');
    const dataCleanupCard = document.getElementById('dataCleanupCard');
    const rolePreviewCard = document.getElementById('rolePreviewCard');
    if (currentUser?.role === 'yonetici') {
        if (adminPasswordCard) adminPasswordCard.style.display = 'block';
        if (dataCleanupCard) dataCleanupCard.style.display = 'block';
        if (rolePreviewCard) rolePreviewCard.style.display = 'block';
    }
    
    // Branches
    const branchList = document.getElementById('branchList');
    if (branchList) {
        branchList.innerHTML = STATE.branches.map((b, i) => `
            <div class="admin-list-item">
                <div class="admin-list-item-text">${b}</div>
                <div class="admin-list-item-actions">
                    <button class="admin-btn-icon admin-btn-edit" onclick="editBranch(${i})">‚úèÔ∏è</button>
                    <button class="admin-btn-icon admin-btn-delete" onclick="deleteBranch(${i})">üóëÔ∏è</button>
                </div>
            </div>
        `).join('');
    }
    
    // Positions
    const posList = document.getElementById('positionList');
    if (posList) {
        posList.innerHTML = STATE.positions.map((p, i) => `
            <div class="admin-list-item">
                <div class="admin-list-item-text">${p.name} <span style="color:var(--txdark2);font-size:.8rem">(${p.type})</span></div>
                <div class="admin-list-item-actions">
                    <button class="admin-btn-icon admin-btn-edit" onclick="editPosition(${i})">‚úèÔ∏è</button>
                    <button class="admin-btn-icon admin-btn-delete" onclick="deletePosition(${i})">üóëÔ∏è</button>
                </div>
            </div>
        `).join('');
    }
    
    // Violations
    const violList = document.getElementById('violationAdminList');
    if (violList) {
        violList.innerHTML = STATE.violations.map((v, i) => `
            <div class="admin-list-item">
                <div class="admin-list-item-text">${v.id}: ${v.title} <span class="violation-badge ${v.risk}" style="margin-left:8px">${v.risk}</span></div>
                <div class="admin-list-item-actions">
                    <button class="admin-btn-icon admin-btn-edit" onclick="editViolation(${i})">‚úèÔ∏è</button>
                    <button class="admin-btn-icon admin-btn-delete" onclick="deleteViolation(${i})">üóëÔ∏è</button>
                </div>
            </div>
        `).join('');
    }
}

// Duplicate personel temizleme
async function cleanDuplicatePersonel() {
    const resultsDiv = document.getElementById('cleanupResults');
    resultsDiv.style.display = 'block';
    resultsDiv.innerHTML = '<p style="color:var(--tx2)">‚è≥ Taranƒ±yor...</p>';
    
    try {
        const snapshot = await db.collection('personel').get();
        const personelMap = {};
        const toDelete = [];
        
        snapshot.forEach(doc => {
            const d = doc.data();
            const key = `${d.name}-${d.branch}`;
            if (personelMap[key]) {
                // Bu bir duplicate
                toDelete.push({ id: doc.id, name: d.name, branch: d.branch });
            } else {
                personelMap[key] = doc.id;
            }
        });
        
        if (toDelete.length === 0) {
            resultsDiv.innerHTML = '<p style="color:var(--green)">‚úÖ Duplicate personel bulunamadƒ±.</p>';
            return;
        }
        
        // Silme i≈ülemi i√ßin onay
        resultsDiv.innerHTML = `
            <p style="color:var(--yellow);margin-bottom:12px">‚ö†Ô∏è ${toDelete.length} duplicate personel bulundu:</p>
            <ul style="font-size:.85rem;margin-bottom:12px;padding-left:20px">
                ${toDelete.slice(0, 10).map(p => `<li>${p.name} (${p.branch})</li>`).join('')}
                ${toDelete.length > 10 ? `<li>...ve ${toDelete.length - 10} daha</li>` : ''}
            </ul>
            <button class="btn btn-primary btn-sm" onclick="confirmDeleteDuplicates('${JSON.stringify(toDelete.map(p => p.id)).replace(/"/g, '&quot;')}')">Sil (${toDelete.length} kayƒ±t)</button>
            <button class="btn btn-ghost btn-sm" onclick="document.getElementById('cleanupResults').style.display='none'">ƒ∞ptal</button>
        `;
    } catch (e) {
        resultsDiv.innerHTML = `<p style="color:var(--red)">‚ùå Hata: ${e.message}</p>`;
    }
}

async function confirmDeleteDuplicates(idsJson) {
    const ids = JSON.parse(idsJson.replace(/&quot;/g, '"'));
    const resultsDiv = document.getElementById('cleanupResults');
    resultsDiv.innerHTML = '<p style="color:var(--tx2)">‚è≥ Siliniyor...</p>';
    
    try {
        const batch = db.batch();
        ids.forEach(id => {
            batch.delete(db.collection('personel').doc(id));
        });
        await batch.commit();
        resultsDiv.innerHTML = `<p style="color:var(--green)">‚úÖ ${ids.length} duplicate personel silindi.</p>`;
        toast(`${ids.length} duplicate personel silindi`, 'success');
    } catch (e) {
        resultsDiv.innerHTML = `<p style="color:var(--red)">‚ùå Hata: ${e.message}</p>`;
    }
}

// Duplicate shift temizleme
async function cleanDuplicateShifts() {
    const resultsDiv = document.getElementById('cleanupResults');
    resultsDiv.style.display = 'block';
    resultsDiv.innerHTML = '<p style="color:var(--tx2)">‚è≥ Taranƒ±yor...</p>';
    
    try {
        const snapshot = await db.collection('shifts').get();
        const shiftMap = {};
        const toDelete = [];
        
        snapshot.forEach(doc => {
            const d = doc.data();
            const key = `${d.branch}-${d.weekStart}`;
            if (shiftMap[key]) {
                // Bu bir duplicate - daha eski olanƒ± sil
                toDelete.push({ id: doc.id, branch: d.branch, weekStart: d.weekStart });
            } else {
                shiftMap[key] = doc.id;
            }
        });
        
        if (toDelete.length === 0) {
            resultsDiv.innerHTML = '<p style="color:var(--green)">‚úÖ Duplicate shift bulunamadƒ±.</p>';
            return;
        }
        
        resultsDiv.innerHTML = `
            <p style="color:var(--yellow);margin-bottom:12px">‚ö†Ô∏è ${toDelete.length} duplicate shift bulundu.</p>
            <button class="btn btn-primary btn-sm" onclick="confirmDeleteDuplicateShifts('${JSON.stringify(toDelete.map(p => p.id)).replace(/"/g, '&quot;')}')">Sil (${toDelete.length} kayƒ±t)</button>
            <button class="btn btn-ghost btn-sm" onclick="document.getElementById('cleanupResults').style.display='none'">ƒ∞ptal</button>
        `;
    } catch (e) {
        resultsDiv.innerHTML = `<p style="color:var(--red)">‚ùå Hata: ${e.message}</p>`;
    }
}

async function confirmDeleteDuplicateShifts(idsJson) {
    const ids = JSON.parse(idsJson.replace(/&quot;/g, '"'));
    const resultsDiv = document.getElementById('cleanupResults');
    resultsDiv.innerHTML = '<p style="color:var(--tx2)">‚è≥ Siliniyor...</p>';
    
    try {
        const batch = db.batch();
        ids.forEach(id => {
            batch.delete(db.collection('shifts').doc(id));
        });
        await batch.commit();
        resultsDiv.innerHTML = `<p style="color:var(--green)">‚úÖ ${ids.length} duplicate shift silindi.</p>`;
        toast(`${ids.length} duplicate shift silindi`, 'success');
    } catch (e) {
        resultsDiv.innerHTML = `<p style="color:var(--red)">‚ùå Hata: ${e.message}</p>`;
    }
}

// ========== ROL √ñNƒ∞ZLEME ==========
let originalUser = null;
let isPreviewMode = false;

// Sayfa y√ºklendiƒüinde √∂nizleme durumunu kontrol et
function checkPreviewMode() {
    const saved = localStorage.getItem('moonberry_preview');
    if (saved) {
        try {
            const data = JSON.parse(saved);
            if (data.originalUser && data.previewUser) {
                originalUser = data.originalUser;
                isPreviewMode = true;
                currentUser = data.previewUser;
                
                // UI g√ºncelle
                const roleNames = { 'barista': 'Barista', 'bolge_muduru': 'B√∂lge M√ºd√ºr√º', 'magaza_muduru': 'Maƒüaza M√ºd√ºr√º', 'yonetici': 'Y√∂netici' };
                
                document.getElementById('previewRoleName').textContent = roleNames[currentUser.role];
                document.getElementById('previewBranchName').textContent = currentUser.branch || 'T√ºm ≈ûubeler';
                document.getElementById('rolePreviewContent').style.display = 'none';
                document.getElementById('rolePreviewActive').style.display = 'block';
                
                const userNameEl = document.getElementById('userName');
                if (userNameEl) userNameEl.innerHTML = `<span style="background:var(--yellow);color:#000;padding:2px 6px;border-radius:4px;font-size:.7rem;margin-right:6px">√ñNƒ∞ZLEME</span>${roleNames[currentUser.role]}`;
                
                const userRoleEl = document.getElementById('userRole');
                if (userRoleEl) userRoleEl.textContent = currentUser.branch || 'T√ºm ≈ûubeler';
                
                // √úst bar ekle
                showPreviewTopBar();
                
                // Yetkileri uygula
                applyRolePreviewPermissions(currentUser.role, currentUser.branch);
            }
        } catch (e) {
            localStorage.removeItem('moonberry_preview');
        }
    }
}

// √ñnizleme √ºst barƒ±
function showPreviewTopBar() {
    if (document.getElementById('previewTopBar')) return;
    
    const roleNames = { 'barista': 'Barista', 'bolge_muduru': 'B√∂lge M√ºd√ºr√º', 'magaza_muduru': 'Maƒüaza M√ºd√ºr√º', 'yonetici': 'Y√∂netici' };
    const bar = document.createElement('div');
    bar.id = 'previewTopBar';
    bar.style.cssText = 'position:fixed;top:0;left:0;right:0;background:linear-gradient(135deg,#f39c12,#e67e22);color:#fff;padding:10px 20px;display:flex;justify-content:space-between;align-items:center;z-index:10000;font-size:.9rem;box-shadow:0 2px 10px rgba(0,0,0,.3)';
    bar.innerHTML = `
        <div style="display:flex;align-items:center;gap:12px">
            <span style="font-size:1.2rem">üëÅÔ∏è</span>
            <span><strong>√ñnizleme Modu:</strong> ${roleNames[currentUser.role]} ${currentUser.branch && currentUser.branch !== 'all' ? '‚Ä¢ ' + currentUser.branch : ''}</span>
        </div>
        <button onclick="stopRolePreview()" style="background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.4);color:#fff;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:.85rem;font-weight:500">‚úï √ñnizlemeyi Sonlandƒ±r</button>
    `;
    document.body.prepend(bar);
    document.body.style.paddingTop = '50px';
}

function startRolePreview() {
    const role = document.getElementById('previewRoleSelect').value;
    const branch = document.getElementById('previewBranchSelect').value;
    
    if (!role) {
        toast('L√ºtfen bir rol se√ßin', 'error');
        return;
    }
    if (!branch && role === 'magaza_muduru') {
        toast('Maƒüaza M√ºd√ºr√º i√ßin ≈üube se√ßimi gerekli', 'error');
        return;
    }
    
    // Mevcut kullanƒ±cƒ±yƒ± sakla
    originalUser = { ...currentUser };
    isPreviewMode = true;
    
    // √ñnizleme kullanƒ±cƒ±sƒ±nƒ± ayarla
    const roleNames = {
        'barista': 'Barista',
        'bolge_muduru': 'B√∂lge M√ºd√ºr√º',
        'magaza_muduru': 'Maƒüaza M√ºd√ºr√º',
        'yonetici': 'Y√∂netici'
    };
    
    currentUser = {
        ...currentUser,
        role: role,
        branch: role === 'magaza_muduru' ? branch : (role === 'barista' ? branch : 'all'),
        name: `√ñnizleme: ${roleNames[role]}`
    };
    
    // UI g√ºncelle
    document.getElementById('previewRoleName').textContent = roleNames[role];
    document.getElementById('previewBranchName').textContent = branch || 'T√ºm ≈ûubeler';
    document.getElementById('rolePreviewContent').style.display = 'none';
    document.getElementById('rolePreviewActive').style.display = 'block';
    
    // Sidebar'a √∂nizleme badge'i ekle
    const userNameEl = document.getElementById('userName');
    if (userNameEl) {
        userNameEl.innerHTML = `<span style="background:var(--yellow);color:#000;padding:2px 6px;border-radius:4px;font-size:.7rem;margin-right:6px">√ñNƒ∞ZLEME</span>${roleNames[role]}`;
    }
    const userRoleEl = document.getElementById('userRole');
    if (userRoleEl) {
        userRoleEl.textContent = branch || 'T√ºm ≈ûubeler';
    }
    
    // LocalStorage'a kaydet
    localStorage.setItem('moonberry_preview', JSON.stringify({ originalUser, previewUser: currentUser }));
    
    // √úst bar ekle
    showPreviewTopBar();
    
    // Yetkileri uygula
    applyRolePreviewPermissions(role, branch);
    
    toast(`${roleNames[role]} olarak √∂nizleme ba≈üladƒ±`, 'info');
}

function applyRolePreviewPermissions(role, branch) {
    // Barista i√ßin √∂zel kƒ±sƒ±tlamalar
    if (role === 'barista') {
        applyBaristaRestrictions();
        if (branch) {
            document.querySelectorAll('select[id*="Sube"]').forEach(select => {
                select.value = branch;
                select.disabled = true;
            });
        }
        return;
    }
    
    // Men√º √∂ƒüelerini g√∂ster/gizle
    const hiddenForMagaza = ['admin', 'sozlesme', 'fesih'];
    const hiddenForBolge = [];
    
    document.querySelectorAll('.nav-item[data-page]').forEach(item => {
        const page = item.dataset.page;
        item.style.display = '';
        
        if (role === 'magaza_muduru' && hiddenForMagaza.includes(page)) {
            item.style.display = 'none';
        }
        if (role === 'bolge_muduru' && hiddenForBolge.includes(page)) {
            item.style.display = 'none';
        }
    });
    
    // ≈ûube filtreleme (maƒüaza m√ºd√ºr√º sadece kendi ≈üubesini g√∂r√ºr)
    if (role === 'magaza_muduru' && branch) {
        // ≈ûube se√ßicileri kilitle
        document.querySelectorAll('select[id*="Sube"]').forEach(select => {
            select.value = branch;
            select.disabled = true;
        });
    }
}

function stopRolePreview() {
    if (!originalUser) return;
    
    // Orijinal kullanƒ±cƒ±yƒ± geri y√ºkle
    currentUser = { ...originalUser };
    originalUser = null;
    isPreviewMode = false;
    
    // LocalStorage'dan sil
    localStorage.removeItem('moonberry_preview');
    
    // √úst barƒ± kaldƒ±r
    const topBar = document.getElementById('previewTopBar');
    if (topBar) topBar.remove();
    document.body.style.paddingTop = '';
    
    // UI'ƒ± sƒ±fƒ±rla
    document.getElementById('rolePreviewContent').style.display = 'block';
    document.getElementById('rolePreviewActive').style.display = 'none';
    document.getElementById('previewRoleSelect').value = '';
    document.getElementById('previewBranchSelect').value = '';
    
    // Sidebar kullanƒ±cƒ± bilgisini geri y√ºkle
    applyUserPermissions();
    
    // T√ºm men√º √∂ƒüelerini g√∂ster
    document.querySelectorAll('.nav-item[data-page]').forEach(item => {
        item.style.display = '';
    });
    
    // T√ºm nav gruplarƒ±nƒ± g√∂ster
    document.querySelectorAll('.nav-group').forEach(group => {
        group.style.display = '';
    });
    
    // T√ºm dashboard kartlarƒ±nƒ± g√∂ster
    document.querySelectorAll('.dashboard-card').forEach(card => {
        card.style.display = '';
    });
    
    // T√ºm dashboard section'larƒ± g√∂ster
    document.querySelectorAll('.dashboard-section').forEach(section => {
        section.style.display = '';
    });
    
    // ≈ûube se√ßicileri a√ß
    document.querySelectorAll('select[id*="Sube"]').forEach(select => {
        select.disabled = false;
    });
    
    toast('√ñnizleme sonlandƒ±rƒ±ldƒ±, y√∂netici g√∂r√ºn√ºm√ºne d√∂n√ºld√º', 'success');
}

// ========== PIN ==========
function changePin() {
    const current = document.getElementById('admin_pin_current').value;
    const newPin = document.getElementById('admin_pin_new').value;
    if (current !== STATE.pin) {
        toast('Mevcut PIN hatalƒ±', 'error');
        return;
    }
    if (newPin.length !== 4 || !/^\d+$/.test(newPin)) {
        toast('Yeni PIN 4 haneli rakam olmalƒ±', 'error');
        return;
    }
    STATE.pin = newPin;
    saveState();
    document.getElementById('admin_pin_current').value = '';
    document.getElementById('admin_pin_new').value = '';
    successModal('PIN ba≈üarƒ±yla deƒüi≈ütirildi!');
}

// ========== COMPANY ==========
function saveCompany() {
    STATE.company.name = getVal('admin_company_name') || STATE.company.name;
    STATE.company.mersis = getVal('admin_mersis') || STATE.company.mersis;
    STATE.company.address = getVal('admin_address') || STATE.company.address;
    saveState();
    document.getElementById('companyName').textContent = STATE.company.name;
    toast('≈ûirket bilgileri kaydedildi', 'success');
}

// ========== BRANCHES ==========
function addBranch() {
    showModal('≈ûube Ekle', `
        <div class="form-group">
            <label class="form-label">≈ûube Adƒ±</label>
            <input type="text" id="newBranchName" class="form-input" placeholder="√ñrn: Kadƒ±k√∂y">
        </div>
    `, `
        <button class="btn btn-ghost" onclick="closeModal()">ƒ∞ptal</button>
        <button class="btn btn-primary" onclick="saveBranch()">Ekle</button>
    `);
}

function saveBranch() {
    const name = getVal('newBranchName');
    if (name) {
        STATE.branches.push(name);
        saveState();
        populateSelects();
        renderAdminLists();
        closeModal();
        toast('≈ûube eklendi', 'success');
    }
}

function editBranch(i) {
    showModal('≈ûube D√ºzenle', `
        <div class="form-group">
            <label class="form-label">≈ûube Adƒ±</label>
            <input type="text" id="editBranchName" class="form-input" value="${STATE.branches[i]}">
        </div>
    `, `
        <button class="btn btn-ghost" onclick="closeModal()">ƒ∞ptal</button>
        <button class="btn btn-primary" onclick="updateBranch(${i})">Kaydet</button>
    `);
}

function updateBranch(i) {
    const name = getVal('editBranchName');
    if (name) {
        STATE.branches[i] = name;
        saveState();
        populateSelects();
        renderAdminLists();
        closeModal();
        toast('G√ºncellendi', 'success');
    }
}

function deleteBranch(i) {
    confirmModal('≈ûube Sil', `"${STATE.branches[i]}" ≈üubesini silmek istediƒüinize emin misiniz?`, () => {
        STATE.branches.splice(i, 1);
        saveState();
        populateSelects();
        renderAdminLists();
        toast('≈ûube silindi', 'success');
    }, 'danger');
}

// ========== POSITIONS ==========
function addPosition() {
    showModal('Pozisyon Ekle', `
        <div class="form-grid">
            <div class="form-group"><label class="form-label">ID</label><input type="text" id="newPosId" class="form-input" placeholder="ornek_pozisyon"></div>
            <div class="form-group"><label class="form-label">Ad</label><input type="text" id="newPosName" class="form-input" placeholder="√ñrnek Pozisyon"></div>
            <div class="form-group full"><label class="form-label">Yaka Tipi</label>
                <select id="newPosType" class="form-select">
                    <option>Mavi Yaka</option><option>Gri Yaka</option><option>Beyaz Yaka</option><option>Stratejik</option>
                </select>
            </div>
        </div>
    `, `
        <button class="btn btn-ghost" onclick="closeModal()">ƒ∞ptal</button>
        <button class="btn btn-primary" onclick="savePosition()">Ekle</button>
    `);
}

function savePosition() {
    const id = getVal('newPosId');
    const name = getVal('newPosName');
    const type = getVal('newPosType');
    if (id && name) {
        STATE.positions.push({id, name, type});
        if (!STATE.templates[id]) STATE.templates[id] = '';
        saveState();
        populateSelects();
        renderPositionCards();
        renderAdminLists();
        closeModal();
        toast('Pozisyon eklendi', 'success');
    }
}

function editPosition(i) {
    const p = STATE.positions[i];
    showModal('Pozisyon D√ºzenle', `
        <div class="form-grid">
            <div class="form-group"><label class="form-label">ID</label><input type="text" id="editPosId" class="form-input" value="${p.id}"></div>
            <div class="form-group"><label class="form-label">Ad</label><input type="text" id="editPosName" class="form-input" value="${p.name}"></div>
            <div class="form-group full"><label class="form-label">Yaka Tipi</label>
                <select id="editPosType" class="form-select">
                    <option ${p.type==='Mavi Yaka'?'selected':''}>Mavi Yaka</option>
                    <option ${p.type==='Gri Yaka'?'selected':''}>Gri Yaka</option>
                    <option ${p.type==='Beyaz Yaka'?'selected':''}>Beyaz Yaka</option>
                    <option ${p.type==='Stratejik'?'selected':''}>Stratejik</option>
                </select>
            </div>
        </div>
    `, `
        <button class="btn btn-ghost" onclick="closeModal()">ƒ∞ptal</button>
        <button class="btn btn-primary" onclick="updatePosition(${i})">Kaydet</button>
    `);
}

function updatePosition(i) {
    const oldId = STATE.positions[i].id;
    const newId = getVal('editPosId');
    STATE.positions[i] = {
        id: newId,
        name: getVal('editPosName'),
        type: getVal('editPosType')
    };
    if (oldId !== newId && STATE.templates[oldId]) {
        STATE.templates[newId] = STATE.templates[oldId];
        delete STATE.templates[oldId];
    }
    saveState();
    populateSelects();
    renderPositionCards();
    renderAdminLists();
    closeModal();
    toast('G√ºncellendi', 'success');
}

function deletePosition(i) {
    confirmModal('Pozisyon Sil', `"${STATE.positions[i].name}" pozisyonunu silmek istediƒüinize emin misiniz?`, () => {
        const id = STATE.positions[i].id;
        STATE.positions.splice(i, 1);
        delete STATE.templates[id];
        saveState();
        populateSelects();
        renderPositionCards();
        renderAdminLists();
        toast('Pozisyon silindi', 'success');
    }, 'danger');
}

// ========== VIOLATIONS ==========
function addViolation() {
    showModal('ƒ∞hlal Ekle', `
        <div class="form-grid">
            <div class="form-group"><label class="form-label">Kod</label><input type="text" id="newViolId" class="form-input" placeholder="V19"></div>
            <div class="form-group"><label class="form-label">Ba≈ülƒ±k</label><input type="text" id="newViolTitle" class="form-input"></div>
            <div class="form-group"><label class="form-label">Risk</label>
                <select id="newViolRisk" class="form-select"><option value="low">D√º≈ü√ºk</option><option value="medium">Orta</option><option value="high">Y√ºksek</option></select>
            </div>
            <div class="form-group"><label class="form-label">Yasal Dayanak</label><input type="text" id="newViolLegal" class="form-input" placeholder="ƒ∞≈ü K. 25/II-x"></div>
            <div class="form-group full"><label class="form-label">A√ßƒ±klama</label><input type="text" id="newViolDesc" class="form-input"></div>
            <div class="form-group full"><label class="form-label">Prosed√ºr Adƒ±mlarƒ± (virg√ºlle ayƒ±rƒ±n)</label><input type="text" id="newViolSteps" class="form-input" placeholder="Tutanak,Savunma,ƒ∞htar"></div>
        </div>
    `, `
        <button class="btn btn-ghost" onclick="closeModal()">ƒ∞ptal</button>
        <button class="btn btn-primary" onclick="saveViolation()">Ekle</button>
    `);
}

function saveViolation() {
    const v = {
        id: getVal('newViolId'),
        title: getVal('newViolTitle'),
        risk: getVal('newViolRisk'),
        legal: getVal('newViolLegal'),
        desc: getVal('newViolDesc'),
        steps: getVal('newViolSteps').split(',').map(s => s.trim()).filter(s => s)
    };
    if (v.id && v.title) {
        STATE.violations.push(v);
        saveState();
        renderViolations();
        renderAdminLists();
        closeModal();
        toast('ƒ∞hlal eklendi', 'success');
    }
}

function editViolation(i) {
    const v = STATE.violations[i];
    showModal('ƒ∞hlal D√ºzenle', `
        <div class="form-grid">
            <div class="form-group"><label class="form-label">Kod</label><input type="text" id="editViolId" class="form-input" value="${v.id}"></div>
            <div class="form-group"><label class="form-label">Ba≈ülƒ±k</label><input type="text" id="editViolTitle" class="form-input" value="${v.title}"></div>
            <div class="form-group"><label class="form-label">Risk</label>
                <select id="editViolRisk" class="form-select">
                    <option value="low" ${v.risk==='low'?'selected':''}>D√º≈ü√ºk</option>
                    <option value="medium" ${v.risk==='medium'?'selected':''}>Orta</option>
                    <option value="high" ${v.risk==='high'?'selected':''}>Y√ºksek</option>
                </select>
            </div>
            <div class="form-group"><label class="form-label">Yasal Dayanak</label><input type="text" id="editViolLegal" class="form-input" value="${v.legal}"></div>
            <div class="form-group full"><label class="form-label">A√ßƒ±klama</label><input type="text" id="editViolDesc" class="form-input" value="${v.desc}"></div>
            <div class="form-group full"><label class="form-label">Prosed√ºr Adƒ±mlarƒ±</label><input type="text" id="editViolSteps" class="form-input" value="${v.steps.join(', ')}"></div>
        </div>
    `, `
        <button class="btn btn-ghost" onclick="closeModal()">ƒ∞ptal</button>
        <button class="btn btn-primary" onclick="updateViolation(${i})">Kaydet</button>
    `);
}

function updateViolation(i) {
    STATE.violations[i] = {
        id: getVal('editViolId'),
        title: getVal('editViolTitle'),
        risk: getVal('editViolRisk'),
        legal: getVal('editViolLegal'),
        desc: getVal('editViolDesc'),
        steps: getVal('editViolSteps').split(',').map(s => s.trim()).filter(s => s)
    };
    saveState();
    renderViolations();
    renderAdminLists();
    closeModal();
    toast('G√ºncellendi', 'success');
}

function deleteViolation(i) {
    confirmModal('ƒ∞hlal Sil', `"${STATE.violations[i].title}" ihlalini silmek istediƒüinize emin misiniz?`, () => {
        STATE.violations.splice(i, 1);
        saveState();
        renderViolations();
        renderAdminLists();
        toast('ƒ∞hlal silindi', 'success');
    }, 'danger');
}

// ========== TEMPLATES ==========
function loadTemplate() {
    const sel = document.getElementById('template_pozisyon');
    const content = document.getElementById('template_content');
    if (sel && content) {
        const posId = sel.value;
        content.value = STATE.templates[posId] || '';
    }
}

function saveTemplate() {
    const posId = document.getElementById('template_pozisyon').value;
    const content = document.getElementById('template_content').value;
    STATE.templates[posId] = content;
    saveState();
    toast('≈ûablon kaydedildi', 'success');
}

// ========== SYNC ==========
function generateExportCode() {
    try {
        const json = JSON.stringify(STATE);
        const compressed = LZString.compressToBase64(json);
        document.getElementById('exportCode').value = compressed;
        toast('Kod olu≈üturuldu', 'success');
    } catch(e) {
        toast('Kod olu≈üturulamadƒ±', 'error');
    }
}

function copyExportCode() {
    const code = document.getElementById('exportCode').value;
    if (code) {
        navigator.clipboard.writeText(code).then(() => {
            toast('Kopyalandƒ±!', 'success');
        }).catch(() => {
            // Fallback
            const ta = document.createElement('textarea');
            ta.value = code;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
            toast('Kopyalandƒ±!', 'success');
        });
    }
}

function importCode() {
    const code = document.getElementById('importCode').value.trim();
    if (!code) {
        toast('Kod bo≈ü', 'error');
        return;
    }
    
    confirmModal('ƒ∞√ße Aktar', 'Mevcut t√ºm ayarlarƒ±nƒ±z deƒüi≈ütirilecek. Emin misiniz?', () => {
        try {
            const json = LZString.decompressFromBase64(code);
            if (!json) throw new Error('Invalid');
            const data = JSON.parse(json);
            
            // Validate basic structure
            if (!data.pin || !data.company || !data.branches) {
                throw new Error('Invalid structure');
            }
            
            STATE = {...CONFIG, ...data};
            saveState();
            initUI();
            document.getElementById('importCode').value = '';
            successModal('Veriler ba≈üarƒ±yla i√ße aktarƒ±ldƒ±!');
        } catch(e) {
            toast('Ge√ßersiz kod!', 'error');
        }
    }, 'danger');
}

// ========== DOSYA YEDEKLEMESƒ∞ ==========
function downloadBackup() {
    try {
        const data = JSON.stringify(STATE, null, 2);
        const blob = new Blob([data], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const date = new Date().toISOString().split('T')[0];
        a.href = url;
        a.download = `moonberry-ik-yedek-${date}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        toast('Yedek dosyasƒ± indirildi', 'success');
    } catch(e) {
        toast('Yedek olu≈üturulamadƒ±', 'error');
    }
}

function uploadBackup(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!file.name.endsWith('.json')) {
        toast('Sadece .json dosyasƒ± y√ºkleyebilirsiniz', 'error');
        return;
    }
    
    confirmModal('Yedek Y√ºkle', `"${file.name}" dosyasƒ±nƒ± y√ºklemek istediƒüinize emin misiniz? Mevcut t√ºm ayarlarƒ±nƒ±z deƒüi≈ütirilecek.`, () => {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                
                // Validate basic structure
                if (!data.pin || !data.company || !data.branches) {
                    throw new Error('Invalid structure');
                }
                
                STATE = {...CONFIG, ...data};
                saveState();
                initUI();
                successModal('Yedek ba≈üarƒ±yla y√ºklendi!');
            } catch(err) {
                toast('Ge√ßersiz yedek dosyasƒ±!', 'error');
            }
        };
        reader.onerror = () => toast('Dosya okunamadƒ±', 'error');
        reader.readAsText(file);
    }, 'danger');
    
    // Reset input
    event.target.value = '';
}

// Drag & Drop desteƒüi
document.addEventListener('DOMContentLoaded', () => {
    const dropZone = document.getElementById('dropZone');
    if (dropZone) {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
        });
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.style.borderColor = 'var(--green)';
                dropZone.style.background = 'var(--bg)';
            });
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.style.borderColor = 'var(--accent)';
                dropZone.style.background = '';
            });
        });
        
        dropZone.addEventListener('drop', (e) => {
            const file = e.dataTransfer.files[0];
            if (file) {
                document.getElementById('backupFileInput').files = e.dataTransfer.files;
                uploadBackup({target: {files: [file], value: ''}});
            }
        });
    }
});

// ========== BELGE ≈ûABLONLARI ==========
let currentDocTemplateCategory = 'tutanak';
let currentDocTemplateSubType = 'olay';
let originalDocTemplateContent = '';
let hasUnsavedDocChanges = false;

function selectDocTemplateCategory(category) {
    // Kaydedilmemi≈ü deƒüi≈üiklik kontrol√º
    if (hasUnsavedDocChanges) {
        showUnsavedChangesModal(() => {
            saveDocTemplate();
            switchDocTemplateCategory(category);
        }, () => {
            hasUnsavedDocChanges = false;
            switchDocTemplateCategory(category);
        });
        return;
    }
    switchDocTemplateCategory(category);
}

function switchDocTemplateCategory(category) {
    currentDocTemplateCategory = category;
    
    // Butonlarƒ± g√ºncelle
    document.querySelectorAll('#admin-belgeler .btn-group .btn').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-ghost');
    });
    event.target.classList.remove('btn-ghost');
    event.target.classList.add('btn-primary');
    
    // Panelleri gizle/g√∂ster
    document.querySelectorAll('.doc-template-panel').forEach(p => p.style.display = 'none');
    const panel = document.getElementById('docTemplate-' + category);
    if (panel) panel.style.display = 'block';
    
    // Alt t√ºr√º belirle
    if (category === 'tutanak') {
        currentDocTemplateSubType = document.getElementById('tutanak_sub_type')?.value || 'olay';
    } else if (category === 'fesih') {
        currentDocTemplateSubType = document.getElementById('fesih_sub_type')?.value || 'hakli';
    } else {
        currentDocTemplateSubType = null;
    }
    
    loadDocTemplate(category, currentDocTemplateSubType);
}

function loadDocTemplate(category, subType) {
    currentDocTemplateCategory = category;
    currentDocTemplateSubType = subType;
    
    let template = '';
    const templates = STATE.documentTemplates || CONFIG.documentTemplates;
    
    if (subType && templates[category] && typeof templates[category] === 'object') {
        template = templates[category][subType] || CONFIG.documentTemplates[category][subType] || '';
    } else {
        template = templates[category] || CONFIG.documentTemplates[category] || '';
    }
    
    const textarea = document.getElementById('doc_template_content');
    if (textarea) {
        textarea.value = template;
        originalDocTemplateContent = template;
        hasUnsavedDocChanges = false;
        updateUnsavedIndicator();
    }
}

function trackDocTemplateChanges() {
    const textarea = document.getElementById('doc_template_content');
    if (textarea) {
        hasUnsavedDocChanges = textarea.value !== originalDocTemplateContent;
        updateUnsavedIndicator();
    }
}

function updateUnsavedIndicator() {
    const indicator = document.getElementById('docTemplateUnsaved');
    if (indicator) {
        indicator.style.display = hasUnsavedDocChanges ? 'block' : 'none';
    }
}

function saveDocTemplate() {
    const textarea = document.getElementById('doc_template_content');
    if (!textarea) return;
    
    const content = textarea.value;
    
    // documentTemplates yoksa olu≈ütur
    if (!STATE.documentTemplates) {
        STATE.documentTemplates = JSON.parse(JSON.stringify(CONFIG.documentTemplates));
    }
    
    if (currentDocTemplateSubType && typeof STATE.documentTemplates[currentDocTemplateCategory] === 'object') {
        STATE.documentTemplates[currentDocTemplateCategory][currentDocTemplateSubType] = content;
    } else {
        STATE.documentTemplates[currentDocTemplateCategory] = content;
    }
    
    saveState();
    originalDocTemplateContent = content;
    hasUnsavedDocChanges = false;
    updateUnsavedIndicator();
    toast('≈ûablon kaydedildi', 'success');
}

function resetDocTemplate() {
    confirmModal('Varsayƒ±lana D√∂n', 'Bu ≈üablonu varsayƒ±lan haline d√∂nd√ºrmek istediƒüinize emin misiniz?', () => {
        let defaultTemplate = '';
        
        if (currentDocTemplateSubType && typeof CONFIG.documentTemplates[currentDocTemplateCategory] === 'object') {
            defaultTemplate = CONFIG.documentTemplates[currentDocTemplateCategory][currentDocTemplateSubType];
        } else {
            defaultTemplate = CONFIG.documentTemplates[currentDocTemplateCategory];
        }
        
        const textarea = document.getElementById('doc_template_content');
        if (textarea) {
            textarea.value = defaultTemplate;
            
            // STATE'i de g√ºncelle
            if (!STATE.documentTemplates) {
                STATE.documentTemplates = JSON.parse(JSON.stringify(CONFIG.documentTemplates));
            }
            
            if (currentDocTemplateSubType && typeof STATE.documentTemplates[currentDocTemplateCategory] === 'object') {
                STATE.documentTemplates[currentDocTemplateCategory][currentDocTemplateSubType] = defaultTemplate;
            } else {
                STATE.documentTemplates[currentDocTemplateCategory] = defaultTemplate;
            }
            
            saveState();
            originalDocTemplateContent = defaultTemplate;
            hasUnsavedDocChanges = false;
            updateUnsavedIndicator();
            toast('Varsayƒ±lana d√∂nd√ºr√ºld√º', 'success');
        }
    }, 'warning');
}

function previewDocTemplate() {
    const content = document.getElementById('doc_template_content')?.value || '';
    
    // √ñrnek verilerle doldur
    const preview = content
        .replace(/\{\{PERSONEL\}\}/g, '√ñrnek Personel')
        .replace(/\{\{TC\}\}/g, '12345678901')
        .replace(/\{\{SUBE\}\}/g, '≈ûi≈üli (Merkez)')
        .replace(/\{\{TARIH\}\}/g, today())
        .replace(/\{\{SAAT\}\}/g, nowTime())
        .replace(/\{\{ACIKLAMA\}\}/g, '√ñrnek a√ßƒ±klama metni burada g√∂r√ºnecektir.')
        .replace(/\{\{DAYANAK\}\}/g, '25/II-e')
        .replace(/\{\{SURE\}\}/g, '1 i≈ü g√ºn√º')
        .replace(/\{\{POZISYON\}\}/g, 'Barista')
        .replace(/\{\{TUTAR\}\}/g, '500')
        .replace(/\{\{ODEME_SEKLI\}\}/g, 'maa≈ütan tek seferde mahsup edilmesini')
        .replace(/\{\{IHBAR_SURE\}\}/g, '4 hafta')
        .replace(/\{\{SON_GUN\}\}/g, today())
        .replace(/\{\{BASLAMA\}\}/g, today());
    
    const categoryTitles = {
        tutanak: {olay: 'OLAY TESPƒ∞T TUTANAƒûI', devamsizlik: 'DEVAMSIZLIK TUTANAƒûI', kasa: 'KASA A√áIƒûI TUTANAƒûI', imza: 'ƒ∞MZADAN ƒ∞MTƒ∞NA TUTANAƒûI'},
        savunma: 'SAVUNMA ƒ∞STEME YAZISI',
        fesih: {hakli: 'HAKLI FESƒ∞H Bƒ∞LDƒ∞Rƒ∞Mƒ∞', gecerli: 'GE√áERLƒ∞ FESƒ∞H Bƒ∞LDƒ∞Rƒ∞Mƒ∞', deneme: 'DENEME S√úRESƒ∞ FESHƒ∞'},
        borc: 'BOR√á ƒ∞KRAR VE MAHSUP MUVAFAKATNAMESƒ∞'
    };
    
    let title = '';
    if (currentDocTemplateSubType && typeof categoryTitles[currentDocTemplateCategory] === 'object') {
        title = categoryTitles[currentDocTemplateCategory][currentDocTemplateSubType];
    } else {
        title = categoryTitles[currentDocTemplateCategory];
    }
    
    const html = `<div class="doc">
        ${docHeader(title)}
        <div class="doc-section">${preview}</div>
        ${docSignature(
            {title: 'ƒ∞≈ûVEREN', name: '(KA≈ûE)', role: 'ƒ∞mza'},
            {title: 'PERSONEL', name: '√ñrnek Personel', role: 'ƒ∞mza'}
        )}
    </div>`;
    
    showPreview('≈ûablon √ñnizleme - ' + title, html);
}

function showUnsavedChangesModal(onSave, onDiscard) {
    openModal('Kaydedilmemi≈ü Deƒüi≈üiklikler', `
        <div class="modal-icon warning">‚ö†Ô∏è</div>
        <p class="modal-message">≈ûablonda kaydedilmemi≈ü deƒüi≈üiklikler var.<br>Ne yapmak istersiniz?</p>
    `, `
        <button class="btn btn-ghost" onclick="closeModal()">ƒ∞ptal</button>
        <button class="btn" style="background:var(--red);color:#fff" onclick="closeModal();(${onDiscard.toString()})()">Kaydetme</button>
        <button class="btn btn-primary" onclick="closeModal();(${onSave.toString()})()">Kaydet</button>
    `);
}

// Sayfa deƒüi≈ütirirken kontrol
const originalGoTo = goTo;
goTo = function(page) {
    if (hasUnsavedDocChanges && currentPage === 'admin') {
        showUnsavedChangesModal(() => {
            saveDocTemplate();
            hasUnsavedDocChanges = false;
            originalGoTo(page);
        }, () => {
            hasUnsavedDocChanges = false;
            originalGoTo(page);
        });
        return;
    }
    originalGoTo(page);
};

// Tarayƒ±cƒ± kapatma/yenileme korumasƒ±
window.addEventListener('beforeunload', (e) => {
    // Tarayƒ±cƒ± kapatƒ±lƒ±nca √ßƒ±kƒ±≈ü yap ayarƒ± aktifse oturumu sonlandƒ±r
    const logoutOnClose = document.getElementById('sessionLogoutOnClose')?.checked;
    if (logoutOnClose && currentUser?.sessionId) {
        // Senkron olarak oturumu sonlandƒ±rmaya √ßalƒ±≈ü (best effort)
        navigator.sendBeacon && navigator.sendBeacon('/api/end-session', JSON.stringify({ sessionId: currentUser.sessionId }));
    }
    
    if (hasUnsavedDocChanges) {
        e.preventDefault();
        e.returnValue = 'Kaydedilmemi≈ü deƒüi≈üiklikler var. Sayfadan ayrƒ±lmak istediƒüinize emin misiniz?';
        return e.returnValue;
    }
});

// Visibility change - sayfa gizlendiƒüinde aktiviteyi duraklat
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible' && currentUser?.sessionId) {
        // Sayfa tekrar g√∂r√ºn√ºr olduƒüunda aktiviteyi g√ºncelle
        updateSessionActivity();
    }
});

// ==================== PERSONEL Y√ñNETƒ∞Mƒ∞ ====================
async function loadPersonelList() {
    const container = document.getElementById('personelListContainer');
    if (!container) return;
    
    container.innerHTML = '<p style="color:var(--tx2);text-align:center;padding:20px">Y√ºkleniyor...</p>';
    
    try {
        const snapshot = await db.collection('personel').orderBy('name').get();
        
        if (snapshot.empty) {
            container.innerHTML = '<p style="color:var(--tx2);text-align:center;padding:40px">Hen√ºz personel kaydƒ± yok. "Yeni Personel" butonuna tƒ±klayarak ekleyin.</p>';
            return;
        }
        
        let html = '<div class="admin-list">';
        snapshot.forEach(doc => {
            const p = doc.data();
            html += `
                <div class="admin-list-item" style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg3);border-radius:var(--radiusSm);margin-bottom:8px">
                    <div>
                        <strong style="color:var(--tx)">${p.name}</strong>
                        <div style="font-size:.8rem;color:var(--tx2)">${p.position || '-'} ‚Ä¢ ${p.branch || '-'}</div>
                        <div style="font-size:.75rem;color:var(--tx3)">TC: ${p.tc || '-'} | Tel: ${p.phone || '-'}</div>
                    </div>
                    <div style="display:flex;gap:8px">
                        <button class="btn btn-sm btn-ghost" onclick="editPersonel('${doc.id}')">‚úèÔ∏è</button>
                        <button class="btn btn-sm" style="background:var(--red);color:#fff" onclick="deletePersonel('${doc.id}')">üóëÔ∏è</button>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        container.innerHTML = html;
    } catch (error) {
        console.error('Personel y√ºkleme hatasƒ±:', error);
        container.innerHTML = '<p style="color:var(--red);text-align:center;padding:20px">Y√ºkleme hatasƒ±!</p>';
    }
}

function showAddPersonelModal(editId = null) {
    const isEdit = !!editId;
    const title = isEdit ? 'Personel D√ºzenle' : 'Yeni Personel Ekle';
    
    // Br√ºt √ºcret sadece y√∂netici ve b√∂lge m√ºd√ºr√º g√∂rebilir
    const canSeeSalary = currentUser?.role === 'yonetici' || currentUser?.role === 'bolge_muduru';
    const salaryField = canSeeSalary 
        ? `<div class="form-group"><label class="form-label">Br√ºt √úcret (TL)</label><input type="number" id="personelSalary" class="form-input"></div>`
        : `<input type="hidden" id="personelSalary" value="">`;
    
    const body = `
        <input type="hidden" id="personelEditId" value="${editId || ''}">
        <div class="form-grid">
            <div class="form-group"><label class="form-label">Ad Soyad *</label><input type="text" id="personelName" class="form-input" required></div>
            <div class="form-group"><label class="form-label">Shift Kod Adƒ±</label><input type="text" id="personelCodeName" class="form-input" placeholder="√ñrn: Esin ƒ∞."><small style="color:var(--tx2);font-size:.7rem">Bo≈ü bƒ±rakƒ±lƒ±rsa Ad S. formatƒ± kullanƒ±lƒ±r</small></div>
            <div class="form-group"><label class="form-label">T.C. Kimlik No *</label><input type="text" id="personelTC" class="form-input" maxlength="11"></div>
            <div class="form-group"><label class="form-label">Telefon</label><input type="tel" id="personelPhone" class="form-input"></div>
            <div class="form-group"><label class="form-label">E-posta</label><input type="email" id="personelEmail" class="form-input"></div>
            <div class="form-group full"><label class="form-label">Adres</label><input type="text" id="personelAddress" class="form-input"></div>
            <div class="form-group"><label class="form-label">IBAN</label><input type="text" id="personelIBAN" class="form-input"></div>
            <div class="form-group"><label class="form-label">≈ûube</label><select id="personelBranch" class="form-select">${STATE.branches.map(b => `<option value="${b}">${b}</option>`).join('')}</select></div>
            <div class="form-group"><label class="form-label">Pozisyon</label><select id="personelPosition" class="form-select">${STATE.positions.map(p => `<option value="${p.name}">${p.name}</option>`).join('')}</select></div>
            <div class="form-group"><label class="form-label">ƒ∞≈üe Ba≈ülama</label><input type="date" id="personelStartDate" class="form-input"></div>
            ${salaryField}
        </div>
    `;
    
    const footer = `
        <button class="btn btn-ghost" onclick="closeModal()">ƒ∞ptal</button>
        <button class="btn btn-primary" onclick="savePersonel()">üíæ Kaydet</button>
    `;
    
    showModal(title, body, footer);
    
    if (isEdit) {
        loadPersonelForEdit(editId);
    }
}

async function loadPersonelForEdit(id) {
    try {
        const doc = await db.collection('personel').doc(id).get();
        if (doc.exists) {
            const p = doc.data();
            document.getElementById('personelName').value = p.name || '';
            document.getElementById('personelCodeName').value = p.codeName || '';
            document.getElementById('personelTC').value = p.tc || '';
            document.getElementById('personelPhone').value = p.phone || '';
            document.getElementById('personelEmail').value = p.email || '';
            document.getElementById('personelAddress').value = p.address || '';
            document.getElementById('personelIBAN').value = p.iban || '';
            document.getElementById('personelBranch').value = p.branch || '';
            document.getElementById('personelPosition').value = p.position || '';
            document.getElementById('personelStartDate').value = p.startDate || '';
            document.getElementById('personelSalary').value = p.salary || '';
        }
    } catch (error) {
        console.error('Personel y√ºkleme hatasƒ±:', error);
    }
}

async function savePersonel() {
    const editId = document.getElementById('personelEditId').value;
    const name = document.getElementById('personelName').value.trim();
    const tc = document.getElementById('personelTC').value.trim();
    let codeName = document.getElementById('personelCodeName').value.trim();
    
    if (!name) {
        toast('Ad soyad zorunludur', 'error');
        return;
    }
    
    // Kod adƒ± bo≈üsa otomatik olu≈ütur: "Ad S."
    if (!codeName) {
        const parts = name.split(' ');
        if (parts.length >= 2) {
            codeName = parts[0] + ' ' + parts[parts.length - 1].charAt(0) + '.';
        } else {
            codeName = name;
        }
    }
    
    const data = {
        name,
        codeName,
        tc,
        phone: document.getElementById('personelPhone').value.trim(),
        email: document.getElementById('personelEmail').value.trim(),
        address: document.getElementById('personelAddress').value.trim(),
        iban: document.getElementById('personelIBAN').value.trim(),
        branch: document.getElementById('personelBranch').value,
        position: document.getElementById('personelPosition').value,
        startDate: document.getElementById('personelStartDate').value,
        salary: document.getElementById('personelSalary').value,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedBy: currentUser?.username || 'admin'
    };
    
    try {
        if (editId) {
            await db.collection('personel').doc(editId).update(data);
            toast('Personel g√ºncellendi', 'success');
        } else {
            data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            await db.collection('personel').add(data);
            toast('Personel eklendi', 'success');
        }
        closeModal();
        loadPersonelList();
    } catch (error) {
        console.error('Kayƒ±t hatasƒ±:', error);
        toast('Kayƒ±t hatasƒ±!', 'error');
    }
}

function editPersonel(id) {
    showAddPersonelModal(id);
}

async function deletePersonel(id) {
    confirmModal('Personel Sil', 'Bu personeli silmek istediƒüinize emin misiniz?', async () => {
        try {
            await db.collection('personel').doc(id).delete();
            toast('Personel silindi', 'success');
            loadPersonelList();
        } catch (error) {
            console.error('Silme hatasƒ±:', error);
            toast('Silme hatasƒ±!', 'error');
        }
    });
}

function filterPersonel() {
    const search = document.getElementById('personelSearch').value.toLowerCase();
    const items = document.querySelectorAll('#personelListContainer .admin-list-item');
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(search) ? 'flex' : 'none';
    });
}

// ==================== PUANTAJ Sƒ∞STEMƒ∞ ====================
let puantajRulesCache = [];

async function loadPuantajRules() {
    try {
        const snapshot = await db.collection('puantajRules').get();
        puantajRulesCache = [];
        snapshot.forEach(doc => {
            puantajRulesCache.push({ id: doc.id, ...doc.data() });
        });
    } catch (e) {
        console.error('Kural y√ºkleme hatasƒ±:', e);
    }
}

async function loadPuantaj() {
    const container = document.getElementById('puantajTableContainer');
    if (!container) return;
    
    const ay = document.getElementById('puantajAy').value;
    const yil = document.getElementById('puantajYil').value;
    const sube = document.getElementById('puantajSube').value;
    
    // Barista kontrol√º
    const isBarista = currentUser?.role === 'barista';
    
    container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--tx2)">Y√ºkleniyor...</div>';
    
    // Kurallarƒ± y√ºkle
    await loadPuantajRules();
    
    try {
        const personelSnapshot = await db.collection('personel').where('branch', '==', sube).get();
        
        if (personelSnapshot.empty) {
            container.innerHTML = '<div style="text-align:center;padding:60px;color:var(--tx2)"><div style="font-size:3rem;margin-bottom:16px;opacity:.5">üë•</div>Bu ≈üubede kayƒ±tlƒ± personel yok.</div>';
            return;
        }
        
        const puantajKey = `${yil}-${ay}`;
        const puantajSnapshot = await db.collection('puantaj').where('period', '==', puantajKey).where('branch', '==', sube).get();
        
        const puantajData = {};
        puantajSnapshot.forEach(doc => {
            const d = doc.data();
            if (!puantajData[d.personelId]) puantajData[d.personelId] = [];
            puantajData[d.personelId].push({ id: doc.id, ...d });
        });
        
        let html = '';
        const personelList = [];
        
        personelSnapshot.forEach(doc => {
            const p = doc.data();
            const puanlar = puantajData[doc.id] || [];
            const kayitSayisi = puanlar.length;
            
            // Yeni puan hesaplama: 1-3 yƒ±ldƒ±z negatif, 4-5 yƒ±ldƒ±z pozitif
            let toplamPuan = 0;
            let negatifOlay = 0;
            let pozitifOlay = 0;
            
            puanlar.forEach(x => {
                const yildiz = x.score || 3;
                if (yildiz === 1) {
                    toplamPuan -= 3; // 1 yƒ±ldƒ±z = -3 puan (Ciddi ƒ∞hlal)
                    negatifOlay++;
                } else if (yildiz === 2) {
                    toplamPuan -= 2; // 2 yƒ±ldƒ±z = -2 puan (Orta ƒ∞hlal)
                    negatifOlay++;
                } else if (yildiz === 3) {
                    toplamPuan -= 1; // 3 yƒ±ldƒ±z = -1 puan (Hafif Uyarƒ±)
                    negatifOlay++;
                } else if (yildiz === 4) {
                    toplamPuan += 1; // 4 yƒ±ldƒ±z = +1 puan (ƒ∞yi Performans)
                    pozitifOlay++;
                } else if (yildiz === 5) {
                    toplamPuan += 2; // 5 yƒ±ldƒ±z = +2 puan (M√ºkemmel)
                    pozitifOlay++;
                }
            });
            
            const primDurumu = toplamPuan <= -5 ? 'prim_yok' : 'prim_var';
            
            personelList.push({ 
                id: doc.id, 
                name: p.name, 
                tc: p.tc, 
                position: p.position, 
                toplamPuan,
                primDurumu, 
                kayitSayisi, 
                negatifOlay,
                pozitifOlay,
                puanlar 
            });
        });
        
        // Puantaj cache'e personel listesini kaydet
        window.puantajPersonelCache = personelList;
        
        // Personel Kartlarƒ±
        html += `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:20px;margin-bottom:28px">`;
        personelList.forEach(p => {
            const statusColor = p.primDurumu === 'prim_yok' ? '#e74c3c' : '#27ae60';
            const statusBg = p.primDurumu === 'prim_yok' ? 'rgba(231,76,60,.12)' : 'rgba(39,174,96,.12)';
            const puanColor = p.toplamPuan < 0 ? '#e74c3c' : (p.toplamPuan > 0 ? '#27ae60' : 'var(--tx)');
            const puanSign = p.toplamPuan > 0 ? '+' : '';
            const cardBorder = p.primDurumu === 'prim_yok' ? 'rgba(231,76,60,.3)' : 'var(--cardBorder)';
            
            html += `
                <div class="puantaj-card" style="background:var(--cardBg);border:2px solid ${cardBorder};border-radius:20px;padding:24px;transition:all .3s;box-shadow:0 4px 20px rgba(0,0,0,.08)">
                    <!-- Header -->
                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:20px">
                        <div style="display:flex;align-items:center;gap:14px">
                            <div style="width:48px;height:48px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;color:#fff;font-weight:700">
                                ${p.name.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div style="font-weight:700;font-size:1.15rem;color:var(--tx);margin-bottom:2px">${p.name}</div>
                                <div style="font-size:.85rem;color:var(--tx2)">${p.position || 'Personel'}</div>
                            </div>
                        </div>
                        <div style="background:${statusBg};color:${statusColor};padding:8px 14px;border-radius:24px;font-size:.8rem;font-weight:700;border:1px solid ${statusColor}20">
                            ${p.primDurumu === 'prim_yok' ? '‚ö†Ô∏è PRƒ∞M YOK' : '‚úÖ Aktif'}
                        </div>
                    </div>
                    
                    <!-- Stats -->
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:18px">
                        <div style="background:linear-gradient(135deg,var(--bg3),var(--bg4));border-radius:14px;padding:16px 12px;text-align:center">
                            <div style="font-size:2rem;font-weight:800;color:${puanColor};line-height:1">${puanSign}${p.toplamPuan}</div>
                            <div style="font-size:.75rem;color:var(--tx2);margin-top:4px;font-weight:500">PUAN</div>
                        </div>
                        <div style="background:rgba(231,76,60,.08);border-radius:14px;padding:16px 12px;text-align:center;border:1px solid rgba(231,76,60,.15)">
                            <div style="font-size:2rem;font-weight:800;color:#e74c3c;line-height:1">${p.negatifOlay}</div>
                            <div style="font-size:.75rem;color:#c0392b;margin-top:4px;font-weight:500">ƒ∞HLAL</div>
                        </div>
                        <div style="background:rgba(39,174,96,.08);border-radius:14px;padding:16px 12px;text-align:center;border:1px solid rgba(39,174,96,.15)">
                            <div style="font-size:2rem;font-weight:800;color:#27ae60;line-height:1">${p.pozitifOlay}</div>
                            <div style="font-size:.75rem;color:#1e8449;margin-top:4px;font-weight:500">BA≈ûARI</div>
                        </div>
                    </div>
                    
                    ${p.toplamPuan <= -5 ? `
                        <div style="background:linear-gradient(135deg,rgba(231,76,60,.15),rgba(192,57,43,.15));border:1px solid rgba(231,76,60,.4);border-radius:12px;padding:12px;margin-bottom:14px;text-align:center">
                            <div style="color:#c0392b;font-weight:700;font-size:.9rem">üö® Prim Hakkƒ± Kaybedildi!</div>
                            <div style="color:#e74c3c;font-size:.8rem;margin-top:4px">Toplam puan -5 veya altƒ±na d√º≈üt√º</div>
                        </div>
                    ` : ''}
                    
                    <!-- Action Buttons -->
                    ${!isBarista ? `
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                        <button class="btn" style="padding:12px;background:linear-gradient(135deg,rgba(231,76,60,.1),rgba(192,57,43,.1));border:2px solid rgba(231,76,60,.25);color:#c0392b;border-radius:12px;font-weight:600;font-size:.85rem;cursor:pointer;transition:all .2s" onclick="showPuantajModal('${p.id}', '${p.name}', 'negatif')" onmouseover="this.style.background='rgba(231,76,60,.2)';this.style.borderColor='rgba(231,76,60,.4)'" onmouseout="this.style.background='linear-gradient(135deg,rgba(231,76,60,.1),rgba(192,57,43,.1))';this.style.borderColor='rgba(231,76,60,.25)'">
                            ‚ö†Ô∏è ƒ∞hlal Ekle
                        </button>
                        <button class="btn" style="padding:12px;background:linear-gradient(135deg,rgba(39,174,96,.1),rgba(30,132,73,.1));border:2px solid rgba(39,174,96,.25);color:#1e8449;border-radius:12px;font-weight:600;font-size:.85rem;cursor:pointer;transition:all .2s" onclick="showPuantajModal('${p.id}', '${p.name}', 'pozitif')" onmouseover="this.style.background='rgba(39,174,96,.2)';this.style.borderColor='rgba(39,174,96,.4)'" onmouseout="this.style.background='linear-gradient(135deg,rgba(39,174,96,.1),rgba(30,132,73,.1))';this.style.borderColor='rgba(39,174,96,.25)'">
                            üèÜ Ba≈üarƒ± Ekle
                        </button>
                    </div>
                    ` : `
                    <div style="text-align:center;padding:12px;background:var(--bg3);border-radius:12px;font-size:.8rem;color:var(--tx3);border:1px dashed var(--bg4)">
                        üëÅÔ∏è Salt Okunur Mod
                    </div>
                    `}
                </div>
            `;
        });
        html += `</div>`;
        
        // Bu Ay Kayƒ±tlar
        html += `<div style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:16px;padding:20px">`;
        html += `<div style="font-weight:600;margin-bottom:16px;color:var(--tx);font-size:1rem">üìã Bu Ay Kayƒ±tlarƒ±</div>`;
        
        let hasRecords = false;
        personelList.forEach(p => {
            if (p.puanlar && p.puanlar.length > 0) {
                hasRecords = true;
                html += `<div style="margin-bottom:16px">`;
                html += `<div style="font-size:.9rem;font-weight:600;color:var(--tx);margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--cardBorder)">${p.name}</div>`;
                p.puanlar.forEach(puan => {
                    const tarih = puan.createdAt?.toDate?.() ? puan.createdAt.toDate().toLocaleDateString('tr-TR') : '-';
                    const yildiz = puan.score || 3;
                    const stars = '‚≠ê'.repeat(yildiz);
                    const isNegative = yildiz <= 3;
                    // Yeni puan sistemi: 1‚òÖ=-3, 2‚òÖ=-2, 3‚òÖ=-1, 4‚òÖ=+1, 5‚òÖ=+2
                    const puanEtki = yildiz === 1 ? '-3' : (yildiz === 2 ? '-2' : (yildiz === 3 ? '-1' : (yildiz === 5 ? '+2' : '+1')));
                    const bgColor = isNegative ? 'rgba(231,76,60,.08)' : 'rgba(39,174,96,.08)';
                    const borderColor = isNegative ? 'rgba(231,76,60,.2)' : 'rgba(39,174,96,.2)';
                    
                    html += `
                        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:${bgColor};border:1px solid ${borderColor};border-radius:10px;margin-bottom:8px">
                            <div style="display:flex;align-items:center;gap:12px">
                                <span style="font-size:.9rem">${stars}</span>
                                <div>
                                    <div style="color:var(--tx);font-size:.85rem;font-weight:500">${puan.note || '-'}</div>
                                    <div style="color:var(--tx3);font-size:.75rem">${tarih}</div>
                                </div>
                            </div>
                            <div style="display:flex;align-items:center;gap:10px">
                                <span style="font-weight:600;color:${isNegative ? '#e74c3c' : '#27ae60'};font-size:.9rem">${puanEtki}</span>
                                ${!isBarista ? `<button onclick="deletePuantajEntry('${puan.id}')" style="background:rgba(255,107,107,.1);border:none;color:#e74c3c;cursor:pointer;font-size:.75rem;padding:6px 10px;border-radius:6px;transition:all .2s" onmouseover="this.style.background='rgba(255,107,107,.2)'" onmouseout="this.style.background='rgba(255,107,107,.1)'">Sil</button>` : ''}
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
            }
        });
        
        if (!hasRecords) {
            html += `<div style="text-align:center;padding:40px;color:var(--tx3)">Bu ay hen√ºz kayƒ±t eklenmemi≈ü</div>`;
        }
        html += `</div>`;
        
        container.innerHTML = html;
    } catch (error) {
        console.error('Puantaj y√ºkleme hatasƒ±:', error);
        container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--red)">Y√ºkleme hatasƒ±!</div>';
    }
}

function showPuantajModal(personelId, name, type = 'negatif') {
    const isNegative = type === 'negatif';
    const title = isNegative ? `${name} - ƒ∞hlal Kaydet` : `${name} - Ba≈üarƒ± Kaydet`;
    const titleColor = isNegative ? '#e74c3c' : '#27ae60';
    
    // Kural se√ßenekleri (cache'ten)
    const kurallar = (puantajRulesCache || []).filter(r => {
        if (isNegative) return r.effect && r.effect.includes('-');
        return r.effect && !r.effect.includes('-');
    });
    
    let kuralOptions = '<option value="">-- Kural Se√ßin (Opsiyonel) --</option>';
    kurallar.forEach(k => {
        kuralOptions += `<option value="${k.id}" data-title="${k.title}">${k.title}</option>`;
    });
    kuralOptions += '<option value="other">üìù Diƒüer (Manuel Giri≈ü)</option>';
    
    // Yƒ±ldƒ±z se√ßenekleri
    let starOptions = '';
    if (isNegative) {
        starOptions = `
            <div class="star-option" onclick="selectPuantajStar(1, this)" style="padding:14px 8px;background:rgba(192,57,43,.12);border:2px solid transparent;border-radius:12px;cursor:pointer;text-align:center;transition:all .2s">
                <div style="font-size:1.3rem;margin-bottom:4px">‚≠ê</div>
                <div style="font-size:.8rem;color:#c0392b;font-weight:700">Ciddi ƒ∞hlal</div>
                <div style="font-size:.85rem;color:#e74c3c;font-weight:600;margin-top:2px">-3 Puan</div>
            </div>
            <div class="star-option" onclick="selectPuantajStar(2, this)" style="padding:14px 8px;background:rgba(211,84,0,.12);border:2px solid transparent;border-radius:12px;cursor:pointer;text-align:center;transition:all .2s">
                <div style="font-size:1.3rem;margin-bottom:4px">‚≠ê‚≠ê</div>
                <div style="font-size:.8rem;color:#d35400;font-weight:700">Orta ƒ∞hlal</div>
                <div style="font-size:.85rem;color:#e67e22;font-weight:600;margin-top:2px">-2 Puan</div>
            </div>
            <div class="star-option" onclick="selectPuantajStar(3, this)" style="padding:14px 8px;background:rgba(241,196,15,.12);border:2px solid transparent;border-radius:12px;cursor:pointer;text-align:center;transition:all .2s">
                <div style="font-size:1.3rem;margin-bottom:4px">‚≠ê‚≠ê‚≠ê</div>
                <div style="font-size:.8rem;color:#f39c12;font-weight:700">Hafif Uyarƒ±</div>
                <div style="font-size:.85rem;color:#f1c40f;font-weight:600;margin-top:2px">-1 Puan</div>
            </div>
        `;
    } else {
        starOptions = `
            <div class="star-option" onclick="selectPuantajStar(4, this)" style="padding:14px 8px;background:rgba(39,174,96,.12);border:2px solid transparent;border-radius:12px;cursor:pointer;text-align:center;transition:all .2s">
                <div style="font-size:1.3rem;margin-bottom:4px">‚≠ê‚≠ê‚≠ê‚≠ê</div>
                <div style="font-size:.8rem;color:#27ae60;font-weight:700">ƒ∞yi Performans</div>
                <div style="font-size:.85rem;color:#2ecc71;font-weight:600;margin-top:2px">+1 Puan</div>
            </div>
            <div class="star-option" onclick="selectPuantajStar(5, this)" style="padding:14px 8px;background:rgba(46,204,113,.12);border:2px solid transparent;border-radius:12px;cursor:pointer;text-align:center;transition:all .2s">
                <div style="font-size:1.3rem;margin-bottom:4px">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                <div style="font-size:.8rem;color:#2ecc71;font-weight:700">M√ºkemmel</div>
                <div style="font-size:.85rem;color:#27ae60;font-weight:600;margin-top:2px">+2 Puan</div>
            </div>
        `;
    }
    
    const body = `
        <div style="padding:8px 0">
            <div style="text-align:center;margin-bottom:20px">
                <div style="font-size:2.5rem">${isNegative ? '‚ö†Ô∏è' : 'üèÜ'}</div>
                <div style="color:${titleColor};font-weight:700;font-size:1rem;margin-top:6px">${isNegative ? 'ƒ∞hlal/Uyarƒ± Kaydƒ±' : 'Ba≈üarƒ±/√ñd√ºl Kaydƒ±'}</div>
            </div>
            
            <div style="display:grid;grid-template-columns:repeat(${isNegative ? 3 : 2}, 1fr);gap:12px;margin-bottom:20px">
                ${starOptions}
            </div>
            
            <div style="margin-bottom:16px">
                <label style="display:block;font-size:.85rem;color:var(--tx2);margin-bottom:8px;font-weight:500">üìã Kural Se√ß</label>
                <select id="puantajKural" class="form-select" onchange="onPuantajKuralChange()" style="background:var(--bg3);color:var(--tx);border-color:var(--bg4)">
                    ${kuralOptions}
                </select>
            </div>
            
            <div style="margin-bottom:16px">
                <label style="display:block;font-size:.85rem;color:var(--tx2);margin-bottom:8px;font-weight:500">üìù A√ßƒ±klama <span style="color:#e74c3c">*</span></label>
                <textarea id="puantajNote" class="form-input" rows="3" placeholder="${isNegative ? '√ñrn: Check listi yanlƒ±≈ü i≈üaretledi, m√º≈üteriye kaba davrandƒ±...' : '√ñrn: M√ºkemmel temizlik yaptƒ±, ekstra mesai √ßalƒ±≈ütƒ±...'}" style="background:var(--bg3);color:var(--tx);border-color:var(--bg4);resize:vertical;min-height:80px;font-family:inherit"></textarea>
            </div>
            
            <div style="margin-bottom:16px">
                <label style="display:block;font-size:.85rem;color:var(--tx2);margin-bottom:8px;font-weight:500">üìÖ Olay Tarihi</label>
                <input type="date" id="puantajDate" class="form-input" value="${new Date().toISOString().split('T')[0]}" style="background:var(--bg3);color:var(--tx);border-color:var(--bg4)">
            </div>
            
            <input type="hidden" id="puantajPersonelId" value="${personelId}">
            <input type="hidden" id="puantajScore" value="0">
        </div>
    `;
    
    showModal(title, body, `
        <button class="btn btn-ghost" onclick="closeModal()">ƒ∞ptal</button>
        <button class="btn" style="background:${titleColor};color:#fff" onclick="savePuantajFromModal()">Kaydet</button>
    `);
}

// Kural se√ßildiƒüinde a√ßƒ±klamaya otomatik yaz
function onPuantajKuralChange() {
    const kuralSelect = document.getElementById('puantajKural');
    const noteField = document.getElementById('puantajNote');
    const selectedOption = kuralSelect.options[kuralSelect.selectedIndex];
    
    if (kuralSelect.value && kuralSelect.value !== 'other' && selectedOption) {
        const title = selectedOption.dataset.title || selectedOption.text;
        if (title && !noteField.value) {
            noteField.value = title;
        }
    }
}

function selectPuantajStar(value, element) {
    document.getElementById('puantajScore').value = value;
    document.querySelectorAll('.star-option').forEach(el => {
        el.style.borderColor = 'transparent';
        el.style.transform = 'scale(1)';
    });
    if (element) {
        element.style.borderColor = value <= 3 ? '#e74c3c' : '#27ae60';
        element.style.transform = 'scale(1.05)';
    }
}

// Sekme deƒüi≈ütirme
function showPuantajTab(tab, btn) {
    // Sekmeleri gizle
    document.getElementById('puantajKayitTab').style.display = 'none';
    document.getElementById('puantajAnalizTab').style.display = 'none';
    document.getElementById('puantajArsivTab').style.display = 'none';
    
    // Butonlarƒ± g√ºncelle
    document.querySelectorAll('.puantaj-tab').forEach(b => {
        b.style.background = 'var(--bg3)';
        b.style.color = 'var(--tx)';
        b.style.boxShadow = 'none';
    });
    btn.style.background = 'linear-gradient(135deg, var(--accent), #ff6b5b)';
    btn.style.color = '#fff';
    btn.style.boxShadow = '0 2px 12px rgba(255,134,116,.3)';
    
    // Se√ßili sekmeyi g√∂ster
    if (tab === 'kayit') {
        document.getElementById('puantajKayitTab').style.display = 'block';
    } else if (tab === 'analiz') {
        document.getElementById('puantajAnalizTab').style.display = 'block';
        populateSubeSelect('analizSube');
        loadPuantajAnaliz();
    } else if (tab === 'arsiv') {
        document.getElementById('puantajArsivTab').style.display = 'block';
        populateSubeSelect('arsivSube');
        loadPuantajArsiv();
    }
}

async function savePuantajFromModal() {
    const personelId = document.getElementById('puantajPersonelId').value;
    const score = parseInt(document.getElementById('puantajScore').value);
    const note = document.getElementById('puantajNote')?.value?.trim() || '';
    const eventDate = document.getElementById('puantajDate')?.value || new Date().toISOString().split('T')[0];
    
    if (score === 0) {
        toast('L√ºtfen yƒ±ldƒ±z seviyesi se√ßin', 'error');
        return;
    }
    
    if (!note) {
        toast('L√ºtfen a√ßƒ±klama girin', 'error');
        return;
    }
    
    const ay = document.getElementById('puantajAy').value;
    const yil = document.getElementById('puantajYil').value;
    const sube = document.getElementById('puantajSube').value;
    const puantajKey = `${yil}-${ay}`;
    
    try {
        await db.collection('puantaj').add({
            personelId,
            period: puantajKey,
            branch: sube,
            score,
            note,
            eventDate,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdBy: currentUser?.email || currentUser?.username || 'admin'
        });
        
        toast('Kayƒ±t eklendi!', 'success');
        closeModal();
        loadPuantaj();
    } catch (error) {
        console.error('Puantaj kayƒ±t hatasƒ±:', error);
        toast('Kayƒ±t hatasƒ±!', 'error');
    }
}

// Analiz y√ºkleme
async function loadPuantajAnaliz() {
    const container = document.getElementById('puantajAnalizContainer');
    if (!container) return;
    
    const donem = document.getElementById('analizDonem')?.value || 'current';
    const sube = document.getElementById('analizSube')?.value || '';
    
    container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--tx2)">Analiz y√ºkleniyor...</div>';
    
    try {
        let query = db.collection('puantaj');
        if (sube) query = query.where('branch', '==', sube);
        
        if (donem === 'current') {
            const now = new Date();
            const currentPeriod = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            query = query.where('period', '==', currentPeriod);
        }
        
        const snapshot = await query.get();
        
        // Personel bazƒ±nda toplama
        const personelStats = {};
        snapshot.forEach(doc => {
            const d = doc.data();
            if (!personelStats[d.personelId]) {
                personelStats[d.personelId] = { id: d.personelId, toplamPuan: 0, negatif: 0, pozitif: 0, kayitlar: [] };
            }
            const yildiz = d.score || 3;
            // Yeni puan sistemi: 1‚òÖ=-3, 2‚òÖ=-2, 3‚òÖ=-1, 4‚òÖ=+1, 5‚òÖ=+2
            if (yildiz === 1) {
                personelStats[d.personelId].toplamPuan -= 3;
                personelStats[d.personelId].negatif++;
            } else if (yildiz === 2) {
                personelStats[d.personelId].toplamPuan -= 2;
                personelStats[d.personelId].negatif++;
            } else if (yildiz === 3) {
                personelStats[d.personelId].toplamPuan -= 1;
                personelStats[d.personelId].negatif++;
            } else if (yildiz === 4) {
                personelStats[d.personelId].toplamPuan += 1;
                personelStats[d.personelId].pozitif++;
            } else if (yildiz === 5) {
                personelStats[d.personelId].toplamPuan += 2;
                personelStats[d.personelId].pozitif++;
            }
            personelStats[d.personelId].kayitlar.push(d);
        });
        
        // Personel isimlerini al
        const personelIds = Object.keys(personelStats);
        for (const pid of personelIds) {
            try {
                const pDoc = await db.collection('personel').doc(pid).get();
                if (pDoc.exists) {
                    personelStats[pid].name = pDoc.data().name;
                    personelStats[pid].position = pDoc.data().position;
                }
            } catch (e) {}
        }
        
        const sortedPersonel = Object.values(personelStats).sort((a, b) => b.toplamPuan - a.toplamPuan);
        
        let html = '';
        
        // √ñzet Kartlar
        html += `<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px">`;
        
        // En ƒ∞yi Personel
        const enIyi = sortedPersonel.length > 0 ? sortedPersonel[0] : null;
        html += `
            <div style="background:linear-gradient(135deg,rgba(39,174,96,.15),rgba(46,204,113,.1));border:1px solid rgba(39,174,96,.3);border-radius:16px;padding:20px;text-align:center">
                <div style="font-size:2.5rem;margin-bottom:8px">üèÜ</div>
                <div style="font-size:.75rem;color:var(--tx2);text-transform:uppercase;margin-bottom:4px">Ayƒ±n En ƒ∞yisi</div>
                <div style="font-size:1.1rem;font-weight:700;color:#27ae60">${enIyi?.name || '-'}</div>
                <div style="font-size:.85rem;color:var(--tx2)">${enIyi ? (enIyi.toplamPuan > 0 ? '+' : '') + enIyi.toplamPuan + ' Puan' : ''}</div>
            </div>
        `;
        
        // Dikkat Edilmesi Gereken
        const dikkat = sortedPersonel.length > 0 ? sortedPersonel[sortedPersonel.length - 1] : null;
        html += `
            <div style="background:linear-gradient(135deg,rgba(231,76,60,.15),rgba(192,57,43,.1));border:1px solid rgba(231,76,60,.3);border-radius:16px;padding:20px;text-align:center">
                <div style="font-size:2.5rem;margin-bottom:8px">‚ö†Ô∏è</div>
                <div style="font-size:.75rem;color:var(--tx2);text-transform:uppercase;margin-bottom:4px">Dikkat Edilmeli</div>
                <div style="font-size:1.1rem;font-weight:700;color:#e74c3c">${dikkat?.name || '-'}</div>
                <div style="font-size:.85rem;color:var(--tx2)">${dikkat ? (dikkat.toplamPuan > 0 ? '+' : '') + dikkat.toplamPuan + ' Puan' : ''}</div>
            </div>
        `;
        
        // Toplam Kayƒ±t
        const toplamKayit = snapshot.size;
        html += `
            <div style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:16px;padding:20px;text-align:center">
                <div style="font-size:2.5rem;margin-bottom:8px">üìä</div>
                <div style="font-size:.75rem;color:var(--tx2);text-transform:uppercase;margin-bottom:4px">Toplam Kayƒ±t</div>
                <div style="font-size:1.1rem;font-weight:700;color:var(--tx)">${toplamKayit}</div>
            </div>
        `;
        
        html += `</div>`;
        
        // Sƒ±ralama Tablosu
        html += `<div style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:16px;padding:20px">`;
        html += `<div style="font-weight:600;margin-bottom:16px;color:var(--tx)">üìã Personel Sƒ±ralamasƒ±</div>`;
        
        if (sortedPersonel.length === 0) {
            html += `<div style="text-align:center;padding:40px;color:var(--tx3)">Bu d√∂nemde kayƒ±t yok</div>`;
        } else {
            sortedPersonel.forEach((p, i) => {
                const medal = i === 0 ? 'ü•á' : (i === 1 ? 'ü•à' : (i === 2 ? 'ü•â' : `${i + 1}.`));
                const puanColor = p.toplamPuan < 0 ? '#e74c3c' : (p.toplamPuan > 0 ? '#27ae60' : 'var(--tx)');
                const primStatus = p.toplamPuan <= -5;
                
                html += `
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:14px;background:${primStatus ? 'rgba(231,76,60,.08)' : 'var(--bg3)'};border-radius:10px;margin-bottom:8px">
                        <div style="display:flex;align-items:center;gap:12px">
                            <span style="font-size:1.2rem;width:30px;text-align:center">${medal}</span>
                            <div>
                                <div style="font-weight:600;color:var(--tx)">${p.name || 'Bilinmiyor'}</div>
                                <div style="font-size:.75rem;color:var(--tx3)">${p.position || ''}</div>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:16px">
                            <div style="text-align:center">
                                <div style="font-size:.65rem;color:var(--tx3)">Negatif</div>
                                <div style="font-weight:600;color:#e74c3c">${p.negatif}</div>
                            </div>
                            <div style="text-align:center">
                                <div style="font-size:.65rem;color:var(--tx3)">Pozitif</div>
                                <div style="font-weight:600;color:#27ae60">${p.pozitif}</div>
                            </div>
                            <div style="min-width:60px;text-align:right">
                                <div style="font-size:1.2rem;font-weight:700;color:${puanColor}">${p.toplamPuan > 0 ? '+' : ''}${p.toplamPuan}</div>
                                ${primStatus ? '<div style="font-size:.65rem;color:#e74c3c">PRƒ∞M YOK</div>' : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        html += `</div>`;
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Analiz y√ºkleme hatasƒ±:', error);
        container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--red)">Y√ºkleme hatasƒ±!</div>';
    }
}

// Ar≈üiv y√ºkleme
async function loadPuantajArsiv() {
    const container = document.getElementById('puantajArsivContainer');
    if (!container) return;
    
    const sube = document.getElementById('arsivSube')?.value || '';
    
    container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--tx2)">Ar≈üiv y√ºkleniyor...</div>';
    
    try {
        let query = db.collection('puantaj');
        if (sube) query = query.where('branch', '==', sube);
        
        const snapshot = await query.get();
        
        // D√∂nem bazƒ±nda gruplama
        const donemler = {};
        snapshot.forEach(doc => {
            const d = doc.data();
            const period = d.period || 'unknown';
            if (!donemler[period]) {
                donemler[period] = { kayitSayisi: 0, personeller: {} };
            }
            donemler[period].kayitSayisi++;
            
            if (!donemler[period].personeller[d.personelId]) {
                donemler[period].personeller[d.personelId] = { toplamPuan: 0 };
            }
            const yildiz = d.score || 3;
            // Yeni puan sistemi: 1‚òÖ=-3, 2‚òÖ=-2, 3‚òÖ=-1, 4‚òÖ=+1, 5‚òÖ=+2
            if (yildiz === 1) {
                donemler[period].personeller[d.personelId].toplamPuan -= 3;
            } else if (yildiz === 2) {
                donemler[period].personeller[d.personelId].toplamPuan -= 2;
            } else if (yildiz === 3) {
                donemler[period].personeller[d.personelId].toplamPuan -= 1;
            } else if (yildiz === 4) {
                donemler[period].personeller[d.personelId].toplamPuan += 1;
            } else if (yildiz === 5) {
                donemler[period].personeller[d.personelId].toplamPuan += 2;
            }
        });
        
        // Sƒ±rala (yeniden eskiye)
        const sortedDonemler = Object.entries(donemler).sort((a, b) => b[0].localeCompare(a[0]));
        
        let html = '';
        
        if (sortedDonemler.length === 0) {
            html = '<div style="text-align:center;padding:60px;color:var(--tx3)">Hen√ºz ar≈üivlenmi≈ü d√∂nem yok</div>';
        } else {
            html = `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px">`;
            
            sortedDonemler.forEach(([period, data]) => {
                const [yil, ay] = period.split('-');
                const ayAdi = getMonthName(ay);
                const personelSayisi = Object.keys(data.personeller).length;
                const primYokSayisi = Object.values(data.personeller).filter(p => p.toplamPuan <= -5).length;
                
                html += `
                    <div style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:16px;padding:20px;transition:all .2s">
                        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:16px">
                            <div>
                                <div style="font-size:1.1rem;font-weight:700;color:var(--tx)">${ayAdi} ${yil}</div>
                                <div style="font-size:.8rem;color:var(--tx2)">${personelSayisi} personel</div>
                            </div>
                            <div style="font-size:2rem">üìÖ</div>
                        </div>
                        <div style="display:flex;gap:12px">
                            <div style="flex:1;background:var(--bg3);border-radius:10px;padding:12px;text-align:center">
                                <div style="font-size:1.4rem;font-weight:700;color:var(--tx)">${data.kayitSayisi}</div>
                                <div style="font-size:.65rem;color:var(--tx3)">Kayƒ±t</div>
                            </div>
                            <div style="flex:1;background:rgba(231,76,60,.1);border-radius:10px;padding:12px;text-align:center">
                                <div style="font-size:1.4rem;font-weight:700;color:#e74c3c">${primYokSayisi}</div>
                                <div style="font-size:.65rem;color:var(--tx3)">Prim Yok</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
        }
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Ar≈üiv y√ºkleme hatasƒ±:', error);
        container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--red)">Y√ºkleme hatasƒ±!</div>';
    }
}

function getMonthName(ay) {
    const aylar = ['', 'Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran', 'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'];
    return aylar[parseInt(ay)] || ay;
}

async function deletePuantajEntry(docId) {
    if (!confirm('Bu kaydƒ± silmek istediƒüinize emin misiniz?')) {
        return;
    }
    
    try {
        await db.collection('puantaj').doc(docId).delete();
        toast('Kayƒ±t silindi', 'success');
        loadPuantaj();
    } catch (error) {
        console.error('Silme hatasƒ±:', error);
        toast('Silme hatasƒ±: ' + error.message, 'error');
    }
}

function showPuantajRules() {
    db.collection('puantajRules').get().then(snapshot => {
        let html = '<div style="max-height:400px;overflow-y:auto">';
        snapshot.forEach(doc => {
            const r = doc.data();
            html += `
                <div style="padding:12px;background:var(--surface2);border-radius:var(--radiusSm);margin-bottom:8px">
                    <strong>${r.title}</strong>
                    <span style="float:right;background:${r.effect === 'prim_yok' ? 'var(--red)' : 'var(--yellow)'};color:#fff;padding:2px 8px;border-radius:4px;font-size:.75rem">${r.effect}</span>
                    <p style="font-size:.85rem;color:var(--txdark2);margin-top:4px">${r.desc}</p>
                </div>
            `;
        });
        html += '</div>';
        showModal('‚≠ê Puantaj Kurallarƒ±', html, '<button class="btn btn-ghost" onclick="closeModal()">Kapat</button>');
    });
}

// ==================== KULLANICI Y√ñNETƒ∞Mƒ∞ ====================
async function loadUserList() {
    const container = document.getElementById('userList');
    if (!container) return;
    
    try {
        const snapshot = await db.collection('users').get();
        
        if (snapshot.empty) {
            container.innerHTML = '<p style="color:var(--tx2);text-align:center;padding:20px">Kullanƒ±cƒ± bulunamadƒ±</p>';
            return;
        }
        
        let html = '';
        snapshot.forEach(doc => {
            const u = doc.data();
            const roleLabel = u.role === 'yonetici' ? 'üëë Y√∂netici' : u.role === 'bolge_muduru' ? 'üè¢ B√∂lge M√ºd√ºr√º' : 'üè™ Maƒüaza M√ºd√ºr√º';
            html += `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg3);border-radius:var(--radiusSm);margin-bottom:8px">
                    <div>
                        <strong style="color:var(--tx)">${u.name || doc.id}</strong>
                        <span style="margin-left:8px;font-size:.75rem;background:var(--accentLight);color:var(--accent);padding:2px 8px;border-radius:4px">${roleLabel}</span>
                        <div style="font-size:.8rem;color:var(--tx2)">@${doc.id} ${u.branch !== 'all' ? '‚Ä¢ ' + u.branch : ''}</div>
                    </div>
                    <div style="display:flex;gap:8px">
                        ${doc.id !== 'admin' ? `
                            <button class="btn btn-sm btn-ghost" onclick="editUser('${doc.id}')">‚úèÔ∏è</button>
                            <button class="btn btn-sm" style="background:var(--red);color:#fff" onclick="deleteUser('${doc.id}')">üóëÔ∏è</button>
                        ` : '<span style="font-size:.75rem;color:var(--tx3)">Sistem hesabƒ±</span>'}
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    } catch (error) {
        console.error('Kullanƒ±cƒ± y√ºkleme hatasƒ±:', error);
        container.innerHTML = '<p style="color:var(--red);text-align:center;padding:20px">Y√ºkleme hatasƒ±!</p>';
    }
}

function showAddUserModal(editId = null) {
    const isEdit = !!editId;
    const title = isEdit ? 'Kullanƒ±cƒ± D√ºzenle' : 'Yeni Kullanƒ±cƒ±';
    
    const body = `
        <input type="hidden" id="userEditId" value="${editId || ''}">
        <div class="form-grid">
            <div class="form-group"><label class="form-label">Kullanƒ±cƒ± Adƒ± *</label><input type="text" id="modalUserName" class="form-input" ${isEdit ? 'readonly' : ''} placeholder="ornek.kullanici"></div>
            <div class="form-group"><label class="form-label">G√∂r√ºnen Ad</label><input type="text" id="modalUserDisplayName" class="form-input" placeholder="Ahmet Yƒ±lmaz"></div>
            <div class="form-group"><label class="form-label">≈ûifre ${isEdit ? '(bo≈ü bƒ±rakƒ±lƒ±rsa deƒüi≈ümez)' : '*'}</label><input type="password" id="modalUserPassword" class="form-input" minlength="6"></div>
            <div class="form-group">
                <label class="form-label">Rol *</label>
                <select id="modalUserRole" class="form-select">
                    <option value="barista">‚òï Barista</option>
                    <option value="magaza_muduru">üè™ Maƒüaza M√ºd√ºr√º</option>
                    <option value="bolge_muduru">üè¢ B√∂lge M√ºd√ºr√º</option>
                    <option value="yonetici">üëë Y√∂netici</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">≈ûube Eri≈üimi</label>
                <select id="modalUserBranch" class="form-select">
                    <option value="all">T√ºm ≈ûubeler</option>
                    ${STATE.branches.map(b => `<option value="${b}">${b}</option>`).join('')}
                </select>
            </div>
        </div>
    `;
    
    const footer = `
        <button class="btn btn-ghost" onclick="closeModal()">ƒ∞ptal</button>
        <button class="btn btn-primary" onclick="saveUser()">üíæ Kaydet</button>
    `;
    
    showModal(title, body, footer);
    
    if (isEdit) {
        loadUserForEdit(editId);
    }
}

async function loadUserForEdit(id) {
    try {
        const doc = await db.collection('users').doc(id).get();
        if (doc.exists) {
            const u = doc.data();
            document.getElementById('modalUserName').value = id;
            document.getElementById('modalUserDisplayName').value = u.name || '';
            document.getElementById('modalUserRole').value = u.role || 'barista';
            document.getElementById('modalUserBranch').value = u.branch || 'all';
        }
    } catch (error) {
        console.error('Kullanƒ±cƒ± y√ºkleme hatasƒ±:', error);
    }
}

async function saveUser() {
    const editId = document.getElementById('userEditId').value;
    const username = document.getElementById('modalUserName').value.trim().toLowerCase();
    const password = document.getElementById('modalUserPassword').value;
    const displayName = document.getElementById('modalUserDisplayName').value.trim();
    const role = document.getElementById('modalUserRole').value;
    const branch = document.getElementById('modalUserBranch').value;
    
    if (!username) {
        toast('Kullanƒ±cƒ± adƒ± zorunludur', 'error');
        return;
    }
    
    if (!editId && !password) {
        toast('≈ûifre zorunludur', 'error');
        return;
    }
    
    if (password && password.length < 6) {
        toast('≈ûifre en az 6 karakter olmalƒ±', 'error');
        return;
    }
    
    const data = {
        name: displayName || username,
        role,
        branch,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    if (password) {
        data.password = password;
    }
    
    try {
        if (editId) {
            await db.collection('users').doc(editId).update(data);
            toast('Kullanƒ±cƒ± g√ºncellendi', 'success');
        } else {
            // Kullanƒ±cƒ± adƒ± zaten var mƒ± kontrol et
            const existing = await db.collection('users').doc(username).get();
            if (existing.exists) {
                toast('Bu kullanƒ±cƒ± adƒ± zaten kullanƒ±lƒ±yor', 'error');
                return;
            }
            data.username = username;
            data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            await db.collection('users').doc(username).set(data);
            toast('Kullanƒ±cƒ± olu≈üturuldu', 'success');
        }
        closeModal();
        loadUserList();
    } catch (error) {
        console.error('Kayƒ±t hatasƒ±:', error);
        toast('Kayƒ±t hatasƒ±!', 'error');
    }
}

function editUser(id) {
    showAddUserModal(id);
}

async function deleteUser(id) {
    if (id === 'admin') {
        toast('Admin hesabƒ± silinemez', 'error');
        return;
    }
    
    confirmModal('Kullanƒ±cƒ± Sil', 'Bu kullanƒ±cƒ±yƒ± silmek istediƒüinize emin misiniz?', async () => {
        try {
            await db.collection('users').doc(id).delete();
            toast('Kullanƒ±cƒ± silindi', 'success');
            loadUserList();
        } catch (error) {
            console.error('Silme hatasƒ±:', error);
            toast('Silme hatasƒ±!', 'error');
        }
    });
}

// ==================== GELƒ∞≈ûMƒ∞≈û ƒ∞Zƒ∞N Y√ñNETƒ∞Mƒ∞ ====================
const PERMISSION_STRUCTURE = {
    pages: [
        { id: 'dashboard', label: 'Dashboard', icon: 'üè†' },
        { id: 'personel', label: 'Personel', icon: 'üë•' },
        { id: 'puantaj', label: 'Puantaj', icon: '‚≠ê' },
        { id: 'shift', label: 'Shift Planƒ±', icon: 'üìÖ' }
    ],
    documents: [
        { id: 'sozlesme', label: 'ƒ∞≈ü S√∂zle≈ümesi', icon: 'üìÑ' },
        { id: 'tutanak', label: 'Tutanak', icon: 'üìù' },
        { id: 'savunma', label: 'Savunma ƒ∞steme', icon: 'üí¨' },
        { id: 'fesih', label: 'Fesih', icon: '‚ùå' },
        { id: 'istifa', label: 'ƒ∞stifa', icon: 'üö™' },
        { id: 'ibraname', label: 'ƒ∞braname', icon: '‚úÖ' }
    ],
    admin: [
        { id: 'admin_genel', label: 'Genel Ayarlar', icon: '‚öôÔ∏è' },
        { id: 'admin_kullanicilar', label: 'Kullanƒ±cƒ± Y√∂netimi', icon: 'üë§' },
        { id: 'admin_izinler', label: 'ƒ∞zin Y√∂netimi', icon: 'üîê' },
        { id: 'admin_puantaj', label: 'Puantaj Kurallarƒ±', icon: '‚≠ê' },
        { id: 'admin_subeler', label: '≈ûube Y√∂netimi', icon: 'üìç' },
        { id: 'admin_pozisyonlar', label: 'Pozisyonlar', icon: 'üëî' },
        { id: 'admin_ihlaller', label: 'ƒ∞hlal Kataloƒüu', icon: 'üìö' },
        { id: 'admin_sablonlar', label: '≈ûablonlar', icon: 'üìã' }
    ],
    special: [
        { id: 'print_shift', label: 'Shift planƒ±nƒ± yazdƒ±rabilir', icon: 'üñ®Ô∏è' },
        { id: 'view_checklist_history', label: 'Ge√ßmi≈ü checklisti g√∂rebilir', icon: 'üìä' },
        { id: 'view_salary', label: 'Maa≈ü bilgilerini g√∂rebilir', icon: 'üí∞' },
        { id: 'export_data', label: 'Veri dƒ±≈üa aktarabilir', icon: 'üì§' },
        { id: 'delete_records', label: 'Kayƒ±t silebilir', icon: 'üóëÔ∏è' }
    ]
};

const DEFAULT_ROLE_PERMISSIONS = {
    barista: {
        pages: { dashboard: { view: true, edit: false }, personel: { view: false, edit: false }, puantaj: { view: true, edit: false }, shift: { view: true, edit: false } },
        documents: { sozlesme: { view: false, edit: false }, tutanak: { view: false, edit: false }, savunma: { view: false, edit: false }, fesih: { view: false, edit: false }, istifa: { view: false, edit: false }, ibraname: { view: false, edit: false } },
        admin: { admin_genel: false, admin_kullanicilar: false, admin_izinler: false, admin_puantaj: false, admin_subeler: false, admin_pozisyonlar: false, admin_ihlaller: false, admin_sablonlar: false },
        special: { print_shift: true, view_checklist_history: false, view_salary: false, export_data: false, delete_records: false }
    },
    magaza_muduru: {
        pages: { dashboard: { view: true, edit: true }, personel: { view: true, edit: true }, puantaj: { view: true, edit: true }, shift: { view: true, edit: true } },
        documents: { sozlesme: { view: true, edit: true }, tutanak: { view: true, edit: true }, savunma: { view: true, edit: true }, fesih: { view: true, edit: false }, istifa: { view: true, edit: true }, ibraname: { view: true, edit: true } },
        admin: { admin_genel: false, admin_kullanicilar: false, admin_izinler: false, admin_puantaj: false, admin_subeler: false, admin_pozisyonlar: false, admin_ihlaller: true, admin_sablonlar: false },
        special: { print_shift: true, view_checklist_history: true, view_salary: false, export_data: true, delete_records: false }
    },
    bolge_muduru: {
        pages: { dashboard: { view: true, edit: true }, personel: { view: true, edit: true }, puantaj: { view: true, edit: true }, shift: { view: true, edit: true } },
        documents: { sozlesme: { view: true, edit: true }, tutanak: { view: true, edit: true }, savunma: { view: true, edit: true }, fesih: { view: true, edit: true }, istifa: { view: true, edit: true }, ibraname: { view: true, edit: true } },
        admin: { admin_genel: true, admin_kullanicilar: false, admin_izinler: false, admin_puantaj: true, admin_subeler: true, admin_pozisyonlar: true, admin_ihlaller: true, admin_sablonlar: true },
        special: { print_shift: true, view_checklist_history: true, view_salary: true, export_data: true, delete_records: true }
    }
};

async function loadAdvancedPermissions() {
    const role = document.getElementById('advRoleSelect').value;
    const panel = document.getElementById('advPermissionsPanel');
    const empty = document.getElementById('advPermissionsEmpty');
    
    if (!role) {
        panel.style.display = 'none';
        empty.style.display = 'block';
        return;
    }
    
    panel.style.display = 'block';
    empty.style.display = 'none';
    
    // Firebase'den izinleri al veya varsayƒ±lanƒ± kullan
    let perms = DEFAULT_ROLE_PERMISSIONS[role];
    try {
        const doc = await db.collection('advancedPermissions').doc(role).get();
        if (doc.exists) {
            perms = { ...perms, ...doc.data() };
        }
    } catch (error) {
        console.error('ƒ∞zin y√ºkleme hatasƒ±:', error);
    }
    
    // Sayfalar
    renderPagePermissions(perms.pages || {});
    
    // Belgeler
    renderDocPermissions(perms.documents || {});
    
    // Admin
    renderAdminPermissions(perms.admin || {});
    
    // √ñzel izinler
    renderSpecialPermissions(perms.special || {});
}

function renderPagePermissions(perms) {
    const container = document.getElementById('pagePermissions');
    let html = '';
    
    PERMISSION_STRUCTURE.pages.forEach(p => {
        const perm = perms[p.id] || { view: false, edit: false };
        html += `
            <div style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:10px;padding:14px">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
                    <span style="font-size:1.2rem">${p.icon}</span>
                    <span style="font-weight:600;color:var(--tx)">${p.label}</span>
                </div>
                <div style="display:flex;gap:16px">
                    <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
                        <input type="checkbox" class="perm-cb" data-cat="pages" data-id="${p.id}" data-type="view" ${perm.view ? 'checked' : ''} style="width:18px;height:18px;accent-color:#27ae60">
                        <span style="font-size:.8rem;color:var(--tx2)">üëÅÔ∏è G√∂r√ºnt√ºle</span>
                    </label>
                    <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
                        <input type="checkbox" class="perm-cb" data-cat="pages" data-id="${p.id}" data-type="edit" ${perm.edit ? 'checked' : ''} style="width:18px;height:18px;accent-color:#3498db">
                        <span style="font-size:.8rem;color:var(--tx2)">‚úèÔ∏è D√ºzenle</span>
                    </label>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function renderDocPermissions(perms) {
    const container = document.getElementById('docPermissions');
    let html = '';
    
    PERMISSION_STRUCTURE.documents.forEach(d => {
        const perm = perms[d.id] || { view: false, edit: false };
        html += `
            <div style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:10px;padding:14px">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
                    <span style="font-size:1.2rem">${d.icon}</span>
                    <span style="font-weight:600;color:var(--tx)">${d.label}</span>
                </div>
                <div style="display:flex;gap:16px">
                    <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
                        <input type="checkbox" class="perm-cb" data-cat="documents" data-id="${d.id}" data-type="view" ${perm.view ? 'checked' : ''} style="width:18px;height:18px;accent-color:#27ae60">
                        <span style="font-size:.8rem;color:var(--tx2)">üëÅÔ∏è G√∂r√ºnt√ºle</span>
                    </label>
                    <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
                        <input type="checkbox" class="perm-cb" data-cat="documents" data-id="${d.id}" data-type="edit" ${perm.edit ? 'checked' : ''} style="width:18px;height:18px;accent-color:#3498db">
                        <span style="font-size:.8rem;color:var(--tx2)">‚úèÔ∏è D√ºzenle</span>
                    </label>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function renderAdminPermissions(perms) {
    const container = document.getElementById('adminPermissions');
    let html = '';
    
    PERMISSION_STRUCTURE.admin.forEach(a => {
        const hasAccess = perms[a.id] || false;
        html += `
            <div style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:10px;padding:14px">
                <label style="display:flex;align-items:center;gap:10px;cursor:pointer">
                    <input type="checkbox" class="perm-cb" data-cat="admin" data-id="${a.id}" data-type="access" ${hasAccess ? 'checked' : ''} style="width:20px;height:20px;accent-color:#ff8674">
                    <div>
                        <div style="display:flex;align-items:center;gap:6px">
                            <span style="font-size:1rem">${a.icon}</span>
                            <span style="font-weight:600;color:var(--tx);font-size:.9rem">${a.label}</span>
                        </div>
                    </div>
                </label>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function renderSpecialPermissions(perms) {
    const container = document.getElementById('specialPermissions');
    let html = '';
    
    PERMISSION_STRUCTURE.special.forEach(s => {
        const hasPermission = perms[s.id] || false;
        html += `
            <label style="display:flex;align-items:center;gap:12px;padding:14px;background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:10px;cursor:pointer;transition:all .2s" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--cardBorder)'">
                <input type="checkbox" class="perm-cb" data-cat="special" data-id="${s.id}" data-type="enabled" ${hasPermission ? 'checked' : ''} style="width:22px;height:22px;accent-color:#ff8674">
                <span style="font-size:1.3rem">${s.icon}</span>
                <span style="font-weight:500;color:var(--tx);font-size:.95rem">${s.label}</span>
            </label>
        `;
    });
    
    container.innerHTML = html;
}

async function saveAdvancedPermissions() {
    const role = document.getElementById('advRoleSelect').value;
    if (!role) {
        toast('L√ºtfen bir rol se√ßin', 'error');
        return;
    }
    
    const permissions = {
        pages: {},
        documents: {},
        admin: {},
        special: {}
    };
    
    // T√ºm checkbox'larƒ± topla
    document.querySelectorAll('.perm-cb').forEach(cb => {
        const cat = cb.dataset.cat;
        const id = cb.dataset.id;
        const type = cb.dataset.type;
        
        if (cat === 'pages' || cat === 'documents') {
            if (!permissions[cat][id]) permissions[cat][id] = { view: false, edit: false };
            permissions[cat][id][type] = cb.checked;
        } else if (cat === 'admin') {
            permissions.admin[id] = cb.checked;
        } else if (cat === 'special') {
            permissions.special[id] = cb.checked;
        }
    });
    
    try {
        await db.collection('advancedPermissions').doc(role).set(permissions);
        toast('ƒ∞zinler ba≈üarƒ±yla kaydedildi!', 'success');
    } catch (error) {
        console.error('ƒ∞zin kayƒ±t hatasƒ±:', error);
        toast('Kayƒ±t hatasƒ±!', 'error');
    }
}

function resetAdvancedPermissions() {
    const role = document.getElementById('advRoleSelect').value;
    if (!role) {
        toast('L√ºtfen bir rol se√ßin', 'error');
        return;
    }
    
    if (!confirm(`"${role}" rol√ºn√ºn izinleri varsayƒ±lana d√∂nd√ºr√ºlecek. Emin misiniz?`)) return;
    
    // Varsayƒ±lan izinleri y√ºkle
    const perms = DEFAULT_ROLE_PERMISSIONS[role];
    
    renderPagePermissions(perms.pages || {});
    renderDocPermissions(perms.documents || {});
    renderAdminPermissions(perms.admin || {});
    renderSpecialPermissions(perms.special || {});
    
    toast('Varsayƒ±lan izinler y√ºklendi. Kaydetmeyi unutmayƒ±n!', 'success');
}

// ƒ∞zin kontrol fonksiyonu
function checkPermission(category, id, type = 'view') {
    if (!currentUser) return false;
    if (currentUser.role === 'yonetici') return true;
    
    const perms = window.userAdvancedPermissions;
    if (!perms) return false;
    
    if (category === 'pages' || category === 'documents') {
        return perms[category]?.[id]?.[type] || false;
    } else if (category === 'admin') {
        return perms.admin?.[id] || false;
    } else if (category === 'special') {
        return perms.special?.[id] || false;
    }
    
    return false;
}

// Kullanƒ±cƒ± giri≈üinde izinleri y√ºkle
async function loadUserAdvancedPermissions() {
    if (!currentUser || currentUser.role === 'yonetici') {
        window.userAdvancedPermissions = null;
        return;
    }
    
    try {
        const doc = await db.collection('advancedPermissions').doc(currentUser.role).get();
        if (doc.exists) {
            window.userAdvancedPermissions = doc.data();
        } else {
            window.userAdvancedPermissions = DEFAULT_ROLE_PERMISSIONS[currentUser.role] || null;
        }
        
        // ƒ∞zinleri uygula
        applyAdvancedPermissions();
    } catch (error) {
        console.error('Kullanƒ±cƒ± izin y√ºkleme hatasƒ±:', error);
    }
}

// ƒ∞zinleri UI'a uygula
function applyAdvancedPermissions() {
    if (!window.userAdvancedPermissions) return;
    
    const perms = window.userAdvancedPermissions;
    
    // Navbar men√ºlerini kƒ±sƒ±tla
    document.querySelectorAll('.nav-item[data-page]').forEach(item => {
        const page = item.dataset.page;
        const pagePerm = perms.pages?.[page];
        
        if (pagePerm && !pagePerm.view) {
            item.style.display = 'none';
        }
    });
    
    // Dashboard kartlarƒ±nƒ± kƒ±sƒ±tla
    document.querySelectorAll('.dashboard-card').forEach(card => {
        const onclick = card.getAttribute('onclick') || '';
        
        // Sayfa kartlarƒ±
        PERMISSION_STRUCTURE.pages.forEach(p => {
            if (onclick.includes(`'${p.id}'`)) {
                const perm = perms.pages?.[p.id];
                if (perm && !perm.view) {
                    card.style.display = 'none';
                }
            }
        });
        
        // Belge kartlarƒ±
        PERMISSION_STRUCTURE.documents.forEach(d => {
            if (onclick.includes(`'${d.id}'`)) {
                const perm = perms.documents?.[d.id];
                if (perm && !perm.view) {
                    card.style.display = 'none';
                }
            }
        });
    });
    
    // Belgeler b√∂l√ºm√ºn√º kontrol et
    const hasAnyDocAccess = Object.values(perms.documents || {}).some(d => d.view);
    if (!hasAnyDocAccess) {
        document.querySelectorAll('.dashboard-section').forEach(section => {
            const header = section.querySelector('div');
            if (header && header.textContent.includes('Belgeler')) {
                section.style.display = 'none';
            }
        });
    }
    
    // Admin paneli eri≈üimini kontrol et
    const hasAnyAdminAccess = Object.values(perms.admin || {}).some(a => a);
    if (!hasAnyAdminAccess) {
        document.querySelectorAll('.dashboard-section').forEach(section => {
            const header = section.querySelector('div');
            if (header && header.textContent.includes('Sistem')) {
                section.style.display = 'none';
            }
        });
    }
    
    // √ñzel izinleri uygula
    if (!perms.special?.print_shift) {
        // Print butonlarƒ±nƒ± gizle
        document.querySelectorAll('[onclick*="print"]').forEach(btn => {
            if (btn.closest('#page-shift')) {
                btn.style.display = 'none';
            }
        });
    }
    
    // Salt okunur badge ekle (d√ºzenleme izni yoksa)
    const hasAnyEdit = Object.values(perms.pages || {}).some(p => p.edit) ||
                       Object.values(perms.documents || {}).some(d => d.edit);
    
    if (!hasAnyEdit) {
        const userRoleEl = document.getElementById('userRole');
        if (userRoleEl && !userRoleEl.innerHTML.includes('SALT OKUNUR')) {
            userRoleEl.innerHTML = '<span style="background:var(--accent);color:#fff;padding:2px 8px;border-radius:10px;font-size:.65rem">SALT OKUNUR</span> ' + userRoleEl.textContent;
        }
    }
}


// ==================== OTURUM Y√ñNETƒ∞Mƒ∞ ====================
let sessionTimeoutId = null;
let sessionWarningId = null;
let lastActivityTime = Date.now();
const SESSION_EVENTS = ['mousedown', 'mousemove', 'keydown', 'scroll', 'touchstart', 'click'];

// Oturum ayarlarƒ±nƒ± y√ºkle
async function loadSessionSettings() {
    try {
        const doc = await db.collection('settings').doc('session').get();
        if (doc.exists) {
            const settings = doc.data();
            document.getElementById('sessionTimeout').value = settings.timeout || '30';
            document.getElementById('sessionWarning').value = settings.warning || '60';
            document.getElementById('sessionLogoutOnClose').checked = settings.logoutOnClose || false;
            document.getElementById('sessionSingleDevice').checked = settings.singleDevice || false;
            
            // Timeout'u ba≈ülat
            initSessionTimeout(settings.timeout || 30, settings.warning || 60);
        }
    } catch (error) {
        console.error('Oturum ayarlarƒ± y√ºkleme hatasƒ±:', error);
    }
}

// Oturum ayarlarƒ±nƒ± kaydet
async function saveSessionSettings() {
    const timeout = document.getElementById('sessionTimeout').value;
    const warning = document.getElementById('sessionWarning').value;
    const logoutOnClose = document.getElementById('sessionLogoutOnClose').checked;
    const singleDevice = document.getElementById('sessionSingleDevice').checked;
    
    try {
        await db.collection('settings').doc('session').set({
            timeout: parseInt(timeout),
            warning: parseInt(warning),
            logoutOnClose,
            singleDevice,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Timeout'u g√ºncelle
        initSessionTimeout(parseInt(timeout), parseInt(warning));
        
        toast('Oturum ayarlarƒ± kaydedildi', 'success');
    } catch (error) {
        console.error('Oturum ayarlarƒ± kayƒ±t hatasƒ±:', error);
        toast('Kayƒ±t hatasƒ±!', 'error');
    }
}

// Session timeout ba≈ülat
function initSessionTimeout(timeoutMinutes, warningSeconds) {
    // Eski timeout'larƒ± temizle
    if (sessionTimeoutId) clearTimeout(sessionTimeoutId);
    if (sessionWarningId) clearTimeout(sessionWarningId);
    
    // Devre dƒ±≈üƒ±ysa √ßƒ±k
    if (timeoutMinutes === 0) return;
    
    const timeoutMs = timeoutMinutes * 60 * 1000;
    const warningMs = timeoutMs - (warningSeconds * 1000);
    
    // Aktivite dinleyicilerini ekle
    SESSION_EVENTS.forEach(event => {
        document.addEventListener(event, resetSessionTimer, { passive: true });
    });
    
    // Zamanlayƒ±cƒ±larƒ± ba≈ülat
    startSessionTimers(timeoutMs, warningMs);
}

function startSessionTimers(timeoutMs, warningMs) {
    // Eski timeout'larƒ± temizle
    if (sessionTimeoutId) clearTimeout(sessionTimeoutId);
    if (sessionWarningId) clearTimeout(sessionWarningId);
    
    // Uyarƒ± timer'ƒ±
    if (warningMs > 0) {
        sessionWarningId = setTimeout(() => {
            showSessionWarning();
        }, warningMs);
    }
    
    // √áƒ±kƒ±≈ü timer'ƒ±
    sessionTimeoutId = setTimeout(() => {
        sessionAutoLogout();
    }, timeoutMs);
}

function resetSessionTimer() {
    lastActivityTime = Date.now();
    
    // Ayarlarƒ± al ve timer'larƒ± yeniden ba≈ülat
    const timeoutEl = document.getElementById('sessionTimeout');
    const warningEl = document.getElementById('sessionWarning');
    
    if (timeoutEl && warningEl) {
        const timeoutMinutes = parseInt(timeoutEl.value) || 30;
        const warningSeconds = parseInt(warningEl.value) || 60;
        
        if (timeoutMinutes > 0) {
            const timeoutMs = timeoutMinutes * 60 * 1000;
            const warningMs = timeoutMs - (warningSeconds * 1000);
            startSessionTimers(timeoutMs, warningMs);
        }
    }
}

function showSessionWarning() {
    const warningEl = document.getElementById('sessionWarning');
    const seconds = warningEl ? parseInt(warningEl.value) : 60;
    
    const body = `
        <div style="text-align:center;padding:20px">
            <div style="font-size:4rem;margin-bottom:16px">‚è∞</div>
            <div style="font-size:1.2rem;font-weight:600;color:var(--tx);margin-bottom:12px">Oturum S√ºresi Doluyor!</div>
            <div style="color:var(--tx2);margin-bottom:20px">
                <span id="sessionCountdown">${seconds}</span> saniye i√ßinde otomatik √ßƒ±kƒ±≈ü yapƒ±lacak.
            </div>
            <div style="font-size:.85rem;color:var(--tx3)">Devam etmek i√ßin herhangi bir yere tƒ±klayƒ±n.</div>
        </div>
    `;
    
    showModal('‚è∞ Oturum Uyarƒ±sƒ±', body, `
        <button class="btn btn-ghost" onclick="sessionAutoLogout()">√áƒ±kƒ±≈ü Yap</button>
        <button class="btn btn-primary" onclick="extendSession()">Devam Et</button>
    `);
    
    // Geri sayƒ±m
    let countdown = seconds;
    const countdownInterval = setInterval(() => {
        countdown--;
        const el = document.getElementById('sessionCountdown');
        if (el) el.textContent = countdown;
        
        if (countdown <= 0) {
            clearInterval(countdownInterval);
        }
    }, 1000);
    
    window.sessionCountdownInterval = countdownInterval;
}

function extendSession() {
    if (window.sessionCountdownInterval) {
        clearInterval(window.sessionCountdownInterval);
    }
    closeModal();
    resetSessionTimer();
    toast('Oturum uzatƒ±ldƒ±', 'success');
}

async function sessionAutoLogout() {
    if (window.sessionCountdownInterval) {
        clearInterval(window.sessionCountdownInterval);
    }
    closeModal();
    
    // Oturum kaydƒ±nƒ± g√ºncelle
    if (currentUser) {
        try {
            await db.collection('sessions').doc(currentUser.sessionId).update({
                status: 'timeout',
                endedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        } catch (e) {}
    }
    
    toast('Oturum s√ºresi doldu', 'error');
    setTimeout(() => {
        logout();
    }, 1000);
}

// Aktif oturumlarƒ± y√ºkle
async function loadActiveSessions() {
    const container = document.getElementById('activeSessionsList');
    if (!container) return;
    
    container.innerHTML = `
        <div style="text-align:center;padding:40px;color:var(--tx2)">
            <div style="font-size:2rem;margin-bottom:12px">üîÑ</div>
            <div>Y√ºkleniyor...</div>
        </div>
    `;
    
    try {
        const snapshot = await db.collection('sessions')
            .where('status', '==', 'active')
            .orderBy('startedAt', 'desc')
            .limit(50)
            .get();
        
        if (snapshot.empty) {
            container.innerHTML = `
                <div style="text-align:center;padding:40px;color:var(--tx2)">
                    <div style="font-size:2rem;margin-bottom:12px">‚ú®</div>
                    <div>Aktif oturum bulunamadƒ±</div>
                </div>
            `;
            return;
        }
        
        let html = `
            <div style="overflow-x:auto">
                <table style="width:100%;border-collapse:collapse;font-size:.85rem">
                    <thead>
                        <tr style="background:var(--bg3)">
                            <th style="padding:12px;text-align:left;color:var(--tx);font-weight:600;border-bottom:1px solid var(--bg4)">Kullanƒ±cƒ±</th>
                            <th style="padding:12px;text-align:left;color:var(--tx);font-weight:600;border-bottom:1px solid var(--bg4)">Cihaz</th>
                            <th style="padding:12px;text-align:left;color:var(--tx);font-weight:600;border-bottom:1px solid var(--bg4)">IP Adresi</th>
                            <th style="padding:12px;text-align:left;color:var(--tx);font-weight:600;border-bottom:1px solid var(--bg4)">Giri≈ü Zamanƒ±</th>
                            <th style="padding:12px;text-align:left;color:var(--tx);font-weight:600;border-bottom:1px solid var(--bg4)">Son Aktivite</th>
                            <th style="padding:12px;text-align:center;color:var(--tx);font-weight:600;border-bottom:1px solid var(--bg4)">ƒ∞≈ülem</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        snapshot.forEach(doc => {
            const s = doc.data();
            const startedAt = s.startedAt?.toDate?.() ? s.startedAt.toDate().toLocaleString('tr-TR') : '-';
            const lastActivity = s.lastActivity?.toDate?.() ? formatTimeAgo(s.lastActivity.toDate()) : '-';
            const isCurrentSession = currentUser?.sessionId === doc.id;
            
            html += `
                <tr style="border-bottom:1px solid var(--bg4);transition:background .2s" onmouseover="this.style.background='var(--bg3)'" onmouseout="this.style.background='transparent'">
                    <td style="padding:12px">
                        <div style="display:flex;align-items:center;gap:10px">
                            <div style="width:32px;height:32px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:.8rem">
                                ${(s.userName || 'U').charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div style="color:var(--tx);font-weight:500">${s.userName || s.userEmail || '-'}</div>
                                <div style="font-size:.75rem;color:var(--tx3)">${s.userRole || '-'}</div>
                            </div>
                        </div>
                    </td>
                    <td style="padding:12px">
                        <div style="display:flex;align-items:center;gap:6px">
                            <span>${getDeviceIcon(s.device)}</span>
                            <span style="color:var(--tx2)">${s.device || 'Bilinmiyor'}</span>
                        </div>
                    </td>
                    <td style="padding:12px;color:var(--tx2);font-family:var(--mono);font-size:.8rem">${s.ip || '-'}</td>
                    <td style="padding:12px;color:var(--tx2)">${startedAt}</td>
                    <td style="padding:12px">
                        <span style="display:inline-flex;align-items:center;gap:4px;padding:4px 10px;background:rgba(39,174,96,.15);color:#27ae60;border-radius:20px;font-size:.75rem">
                            <span style="width:6px;height:6px;background:#27ae60;border-radius:50%;animation:pulse 2s infinite"></span>
                            ${lastActivity}
                        </span>
                    </td>
                    <td style="padding:12px;text-align:center">
                        ${isCurrentSession ? 
                            `<button onclick="terminateSession('${doc.id}')" style="background:rgba(243,156,18,.1);border:1px solid rgba(243,156,18,.3);color:#f39c12;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:.8rem;transition:all .2s" onmouseover="this.style.background='rgba(243,156,18,.2)'" onmouseout="this.style.background='rgba(243,156,18,.1)'">‚ö†Ô∏è √áƒ±kƒ±≈ü Yap</button>` :
                            `<button onclick="terminateSession('${doc.id}')" style="background:rgba(231,76,60,.1);border:none;color:#e74c3c;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:.8rem;transition:all .2s" onmouseover="this.style.background='rgba(231,76,60,.2)'" onmouseout="this.style.background='rgba(231,76,60,.1)'">üö´ Sonlandƒ±r</button>`
                        }
                    </td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Oturum y√ºkleme hatasƒ±:', error);
        container.innerHTML = `
            <div style="text-align:center;padding:40px;color:var(--red)">
                <div style="font-size:2rem;margin-bottom:12px">‚ö†Ô∏è</div>
                <div>Y√ºkleme hatasƒ±: ${error.message}</div>
            </div>
        `;
    }
}

// Oturum ge√ßmi≈üini y√ºkle
async function loadSessionHistory() {
    const container = document.getElementById('sessionHistoryList');
    if (!container) return;
    
    try {
        const snapshot = await db.collection('sessions')
            .orderBy('startedAt', 'desc')
            .limit(20)
            .get();
        
        if (snapshot.empty) {
            container.innerHTML = `
                <div style="text-align:center;padding:40px;color:var(--tx2)">
                    <div style="font-size:2rem;margin-bottom:12px">üìä</div>
                    <div>Hen√ºz oturum ge√ßmi≈üi yok</div>
                </div>
            `;
            return;
        }
        
        let html = '<div style="display:flex;flex-direction:column;gap:8px">';
        
        snapshot.forEach(doc => {
            const s = doc.data();
            const startedAt = s.startedAt?.toDate?.() ? s.startedAt.toDate().toLocaleString('tr-TR') : '-';
            const statusColor = s.status === 'active' ? '#27ae60' : (s.status === 'timeout' ? '#f39c12' : '#95a5a6');
            const statusText = s.status === 'active' ? 'Aktif' : (s.status === 'timeout' ? 'Zaman A≈üƒ±mƒ±' : 'Sonlandƒ±');
            const statusIcon = s.status === 'active' ? 'üü¢' : (s.status === 'timeout' ? 'üü°' : '‚ö™');
            
            html += `
                <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--bg3);border-radius:10px">
                    <div style="display:flex;align-items:center;gap:12px">
                        <span>${statusIcon}</span>
                        <div>
                            <div style="font-weight:500;color:var(--tx)">${s.userName || s.userEmail || '-'}</div>
                            <div style="font-size:.75rem;color:var(--tx3)">${s.device || 'Bilinmiyor'} ‚Ä¢ ${s.ip || '-'}</div>
                        </div>
                    </div>
                    <div style="text-align:right">
                        <div style="font-size:.8rem;color:var(--tx2)">${startedAt}</div>
                        <div style="font-size:.75rem;color:${statusColor}">${statusText}</div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Oturum ge√ßmi≈üi y√ºkleme hatasƒ±:', error);
    }
}

// Oturum sonlandƒ±r
async function terminateSession(sessionId) {
    // Kendi oturumunu mu sonlandƒ±rƒ±yor?
    const isOwnSession = sessionId === currentUser?.sessionId;
    
    if (isOwnSession) {
        if (!confirm('KENDƒ∞ OTURUMUNUZU sonlandƒ±rmak √ºzeresiniz. √áƒ±kƒ±≈ü yapƒ±lacak. Devam etmek istiyor musunuz?')) return;
    } else {
        if (!confirm('Bu oturumu sonlandƒ±rmak istediƒüinize emin misiniz?')) return;
    }
    
    try {
        await db.collection('sessions').doc(sessionId).update({
            status: 'terminated',
            endedAt: firebase.firestore.FieldValue.serverTimestamp(),
            terminatedBy: currentUser?.id || 'admin'
        });
        
        if (isOwnSession) {
            // Kendi oturumunu sonlandƒ±rdƒ± - logout yap
            toast('Oturumunuz sonlandƒ±rƒ±ldƒ±, √ßƒ±kƒ±≈ü yapƒ±lƒ±yor...', 'warning');
            setTimeout(() => logout(), 1000);
        } else {
            toast('Oturum sonlandƒ±rƒ±ldƒ±', 'success');
            loadActiveSessions();
            loadSessionHistory();
        }
    } catch (error) {
        console.error('Oturum sonlandƒ±rma hatasƒ±:', error);
        toast('Sonlandƒ±rma hatasƒ±!', 'error');
    }
}

// T√ºm oturumlarƒ± sonlandƒ±r (≈üifre deƒüi≈üikliƒüinde)
async function terminateAllSessions(userId, exceptCurrentSession = true) {
    try {
        const snapshot = await db.collection('sessions')
            .where('userId', '==', userId)
            .where('status', '==', 'active')
            .get();
        
        const batch = db.batch();
        snapshot.forEach(doc => {
            if (exceptCurrentSession && doc.id === currentUser?.sessionId) return;
            batch.update(doc.ref, {
                status: 'terminated',
                endedAt: firebase.firestore.FieldValue.serverTimestamp(),
                terminatedBy: 'password_change'
            });
        });
        
        await batch.commit();
        return true;
    } catch (error) {
        console.error('Toplu oturum sonlandƒ±rma hatasƒ±:', error);
        return false;
    }
}

// Session ge√ßerliliƒüini kontrol et
async function checkSessionValidity() {
    if (!currentUser) return false;
    
    try {
        // LocalStorage'dan session ID'yi al
        const storedSessionId = localStorage.getItem('mb_session_id');
        
        if (!storedSessionId) {
            // Session ID yok - yeni session olu≈ütur
            const newSessionId = await createSession();
            if (newSessionId) {
                localStorage.setItem('mb_session_id', newSessionId);
                return true;
            }
            return false;
        }
        
        // Session durumunu kontrol et
        const sessionDoc = await db.collection('sessions').doc(storedSessionId).get();
        
        if (!sessionDoc.exists) {
            // Session bulunamadƒ± - yeni olu≈ütur
            localStorage.removeItem('mb_session_id');
            const newSessionId = await createSession();
            if (newSessionId) {
                localStorage.setItem('mb_session_id', newSessionId);
                return true;
            }
            return false;
        }
        
        const sessionData = sessionDoc.data();
        
        // Session sonlandƒ±rƒ±lmƒ±≈ü mƒ±?
        if (sessionData.status === 'terminated' || sessionData.status === 'forced_logout' || sessionData.status === 'ended') {
            console.log('Session was terminated:', sessionData.status);
            localStorage.removeItem('mb_session_id');
            return false;
        }
        
        // Session bu kullanƒ±cƒ±ya mƒ± ait?
        if (sessionData.userId !== currentUser.id) {
            console.log('Session belongs to different user');
            localStorage.removeItem('mb_session_id');
            return false;
        }
        
        // Session ge√ßerli
        currentUser.sessionId = storedSessionId;
        return true;
        
    } catch (error) {
        console.error('Session validity check error:', error);
        return true; // Hata durumunda devam et
    }
}

// Yeni oturum ba≈ülat
async function createSession() {
    if (!currentUser) return null;
    
    const sessionId = 'S' + Date.now() + Math.random().toString(36).substr(2, 9);
    const deviceInfo = getDeviceInfo();
    
    try {
        // Tek cihaz politikasƒ± kontrol√º
        const settingsDoc = await db.collection('settings').doc('session').get();
        if (settingsDoc.exists && settingsDoc.data().singleDevice) {
            // Bu kullanƒ±cƒ±nƒ±n diƒüer aktif oturumlarƒ±nƒ± sonlandƒ±r
            const existingSessions = await db.collection('sessions')
                .where('userId', '==', currentUser.id)
                .where('status', '==', 'active')
                .get();
            
            const batch = db.batch();
            existingSessions.forEach(doc => {
                batch.update(doc.ref, {
                    status: 'forced_logout',
                    endedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    terminatedBy: 'single_device_policy'
                });
            });
            await batch.commit();
        }
        
        await db.collection('sessions').doc(sessionId).set({
            userId: currentUser.id,
            userEmail: currentUser.email,
            userName: currentUser.name,
            userRole: currentUser.role,
            device: deviceInfo.device,
            browser: deviceInfo.browser,
            ip: await getClientIP(),
            status: 'active',
            startedAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastActivity: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        currentUser.sessionId = sessionId;
        localStorage.setItem('mb_session_id', sessionId);
        return sessionId;
    } catch (error) {
        console.error('Oturum olu≈üturma hatasƒ±:', error);
        return null;
    }
}

// Oturum aktivitesini g√ºncelle
async function updateSessionActivity() {
    if (!currentUser?.sessionId) return;
    
    try {
        await db.collection('sessions').doc(currentUser.sessionId).update({
            lastActivity: firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch (error) {
        console.error('Aktivite g√ºncelleme hatasƒ±:', error);
    }
}

// Periyodik aktivite g√ºncellemesi (5 dakikada bir)
setInterval(() => {
    if (currentUser?.sessionId) {
        updateSessionActivity();
    }
}, 5 * 60 * 1000);

// Cihaz bilgisi al
function getDeviceInfo() {
    const ua = navigator.userAgent;
    let device = 'Bilinmiyor';
    let browser = 'Bilinmiyor';
    
    // Cihaz
    if (/iPhone/i.test(ua)) device = 'iPhone';
    else if (/iPad/i.test(ua)) device = 'iPad';
    else if (/Android/i.test(ua)) device = 'Android';
    else if (/Windows/i.test(ua)) device = 'Windows PC';
    else if (/Mac/i.test(ua)) device = 'Mac';
    else if (/Linux/i.test(ua)) device = 'Linux';
    
    // Tarayƒ±cƒ±
    if (/Chrome/i.test(ua)) browser = 'Chrome';
    else if (/Firefox/i.test(ua)) browser = 'Firefox';
    else if (/Safari/i.test(ua)) browser = 'Safari';
    else if (/Edge/i.test(ua)) browser = 'Edge';
    
    return { device: device + ' / ' + browser, browser };
}

function getDeviceIcon(device) {
    if (!device) return 'üíª';
    const d = device.toLowerCase();
    if (d.includes('iphone') || d.includes('android')) return 'üì±';
    if (d.includes('ipad') || d.includes('tablet')) return 'üì±';
    if (d.includes('mac')) return 'üñ•Ô∏è';
    if (d.includes('windows')) return 'üíª';
    if (d.includes('linux')) return 'üêß';
    return 'üíª';
}

// IP adresi al (basit yakla≈üƒ±m)
async function getClientIP() {
    try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
    } catch {
        return 'Bilinmiyor';
    }
}

// Zaman formatlama
function formatTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    
    if (diffMins < 1) return 'Az √∂nce';
    if (diffMins < 60) return `${diffMins} dk √∂nce`;
    if (diffHours < 24) return `${diffHours} saat √∂nce`;
    return date.toLocaleDateString('tr-TR');
}

// ==================== PUANTAJ KURALLARI (ADMIN) ====================
async function loadPuantajRulesAdmin() {
    const container = document.getElementById('puantajRulesList');
    if (!container) return;
    
    try {
        const snapshot = await db.collection('puantajRules').get();
        
        if (snapshot.empty) {
            container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--tx2)">Hen√ºz kural tanƒ±mlanmamƒ±≈ü</div>';
            return;
        }
        
        let html = '';
        
        // Kurallarƒ± kategoriye g√∂re grupla
        const ihlaller = [];
        const basarilar = [];
        
        snapshot.forEach(doc => {
            const r = { id: doc.id, ...doc.data() };
            if (r.effect && r.effect.includes('+')) {
                basarilar.push(r);
            } else {
                ihlaller.push(r);
            }
        });
        
        // ƒ∞hlaller
        if (ihlaller.length > 0) {
            html += `<div style="margin-bottom:20px">
                <div style="font-size:.85rem;font-weight:600;color:#e74c3c;margin-bottom:12px;display:flex;align-items:center;gap:8px">
                    <span>‚ö†Ô∏è</span> ƒ∞hlal Kurallarƒ±
                </div>`;
            ihlaller.forEach(r => {
                const starCount = r.star || 1;
                const stars = '‚≠ê'.repeat(starCount);
                const effectColor = r.effect === '-3' ? '#c0392b' : (r.effect === '-2' ? '#d35400' : '#f39c12');
                const effectBg = r.effect === '-3' ? 'rgba(192,57,43,.15)' : (r.effect === '-2' ? 'rgba(211,84,0,.15)' : 'rgba(243,156,18,.15)');
                html += `
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:14px;background:rgba(231,76,60,.05);border:1px solid rgba(231,76,60,.15);border-radius:12px;margin-bottom:8px">
                        <div style="flex:1">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:4px;flex-wrap:wrap">
                                <span style="font-size:1rem">${stars}</span>
                                <span style="font-weight:600;color:var(--tx)">${r.title}</span>
                                <span style="font-size:.8rem;background:${effectBg};color:${effectColor};padding:4px 12px;border-radius:20px;font-weight:600">${r.effect} Puan</span>
                            </div>
                            ${r.desc ? `<div style="font-size:.8rem;color:var(--tx3);margin-top:4px">${r.desc}</div>` : ''}
                        </div>
                        <div style="display:flex;gap:6px">
                            <button onclick="editPuantajRule('${r.id}')" style="background:var(--bg3);border:none;color:var(--tx);padding:8px 14px;border-radius:8px;cursor:pointer;font-size:.8rem;transition:all .2s" onmouseover="this.style.background='var(--bg4)'" onmouseout="this.style.background='var(--bg3)'">‚úèÔ∏è D√ºzenle</button>
                            <button onclick="deletePuantajRule('${r.id}')" style="background:rgba(255,107,107,.1);border:none;color:#e74c3c;padding:8px 14px;border-radius:8px;cursor:pointer;font-size:.8rem;transition:all .2s" onmouseover="this.style.background='rgba(255,107,107,.2)'" onmouseout="this.style.background='rgba(255,107,107,.1)'">üóëÔ∏è Sil</button>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;
        }
        
        // Ba≈üarƒ±lar
        if (basarilar.length > 0) {
            html += `<div>
                <div style="font-size:.85rem;font-weight:600;color:#27ae60;margin-bottom:12px;display:flex;align-items:center;gap:8px">
                    <span>üèÜ</span> Ba≈üarƒ± Kurallarƒ±
                </div>`;
            basarilar.forEach(r => {
                const starCount = r.star || 4;
                const stars = '‚≠ê'.repeat(starCount);
                const effectColor = r.effect === '+2' ? '#27ae60' : '#2ecc71';
                const effectBg = r.effect === '+2' ? 'rgba(39,174,96,.15)' : 'rgba(46,204,113,.15)';
                html += `
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:14px;background:rgba(39,174,96,.05);border:1px solid rgba(39,174,96,.15);border-radius:12px;margin-bottom:8px">
                        <div style="flex:1">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:4px;flex-wrap:wrap">
                                <span style="font-size:1rem">${stars}</span>
                                <span style="font-weight:600;color:var(--tx)">${r.title}</span>
                                <span style="font-size:.8rem;background:${effectBg};color:${effectColor};padding:4px 12px;border-radius:20px;font-weight:600">${r.effect} Puan</span>
                            </div>
                            ${r.desc ? `<div style="font-size:.8rem;color:var(--tx3);margin-top:4px">${r.desc}</div>` : ''}
                        </div>
                        <div style="display:flex;gap:6px">
                            <button onclick="editPuantajRule('${r.id}')" style="background:var(--bg3);border:none;color:var(--tx);padding:8px 14px;border-radius:8px;cursor:pointer;font-size:.8rem;transition:all .2s" onmouseover="this.style.background='var(--bg4)'" onmouseout="this.style.background='var(--bg3)'">‚úèÔ∏è D√ºzenle</button>
                            <button onclick="deletePuantajRule('${r.id}')" style="background:rgba(255,107,107,.1);border:none;color:#e74c3c;padding:8px 14px;border-radius:8px;cursor:pointer;font-size:.8rem;transition:all .2s" onmouseover="this.style.background='rgba(255,107,107,.2)'" onmouseout="this.style.background='rgba(255,107,107,.1)'">üóëÔ∏è Sil</button>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;
        }
        
        container.innerHTML = html;
    } catch (error) {
        console.error('Kural y√ºkleme hatasƒ±:', error);
    }
}

function showAddPuantajRuleModal(editId = null) {
    const isEdit = !!editId;
    const title = isEdit ? 'Kural D√ºzenle' : 'Yeni Puantaj Kuralƒ±';
    
    const body = `
        <input type="hidden" id="ruleEditId" value="${editId || ''}">
        <div class="form-grid">
            <div class="form-group full">
                <label class="form-label">Kural Ba≈ülƒ±ƒüƒ± *</label>
                <input type="text" id="ruleTitle" class="form-input" placeholder="√ñrn: Check listi yanlƒ±≈ü i≈üaretleme, Ge√ß kalma vb.">
            </div>
            <div class="form-group">
                <label class="form-label">Kategori *</label>
                <select id="ruleCategory" class="form-select">
                    <option value="ihlal">‚ö†Ô∏è ƒ∞hlal (Negatif)</option>
                    <option value="basari">üèÜ Ba≈üarƒ± (Pozitif)</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Puan Etkisi *</label>
                <select id="ruleEffect" class="form-select">
                    <optgroup label="‚îÄ‚îÄ Negatif (ƒ∞hlaller) ‚îÄ‚îÄ">
                        <option value="-3">‚≠ê Ciddi ƒ∞hlal (-3 Puan)</option>
                        <option value="-2">‚≠ê‚≠ê Orta ƒ∞hlal (-2 Puan)</option>
                        <option value="-1">‚≠ê‚≠ê‚≠ê Hafif Uyarƒ± (-1 Puan)</option>
                    </optgroup>
                    <optgroup label="‚îÄ‚îÄ Pozitif (Ba≈üarƒ±lar) ‚îÄ‚îÄ">
                        <option value="+1">‚≠ê‚≠ê‚≠ê‚≠ê ƒ∞yi Performans (+1 Puan)</option>
                        <option value="+2">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê M√ºkemmel (+2 Puan)</option>
                    </optgroup>
                </select>
            </div>
            <div class="form-group full">
                <label class="form-label">A√ßƒ±klama</label>
                <textarea id="ruleDesc" class="form-textarea" rows="3" placeholder="Kuralƒ±n detaylƒ± a√ßƒ±klamasƒ±..." style="resize:vertical"></textarea>
            </div>
        </div>
        <div style="background:var(--bg3);border-radius:10px;padding:12px;margin-top:16px">
            <div style="font-size:.8rem;color:var(--tx2);display:flex;align-items:center;gap:8px">
                <span style="font-size:1.1rem">üí°</span>
                <span>Bu kural, ƒ∞hlal/Ba≈üarƒ± kaydederken se√ßilebilir olacak ve otomatik puan hesaplamasƒ±nƒ± etkileyecek.</span>
            </div>
        </div>
    `;
    
    const footer = `
        <button class="btn btn-ghost" onclick="closeModal()">ƒ∞ptal</button>
        <button class="btn btn-primary" onclick="savePuantajRule()">üíæ Kaydet</button>
    `;
    
    showModal(title, body, footer);
    
    if (isEdit) {
        loadPuantajRuleForEdit(editId);
    }
}

async function loadPuantajRuleForEdit(id) {
    try {
        const doc = await db.collection('puantajRules').doc(id).get();
        if (doc.exists) {
            const r = doc.data();
            document.getElementById('ruleTitle').value = r.title || '';
            document.getElementById('ruleCategory').value = r.category || 'ihlal';
            document.getElementById('ruleEffect').value = r.effect || '-1';
            document.getElementById('ruleDesc').value = r.desc || '';
        }
    } catch (error) {
        console.error('Kural y√ºkleme hatasƒ±:', error);
    }
}

async function savePuantajRule() {
    const editId = document.getElementById('ruleEditId').value;
    const title = document.getElementById('ruleTitle').value.trim();
    const category = document.getElementById('ruleCategory').value;
    const effect = document.getElementById('ruleEffect').value;
    const desc = document.getElementById('ruleDesc').value.trim();
    
    if (!title) {
        toast('Ba≈ülƒ±k zorunludur', 'error');
        return;
    }
    
    // Yƒ±ldƒ±z sayƒ±sƒ±nƒ± etkiden hesapla
    let star = 3;
    if (effect === '-3') star = 1;
    else if (effect === '-2') star = 2;
    else if (effect === '-1') star = 3;
    else if (effect === '+1') star = 4;
    else if (effect === '+2') star = 5;
    
    const data = { title, category, star, effect, desc, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
    
    try {
        if (editId) {
            await db.collection('puantajRules').doc(editId).update(data);
            toast('Kural g√ºncellendi', 'success');
        } else {
            const newId = 'R' + Date.now();
            await db.collection('puantajRules').doc(newId).set(data);
            toast('Kural eklendi', 'success');
        }
        closeModal();
        loadPuantajRules();
    } catch (error) {
        console.error('Kayƒ±t hatasƒ±:', error);
        toast('Kayƒ±t hatasƒ±!', 'error');
    }
}

function editPuantajRule(id) {
    showAddPuantajRuleModal(id);
}

async function deletePuantajRule(id) {
    confirmModal('Kural Sil', 'Bu kuralƒ± silmek istediƒüinize emin misiniz?', async () => {
        try {
            await db.collection('puantajRules').doc(id).delete();
            toast('Kural silindi', 'success');
            loadPuantajRules();
        } catch (error) {
            console.error('Silme hatasƒ±:', error);
            toast('Silme hatasƒ±!', 'error');
        }
    });
}

// ==================== ADMIN RENDER OVERRIDE ====================
const originalRenderAdminLists = renderAdminLists;
renderAdminLists = function() {
    originalRenderAdminLists();
    loadUserList();
    loadPuantajRulesAdmin();
    
    // Y√∂netici deƒüilse ≈üirket bilgilerini ve ≈üifre deƒüi≈ütirmeyi gizle
    if (currentUser && currentUser.role !== 'yonetici') {
        const companyCard = document.getElementById('companySettingsCard');
        if (companyCard) companyCard.style.display = 'none';
        const passwordCard = document.getElementById('adminPasswordCard');
        if (passwordCard) passwordCard.style.display = 'none';
    } else {
        const passwordCard = document.getElementById('adminPasswordCard');
        if (passwordCard) passwordCard.style.display = 'block';
    }
};

// ==================== DARK MODE ====================
function toggleDarkMode() {
    const html = document.documentElement;
    const isDark = html.getAttribute('data-theme') === 'dark';
    const newTheme = isDark ? 'light' : 'dark';
    html.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateDarkModeIcon(newTheme);
}

function updateDarkModeIcon(theme) {
    const icon = document.getElementById('darkModeIcon');
    const btn = document.getElementById('darkModeBtn');
    if (!icon) return;
    if (theme === 'dark') {
        icon.innerHTML = '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
        if (btn) { btn.style.background = 'var(--bg3)'; btn.style.borderColor = 'var(--bg4)'; }
    } else {
        icon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';
        if (btn) { btn.style.background = 'var(--surface2)'; btn.style.borderColor = 'var(--surface3)'; }
    }
    // Logo g√ºncelle (Dark: beyaz logo, Light: renkli logo)
    updateLogos(theme);
}

function updateLogos(theme) {
    const darkLogo = 'https://static.wixstatic.com/media/760af2_cb121a61291f4f07adb48cfb70f3e2d9~mv2.png/v1/fill/w_94,h_82,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/beyazwhitelogo-min1.png';
    const lightLogo = 'https://static.wixstatic.com/media/760af2_755f54f13b654f1bb318c97f16a029a3~mv2.png/v1/fill/w_104,h_92,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/Moonberry%20Coffee%20Logo.png';
    
    // Login logo (tema ile deƒüi≈üir)
    const loginLogo = document.getElementById('loginLogo');
    if (loginLogo) {
        loginLogo.src = theme === 'dark' ? darkLogo : lightLogo;
    }
    
    // Breadcrumb logo (tema ile deƒüi≈üir - ana i√ßerik alanƒ±nda)
    const breadcrumbLogo = document.getElementById('breadcrumbLogo');
    if (breadcrumbLogo) {
        breadcrumbLogo.src = theme === 'dark' ? darkLogo : lightLogo;
    }
    
    // Sidebar logo her zaman beyaz kalƒ±r (koyu arka plan)
}

// Dark mode init
(function() {
    const saved = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', saved);
    setTimeout(() => updateDarkModeIcon(saved), 100);
})();

// ==================== ADMIN ≈ûƒ∞FRE DEƒûƒ∞≈ûTƒ∞RME ====================
async function updateAdminCredentials() {
    const newUsername = document.getElementById('admin_new_username').value.trim();
    const newPassword = document.getElementById('admin_new_password').value;
    const confirmPassword = document.getElementById('admin_confirm_password').value;
    
    if (!newUsername && !newPassword) { toast('En az bir alan doldurun', 'error'); return; }
    if (newPassword && newPassword !== confirmPassword) { toast('≈ûifreler e≈üle≈ümiyor', 'error'); return; }
    if (newPassword && newPassword.length < 4) { toast('≈ûifre en az 4 karakter olmalƒ±', 'error'); return; }
    
    try {
        const updateData = {};
        if (newUsername) updateData.username = newUsername;
        if (newPassword) updateData.password = newPassword;
        await db.collection('users').doc('admin').update(updateData);
        toast('Giri≈ü bilgileri g√ºncellendi', 'success');
        document.getElementById('admin_new_username').value = '';
        document.getElementById('admin_new_password').value = '';
        document.getElementById('admin_confirm_password').value = '';
    } catch (e) { console.error(e); toast('G√ºncelleme hatasƒ±!', 'error'); }
}

// ==================== SHIFT Sƒ∞STEMƒ∞ ====================
// Shift tipleri ve saat aralƒ±klarƒ±
const SHIFT_TYPES = ['A√áILI≈û', 'ARA', 'KAPANI≈û', 'OFF', 'Y.ƒ∞', 'B√ñLGE M√úD√úR√ú'];
const COMMON_TIMES = [
    '10:00/19:00', '11:00/20:00', '12:00/21:00', '13:00/22:00', 
    '14:00/23:00', '15:00/00:00'
];

// Hafta label'ƒ±na yƒ±l ekle
function formatWeekWithYear(weekLabel, weekStart) {
    if (!weekStart) return weekLabel || 'Tarih Yok';
    const year = weekStart.split('-')[0];
    const label = weekLabel || weekStart;
    // Eƒüer label zaten yƒ±lƒ± i√ßeriyorsa ekleme
    if (label.includes(year) || label.includes('2024') || label.includes('2025') || label.includes('2026')) {
        return label;
    }
    return `${label} (${year})`;
}
// Part-time saat se√ßenekleri (10:00 - 00:00 arasƒ± t√ºm saatler)
const PARTTIME_START = ['10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00', '21:00', '22:00', '23:00'];
const PARTTIME_END = ['11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00', '21:00', '22:00', '23:00', '00:00'];

// Excel renkleri (ger√ßek Excel'den alƒ±ndƒ±)
const SHIFT_COLORS = {
    'A√áILI≈û':  { bg: '#99CCFF', border: '#6699CC', text: '#003366' },  // Mavi
    'ARA':     { bg: '#FFFF99', border: '#CCCC00', text: '#666600' },  // Sarƒ±
    'KAPANI≈û': { bg: '#FFC000', border: '#CC9900', text: '#663300' },  // Turuncu
    'OFF':     { bg: '#FF6666', border: '#CC0000', text: '#FFFFFF' },  // Kƒ±rmƒ±zƒ±
    'Y.ƒ∞':     { bg: '#D9EAD3', border: '#6AA84F', text: '#274E13' },  // Ye≈üil
    'B√ñLGE M√úD√úR√ú': { bg: '#E1BEE7', border: '#9C27B0', text: '#6A1B9A' },  // Mor
    'TUZLA':   { bg: '#E6B8AF', border: '#CC4125', text: '#660000' },  // Kƒ±rmƒ±zƒ±msƒ±
    'B√ñLGE':   { bg: '#B4A7D6', border: '#8E7CC3', text: '#351C75' },  // Mor (eski)
    'RAPOR':   { bg: '#F4CCCC', border: '#E06666', text: '#990000' },  // A√ßƒ±k kƒ±rmƒ±zƒ±
    'default': { bg: '#F3F3F3', border: '#CCCCCC', text: '#333333' }   // Varsayƒ±lan
};

// Shift duyurularƒ± (Excel'den)
const SHIFT_ANNOUNCEMENTS = [
    { text: 'A√áILI≈û PERSONELƒ∞ ƒ∞≈ûE GE√á KALMAMALIDIR!', color: '#2E7D32', bg: '#C6EFCE' },
    { text: 'ƒ∞Zƒ∞N G√úN√ú YOKSA; YEMEK VE MOLA S√úRESƒ∞ SE√áƒ∞Mƒ∞ PERSONELƒ∞N KENDƒ∞ SE√áƒ∞Mƒ∞NDEDƒ∞R.', color: '#2E7D32', bg: '#C6EFCE' },
    { text: "SHIFT'E YILDIZ (*) SEMBOL√ú OLAN G√úNLER √ñZEL ƒ∞STEK G√úNLERƒ∞Dƒ∞R.", color: '#9C5700', bg: '#FFEB9C' },
    { text: 'KAPANI≈ûTAN A√áILI≈û GELECEK PERSONEL Y√ñNETƒ∞Cƒ∞LERƒ∞Nƒ∞ UYARACAK!', color: '#C00000', bg: '#FFC7CE' }
];

async function loadShiftList() {
    const subeSelect = document.getElementById('shiftSube');
    const haftaSelect = document.getElementById('shiftHafta');
    const historyContainer = document.getElementById('shiftHistoryContainer');
    
    if (!subeSelect || !haftaSelect) return;
    
    const selectedSube = subeSelect.value;
    if (!selectedSube) {
        haftaSelect.innerHTML = '<option value="">-- √ñnce Maƒüaza Se√ßin --</option>';
        if (historyContainer) historyContainer.innerHTML = '<p style="color:var(--tx2);text-align:center;padding:20px">Maƒüaza se√ßerek ge√ßmi≈ü shiftleri g√∂r√ºnt√ºleyin.</p>';
        return;
    }
    
    haftaSelect.innerHTML = '<option value="">‚è≥ Y√ºkleniyor...</option>';
    if (historyContainer) historyContainer.innerHTML = '<p style="color:var(--tx2);text-align:center;padding:20px">‚è≥ Y√ºkleniyor...</p>';
    
    try {
        const snapshot = await db.collection('shifts').get();
        const weeks = [];
        
        snapshot.forEach(doc => {
            const d = doc.data();
            if (d.branch === selectedSube) {
                weeks.push({ id: doc.id, ...d });
            }
        });
        
        // Tarihe g√∂re sƒ±rala (en yeni √∂nce)
        weeks.sort((a, b) => (b.weekStart || '').localeCompare(a.weekStart || ''));
        
        // Hafta dropdown'ƒ±nƒ± doldur
        if (weeks.length === 0) {
            haftaSelect.innerHTML = '<option value="">-- Kayƒ±tlƒ± shift yok --</option>';
        } else {
            haftaSelect.innerHTML = '<option value="">-- Hafta Se√ßin (' + weeks.length + ' kayƒ±t) --</option>';
            weeks.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w.id;
                const cnt = Object.keys(w.personelShifts || {}).length;
                opt.textContent = formatWeekWithYear(w.weekLabel, w.weekStart) + ' (' + cnt + ' ki≈üi)';
                haftaSelect.appendChild(opt);
            });
        }
        
        // Ge√ßmi≈ü shiftleri g√∂ster
        renderShiftHistory(weeks, selectedSube);
        
    } catch (e) { 
        console.error('Shift y√ºkleme hatasƒ±:', e); 
        haftaSelect.innerHTML = '<option value="">-- Y√ºkleme hatasƒ± --</option>';
        if (historyContainer) historyContainer.innerHTML = '<p style="color:var(--red);text-align:center;padding:20px">‚ùå Y√ºkleme hatasƒ±: ' + e.message + '</p>';
        toast('Shift listesi y√ºklenemedi: ' + e.message, 'error');
    }
}

function renderShiftHistory(weeks, branch, showAll = false) {
    const container = document.getElementById('shiftHistoryContainer');
    if (!container) return;
    
    if (!weeks || weeks.length === 0) {
        container.innerHTML = `
            <div style="text-align:center;padding:40px;background:var(--bg2);border-radius:12px">
                <div style="font-size:3rem;margin-bottom:12px">üìã</div>
                <div style="color:var(--tx2);margin-bottom:8px">Bu maƒüazada hen√ºz shift kaydƒ± yok.</div>
                <button class="btn btn-primary btn-sm" onclick="showNewShiftModal()" style="margin-top:12px">+ ƒ∞lk Shift'i Olu≈ütur</button>
            </div>`;
        return;
    }
    
    // G√∂sterilecek hafta sayƒ±sƒ±
    const displayWeeks = showAll ? weeks : weeks.slice(0, 3);
    const hasMore = weeks.length > 3 && !showAll;
    
    // Global'e kaydet (Daha Fazla i√ßin)
    window._allShiftWeeks = weeks;
    window._shiftBranch = branch;
    
    let html = `
        <div style="margin-bottom:12px;display:flex;justify-content:space-between;align-items:center">
            <span style="font-size:.85rem;color:var(--tx2)">${branch}</span>
            <span style="font-size:.75rem;color:var(--tx2)">${showAll ? weeks.length : Math.min(3, weeks.length)}/${weeks.length} kayƒ±t</span>
        </div>
        <div style="display:grid;gap:8px">`;
    
    displayWeeks.forEach((w, idx) => {
        const cnt = Object.keys(w.personelShifts || {}).length;
        const isFirst = idx === 0;
        const borderColor = isFirst ? 'var(--accent)' : 'var(--bg4)';
        const badge = isFirst ? '<span style="font-size:.6rem;background:var(--accent);color:#fff;padding:2px 6px;border-radius:4px;margin-left:6px">EN YENƒ∞</span>' : '';
        
        html += `
            <div onclick="selectShift('${w.id}')" 
                 style="display:flex;justify-content:space-between;align-items:center;padding:12px 14px;background:var(--bg3);border:2px solid ${borderColor};border-radius:10px;cursor:pointer;transition:all .2s" 
                 onmouseover="this.style.borderColor='var(--accent)';this.style.transform='translateX(4px)'" 
                 onmouseout="this.style.borderColor='${borderColor}';this.style.transform='none'">
                <div>
                    <div style="font-weight:600;color:var(--tx);font-size:.85rem;display:flex;align-items:center">
                        ${formatWeekWithYear(w.weekLabel, w.weekStart)}${badge}
                    </div>
                    <div style="font-size:.7rem;color:var(--tx2);margin-top:3px">üë• ${cnt} personel</div>
                </div>
                <div style="color:var(--accent);font-size:1.2rem;font-weight:bold">‚Ä∫</div>
            </div>`;
    });
    
    html += '</div>';
    
    // Daha Fazla butonu
    if (hasMore) {
        html += `
            <button onclick="renderShiftHistory(window._allShiftWeeks, window._shiftBranch, true)" 
                    class="btn btn-ghost" style="width:100%;margin-top:12px;font-size:.8rem">
                üìÇ Daha Fazla Y√ºkle (${weeks.length - 3} daha)
            </button>`;
    } else if (showAll && weeks.length > 3) {
        html += `
            <button onclick="renderShiftHistory(window._allShiftWeeks, window._shiftBranch, false)" 
                    class="btn btn-ghost" style="width:100%;margin-top:12px;font-size:.8rem">
                üîº Daha Az G√∂ster
            </button>`;
    }
    
    container.innerHTML = html;
}

function selectShift(shiftId) {
    document.getElementById('shiftHafta').value = shiftId;
    loadShiftWeek();
}

async function loadShiftWeek() {
    const container = document.getElementById('shiftTableContainer');
    const haftaId = document.getElementById('shiftHafta').value;
    
    // Barista i√ßin silme butonunu gizle
    const deleteBtn = document.getElementById('deleteShiftBtn');
    if (deleteBtn) {
        deleteBtn.style.display = currentUser?.role === 'barista' ? 'none' : 'flex';
    }
    
    if (!haftaId) { 
        container.innerHTML = '<p style="color:var(--tx2);text-align:center;padding:40px">‚¨ÜÔ∏è Yukarƒ±dan hafta se√ßin veya yeni hafta olu≈üturun.</p>'; 
        return; 
    }
    
    container.innerHTML = '<p style="color:var(--tx2);text-align:center;padding:40px">‚è≥ Y√ºkleniyor...</p>';
    
    try {
        const doc = await db.collection('shifts').doc(haftaId).get();
        if (!doc.exists) { 
            container.innerHTML = '<p style="color:var(--red);text-align:center;padding:40px">‚ùå Shift bulunamadƒ±.</p>'; 
            return; 
        }
        renderShiftTable(doc.data(), haftaId);
    } catch (e) { 
        console.error('Shift y√ºkleme hatasƒ±:', e); 
        container.innerHTML = `<p style="color:var(--red);text-align:center;padding:40px">‚ùå Y√ºkleme hatasƒ±: ${e.message}</p>`; 
    }
}

function renderShiftTable(shift, docId) {
    const container = document.getElementById('shiftTableContainer');
    const days = ['Pazartesi', 'Salƒ±', '√áar≈üamba', 'Per≈üembe', 'Cuma', 'Cumartesi', 'Pazar'];
    const daysShort = ['Pzt', 'Sal', '√áar', 'Per', 'Cum', 'Cmt', 'Paz'];
    const personelShifts = shift.personelShifts || {};
    
    // Barista kontrol√º - salt okunur mod
    const isBarista = currentUser?.role === 'barista';
    
    // ≈ûube bazlƒ± saat kurallarƒ±
    const isTuzla = (shift.branch || '').toLowerCase().includes('tuzla');
    const saatKurali = isTuzla 
        ? 'A√áILI≈û: 09:50-18:50 | Pzt-Per-Paz KAPANI≈û: 16:00-01:00 | Cum-Cmt KAPANI≈û: 16:30-01:30'
        : 'A√áILI≈û: 09:50-18:50 | KAPANI≈û: 16:30-01:30';
    
    // Sƒ±ralama: personelOrder varsa kullan, yoksa Object.keys
    let personelNames = shift.personelOrder || Object.keys(personelShifts);
    // personelOrder'da olmayan ama personelShifts'te olan isimleri de ekle
    Object.keys(personelShifts).forEach(name => {
        if (!personelNames.includes(name)) personelNames.push(name);
    });
    // personelShifts'te olmayan isimleri √ßƒ±kar
    personelNames = personelNames.filter(name => personelShifts[name]);
    
    const specialRequests = shift.specialRequests || [];
    
    if (personelNames.length === 0) {
        container.innerHTML = `
            <div style="text-align:center;padding:40px">
                <div style="font-size:3rem;margin-bottom:16px">üìã</div>
                <div style="color:var(--tx2);margin-bottom:16px">Bu haftaya hen√ºz personel eklenmemi≈ü.</div>
                <button class="btn btn-primary" onclick="addPersonelToShift('${docId}')">+ Personel Ekle</button>
            </div>`;
        return;
    }
    
    // PDF i√ßin wrapper
    const weekLabelWithYear = formatWeekWithYear(shift.weekLabel, shift.weekStart);
    let html = `<div id="shiftTablePrint">
        <!-- PDF Header (print only) -->
        <div id="shiftPdfHeader" style="display:none;text-align:center;margin-bottom:20px;padding-bottom:16px;border-bottom:2px solid #ff8674">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
                <img src="https://static.wixstatic.com/media/760af2_cb121a61291f4f07adb48cfb70f3e2d9~mv2.png" style="width:45px;height:40px;object-fit:contain" onerror="this.style.display='none'">
                <h2 style="color:#ff8674;margin:0;font-size:1.4rem">Moonberry Coffee - ${shift.branch}</h2>
            </div>
            <p style="color:#666;margin:0;font-size:1rem">Shift Planƒ±: ${weekLabelWithYear}</p>
        </div>
        
        <!-- Shift Tablosu -->
        <div style="overflow-x:auto">
            <table id="shiftMainTable" style="width:100%;border-collapse:collapse;font-size:.85rem;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.1)">
                <thead>
                    <tr style="background:linear-gradient(135deg,#00B050,#008040)">
                        <th style="padding:14px 12px;text-align:left;color:#fff;font-weight:600;font-size:.9rem;border-right:1px solid rgba(255,255,255,.2);background:#00B050">
                            <div style="font-size:.75rem;opacity:.8">SHIFT</div>
                            <div>${weekLabelWithYear}</div>
                        </th>
                        ${days.map((d, i) => `<th style="padding:14px 8px;text-align:center;color:#000;font-weight:600;font-size:.8rem;background:#FFFF00;border:1px solid #ccc">${daysShort[i]}<br><span style="font-size:.65rem;font-weight:400">${d}</span></th>`).join('')}
                    </tr>
                </thead>
                <tbody>`;
    
    personelNames.forEach((name, idx) => {
        const p = personelShifts[name];
        const rowBg = idx % 2 === 0 ? '#fff' : '#f9f9f9';
        html += `<tr style="background:${rowBg}">
            <td style="padding:12px;font-weight:600;color:#333;border:1px solid #ddd;background:#FFFF00;min-width:100px">${name}</td>`;
        
        days.forEach((_, dayIdx) => {
            let val = p[dayIdx] || '';
            // Yƒ±ldƒ±z kontrol√º
            const hasStar = val.includes('*') && !/^\*+$/.test(val);
            const cleanVal = val.replace(/\*/g, '').trim();
            // **** gibi deƒüerler veya bo≈ü = bo≈ü g√∂ster
            const isEmpty = !val || /^\*+$/.test(val.trim());
            const displayVal = isEmpty ? '' : cleanVal;
            const colors = isEmpty ? {bg:'#fff',border:'#ddd',text:'#999'} : getShiftColorExcel(cleanVal);
            
            // OFF g√ºnlerde de yƒ±ldƒ±z g√∂ster
            const isOff = cleanVal.toUpperCase() === 'OFF' || cleanVal.toUpperCase().includes('ƒ∞Zƒ∞N');
            const showStar = hasStar || isOff;
            
            // Yƒ±ldƒ±zlƒ± veya OFF deƒüer i√ßin border
            const borderStyle = showStar ? `3px solid #ff8674` : `2px solid ${colors.border}`;
            const starIndicator = showStar ? '‚≠ê' : '';
            
            html += `<td style="padding:4px;text-align:center;border:1px solid #ddd;min-width:90px">
                <select ${isBarista ? 'disabled' : ''} onchange="updateShiftCell('${docId}','${name}',${dayIdx},this.value)" 
                    style="width:100%;padding:8px 2px;border:${borderStyle};background:${colors.bg};color:${colors.text};border-radius:6px;font-size:.75rem;font-weight:600;cursor:${isBarista ? 'not-allowed' : 'pointer'};text-align:center;${isBarista ? 'opacity:.8;' : ''}">
                    <option value="" ${isEmpty ? 'selected' : ''} style="background:#fff;color:#999"></option>
                    <optgroup label="‚îÄ‚îÄ Shift T√ºrleri ‚îÄ‚îÄ">
                        ${SHIFT_TYPES.map(t => `<option value="${t}" ${displayVal === t && !hasStar ? 'selected' : ''} style="background:${SHIFT_COLORS[t]?.bg || '#fff'};color:${SHIFT_COLORS[t]?.text || '#333'}">${t === 'OFF' ? '‚≠ê ' : ''}${t}</option>`).join('')}
                    </optgroup>
                    <optgroup label="‚îÄ‚îÄ ‚≠ê √ñzel ƒ∞stek ‚îÄ‚îÄ">
                        ${SHIFT_TYPES.filter(t => t !== 'OFF').map(t => `<option value="*${t}" ${displayVal === t && hasStar ? 'selected' : ''} style="background:${SHIFT_COLORS[t]?.bg || '#fff'};color:${SHIFT_COLORS[t]?.text || '#333'}">‚≠ê ${t}</option>`).join('')}
                    </optgroup>
                    <optgroup label="‚îÄ‚îÄ Saatler ‚îÄ‚îÄ">
                        ${COMMON_TIMES.map(t => `<option value="${t}" ${cleanVal === t && !hasStar ? 'selected' : ''}>${t}</option>`).join('')}
                    </optgroup>
                    <optgroup label="‚îÄ‚îÄ ‚≠ê √ñzel Saat ‚îÄ‚îÄ">
                        ${COMMON_TIMES.map(t => `<option value="*${t}" ${cleanVal === t && hasStar ? 'selected' : ''}>‚≠ê ${t}</option>`).join('')}
                    </optgroup>
                    ${cleanVal && !SHIFT_TYPES.includes(displayVal) && !COMMON_TIMES.includes(cleanVal) ? `<option value="${val}" selected style="background:${colors.bg};color:${colors.text};font-weight:700">${starIndicator}${displayVal}</option>` : ''}
                    <optgroup label="‚îÄ‚îÄ Diƒüer ‚îÄ‚îÄ">
                        <option value="parttime">‚è∞ √ñzel Saat Gir...</option>
                    </optgroup>
                </select>
            </td>`;
        });
        html += '</tr>';
    });
    
    html += `</tbody></table></div>`;
    
    // Personel Ekle/√áƒ±kar butonlarƒ± (shift tablosunun hemen altƒ±nda) - Barista i√ßin gizle
    if (!isBarista) {
        html += `<div style="display:flex;gap:10px;margin:16px 0;justify-content:center">
            <button class="btn btn-primary btn-sm" onclick="addPersonelToShift('${docId}')" style="padding:8px 16px;font-size:.8rem">‚ûï Personel Ekle</button>
            <button class="btn btn-ghost btn-sm" onclick="removePersonelFromShiftModal('${docId}')" style="padding:8px 16px;font-size:.8rem">‚ûñ Personel √áƒ±kar</button>
        </div>`;
    }
    
    // Shift Kurallarƒ± b√∂l√ºm√º (d√ºzenlenebilir)
    html += `<div id="shiftAnnouncements" style="margin-top:20px;padding:16px;background:var(--bg2);border-radius:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <div style="font-weight:600;color:var(--tx);font-size:.9rem">üì¢ Shift Kurallarƒ±</div>
            ${!isBarista ? `<button class="btn btn-ghost btn-sm" onclick="editShiftRules('${docId}')" style="padding:4px 10px;font-size:.75rem">‚úèÔ∏è D√ºzenle</button>` : ''}
        </div>
        <div id="shiftRulesContent" style="display:flex;flex-direction:column;gap:8px">
            ${(shift.customRules || SHIFT_ANNOUNCEMENTS).map((a, i) => `
                <div style="padding:10px 14px;background:${a.bg};color:${a.color};border-radius:8px;font-size:.8rem;font-weight:500">
                    ${a.text}
                </div>
            `).join('')}
        </div>
        <div style="margin-top:12px;padding:10px 14px;background:#E3F2FD;color:#1565C0;border-radius:8px;font-size:.8rem">
            <strong>Saat Bilgisi:</strong> ${saatKurali} | *YEMEK: 45DK, MOLA: 1x15DK
        </div>
    </div>`;
    
    // √ñzel istekleri grupla (aynƒ± personel + aynƒ± neden = tek satƒ±r)
    const groupedRequests = {};
    specialRequests.forEach((r, i) => {
        const key = `${r.personel}|||${r.reason}`;
        if (!groupedRequests[key]) {
            groupedRequests[key] = { personel: r.personel, reason: r.reason, days: [], indices: [] };
        }
        if (r.day !== null && r.day !== undefined) {
            groupedRequests[key].days.push(days[r.day]);
        }
        groupedRequests[key].indices.push(i);
    });
    const groupedList = Object.values(groupedRequests);
    
    // √ñzel ƒ∞stek G√ºnleri b√∂l√ºm√º
    html += `<div id="shiftSpecialRequests" style="margin-top:16px;padding:16px;background:#FFF8E1;border:2px solid #FFB300;border-radius:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <div style="font-weight:600;color:#E65100;font-size:.9rem">‚≠ê √ñzel ƒ∞stek G√ºnleri</div>
            ${!isBarista ? `<button class="btn btn-primary btn-sm" onclick="addSpecialRequest('${docId}')" style="padding:4px 10px;font-size:.75rem;background:#FF9800">+ √ñzel ƒ∞stek Ekle</button>` : ''}
        </div>
        <div style="font-size:.75rem;color:#795548;margin-bottom:10px;padding:6px 10px;background:rgba(0,0,0,.05);border-radius:6px">
            SHIFT'E YILDIZ (*) SEMBOL√ú OLAN G√úNLER √ñZEL ƒ∞STEK G√úNLERƒ∞Dƒ∞R.
        </div>
        <div id="specialRequestsList" style="display:flex;flex-direction:column;gap:8px">
            ${groupedList.length > 0 ? groupedList.map((r, gi) => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:#fff;border-radius:8px;border:1px solid #FFB300">
                    <div>
                        <span style="font-weight:600;color:#E65100">${r.personel}</span>
                        <span style="color:#888;margin:0 6px;font-size:.8rem">${r.days.length > 0 ? r.days.join(', ') : 'T√ºm Hafta'}</span>
                        <span style="color:#666;margin:0 4px">‚Üí</span>
                        <span style="color:#333;font-weight:500">${r.reason}</span>
                    </div>
                    ${!isBarista ? `<button onclick="removeSpecialRequestGroup('${docId}', '${r.personel}', '${r.reason}')" style="background:none;border:none;color:#E53935;cursor:pointer;font-size:1rem" title="Bu isteƒüi sil">√ó</button>` : ''}
                </div>
            `).join('') : `
                <div style="text-align:center;padding:16px;color:#795548;font-size:.85rem">
                    Hen√ºz √∂zel istek eklenmemi≈ü.
                </div>
            `}
        </div>
    </div>`;
    
    html += `</div>`; // shiftTablePrint close
    
    container.innerHTML = html;
}

// Excel renk sistemi
function getShiftColorExcel(val) {
    if (!val) return SHIFT_COLORS.default;
    
    // **** gibi deƒüerler OFF olarak kabul edilsin
    if (/^\*+$/.test(val.trim())) return SHIFT_COLORS.OFF;
    
    const upperVal = val.toUpperCase().trim();
    
    // Tam e≈üle≈üme
    if (SHIFT_COLORS[upperVal]) return SHIFT_COLORS[upperVal];
    
    // Kƒ±smi e≈üle≈üme
    if (upperVal.includes('A√áILI≈û') || upperVal.includes('ACILIS')) return SHIFT_COLORS.A√áILI≈û;
    if (upperVal.includes('KAPANI≈û') || (upperVal.includes('KAPANI≈û') || upperVal.includes('KAPANIS'))) return SHIFT_COLORS.KAPANI≈û;
    if (upperVal.includes('OFF') || upperVal.includes('ƒ∞Zƒ∞N') || upperVal.includes('IZIN')) return SHIFT_COLORS.OFF;
    if (upperVal.includes('ARA') || upperVal.includes('ARACI')) return SHIFT_COLORS.ARA;
    if (upperVal.includes('TUZLA')) return SHIFT_COLORS.TUZLA;
    if (upperVal.includes('B√ñLGE M√úD√úR√ú') || upperVal.includes('BOLGE MUDURU')) return SHIFT_COLORS['B√ñLGE M√úD√úR√ú'];
    if (upperVal.includes('B√ñLGE') || upperVal.includes('BOLGE')) return SHIFT_COLORS.B√ñLGE;
    if (upperVal.includes('RAPOR')) return SHIFT_COLORS.RAPOR;
    if (upperVal.includes('Y.ƒ∞') || upperVal.includes('YILLIK')) return SHIFT_COLORS['Y.ƒ∞'];
    
    // Saat formatƒ± (√∂rn: 10:00 - 19:00)
    if (/\d{1,2}:\d{2}/.test(val)) {
        return { bg: '#E8F4FD', border: '#4A90D9', text: '#1E5B94' }; // Mavi tonu
    }
    
    return SHIFT_COLORS.default;
}

// Shift deƒüerini g√∂r√ºnt√ºleme formatƒ±na √ßevir (**** -> OFF)
function formatShiftValue(val) {
    if (!val) return '';
    if (/^\*+$/.test(val.trim())) return 'OFF';
    return val;
}

async function updateShiftCell(docId, name, dayIdx, value, keepStar = false) {
    if (value === 'parttime') { 
        // Part-time saat se√ßici modal
        const startOpts = PARTTIME_START.map(t => `<option value="${t}">${t}</option>`).join('');
        const endOpts = PARTTIME_END.map(t => `<option value="${t}">${t}</option>`).join('');
        
        showModal('√ñzel Saat Gir', `
            <div style="padding:8px 0">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                    <div class="form-group">
                        <label class="form-label">Ba≈ülangƒ±√ß</label>
                        <select id="parttimeStart" class="form-select" style="font-size:1rem">${startOpts}</select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Biti≈ü</label>
                        <select id="parttimeEnd" class="form-select" style="font-size:1rem">${endOpts}</select>
                    </div>
                </div>
                <div style="margin-top:12px">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                        <input type="checkbox" id="parttimeStar" ${keepStar ? 'checked' : ''} style="width:18px;height:18px">
                        <span>‚≠ê √ñzel istek olarak i≈üaretle</span>
                    </label>
                </div>
            </div>
        `, `<button class="btn btn-ghost" onclick="closeModal();loadShiftWeek()">ƒ∞ptal</button>
            <button class="btn btn-primary" onclick="confirmParttime('${docId}','${name}',${dayIdx})">Kaydet</button>`);
        return;
    }
    try {
        const doc = await db.collection('shifts').doc(docId).get();
        const data = doc.data();
        if (!data.personelShifts) data.personelShifts = {};
        if (!data.personelShifts[name]) data.personelShifts[name] = {};
        // Yƒ±ldƒ±z koruma
        const finalValue = keepStar && value ? '*' + value : value;
        data.personelShifts[name][dayIdx] = finalValue;
        await db.collection('shifts').doc(docId).update({ personelShifts: data.personelShifts });
        toast('‚úì Kaydedildi', 'success');
        loadShiftWeek();
    } catch (e) { 
        console.error(e); 
        toast('G√ºncelleme hatasƒ±!', 'error'); 
        loadShiftWeek();
    }
}

// Yƒ±ldƒ±z toggle fonksiyonu
async function toggleStar(docId, name, dayIdx, isChecked) {
    try {
        const doc = await db.collection('shifts').doc(docId).get();
        const data = doc.data();
        if (!data.personelShifts || !data.personelShifts[name]) return;
        
        let val = data.personelShifts[name][dayIdx] || '';
        const cleanVal = val.replace(/\*/g, '').trim();
        
        if (!cleanVal) {
            toast('√ñnce shift se√ßin', 'error');
            loadShiftWeek();
            return;
        }
        
        const finalValue = isChecked ? '*' + cleanVal : cleanVal;
        data.personelShifts[name][dayIdx] = finalValue;
        
        await db.collection('shifts').doc(docId).update({ personelShifts: data.personelShifts });
        toast(isChecked ? '‚≠ê √ñzel istek eklendi' : '√ñzel istek kaldƒ±rƒ±ldƒ±', 'success');
        loadShiftWeek();
    } catch (e) { 
        console.error(e); 
        toast('Hata!', 'error'); 
        loadShiftWeek();
    }
}

async function confirmParttime(docId, name, dayIdx) {
    const start = document.getElementById('parttimeStart').value;
    const end = document.getElementById('parttimeEnd').value;
    const hasStar = document.getElementById('parttimeStar')?.checked;
    if (!start || !end) { toast('Saat se√ßin', 'error'); return; }
    let value = `${start}/${end}`;
    if (hasStar) value = '*' + value;
    closeModal();
    try {
        const doc = await db.collection('shifts').doc(docId).get();
        const data = doc.data();
        if (!data.personelShifts) data.personelShifts = {};
        if (!data.personelShifts[name]) data.personelShifts[name] = {};
        data.personelShifts[name][dayIdx] = value;
        await db.collection('shifts').doc(docId).update({ personelShifts: data.personelShifts });
        toast('‚úì Part-time saat kaydedildi', 'success');
        loadShiftWeek();
    } catch (e) { 
        console.error(e); 
        toast('G√ºncelleme hatasƒ±!', 'error'); 
    }
}

// Shift kurallarƒ±nƒ± d√ºzenleme
function editShiftRules(docId) {
    showModal('Shift Kurallarƒ±nƒ± D√ºzenle', `
        <div style="padding:8px 0">
            <div class="form-group" style="margin-bottom:12px">
                <label class="form-label">Kural 1 (Ye≈üil)</label>
                <input type="text" id="rule1" class="form-input" value="A√áILI≈û PERSONELƒ∞ ƒ∞≈ûE GE√á KALMAMALIDIR!">
            </div>
            <div class="form-group" style="margin-bottom:12px">
                <label class="form-label">Kural 2 (Ye≈üil)</label>
                <input type="text" id="rule2" class="form-input" value="ƒ∞Zƒ∞N G√úN√ú YOKSA; YEMEK VE MOLA S√úRESƒ∞ SE√áƒ∞Mƒ∞ PERSONELƒ∞N KENDƒ∞ SE√áƒ∞Mƒ∞NDEDƒ∞R.">
            </div>
            <div class="form-group" style="margin-bottom:12px">
                <label class="form-label">Kural 3 (Sarƒ±)</label>
                <input type="text" id="rule3" class="form-input" value="SHIFT'E YILDIZ (*) SEMBOL√ú OLAN G√úNLER √ñZEL ƒ∞STEK G√úNLERƒ∞Dƒ∞R.">
            </div>
            <div class="form-group">
                <label class="form-label">Kural 4 (Kƒ±rmƒ±zƒ±)</label>
                <input type="text" id="rule4" class="form-input" value="SHIFT Y√ñNETƒ∞Cƒ∞LERƒ∞Nƒ∞ZE Bƒ∞LGƒ∞ VERƒ∞LMEDEN HABERSƒ∞Z DEƒûƒ∞≈ûTƒ∞Rƒ∞LEMEZ!">
            </div>
        </div>
    `, `<button class="btn btn-ghost" onclick="closeModal()">ƒ∞ptal</button>
        <button class="btn btn-primary" onclick="saveShiftRules('${docId}')">Kaydet</button>`);
}

async function saveShiftRules(docId) {
    const rules = [
        { text: document.getElementById('rule1').value, color: '#2E7D32', bg: '#C6EFCE' },
        { text: document.getElementById('rule2').value, color: '#2E7D32', bg: '#C6EFCE' },
        { text: document.getElementById('rule3').value, color: '#9C5700', bg: '#FFEB9C' },
        { text: document.getElementById('rule4').value, color: '#C00000', bg: '#FFC7CE' }
    ];
    closeModal();
    try {
        await db.collection('shifts').doc(docId).update({ customRules: rules });
        toast('Kurallar g√ºncellendi', 'success');
        loadShiftWeek();
    } catch (e) { console.error(e); toast('Hata!', 'error'); }
}

// √ñzel istek ekleme
async function addSpecialRequest(docId) {
    const days = ['Pazartesi', 'Salƒ±', '√áar≈üamba', 'Per≈üembe', 'Cuma', 'Cumartesi', 'Pazar'];
    
    // Shift'teki personelleri al
    let personelOpts = '<option value="">-- Personel Se√ßin --</option>';
    try {
        const doc = await db.collection('shifts').doc(docId).get();
        const data = doc.data();
        const names = data.personelOrder || Object.keys(data.personelShifts || {});
        personelOpts += names.map(n => `<option value="${n}">${n}</option>`).join('');
    } catch (e) { console.error(e); }
    
    // √áoklu g√ºn se√ßimi i√ßin checkbox'lar
    const dayCheckboxes = days.map((d, i) => `
        <label style="display:inline-flex;align-items:center;gap:4px;padding:6px 10px;background:var(--bg3);border-radius:6px;cursor:pointer;font-size:.85rem">
            <input type="checkbox" class="reqDayCheck" value="${i}" style="width:16px;height:16px;cursor:pointer">
            ${d}
        </label>
    `).join('');
    
    showModal('√ñzel ƒ∞stek Ekle', `
        <div style="padding:8px 0">
            <div class="form-group" style="margin-bottom:12px">
                <label class="form-label">Personel</label>
                <select id="reqPersonel" class="form-select">${personelOpts}</select>
            </div>
            <div class="form-group" style="margin-bottom:12px">
                <label class="form-label">G√ºnler (√ßoklu se√ßim yapabilirsiniz)</label>
                <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:6px">
                    ${dayCheckboxes}
                </div>
                <div style="margin-top:6px;font-size:.75rem;color:var(--tx3)">Hi√ßbiri se√ßilmezse t√ºm hafta i√ßin ge√ßerli olur.</div>
            </div>
            <div class="form-group">
                <label class="form-label">ƒ∞stek Nedeni</label>
                <input type="text" id="reqReason" class="form-input" placeholder="√ñrn: OKUL, HASTANE, Aƒ∞LE vb.">
            </div>
        </div>
    `, `<button class="btn btn-ghost" onclick="closeModal()">ƒ∞ptal</button>
        <button class="btn btn-primary" onclick="saveSpecialRequest('${docId}')">Ekle</button>`);
}

async function saveSpecialRequest(docId) {
    const personel = document.getElementById('reqPersonel').value.trim();
    const reason = document.getElementById('reqReason').value.trim();
    
    // Se√ßili g√ºnleri al
    const checkedDays = [];
    document.querySelectorAll('.reqDayCheck:checked').forEach(cb => {
        checkedDays.push(parseInt(cb.value));
    });
    
    if (!personel || !reason) { toast('Personel ve neden gerekli', 'error'); return; }
    
    closeModal();
    try {
        const doc = await db.collection('shifts').doc(docId).get();
        const data = doc.data();
        const requests = data.specialRequests || [];
        
        // Her se√ßili g√ºn i√ßin ayrƒ± kayƒ±t ekle (veya hi√ß se√ßilmediyse null ile tek kayƒ±t)
        if (checkedDays.length === 0) {
            requests.push({ personel, day: null, reason });
        } else {
            checkedDays.forEach(day => {
                requests.push({ personel, day, reason });
            });
        }
        
        await db.collection('shifts').doc(docId).update({ specialRequests: requests });
        toast('√ñzel istek eklendi', 'success');
        loadShiftWeek();
    } catch (e) { console.error(e); toast('Hata!', 'error'); }
}

async function removeSpecialRequest(docId, idx) {
    if (!confirm('Bu √∂zel isteƒüi silmek istediƒüinize emin misiniz?')) return;
    try {
        const doc = await db.collection('shifts').doc(docId).get();
        const data = doc.data();
        const requests = data.specialRequests || [];
        requests.splice(idx, 1);
        await db.collection('shifts').doc(docId).update({ specialRequests: requests });
        toast('√ñzel istek silindi', 'success');
        loadShiftWeek();
    } catch (e) { console.error(e); toast('Hata!', 'error'); }
}

// Gruplu √∂zel isteƒüi sil (aynƒ± personel + reason olan t√ºm kayƒ±tlar)
async function removeSpecialRequestGroup(docId, personel, reason) {
    if (!confirm(`${personel} i√ßin "${reason}" isteƒüini silmek istediƒüinize emin misiniz?`)) return;
    try {
        const doc = await db.collection('shifts').doc(docId).get();
        const data = doc.data();
        const requests = data.specialRequests || [];
        // E≈üle≈üenleri filtrele
        const filteredRequests = requests.filter(r => !(r.personel === personel && r.reason === reason));
        await db.collection('shifts').doc(docId).update({ specialRequests: filteredRequests });
        toast('√ñzel istek silindi', 'success');
        loadShiftWeek();
    } catch (e) { console.error(e); toast('Hata!', 'error'); }
}

async function addPersonelToShift(docId) {
    // Maƒüazadaki personel listesini getir (≈üube bazlƒ±)
    const sube = document.getElementById('shiftSube').value;
    try {
        const pSnap = await db.collection('personel').get();
        const personelList = [];
        pSnap.forEach(d => {
            const p = d.data();
            if (p.branch === sube) {
                // codeName varsa onu kullan, yoksa "Ad S." formatƒ±
                const displayName = p.codeName || (p.name.split(' ')[0] + ' ' + (p.name.split(' ')[1] || '').charAt(0) + '.');
                personelList.push({ name: p.name, displayName, role: p.role });
            }
        });
        
        // R√ºtbeye g√∂re sƒ±rala
        const roleOrder = ['bolge_muduru', 'magaza_muduru', 'magaza_muduru_yardimcisi', 'kidemli_barista', 'barista', 'part_time'];
        personelList.sort((a, b) => {
            const aIdx = roleOrder.indexOf(a.role) === -1 ? 99 : roleOrder.indexOf(a.role);
            const bIdx = roleOrder.indexOf(b.role) === -1 ? 99 : roleOrder.indexOf(b.role);
            return aIdx - bIdx;
        });
        
        if (personelList.length === 0) {
            const name = prompt('Personel adƒ± girin:');
            if (name) await doAddPersonel(docId, name);
            return;
        }
        
        // Modal ile se√ßim
        const opts = personelList.map(p => `<option value="${p.displayName}">${p.displayName} (${p.name})</option>`).join('');
        showModal('Personel Ekle', `
            <div style="padding:8px 0">
                <div class="form-group" style="margin-bottom:16px">
                    <label class="form-label">${sube} Personeli</label>
                    <select id="addPersonelSelect" class="form-select">${opts}</select>
                </div>
                <div style="text-align:center;color:var(--tx2);margin:12px 0">- veya -</div>
                <div class="form-group">
                    <label class="form-label">Ge√ßici Personel (Manuel)</label>
                    <input type="text" id="addPersonelManual" class="form-input" placeholder="Kod adƒ± girin">
                </div>
            </div>
        `, `<button class="btn btn-ghost" onclick="closeModal()">ƒ∞ptal</button>
            <button class="btn btn-primary" onclick="confirmAddPersonel('${docId}')">Ekle</button>`);
    } catch (e) {
        const name = prompt('Personel adƒ± girin:');
        if (name) await doAddPersonel(docId, name);
    }
}

async function confirmAddPersonel(docId) {
    const select = document.getElementById('addPersonelSelect');
    const manual = document.getElementById('addPersonelManual');
    const name = manual.value.trim() || select.value;
    if (!name) { toast('Personel se√ßin veya girin', 'error'); return; }
    closeModal();
    await doAddPersonel(docId, name);
}

async function doAddPersonel(docId, name) {
    try {
        const doc = await db.collection('shifts').doc(docId).get();
        const data = doc.data();
        if (!data.personelShifts) data.personelShifts = {};
        if (data.personelShifts[name]) {
            toast('Bu personel zaten mevcut', 'error');
            return;
        }
        data.personelShifts[name] = {};
        await db.collection('shifts').doc(docId).update({ personelShifts: data.personelShifts });
        toast('Personel eklendi', 'success');
        loadShiftWeek();
    } catch (e) { console.error(e); toast('Ekleme hatasƒ±!', 'error'); }
}

// Alias fonksiyon
const removePersonelFromShiftModal = removePersonelFromShift;

async function removePersonelFromShift(docId) {
    try {
        const doc = await db.collection('shifts').doc(docId).get();
        const data = doc.data();
        const names = Object.keys(data.personelShifts || {});
        if (names.length === 0) { toast('Silinecek personel yok', 'error'); return; }
        
        const opts = names.map(n => `<option value="${n}">${n}</option>`).join('');
        showModal('Personel √áƒ±kar', `
            <div style="padding:8px 0">
                <div class="form-group">
                    <label class="form-label">√áƒ±karƒ±lacak Personel</label>
                    <select id="removePersonelSelect" class="form-select">${opts}</select>
                </div>
                <div style="margin-top:12px;padding:12px;background:rgba(231,76,60,.1);border-radius:8px;color:var(--red);font-size:.85rem">
                    ‚ö†Ô∏è Bu i≈ülem geri alƒ±namaz. Personelin t√ºm shift verileri silinecek.
                </div>
            </div>
        `, `<button class="btn btn-ghost" onclick="closeModal()">ƒ∞ptal</button>
            <button class="btn btn-primary" style="background:var(--red)" onclick="confirmRemovePersonel('${docId}')">√áƒ±kar</button>`);
    } catch (e) { console.error(e); }
}

async function confirmRemovePersonel(docId) {
    const name = document.getElementById('removePersonelSelect').value;
    if (!name) return;
    closeModal();
    try {
        const doc = await db.collection('shifts').doc(docId).get();
        const data = doc.data();
        delete data.personelShifts[name];
        await db.collection('shifts').doc(docId).update({ personelShifts: data.personelShifts });
        toast('Personel √ßƒ±karƒ±ldƒ±', 'success');
        loadShiftWeek();
    } catch (e) { console.error(e); toast('Silme hatasƒ±!', 'error'); }
}

function showNewShiftModal() {
    const userBranch = currentUser?.branch;
    const isAdmin = currentUser?.role === 'yonetici' || currentUser?.role === 'bolge_muduru';
    let branches = STATE.branches || [];
    if (!isAdmin && userBranch) branches = branches.filter(b => b === userBranch);
    
    const selectedSube = document.getElementById('shiftSube').value || branches[0] || '';
    const opts = branches.map(s => `<option value="${s}" ${s === selectedSube ? 'selected' : ''}>${s}</option>`).join('');
    
    // Hafta se√ßenekleri (sadece bu hafta + gelecek 8 hafta)
    const weekOpts = [];
    const today = new Date();
    for (let i = 0; i <= 8; i++) {
        const monday = new Date(today);
        // Pazartesi'yi bul (getDay: 0=Pazar, 1=Pazartesi...)
        const dayOfWeek = monday.getDay();
        const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
        monday.setDate(monday.getDate() + diff + (i * 7));
        
        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);
        
        const label = `${monday.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long' })} - ${sunday.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long' })}`;
        const monStr = monday.toISOString().split('T')[0];
        const sunStr = sunday.toISOString().split('T')[0];
        const isCurrent = i === 0;
        const isNext = i === 1;
        
        weekOpts.push(`<option value="${monStr}|${sunStr}" ${isNext ? 'selected' : ''}>${label}${isCurrent ? ' (Bu Hafta)' : ''}${isNext ? ' ‚úì Gelecek Hafta' : ''}</option>`);
    }
    
    showModal('Yeni Shift Haftasƒ±', `
        <div style="padding:8px 0">
            <div class="form-group" style="margin-bottom:16px">
                <label class="form-label">Maƒüaza</label>
                <select id="newShiftSube" class="form-select">${opts}</select>
            </div>
            <div class="form-group" style="margin-bottom:16px">
                <label class="form-label">Hafta (Pazartesi - Pazar)</label>
                <select id="newShiftWeekSelect" class="form-select">${weekOpts.join('')}</select>
            </div>
            <div class="form-group">
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                    <input type="checkbox" id="newShiftCopy" checked>
                    <span>√ñnceki haftadan personel listesini kopyala</span>
                </label>
            </div>
        </div>
    `, `<button class="btn btn-ghost" onclick="closeModal()">ƒ∞ptal</button>
        <button class="btn btn-primary" onclick="createNewShift()">Olu≈ütur</button>`);
}

async function createNewShift() {
    const sube = document.getElementById('newShiftSube').value;
    const weekVal = document.getElementById('newShiftWeekSelect').value;
    const copy = document.getElementById('newShiftCopy').checked;
    
    if (!sube || !weekVal) { toast('T√ºm alanlarƒ± doldurun', 'error'); return; }
    
    const [start, end] = weekVal.split('|');
    
    try {
        // Aynƒ± hafta var mƒ± kontrol
        const existingSnap = await db.collection('shifts').get();
        let exists = false;
        existingSnap.forEach(doc => {
            const d = doc.data();
            if (d.branch === sube && d.weekStart === start) exists = true;
        });
        
        if (exists) {
            toast('Bu hafta zaten mevcut!', 'error');
            return;
        }
        
        let ps = {};
        let personelOrder = [];
        
        // √ñnceki haftadan kopyala (T√úM shift verileri dahil)
        if (copy) {
            const allShifts = [];
            existingSnap.forEach(doc => {
                const d = doc.data();
                if (d.branch === sube) allShifts.push(d);
            });
            allShifts.sort((a, b) => (b.weekStart || '').localeCompare(a.weekStart || ''));
            
            if (allShifts.length > 0) {
                const prevShift = allShifts[0];
                // personelOrder'ƒ± kopyala
                personelOrder = prevShift.personelOrder || Object.keys(prevShift.personelShifts || {});
                // T√úM shift verilerini kopyala (g√ºnler dahil)
                ps = JSON.parse(JSON.stringify(prevShift.personelShifts || {}));
            }
        }
        
        // Personel yoksa maƒüazadaki personelden al (r√ºtbeye g√∂re sƒ±rala)
        if (Object.keys(ps).length === 0) {
            const pSnap = await db.collection('personel').get();
            const personelList = [];
            pSnap.forEach(d => {
                const p = d.data();
                if (p.branch === sube) personelList.push(p);
            });
            // R√ºtbeye g√∂re sƒ±rala
            const roleOrder = ['bolge_muduru', 'magaza_muduru', 'magaza_muduru_yardimcisi', 'kidemli_barista', 'barista', 'part_time'];
            personelList.sort((a, b) => {
                const aIdx = roleOrder.indexOf(a.role) === -1 ? 99 : roleOrder.indexOf(a.role);
                const bIdx = roleOrder.indexOf(b.role) === -1 ? 99 : roleOrder.indexOf(b.role);
                return aIdx - bIdx;
            });
            personelList.forEach(p => {
                const displayName = p.codeName || p.name.split(' ')[0] + ' ' + (p.name.split(' ')[1] || '').charAt(0) + '.';
                ps[displayName] = {};
                personelOrder.push(displayName);
            });
        }
        
        const label = `${new Date(start).toLocaleDateString('tr-TR', {day:'numeric', month:'long'})} - ${new Date(end).toLocaleDateString('tr-TR', {day:'numeric', month:'long'})}`;
        
        const newDoc = await db.collection('shifts').add({ 
            branch: sube, 
            weekStart: start, 
            weekEnd: end, 
            weekLabel: label, 
            personelOrder: personelOrder,
            personelShifts: ps, 
            createdAt: firebase.firestore.FieldValue.serverTimestamp(), 
            createdBy: currentUser?.username || 'admin' 
        });
        
        toast('Yeni hafta olu≈üturuldu!', 'success');
        closeModal();
        
        // Maƒüazayƒ± se√ß ve listeyi yenile
        document.getElementById('shiftSube').value = sube;
        await loadShiftList();
        
        // Yeni haftayƒ± se√ß ve tabloyu y√ºkle
        setTimeout(() => {
            const haftaSelect = document.getElementById('shiftHafta');
            haftaSelect.value = newDoc.id;
            // Dropdown'da yeni eklenen se√ßenek g√∂r√ºns√ºn
            if (!haftaSelect.querySelector(`option[value="${newDoc.id}"]`)) {
                const opt = document.createElement('option');
                opt.value = newDoc.id;
                opt.textContent = label + ' (Yeni)';
                opt.selected = true;
                haftaSelect.insertBefore(opt, haftaSelect.options[1]);
            }
            loadShiftWeek();
        }, 500);
        
    } catch (e) { 
        console.error('Shift olu≈üturma hatasƒ±:', e); 
        toast('Olu≈üturma hatasƒ±: ' + e.message, 'error'); 
    }
}

// PDF ƒ∞ndir - pdfmake ile renkli tablo
async function downloadShiftPDF() {
    const haftaSelect = document.getElementById('shiftHafta');
    const subeSelect = document.getElementById('shiftSube');
    const docId = haftaSelect?.value;
    
    if (!docId) { 
        toast('√ñnce bir shift se√ßin', 'error'); 
        return; 
    }
    
    toast('PDF olu≈üturuluyor...', 'info');
    
    const branch = subeSelect?.value || '';
    const weekLabel = haftaSelect.selectedOptions[0]?.textContent || '';
    
    // Firebase'den veri al
    let shiftData = null;
    try {
        const doc = await db.collection('shifts').doc(docId).get();
        shiftData = doc.data();
    } catch (e) { 
        console.error(e);
        toast('Shift verisi alƒ±namadƒ±', 'error');
        return;
    }
    
    if (!shiftData) {
        toast('Shift verisi alƒ±namadƒ±', 'error');
        return;
    }
    
    const personelShifts = shiftData.personelShifts || {};
    const personelOrder = shiftData.personelOrder || Object.keys(personelShifts);
    const specialRequests = shiftData.specialRequests || [];
    const customRules = shiftData.customRules || SHIFT_ANNOUNCEMENTS;
    const days = ['Pzt', 'Sal', '√áar', 'Per', 'Cum', 'Cmt', 'Paz'];
    const daysLong = ['Pazartesi', 'Salƒ±', '√áar≈üamba', 'Per≈üembe', 'Cuma', 'Cumartesi', 'Pazar'];
    
    // ≈ûube bazlƒ± saat kurallarƒ±
    const isTuzla = branch.toLowerCase().includes('tuzla');
    const saatKurali = isTuzla 
        ? 'A√áILI≈û: 09:50-18:50 | Pzt-Per-Paz: 16:00-01:00 | Cum-Cmt: 16:30-01:30'
        : 'A√áILI≈û: 09:50-18:50 | KAPANI≈û: 16:30-01:30';
    
    // Hex to RGB converter
    function hexToRgb(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? [parseInt(result[1], 16), parseInt(result[2], 16), parseInt(result[3], 16)] : [255, 255, 255];
    }
    
    // Tablo verileri hazƒ±rla
    const tableBody = [];
    
    // Header satƒ±rƒ±
    tableBody.push([
        { text: 'Personel', fillColor: '#00B050', color: '#ffffff', bold: true, alignment: 'center', fontSize: 9 },
        ...days.map(d => ({ text: d, fillColor: '#FFFF00', color: '#000000', bold: true, alignment: 'center', fontSize: 9 }))
    ]);
    
    // Personel satƒ±rlarƒ± - HER H√úCRE RENK ALACAK
    personelOrder.forEach((name, idx) => {
        if (!personelShifts[name]) return;
        const row = [{ text: name, fillColor: '#FFFF00', color: '#000000', bold: true, fontSize: 9 }];
        
        for (let dayIdx = 0; dayIdx < 7; dayIdx++) {
            let val = personelShifts[name][dayIdx] || '';
            const hasStar = val.includes('*') && !/^\*+$/.test(val);
            const cleanVal = val.replace(/\*/g, '').trim();
            const isEmpty = !val || /^\*+$/.test(val.trim());
            const isOff = cleanVal.toUpperCase() === 'OFF' || cleanVal.toUpperCase().includes('ƒ∞Zƒ∞N');
            const showStar = hasStar || isOff;
            
            if (isEmpty) {
                row.push({ text: '-', fillColor: '#ffffff', color: '#999999', alignment: 'center', fontSize: 9 });
            } else {
                // Renk al
                const colors = getShiftColorExcel(cleanVal);
                // Yƒ±ldƒ±z i√ßin Unicode karakter (‚òÖ = U+2605)
                const starSymbol = String.fromCharCode(0x2605);
                const displayText = (showStar ? starSymbol + ' ' : '') + cleanVal;
                
                row.push({ 
                    text: displayText, 
                    fillColor: colors.bg, 
                    color: colors.text, 
                    bold: true,
                    alignment: 'center', 
                    fontSize: 9 
                });
            }
        }
        tableBody.push(row);
    });
    
    // √ñzel istekleri grupla (aynƒ± personel + aynƒ± neden = tek satƒ±r)
    const groupedRequests = {};
    specialRequests.forEach(r => {
        const key = `${r.personel}|||${r.reason}`;
        if (!groupedRequests[key]) {
            groupedRequests[key] = { personel: r.personel, reason: r.reason, days: [] };
        }
        if (r.day !== null && r.day !== undefined) {
            groupedRequests[key].days.push(daysLong[r.day]);
        }
    });
    
    const ozelIstekler = Object.values(groupedRequests).length > 0 
        ? Object.values(groupedRequests).map(r => {
            const dayStr = r.days.length > 0 ? r.days.join(', ') : 'T√ºm Hafta';
            return `‚Ä¢ ${r.personel}: ${dayStr} ‚Üí ${r.reason}`;
        }).join('\n')
        : 'Bu hafta i√ßin √∂zel istek yok';
    
    // pdfmake d√∂k√ºman tanƒ±mƒ±
    const docDefinition = {
        pageSize: 'A4',
        pageOrientation: 'landscape',
        pageMargins: [15, 15, 15, 15],
        content: [
            // Ba≈ülƒ±k - Marka renkleri
            { text: 'Moonberry Coffee - ' + branch, fontSize: 16, bold: true, color: '#ff8674' },
            { text: 'Shift Planƒ±: ' + weekLabel, fontSize: 10, color: '#008c95', margin: [0, 2, 0, 10] },
            
            // Tablo
            {
                table: {
                    headerRows: 1,
                    widths: [80, '*', '*', '*', '*', '*', '*', '*'],
                    body: tableBody
                },
                layout: {
                    hLineWidth: () => 0.5,
                    vLineWidth: () => 0.5,
                    hLineColor: () => '#999999',
                    vLineColor: () => '#999999',
                    paddingLeft: () => 4,
                    paddingRight: () => 4,
                    paddingTop: () => 3,
                    paddingBottom: () => 3
                }
            },
            
            // Kurallar - customRules'tan dinamik
            { text: '', margin: [0, 8, 0, 0] },
            {
                table: {
                    widths: customRules.map(() => 'auto').concat(['auto']),
                    body: [[
                        ...customRules.map(a => ({
                            text: a.text,
                            fillColor: a.bg,
                            color: a.color,
                            fontSize: 7,
                            bold: true,
                            margin: [4, 2, 4, 2]
                        })),
                        { text: saatKurali, fillColor: '#BDE0FE', color: '#1565C0', fontSize: 7, bold: true, margin: [4, 2, 4, 2] }
                    ]]
                },
                layout: 'noBorders'
            },
            
            // √ñzel ƒ∞stekler
            { text: '', margin: [0, 8, 0, 0] },
            { text: '√ñzel ƒ∞stek G√ºnleri:', fontSize: 9, bold: true, color: '#F57C00' },
            { text: ozelIstekler, fontSize: 8, color: '#E65100', margin: [0, 2, 0, 0] }
        ]
    };
    
    // PDF olu≈ütur ve indir
    const filename = `Shift_${branch.replace(/\s/g, '_')}_${weekLabel.replace(/\s/g, '_').replace(/[^\w-]/g, '')}.pdf`;
    pdfMake.createPdf(docDefinition).download(filename);
    
    toast('PDF indirildi! ‚úì', 'success');
}

// Bu haftayƒ± sil fonksiyonu
async function deleteCurrentShift() {
    const haftaSelect = document.getElementById('shiftHafta');
    const subeSelect = document.getElementById('shiftSube');
    const docId = haftaSelect?.value;
    const branch = subeSelect?.value;
    
    if (!docId) {
        toast('√ñnce bir shift se√ßin', 'error');
        return;
    }
    
    // Sadece y√∂netici silebilir
    if (currentUser?.role !== 'yonetici') {
        toast('Sadece y√∂netici shift silebilir', 'error');
        return;
    }
    
    // Sadece en yeni shift silinebilir - kontrol et
    try {
        const shiftsSnap = await db.collection('shifts')
            .where('branch', '==', branch)
            .orderBy('weekStart', 'desc')
            .limit(1)
            .get();
        
        if (shiftsSnap.empty) {
            toast('Silinecek shift bulunamadƒ±', 'error');
            return;
        }
        
        const newestShiftId = shiftsSnap.docs[0].id;
        
        if (docId !== newestShiftId) {
            toast('Sadece en son olu≈üturulan hafta silinebilir!', 'error');
            return;
        }
    } catch (e) {
        console.error('Kontrol hatasƒ±:', e);
    }
    
    const weekLabel = haftaSelect.selectedOptions[0]?.textContent || '';
    
    // Onay iste
    if (!confirm(`"${weekLabel}" shift'ini silmek istediƒüinize emin misiniz?\n\nBu i≈ülem geri alƒ±namaz!`)) {
        return;
    }
    
    try {
        await db.collection('shifts').doc(docId).delete();
        toast('Shift silindi', 'success');
        haftaSelect.value = '';
        document.getElementById('shiftTableContainer').innerHTML = '<p style="color:var(--tx2);text-align:center;padding:40px">‚¨ÜÔ∏è Yukarƒ±dan hafta se√ßin.</p>';
        loadShiftList();
    } catch (e) {
        console.error('Silme hatasƒ±:', e);
        toast('Silme hatasƒ±: ' + e.message, 'error');
    }
}

// Yazdƒ±r fonksiyonu
async function printShift() {
    const haftaSelect = document.getElementById('shiftHafta');
    const docId = haftaSelect?.value;
    
    if (!docId) { 
        toast('√ñnce bir shift se√ßin', 'error'); 
        return; 
    }
    
    const branch = document.getElementById('shiftSube').value;
    const weekLabel = haftaSelect.selectedOptions[0]?.textContent || '';
    
    // Firebase'den veri al
    let shiftData = null;
    try {
        const doc = await db.collection('shifts').doc(docId).get();
        shiftData = doc.data();
    } catch (e) { 
        console.error(e);
        toast('Shift verisi alƒ±namadƒ±', 'error');
        return;
    }
    
    const personelShifts = shiftData.personelShifts || {};
    const personelOrder = shiftData.personelOrder || Object.keys(personelShifts);
    const specialRequests = shiftData.specialRequests || [];
    const customRules = shiftData.customRules || SHIFT_ANNOUNCEMENTS;
    const days = ['Pzt', 'Sal', '√áar', 'Per', 'Cum', 'Cmt', 'Paz'];
    const daysLong = ['Pazartesi', 'Salƒ±', '√áar≈üamba', 'Per≈üembe', 'Cuma', 'Cumartesi', 'Pazar'];
    
    // ≈ûube bazlƒ± saat kurallarƒ±
    const isTuzla = branch.toLowerCase().includes('tuzla');
    const saatKurali = isTuzla 
        ? 'A√áILI≈û: 09:50-18:50 | Pzt-Per-Paz KAPANI≈û: 16:00-01:00 | Cum-Cmt KAPANI≈û: 16:30-01:30'
        : 'A√áILI≈û: 09:50-18:50 | KAPANI≈û: 16:30-01:30';
    
    // Tablo verisi
    const data = [];
    
    personelOrder.forEach(name => {
        if (!personelShifts[name]) return;
        const rowData = [];
        rowData.push({ text: name, bg: '#FFFF00', color: '#000' });
        
        for (let dayIdx = 0; dayIdx < 7; dayIdx++) {
            let val = personelShifts[name][dayIdx] || '';
            const hasStar = val.includes('*') && !/^\*+$/.test(val);
            const cleanVal = val.replace(/\*/g, '').trim();
            const isEmpty = !val || /^\*+$/.test(val.trim());
            const isOff = cleanVal.toUpperCase() === 'OFF' || cleanVal.toUpperCase().includes('ƒ∞Zƒ∞N');
            const showStar = hasStar || isOff;
            
            if (isEmpty) {
                rowData.push({ text: '-', bg: '#fff', color: '#999', hasStar: false });
            } else {
                const colors = getShiftColorExcel(cleanVal);
                const displayText = showStar ? '‚≠ê' + cleanVal : cleanVal;
                rowData.push({ text: displayText, bg: colors.bg, color: colors.text, hasStar: showStar });
            }
        }
        data.push(rowData);
    });
    
    // √ñzel istekleri grupla (aynƒ± personel + aynƒ± neden = tek satƒ±r)
    const groupedRequests = {};
    specialRequests.forEach(r => {
        const key = `${r.personel}|||${r.reason}`;
        if (!groupedRequests[key]) {
            groupedRequests[key] = { personel: r.personel, reason: r.reason, days: [] };
        }
        if (r.day !== null && r.day !== undefined) {
            groupedRequests[key].days.push(daysLong[r.day]);
        }
    });
    
    const specialRequestsHtml = Object.values(groupedRequests).length > 0 
        ? Object.values(groupedRequests).map(r => {
            const dayStr = r.days.length > 0 ? r.days.join(', ') : 'T√ºm Hafta';
            return `<span class="request-item">${r.personel}: ${dayStr} ‚Üí ${r.reason}</span>`;
        }).join('') 
        : '<span class="empty-requests">Bu hafta i√ßin √∂zel istek yok</span>';
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Shift - ${branch} - ${weekLabel}</title>
            <style>
                @page { size: A4 landscape; margin: 8mm; }
                @media print {
                    * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; color-adjust: exact !important; }
                    body { margin: 0; padding: 0; }
                }
                body { font-family: Arial, sans-serif; padding: 12px; background: #fff; margin: 0; }
                .header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 3px solid #ff8674; }
                .logo { width: 50px; height: 44px; object-fit: contain; }
                .title { color: #ff8674; font-size: 18px; margin: 0; font-weight: 700; }
                .subtitle { color: #008c95; font-size: 11px; margin: 4px 0 0 0; }
                table { width: 100%; border-collapse: collapse; font-size: 10px; margin-bottom: 12px; table-layout: fixed; }
                th, td { border: 1px solid #bbb; padding: 6px 4px; text-align: center; }
                th { font-weight: 600; }
                th:first-child, td:first-child { width: 14%; text-align: left; }
                th:not(:first-child), td:not(:first-child) { width: 12.28%; }
                .rules-box { margin-top: 10px; }
                .rule { display: inline-block; padding: 5px 8px; margin: 2px; font-size: 8px; border-radius: 3px; font-weight: 500; }
                .rule1 { background: #C6EFCE !important; color: #2E7D32 !important; }
                .rule2 { background: #FFEB9C !important; color: #9C5700 !important; }
                .rule3 { background: #BDE0FE !important; color: #1565C0 !important; }
                .rule4 { background: #E8F4FD !important; color: #1976D2 !important; }
                .requests-box { margin-top: 10px; padding: 10px; background: #FFF8E1 !important; border-radius: 6px; border: 1px solid #FFE082; }
                .requests-title { font-weight: 600; color: #F57C00; font-size: 10px; margin-bottom: 6px; }
                .request-item { background: #FFECB3 !important; color: #E65100 !important; padding: 3px 6px; border-radius: 3px; display: inline-block; margin: 2px; font-size: 9px; }
                .empty-requests { color: #9E9E9E; font-style: italic; font-size: 9px; }
            </style>
        </head>
        <body>
            <div class="header">
                <img src="https://static.wixstatic.com/media/760af2_cb121a61291f4f07adb48cfb70f3e2d9~mv2.png" class="logo" onerror="this.style.display='none'">
                <div>
                    <h1 class="title">Moonberry Coffee - ${branch}</h1>
                    <p class="subtitle">Shift Planƒ±: ${weekLabel}</p>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th style="background:#00B050 !important; color:#fff !important;">PERSONEL</th>
                        ${days.map(d => `<th style="background:#FFFF00 !important; color:#000 !important;">${d}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
                    ${data.map((row, i) => `
                        <tr style="background:${i % 2 === 0 ? '#fff' : '#f5f5f5'}">
                            ${row.map((cell, idx) => `<td style="background:${cell.bg} !important; color:${cell.color} !important; font-weight:600;${cell.hasStar ? ' border:2px solid #ff8674 !important;' : ''}">${cell.text}</td>`).join('')}
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            
            <div class="rules-box">
                ${customRules.map((a, i) => `<span class="rule" style="background:${a.bg} !important; color:${a.color} !important;">${a.text}</span>`).join('')}
                <span class="rule rule3">${saatKurali}</span>
            </div>
            
            <div class="requests-box">
                <div class="requests-title">üìå √ñzel ƒ∞stek G√ºnleri</div>
                ${specialRequestsHtml}
            </div>
            
            <script>window.onload = function() { window.print(); }<\/script>
        </body>
        </html>
    `);
    printWindow.document.close();
}

const EXCEL_PERSONEL = {
    '≈ûi≈üli': ["ESƒ∞N", "ESMA", "ECE"],
    'Tuzla': ["B√ú≈ûRA", "ESƒ∞N", "BALRA", "TUANA", "BARAN", "ELƒ∞F"]
};

// Firebase'e y√ºkle
async function uploadExcelToFirebase() {
    if (currentUser?.role !== 'yonetici') {
        toast('Sadece y√∂netici yapabilir', 'error');
        return;
    }
    
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Y√ºkleniyor...';
    
    // Branch isim d√∂n√º≈ü√ºm√º
    const branchMap = {
        '≈ûi≈üli': '≈ûi≈üli (Merkez)',
        'Tuzla': 'Tuzla Port'
    };
    
    try {
        // 1. Personel ekle (son 2 hafta kadrosu)
        let pAdded = 0;
        for (const [excelBranch, names] of Object.entries(EXCEL_PERSONEL)) {
            const dbBranch = branchMap[excelBranch] || excelBranch;
            for (const name of names) {
                const existing = await db.collection('personel').where('name', '==', name).where('branch', '==', dbBranch).get();
                if (existing.empty) {
                    await db.collection('personel').add({
                        name: name,
                        branch: dbBranch,
                        position: 'Barista',
                        status: 'aktif',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    pAdded++;
                }
            }
        }
        
        // 2. Shiftleri ekle
        let sAdded = 0, sSkipped = 0;
        for (const shift of EXCEL_SHIFTS) {
            if (!shift.weekStart) { sSkipped++; continue; }
            
            const dbBranch = branchMap[shift.branch] || shift.branch;
            
            const existing = await db.collection('shifts')
                .where('branch', '==', dbBranch)
                .where('weekStart', '==', shift.weekStart)
                .get();
            
            if (existing.empty) {
                await db.collection('shifts').add({
                    branch: dbBranch,
                    weekStart: shift.weekStart,
                    weekEnd: shift.weekEnd,
                    weekLabel: shift.weekLabel,
                    personelShifts: shift.personelShifts,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    source: 'excel'
                });
                sAdded++;
            } else {
                sSkipped++;
            }
        }
        
        toast(`‚úì ${pAdded} personel, ${sAdded} shift eklendi`, 'success');
        loadShiftList();
        
    } catch (e) {
        console.error(e);
        toast('Hata: ' + e.message, 'error');
    }
    
    btn.disabled = false;
    btn.innerHTML = 'üì• Excel Verilerini Y√ºkle';
}

// ==================== AKTƒ∞Vƒ∞TE LOGLAMA ====================

// Aktivite logla
async function logActivity(type, details = {}) {
    if (!currentUser || !db) return;
    
    try {
        await db.collection('activityLogs').add({
            userId: currentUser.id,
            userEmail: currentUser.email,
            userName: currentUser.name,
            userRole: currentUser.role,
            type: type,
            details: details,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            sessionId: currentUser.sessionId || null
        });
    } catch (error) {
        console.error('Aktivite loglama hatasƒ±:', error);
    }
}

// Aktivite loglarƒ±nƒ± y√ºkle
async function loadActivityLogs() {
    const container = document.getElementById('activityLogList');
    if (!container) return;
    
    // Kullanƒ±cƒ± filtresini doldur
    const userFilter = document.getElementById('activityUserFilter');
    if (userFilter && userFilter.options.length <= 1) {
        try {
            const usersSnap = await db.collection('users').get();
            usersSnap.forEach(doc => {
                const u = doc.data();
                const opt = document.createElement('option');
                opt.value = doc.id;
                opt.textContent = u.name || u.email || doc.id;
                userFilter.appendChild(opt);
            });
        } catch (e) {
            console.error('Kullanƒ±cƒ± listesi y√ºklenemedi:', e);
        }
    }
    
    try {
        let query = db.collection('activityLogs').orderBy('timestamp', 'desc').limit(100);
        
        // Filtreler
        const selectedUser = document.getElementById('activityUserFilter')?.value;
        const selectedType = document.getElementById('activityTypeFilter')?.value;
        const selectedDate = document.getElementById('activityDateFilter')?.value;
        
        if (selectedUser) {
            query = db.collection('activityLogs')
                .where('userId', '==', selectedUser)
                .orderBy('timestamp', 'desc')
                .limit(100);
        }
        
        const snapshot = await query.get();
        
        if (snapshot.empty) {
            container.innerHTML = `
                <div style="text-align:center;padding:40px;color:var(--tx2)">
                    <div style="font-size:2rem;margin-bottom:12px">üìä</div>
                    <div>Hen√ºz aktivite kaydƒ± yok</div>
                </div>
            `;
            return;
        }
        
        const typeLabels = {
            'login': { icon: 'üîê', label: 'Giri≈ü Yaptƒ±', color: '#27ae60' },
            'logout': { icon: 'üö™', label: '√áƒ±kƒ±≈ü Yaptƒ±', color: '#95a5a6' },
            'page_view': { icon: 'üëÅÔ∏è', label: 'Sayfa G√∂r√ºnt√ºledi', color: '#3498db' },
            'document_create': { icon: 'üìÑ', label: 'Belge Olu≈üturdu', color: '#9b59b6' },
            'data_edit': { icon: '‚úèÔ∏è', label: 'Veri D√ºzenledi', color: '#f39c12' },
            'data_delete': { icon: 'üóëÔ∏è', label: 'Veri Sildi', color: '#e74c3c' }
        };
        
        let html = '<div style="display:flex;flex-direction:column;gap:6px">';
        
        snapshot.forEach(doc => {
            const log = doc.data();
            const ts = log.timestamp?.toDate?.();
            const time = ts ? ts.toLocaleString('tr-TR') : '-';
            const typeInfo = typeLabels[log.type] || { icon: 'üìå', label: log.type, color: '#95a5a6' };
            
            // Filtreler
            if (selectedType && log.type !== selectedType) return;
            if (selectedDate) {
                const logDate = ts?.toISOString().split('T')[0];
                if (logDate !== selectedDate) return;
            }
            
            const detailsStr = log.details?.page 
                ? `‚Üí ${log.details.page}` 
                : (log.details?.action || '');
            
            html += `
                <div style="display:flex;align-items:center;gap:12px;padding:10px 14px;background:var(--bg3);border-radius:8px;border-left:3px solid ${typeInfo.color}">
                    <span style="font-size:1.1rem">${typeInfo.icon}</span>
                    <div style="flex:1;min-width:0">
                        <div style="display:flex;align-items:center;gap:8px">
                            <span style="font-weight:500;color:var(--tx)">${log.userName || log.userEmail || '-'}</span>
                            <span style="font-size:.75rem;color:var(--tx3);background:var(--bg4);padding:2px 6px;border-radius:4px">${log.userRole || '-'}</span>
                        </div>
                        <div style="font-size:.8rem;color:var(--tx2)">${typeInfo.label} ${detailsStr}</div>
                    </div>
                    <div style="font-size:.75rem;color:var(--tx3);white-space:nowrap">${time}</div>
                </div>
            `;
        });
        
        html += '</div>';
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Aktivite loglarƒ± y√ºkleme hatasƒ±:', error);
        container.innerHTML = `<div style="color:var(--red);padding:20px;text-align:center">Y√ºkleme hatasƒ±</div>`;
    }
}

// getWeekOptions fonksiyonu (hafta listesi i√ßin)// getWeekOptions fonksiyonu (hafta listesi i√ßin)
function getWeekOptions() {
    const options = [];
    const today = new Date();
    for (let i = -12; i <= 2; i++) {
        const monday = new Date(today);
        monday.setDate(today.getDate() - today.getDay() + 1 + (i * 7));
        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);
        const label = `${monday.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' })} - ${sunday.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' })}`;
        const value = monday.toISOString().split('T')[0];
        options.push({ value, label, monday, sunday, isCurrent: i === 0 });
    }
    return options;
}

// ==================== CHECKLIST MODULE ====================
// Checklist t√ºrleri - ≈üubeye g√∂re
// Checklist t√ºrleri - Firebase'den y√ºklenecek
let CHECKLIST_TYPES = {};
let SYSTEM_CONFIG = {};

// Platform listesi - Firebase'den y√ºklenecek
let PLATFORMS = ['Trendyol', 'Yemek Sepeti', 'Getir Yemek', 'Migros'];

// WhatsApp Grup Linkleri - Firebase'den y√ºklenecek
let WHATSAPP_GROUPS = {};

// Modern SVG ƒ∞konlar
const ICONS = {
    sunrise: '<svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 18a5 5 0 00-10 0"/><line x1="12" y1="2" x2="12" y2="9"/><line x1="4.22" y1="10.22" x2="5.64" y2="11.64"/><line x1="1" y1="18" x2="3" y2="18"/><line x1="21" y1="18" x2="23" y2="18"/><line x1="18.36" y1="11.64" x2="19.78" y2="10.22"/><line x1="23" y1="22" x2="1" y2="22"/><polyline points="8 6 12 2 16 6"/></svg>',
    sunset: '<svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 18a5 5 0 00-10 0"/><line x1="12" y1="9" x2="12" y2="2"/><line x1="4.22" y1="10.22" x2="5.64" y2="11.64"/><line x1="1" y1="18" x2="3" y2="18"/><line x1="21" y1="18" x2="23" y2="18"/><line x1="18.36" y1="11.64" x2="19.78" y2="10.22"/><line x1="23" y1="22" x2="1" y2="22"/><polyline points="16 6 12 10 8 6"/></svg>',
    'clipboard-check': '<svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/><path d="M9 14l2 2 4-4"/></svg>',
    smartphone: '<svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>',
    'calendar-week': '<svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><line x1="8" y1="14" x2="8" y2="14"/><line x1="12" y1="14" x2="12" y2="14"/><line x1="16" y1="14" x2="16" y2="14"/></svg>',
    calendar: '<svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
    'user-check': '<svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></svg>',
    check: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>',
    x: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
    trash: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>'
};

// ƒ∞kon getir
function getIcon(name) {
    return ICONS[name] || ICONS['clipboard-check'];
}

// Rol adƒ±nƒ± T√ºrk√ße d√∂nd√ºr
function getRoleName(role) {
    const names = {
        'yonetici': 'Y√∂netici',
        'bolge_muduru': 'B√∂lge M√ºd√ºr√º',
        'magaza_muduru': 'Maƒüaza M√ºd√ºr√º',
        'mudur_yardimcisi': 'M√ºd√ºr Yardƒ±mcƒ±sƒ±',
        'barista': 'Barista'
    };
    return names[role] || role;
}

// Checklist zamanlama deƒüi≈ükenleri
let checklistStartTime = null;
let checklistFirstItemTime = null;
let checklistExpectedDuration = 0; // saniye cinsinden

// Personel-≈üube e≈üle≈ütirmesi (Firebase'den y√ºklenecek)
let personnelMapping = [];

// T√ºm config'i Firebase'den y√ºkle
async function loadSystemConfig() {
    try {
        // √ñnce t√ºm config'i Firebase'den y√ºkle
        await loadConfigFromFirebase();
        
        // Personel e≈üle≈ütirmesi
        const persDoc = await db.collection('config').doc('personnel').get();
        if (persDoc.exists) {
            personnelMapping = persDoc.data().list || [];
        }
        
        // STATE'i CONFIG'dan doldur
        loadState();
        
        console.log('‚úÖ Sistem config y√ºklendi:', {
            branches: Object.keys(CHECKLIST_TYPES),
            personnel: personnelMapping.length,
            violations: CONFIG.violations?.length || 0,
            contractTemplates: Object.keys(CONFIG.contractTemplates || {}).length
        });
    } catch (e) {
        console.warn('‚ùå Config y√ºklenemedi:', e);
    }
}

// Personel e≈üle≈ütirmesini Firebase'den y√ºkle (eski uyumluluk i√ßin)
async function loadPersonnelMapping() {
    if (personnelMapping.length === 0) {
        await loadSystemConfig();
    }
}

// Kullanƒ±cƒ±nƒ±n ≈üubesini email'den al
function getUserBranchFromEmail(email) {
    const match = personnelMapping.find(p => p.email?.toLowerCase() === email?.toLowerCase());
    return match ? match.branch : null;
}

// Kullanƒ±cƒ±nƒ±n adƒ±nƒ± email'den al
function getUserNameFromEmail(email) {
    const match = personnelMapping.find(p => p.email?.toLowerCase() === email?.toLowerCase());
    return match ? match.name : null;
}

// Checklist sayfasƒ± ba≈ülat
async function initChecklistPage() {
    // √ñnce config'i y√ºkle
    await loadSystemConfig();
    // ≈ûube dropdown'ƒ± doldur
    const subeSelect = document.getElementById('checklistSube');
    if (!subeSelect) return;
    
    const userEmail = currentUser?.email;
    const emailBranch = getUserBranchFromEmail(userEmail);
    const userBranch = emailBranch || currentUser?.branch;
    const isAdmin = currentUser?.role === 'yonetici' || currentUser?.role === 'bolge_muduru';
    
    let branches = STATE.branches || [];
    
    // Maƒüaza m√ºd√ºr√º/barista sadece kendi ≈üubesini g√∂rs√ºn ve deƒüi≈ütiremesin
    if (!isAdmin && userBranch && userBranch !== 'all') {
        branches = branches.filter(b => b === userBranch);
        subeSelect.disabled = true;
        subeSelect.style.opacity = '0.7';
        subeSelect.title = '≈ûubeniz otomatik se√ßilmi≈ütir';
    } else {
        subeSelect.disabled = false;
        subeSelect.style.opacity = '1';
    }
    
    subeSelect.innerHTML = branches.map(b => `<option value="${b}">${b}</option>`).join('');
    
    // Kullanƒ±cƒ±nƒ±n ≈üubesini se√ß veya default Tuzla Port
    if (userBranch && userBranch !== 'all') {
        const userOption = Array.from(subeSelect.options).find(o => o.value === userBranch);
        if (userOption) subeSelect.value = userOption.value;
    } else {
        const tuzlaOption = Array.from(subeSelect.options).find(o => o.value.toLowerCase().includes('tuzla'));
        if (tuzlaOption) subeSelect.value = tuzlaOption.value;
    }
    
    // Tarih bug√ºn
    document.getElementById('checklistDate').value = new Date().toISOString().split('T')[0];
    
    // Y√∂netici butonlarƒ±nƒ± g√∂ster/gizle
    const adminBtns = document.getElementById('checklistAdminButtons');
    if (adminBtns) {
        adminBtns.style.display = (currentUser?.role === 'yonetici' || currentUser?.role === 'magaza_muduru') ? 'block' : 'none';
    }
    
    // Checklist t√ºrlerini y√ºkle
    loadChecklistTypes();
}

// Checklist t√ºrlerini y√ºkle
async function loadChecklistTypes() {
    const branch = document.getElementById('checklistSube')?.value;
    const typeSelect = document.getElementById('checklistType');
    const buttonsContainer = document.getElementById('checklistTypeButtons');
    if (!typeSelect || !branch) return;
    
    // Config y√ºklenmemi≈üse y√ºkle
    if (Object.keys(CHECKLIST_TYPES).length === 0) {
        await loadSystemConfig();
    }
    
    const types = CHECKLIST_TYPES[branch] || [];
    // G√ºncel Kontrol'u filtrele (veriler korunuyor, sadece men√ºden kaldƒ±rƒ±ldƒ±)
    const filteredTypes = types.filter(t => t.id !== 'guncel');
    const isManager = currentUser?.role === 'yonetici' || currentUser?.role === 'magaza_muduru' || currentUser?.role === 'bolge_muduru';
    
    // Debug log
    console.log('Checklist t√ºrleri:', branch, filteredTypes.length, 'adet');
    
    // Hidden select g√ºncelle
    let selectHtml = '<option value="">-- Checklist Se√ßin --</option>';
    filteredTypes.forEach(t => {
        if (t.managerOnly && !isManager) return;
        selectHtml += `<option value="${t.id}" data-timeslots="${t.timeSlots ? t.timeSlots.join(',') : ''}">${t.name}</option>`;
    });
    typeSelect.innerHTML = selectHtml;
    
    // Butonlarƒ± olu≈ütur - Modern SVG ikonlar
    let buttonsHtml = '';
    filteredTypes.forEach(t => {
        if (t.managerOnly && !isManager) return;
        const iconSvg = getIcon(t.icon || 'clipboard-check');
        buttonsHtml += `
            <button type="button" class="checklist-type-btn" data-type="${t.id}" data-timeslots="${t.timeSlots ? t.timeSlots.join(',') : ''}"
                onclick="selectChecklistType('${t.id}')"
                style="padding:12px 18px;border:1px solid var(--cardBorder);background:var(--bg2);color:var(--tx);border-radius:10px;cursor:pointer;font-size:.9rem;font-weight:500;transition:all .2s;display:flex;align-items:center;gap:10px">
                <span style="opacity:.7">${iconSvg}</span>
                ${t.name}
            </button>
        `;
    });
    
    if (!buttonsHtml) {
        buttonsHtml = '<div style="color:var(--tx3);font-size:.9rem;padding:10px">Bu ≈üube i√ßin checklist bulunamadƒ±. L√ºtfen seed.html ile verileri y√ºkleyin.</div>';
    }
    buttonsContainer.innerHTML = buttonsHtml;
    
    // Formu temizle
    document.getElementById('checklistFormContainer').innerHTML = `
        <div style="text-align:center;padding:60px;color:var(--tx2)">
            <svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" style="opacity:.4;margin-bottom:16px">
                <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/>
                <rect x="9" y="3" width="6" height="4" rx="1"/>
                <path d="M9 14l2 2 4-4"/>
            </svg>
            <div style="font-size:1.1rem;margin-bottom:8px">Checklist Se√ßin</div>
            <div style="font-size:.85rem;opacity:.6">Yukarƒ±dan checklist t√ºr√º se√ßerek ba≈ülayƒ±n</div>
        </div>
    `;
}

// Checklist t√ºr√º se√ß (buton)
function selectChecklistType(typeId) {
    const typeSelect = document.getElementById('checklistType');
    typeSelect.value = typeId;
    
    // Buton stillerini g√ºncelle
    document.querySelectorAll('.checklist-type-btn').forEach(btn => {
        if (btn.dataset.type === typeId) {
            btn.style.background = 'linear-gradient(135deg, var(--accent), #ff6b5b)';
            btn.style.color = '#fff';
            btn.style.borderColor = 'var(--accent)';
            btn.style.boxShadow = '0 4px 12px rgba(255,134,116,.3)';
        } else {
            btn.style.background = 'var(--bg2)';
            btn.style.color = 'var(--tx)';
            btn.style.borderColor = 'var(--cardBorder)';
            btn.style.boxShadow = 'none';
        }
    });
    
    // Time slot g√ºncelle - Platform check i√ßin saat se√ßimi YOK
    const selectedBtn = document.querySelector(`.checklist-type-btn[data-type="${typeId}"]`);
    const timeSlots = selectedBtn?.dataset.timeslots?.split(',').filter(Boolean) || [];
    const timeSlotGroup = document.getElementById('checklistTimeSlotGroup');
    const timeSlotSelect = document.getElementById('checklistTimeSlot');
    
    // Platform check i√ßin saat se√ßimi g√∂sterme
    if (typeId === 'platform') {
        timeSlotGroup.style.display = 'none';
        timeSlotSelect.innerHTML = '<option value="">-- Se√ßin --</option>';
    } else if (timeSlots.length > 0) {
        timeSlotGroup.style.display = 'block';
        let tsHtml = '<option value="">-- Se√ßin --</option>';
        timeSlots.forEach(ts => { tsHtml += `<option value="${ts}">${ts}</option>`; });
        timeSlotSelect.innerHTML = tsHtml;
    } else {
        timeSlotGroup.style.display = 'none';
        timeSlotSelect.innerHTML = '<option value="">-- Se√ßin --</option>';
    }
    
    loadChecklist();
}

// Checklist y√ºkle
async function loadChecklist() {
    const branch = document.getElementById('checklistSube')?.value;
    const type = document.getElementById('checklistType')?.value;
    const date = document.getElementById('checklistDate')?.value;
    const container = document.getElementById('checklistFormContainer');
    
    if (!branch || !type || !date || !container) return;
    
    // Platform Check i√ßin √∂zel render - saat se√ßimi yok
    if (type === 'platform') {
        container.innerHTML = `<div style="text-align:center;padding:40px;color:var(--tx2)">
            <div class="loading-spinner" style="margin:0 auto 16px"></div>
            Platform Check y√ºkleniyor...
        </div>`;
        
        // Platform Check kaydedilmi≈ü verileri al
        let submittedData = null;
        try {
            const docId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_platform_${date}`;
            const doc = await db.collection('platformChecks').doc(docId).get();
            if (doc.exists) {
                submittedData = doc.data();
            }
        } catch (e) {
            console.warn('Platform Check verisi alƒ±namadƒ±:', e);
        }
        
        renderPlatformChecklist(container, branch, date, null, submittedData);
        return;
    }
    
    // Saat dilimi kontrol√º (Platform check hari√ß diƒüerleri i√ßin)
    const typeOption = document.getElementById('checklistType')?.selectedOptions[0];
    const timeSlots = typeOption?.dataset.timeslots?.split(',').filter(Boolean) || [];
    const timeSlotGroup = document.getElementById('checklistTimeSlotGroup');
    const timeSlotSelect = document.getElementById('checklistTimeSlot');
    
    if (timeSlots.length > 0) {
        timeSlotGroup.style.display = 'block';
        timeSlotSelect.innerHTML = '<option value="">-- Saat Se√ßin --</option>' + 
            timeSlots.map(t => `<option value="${t}">${t}</option>`).join('');
        
        // Saat se√ßilmemi≈üse bekle
        if (!timeSlotSelect.value) {
            container.innerHTML = `
                <div style="text-align:center;padding:60px;color:var(--tx2)">
                    <div style="font-size:4rem;margin-bottom:16px">‚è∞</div>
                    <div style="font-size:1.1rem;margin-bottom:8px">Saat Dilimi Se√ßin</div>
                    <div style="font-size:.9rem">Bu checklist g√ºn√ºn belirli saatlerinde doldurulur</div>
                </div>
            `;
            return;
        }
    } else {
        timeSlotGroup.style.display = 'none';
    }
    
    const timeSlot = timeSlotSelect?.value || null;
    
    // Loading
    container.innerHTML = `<div style="text-align:center;padding:40px;color:var(--tx2)">
        <div class="loading-spinner" style="margin:0 auto 16px"></div>
        Checklist y√ºkleniyor...
    </div>`;
    
    try {
        const checklistId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_${type}`;
        let items = [];
        
        // √ñnce Firebase'den √ßek
        try {
            const checklistDoc = await db.collection('checklists').doc(checklistId).get();
            if (checklistDoc.exists && checklistDoc.data().items?.length > 0) {
                items = checklistDoc.data().items;
            }
        } catch (dbError) {
            console.warn('Firestore eri≈üim hatasƒ±:', dbError);
        }
        
        // Firebase'de yoksa default maddeleri kullan ve kaydet (ilk kurulum)
        if (items.length === 0) {
            items = getDefaultChecklistItems(branch, type);
            if (items.length > 0) {
                try {
                    await db.collection('checklists').doc(checklistId).set({
                        branch,
                        type,
                        items,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log(`ƒ∞lk kurulum: ${checklistId} Firebase'e kaydedildi`);
                } catch (e) {
                    console.warn('ƒ∞lk kayƒ±t hatasƒ±:', e);
                }
            }
        }
        
        // Eƒüer hala items bo≈üsa hata g√∂ster
        if (!items || items.length === 0) {
            container.innerHTML = `<div style="text-align:center;padding:60px;color:var(--tx2)">
                <svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" style="opacity:.4;margin-bottom:16px">
                    <circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/>
                </svg>
                <div style="font-size:1.1rem;margin-bottom:8px;color:var(--tx)">Checklist Verisi Bulunamadƒ±</div>
                <div style="font-size:.85rem;margin-bottom:16px;max-width:300px;margin-left:auto;margin-right:auto">
                    <strong>${branch}</strong> ≈üubesi i√ßin <strong>${type}</strong> checklist'i hen√ºz y√ºklenmemi≈ü.
                </div>
                <div style="font-size:.8rem;color:var(--tx3)">
                    Y√∂netici: <code>seed.html</code> dosyasƒ±nƒ± a√ßƒ±p verileri y√ºkleyin.
                </div>
            </div>`;
            return;
        }
        
        // Temizlik ve Bakƒ±m i√ßin renk ve tarih bilgisi mapping
        if (type === 'aylik') {
            const aylikMapping = {
                // A√áILI≈û√áI (Mavi)
                'bula≈üƒ±k makinesi kire√ß': { color: '#00B0F0', responsible: 'A√áILI≈û√áI', dates: [3, 11, 19, 27] },
                '≈üurup ve soslarƒ±n': { color: '#00B0F0', responsible: 'A√áILI≈û√áI', dates: [2, 4, 6, 8, 10, 12, 18, 20, 22, 24, 26, 28] },
                // HER SHIFT (Sarƒ±)
                'kuvings': { color: '#FFFF00', responsible: 'HER SHIFT', dates: [] },
                'blender': { color: '#FFFF00', responsible: 'HER SHIFT', dates: [] },
                'yasomi': { color: '#FFFF00', responsible: 'HER SHIFT', dates: [] },
                '√ßama≈üƒ±r sulu paspas': { color: '#FFFF00', responsible: 'HER SHIFT', dates: [] },
                'mikrodalga': { color: '#FFFF00', responsible: 'HER SHIFT', dates: [] },
                // ARACI (Kƒ±rmƒ±zƒ±)
                'mutfak t√ºm zeminler': { color: '#C00000', responsible: 'ARACI', dates: [2, 4, 6, 8, 10, 12, 18, 20, 22, 24, 26, 28] },
                'beyaz duvarlar': { color: '#C00000', responsible: 'ARACI', dates: [1, 3, 5, 7, 9, 11, 17, 19, 21, 23, 25, 27] },
                'bar raflarƒ±': { color: '#C00000', responsible: 'ARACI', dates: [1, 3, 5, 7, 9, 11, 17, 19, 21, 23, 25, 27] },
                'dolap i√ß ve dƒ±≈ü': { color: '#C00000', responsible: 'ARACI', dates: [1, 3, 5, 7, 9, 11, 17, 19, 21, 23, 25, 27] },
                'dolap raylarƒ±': { color: '#C00000', responsible: 'ARACI', dates: [1, 3, 5, 7, 9, 11, 17, 19, 21, 23, 25, 27] },
                // KAPANI≈û√áI (Turuncu)
                'bardaklar': { color: '#FFC000', responsible: 'KAPANI≈û√áI', dates: [2, 4, 6, 8, 10, 12, 18, 20, 22, 24, 26, 28] },
                'tabaklar': { color: '#FFC000', responsible: 'KAPANI≈û√áI', dates: [2, 4, 6, 8, 10, 12, 18, 20, 22, 24, 26, 28] },
                'ka≈üƒ±k': { color: '#FFC000', responsible: 'KAPANI≈û√áI', dates: [2, 4, 6, 8, 10, 12, 18, 20, 22, 24, 26, 28] },
                'dolap camlarƒ±': { color: '#FFC000', responsible: 'KAPANI≈û√áI', dates: [1, 3, 5, 7, 9, 11, 17, 19, 21, 23, 25, 27] },
                'espresso makinasƒ± ka≈üƒ±k': { color: '#FFC000', responsible: 'KAPANI≈û√áI', dates: [] },
                'espresso makinasƒ± detaylƒ±': { color: '#FFC000', responsible: 'KAPANI≈û√áI', dates: [2, 4, 6, 8, 10, 12, 18, 20, 22, 24, 26, 28] },
                '√ßay demlikleri': { color: '#FFC000', responsible: 'KAPANI≈û√áI', dates: [1, 3, 5, 7, 9, 11, 17, 19, 21, 23, 25, 27] },
                'dƒ±≈ü mekan camlarƒ±': { color: '#FFC000', responsible: 'KAPANI≈û√áI', dates: [5, 27] },
                'beyaz minderler': { color: '#FFC000', responsible: 'KAPANI≈û√áI', dates: [14, 25] },
                'buz makinasƒ±': { color: '#FFC000', responsible: 'KAPANI≈û√áI', dates: [12, 28] },
                'tv √ºst√º': { color: '#FFC000', responsible: 'KAPANI≈û√áI', dates: [11, 20] }
            };
            
            // Her item'a mapping'den renk ve tarih bilgisi ekle
            items = items.map(item => {
                if (item.color && item.dates) return item; // Zaten yeni formatta
                
                const textLower = (item.text || '').toLowerCase();
                for (const [key, value] of Object.entries(aylikMapping)) {
                    if (textLower.includes(key)) {
                        return { ...item, ...value };
                    }
                }
                return item;
            });
        }
        
        // Temizlik ve Bakƒ±m (aylik) i√ßin tarih filtreleme
        let filteredItems = items;
        let totalItemCount = items.length;
        let showAllItems = false;
        
        if (type === 'aylik') {
            const selectedDate = new Date(date);
            const dayOfMonth = selectedDate.getDate();
            
            filteredItems = items.filter(item => {
                // Yeni format: item.dates dizisi varsa kullan
                if (item.dates && Array.isArray(item.dates)) {
                    // Bo≈ü dizi = her g√ºn g√∂ster (HER SHIFT gibi)
                    if (item.dates.length === 0) return true;
                    return item.dates.includes(dayOfMonth);
                }
                
                // Eski format: text i√ßindeki tarihleri parse et
                const text = item.text || '';
                const dateMatch = text.match(/ayƒ±n\s*([\d,\-\s]+)/i);
                if (!dateMatch) return true;
                
                const dateStr = dateMatch[1];
                const dates = dateStr.split(/[,\s]+/).flatMap(part => {
                    if (part.includes('-')) {
                        return part.split('-').map(d => parseInt(d.trim()));
                    }
                    return [parseInt(part.trim())];
                }).filter(d => !isNaN(d));
                
                return dates.includes(dayOfMonth);
            });
            
            console.log(`Temizlik ve Bakƒ±m: ${filteredItems.length}/${totalItemCount} madde (Ayƒ±n ${dayOfMonth})`);
        }
        
        // Daha √∂nce doldurulmu≈ü mu kontrol et
        let submittedData = null;
        try {
            const submissionId = `${checklistId}_${date}${timeSlot ? '_' + timeSlot.replace(':', '') : ''}`;
            const submissionDoc = await db.collection('checklistSubmissions').doc(submissionId).get();
            if (submissionDoc.exists) {
                submittedData = submissionDoc.data();
            }
        } catch (subError) {
            console.warn('Submission kontrol hatasƒ±:', subError);
        }
        
        // Formu render et
        renderChecklistForm(filteredItems, branch, type, date, timeSlot, submittedData, totalItemCount);
        
    } catch (error) {
        console.error('Checklist y√ºkleme hatasƒ±:', error);
        container.innerHTML = `<div style="color:var(--red);padding:20px;text-align:center">
            <div style="font-size:2rem;margin-bottom:8px">‚ö†Ô∏è</div>
            Checklist y√ºklenirken hata olu≈ütu: ${error.message || 'Bilinmeyen hata'}
        </div>`;
    }
}

// Checklist formunu render et
let checklistEditMode = false;

function renderChecklistForm(items, branch, type, date, timeSlot, submittedData, totalItemCount = null) {
    const container = document.getElementById('checklistFormContainer');
    const isAdmin = currentUser?.role === 'yonetici' || currentUser?.role === 'bolge_muduru';
    const isManager = currentUser?.role === 'yonetici' || currentUser?.role === 'magaza_muduru' || currentUser?.role === 'bolge_muduru';
    const isSubmitted = !!submittedData;
    const actualTotalCount = totalItemCount || items.length;
    
    // Zamanlama sƒ±fƒ±rla (yeni checklist)
    if (!isSubmitted) {
        checklistStartTime = null;
        checklistFirstItemTime = null;
        // Beklenen s√ºreyi sadece G√ñR√úNEN maddeler i√ßin hesapla
        checklistExpectedDuration = items.reduce((sum, item) => sum + (item.duration || 60), 0);
    }
    
    // Kullanƒ±cƒ± adƒ±nƒ± email'den al
    const autoPersonName = getUserNameFromEmail(currentUser?.email) || currentUser?.name || '';
    const isAutoName = !!getUserNameFromEmail(currentUser?.email);
    
    // Platform check i√ßin √∂zel render
    if (type === 'platform') {
        renderPlatformChecklist(container, branch, date, timeSlot, submittedData);
        return;
    }
    
    // Haftalƒ±k g√∂revler i√ßin √∂zel render
    if (type === 'haftalik') {
        renderHaftalikGorevler(container, items, branch, date, submittedData);
        return;
    }
    
    let typeInfo = CHECKLIST_TYPES[branch]?.find(t => t.id === type);
    const expectedMinutes = Math.round(checklistExpectedDuration / 60);
    const iconSvg = getIcon(typeInfo?.icon || 'clipboard-check');
    
    // Sticky toolbar i√ßin data attribute
    const toolbarData = `data-branch="${branch}" data-type="${type}" data-date="${date}" data-timeslot="${timeSlot || ''}"`;
    
    let html = `
        <div class="form-section">
            <!-- Sticky Toolbar -->
            <div id="checklistToolbar" class="checklist-toolbar" ${toolbarData} style="position:sticky;top:0;z-index:100;background:var(--bg);padding:12px 0;margin:-12px -16px 16px;padding:12px 16px;border-bottom:1px solid var(--cardBorder)">
                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
                    <div>
                        <div style="font-size:1.2rem;font-weight:700;color:var(--tx);display:flex;align-items:center;gap:10px">
                            <span style="opacity:.7">${iconSvg}</span>
                            ${typeInfo?.name || type}
                            ${type === 'aylik' && items.length < actualTotalCount ? `<span style="font-size:.75rem;background:var(--accent);color:#fff;padding:2px 8px;border-radius:10px">${items.length}/${actualTotalCount}</span>` : ''}
                        </div>
                        <div style="font-size:.8rem;color:var(--tx2)">${branch} ‚Ä¢ ${new Date(date).toLocaleDateString('tr-TR', {weekday: 'long', day: 'numeric', month: 'long'})}${timeSlot ? ' ‚Ä¢ ' + timeSlot : ''}</div>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                        ${type === 'aylik' ? `
                            <button class="btn btn-sm btn-ghost" onclick="toggleShowAllAylikItems('${branch}', '${type}', '${date}', '${timeSlot || ''}')">
                                üìã T√ºm√ºn√º G√∂ster
                            </button>
                        ` : ''}
                        ${isSubmitted ? `
                            <div style="display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:rgba(39,174,96,.15);color:#27ae60;border-radius:16px;font-size:.8rem">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                                Tamamlandƒ±
                            </div>
                        ` : ''}
                        ${isAdmin && !isSubmitted ? `
                            <button class="btn btn-sm ${checklistEditMode ? 'btn-primary' : 'btn-ghost'}" onclick="toggleChecklistEditMode('${branch}', '${type}', '${date}', '${timeSlot || ''}')">
                                ${checklistEditMode ? '‚úì D√ºzenleme' : '‚úèÔ∏è D√ºzenle'}
                            </button>
                        ` : ''}
                    </div>
                </div>
            </div>
            
            ${isSubmitted ? `
                <div style="font-size:.75rem;color:var(--tx3);margin-bottom:16px">${submittedData.submittedByName} ‚Ä¢ ${submittedData.submittedAt?.toDate ? new Date(submittedData.submittedAt.toDate()).toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'}) : ''}</div>
            ` : ''}
            
            ${type === 'aylik' && !checklistEditMode ? `
                <!-- Temizlik ve Bakƒ±m - Sorumlu Renk A√ßƒ±klamasƒ± -->
                <div style="margin-bottom:20px;padding:14px;background:var(--bg3);border-radius:12px">
                    <div style="font-size:.75rem;color:var(--tx2);margin-bottom:10px;font-weight:600">üé® Kƒ∞M SORUMLU?</div>
                    <div style="display:flex;flex-wrap:wrap;gap:12px">
                        <div style="display:flex;align-items:center;gap:6px">
                            <span style="width:16px;height:16px;background:#00B0F0;border-radius:4px"></span>
                            <span style="font-size:.8rem;color:var(--tx)">A√áILI≈û√áI</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:6px">
                            <span style="width:16px;height:16px;background:#FFFF00;border-radius:4px;border:1px solid #ccc"></span>
                            <span style="font-size:.8rem;color:var(--tx)">HER SHIFT</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:6px">
                            <span style="width:16px;height:16px;background:#C00000;border-radius:4px"></span>
                            <span style="font-size:.8rem;color:var(--tx)">ARACI</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:6px">
                            <span style="width:16px;height:16px;background:#FFC000;border-radius:4px"></span>
                            <span style="font-size:.8rem;color:var(--tx)">KAPANI≈û√áI</span>
                        </div>
                    </div>
                </div>
            ` : ''}
            
            ${!checklistEditMode ? `
                <!-- Personel ve Zaman Bilgisi -->
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px">
                    <div style="padding:16px;background:var(--bg3);border-radius:12px">
                        <label class="form-label" style="margin-bottom:8px;display:flex;align-items:center;gap:6px">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                            Personel
                        </label>
                        <input type="text" id="checklistPersonName" class="form-input" 
                            value="${submittedData?.personName || autoPersonName}" 
                            disabled style="opacity:0.7;background:var(--bg2);cursor:not-allowed">
                        <div style="font-size:.75rem;color:var(--tx3);margin-top:4px">üîí Giri≈ü yapan kullanƒ±cƒ±</div>
                    </div>
                    <div style="padding:16px;background:var(--bg3);border-radius:12px">
                        <label class="form-label" style="margin-bottom:8px;display:flex;align-items:center;gap:6px">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                            Tahmini S√ºre
                        </label>
                        <div style="font-size:1.1rem;font-weight:600;color:var(--tx)">${expectedMinutes} dakika</div>
                        <div style="font-size:.75rem;color:var(--tx3)">${items.length} madde</div>
                    </div>
                </div>
                
                <!-- Ba≈ülangƒ±√ß Zamanƒ± Banner -->
                <div id="checklistTimerBanner" style="display:none;margin-bottom:16px;padding:14px 16px;background:linear-gradient(135deg,rgba(0,140,149,.15),rgba(0,140,149,.05));border:1px solid rgba(0,140,149,.3);border-radius:12px">
                    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
                        <div style="display:flex;align-items:center;gap:8px">
                            <div style="width:8px;height:8px;background:#27ae60;border-radius:50%;animation:pulse 1.5s infinite"></div>
                            <span style="font-weight:600;color:var(--tx)">Checklist Ba≈üladƒ±</span>
                        </div>
                        <div style="font-size:.9rem;color:var(--tx2)">
                            <span id="checklistStartTimeDisplay">--:--:--</span>
                        </div>
                    </div>
                </div>
                
                <style>@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}</style>
                
                <div style="margin-bottom:16px;padding:12px;background:rgba(255,134,116,.1);border-radius:10px;font-size:.85rem;color:var(--tx2)">
                    ‚ö†Ô∏è <strong>√ñnemli:</strong> ƒ∞lk maddeyi i≈üaretlediƒüinizde s√ºre ba≈ülar. T√ºm maddeleri dikkatlice kontrol edin.
                </div>
            ` : `
                <div style="margin-bottom:16px;padding:16px;background:rgba(0,140,149,.1);border-radius:12px">
                    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
                        <div style="font-size:.9rem;color:var(--tx)">
                            <strong>üìù D√ºzenleme Modu</strong> - Madde ekle, sil veya toplu i≈ülem yap
                        </div>
                        <div style="display:flex;gap:8px;flex-wrap:wrap">
                            <button class="btn btn-sm btn-primary" onclick="showAddChecklistItemModal()">+ Madde Ekle</button>
                            <button class="btn btn-sm btn-ghost" onclick="selectAllChecklistItems()">‚òëÔ∏è T√ºm√ºn√º Se√ß</button>
                            <button class="btn btn-sm btn-ghost" onclick="deselectAllChecklistItems()">‚òê Se√ßimi Kaldƒ±r</button>
                            <button class="btn btn-sm" style="background:#e74c3c;color:#fff" onclick="deleteSelectedChecklistItems('${branch}', '${type}')">üóëÔ∏è Se√ßilenleri Sil</button>
                        </div>
                    </div>
                </div>
            `}
            
            <div id="checklistItems">
    `;
    
    items.forEach((item, index) => {
        const isChecked = submittedData?.items?.find(i => i.id === item.id)?.checked;
        const isNotDone = submittedData?.items?.find(i => i.id === item.id)?.notDone;
        const itemNum = index + 1;
        
        // Temizlik ve Bakƒ±m i√ßin renk ve sorumlu bilgisi
        const hasColor = item.color;
        const isAylik = type === 'aylik';
        const colorStyle = hasColor ? `border-left:5px solid ${item.color};` : '';
        const bgColor = hasColor ? `background:${item.color}08;` : '';
        
        // Sorumlu badge
        const responsibleBadge = hasColor && item.responsible ? `
            <span style="font-size:.65rem;padding:3px 8px;border-radius:12px;background:${item.color};color:#fff;font-weight:600;white-space:nowrap;text-shadow:0 1px 1px rgba(0,0,0,.2)">${item.responsible}</span>
        ` : '';
        
        // Tarih badge (sadece aylik i√ßin ve tarih varsa)
        const datesBadge = isAylik && item.dates && item.dates.length > 0 ? `
            <span style="font-size:.65rem;padding:2px 6px;border-radius:8px;background:var(--bg4);color:var(--tx2);white-space:nowrap">üìÖ Ayƒ±n ${item.dates.slice(0,4).join(', ')}${item.dates.length > 4 ? '...' : ''}</span>
        ` : (isAylik && (!item.dates || item.dates.length === 0) ? `
            <span style="font-size:.65rem;padding:2px 6px;border-radius:8px;background:var(--bg4);color:var(--tx2);white-space:nowrap">üîÑ Her g√ºn</span>
        ` : '');
        
        if (checklistEditMode) {
            // D√ºzenleme modu - checkbox ile se√ßim
            html += `
                <div class="checklist-item" data-item-id="${item.id}" style="display:flex;align-items:center;gap:12px;padding:14px;${bgColor}border-radius:10px;margin-bottom:8px;border:1px solid var(--cardBorder);${colorStyle}">
                    <input type="checkbox" class="checklist-select-item" value="${item.id}" style="width:20px;height:20px;cursor:pointer;accent-color:#008c95">
                    <span style="min-width:28px;height:28px;background:${hasColor ? item.color : 'var(--bg3)'};border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:.8rem;font-weight:600;color:${hasColor ? '#fff' : 'var(--tx2)'}">${itemNum}</span>
                    <div style="flex:1">
                        <div style="font-size:.9rem;color:var(--tx)">${item.text}</div>
                        ${isAylik ? `<div style="margin-top:4px;display:flex;gap:6px;flex-wrap:wrap">${responsibleBadge}${datesBadge}</div>` : ''}
                    </div>
                    <button onclick="editChecklistItem('${item.id}')" style="background:none;border:none;color:var(--accent2);cursor:pointer;padding:6px;border-radius:6px;transition:all .2s" title="D√ºzenle">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                    </button>
                    <button onclick="deleteChecklistItem('${item.id}')" style="background:none;border:none;color:#e74c3c;cursor:pointer;padding:6px;border-radius:6px;transition:all .2s" title="Sil">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2M10 11v6M14 11v6"/></svg>
                    </button>
                </div>
            `;
        } else {
            // Normal mod - check/uncheck with auto numbering
            html += `
                <div class="checklist-item" style="display:flex;align-items:flex-start;gap:12px;padding:16px;${bgColor}border-radius:10px;margin-bottom:10px;border:1px solid var(--cardBorder);${colorStyle}">
                    <span style="min-width:32px;height:32px;background:${hasColor ? item.color : 'var(--bg3)'};border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:.85rem;font-weight:600;color:${hasColor ? '#fff' : 'var(--tx2)'};flex-shrink:0">${itemNum}</span>
                    <div style="display:flex;gap:8px;flex-shrink:0">
                        <label class="check-option" style="display:flex;align-items:center;gap:6px;cursor:${isSubmitted ? 'default' : 'pointer'}">
                            <input type="radio" name="check_${item.id}" value="done" 
                                ${isChecked ? 'checked' : ''} ${isSubmitted ? 'disabled' : ''}
                                style="display:none">
                            <span class="check-btn done ${isChecked ? 'active' : ''}" onclick="${isSubmitted ? '' : `selectCheckOption(this, '${item.id}', 'done')`}"
                                style="width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;
                                background:${isChecked ? 'rgba(39,174,96,.2)' : 'var(--bg3)'};
                                border:2px solid ${isChecked ? '#27ae60' : 'var(--cardBorder)'};
                                color:${isChecked ? '#27ae60' : 'var(--tx3)'};
                                transition:all .2s">‚úì</span>
                        </label>
                        <label class="check-option" style="display:flex;align-items:center;gap:6px;cursor:${isSubmitted ? 'default' : 'pointer'}">
                            <input type="radio" name="check_${item.id}" value="notdone" 
                                ${isNotDone ? 'checked' : ''} ${isSubmitted ? 'disabled' : ''}
                                style="display:none">
                            <span class="check-btn notdone ${isNotDone ? 'active' : ''}" onclick="${isSubmitted ? '' : `selectCheckOption(this, '${item.id}', 'notdone')`}"
                                style="width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;
                                background:${isNotDone ? 'rgba(231,76,60,.2)' : 'var(--bg3)'};
                                border:2px solid ${isNotDone ? '#e74c3c' : 'var(--cardBorder)'};
                                color:${isNotDone ? '#e74c3c' : 'var(--tx3)'};
                                transition:all .2s">‚úó</span>
                        </label>
                    </div>
                    <div style="flex:1">
                        <div style="font-size:.9rem;color:var(--tx);line-height:1.5">${item.text}</div>
                        ${isAylik ? `<div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap">${responsibleBadge}${datesBadge}</div>` : ''}
                    </div>
                </div>
            `;
        }
    });
    
    html += `
            </div>
            
            ${!checklistEditMode && !isSubmitted ? `
                <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;flex-wrap:wrap">
                    <button class="btn btn-ghost" onclick="loadChecklist()">üîÑ Yenile</button>
                    <button class="btn btn-ghost" onclick="downloadChecklistPDF()">üì• PDF ƒ∞ndir</button>
                    <button class="btn btn-primary" onclick="submitChecklist('${branch}', '${type}', '${date}', '${timeSlot || ''}')">
                        ‚úÖ Checklist'i Tamamla
                    </button>
                </div>
            ` : ''}
            ${!checklistEditMode && isSubmitted ? `
                <div style="margin-top:24px;text-align:center;color:var(--tx2)">
                    Bu checklist zaten tamamlanmƒ±≈ü
                </div>
            ` : ''}
            ${checklistEditMode ? `
                <div style="margin-top:24px;text-align:center">
                    <div style="font-size:.85rem;color:var(--tx2)">Toplam ${items.length} madde</div>
                </div>
            ` : ''}
        </div>
    `;
    
    container.innerHTML = html;
}

// D√ºzenleme modunu a√ß/kapat
function toggleChecklistEditMode(branch, type, date, timeSlot) {
    checklistEditMode = !checklistEditMode;
    loadChecklist();
}

// T√ºm√ºn√º se√ß
function selectAllChecklistItems() {
    document.querySelectorAll('.checklist-select-item').forEach(cb => cb.checked = true);
}

// Se√ßimi kaldƒ±r
function deselectAllChecklistItems() {
    document.querySelectorAll('.checklist-select-item').forEach(cb => cb.checked = false);
}

// Se√ßilenleri sil
async function deleteSelectedChecklistItems(branch, type) {
    const selected = Array.from(document.querySelectorAll('.checklist-select-item:checked')).map(cb => cb.value);
    
    if (selected.length === 0) {
        toast('Silmek i√ßin madde se√ßin', 'error');
        return;
    }
    
    if (!confirm(`${selected.length} madde silinecek. Emin misiniz?`)) return;
    
    try {
        const checklistId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_${type}`;
        const checklistRef = db.collection('checklists').doc(checklistId);
        const doc = await checklistRef.get();
        
        if (doc.exists) {
            const items = doc.data().items.filter(i => !selected.includes(i.id));
            await checklistRef.update({
                items,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        toast(`${selected.length} madde silindi`, 'success');
        loadChecklist();
        
    } catch (error) {
        console.error('Toplu silme hatasƒ±:', error);
        toast('Silme hatasƒ±!', 'error');
    }
}

// Check se√ßeneƒüi se√ß
function selectCheckOption(btn, itemId, value) {
    const parent = btn.closest('.checklist-item');
    const doneBtn = parent.querySelector('.check-btn.done');
    const notdoneBtn = parent.querySelector('.check-btn.notdone');
    const doneInput = parent.querySelector('input[value="done"]');
    const notdoneInput = parent.querySelector('input[value="notdone"]');
    
    // ƒ∞lk madde i≈üaretlendiƒüinde zamanlayƒ±cƒ±yƒ± ba≈ülat
    if (!checklistFirstItemTime) {
        checklistFirstItemTime = new Date();
        checklistStartTime = new Date();
        
        // Banner'ƒ± g√∂ster
        const banner = document.getElementById('checklistTimerBanner');
        if (banner) {
            banner.style.display = 'block';
            const timeDisplay = document.getElementById('checklistStartTimeDisplay');
            if (timeDisplay) {
                timeDisplay.textContent = checklistStartTime.toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
            }
        }
        
        // Bildirim g√∂ster
        const typeSelect = document.getElementById('checklistType');
        const typeName = typeSelect?.selectedOptions?.[0]?.text || 'Checklist';
        showToast(`${typeName} ba≈üladƒ±! Ba≈ülangƒ±√ß: ${checklistStartTime.toLocaleTimeString('tr-TR')}`, 'success');
    }
    
    // Reset
    doneBtn.style.background = 'var(--bg3)';
    doneBtn.style.borderColor = 'var(--cardBorder)';
    doneBtn.style.color = 'var(--tx3)';
    notdoneBtn.style.background = 'var(--bg3)';
    notdoneBtn.style.borderColor = 'var(--cardBorder)';
    notdoneBtn.style.color = 'var(--tx3)';
    
    if (value === 'done') {
        doneInput.checked = true;
        doneBtn.style.background = 'rgba(39,174,96,.2)';
        doneBtn.style.borderColor = '#27ae60';
        doneBtn.style.color = '#27ae60';
    } else {
        notdoneInput.checked = true;
        notdoneBtn.style.background = 'rgba(231,76,60,.2)';
        notdoneBtn.style.borderColor = '#e74c3c';
        notdoneBtn.style.color = '#e74c3c';
    }
    
    // T√ºm maddeler i≈üaretlendi mi kontrol et
    checkAllItemsMarked();
}

// T√ºm maddelerin i≈üaretlenip i≈üaretlenmediƒüini kontrol et
function checkAllItemsMarked() {
    const items = document.querySelectorAll('#checklistItems .checklist-item');
    let allMarked = true;
    let markedCount = 0;
    
    items.forEach(item => {
        const doneInput = item.querySelector('input[value="done"]');
        const notdoneInput = item.querySelector('input[value="notdone"]');
        if (doneInput?.checked || notdoneInput?.checked) {
            markedCount++;
        } else {
            allMarked = false;
        }
    });
    
    // ƒ∞lerleme g√∂stergesi g√ºncelle (opsiyonel)
    const progress = Math.round((markedCount / items.length) * 100);
    
    // Submit butonu aktifliƒüi
    const submitBtn = document.querySelector('button[onclick*="submitChecklist"]');
    if (submitBtn) {
        if (allMarked) {
            submitBtn.classList.remove('btn-ghost');
            submitBtn.classList.add('btn-primary');
            submitBtn.innerHTML = '‚úÖ Checklist\'i Tamamla';
        }
    }
}

// Platform checklist render
function renderPlatformChecklist(container, branch, date, timeSlot, submittedData) {
    const userName = currentUser?.name || currentUser?.email?.split('@')[0] || 'Personel';
    const isTuzla = branch.toLowerCase().includes('tuzla');
    
    // Saatler ve platformlar
    const timeSlots = ['10:00', '12:00', '15:00', '18:00', '21:00', '00:00'];
    const moonberryPlatforms = ['Trendyol', 'Yemek Sepeti', 'Getir Yemek', 'Migros'];
    const sunberryPlatforms = isTuzla ? ['Trendyol', 'Yemek Sepeti', 'Getir Yemek', 'Migros'] : [];
    
    // Daha √∂nce kaydedilmi≈ü veri
    const savedData = submittedData?.platformData || {};
    
    let html = `
        <div class="form-section">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                <div>
                    <div style="font-size:1.3rem;font-weight:700;color:var(--tx);display:flex;align-items:center;gap:10px">
                        <span style="font-size:1.5rem">üì±</span> Platform Check
                    </div>
                    <div style="font-size:.85rem;color:var(--tx2)">${branch} ‚Ä¢ ${new Date(date).toLocaleDateString('tr-TR', {weekday: 'long', day: 'numeric', month: 'long'})}</div>
                </div>
                <div style="font-size:.8rem;color:var(--tx2);text-align:right">
                    <div>üë§ ${userName}</div>
                </div>
            </div>
            
            <!-- Platform Check Tablosu -->
            <div style="overflow-x:auto;border-radius:12px;border:1px solid var(--cardBorder)">
                <table style="width:100%;border-collapse:collapse;min-width:800px">
                    <thead>
                        <tr>
                            <th rowspan="2" style="padding:12px;background:var(--bg3);border:1px solid var(--cardBorder);font-weight:600;color:var(--tx);width:70px">SAAT</th>
                            <th colspan="${moonberryPlatforms.length}" style="padding:10px;background:linear-gradient(135deg,#008C95,#00b5a0);color:#fff;text-align:center;font-weight:700;border:1px solid var(--cardBorder)">MOONBERRY</th>
                            ${isTuzla ? `<th colspan="${sunberryPlatforms.length}" style="padding:10px;background:linear-gradient(135deg,#ff8674,#ff6b5b);color:#fff;text-align:center;font-weight:700;border:1px solid var(--cardBorder)">SUNBERRY</th>` : ''}
                        </tr>
                        <tr>
                            ${moonberryPlatforms.map(p => `<th style="padding:8px;background:rgba(0,140,149,.15);font-size:.75rem;font-weight:600;color:var(--tx);border:1px solid var(--cardBorder);min-width:90px">${p}</th>`).join('')}
                            ${isTuzla ? sunberryPlatforms.map(p => `<th style="padding:8px;background:rgba(255,134,116,.15);font-size:.75rem;font-weight:600;color:var(--tx);border:1px solid var(--cardBorder);min-width:90px">${p}</th>`).join('') : ''}
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    timeSlots.forEach(time => {
        html += `<tr>
            <td style="padding:10px;background:var(--bg3);font-weight:600;color:var(--tx);text-align:center;border:1px solid var(--cardBorder)">${time}</td>
        `;
        
        // Moonberry platformlarƒ±
        moonberryPlatforms.forEach(platform => {
            const cellKey = `moonberry_${time}_${platform}`.replace(/[:\s]/g, '_');
            const cellData = savedData[cellKey];
            html += renderPlatformCell(cellKey, cellData, 'moonberry');
        });
        
        // Sunberry platformlarƒ± (sadece Tuzla)
        if (isTuzla) {
            sunberryPlatforms.forEach(platform => {
                const cellKey = `sunberry_${time}_${platform}`.replace(/[:\s]/g, '_');
                const cellData = savedData[cellKey];
                html += renderPlatformCell(cellKey, cellData, 'sunberry');
            });
        }
        
        html += `</tr>`;
    });
    
    html += `
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top:16px;display:flex;gap:16px;align-items:center;justify-content:space-between;flex-wrap:wrap">
                <div style="display:flex;gap:16px;font-size:.8rem;color:var(--tx2)">
                    <span style="display:flex;align-items:center;gap:4px"><span style="color:#27ae60;font-size:1.1rem">‚úì</span> A√ßƒ±k</span>
                    <span style="display:flex;align-items:center;gap:4px"><span style="color:#e74c3c;font-size:1.1rem">‚úó</span> Kapalƒ±</span>
                </div>
                <button class="btn btn-primary" onclick="savePlatformCheck('${branch}', '${date}')">
                    üíæ Kaydet
                </button>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

// Platform h√ºcre render
function renderPlatformCell(cellKey, cellData, brand) {
    const bgColor = brand === 'moonberry' ? 'rgba(255,134,116,.05)' : 'rgba(0,140,149,.05)';
    
    if (cellData) {
        // Daha √∂nce i≈üaretlenmi≈ü
        const isOpen = cellData.status === 'open';
        const statusColor = isOpen ? '#27ae60' : '#e74c3c';
        const statusBg = isOpen ? 'rgba(39,174,96,.15)' : 'rgba(231,76,60,.15)';
        const statusIcon = isOpen ? '‚úì' : '‚úó';
        return `
            <td style="padding:6px;border:1px solid var(--cardBorder);background:${statusBg};text-align:center;vertical-align:top">
                <div style="font-size:1.2rem;color:${statusColor};font-weight:bold">${statusIcon}</div>
                <div style="font-size:.65rem;color:var(--tx2);margin-top:2px">${cellData.person || ''}</div>
                <div style="font-size:.6rem;color:var(--tx3)">${cellData.time || ''}</div>
            </td>
        `;
    }
    
    // Bo≈ü h√ºcre - se√ßim yapƒ±labilir
    return `
        <td style="padding:4px;border:1px solid var(--cardBorder);background:${bgColor};text-align:center" data-cell="${cellKey}">
            <div style="display:flex;gap:4px;justify-content:center">
                <button onclick="setPlatformStatus('${cellKey}', 'open')" 
                    style="width:32px;height:32px;border-radius:6px;border:1px solid var(--cardBorder);background:var(--bg2);color:var(--tx3);cursor:pointer;font-size:1rem;transition:all .2s"
                    onmouseover="this.style.background='rgba(39,174,96,.2)';this.style.color='#27ae60';this.style.borderColor='#27ae60'"
                    onmouseout="this.style.background='var(--bg2)';this.style.color='var(--tx3)';this.style.borderColor='var(--cardBorder)'">‚úì</button>
                <button onclick="setPlatformStatus('${cellKey}', 'closed')" 
                    style="width:32px;height:32px;border-radius:6px;border:1px solid var(--cardBorder);background:var(--bg2);color:var(--tx3);cursor:pointer;font-size:1rem;transition:all .2s"
                    onmouseover="this.style.background='rgba(231,76,60,.2)';this.style.color='#e74c3c';this.style.borderColor='#e74c3c'"
                    onmouseout="this.style.background='var(--bg2)';this.style.color='var(--tx3)';this.style.borderColor='var(--cardBorder)'">‚úó</button>
            </div>
        </td>
    `;
}

// Platform status set
let platformCheckData = {};

function setPlatformStatus(cellKey, status) {
    const now = new Date();
    const timeStr = now.toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'});
    const userName = currentUser?.name || currentUser?.email?.split('@')[0] || 'Personel';
    
    platformCheckData[cellKey] = {
        status: status,
        person: userName,
        time: timeStr
    };
    
    // H√ºcreyi g√ºncelle
    const cell = document.querySelector(`td[data-cell="${cellKey}"]`);
    if (cell) {
        const isOpen = status === 'open';
        const statusColor = isOpen ? '#27ae60' : '#e74c3c';
        const statusBg = isOpen ? 'rgba(39,174,96,.15)' : 'rgba(231,76,60,.15)';
        const statusIcon = isOpen ? '‚úì' : '‚úó';
        
        cell.innerHTML = `
            <div style="font-size:1.2rem;color:${statusColor};font-weight:bold">${statusIcon}</div>
            <div style="font-size:.65rem;color:var(--tx2);margin-top:2px">${userName}</div>
            <div style="font-size:.6rem;color:var(--tx3)">${timeStr}</div>
        `;
        cell.style.background = statusBg;
        cell.removeAttribute('data-cell');
    }
    
    toast(`Platform ${status === 'open' ? 'a√ßƒ±k' : 'kapalƒ±'} olarak i≈üaretlendi`, 'success');
}

// Platform Check kaydet
async function savePlatformCheck(branch, date) {
    if (Object.keys(platformCheckData).length === 0) {
        toast('Hen√ºz hi√ßbir platform i≈üaretlenmedi', 'error');
        return;
    }
    
    try {
        const docId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_platform_${date}`;
        
        // Mevcut veriyi al ve birle≈ütir
        let existingData = {};
        try {
            const doc = await db.collection('platformChecks').doc(docId).get();
            if (doc.exists) {
                existingData = doc.data().platformData || {};
            }
        } catch (e) {}
        
        const mergedData = { ...existingData, ...platformCheckData };
        
        await db.collection('platformChecks').doc(docId).set({
            branch,
            date,
            platformData: mergedData,
            lastUpdatedBy: currentUser?.name || currentUser?.email,
            lastUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        
        toast('Platform Check kaydedildi!', 'success');
        platformCheckData = {}; // Reset
        
    } catch (error) {
        console.error('Platform Check kayƒ±t hatasƒ±:', error);
        toast('Kayƒ±t hatasƒ±: ' + error.message, 'error');
    }
}

// Platform status se√ß (eski fonksiyon - uyumluluk i√ßin)
function selectPlatformStatus(btn, platformKey, isOpen) {
    // Eski versiyon uyumluluƒüu
    setPlatformStatus(platformKey, isOpen ? 'open' : 'closed');
}

// Checklist g√∂nder
async function submitChecklist(branch, type, date, timeSlot) {
    const personName = document.getElementById('checklistPersonName')?.value?.trim();
    if (!personName) {
        toast('L√ºtfen personel adƒ±nƒ± girin', 'error');
        return;
    }
    
    // T√ºm maddelerin cevaplandƒ±ƒüƒ±nƒ± kontrol et
    const items = document.querySelectorAll('#checklistItems .checklist-item');
    const responses = [];
    let allAnswered = true;
    let doneCount = 0;
    
    items.forEach(item => {
        const doneInput = item.querySelector('input[value="done"]');
        const notdoneInput = item.querySelector('input[value="notdone"]');
        const itemId = doneInput?.name?.replace('check_', '');
        
        if (!doneInput?.checked && !notdoneInput?.checked) {
            allAnswered = false;
            item.style.borderColor = '#e74c3c';
        } else {
            item.style.borderColor = 'var(--cardBorder)';
            if (doneInput?.checked) doneCount++;
            responses.push({
                id: itemId,
                checked: doneInput?.checked || false,
                notDone: notdoneInput?.checked || false
            });
        }
    });
    
    if (!allAnswered) {
        toast('L√ºtfen t√ºm maddeleri i≈üaretleyin', 'error');
        return;
    }
    
    // S√ºre hesapla
    const endTime = new Date();
    const actualDuration = checklistStartTime ? Math.round((endTime - checklistStartTime) / 1000) : 0;
    const actualMinutes = Math.round(actualDuration / 60);
    const expectedMinutes = Math.round(checklistExpectedDuration / 60);
    const minExpectedMinutes = Math.round(expectedMinutes * 0.3); // Minimum %30
    
    // S√ºre uyarƒ±sƒ± g√∂ster
    if (actualDuration > 0 && actualMinutes < minExpectedMinutes) {
        showCompletionConfirmModal(branch, type, date, timeSlot, personName, responses, actualMinutes, expectedMinutes, doneCount, items.length);
        return;
    }
    
    // Doƒürudan kaydet
    await saveChecklistAndShare(branch, type, date, timeSlot, personName, responses, actualMinutes, expectedMinutes, doneCount, items.length);
}

// Tamamlama onay modal'ƒ±
function showCompletionConfirmModal(branch, type, date, timeSlot, personName, responses, actualMinutes, expectedMinutes, doneCount, totalCount) {
    const typeInfo = CHECKLIST_TYPES[branch]?.find(t => t.id === type);
    const typeName = typeInfo?.name || type;
    
    const modal = document.createElement('div');
    modal.id = 'completionConfirmModal';
    modal.innerHTML = `
        <div style="position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px">
            <div style="background:var(--bg2);border-radius:20px;max-width:420px;width:100%;padding:32px;text-align:center;border:1px solid var(--cardBorder)">
                <div style="width:64px;height:64px;background:rgba(255,134,116,.15);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px">
                    <svg width="32" height="32" fill="none" stroke="#ff8674" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                </div>
                <h3 style="font-size:1.3rem;font-weight:700;color:var(--tx);margin-bottom:12px">S√ºre Kontrol√º</h3>
                <p style="color:var(--tx2);margin-bottom:24px;line-height:1.6">
                    <strong>${typeName}</strong> i√ßin tahmini s√ºre <strong>${expectedMinutes} dakika</strong> iken, 
                    siz <strong>${actualMinutes} dakikada</strong> tamamladƒ±nƒ±z.<br><br>
                    T√ºm kontrolleri ger√ßekle≈ütirdiƒüinizden emin misiniz?
                </p>
                <div style="display:flex;gap:12px;justify-content:center">
                    <button onclick="document.getElementById('completionConfirmModal').remove()" class="btn btn-ghost" style="padding:12px 24px">
                        ‚Üê Geri D√∂n
                    </button>
                    <button onclick="confirmAndSaveChecklist('${branch}', '${type}', '${date}', '${timeSlot || ''}', '${personName}', ${actualMinutes}, ${expectedMinutes}, ${doneCount}, ${totalCount})" class="btn btn-primary" style="padding:12px 24px">
                        ‚úì Evet, Tamamla
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Responses'u ge√ßici sakla
    window._pendingResponses = responses;
}

// Onaylƒ± kaydet
async function confirmAndSaveChecklist(branch, type, date, timeSlot, personName, actualMinutes, expectedMinutes, doneCount, totalCount) {
    document.getElementById('completionConfirmModal')?.remove();
    const responses = window._pendingResponses || [];
    await saveChecklistAndShare(branch, type, date, timeSlot, personName, responses, actualMinutes, expectedMinutes, doneCount, totalCount);
}

// Checklist'i kaydet ve payla≈ü
async function saveChecklistAndShare(branch, type, date, timeSlot, personName, responses, actualMinutes, expectedMinutes, doneCount, totalCount) {
    try {
        const checklistId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_${type}`;
        const submissionId = `${checklistId}_${date}${timeSlot ? '_' + timeSlot.replace(':', '') : ''}`;
        
        const submissionData = {
            checklistId,
            branch,
            type,
            date,
            timeSlot: timeSlot || null,
            personName,
            submittedBy: currentUser?.id,
            submittedByName: currentUser?.name || personName,
            submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
            startTime: checklistStartTime?.toISOString() || null,
            endTime: new Date().toISOString(),
            actualDurationMinutes: actualMinutes,
            expectedDurationMinutes: expectedMinutes,
            completionRate: Math.round((doneCount / totalCount) * 100),
            items: responses
        };
        
        await db.collection('checklistSubmissions').doc(submissionId).set(submissionData);
        
        // Ba≈üarƒ± modal'ƒ± g√∂ster
        showChecklistCompleteModal(branch, type, date, timeSlot, personName, actualMinutes, expectedMinutes, doneCount, totalCount);
        
    } catch (error) {
        console.error('Checklist kayƒ±t hatasƒ±:', error);
        toast('Kayƒ±t hatasƒ±!', 'error');
    }
}

// Checklist tamamlandƒ± modal'ƒ± - WhatsApp payla≈üƒ±mƒ± ile
function showChecklistCompleteModal(branch, type, date, timeSlot, personName, actualMinutes, expectedMinutes, doneCount, totalCount) {
    const typeInfo = CHECKLIST_TYPES[branch]?.find(t => t.id === type);
    const typeName = typeInfo?.name || type;
    const completionRate = Math.round((doneCount / totalCount) * 100);
    const dateStr = new Date(date).toLocaleDateString('tr-TR', {day: 'numeric', month: 'long', year: 'numeric'});
    const timeStr = new Date().toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'});
    
    const modal = document.createElement('div');
    modal.id = 'checklistCompleteModal';
    modal.innerHTML = `
        <div style="position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px">
            <div style="background:var(--bg2);border-radius:20px;max-width:480px;width:100%;padding:32px;text-align:center;border:1px solid var(--cardBorder)">
                <div style="width:80px;height:80px;background:linear-gradient(135deg,rgba(39,174,96,.2),rgba(39,174,96,.1));border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 24px">
                    <svg width="40" height="40" fill="none" stroke="#27ae60" stroke-width="2.5" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                </div>
                <h3 style="font-size:1.5rem;font-weight:700;color:var(--tx);margin-bottom:8px">Checklist Tamamlandƒ±!</h3>
                <p style="color:var(--tx2);margin-bottom:24px">${typeName} ‚Ä¢ ${branch}</p>
                
                <div style="background:var(--bg3);border-radius:12px;padding:20px;margin-bottom:24px;text-align:left">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                        <div>
                            <div style="font-size:.75rem;color:var(--tx3);margin-bottom:4px">Personel</div>
                            <div style="font-weight:600;color:var(--tx)">${personName}</div>
                        </div>
                        <div>
                            <div style="font-size:.75rem;color:var(--tx3);margin-bottom:4px">Tarih</div>
                            <div style="font-weight:600;color:var(--tx)">${dateStr}</div>
                        </div>
                        <div>
                            <div style="font-size:.75rem;color:var(--tx3);margin-bottom:4px">S√ºre</div>
                            <div style="font-weight:600;color:var(--tx)">${actualMinutes} dk <span style="color:var(--tx3);font-weight:400">(tahmini ${expectedMinutes} dk)</span></div>
                        </div>
                        <div>
                            <div style="font-size:.75rem;color:var(--tx3);margin-bottom:4px">Tamamlama</div>
                            <div style="font-weight:600;color:#27ae60">${completionRate}% (${doneCount}/${totalCount})</div>
                        </div>
                    </div>
                </div>
                
                <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
                    <button onclick="closeCompleteModalAndRefresh()" class="btn btn-ghost" style="padding:12px 20px">
                        ‚úì Tamam
                    </button>
                    <button onclick="shareChecklistToWhatsApp('${branch}', '${typeName}', '${personName}', '${dateStr}', '${timeStr}', ${actualMinutes}, ${completionRate}, ${doneCount}, ${totalCount})" class="btn btn-primary" style="padding:12px 20px;background:linear-gradient(135deg,#25D366,#128C7E)">
                        <svg width="18" height="18" fill="#fff" viewBox="0 0 24 24" style="margin-right:6px"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                        WhatsApp'ta Payla≈ü
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Modal kapat ve yenile
function closeCompleteModalAndRefresh() {
    document.getElementById('checklistCompleteModal')?.remove();
    loadChecklist();
}

// WhatsApp'ta payla≈ü
function shareChecklistToWhatsApp(branch, typeName, personName, dateStr, timeStr, duration, rate, done, total) {
    const whatsappLink = WHATSAPP_GROUPS[branch];
    
    const message = `‚úÖ *CHECKLIST TAMAMLANDI*

üìã *${typeName}*
üìç ${branch}
üë§ ${personName}
üìÖ ${dateStr} - ${timeStr}

‚è±Ô∏è S√ºre: ${duration} dakika
‚úì Tamamlanan: ${done}/${total} (%${rate})

_Moonberry ƒ∞K Sistemi_`;

    const encodedMessage = encodeURIComponent(message);
    
    // WhatsApp grup linkini a√ß
    if (whatsappLink) {
        // √ñnce mesajƒ± kopyala
        navigator.clipboard?.writeText(message).then(() => {
            toast('Mesaj kopyalandƒ±! WhatsApp grubu a√ßƒ±lƒ±yor...', 'success');
        }).catch(() => {});
        
        // Grup linkini a√ß
        setTimeout(() => {
            window.open(whatsappLink, '_blank');
        }, 500);
    } else {
        // Genel WhatsApp payla≈üƒ±mƒ±
        window.open(`https://wa.me/?text=${encodedMessage}`, '_blank');
    }
    
    document.getElementById('checklistCompleteModal')?.remove();
    loadChecklist();
}

// Platform checklist g√∂nder
async function submitPlatformChecklist(branch, date, timeSlot) {
    const personName = document.getElementById('checklistPersonName')?.value?.trim();
    if (!personName) {
        toast('L√ºtfen personel adƒ±nƒ± girin', 'error');
        return;
    }
    
    const platforms = [];
    let allAnswered = true;
    
    PLATFORMS.forEach(platform => {
        const key = platform.replace(/\s/g, '_');
        const openInput = document.querySelector(`input[name="platform_${key}"][value="open"]`);
        const closedInput = document.querySelector(`input[name="platform_${key}"][value="closed"]`);
        
        if (!openInput?.checked && !closedInput?.checked) {
            allAnswered = false;
        } else {
            platforms.push({
                name: platform,
                isOpen: openInput?.checked || false
            });
        }
    });
    
    if (!allAnswered) {
        toast('L√ºtfen t√ºm platformlarƒ± i≈üaretleyin', 'error');
        return;
    }
    
    try {
        const checklistId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_platform`;
        const submissionId = `${checklistId}_${date}_${timeSlot.replace(':', '')}`;
        
        await db.collection('checklistSubmissions').doc(submissionId).set({
            checklistId,
            branch,
            type: 'platform',
            date,
            timeSlot,
            personName,
            submittedBy: currentUser?.id,
            submittedByName: currentUser?.name || personName,
            submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
            platforms
        });
        
        toast('Platform check kaydedildi!', 'success');
        loadChecklist();
        
    } catch (error) {
        console.error('Platform check kayƒ±t hatasƒ±:', error);
        toast('Kayƒ±t hatasƒ±!', 'error');
    }
}

// Checklist madde ekle modal
function showAddChecklistItemModal(editItem = null) {
    const branch = document.getElementById('checklistSube')?.value;
    const type = document.getElementById('checklistType')?.value;
    
    if (!branch || !type) {
        toast('√ñnce checklist se√ßin', 'error');
        return;
    }
    
    const isAylik = type === 'aylik';
    const isEdit = !!editItem;
    const title = isEdit ? 'Madde D√ºzenle' : 'Yeni Madde Ekle';
    
    // Tarih se√ßenekleri (1-31)
    const dateOptions = Array.from({length: 31}, (_, i) => i + 1);
    const selectedDates = editItem?.dates || [];
    
    showModal(title, `
        <div class="form-group">
            <label class="form-label">Madde Metni *</label>
            <textarea id="newChecklistItemText" class="form-input" rows="3" placeholder="Kontrol maddesi...">${editItem?.text || ''}</textarea>
        </div>
        <div class="form-group">
            <label class="form-label">Tahmini S√ºre (saniye)</label>
            <input type="number" id="newChecklistItemDuration" class="form-input" placeholder="√∂rn: 300" value="${editItem?.duration || 60}">
        </div>
        ${isAylik ? `
            <div class="form-group">
                <label class="form-label">Sorumlu</label>
                <select id="newChecklistItemResponsible" class="form-select">
                    <option value="">-- Se√ßin --</option>
                    <option value="A√áILI≈û√áI" ${editItem?.responsible === 'A√áILI≈û√áI' ? 'selected' : ''}>üîµ A√áILI≈û√áI</option>
                    <option value="HER SHIFT" ${editItem?.responsible === 'HER SHIFT' ? 'selected' : ''}>üü° HER SHIFT</option>
                    <option value="ARACI" ${editItem?.responsible === 'ARACI' ? 'selected' : ''}>üî¥ ARACI</option>
                    <option value="KAPANI≈û√áI" ${editItem?.responsible === 'KAPANI≈û√áI' ? 'selected' : ''}>üü† KAPANI≈û√áI</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Yapƒ±lacak G√ºnler (bo≈ü = her g√ºn)</label>
                <div style="display:flex;flex-wrap:wrap;gap:4px;max-height:150px;overflow-y:auto;padding:8px;background:var(--bg3);border-radius:8px">
                    ${dateOptions.map(d => `
                        <label style="display:flex;align-items:center;gap:4px;padding:4px 8px;background:var(--bg2);border-radius:6px;cursor:pointer;font-size:.8rem">
                            <input type="checkbox" class="newItemDate" value="${d}" ${selectedDates.includes(d) ? 'checked' : ''}>
                            ${d}
                        </label>
                    `).join('')}
                </div>
                <div style="font-size:.75rem;color:var(--tx3);margin-top:4px">Hi√ß se√ßilmezse her g√ºn g√∂sterilir</div>
            </div>
        ` : `
            <div class="form-group">
                <label class="form-label">Ceza (opsiyonel)</label>
                <input type="text" id="newChecklistItemPenalty" class="form-input" placeholder="√∂rn: -100 puan" value="${editItem?.penalty || ''}">
            </div>
        `}
        <input type="hidden" id="editChecklistItemId" value="${editItem?.id || ''}">
    `, `
        <button class="btn btn-ghost" onclick="closeModal()">ƒ∞ptal</button>
        <button class="btn btn-primary" onclick="addChecklistItem('${branch}', '${type}')">${isEdit ? 'G√ºncelle' : 'Ekle'}</button>
    `);
}

// Checklist madde d√ºzenle
function editChecklistItem(itemId) {
    const branch = document.getElementById('checklistSube')?.value;
    const type = document.getElementById('checklistType')?.value;
    
    // Firebase'den maddeyi bul
    const checklistId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_${type}`;
    db.collection('checklists').doc(checklistId).get().then(doc => {
        if (doc.exists) {
            const item = doc.data().items?.find(i => i.id === itemId);
            if (item) {
                showAddChecklistItemModal(item);
            }
        }
    });
}

// Checklist madde ekle/g√ºncelle
async function addChecklistItem(branch, type) {
    const text = document.getElementById('newChecklistItemText')?.value?.trim();
    const duration = parseInt(document.getElementById('newChecklistItemDuration')?.value) || 60;
    const editId = document.getElementById('editChecklistItemId')?.value;
    const isEdit = !!editId;
    
    if (!text) {
        toast('Madde metni gerekli', 'error');
        return;
    }
    
    // Temizlik ve bakƒ±m i√ßin ek alanlar
    const isAylik = type === 'aylik';
    let responsible = '';
    let dates = [];
    let color = '';
    
    if (isAylik) {
        responsible = document.getElementById('newChecklistItemResponsible')?.value || '';
        const dateCheckboxes = document.querySelectorAll('.newItemDate:checked');
        dates = Array.from(dateCheckboxes).map(cb => parseInt(cb.value));
        
        // Sorumluya g√∂re renk ata
        const colorMap = {
            'A√áILI≈û√áI': '#00B0F0',
            'HER SHIFT': '#FFFF00',
            'ARACI': '#C00000',
            'KAPANI≈û√áI': '#FFC000'
        };
        color = colorMap[responsible] || '';
    }
    
    const penalty = document.getElementById('newChecklistItemPenalty')?.value?.trim() || null;
    
    try {
        const checklistId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_${type}`;
        const checklistRef = db.collection('checklists').doc(checklistId);
        const doc = await checklistRef.get();
        
        const newItem = {
            id: isEdit ? editId : 'item_' + Date.now(),
            text,
            duration,
            ...(isAylik && { responsible, dates, color }),
            ...(!isAylik && penalty && { penalty }),
            order: (doc.exists ? doc.data().items?.length : 0) + 1
        };
        
        if (isEdit && doc.exists) {
            // G√ºncelleme
            const items = doc.data().items.map(i => i.id === editId ? newItem : i);
            await checklistRef.update({
                items,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            toast('Madde g√ºncellendi', 'success');
        } else if (doc.exists) {
            await checklistRef.update({
                items: firebase.firestore.FieldValue.arrayUnion(newItem),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            toast('Madde eklendi', 'success');
        } else {
            await checklistRef.set({
                branch,
                type,
                items: [newItem],
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            toast('Madde eklendi', 'success');
        }
        
        closeModal();
        loadChecklist();
        
    } catch (error) {
        console.error('Madde ekleme hatasƒ±:', error);
        toast('ƒ∞≈ülem hatasƒ±!', 'error');
    }
}

// Checklist madde sil
async function deleteChecklistItem(itemId) {
    if (!confirm('Bu maddeyi silmek istediƒüinize emin misiniz?')) return;
    
    const branch = document.getElementById('checklistSube')?.value;
    const type = document.getElementById('checklistType')?.value;
    
    try {
        const checklistId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_${type}`;
        const checklistRef = db.collection('checklists').doc(checklistId);
        const doc = await checklistRef.get();
        
        if (doc.exists) {
            const items = doc.data().items.filter(i => i.id !== itemId);
            await checklistRef.update({
                items,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        toast('Madde silindi', 'success');
        loadChecklist();
        
    } catch (error) {
        console.error('Madde silme hatasƒ±:', error);
        toast('Silme hatasƒ±!', 'error');
    }
}

// Checklist ge√ßmi≈üi g√∂ster
async function showChecklistHistory() {
    const branch = document.getElementById('checklistSube')?.value;
    const type = document.getElementById('checklistType')?.value;
    
    if (!branch) {
        toast('√ñnce ≈üube se√ßin', 'error');
        return;
    }
    
    try {
        let query = db.collection('checklistSubmissions')
            .where('branch', '==', branch)
            .orderBy('submittedAt', 'desc')
            .limit(50);
        
        if (type) {
            query = db.collection('checklistSubmissions')
                .where('branch', '==', branch)
                .where('type', '==', type)
                .orderBy('submittedAt', 'desc')
                .limit(50);
        }
        
        const snapshot = await query.get();
        
        let html = '<div style="max-height:400px;overflow-y:auto">';
        
        if (snapshot.empty) {
            html += '<p style="color:var(--tx2);text-align:center;padding:20px">Hen√ºz checklist kaydƒ± yok</p>';
        } else {
            snapshot.forEach(doc => {
                const data = doc.data();
                const typeInfo = CHECKLIST_TYPES[branch]?.find(t => t.id === data.type);
                const date = data.submittedAt?.toDate ? new Date(data.submittedAt.toDate()) : new Date();
                
                // Tamamlanma oranƒ±
                let completionRate = 100;
                if (data.items) {
                    const done = data.items.filter(i => i.checked).length;
                    completionRate = Math.round((done / data.items.length) * 100);
                }
                
                html += `
                    <div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg2);border-radius:10px;margin-bottom:8px">
                        <div style="width:44px;height:44px;background:${completionRate === 100 ? 'rgba(39,174,96,.15)' : 'rgba(243,156,18,.15)'};border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.2rem">
                            ${typeInfo?.icon || 'üìã'}
                        </div>
                        <div style="flex:1">
                            <div style="font-weight:600;color:var(--tx)">${typeInfo?.name || data.type}</div>
                            <div style="font-size:.8rem;color:var(--tx2)">${data.personName} ‚Ä¢ ${date.toLocaleDateString('tr-TR')} ${date.toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'})}</div>
                        </div>
                        <div style="text-align:right">
                            <div style="font-weight:600;color:${completionRate === 100 ? '#27ae60' : '#f39c12'}">${completionRate}%</div>
                            <div style="font-size:.75rem;color:var(--tx3)">${data.timeSlot || ''}</div>
                        </div>
                    </div>
                `;
            });
        }
        
        html += '</div>';
        
        showModal('üìä Checklist Ge√ßmi≈üi', html, '<button class="btn btn-ghost" onclick="closeModal()">Kapat</button>');
        
    } catch (error) {
        console.error('Ge√ßmi≈ü y√ºkleme hatasƒ±:', error);
        toast('Ge√ßmi≈ü y√ºklenemedi', 'error');
    }
}

// Checklist ayarlarƒ±
function showChecklistSettings() {
    const branch = document.getElementById('checklistSube')?.value;
    if (!branch) {
        toast('√ñnce ≈üube se√ßin', 'error');
        return;
    }
    
    const types = CHECKLIST_TYPES[branch] || [];
    
    let html = `
        <p style="color:var(--tx2);margin-bottom:16px">${branch} i√ßin checklist ayarlarƒ±</p>
        <div style="display:flex;flex-direction:column;gap:12px">
    `;
    
    types.forEach(t => {
        html += `
            <div style="display:flex;align-items:center;justify-content:space-between;padding:12px;background:var(--bg3);border-radius:10px">
                <div style="display:flex;align-items:center;gap:10px">
                    <span style="font-size:1.2rem">${t.icon}</span>
                    <span style="font-weight:500">${t.name}</span>
                </div>
                <div style="font-size:.8rem;color:var(--tx2)">
                    ${t.timeSlots ? t.timeSlots.join(', ') : 'Tek seferlik'}
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    showModal('‚öôÔ∏è Checklist Ayarlarƒ±', html, '<button class="btn btn-ghost" onclick="closeModal()">Kapat</button>');
}

// Default checklist maddeleri - T√úM EXCEL MADDELERƒ∞
function getDefaultChecklistItems(branch, type) {
    // Veriler artƒ±k Firebase'den y√ºkleniyor
    // seed.html programƒ± ile veritabanƒ±na y√ºklendi
    return [];
}

// =====================================================
// IMPERSONATION (Kullanƒ±cƒ± G√∂z√ºnden G√∂r)
// =====================================================
let isImpersonating = false;
let impersonatedUser = null;
let originalUserData = null;

// Sayfa y√ºklendiƒüinde y√∂netici i√ßin butonu g√∂ster
function checkImpersonateButton() {
    if (currentUser && currentUser.role === 'yonetici') {
        const btn = document.getElementById('btnImpersonate');
        if (btn) btn.style.display = 'flex';
    }
}

// Impersonation modal g√∂ster
async function showImpersonationModal() {
    if (!currentUser || currentUser.role !== 'yonetici') {
        toast('Bu √∂zellik sadece y√∂neticiler i√ßin aktif.', 'error');
        return;
    }
    
    // Personel listesini Firebase'den al
    let personnel = [];
    try {
        const personnelDoc = await db.collection('config').doc('personnel').get();
        if (personnelDoc.exists) {
            personnel = personnelDoc.data().list || [];
        }
    } catch (e) {
        console.error('Personel listesi alƒ±namadƒ±:', e);
    }
    
    const roleLabels = { yonetici: 'Y√∂netici', bolge_muduru: 'B√∂lge M√ºd√ºr√º', magaza_muduru: 'Maƒüaza M√ºd√ºr√º', barista: 'Barista' };
    
    const html = `
        <div style="font-size:.85rem;color:var(--tx2);margin-bottom:16px">Bir kullanƒ±cƒ± se√ßerek onun g√∂rd√ºƒü√º ekranƒ± g√∂r√ºnt√ºleyin:</div>
        <div style="display:flex;flex-direction:column;gap:8px;max-height:400px;overflow-y:auto">
            ${personnel.filter(p => p.email !== currentUser.email).map(p => `
                <div onclick="startImpersonation('${p.email}', '${p.name}', '${p.branch}', '${p.role}')" 
                     style="padding:12px;background:var(--bg3);border:1px solid var(--cardBorder);border-radius:8px;cursor:pointer;transition:all .2s"
                     onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--cardBorder)'">
                    <div style="font-weight:600;color:var(--tx)">${p.name}</div>
                    <div style="font-size:.75rem;color:var(--tx2)">${p.branch} ‚Ä¢ ${roleLabels[p.role] || p.role}</div>
                </div>
            `).join('')}
        </div>
    `;
    
    showModal('üëÅÔ∏è Kullanƒ±cƒ± G√∂z√ºnden G√∂r', html, '<button class="btn btn-ghost" onclick="closeModal()">Kapat</button>');
}

// Impersonation ba≈ülat
function startImpersonation(email, name, branch, role) {
    if (!isImpersonating) {
        originalUserData = { ...currentUser };
    }
    
    isImpersonating = true;
    impersonatedUser = { email, name, branch, role };
    
    // Ge√ßici olarak currentUser'ƒ± deƒüi≈ütir (read-only i≈ülemler i√ßin)
    currentUser.branch = branch;
    currentUser.role = role;
    currentUser.name = name;
    currentUser.email = email;
    
    // UI g√ºncelle
    document.getElementById('impersonationBanner').style.display = 'block';
    document.getElementById('impersonatingAs').textContent = `${name} (${getRoleName(role)})`;
    document.getElementById('userName').textContent = name;
    document.getElementById('userRole').textContent = getRoleName(role);
    
    // Modal kapat
    closeModal();
    
    // Sayfayƒ± yenile
    applyPermissions();
    if (document.getElementById('page-checklist').classList.contains('active')) {
        loadChecklistTypes();
    }
    
    toast(`${name} olarak g√∂r√ºnt√ºleniyor`, 'success');
}

// Impersonation √ßƒ±kƒ±≈ü
function exitImpersonation() {
    if (!isImpersonating || !originalUserData) return;
    
    isImpersonating = false;
    
    // Orijinal kullanƒ±cƒ±ya geri d√∂n
    currentUser.branch = originalUserData.branch;
    currentUser.role = originalUserData.role;
    currentUser.name = originalUserData.name;
    currentUser.email = originalUserData.email;
    
    impersonatedUser = null;
    
    // UI g√ºncelle
    document.getElementById('impersonationBanner').style.display = 'none';
    document.getElementById('userName').textContent = originalUserData.name || originalUserData.email;
    document.getElementById('userRole').textContent = getRoleName(originalUserData.role);
    
    // Sayfayƒ± yenile
    applyPermissions();
    if (document.getElementById('page-checklist').classList.contains('active')) {
        loadChecklistTypes();
    }
    
    toast('Normal g√∂r√ºn√ºme d√∂n√ºld√º', 'success');
}

// =====================================================
// PDF ƒ∞NDƒ∞RME FONKSƒ∞YONU
// =====================================================
function downloadChecklistPDF() {
    const branch = document.getElementById('checklistSube')?.value;
    const type = document.getElementById('checklistType')?.value;
    const date = document.getElementById('checklistDate')?.value;
    const timeSlot = document.getElementById('checklistTimeSlot')?.value;
    
    if (!branch || !type || !date) {
        toast('L√ºtfen √∂nce checklist se√ßin', 'error');
        return;
    }
    
    const items = document.querySelectorAll('#checklistFormContainer .checklist-item-row');
    if (items.length === 0) {
        toast('ƒ∞ndirilecek checklist bulunamadƒ±', 'error');
        return;
    }
    
    const typeInfo = CHECKLIST_TYPES[branch]?.find(t => t.id === type);
    const now = new Date();
    const userName = isImpersonating ? impersonatedUser.name : (currentUser?.name || currentUser?.email);
    
    const checkedItems = [];
    const uncheckedItems = [];
    
    items.forEach(item => {
        const checkbox = item.querySelector('input[type="checkbox"]');
        const textEl = item.querySelector('.checklist-item-text');
        if (checkbox && textEl) {
            const text = textEl.textContent.trim();
            if (checkbox.checked) {
                checkedItems.push({ text, status: '‚úì Yapƒ±ldƒ±' });
            } else {
                uncheckedItems.push({ text, status: '‚úó Yapƒ±lmadƒ±' });
            }
        }
    });
    
    const docDefinition = {
        pageSize: 'A4',
        pageMargins: [40, 60, 40, 60],
        content: [
            { text: 'MOONBERRY COFFEE', style: 'header', alignment: 'center' },
            { text: `${typeInfo?.name || type} - ${branch}`, style: 'subheader', alignment: 'center' },
            { text: ' ', margin: [0, 10] },
            {
                columns: [
                    { text: `Tarih: ${new Date(date).toLocaleDateString('tr-TR')}${timeSlot ? ' ' + timeSlot : ''}`, style: 'info' },
                    { text: `Olu≈üturulma: ${now.toLocaleString('tr-TR')}`, style: 'info', alignment: 'right' }
                ]
            },
            { text: `Personel: ${userName}`, style: 'info' },
            { text: ' ', margin: [0, 10] },
            { text: `Tamamlanan: ${checkedItems.length}/${checkedItems.length + uncheckedItems.length}`, style: 'summary' },
            { text: ' ', margin: [0, 15] },
            { text: 'TAMAMLANAN MADDELER', style: 'sectionTitle' },
            ...checkedItems.map(item => ({ text: `‚úì ${item.text}`, style: 'itemDone', margin: [0, 3] })),
            { text: ' ', margin: [0, 10] },
            { text: 'TAMAMLANMAYAN MADDELER', style: 'sectionTitle' },
            ...uncheckedItems.map(item => ({ text: `‚úó ${item.text}`, style: 'itemNotDone', margin: [0, 3] }))
        ],
        styles: {
            header: { fontSize: 18, bold: true, color: '#008c95' },
            subheader: { fontSize: 14, bold: true, color: '#ff8674', margin: [0, 10] },
            info: { fontSize: 10, color: '#555' },
            summary: { fontSize: 12, bold: true, color: '#1a1a1a' },
            sectionTitle: { fontSize: 11, bold: true, color: '#333', margin: [0, 5] },
            itemDone: { fontSize: 9, color: '#27ae60' },
            itemNotDone: { fontSize: 9, color: '#e74c3c' }
        }
    };
    
    pdfMake.createPdf(docDefinition).download(`Checklist_${type}_${date}.pdf`);
    toast('PDF indiriliyor...', 'success');
}

// Sayfa y√ºklendiƒüinde impersonate butonunu kontrol et
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(checkImpersonateButton, 1000);
});

// Temizlik ve Bakƒ±m - T√ºm√ºn√º G√∂ster/Filtrele
let showAllAylikItems = false;

async function toggleShowAllAylikItems(branch, type, date, timeSlot) {
    showAllAylikItems = !showAllAylikItems;
    
    const container = document.getElementById('checklistFormContainer');
    container.innerHTML = `<div style="text-align:center;padding:40px;color:var(--tx2)">
        <div class="loading-spinner" style="margin:0 auto 16px"></div>
        Yeniden y√ºkleniyor...
    </div>`;
    
    try {
        const checklistId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_${type}`;
        const checklistDoc = await db.collection('checklists').doc(checklistId).get();
        
        if (!checklistDoc.exists) return;
        
        let items = checklistDoc.data().items || [];
        const totalItemCount = items.length;
        
        // Filtreleme
        if (!showAllAylikItems) {
            const selectedDate = new Date(date);
            const dayOfMonth = selectedDate.getDate();
            
            items = items.filter(item => {
                const text = item.text || '';
                const dateMatch = text.match(/ayƒ±n\s*([\d,\-\s]+)/i);
                if (!dateMatch) return true;
                
                const dateStr = dateMatch[1];
                const dates = dateStr.split(/[,\s]+/).flatMap(part => {
                    if (part.includes('-')) {
                        return part.split('-').map(d => parseInt(d.trim()));
                    }
                    return [parseInt(part.trim())];
                }).filter(d => !isNaN(d));
                
                return dates.includes(dayOfMonth);
            });
        }
        
        // Submission kontrol
        let submittedData = null;
        try {
            const submissionId = `${checklistId}_${date}${timeSlot ? '_' + timeSlot.replace(':', '') : ''}`;
            const submissionDoc = await db.collection('checklistSubmissions').doc(submissionId).get();
            if (submissionDoc.exists) submittedData = submissionDoc.data();
        } catch (e) {}
        
        renderChecklistForm(items, branch, type, date, timeSlot, submittedData, totalItemCount);
        
        toast(showAllAylikItems ? 'T√ºm maddeler g√∂steriliyor' : 'Bug√ºne g√∂re filtrelendi', 'success');
        
    } catch (error) {
        console.error('Hata:', error);
        toast('Y√ºklenirken hata olu≈ütu', 'error');
    }
}

// =====================================================
// HAFTALIK G√ñREVLER - Personel Atama Sistemi
// =====================================================
async function renderHaftalikGorevler(container, items, branch, date) {
    const isManager = currentUser?.role === 'yonetici' || currentUser?.role === 'magaza_muduru' || currentUser?.role === 'bolge_muduru';
    const currentWeek = getWeekNumber(new Date(date));
    const weekDocId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_haftalik_${currentWeek.year}_W${currentWeek.week}`;
    
    // Personel listesi (≈üubeye g√∂re)
    const branchPersonnel = personnelMapping.filter(p => 
        p.branch === branch || currentUser?.role === 'yonetici'
    );
    
    // Bu haftaki atamalar
    let weeklyAssignments = {};
    try {
        const doc = await db.collection('weeklyAssignments').doc(weekDocId).get();
        if (doc.exists) {
            weeklyAssignments = doc.data().assignments || {};
        }
    } catch (e) {
        console.warn('Haftalƒ±k atama verisi alƒ±namadƒ±:', e);
    }
    
    let html = `
        <div class="form-section">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                <div>
                    <div style="font-size:1.3rem;font-weight:700;color:var(--tx);display:flex;align-items:center;gap:10px">
                        <span style="font-size:1.5rem">üìã</span> Haftalƒ±k G√∂revler
                    </div>
                    <div style="font-size:.85rem;color:var(--tx2)">${branch} ‚Ä¢ Hafta ${currentWeek.week} (${currentWeek.year})</div>
                </div>
                ${isManager ? `
                    <button class="btn btn-sm btn-ghost" onclick="toggleHaftalikEditMode()">
                        ‚úèÔ∏è G√∂rev Ata
                    </button>
                ` : ''}
            </div>
            
            <div id="haftalikGorevlerContent">
    `;
    
    // G√∂rev listesi
    items.forEach((item, idx) => {
        const assignment = weeklyAssignments[idx];
        const assignedTo = assignment?.assignedTo;
        const isCompleted = assignment?.completed;
        const completedBy = assignment?.completedBy;
        const completedAt = assignment?.completedAt;
        
        // Kullanƒ±cƒ± bu g√∂revi yapabilir mi?
        const canComplete = assignedTo === currentUser?.email || assignedTo === currentUser?.name;
        
        html += `
            <div class="haftalik-gorev-item" style="padding:14px;background:var(--bg3);border-radius:10px;margin-bottom:10px;border-left:4px solid ${isCompleted ? '#27ae60' : (assignedTo ? 'var(--accent)' : 'var(--cardBorder)')}">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
                    <div style="flex:1">
                        <div style="font-weight:500;color:var(--tx);margin-bottom:4px">${item.text}</div>
                        ${assignedTo ? `
                            <div style="font-size:.8rem;color:var(--tx2);display:flex;align-items:center;gap:6px">
                                <span>üë§ ${assignedTo}</span>
                                ${isCompleted ? `
                                    <span style="color:#27ae60">‚Ä¢ ‚úì Tamamlandƒ± ${completedAt || ''}</span>
                                ` : ''}
                            </div>
                        ` : `
                            <div style="font-size:.8rem;color:var(--tx3)">Hen√ºz atanmadƒ±</div>
                        `}
                    </div>
                    <div>
                        ${canComplete && !isCompleted ? `
                            <button onclick="completeHaftalikGorev('${weekDocId}', ${idx})" 
                                class="btn btn-sm btn-primary" style="padding:8px 16px">
                                ‚úì Tamamla
                            </button>
                        ` : ''}
                        ${isCompleted ? `
                            <span style="display:inline-flex;align-items:center;gap:4px;padding:6px 12px;background:rgba(39,174,96,.15);color:#27ae60;border-radius:6px;font-size:.8rem">
                                ‚úì Yapƒ±ldƒ±
                            </span>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    });
    
    html += `
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

// Hafta numarasƒ± hesapla
function getWeekNumber(date) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    return { week: weekNo, year: d.getUTCFullYear() };
}

// Haftalƒ±k g√∂rev tamamla
async function completeHaftalikGorev(weekDocId, taskIndex) {
    try {
        const now = new Date();
        const timeStr = now.toLocaleString('tr-TR', {day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'});
        
        await db.collection('weeklyAssignments').doc(weekDocId).set({
            [`assignments.${taskIndex}.completed`]: true,
            [`assignments.${taskIndex}.completedBy`]: currentUser?.name || currentUser?.email,
            [`assignments.${taskIndex}.completedAt`]: timeStr
        }, { merge: true });
        
        toast('G√∂rev tamamlandƒ±!', 'success');
        loadChecklist(); // Yenile
        
    } catch (error) {
        console.error('G√∂rev tamamlama hatasƒ±:', error);
        toast('Hata: ' + error.message, 'error');
    }
}

// Haftalƒ±k g√∂rev atama modalƒ±
async function showHaftalikAtamaModal(branch, items) {
    const currentWeek = getWeekNumber(new Date());
    const weekDocId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_haftalik_${currentWeek.year}_W${currentWeek.week}`;
    
    // ≈ûube personelleri
    const branchPersonnel = personnelMapping.filter(p => p.branch === branch);
    
    // Mevcut atamalar
    let weeklyAssignments = {};
    try {
        const doc = await db.collection('weeklyAssignments').doc(weekDocId).get();
        if (doc.exists) {
            weeklyAssignments = doc.data().assignments || {};
        }
    } catch (e) {}
    
    let html = `
        <div style="max-height:500px;overflow-y:auto">
            <div style="font-size:.85rem;color:var(--tx2);margin-bottom:16px">
                Her g√∂rev i√ßin bir personel se√ßin. Hafta ${currentWeek.week}
            </div>
    `;
    
    items.forEach((item, idx) => {
        const currentAssignment = weeklyAssignments[idx]?.assignedTo || '';
        html += `
            <div style="padding:12px;background:var(--bg3);border-radius:8px;margin-bottom:10px">
                <div style="font-size:.9rem;color:var(--tx);margin-bottom:8px">${item.text}</div>
                <select id="haftalikAtama_${idx}" class="form-select" style="font-size:.85rem">
                    <option value="">-- Personel Se√ß --</option>
                    ${branchPersonnel.map(p => `
                        <option value="${p.name}" ${currentAssignment === p.name ? 'selected' : ''}>${p.name}</option>
                    `).join('')}
                </select>
            </div>
        `;
    });
    
    html += `</div>`;
    
    showModal('üìã Haftalƒ±k G√∂rev Atama', html, `
        <button class="btn btn-ghost" onclick="closeModal()">ƒ∞ptal</button>
        <button class="btn btn-primary" onclick="saveHaftalikAtamalar('${weekDocId}', ${items.length})">üíæ Kaydet</button>
    `);
}

// Haftalƒ±k atamalarƒ± kaydet
async function saveHaftalikAtamalar(weekDocId, itemCount) {
    try {
        const assignments = {};
        
        for (let i = 0; i < itemCount; i++) {
            const select = document.getElementById(`haftalikAtama_${i}`);
            if (select && select.value) {
                assignments[i] = {
                    assignedTo: select.value,
                    assignedAt: new Date().toISOString(),
                    assignedBy: currentUser?.name || currentUser?.email,
                    completed: false
                };
            }
        }
        
        await db.collection('weeklyAssignments').doc(weekDocId).set({
            assignments,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedBy: currentUser?.name || currentUser?.email
        }, { merge: true });
        
        closeModal();
        toast('G√∂revler atandƒ±!', 'success');
        loadChecklist();
        
    } catch (error) {
        console.error('Atama kayƒ±t hatasƒ±:', error);
        toast('Hata: ' + error.message, 'error');
    }
}
    </script>
</body>
</html>
