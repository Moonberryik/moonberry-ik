rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==================== YARDIMCI FONKSİYONLAR ====================
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      let userDoc = /databases/$(database)/documents/users/$(request.auth.uid);
      return exists(userDoc) ? get(userDoc).data : null;
    }
    
    function getUserRole() {
      let data = getUserData();
      return data != null ? data.role : null;
    }
    
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'yonetici';
    }
    
    function isManager() {
      return isAuthenticated() && getUserRole() in ['yonetici', 'bolge_muduru', 'magaza_muduru'];
    }
    
    function isBolgeMuduru() {
      return isAuthenticated() && getUserRole() in ['yonetici', 'bolge_muduru'];
    }
    
    // ==================== KOLEKSİYON KURALLARI ====================

    // Haftalık Shiftler
    match /weeklyShifts/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // Shift Planları
    match /shiftPlans/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // ========== AUTH MAPPING (UID → EMAIL) ==========
    match /authMapping/{uid} {
      allow read: if isAuthenticated() && request.auth.uid == uid;
      allow write: if isAuthenticated() && request.auth.uid == uid;
    }

    // ========== GÜVENLİK: CREDENTIALS (ŞİFRELER) ==========
    match /credentials/{docId} {
      allow get: if isAuthenticated();
      allow list: if false;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ========== MOTİVASYON ==========
    match /motivationQuotes/{docId} {
      allow read, write: if request.auth != null;
    }

    // ========== GÜVENLİK: LOGIN LOGLARI ==========
    match /loginLogs/{docId} {
      allow create: if true;
      allow read: if isAdmin();
      allow update, delete: if false;
    }

    // ========== FINGERPRINT (CF İÇİN) ==========
    match /fingerprints/{docId} {
      allow read: if isAdmin();
      allow write: if true;
    }

    // Personel
    match /personel/{docId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    
    // Kullanıcılar
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // ==================== PUANTAJ SİSTEMİ ====================
    
    // Puantaj
    match /puantaj/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Puantaj Log (Checklist otomatik kayıtları)
    match /puantajLog/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Puantaj Kuralları
    match /puantajRules/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Puantaj Notları
    match /puantajNotes/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Supervisor Penalties (Müdür Personel Eksisi)
    match /supervisorPenalties/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Puantaj Archive (Aylık Performans Arşivi)
    match /puantajArchive/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // ==================== DİĞER KOLEKSİYONLAR ====================
    
    // Vardiyalar
    match /shifts/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Oturumlar
    match /sessions/{docId} {
      allow read, write: if isAuthenticated();
    }
    
    // Ayarlar
    match /settings/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Config (Yıldız Puanları vb.)
    match /config/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // İzinler
    match /permissions/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Gelişmiş İzinler
    match /advancedPermissions/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Aktivite Logları
    match /activityLogs/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Loglar
    match /logs/{docId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
    }
    
    // Şubeler
    match /branches/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Pozisyonlar
    match /positions/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Şablonlar
    match /templates/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // İhlaller
    match /violations/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Belgeler
    match /documents/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // Checklistler
    match /checklists/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Checklist Maddeleri
    match /checklistItems/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Checklist Gönderimleri
    match /checklistSubmissions/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Checklist Türleri
    match /checklistTypes/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Temizlik Tamamlamaları
    match /temizlikCompletions/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Temizlik Maddeleri
    match /temizlikItems/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Sistem Config (Check Rules vb.)
    match /systemConfig/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // ========== HAFTALIK GÖREVLER ==========
    match /weeklyTasks/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Haftalık Görev Atamaları (Round-Robin)
    match /weeklyAssignments/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Haftalık Görev Atamaları (Eski - Uyumluluk)
    match /weeklyTaskAssignments/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Günlük Görev Atamaları
    match /dailyTaskAssignments/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Rozetler
    match /badges/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Müdür Notları
    match /managerNotes/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Yedekler
    match /backups/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Duyurular
    match /announcements/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // ========== PRİM DUYURULARI ==========
    match /primAnnouncements/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // ========== PRİM AYARLARI ==========
    match /primSettings/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
  }
}
