// ============================================
// MOONBERRY ƒ∞K v2.9 KAPSAMLI TEST
// ============================================
console.clear();
console.log('%c MOONBERRY ƒ∞K v2.9 TEST ', 'background:#008c95;color:#fff;padding:12px;font-size:16px');

(async () => {
    // 1. BUILD
    console.log('\n%c 1. BUILD ', 'background:#27ae60;color:#fff;padding:4px');
    const buildMatch = document.body.innerHTML.match(/BUILD (\d{8}-\d{4})/);
    const build = buildMatch ? buildMatch[1] : 'Bilinmiyor';
    console.log('Build:', build);
    console.log(build === '20260130-0435' ? '‚úÖ G√ºncel' : '‚ö†Ô∏è G√ºncelle! (0435 olmalƒ±)');
    
    // 2. PUANTAJ ROL SIRALAMASI
    console.log('\n%c 2. ROL SIRALAMASI TEST ', 'background:#3498db;color:#fff;padding:4px');
    goTo('puantaj');
    
    await new Promise(r => setTimeout(r, 2500));
    
    const cache = window.puantajPersonelCache || [];
    const roleOrderExpected = ['bolge_muduru', 'magaza_muduru', 'mudur_yardimcisi', 'magaza_mudur_yardimcisi', 'kidemli_barista', 'barista', 'part_time'];
    
    let lastRoleIdx = -1;
    let siralamaOK = true;
    
    console.log('Sƒ±ralama (rol ‚Üí i≈üe giri≈ü tarihi):');
    cache.forEach((p, i) => {
        const roleIdx = roleOrderExpected.indexOf(p.role);
        const actualIdx = roleIdx === -1 ? 99 : roleIdx;
        if (actualIdx < lastRoleIdx) siralamaOK = false;
        lastRoleIdx = Math.max(lastRoleIdx, actualIdx);
        
        const badge = p.role === 'bolge_muduru' ? 'üëë' : 
                     p.role === 'magaza_muduru' ? 'üõ°Ô∏è' : 
                     p.role === 'mudur_yardimcisi' ? 'üéñÔ∏è' :
                     p.isChampion ? 'üèÜ' : 
                     p.championRank ? `#${p.championRank}` : '  ';
        console.log(`  ${i+1}. ${badge} ${p.displayName.padEnd(12)} | ${p.role.padEnd(20)} | ${p.startDate || '-'}`);
    });
    
    console.log('\nRol sƒ±ralamasƒ±:', siralamaOK ? '‚úÖ DOƒûRU' : '‚ùå YANLI≈û');
    
    // ƒ∞lk 3'√ºn rollerini kontrol et
    const first3Roles = cache.slice(0, 3).map(p => p.role);
    const expectedFirst = ['bolge_muduru', 'magaza_muduru'];
    const hasCorrectTop = expectedFirst.some(r => first3Roles.includes(r));
    console.log('ƒ∞lk sƒ±ralarda m√ºd√ºr var mƒ±:', hasCorrectTop ? '‚úÖ EVET' : '‚ùå HAYIR');
    
    // 3. BADGE G√ñRSEL KONTROL
    console.log('\n%c 3. BADGE KONTROL√ú ', 'background:#9b59b6;color:#fff;padding:4px');
    
    // DOM'da badge i√ßeren div'leri say
    const allCards = document.querySelectorAll('[style*="position:relative"][style*="border-radius:12px"]');
    let badgeCount = 0;
    allCards.forEach(card => {
        const badges = card.querySelectorAll('[style*="position:absolute"][style*="border-radius:50%"]');
        if (badges.length > 0) badgeCount++;
    });
    console.log('Badge olan kart:', badgeCount);
    console.log('Beklenen (m√ºd√ºr + b√∂lge + ≈üampiyon):', cache.filter(p => 
        p.role === 'bolge_muduru' || p.role === 'magaza_muduru' || p.isChampion
    ).length);
    
    // 4. CF + SUPERVISION
    console.log('\n%c 4. CF KONTROL√ú ', 'background:#e74c3c;color:#fff;padding:4px');
    
    const periodKey = new Date().toISOString().slice(0, 7);
    const cfSnap = await db.collection('puantaj')
        .where('period', '==', periodKey)
        .where('type', '==', 'checklist_auto')
        .get();
    
    const cfStats = { onTime: 0, late: 0, missed: 0, supervision_penalty: 0 };
    cfSnap.forEach(doc => {
        const status = doc.data().status || 'unknown';
        cfStats[status] = (cfStats[status] || 0) + 1;
    });
    
    console.log('CF toplam:', cfSnap.size);
    console.log('Durumlar:', cfStats);
    console.log('Supervision penalty:', cfStats.supervision_penalty > 0 ? '‚úÖ AKTƒ∞F' : '‚è≥ Bekliyor');
    
    // 5. √ñZET
    console.log('\n%c 5. √ñZET ', 'background:#2c3e50;color:#fff;padding:8px');
    console.log('Build g√ºncel:', build === '20260130-0435' ? '‚úÖ' : '‚ùå');
    console.log('Rol sƒ±ralamasƒ±:', siralamaOK ? '‚úÖ' : '‚ùå');
    console.log('Badge\'ler:', badgeCount >= 2 ? '‚úÖ' : '‚ö†Ô∏è Kontrol et');
    console.log('CF √ßalƒ±≈üƒ±yor:', cfSnap.size > 0 ? '‚úÖ' : '‚è≥');
})();
