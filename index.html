<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Moonberry Coffee | YÃ¶netim Paneli v2.9</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%23008c95'/%3E%3Ctext x='50' y='68' text-anchor='middle' font-family='Arial,sans-serif' font-weight='bold' font-size='60' fill='white'%3EM%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="https://static.wixstatic.com/media/760af2_0e846222ae5b4021930a757e498f30e9~mv2.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- pdfmake - TÃ¼rkÃ§e karakter desteÄŸi -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <style>
:root{
    /* Light Mode (Default) */
    --bg:#fafafa;--bg2:#ffffff;--bg3:#f5f5f5;--bg4:#ebebeb;
    --surface:#ffffff;--surface2:#fafafa;--surface3:#f5f5f5;
    --tx:#1a1a1a;--tx2:#555555;--tx3:#888888;
    --txdark:#1a1a1a;--txdark2:#555555;
    /* Marka Renkleri */
    --brand-coral:#ff8674;--brand-teal:#008c95;
    --accent:var(--brand-coral);--accent2:var(--brand-teal);--accentLight:rgba(255,134,116,.15);
    --green:#27ae60;--red:#e74c3c;--yellow:#f39c12;--blue:#3498db;
    --glass:rgba(255,255,255,.98);--glassBorder:rgba(0,0,0,.08);
    --shadow:0 4px 24px rgba(0,0,0,.08);--shadowSm:0 2px 8px rgba(0,0,0,.05);
    --radius:10px;--radiusSm:6px;--radiusLg:16px;
    --transition:.2s ease;
    --font:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;--mono:'JetBrains Mono',monospace;
    --cardBg:#ffffff;--cardBorder:rgba(0,0,0,.06);
    --sectionBg:#ffffff;
    --sidebarBg:#006d73;--sidebarTx:#ffffff;--sidebarTx2:#ffffff;--sidebarTx3:rgba(255,255,255,.7);
    /* Logolar */
    --logo-dark:url('https://static.wixstatic.com/media/760af2_0e846222ae5b4021930a757e498f30e9~mv2.png');
    --logo-light:url('https://static.wixstatic.com/media/760af2_755f54f13b654f1bb318c97f16a029a3~mv2.png/v1/fill/w_104,h_92,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/Moonberry%20Coffee%20Logo.png');
}
/* Dark Mode */
[data-theme="dark"]{
    --bg:#0f0f0f;--bg2:#1a1a1a;--bg3:#242424;--bg4:#333333;
    --surface:#1a1a1a;--surface2:#242424;--surface3:#2e2e2e;
    --tx:#f0f0f0;--tx2:#b0b0b0;--tx3:#707070;
    --txdark:#f0f0f0;--txdark2:#a0a0a0;
    --glass:rgba(30,30,30,.95);--glassBorder:rgba(255,255,255,.1);
    --shadow:0 8px 32px rgba(0,0,0,.4);--shadowSm:0 2px 8px rgba(0,0,0,.3);
    --cardBg:rgba(40,40,40,.95);--cardBorder:rgba(255,255,255,.08);
    --sectionBg:linear-gradient(135deg,rgba(30,30,30,.95),rgba(20,20,20,.9));
    --sidebarBg:#0f0f0f;--sidebarTx:#ffffff;--sidebarTx2:#ffffff;--sidebarTx3:rgba(255,255,255,.5);
}
[data-theme="dark"] .main{background:var(--bg)!important}
[data-theme="dark"] .page-title,[data-theme="dark"] .page-subtitle{color:var(--tx)!important}
[data-theme="dark"] .form-section{background:var(--bg2)!important;border-color:var(--bg4)!important}
[data-theme="dark"] .form-section-title{color:var(--tx)!important;border-color:var(--bg4)!important}
[data-theme="dark"] .form-label{color:var(--tx2)!important}
[data-theme="dark"] .form-input,[data-theme="dark"] .form-select,[data-theme="dark"] .form-textarea{background:var(--bg3)!important;border-color:var(--bg4)!important;color:var(--tx)!important}
[data-theme="dark"] .type-card{background:var(--bg3)!important;border-color:var(--bg4)!important}
[data-theme="dark"] .type-card-title{color:var(--tx)!important}
[data-theme="dark"] .type-card-sub{color:var(--tx2)!important}
[data-theme="dark"] .alert{background:var(--bg2)!important;border-color:var(--bg4)!important;color:var(--tx2)!important}
[data-theme="dark"] .back-link{color:var(--tx2)!important}
[data-theme="dark"] .admin-list-item{background:var(--bg3)!important;border-color:var(--bg4)!important}
[data-theme="dark"] .admin-list-item:hover{background:var(--bg4)!important}
[data-theme="dark"] .tabs{background:var(--bg3)!important}
[data-theme="dark"] .tab{color:var(--tx2)!important}
[data-theme="dark"] .tab.active{background:var(--bg2)!important;color:var(--accent)!important}
[data-theme="dark"] .dashboard-card{background:var(--cardBg)!important;border-color:var(--cardBorder)!important}
[data-theme="dark"] .dashboard-card-title{color:var(--tx)!important}
[data-theme="dark"] .dashboard-card-desc{color:var(--tx2)!important}
[data-theme="dark"] .section-card{background:var(--sectionBg)!important;border-color:var(--cardBorder)!important}

/* Permission Matrix Styles - Balanced */
#permissionMatrix{min-width:auto;font-size:.8rem;width:100%}
#permissionMatrix th,#permissionMatrix td{padding:6px 8px;text-align:center;border-bottom:1px solid var(--cardBorder);white-space:nowrap}
#permissionMatrix th{background:var(--bg3);font-weight:600;color:var(--tx);position:sticky;top:0;z-index:2;font-size:.75rem}
#permissionMatrix .perm-category{background:var(--bg3);font-weight:600;color:var(--tx);text-align:left!important;padding-left:10px;font-size:.8rem}
#permissionMatrix .perm-item{text-align:left!important;padding-left:14px;color:var(--tx2);font-weight:400;font-size:.78rem}
#permissionMatrix .perm-item-name{position:sticky;left:0;background:var(--bg2);z-index:1;width:140px;min-width:100px;max-width:160px}
#permissionMatrix input[type="checkbox"]{width:15px;height:15px;accent-color:var(--brand-coral);cursor:pointer}
#permissionMatrix select{padding:3px 6px;border-radius:4px;border:1px solid var(--cardBorder);background:var(--bg2);color:var(--tx);font-size:.7rem}
#permissionMatrix .role-header{min-width:100px;font-size:.75rem;padding:8px 6px}
#permissionMatrix .sub-header{font-size:.68rem;font-weight:500;color:var(--tx3);padding:4px}
#permissionMatrix tr:hover td{background:var(--accentLight)}
#permissionMatrix tr:hover .perm-item-name{background:var(--accentLight)}
[data-theme="dark"] #permissionMatrix th{background:var(--bg3)}
[data-theme="dark"] #permissionMatrix .perm-item-name{background:var(--bg2)}
[data-theme="dark"] #permissionMatrix tr:hover td,[data-theme="dark"] #permissionMatrix tr:hover .perm-item-name{background:rgba(255,134,116,.1)}

/* Barista Mode - CSS ile gizleme (JavaScript'e baÄŸÄ±mlÄ± deÄŸil) */
/* Barista Mode - ArtÄ±k dinamik JS kontrolÃ¼ ile yÃ¶netiliyor */
/* Sidebar gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ updateSidebarByPermissions() fonksiyonu tarafÄ±ndan kontrol edilir */

*{margin:0;padding:0;box-sizing:border-box}
html{font-size:15px}
body{font-family:var(--font);background:var(--bg);color:var(--tx);line-height:1.6;min-height:100vh;overflow-x:hidden}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--tx3)}

/* App Layout */
.app{display:flex;min-height:100vh;opacity:0;transition:opacity .3s}
.sidebar{width:260px;background:var(--sidebarBg);border-right:1px solid rgba(255,255,255,.1);display:flex;flex-direction:column;position:fixed;height:100vh;z-index:100;transition:width .3s ease}
.sidebar-header{height:56px;padding:0 16px;border-bottom:1px solid rgba(255,255,255,.1);display:flex;align-items:center}
.logo{display:flex;align-items:center;gap:10px;flex:1;min-width:0}
.logo-text-wrap{overflow:hidden}
.logo-text{font-size:1rem;font-weight:700;letter-spacing:-.02em;color:var(--sidebarTx);white-space:nowrap}
.logo-sub{font-size:.65rem;color:var(--sidebarTx3);margin-top:1px;white-space:nowrap}
.nav{flex:1;padding:12px 10px;overflow-y:auto}
.nav-group{margin-bottom:8px}
.nav-label{font-size:.75rem;color:var(--sidebarTx2);padding:10px 14px;margin-bottom:0;font-weight:500;display:flex;align-items:center;justify-content:space-between;cursor:pointer;border-radius:var(--radiusSm);transition:var(--transition)}
.nav-label:hover{background:rgba(255,255,255,.1)}
.nav-label .nav-arrow{transition:transform .2s;font-size:.7rem}
.nav-label.collapsed .nav-arrow{transform:rotate(-90deg)}
.nav-items{overflow:hidden;transition:max-height .3s ease;max-height:500px}
.nav-items.collapsed{max-height:0}
.nav-item{display:flex;align-items:center;gap:12px;padding:10px 14px;border-radius:var(--radiusSm);cursor:pointer;transition:var(--transition);color:var(--sidebarTx2);font-weight:500;font-size:.85rem;margin-bottom:2px;position:relative}
.nav-item:hover{background:rgba(255,134,116,.15);color:#fff}
.nav-item.active{background:linear-gradient(135deg,var(--accent),#ff6b5b);color:#fff;box-shadow:0 4px 20px rgba(255,134,116,.35);font-weight:600}
.nav-item .icon{font-size:1rem;width:20px;text-align:center;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.nav-item .icon svg{width:18px;height:18px;stroke:currentColor;stroke-width:2;fill:none}
.nav-divider{height:1px;background:rgba(255,255,255,.1);margin:12px 12px}

/* Sidebar Collapsed */
.sidebar.collapsed{width:60px}
.sidebar.collapsed .sidebar-header{padding:0 8px;justify-content:center}
.sidebar.collapsed .logo{justify-content:center;flex:none}
.sidebar.collapsed .logo img{width:28px}
.sidebar.collapsed .logo-text-wrap{display:none}
.sidebar.collapsed .nav{padding:8px 4px}
.sidebar.collapsed .nav-label{padding:10px;justify-content:center;font-size:0}
.sidebar.collapsed .nav-label .nav-arrow{display:none}
.sidebar.collapsed .nav-item{padding:12px 0;justify-content:center;font-size:0;gap:0;position:relative}
.sidebar.collapsed .nav-item .icon{margin:0}
.sidebar.collapsed .nav-items.collapsed{max-height:500px}
.sidebar.collapsed .nav-group{position:relative}
.sidebar.collapsed .nav-item[data-tooltip]:hover::after{content:attr(data-tooltip);position:absolute;left:calc(100% + 8px);top:50%;transform:translateY(-50%);background:#1a1a2e;color:#fff;padding:8px 12px;border-radius:6px;font-size:.8rem;white-space:nowrap;box-shadow:0 4px 12px rgba(0,0,0,.3);z-index:9999;pointer-events:none;border:1px solid rgba(255,255,255,.1)}
.sidebar.collapsed .sidebar-user{padding:8px 4px}
.sidebar.collapsed .sidebar-user .user-details{display:none}
.sidebar.collapsed .sidebar-user .user-avatar{margin:0 auto}
.sidebar.collapsed #userInfo{margin:0 0 8px 0;padding:4px;justify-content:center}
.sidebar.collapsed #userInfo svg{display:none}

/* Main Content */
.main{flex:1;margin-left:260px;background:var(--bg);min-height:100vh;position:relative;transition:margin-left .3s ease}
.main.sidebar-collapsed{margin-left:60px}
.main-header{position:sticky;top:0;z-index:50;height:56px;display:flex;justify-content:space-between;align-items:center;padding:0 24px;background:var(--bg2);border-bottom:1px solid var(--bg4)}
.page{display:none;padding:24px 32px;animation:fadeUp .3s}
.page.active{display:block}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.page-header{margin-bottom:28px}
.page-title{font-size:1.6rem;font-weight:700;color:var(--txdark);letter-spacing:-.02em}
.page-subtitle{color:var(--txdark2);font-size:.9rem;margin-top:4px}
.back-link{display:inline-flex;align-items:center;gap:6px;color:var(--txdark2);font-size:.85rem;font-weight:500;cursor:pointer;margin-bottom:16px;transition:var(--transition)}
.back-link:hover{color:var(--accent)}

/* Cards Grid */
.dashboard-section{margin-bottom:32px}
.section-title{font-size:.75rem;font-weight:600;color:var(--tx3);text-transform:uppercase;letter-spacing:.1em;margin-bottom:16px}
.cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px}
.card{background:rgba(255,255,255,.03);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:20px;cursor:pointer;transition:all .3s cubic-bezier(.4,0,.2,1);position:relative;display:flex;align-items:center;gap:16px}
.card:hover{transform:translateY(-2px);background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.12);box-shadow:0 20px 40px rgba(0,0,0,.3)}
.card-icon{width:48px;height:48px;border-radius:14px;display:flex;align-items:center;justify-content:center;color:#fff;flex-shrink:0}
.card-content{flex:1;min-width:0}
.card-title{font-size:.95rem;font-weight:600;color:var(--tx);margin-bottom:4px}
.card-desc{font-size:.8rem;color:var(--tx3);line-height:1.4}

/* Legacy card styles for other pages */
.card-icon.orange{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff}
.card-icon.coral{background:linear-gradient(135deg,#ff8674,#ff6b5b);color:#fff}
.card-icon.teal{background:linear-gradient(135deg,#008c95,#00a8a8);color:#fff}
.card-icon.green{background:linear-gradient(135deg,#27ae60,#2ecc71);color:#fff}
.card-icon.red{background:linear-gradient(135deg,#e74c3c,#c0392b);color:#fff}
.card-icon.blue{background:linear-gradient(135deg,#008c95,#4db6ac);color:#fff}
.card-icon.purple{background:linear-gradient(135deg,#ff8674,#008c95);color:#fff}

/* Form Elements */
.form-section{background:var(--surface);border:1px solid var(--surface3);border-radius:var(--radius);padding:24px;margin-bottom:20px}
.form-section-title{font-size:.95rem;font-weight:600;color:var(--txdark);margin-bottom:20px;padding-bottom:12px;border-bottom:1px solid var(--surface3);display:flex;align-items:center;gap:10px}
.form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
.form-group{display:flex;flex-direction:column;gap:6px}
.form-group.full{grid-column:span 2}
.form-label{font-size:.8rem;font-weight:500;color:var(--txdark2)}
.form-input,.form-select,.form-textarea{padding:12px 14px;background:var(--surface2);border:1.5px solid var(--surface3);border-radius:var(--radiusSm);color:var(--txdark);font-size:.9rem;font-family:var(--font);transition:var(--transition)}
.form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--accent);background:var(--surface);box-shadow:0 0 0 3px rgba(255,134,116,.15)}
.form-textarea{resize:vertical;min-height:100px}
.form-input::placeholder{color:var(--txdark2);opacity:.6}

/* Type Cards */
.type-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
.type-card{background:var(--surface2);border:2px solid transparent;border-radius:var(--radiusSm);padding:16px;cursor:pointer;transition:var(--transition);text-align:center}
.type-card:hover{border-color:var(--accent);background:var(--surface)}
.type-card.selected{border-color:var(--accent);background:var(--accentLight)}
.type-card-icon{font-size:1.5rem;margin-bottom:8px}
.type-card-title{font-size:.9rem;font-weight:600;color:var(--txdark)}
.type-card-sub{font-size:.75rem;color:var(--txdark2);margin-top:2px}

/* Buttons */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 24px;border-radius:var(--radiusSm);font-size:.9rem;font-weight:600;cursor:pointer;transition:var(--transition);border:none;font-family:var(--font)}
.btn:focus{outline:none;box-shadow:0 0 0 3px rgba(255,134,116,.3)}
.btn-primary{background:linear-gradient(135deg,var(--accent),#ff6b5b);color:#fff}
.btn-primary:hover{background:linear-gradient(135deg,var(--accent2),#007a82);box-shadow:0 4px 20px rgba(255,134,116,.35)}
.btn-secondary{background:var(--surface3);color:var(--txdark)}
.btn-secondary:hover{background:var(--surface2);border-color:var(--accent)}
.btn-danger{background:linear-gradient(135deg,#e74c3c,#c0392b);color:#fff}
.btn-danger:hover{background:linear-gradient(135deg,#c0392b,#a93226);box-shadow:0 4px 16px rgba(231,76,60,.3)}
.btn-ghost{background:transparent;color:var(--txdark2);border:1.5px solid var(--surface3)}
.btn-ghost:hover{border-color:var(--accent);color:var(--accent);background:rgba(255,134,116,.05)}
.btn-group{display:flex;gap:12px;margin-top:24px;flex-wrap:wrap}
.btn-sm{padding:8px 16px;font-size:.8rem}

/* Alert Boxes */
.alert{padding:16px 20px;border-radius:var(--radiusSm);margin-bottom:20px;display:flex;align-items:flex-start;gap:12px;font-size:.85rem}
.alert-icon{font-size:1.2rem;flex-shrink:0}
.alert-warning{background:#fef9e7;border:1px solid #f9e79f;color:#7d6608}
.alert-danger{background:#fdedec;border:1px solid #f5b7b1;color:#922b21}
.alert-info{background:#ebf5fb;border:1px solid #aed6f1;color:#1a5276}
.alert-success{background:#e9f7ef;border:1px solid #abebc6;color:#1e8449}

/* Tabs */
.tabs{display:flex;gap:4px;background:var(--surface3);padding:4px;border-radius:var(--radiusSm);margin-bottom:20px}
.tab{flex:1;padding:10px 16px;border:none;background:transparent;color:var(--txdark2);font-size:.85rem;font-weight:600;cursor:pointer;border-radius:6px;transition:var(--transition);font-family:var(--font)}
.tab:hover{color:var(--txdark);background:rgba(255,134,116,.08)}
.tab.active{background:linear-gradient(135deg,var(--accent),#ff6b5b);color:#fff;box-shadow:0 2px 8px rgba(255,134,116,.25)}

/* Violation List */
.violation-list{display:flex;flex-direction:column;gap:10px}
.violation-item{background:var(--surface2);border:1px solid var(--surface3);border-radius:var(--radiusSm);padding:16px;cursor:pointer;transition:var(--transition)}
.violation-item:hover{border-color:var(--accent);background:var(--surface)}
.violation-header{display:flex;align-items:center;justify-content:space-between}
.violation-title{font-weight:600;font-size:.9rem;color:var(--txdark)}
.violation-badge{padding:4px 10px;border-radius:20px;font-size:.7rem;font-weight:600;text-transform:uppercase}
.violation-badge.low{background:#d5f5e3;color:#1e8449}
.violation-badge.medium{background:#fef9e7;color:#7d6608}
.violation-badge.high{background:#fdedec;color:#922b21}
.violation-legal{font-size:.8rem;color:var(--txdark2);margin-top:6px}

/* Dashboard Cards */
.dashboard-card{transition:all .25s cubic-bezier(.4,0,.2,1)!important}
.dashboard-card:hover{transform:translateY(-4px);box-shadow:0 12px 28px rgba(255,134,116,.15)!important;border-color:var(--accent)!important}
.dashboard-section{margin-bottom:32px}

/* Preview */
.preview-container{background:var(--surface);border:1px solid var(--surface3);border-radius:var(--radius);overflow:hidden}
.preview-toolbar{background:var(--surface2);padding:14px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--surface3)}
.preview-title{font-weight:600;font-size:.9rem;color:var(--txdark)}
.preview-actions{display:flex;gap:8px}
.preview-content{padding:40px;background:#fff;min-height:500px}

/* Document Styles - PDF Optimized */
.doc{max-width:800px;margin:0 auto;font-size:10pt;line-height:1.6;color:#000;font-family:'Times New Roman',serif}
.doc-header{text-align:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #000}
.doc-company{font-size:10pt;font-weight:700}
.doc-company-info{font-size:8pt;color:#444;margin-top:2px}
.doc-title{font-size:12pt;font-weight:700;margin:15px 0;text-decoration:underline}
.doc-section{margin-bottom:12px}
.doc-section-title{font-size:10pt;font-weight:700;margin-bottom:6px;border-bottom:1px solid #ccc;padding-bottom:3px}
.doc-article{margin-bottom:8px}
.doc-article-title{font-weight:700;margin-bottom:2px;font-size:10pt}
.doc-article-content{margin-left:10px;text-align:justify;font-size:9.5pt;line-height:1.4}
.doc-article-content p{margin:4px 0}
.doc-signature-area{display:grid;grid-template-columns:1fr 1fr;gap:40px;margin-top:35px}
.doc-signature-block{text-align:center}
.doc-signature-title{font-weight:600;margin-bottom:40px;font-size:10pt}
.doc-signature-line{border-top:1px solid #000;padding-top:5px;font-size:9pt}
.doc p{margin:4px 0;font-size:9.5pt}
.no-break{page-break-inside:avoid}

/* Modal System */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);z-index:9000;display:flex;align-items:center;justify-content:center;opacity:0;visibility:hidden;transition:var(--transition)}
.modal-overlay.show{opacity:1;visibility:visible}
.modal{background:var(--surface);border-radius:var(--radiusLg);max-width:480px;width:90%;max-height:90vh;overflow:hidden;transform:scale(.9);transition:var(--transition);box-shadow:var(--shadow)}
.modal-overlay.show .modal{transform:scale(1)}
.modal-header{padding:20px 24px;border-bottom:1px solid var(--surface3);display:flex;align-items:center;justify-content:space-between}
.modal-title{font-size:1.1rem;font-weight:700;color:var(--txdark)}
.modal-close{width:32px;height:32px;border-radius:50%;border:none;background:var(--surface3);color:var(--txdark2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.2rem;transition:var(--transition)}
.modal-close:hover{background:var(--red);color:#fff}
.modal-body{padding:24px;max-height:60vh;overflow-y:auto}
.modal-footer{padding:16px 24px;border-top:1px solid var(--surface3);display:flex;justify-content:flex-end;gap:12px}
.modal-icon{width:64px;height:64px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:2rem;margin:0 auto 20px}
.modal-icon.success{background:#e9f7ef;color:var(--green)}
.modal-icon.warning{background:#fef9e7;color:var(--yellow)}
.modal-icon.danger{background:#fdedec;color:var(--red)}
.modal-icon.info{background:#ebf5fb;color:var(--blue)}
.modal-message{text-align:center;color:var(--txdark2);font-size:.95rem;line-height:1.6}

/* Toast */
.toast-container{position:fixed;bottom:24px;right:24px;z-index:9999;display:flex;flex-direction:column;gap:10px}
.toast{background:var(--bg2);color:var(--tx);padding:14px 20px;border-radius:var(--radiusSm);font-size:.85rem;font-weight:500;box-shadow:var(--shadow);display:flex;align-items:center;gap:10px;transform:translateX(120%);transition:var(--transition);border-left:3px solid var(--accent)}
.toast.show{transform:translateX(0)}
.toast.success{border-color:var(--green)}
.toast.error{border-color:var(--red)}
.toast-icon{font-size:1.1rem}

/* Admin Panel */
.admin-tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:24px}
.admin-tab{padding:10px 20px;background:var(--surface2);border:1.5px solid var(--surface3);border-radius:var(--radiusSm);color:var(--txdark2);font-size:.85rem;font-weight:600;cursor:pointer;transition:var(--transition)}
.admin-tab.tab-hidden{display:none!important}
.admin-tab:hover{border-color:var(--accent);color:var(--accent);background:rgba(255,134,116,.05)}
.admin-tab.active{background:linear-gradient(135deg,var(--accent),#ff6b5b);border-color:var(--accent);color:#fff;box-shadow:0 2px 12px rgba(255,134,116,.25)}
.admin-section{display:none;animation:fadeUp .3s}
.admin-section.active{display:block}
.admin-card{background:var(--surface2);border:1px solid var(--surface3);border-radius:var(--radiusSm);padding:20px;margin-bottom:16px}
.admin-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.admin-card-title{font-weight:600;color:var(--txdark);font-size:.95rem}
.admin-list{display:flex;flex-direction:column;gap:8px}
.admin-list-item{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--surface);border:1px solid var(--surface3);border-radius:6px}
.admin-list-item-text{font-size:.9rem;color:var(--txdark)}
.admin-list-item-actions{display:flex;gap:8px}
.admin-btn-icon{width:32px;height:32px;border-radius:6px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--transition);font-size:.9rem}
.admin-btn-edit{background:var(--surface3);color:var(--txdark2)}
.admin-btn-edit:hover{background:var(--accent);color:#fff}
.admin-btn-delete{background:var(--surface3);color:var(--txdark2)}
.admin-btn-delete:hover{background:var(--red);color:#fff}
.sync-code-area{background:var(--bg2);border:1px solid var(--bg4);border-radius:var(--radiusSm);padding:16px;margin:16px 0}
.sync-code-text{width:100%;min-height:120px;background:var(--bg);border:1px solid var(--bg4);border-radius:6px;padding:12px;color:var(--tx);font-family:var(--mono);font-size:.8rem;resize:vertical}
.sync-actions{display:flex;gap:12px;margin-top:12px}

/* Permission Checkboxes */
.perm-cb{cursor:pointer;transition:transform .15s}
.perm-cb:hover{transform:scale(1.1)}
.perm-cb:checked{animation:checkPop .2s ease}
@keyframes checkPop{0%{transform:scale(.8)}50%{transform:scale(1.2)}100%{transform:scale(1)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
@keyframes glow{0%,100%{box-shadow:0 0 5px var(--glow-color)}50%{box-shadow:0 0 20px var(--glow-color),0 0 30px var(--glow-color)}}
@keyframes pulse-dot{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.6;transform:scale(1.2)}}
@keyframes float-bubble{0%,100%{transform:translateY(0) scale(1);opacity:.6}50%{transform:translateY(-10px) scale(1.1);opacity:1}}
@keyframes soft-pulse{0%,100%{opacity:.85;box-shadow:0 0 0 0 var(--pulse-color)}50%{opacity:1;box-shadow:0 0 12px 3px var(--pulse-color)}}
@keyframes urgent-glow{0%,100%{box-shadow:0 0 8px var(--glow-color),inset 0 0 5px rgba(255,255,255,.05)}50%{box-shadow:0 0 20px var(--glow-color),0 0 30px var(--glow-color),inset 0 0 10px rgba(255,255,255,.1)}}
@keyframes urgent-blink{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.9;transform:scale(1.01)}}
@keyframes countdown-pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.03)}}
@keyframes missed-shake{0%,100%{transform:translateX(0)}10%,30%,50%,70%,90%{transform:translateX(-2px)}20%,40%,60%,80%{transform:translateX(2px)}}
.check-card-active{animation:glow 2s ease-in-out infinite;--glow-color:rgba(0,140,149,.4)}
.check-card-active.sunberry{--glow-color:rgba(255,134,116,.4)}
.check-pulse-active{animation:soft-pulse 3s ease-in-out infinite;--pulse-color:rgba(0,140,149,.25)}
.check-pulse-warning{animation:soft-pulse 2.5s ease-in-out infinite;--pulse-color:rgba(243,156,18,.25)}
.check-pulse-urgent{animation:urgent-glow 2s ease-in-out infinite,urgent-blink 2s ease-in-out infinite;--glow-color:rgba(0,140,149,.4);border-width:2px!important}
.check-pulse-urgent.coral{--glow-color:rgba(255,134,116,.4)}
.check-card-premium.missed-recent{border-left:3px solid #e74c3c!important;background:linear-gradient(90deg,rgba(231,76,60,.08),transparent)}
.check-card-premium.expired{opacity:.5;pointer-events:none;filter:grayscale(.3);border-left:3px solid #9ca3af!important}
.check-card-premium.disabled{opacity:.35;pointer-events:none;filter:grayscale(.5)}
.check-countdown-live{display:inline-flex;align-items:center;gap:4px;font-family:'SF Mono',Monaco,monospace;font-size:.75rem;font-weight:600;padding:4px 8px;border-radius:6px;background:rgba(0,140,149,.1);color:#008c95}
.check-countdown-live.urgent{background:rgba(231,76,60,.15);color:#e74c3c;animation:countdown-pulse 2s ease-in-out infinite}
.check-countdown-live.warning{background:rgba(243,156,18,.15);color:#f39c12}
.check-countdown-live.coral{background:rgba(255,134,116,.1);color:#ff8674}
.check-countdown-live.expired{background:rgba(156,163,175,.1);color:#9ca3af}
.check-message{font-size:.7rem;padding:3px 8px;border-radius:4px;font-weight:500;white-space:nowrap}
.check-message.active{background:linear-gradient(135deg,rgba(0,140,149,.15),rgba(0,140,149,.05));color:#008c95}
.check-message.upcoming{background:rgba(52,152,219,.1);color:#3498db}
.check-message.completed{background:rgba(39,174,96,.1);color:#27ae60}
.check-message.missed{background:rgba(231,76,60,.15);color:#e74c3c}
.check-message.expired{background:rgba(156,163,175,.1);color:#6b7280}
.floating-bubble{position:absolute;border-radius:50%;background:rgba(255,255,255,.3);animation:float-bubble 3s ease-in-out infinite}
.check-card-shimmer{background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);background-size:200% 100%;animation:shimmer 2s infinite}

/* Premium Dashboard Check Cards */
.branch-group{margin-bottom:20px;animation:fadeUp .4s ease}
.branch-header{display:flex;align-items:center;gap:10px;margin-bottom:12px;padding-left:2px}
.branch-badge{display:inline-flex;align-items:center;gap:6px;padding:5px 12px;border-radius:16px;font-size:.7rem;font-weight:600;text-transform:uppercase;letter-spacing:.02em;background:linear-gradient(135deg,rgba(0,140,149,.12),rgba(0,140,149,.04));color:#008c95;border:1px solid rgba(0,140,149,.15)}
.branch-check-count{font-size:.7rem;color:var(--tx3);font-weight:400;margin-left:auto}
.check-cards-grid{display:flex;flex-direction:column;gap:8px}
.check-card-premium{background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:10px;padding:12px 16px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:all .2s cubic-bezier(.4,0,.2,1);position:relative;overflow:hidden}
.check-card-premium:hover{transform:translateX(4px);box-shadow:0 4px 16px rgba(0,0,0,.06);border-color:rgba(0,140,149,.2)}
.check-card-premium.active{border-left:3px solid var(--card-accent,#008c95);background:linear-gradient(90deg,rgba(0,140,149,.03),transparent)}
.check-card-premium.active.coral{--card-accent:#ff8674;border-left-color:#ff8674;background:linear-gradient(90deg,rgba(255,134,116,.03),transparent)}
.check-card-premium.urgent{border-left:3px solid #f39c12;animation:soft-pulse 1.5s ease-in-out infinite;--pulse-color:rgba(243,156,18,.25)}
.check-card-premium.completed{opacity:.55;border-left:3px solid #27ae60}
.check-card-premium.missed{opacity:.45;border-left:3px solid #9ca3af}
.check-card-premium.waiting{opacity:.45;border-left:3px solid #95a5a6;filter:grayscale(30%)}
.check-icon-wrap{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.check-icon-wrap.teal{background:linear-gradient(135deg,rgba(0,140,149,.12),rgba(0,140,149,.06))}
.check-icon-wrap.coral{background:linear-gradient(135deg,rgba(255,134,116,.12),rgba(255,134,116,.06))}
.check-icon-wrap.green{background:rgba(39,174,96,.1)}
.check-icon-wrap.gray{background:var(--bg3)}
.check-icon-wrap.orange{background:rgba(243,156,18,.1)}
.check-info{flex:1;min-width:0}
.check-name{font-weight:600;font-size:.85rem;color:var(--tx);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.check-meta{display:flex;align-items:center;gap:6px;margin-top:2px}
.check-time-badge{font-size:.75rem;color:var(--tx2);font-weight:500}
.check-personnel-tag{font-size:.8rem;color:#fff;padding:3px 10px;background:#ff8674;border-radius:6px;max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-weight:500}
.check-status-wrap{display:flex;align-items:center;gap:6px;margin-left:auto;flex-shrink:0}
.check-countdown-pill{font-size:.75rem;font-weight:600;font-family:var(--mono);padding:4px 10px;border-radius:6px}
.check-countdown-pill.active{background:rgba(0,140,149,.1);color:#008c95}
.check-countdown-pill.coral{background:rgba(255,134,116,.1);color:#ff8674}
.check-countdown-pill.urgent{background:rgba(243,156,18,.1);color:#f39c12}
.check-countdown-pill.done{background:rgba(39,174,96,.1);color:#27ae60}
.check-countdown-pill.missed{background:rgba(156,163,175,.1);color:#9ca3af}
.check-points-badge{font-size:.65rem;font-weight:700;padding:2px 6px;border-radius:4px}
.check-points-badge.positive{background:rgba(39,174,96,.1);color:#27ae60}
.check-points-badge.negative{background:rgba(231,76,60,.1);color:#e74c3c}

/* Check Rule Tabs */
.check-rule-tab{display:flex;align-items:center;gap:6px;padding:10px 16px;background:var(--bg3);border:1.5px solid var(--bg4);border-radius:10px;color:var(--tx2);font-size:.85rem;font-weight:500;cursor:pointer;transition:all .2s}
.check-rule-tab:hover{border-color:var(--accent);color:var(--accent);background:rgba(255,134,116,.05)}
.check-rule-tab.active{background:linear-gradient(135deg,#008c95,#00a5a5);border-color:#008c95;color:#fff;box-shadow:0 2px 12px rgba(0,140,149,.25)}
.check-rule-tab svg{opacity:.7}
.check-rule-tab.active svg{opacity:1}

/* Time Slot Cards */
.time-slot-card{background:var(--bg3);border:1px solid var(--bg4);border-radius:12px;padding:16px;display:flex;align-items:center;gap:16px;transition:all .2s}
.time-slot-card:hover{border-color:rgba(0,140,149,.3);box-shadow:0 4px 12px rgba(0,0,0,.05)}
.time-slot-time{font-size:1.2rem;font-weight:700;font-family:var(--mono);color:var(--tx);min-width:60px}
.time-slot-window{display:flex;align-items:center;gap:8px;flex:1}
.time-slot-input{width:70px;padding:8px 10px;border:1px solid var(--bg4);border-radius:8px;background:var(--bg2);color:var(--tx);font-size:.9rem;font-family:var(--mono);text-align:center}
.time-slot-input:focus{border-color:#008c95;outline:none}
.time-slot-points{display:flex;align-items:center;gap:12px}
.time-slot-points .point-box{display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 12px;background:var(--bg2);border-radius:8px;min-width:60px}
.time-slot-points .point-box label{font-size:.65rem;color:var(--tx3);text-transform:uppercase;letter-spacing:.03em}
.time-slot-points .point-box input{width:50px;padding:4px;border:1px solid var(--bg4);border-radius:4px;background:var(--cardBg);color:var(--tx);font-size:.9rem;text-align:center;font-weight:600}
.time-slot-delete{width:32px;height:32px;border-radius:8px;border:none;background:rgba(231,76,60,.1);color:#e74c3c;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.time-slot-delete:hover{background:#e74c3c;color:#fff}
.add-time-slot-btn{display:flex;align-items:center;justify-content:center;gap:8px;padding:14px;background:rgba(0,140,149,.08);border:2px dashed rgba(0,140,149,.3);border-radius:12px;color:#008c95;font-size:.9rem;font-weight:600;cursor:pointer;transition:all .2s;margin-top:12px}
.add-time-slot-btn:hover{background:rgba(0,140,149,.15);border-color:#008c95}

/* SÃ¼rÃ¼kle BÄ±rak Stilleri */
.checklist-item[draggable="true"]:hover{box-shadow:0 4px 20px rgba(0,0,0,.15)}
.checklist-item[draggable="true"]:hover .drag-handle{opacity:1}
.checklist-item.dragging{opacity:.5;transform:scale(.98)}
.drag-handle:hover{background:rgba(0,0,0,.1);border-radius:8px}

/* Responsive */
@media(max-width:768px){
    .sidebar{transform:translateX(-100%)}
    .sidebar.open{transform:translateX(0)}
    .main{margin-left:0}
    .form-grid{grid-template-columns:1fr}
    .form-group.full{grid-column:span 1}
    .cards{grid-template-columns:1fr}
}
@media print{
    .sidebar,.back-link,.preview-toolbar,.btn-group{display:none!important}
    .main{margin:0;background:#fff}
    .page{padding:0}
    .preview-container{border:none;box-shadow:none}
}

/* DeÄŸerlendir Butonu Animasyonu */
@keyframes subtlePulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(0,140,149,.3); }
    50% { box-shadow: 0 0 0 4px rgba(0,140,149,.1); }
}
.btn-evaluate-pulse {
    animation: subtlePulse 2.5s ease-in-out infinite;
}
.btn-evaluate-pulse:hover {
    animation: none;
}

/* 5 YÄ±ldÄ±z Rating Animasyonu */
@keyframes starShine {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}
.star-rating-5 { color: #f1c40f !important; }
.star-rating-4 { color: #f39c12 !important; }
.star-rating-3 { color: #95a5a6 !important; }
.star-rating-2 { color: #e67e22 !important; }
.star-rating-1 { color: #e74c3c !important; }

/* Duyuru Stilleri */
.announcement-card{background:linear-gradient(135deg,rgba(255,134,116,.08),rgba(255,134,116,.02));border:1px solid rgba(255,134,116,.2);border-left:3px solid #ff8674;border-radius:12px;padding:14px 16px;position:relative;transition:all .2s}
.announcement-card:hover{transform:translateX(4px);box-shadow:0 4px 12px rgba(0,0,0,.05)}
.announcement-header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:8px}
.announcement-title{font-size:.9rem;font-weight:600;color:var(--tx);display:flex;align-items:center;gap:8px}
.announcement-meta{font-size:.65rem;color:var(--tx3);display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin-top:10px}
.announcement-content{font-size:.82rem;color:var(--tx2);line-height:1.5}
.announcement-edit,.announcement-delete{background:none;border:none;color:var(--tx3);cursor:pointer;padding:4px;border-radius:4px;opacity:0;transition:all .2s}
.announcement-card:hover .announcement-edit,.announcement-card:hover .announcement-delete{opacity:1}
.announcement-edit:hover{background:rgba(0,140,149,.1);color:#008c95}
.announcement-delete:hover{background:rgba(231,76,60,.1);color:#e74c3c}
.announcement-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:10px;font-size:.6rem;font-weight:600;text-transform:uppercase;background:rgba(255,134,116,.15);color:#ff8674}
/* Duyuru AnimasyonlarÄ± */
@keyframes ann-pulse{0%,100%{opacity:.7;transform:scale(1)}50%{opacity:1;transform:scale(1.02)}}
@keyframes ann-shake{0%,100%{transform:translateX(0)}10%,30%,50%,70%,90%{transform:translateX(-3px)}20%,40%,60%,80%{transform:translateX(3px)}}
@keyframes ann-glow{0%,100%{box-shadow:0 0 5px rgba(255,134,116,.3)}50%{box-shadow:0 0 20px rgba(255,134,116,.7)}}
@keyframes ann-bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-4px)}}
@keyframes ann-slide{0%,100%{transform:translateX(0)}50%{transform:translateX(6px)}}
@keyframes ann-blink{0%,100%{opacity:1}50%{opacity:.5}}
@keyframes ann-heartbeat{0%,100%{transform:scale(1)}14%{transform:scale(1.03)}28%{transform:scale(1)}42%{transform:scale(1.03)}70%{transform:scale(1)}}
@keyframes ann-swing{0%,100%{transform:rotate(0deg)}25%{transform:rotate(3deg)}75%{transform:rotate(-3deg)}}
@keyframes ann-tada{0%,100%{transform:scale(1) rotate(0)}10%,20%{transform:scale(.95) rotate(-2deg)}30%,50%,70%,90%{transform:scale(1.05) rotate(2deg)}40%,60%,80%{transform:scale(1.05) rotate(-2deg)}}
@keyframes ann-rubber{0%,100%{transform:scaleX(1)}30%{transform:scaleX(1.15)}40%{transform:scaleX(.9)}50%{transform:scaleX(1.05)}65%{transform:scaleX(.98)}75%{transform:scaleX(1.02)}}
@keyframes ann-flash{0%,50%,100%{opacity:1}25%,75%{opacity:.3}}

/* Animasyon Class TanÄ±mlarÄ± */
.ann-pulse{animation:ann-pulse 2s ease-in-out infinite}
.ann-shake{animation:ann-shake 1s ease-in-out infinite}
.ann-glow{animation:ann-glow 2s ease-in-out infinite}
.ann-bounce{animation:ann-bounce 1s ease-in-out infinite}
.ann-slide{animation:ann-slide 1.5s ease-in-out infinite}
.ann-blink{animation:ann-blink 1s ease-in-out infinite}
.ann-heartbeat{animation:ann-heartbeat 1.5s ease-in-out infinite}
.ann-swing{animation:ann-swing 1s ease-in-out infinite}
.ann-tada{animation:ann-tada 1s ease-in-out infinite}
.ann-rubber{animation:ann-rubber 1s ease-in-out infinite}
.ann-flash{animation:ann-flash 1.5s ease-in-out infinite}
    </style>
</head>
<body>
    <!-- AUTH GUARD - GiriÅŸ yapmamÄ±ÅŸsa login.html'e yÃ¶nlendir -->
    <script>
        (function() {
            const checkAuth = setInterval(() => {
                // Firebase SDK yÃ¼klendi mi VE initialize edildi mi kontrol et
                if (typeof firebase !== 'undefined' && firebase.auth && firebase.apps && firebase.apps.length > 0) {
                    clearInterval(checkAuth);
                    firebase.auth().onAuthStateChanged(user => {
                        if (!user) {
                            window.location.replace('login.html');
                        }
                    });
                }
            }, 100);
            setTimeout(() => {
                clearInterval(checkAuth);
                // Timeout sonunda hala hazÄ±r deÄŸilse login'e yÃ¶nlendir
                try {
                    if (typeof firebase === 'undefined' || !firebase.apps || firebase.apps.length === 0 || !firebase.auth().currentUser) {
                        window.location.replace('login.html');
                    }
                } catch (e) {
                    window.location.replace('login.html');
                }
            }, 5000);
        })();
    </script>

    <!-- Modal System -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Modal</div>
                <button class="modal-close" onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- App -->
    <div class="app">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo" onclick="goTo('dashboard')" style="cursor:pointer" title="Ana Sayfaya DÃ¶n">
                    <img id="sidebarLogo" src="https://static.wixstatic.com/media/760af2_cb121a61291f4f07adb48cfb70f3e2d9~mv2.png/v1/fill/w_94,h_82,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/beyazwhitelogo-min1.png" alt="Logo" style="width:36px;height:auto">
                    <div class="logo-text-wrap">
                        <div class="logo-text">Moonberry</div>
                        <div class="logo-sub">YÃ¶netim Paneli</div>
                    </div>
                </div>
            </div>
            <nav class="nav">
                <!-- Ana Sayfa -->
                <div class="nav-item active" data-page="dashboard" data-tooltip="Ana Sayfa" onclick="goTo('dashboard')">
                    <span class="icon"><svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></span> Ana Sayfa
                </div>
                
                <!-- Performans -->
                <div class="nav-item" data-page="puantaj" data-tooltip="Performans" onclick="goTo('puantaj')">
                    <span class="icon"><svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></span> Performans
                </div>
                
                <!-- Prim Sistemi -->
                <div class="nav-item" data-page="primSistemi" data-tooltip="Prim Sistemi" onclick="goTo('primSistemi')">
                    <span class="icon"><svg viewBox="0 0 24 24"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg></span> Prim Sistemi
                </div>
                
                <!-- Shift PlanÄ± -->
                <div class="nav-item" data-page="shift" data-tooltip="Shift PlanÄ±" onclick="goTo('shift')">
                    <span class="icon"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></span> Shift PlanÄ±
                </div>
                
                <!-- Checklist -->
                <div class="nav-item" data-page="checklist" data-tooltip="Checklist" onclick="goTo('checklist')">
                    <span class="icon"><svg viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg></span> Checklist
                </div>
                
                <!-- G13: MÃ¼dÃ¼r NotlarÄ± (sadece yÃ¶netici gÃ¶rebilir) -->
                <div class="nav-item" id="nav-notlar" data-page="notlar" data-tooltip="Notlar" onclick="goTo('notlar')">
                    <span class="icon"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></span> Notlar
                </div>
                
                <!-- Personel -->
                <div class="nav-item" data-page="personel" data-tooltip="Personel" onclick="goTo('personel')">
                    <span class="icon"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></span> Personel
                </div>
                
                <div class="nav-divider"></div>
                
                <!-- Belgeler (Collapsible - KapalÄ± baÅŸla) -->
                <div class="nav-group" id="nav-belgeler">
                    <div class="nav-label collapsed" onclick="toggleNavGroup(this)">
                        ðŸ“„ Belgeler <span class="nav-arrow">â–¼</span>
                    </div>
                    <div class="nav-items collapsed">
                        <div class="nav-item" data-page="sozlesme" data-tooltip="Ä°ÅŸ SÃ¶zleÅŸmesi" onclick="goTo('sozlesme')">
                            <span class="icon"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></span> Ä°ÅŸ SÃ¶zleÅŸmesi
                        </div>
                        <div class="nav-item" data-page="tutanak" data-tooltip="Tutanak" onclick="goTo('tutanak')">
                            <span class="icon"><svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></span> Tutanak
                        </div>
                        <div class="nav-item" data-page="savunma" data-tooltip="Savunma Ä°steme" onclick="goTo('savunma')">
                            <span class="icon"><svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></span> Savunma Ä°steme
                        </div>
                        <div class="nav-item" data-page="fesih" data-tooltip="Fesih" onclick="goTo('fesih')">
                            <span class="icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg></span> Fesih
                        </div>
                        <div class="nav-item" data-page="istifa" data-tooltip="Ä°stifa" onclick="goTo('istifa')">
                            <span class="icon"><svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></span> Ä°stifa
                        </div>
                        <div class="nav-item" data-page="ibraname" data-tooltip="Ä°braname" onclick="goTo('ibraname')">
                            <span class="icon"><svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></span> Ä°braname
                        </div>
                    </div>
                </div>
                
                <!-- Formlar (Collapsible - KapalÄ± baÅŸla) -->
                <div class="nav-group" id="nav-formlar">
                    <div class="nav-label collapsed" onclick="toggleNavGroup(this)">
                        ðŸ“‘ Formlar <span class="nav-arrow">â–¼</span>
                    </div>
                    <div class="nav-items collapsed">
                        <div class="nav-item" data-page="borc" data-tooltip="BorÃ§ Ä°krar" onclick="goTo('borc')">
                            <span class="icon"><svg viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></span> BorÃ§ Ä°krar
                        </div>
                        <div class="nav-item" data-page="avans" data-tooltip="Avans Talebi" onclick="goTo('avans')">
                            <span class="icon"><svg viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg></span> Avans Talebi
                        </div>
                        <div class="nav-item" data-page="zimmet" data-tooltip="Zimmet Formu" onclick="goTo('zimmet')">
                            <span class="icon"><svg viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg></span> Zimmet Formu
                        </div>
                    </div>
                </div>
                
                <div class="nav-divider"></div>
                
                <!-- Ä°hlal KataloÄŸu (tek baÅŸÄ±na) -->
                <div class="nav-item" data-page="katalog" data-tooltip="Ä°hlal KataloÄŸu" onclick="goTo('katalog')">
                    <span class="icon"><svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg></span> Ä°hlal KataloÄŸu
                </div>
                
                <!-- Ayarlar (en altta) -->
                <div class="nav-item" data-page="admin" data-tooltip="Ayarlar" onclick="openAdminWithPin()">
                    <span class="icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></span> Ayarlar
                </div>
                <!-- KullanÄ±cÄ± Bilgisi ve Ã‡Ä±kÄ±ÅŸ -->
                <div class="sidebar-user" style="margin-top:auto;padding:12px;border-top:1px solid rgba(255,255,255,.1)">
                    <div id="userInfo" onclick="goTo('admin');showAdminTab('genel',document.querySelector('.admin-tab'))" style="display:flex;align-items:center;gap:12px;cursor:pointer;padding:8px;margin-bottom:8px;border-radius:8px;transition:background .2s" onmouseover="this.style.background='rgba(255,255,255,.1)'" onmouseout="this.style.background='transparent'" title="Profil AyarlarÄ±">
                        <div class="user-avatar" style="width:36px;height:36px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:.9rem;color:#fff;font-weight:600;flex-shrink:0;overflow:hidden" id="userAvatar">ðŸ‘¤</div>
                        <div class="user-details" style="flex:1;overflow:hidden">
                            <div id="userName" style="color:var(--sidebarTx);font-size:.85rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">YÃ¼kleniyor...</div>
                            <div id="userRole" style="color:var(--sidebarTx2);font-size:.7rem">-</div>
                        </div>
                        <svg class="user-details" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--sidebarTx2)" stroke-width="2" style="flex-shrink:0"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c.26.604.852.997 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                    </div>
                    <!-- Ã‡Ä±kÄ±ÅŸ ve Daralt butonlarÄ± - nav-item stili -->
                    <div class="nav-item sidebar-action-btn" data-tooltip="Ã‡Ä±kÄ±ÅŸ Yap" onclick="logout()">
                        <span class="icon"><svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></span> Ã‡Ä±kÄ±ÅŸ Yap
                    </div>
                    <div class="nav-item sidebar-action-btn" data-tooltip="MenÃ¼yÃ¼ Daralt" onclick="toggleSidebar()">
                        <span class="icon"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="3" x2="9" y2="21"/></svg></span> Daralt
                    </div>
                </div>
            </nav>
        </aside>

        <main class="main">
            <!-- Global Header with Breadcrumb and Dark Mode -->
            <div class="main-header">
                <div id="breadcrumb" style="display:flex;align-items:center;gap:10px;font-size:.9rem">
                    <a onclick="goTo('dashboard')" style="color:var(--accent);font-weight:600;cursor:pointer;text-decoration:none;display:flex;align-items:center;gap:8px">
                        <img id="breadcrumbLogo" src="https://static.wixstatic.com/media/760af2_cb121a61291f4f07adb48cfb70f3e2d9~mv2.png" style="width:28px;height:24px;object-fit:contain" onerror="this.outerHTML='â˜•'"> Moonberry
                    </a>
                    <span style="color:var(--tx3);font-size:.8rem">â€º</span>
                    <span id="currentPageName" style="color:var(--tx);font-weight:500">Ana Sayfa</span>
                </div>
                <button onclick="toggleDarkMode()" id="darkModeBtn" style="background:var(--bg3);border:1px solid var(--bg4);border-radius:8px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s" title="KaranlÄ±k/AydÄ±nlÄ±k Mod">
                    <svg id="darkModeIcon" width="18" height="18" fill="none" stroke="var(--tx)" stroke-width="2" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                </button>
            </div>
            
            <!-- Dashboard -->
            <div class="page active" id="page-dashboard">
                <div class="page-header" style="margin-bottom:24px">
                    <div class="page-title" style="display:flex;align-items:center;gap:10px">
                        <div style="width:36px;height:36px;background:linear-gradient(135deg,#ff8674,#008c95);border-radius:8px;display:flex;align-items:center;justify-content:center">
                            <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                        </div>
                        YÃ¶netim Paneli
                    </div>
                    <div class="page-subtitle" style="display:flex;align-items:center;gap:6px;font-size:.85rem;color:var(--tx3)">
                        <button onclick="loadMotivationQuote()" style="background:none;border:none;cursor:pointer;padding:2px;display:inline-flex;align-items:center;justify-content:center;transition:all .2s;color:#008c95;opacity:.6;flex-shrink:0" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='.6'" title="Yeni sÃ¶z">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
                        </button>
                        <span id="motivationQuote" style="font-style:italic">YÃ¼kleniyor...</span>
                    </div>
                </div>
                
                <!-- Personel KarÅŸÄ±lama KartÄ± - Dinamik -->
                <div id="welcomeCard" style="margin-bottom:24px;display:none">
                    <div style="background:linear-gradient(135deg,var(--accent),#008c95);border-radius:16px;padding:24px;color:#fff;position:relative;overflow:hidden">
                        <!-- Hareketli Baloncuklar -->
                        <div class="floating-bubble" style="right:20px;top:20px;width:60px;height:60px;animation-delay:0s"></div>
                        <div class="floating-bubble" style="right:60px;bottom:10px;width:40px;height:40px;animation-delay:.5s"></div>
                        <div class="floating-bubble" style="right:100px;top:40px;width:25px;height:25px;animation-delay:1s"></div>
                        <div class="floating-bubble" style="right:-10px;bottom:30px;width:80px;height:80px;animation-delay:1.5s;opacity:.4"></div>
                        <div style="position:relative;z-index:1">
                            <div style="font-size:.85rem;opacity:.9;margin-bottom:4px" id="welcomeDate">YÃ¼kleniyor...</div>
                            <div style="font-size:1.4rem;font-weight:700;margin-bottom:12px" id="welcomeMessage">HoÅŸ geldin!</div>
                            <div style="display:flex;gap:16px;flex-wrap:wrap">
                                <div id="welcomeBranch" style="display:flex;align-items:center;gap:6px;font-size:.9rem">
                                    <span>ðŸ“</span> <span>-</span>
                                </div>
                                <div id="welcomeShift" style="display:flex;align-items:center;gap:6px;font-size:.9rem">
                                    <span>â°</span> <span>-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Duyurular AlanÄ± -->
                <div id="announcementsSection" style="margin-bottom:24px;display:none">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;padding:0 4px">
                        <div style="font-size:.8rem;font-weight:600;color:var(--tx2);text-transform:uppercase;letter-spacing:.08em;display:flex;align-items:center;gap:8px">
                            <svg width="14" height="14" fill="none" stroke="#ff8674" stroke-width="2" viewBox="0 0 24 24"><path d="M22 17H2a3 3 0 003-3V9a7 7 0 0114 0v5a3 3 0 003 3zM8.5 17v1a3.5 3.5 0 007 0v-1"/></svg>
                            Duyurular
                        </div>
                        <div style="display:flex;align-items:center;gap:8px">
                            <select id="announcementLimitSelect" onchange="changeAnnouncementLimit(this.value)" style="padding:4px 8px;border:1px solid var(--cardBorder);border-radius:6px;font-size:.7rem;background:var(--bg2);color:var(--tx2);cursor:pointer">
                                <option value="3" selected>3 gÃ¶ster</option>
                                <option value="5">5 gÃ¶ster</option>
                                <option value="10">10 gÃ¶ster</option>
                            </select>
                            <button id="addAnnouncementBtn" onclick="showAddAnnouncementModal()" style="display:none;background:linear-gradient(135deg,#ff8674,#ff6b5b);color:#fff;border:none;padding:6px 12px;border-radius:8px;font-size:.7rem;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:4px">
                                <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                Yeni Duyuru
                            </button>
                        </div>
                    </div>
                    <div id="announcementsContainer" style="display:flex;flex-direction:column;gap:10px">
                        <!-- Duyurular dinamik yÃ¼klenecek -->
                    </div>
                    <button id="loadMoreAnnouncements" onclick="loadMoreAnnouncements()" style="display:none;width:100%;margin-top:12px;background:var(--bg3);border:1px solid var(--cardBorder);color:var(--tx2);padding:10px;border-radius:8px;font-size:.8rem;cursor:pointer">
                        Daha fazla gÃ¶ster
                    </button>
                </div>
                
                <!-- BugÃ¼nkÃ¼ Checklerim - Dinamik -->
                <div id="todayChecksSection" class="dashboard-section" style="margin-bottom:28px">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;padding:0 4px">
                        <div style="font-size:.8rem;font-weight:600;color:var(--tx2);text-transform:uppercase;letter-spacing:.08em;display:flex;align-items:center;gap:8px">
                            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
                            BugÃ¼nkÃ¼ GÃ¶revlerim
                        </div>
                        <div id="checksTotalCount" style="font-size:.7rem;color:var(--tx3)"></div>
                    </div>
                    <div id="todayChecksContainer">
                        <!-- Åžube gruplarÄ± dinamik olarak yÃ¼klenecek -->
                    </div>
                </div>
                
                <!-- Bu Ay Puan Ã–zeti - Dinamik -->
                <div id="monthlyPointsCard" style="margin-bottom:24px;display:none">
                    <div style="background:linear-gradient(135deg,rgba(0,140,149,.08),rgba(0,140,149,.03));border:1px solid rgba(0,140,149,.15);border-radius:16px;padding:20px;cursor:pointer" onclick="showMonthlyPointsModal()">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                            <div style="display:flex;align-items:center;gap:10px">
                                <div style="width:36px;height:36px;background:linear-gradient(135deg,#008c95,#00a8b5);border-radius:10px;display:flex;align-items:center;justify-content:center">
                                    <svg width="18" height="18" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M12 20V10M18 20V4M6 20v-4"/></svg>
                                </div>
                                <div>
                                    <div style="font-size:.85rem;font-weight:700;color:var(--tx)">Bu Ay PuanÄ±m</div>
                                    <div style="font-size:.65rem;color:var(--tx3)">${new Date().toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' })}</div>
                                </div>
                            </div>
                            <div id="monthlyPointsTotal" style="font-size:1.4rem;font-weight:800">-</div>
                        </div>
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px" id="monthlyPointsDetails">
                            <!-- Dinamik iÃ§erik -->
                        </div>
                        <div style="text-align:center;margin-top:12px;font-size:.65rem;color:var(--tx3)">Detaylar iÃ§in tÄ±klayÄ±n â†’</div>
                    </div>
                </div>
                
                <!-- Bu Ay Puan SÄ±ralamasÄ± - Sadece YÃ¶neticiler -->
                <div id="leaderboardSection" class="dashboard-section" style="margin-bottom:28px;display:none">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;padding:0 4px">
                        <div style="font-size:.8rem;font-weight:600;color:var(--tx2);text-transform:uppercase;letter-spacing:.08em;display:flex;align-items:center;gap:8px">
                            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                            Bu Ay Puan SÄ±ralamasÄ±
                        </div>
                        <div style="display:flex;gap:4px">
                            <button onclick="loadLeaderboard()" class="btn btn-sm btn-ghost" style="font-size:.7rem">ðŸ”„ Yenile</button>
                            <button onclick="showWeeklyReportModal()" class="btn btn-sm btn-ghost" style="font-size:.7rem">ðŸ“Š HaftalÄ±k Rapor</button>
                        </div>
                    </div>
                    <div id="leaderboardContainer" style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:16px;overflow:hidden">
                        <div style="padding:20px;text-align:center;color:var(--tx3)">YÃ¼kleniyor...</div>
                    </div>
                </div>
                
                <!-- KPI Dashboard - Åžube Performans -->
                <div id="kpiDashboardSection" class="dashboard-section" style="margin-bottom:28px;display:none">
                    <div style="font-size:.8rem;font-weight:600;color:var(--tx2);text-transform:uppercase;letter-spacing:.08em;margin-bottom:16px;padding-left:4px;display:flex;align-items:center;gap:8px">
                        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
                        Åžube Performans
                    </div>
                    <div id="kpiDashboardContainer" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px">
                    </div>
                </div>
                
                <!-- Personel YÃ¶netimi -->
                <div class="dashboard-section" style="margin-bottom:28px">
                    <div style="font-size:.8rem;font-weight:600;color:var(--tx2);text-transform:uppercase;letter-spacing:.08em;margin-bottom:16px;padding-left:4px;display:flex;align-items:center;gap:8px">
                        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
                        Personel YÃ¶netimi
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px">
                        <div class="dashboard-card" onclick="goTo('personel')" style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:20px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:16px">
                            <div style="width:40px;height:40px;background:linear-gradient(135deg,#ff8674,#ff6b5b);border-radius:10px;display:flex;align-items:center;justify-content:center">
                                <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
                            </div>
                            <div>
                                <div style="font-weight:600;color:var(--tx)">Personel</div>
                                <div style="font-size:.75rem;color:var(--tx2)">Liste & YÃ¶netim</div>
                            </div>
                        </div>
                        <div class="dashboard-card" onclick="goTo('puantaj')" style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:20px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:16px">
                            <div style="width:40px;height:40px;background:linear-gradient(135deg,#ff8674,#008c95);border-radius:10px;display:flex;align-items:center;justify-content:center">
                                <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                            </div>
                            <div>
                                <div style="font-weight:600;color:var(--tx)">Puantaj</div>
                                <div style="font-size:.75rem;color:var(--tx2)">Performans Sistemi</div>
                            </div>
                        </div>
                        <div class="dashboard-card" onclick="goTo('shift')" style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:20px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:16px">
                            <div style="width:40px;height:40px;background:linear-gradient(135deg,#008c95,#00a8a8);border-radius:10px;display:flex;align-items:center;justify-content:center">
                                <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                            </div>
                            <div>
                                <div style="font-weight:600;color:var(--tx)">Shift PlanÄ±</div>
                                <div style="font-size:.75rem;color:var(--tx2)">HaftalÄ±k Vardiya</div>
                            </div>
                        </div>
                        <div class="dashboard-card" onclick="goTo('checklist')" style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:20px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:16px">
                            <div style="width:40px;height:40px;background:linear-gradient(135deg,#00c9a7,#008c95);border-radius:10px;display:flex;align-items:center;justify-content:center">
                                <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
                            </div>
                            <div>
                                <div style="font-weight:600;color:var(--tx)">Checklist</div>
                                <div style="font-size:.75rem;color:var(--tx2)">GÃ¼nlÃ¼k Kontrol</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Belgeler -->
                <div class="dashboard-section" style="margin-bottom:28px">
                    <div style="font-size:.8rem;font-weight:600;color:var(--tx2);text-transform:uppercase;letter-spacing:.08em;margin-bottom:16px;padding-left:4px;display:flex;align-items:center;gap:8px">
                        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                        Belgeler
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px">
                        <div class="dashboard-card" onclick="goTo('sozlesme')" style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:20px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:16px">
                            <div style="width:40px;height:40px;background:linear-gradient(135deg,#008c95,#00a8a8);border-radius:10px;display:flex;align-items:center;justify-content:center">
                                <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                            </div>
                            <div>
                                <div style="font-weight:600;color:var(--tx)">SÃ¶zleÅŸme</div>
                                <div style="font-size:.75rem;color:var(--tx2)">Ä°ÅŸ SÃ¶zleÅŸmesi</div>
                            </div>
                        </div>
                        <div class="dashboard-card" onclick="goTo('tutanak')" style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:20px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:16px">
                            <div style="width:40px;height:40px;background:linear-gradient(135deg,#ff8674,#ffa07a);border-radius:10px;display:flex;align-items:center;justify-content:center">
                                <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                            </div>
                            <div>
                                <div style="font-weight:600;color:var(--tx)">Tutanak</div>
                                <div style="font-size:.75rem;color:var(--tx2)">Olay Tespit</div>
                            </div>
                        </div>
                        <div class="dashboard-card" onclick="goTo('savunma')" style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:20px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:16px">
                            <div style="width:40px;height:40px;background:linear-gradient(135deg,#008c95,#4db6ac);border-radius:10px;display:flex;align-items:center;justify-content:center">
                                <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
                            </div>
                            <div>
                                <div style="font-weight:600;color:var(--tx)">Savunma</div>
                                <div style="font-size:.75rem;color:var(--tx2)">Savunma Ä°steme</div>
                            </div>
                        </div>
                        <div class="dashboard-card" onclick="goTo('fesih')" style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:20px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:16px">
                            <div style="width:40px;height:40px;background:linear-gradient(135deg,#e74c3c,#c0392b);border-radius:10px;display:flex;align-items:center;justify-content:center">
                                <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                            </div>
                            <div>
                                <div style="font-weight:600;color:var(--tx)">Fesih</div>
                                <div style="font-size:.75rem;color:var(--tx2)">Ä°ÅŸ Akdi Fesih</div>
                            </div>
                        </div>
                        <div class="dashboard-card" onclick="goTo('istifa')" style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:20px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:16px">
                            <div style="width:40px;height:40px;background:linear-gradient(135deg,#ff8674,#008c95);border-radius:10px;display:flex;align-items:center;justify-content:center">
                                <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                            </div>
                            <div>
                                <div style="font-weight:600;color:var(--tx)">Ä°stifa</div>
                                <div style="font-size:.75rem;color:var(--tx2)">Ä°stifa DilekÃ§esi</div>
                            </div>
                        </div>
                        <div class="dashboard-card" onclick="goTo('ibraname')" style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:20px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:16px">
                            <div style="width:40px;height:40px;background:linear-gradient(135deg,#27ae60,#2ecc71);border-radius:10px;display:flex;align-items:center;justify-content:center">
                                <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                            </div>
                            <div>
                                <div style="font-weight:600;color:var(--tx)">Ä°braname</div>
                                <div style="font-size:.75rem;color:var(--tx2)">Ä°bra Belgesi</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Formlar -->
                <div class="dashboard-section" id="dashboard-formlar-section" style="margin-bottom:28px">
                    <div style="font-size:.8rem;font-weight:600;color:var(--tx2);text-transform:uppercase;letter-spacing:.08em;margin-bottom:16px;padding-left:4px">ðŸ“‘ Formlar</div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px">
                        <div class="dashboard-card" onclick="goTo('borc')" style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:20px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:16px">
                            <div style="width:40px;height:40px;background:rgba(0,140,149,.1);border-radius:10px;display:flex;align-items:center;justify-content:center"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--brand-teal)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div>
                            <div>
                                <div style="font-weight:600;color:var(--tx)">BorÃ§ Ä°krar</div>
                                <div style="font-size:.75rem;color:var(--tx2)">Kesinti OnayÄ±</div>
                            </div>
                        </div>
                        <div class="dashboard-card" onclick="goTo('avans')" style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:20px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:16px">
                            <div style="width:40px;height:40px;background:rgba(255,134,116,.1);border-radius:10px;display:flex;align-items:center;justify-content:center"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--brand-coral)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="6" width="20" height="12" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/><line x1="6" y1="14" x2="8" y2="14"/><line x1="12" y1="14" x2="16" y2="14"/></svg></div>
                            <div>
                                <div style="font-weight:600;color:var(--tx)">Avans</div>
                                <div style="font-size:.75rem;color:var(--tx2)">Avans Talebi</div>
                            </div>
                        </div>
                        <div class="dashboard-card" onclick="goTo('zimmet')" style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:20px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:16px">
                            <div style="width:40px;height:40px;background:rgba(0,140,149,.1);border-radius:10px;display:flex;align-items:center;justify-content:center"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--brand-teal)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg></div>
                            <div>
                                <div style="font-weight:600;color:var(--tx)">Zimmet</div>
                                <div style="font-size:.75rem;color:var(--tx2)">DemirbaÅŸ Teslim</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- DiÄŸer -->
                <div class="dashboard-section">
                    <div style="font-size:.8rem;font-weight:600;color:var(--tx2);text-transform:uppercase;letter-spacing:.08em;margin-bottom:16px;padding-left:4px;display:flex;align-items:center;gap:8px">
                        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
                        Sistem
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px">
                        <div class="dashboard-card" onclick="goTo('katalog')" style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:20px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:16px">
                            <div style="width:40px;height:40px;background:linear-gradient(135deg,#008c95,#4db6ac);border-radius:10px;display:flex;align-items:center;justify-content:center">
                                <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>
                            </div>
                            <div>
                                <div style="font-weight:600;color:var(--tx)">Ä°hlal KataloÄŸu</div>
                                <div style="font-size:.75rem;color:var(--tx2)">Yasal Dayanaklar</div>
                            </div>
                        </div>
                        <div class="dashboard-card" onclick="openAdminWithPin()" style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:20px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:16px">
                            <div style="width:40px;height:40px;background:linear-gradient(135deg,#ff8674,#008c95);border-radius:10px;display:flex;align-items:center;justify-content:center">
                                <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
                            </div>
                            <div>
                                <div style="font-weight:600;color:var(--tx)">YÃ¶netim</div>
                                <div style="font-size:.75rem;color:var(--tx2)">Sistem AyarlarÄ±</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SÃ¶zleÅŸme -->
            <div class="page" id="page-sozlesme">
                <div class="back-link" onclick="goTo('dashboard')">â† Ana Sayfa</div>
                <div class="page-header">
                    <div class="page-title">Ä°ÅŸ SÃ¶zleÅŸmesi</div>
                    <div class="page-subtitle">Pozisyona Ã¶zel sÃ¶zleÅŸme oluÅŸtur</div>
                </div>
                <div class="form-section">
                    <div class="form-section-title">ðŸ‘¤ Pozisyon SeÃ§</div>
                    <div class="type-cards" id="sozlesmePozisyonlar"></div>
                </div>
                <div class="form-section">
                    <div class="form-section-title" style="display:flex;align-items:center;gap:8px"><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg> Personel Bilgileri</div>
                    <div class="form-grid">
                        <div class="form-group"><label class="form-label">Ad Soyad</label><input type="text" id="soz_ad" class="form-input" placeholder="Personel adÄ±"></div>
                        <div class="form-group"><label class="form-label">TC Kimlik</label><input type="text" id="soz_tc" class="form-input" placeholder="11 hane" maxlength="11"></div>
                        <div class="form-group full"><label class="form-label">Adres</label><input type="text" id="soz_adres" class="form-input" placeholder="Ä°kametgah adresi"></div>
                        <div class="form-group"><label class="form-label">Cep Telefonu</label><input type="text" id="soz_telefon" class="form-input" placeholder="+90 5XX XXX XX XX"></div>
                        <div class="form-group"><label class="form-label">IBAN</label><input type="text" id="soz_iban" class="form-input" placeholder="TR..."></div>
                        <div class="form-group"><label class="form-label">Ä°ÅŸe BaÅŸlama</label><input type="date" id="soz_baslama" class="form-input"></div>
                        <div class="form-group"><label class="form-label">BrÃ¼t Ãœcret (TL)</label><input type="text" id="soz_ucret" class="form-input" placeholder="25.000"></div>
                        <div class="form-group"><label class="form-label">Åžube</label><select id="soz_sube" class="form-select"></select></div>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="generateSozlesme()">ðŸ“„ SÃ¶zleÅŸme OluÅŸtur</button>
                    <button class="btn btn-ghost" onclick="clearForm('soz')">Temizle</button>
                </div>
            </div>

            <!-- Tutanak -->
            <div class="page" id="page-tutanak">
                <div class="back-link" onclick="goTo('dashboard')">â† Ana Sayfa</div>
                <div class="page-header">
                    <div class="page-title">Tutanak OluÅŸtur</div>
                </div>
                <div class="form-section">
                    <div class="form-section-title" style="display:flex;align-items:center;gap:8px"><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg> Tutanak TÃ¼rÃ¼</div>
                    <div class="type-cards">
                        <div class="type-card" data-type="olay" onclick="selectType('tutanak','olay',this)"><div class="type-card-icon">ðŸ“</div><div class="type-card-title">Olay Tespit</div></div>
                        <div class="type-card" data-type="devamsizlik" onclick="selectType('tutanak','devamsizlik',this)"><div class="type-card-icon">ðŸ“…</div><div class="type-card-title">DevamsÄ±zlÄ±k</div></div>
                        <div class="type-card" data-type="kasa" onclick="selectType('tutanak','kasa',this)"><div class="type-card-icon" style="color:var(--brand-teal)">â‚º</div><div class="type-card-title">Kasa AÃ§Ä±ÄŸÄ±</div></div>
                        <div class="type-card" data-type="imza" onclick="selectType('tutanak','imza',this)"><div class="type-card-icon">âœï¸</div><div class="type-card-title">Ä°mzadan Ä°mtina</div></div>
                    </div>
                </div>
                <div class="form-section">
                    <div class="form-section-title">ðŸ“ Bilgiler</div>
                    <div class="form-grid">
                        <div class="form-group"><label class="form-label">Personel</label><input type="text" id="tut_personel" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Pozisyon</label><select id="tut_pozisyon" class="form-select"></select></div>
                        <div class="form-group"><label class="form-label">Olay Tarihi</label><input type="date" id="tut_tarih" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Olay Saati</label><input type="time" id="tut_saat" class="form-input"></div>
                        <div class="form-group"><label class="form-label">DÃ¼zenleme Tarihi</label><input type="date" id="tut_duz_tarih" class="form-input"></div>
                        <div class="form-group"><label class="form-label">DÃ¼zenleme Saati</label><input type="time" id="tut_duz_saat" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Åžube</label><select id="tut_sube" class="form-select"></select></div>
                        <div class="form-group" id="tut_kasa_field" style="display:none"><label class="form-label">AÃ§Ä±k TutarÄ± (TL)</label><input type="text" id="tut_kasa" class="form-input"></div>
                        <div class="form-group full"><label class="form-label">AÃ§Ä±klama</label><textarea id="tut_aciklama" class="form-textarea" placeholder="OlayÄ± aÃ§Ä±klayÄ±n..."></textarea></div>
                        <div class="form-group"><label class="form-label">1. Åžahit</label><input type="text" id="tut_sahit1" class="form-input"></div>
                        <div class="form-group"><label class="form-label">2. Åžahit</label><input type="text" id="tut_sahit2" class="form-input"></div>
                        <div class="form-group"><label class="form-label">DÃ¼zenleyen</label><input type="text" id="tut_duzenleyen" class="form-input"></div>
                        <div class="form-group"><label class="form-label">GÃ¶revi</label><input type="text" id="tut_gorev" class="form-input"></div>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="generateTutanak()">ðŸ“„ Tutanak OluÅŸtur</button>
                    <button class="btn btn-ghost" onclick="clearForm('tut')">Temizle</button>
                </div>
            </div>

            <!-- Savunma -->
            <div class="page" id="page-savunma">
                <div class="back-link" onclick="goTo('dashboard')">â† Ana Sayfa</div>
                <div class="page-header">
                    <div class="page-title">Savunma Ä°steme</div>
                </div>
                <div class="alert alert-warning">
                    <span class="alert-icon"><svg width="18" height="18" fill="none" stroke="#f39c12" stroke-width="2" viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></span>
                    <div>Ä°ÅŸ Kanunu Md. 19: Fesih Ã¶ncesi savunma almak zorunludur.</div>
                </div>
                <div class="form-section">
                    <div class="form-grid">
                        <div class="form-group"><label class="form-label">Personel</label><input type="text" id="sav_personel" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Pozisyon</label><select id="sav_pozisyon" class="form-select"></select></div>
                        <div class="form-group"><label class="form-label">Ä°hlal Tarihi</label><input type="date" id="sav_tarih" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Åžube</label><select id="sav_sube" class="form-select"></select></div>
                        <div class="form-group"><label class="form-label">DÃ¼zenleme Tarihi</label><input type="date" id="sav_duz_tarih" class="form-input"></div>
                        <div class="form-group"><label class="form-label">DÃ¼zenleme Saati</label><input type="time" id="sav_duz_saat" class="form-input"></div>
                        <div class="form-group full"><label class="form-label">Ä°snat Edilen Eylem</label><textarea id="sav_isnat" class="form-textarea" placeholder="DetaylÄ± aÃ§Ä±klayÄ±n..."></textarea></div>
                        <div class="form-group"><label class="form-label">Savunma SÃ¼resi</label><select id="sav_sure" class="form-select"><option value="1" selected>1 Ä°ÅŸ GÃ¼nÃ¼ (Minimum)</option><option value="2">2 Ä°ÅŸ GÃ¼nÃ¼</option><option value="3">3 Ä°ÅŸ GÃ¼nÃ¼</option><option value="5">5 Ä°ÅŸ GÃ¼nÃ¼</option></select></div>
                        <div class="form-group"><label class="form-label">Yetkili</label><input type="text" id="sav_yetkili" class="form-input"></div>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="generateSavunma()">ðŸ“„ Belge OluÅŸtur</button>
                </div>
            </div>

            <!-- Fesih -->
            <div class="page" id="page-fesih">
                <div class="back-link" onclick="goTo('dashboard')">â† Ana Sayfa</div>
                <div class="page-header">
                    <div class="page-title">Fesih Ä°ÅŸlemleri</div>
                </div>
                <div class="form-section">
                    <div class="form-section-title" style="display:flex;align-items:center;gap:8px">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                        Fesih TÃ¼rÃ¼
                    </div>
                    <div class="type-cards">
                        <div class="type-card" data-type="hakli" onclick="selectFesihType('hakli',this)">
                            <div class="type-card-icon"><svg width="24" height="24" fill="none" stroke="#e74c3c" stroke-width="2" viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></div>
                            <div class="type-card-title">HaklÄ± Fesih</div>
                            <div class="type-card-sub">Md. 25/II - TazminatsÄ±z</div>
                        </div>
                        <div class="type-card" data-type="gecerli" onclick="selectFesihType('gecerli',this)">
                            <div class="type-card-icon"><svg width="24" height="24" fill="none" stroke="#3498db" stroke-width="2" viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/><path d="M9 14l2 2 4-4"/></svg></div>
                            <div class="type-card-title">GeÃ§erli Fesih</div>
                            <div class="type-card-sub">Md. 18 - TazminatlÄ±</div>
                        </div>
                        <div class="type-card" data-type="deneme" onclick="selectFesihType('deneme',this)">
                            <div class="type-card-icon"><svg width="24" height="24" fill="none" stroke="#f39c12" stroke-width="2" viewBox="0 0 24 24"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg></div>
                            <div class="type-card-title">Deneme Feshi</div>
                            <div class="type-card-sub">Bildirimsiz</div>
                        </div>
                    </div>
                </div>
                <div id="fesih_6gun_alert" class="alert alert-danger" style="display:none">
                    <span class="alert-icon"><svg width="18" height="18" fill="none" stroke="#e74c3c" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg></span>
                    <div><strong>6 Ä°ÅŸ GÃ¼nÃ¼ UyarÄ±sÄ±!</strong> HaklÄ± fesih iÃ§in sÃ¼re dolmuÅŸ olabilir. Yine de belge oluÅŸturabilirsiniz.</div>
                </div>
                <div class="form-section">
                    <div class="form-grid">
                        <div class="form-group"><label class="form-label">Personel</label><input type="text" id="fes_personel" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Pozisyon</label><select id="fes_pozisyon" class="form-select"></select></div>
                        <div class="form-group"><label class="form-label">Åžube</label><select id="fes_sube" class="form-select"></select></div>
                        <div class="form-group" id="fes_ogrenme_field"><label class="form-label">Ã–ÄŸrenme Tarihi</label><input type="date" id="fes_ogrenme" class="form-input" onchange="check6Gun()"></div>
                        <div class="form-group"><label class="form-label">Ä°ÅŸe GiriÅŸ</label><input type="date" id="fes_giris" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Fesih Tarihi</label><input type="date" id="fes_tarih" class="form-input"></div>
                        <div class="form-group full"><label class="form-label">GerekÃ§e</label><textarea id="fes_gerekce" class="form-textarea"></textarea></div>
                        <div class="form-group"><label class="form-label">Dayanak</label><select id="fes_dayanak" class="form-select"></select></div>
                        <div class="form-group"><label class="form-label">Yetkili</label><input type="text" id="fes_yetkili" class="form-input"></div>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-danger" onclick="generateFesih()">â›” Fesih OluÅŸtur</button>
                </div>
            </div>

            <!-- Ä°stifa DilekÃ§esi -->
            <div class="page" id="page-istifa">
                <div class="back-link" onclick="goTo('dashboard')">â† Ana Sayfa</div>
                <div class="page-header">
                    <div class="page-title" style="display:flex;align-items:center;gap:10px">
                        <div style="width:36px;height:36px;background:linear-gradient(135deg,#a29bfe,#6c5ce7);border-radius:8px;display:flex;align-items:center;justify-content:center">
                            <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                        </div>
                        Ä°stifa DilekÃ§esi
                    </div>
                </div>
                <div class="alert alert-info"><span class="alert-icon">â„¹ï¸</span><div>Ä°ÅŸ Kanunu Md.17: Ä°ÅŸÃ§i istifa etmek istediÄŸinde ihbar sÃ¼resine uymak zorundadÄ±r. Aksi halde iÅŸveren tazminat talep edebilir.</div></div>
                <div class="form-section">
                    <div class="form-grid">
                        <div class="form-group"><label class="form-label">Personel AdÄ± SoyadÄ±</label><input type="text" id="istifa_personel" class="form-input"></div>
                        <div class="form-group"><label class="form-label">TC Kimlik No</label><input type="text" id="istifa_tc" class="form-input" maxlength="11"></div>
                        <div class="form-group"><label class="form-label">Åžube</label><select id="istifa_sube" class="form-select"></select></div>
                        <div class="form-group"><label class="form-label">Pozisyon</label><select id="istifa_pozisyon" class="form-select"></select></div>
                        <div class="form-group"><label class="form-label">Ä°ÅŸe GiriÅŸ Tarihi</label><input type="date" id="istifa_giris" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Ä°stifa Tarihi</label><input type="date" id="istifa_tarih" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Son Ã‡alÄ±ÅŸma Tarihi</label><input type="date" id="istifa_son_tarih" class="form-input"></div>
                        <div class="form-group">
                            <label class="form-label">Ä°hbar SÃ¼resi</label>
                            <select id="istifa_ihbar" class="form-select">
                                <option value="0">Ä°hbar SÃ¼resiz (Derhal)</option>
                                <option value="2">2 Hafta (6 aya kadar)</option>
                                <option value="4">4 Hafta (6 ay - 1.5 yÄ±l)</option>
                                <option value="6">6 Hafta (1.5 - 3 yÄ±l)</option>
                                <option value="8">8 Hafta (3 yÄ±l Ã¼zeri)</option>
                            </select>
                        </div>
                        <div class="form-group full"><label class="form-label">Ä°stifa Nedeni (Ä°steÄŸe BaÄŸlÄ±)</label><textarea id="istifa_neden" class="form-textarea" placeholder="KiÅŸisel nedenlerden dolayÄ±... (boÅŸ bÄ±rakÄ±labilir)"></textarea></div>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="generateIstifa()">ðŸ“„ Ä°stifa DilekÃ§esi OluÅŸtur</button>
                </div>
            </div>

            <!-- Ä°braname -->
            <div class="page" id="page-ibraname">
                <div class="back-link" onclick="goTo('dashboard')">â† Ana Sayfa</div>
                <div class="page-header">
                    <div class="page-title" style="display:flex;align-items:center;gap:10px">
                        <div style="width:36px;height:36px;background:linear-gradient(135deg,#00b894,#00cec9);border-radius:8px;display:flex;align-items:center;justify-content:center">
                            <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                        </div>
                        Ä°braname
                    </div>
                </div>
                <div class="alert alert-warning">
                    <span class="alert-icon"><svg width="18" height="18" fill="none" stroke="#f39c12" stroke-width="2" viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></span>
                    <div>TBK Md.420: Ä°branamenin geÃ§erliliÄŸi iÃ§in iÅŸÃ§inin yazÄ±lÄ± onayÄ± ve Ã¶demenin banka yoluyla yapÄ±lmasÄ± ÅŸarttÄ±r.</div>
                </div>
                <div class="form-section">
                    <div class="form-grid">
                        <div class="form-group"><label class="form-label">Personel AdÄ± SoyadÄ±</label><input type="text" id="ibra_personel" class="form-input"></div>
                        <div class="form-group"><label class="form-label">TC Kimlik No</label><input type="text" id="ibra_tc" class="form-input" maxlength="11"></div>
                        <div class="form-group"><label class="form-label">Åžube</label><select id="ibra_sube" class="form-select"></select></div>
                        <div class="form-group"><label class="form-label">Pozisyon</label><select id="ibra_pozisyon" class="form-select"></select></div>
                        <div class="form-group"><label class="form-label">Ä°ÅŸe GiriÅŸ Tarihi</label><input type="date" id="ibra_giris" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Ä°ÅŸten AyrÄ±lÄ±ÅŸ Tarihi</label><input type="date" id="ibra_cikis" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Ä°braname Tarihi</label><input type="date" id="ibra_tarih" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Toplam Ã–deme (TL)</label><input type="text" id="ibra_tutar" class="form-input" placeholder="Net Ã¶denen tutar"></div>
                        <div class="form-group"><label class="form-label">IBAN</label><input type="text" id="ibra_iban" class="form-input" placeholder="TR00 0000 0000 0000 0000 0000 00"></div>
                        <div class="form-group"><label class="form-label">Yetkili</label><input type="text" id="ibra_yetkili" class="form-input"></div>
                        <div class="form-group full">
                            <label class="form-label">Ã–deme Kalemleri</label>
                            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px">
                                <label style="display:flex;align-items:center;gap:8px;font-size:.85rem"><input type="checkbox" id="ibra_maas" checked> MaaÅŸ AlacaÄŸÄ±</label>
                                <label style="display:flex;align-items:center;gap:8px;font-size:.85rem"><input type="checkbox" id="ibra_kidem"> KÄ±dem TazminatÄ±</label>
                                <label style="display:flex;align-items:center;gap:8px;font-size:.85rem"><input type="checkbox" id="ibra_ihbar"> Ä°hbar TazminatÄ±</label>
                                <label style="display:flex;align-items:center;gap:8px;font-size:.85rem"><input type="checkbox" id="ibra_izin"> KullanÄ±lmayan YÄ±llÄ±k Ä°zin</label>
                                <label style="display:flex;align-items:center;gap:8px;font-size:.85rem"><input type="checkbox" id="ibra_fazla"> Fazla Mesai</label>
                                <label style="display:flex;align-items:center;gap:8px;font-size:.85rem"><input type="checkbox" id="ibra_diger"> DiÄŸer Alacaklar</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="generateIbraname()">ðŸ“„ Ä°braname OluÅŸtur</button>
                </div>
            </div>

            <!-- BorÃ§ Ä°krar -->
            <div class="page" id="page-borc">
                <div class="back-link" onclick="goTo('dashboard')">â† Ana Sayfa</div>
                <div class="page-header">
                    <div class="page-title">BorÃ§ Ä°krar Muvafakatnamesi</div>
                </div>
                <div class="alert alert-info"><span class="alert-icon">â„¹ï¸</span><div>TBK 407/2: Her olay iÃ§in ayrÄ± muvafakatname gerekir.</div></div>
                <div class="form-section">
                    <div class="form-grid">
                        <div class="form-group"><label class="form-label">Personel</label><input type="text" id="borc_personel" class="form-input"></div>
                        <div class="form-group"><label class="form-label">TC</label><input type="text" id="borc_tc" class="form-input" maxlength="11"></div>
                        <div class="form-group"><label class="form-label">Åžube</label><select id="borc_sube" class="form-select"></select></div>
                        <div class="form-group"><label class="form-label">BorÃ§ TÃ¼rÃ¼</label><select id="borc_tur" class="form-select"><option value="kasa">Kasa AÃ§Ä±ÄŸÄ±</option><option value="zimmet">Zimmet HasarÄ±</option><option value="stok">Stok KaybÄ±</option></select></div>
                        <div class="form-group"><label class="form-label">Tutar (TL)</label><input type="text" id="borc_tutar" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Olay Tarihi</label><input type="date" id="borc_tarih" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Ã–deme</label><select id="borc_odeme" class="form-select"><option value="tek">Tek Seferde</option><option value="taksit">Taksitle</option></select></div>
                        <div class="form-group"><label class="form-label">DÃ¼zenleme Tarihi</label><input type="date" id="borc_duz_tarih" class="form-input"></div>
                        <div class="form-group full"><label class="form-label">AÃ§Ä±klama</label><textarea id="borc_aciklama" class="form-textarea"></textarea></div>
                        <div class="form-group"><label class="form-label">Åžahit</label><input type="text" id="borc_sahit" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Yetkili</label><input type="text" id="borc_yetkili" class="form-input"></div>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="generateBorc()">ðŸ“„ Muvafakatname OluÅŸtur</button>
                </div>
            </div>

            <!-- Avans Talebi -->
            <div class="page" id="page-avans">
                <div class="back-link" onclick="goTo('dashboard')">â† Ana Sayfa</div>
                <div class="page-header">
                    <div class="page-title">Avans Talebi Formu</div>
                </div>
                <div class="alert alert-info"><span class="alert-icon">â„¹ï¸</span><div>Personel avans talebini bu form ile iletir. Ä°ÅŸveren onayÄ± ile Ã¶deme yapÄ±lÄ±r.</div></div>
                <div class="form-section">
                    <div class="form-grid">
                        <div class="form-group"><label class="form-label">Personel AdÄ± SoyadÄ±</label><input type="text" id="avans_personel" class="form-input"></div>
                        <div class="form-group"><label class="form-label">TC Kimlik No</label><input type="text" id="avans_tc" class="form-input" maxlength="11"></div>
                        <div class="form-group"><label class="form-label">Åžube</label><select id="avans_sube" class="form-select"></select></div>
                        <div class="form-group"><label class="form-label">Pozisyon</label><select id="avans_pozisyon" class="form-select"></select></div>
                        <div class="form-group"><label class="form-label">IBAN</label><input type="text" id="avans_iban" class="form-input" placeholder="TR00 0000 0000 0000 0000 0000 00"></div>
                        <div class="form-group"><label class="form-label">Talep Edilen Tutar (TL)</label><input type="text" id="avans_tutar" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Talep Tarihi</label><input type="date" id="avans_tarih" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Geri Ã–deme Åžekli</label><input type="text" id="avans_odeme" class="form-input" value="Gelecek ay maaÅŸÄ±ndan tek seferde kesilecektir" readonly style="background:#f5f5f5"></div>
                        <div class="form-group full"><label class="form-label">Avans Talebi GerekÃ§esi</label><textarea id="avans_gerekce" class="form-textarea" placeholder="Avans talebinizin nedenini kÄ±saca aÃ§Ä±klayÄ±nÄ±z..."></textarea></div>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="generateAvans()">ðŸ“„ Avans Talebi OluÅŸtur</button>
                </div>
            </div>

            <!-- Zimmet Formu -->
            <div class="page" id="page-zimmet">
                <div class="back-link" onclick="goTo('dashboard')">â† Ana Sayfa</div>
                <div class="page-header">
                    <div class="page-title">Zimmet (DemirbaÅŸ Teslim) Formu</div>
                </div>
                <div class="alert alert-info"><span class="alert-icon">â„¹ï¸</span><div>TBK Md. 390 ve 462: Ä°ÅŸÃ§i, iÅŸverenin mallarÄ±nÄ± Ã¶zenle korumakla yÃ¼kÃ¼mlÃ¼dÃ¼r. Zimmet tutanaÄŸÄ± ile teslim edilen eÅŸyalar iÃ§in personel mali sorumluluk taÅŸÄ±r.</div></div>
                <div class="form-section">
                    <div class="form-section-title" style="display:flex;align-items:center;gap:8px"><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg> Personel Bilgileri</div>
                    <div class="form-grid">
                        <div class="form-group"><label class="form-label">Personel AdÄ± SoyadÄ±</label><input type="text" id="zimmet_personel" class="form-input"></div>
                        <div class="form-group"><label class="form-label">TC Kimlik No</label><input type="text" id="zimmet_tc" class="form-input" maxlength="11"></div>
                        <div class="form-group"><label class="form-label">Åžube</label><select id="zimmet_sube" class="form-select"></select></div>
                        <div class="form-group"><label class="form-label">Pozisyon</label><select id="zimmet_pozisyon" class="form-select"></select></div>
                        <div class="form-group"><label class="form-label">Teslim Tarihi</label><input type="date" id="zimmet_tarih" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Ä°ÅŸlem TÃ¼rÃ¼</label><select id="zimmet_islem" class="form-select"><option value="teslim">Teslim (Zimmet)</option><option value="iade">Ä°ade</option></select></div>
                    </div>
                </div>
                <div class="form-section">
                    <div class="form-section-title">ðŸ“¦ Zimmet Edilecek EÅŸyalar</div>
                    <div id="zimmetListesi"></div>
                    <button class="btn btn-ghost" onclick="zimmetEkle()" style="margin-top:10px">+ EÅŸya Ekle</button>
                </div>
                <div class="form-section">
                    <div class="form-group full"><label class="form-label">Ek Notlar / Ã–zel KoÅŸullar</label><textarea id="zimmet_notlar" class="form-textarea" placeholder="Varsa Ã¶zel kullanÄ±m koÅŸullarÄ±, kÄ±sÄ±tlamalar..."></textarea></div>
                    <div class="form-group"><label class="form-label">Teslim Eden Yetkili</label><input type="text" id="zimmet_yetkili" class="form-input"></div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="generateZimmet()">ðŸ“„ Zimmet Formu OluÅŸtur</button>
                </div>
            </div>

            <!-- G13: MÃ¼dÃ¼r NotlarÄ± SayfasÄ± -->
            <div class="page" id="page-notlar">
                <div class="back-link" onclick="goTo('dashboard')">â† Ana Sayfa</div>
                <div class="page-header">
                    <div class="page-title">ðŸ“ MÃ¼dÃ¼r NotlarÄ±</div>
                    <div class="page-subtitle">Åžube notlarÄ± ve hatÄ±rlatmalar</div>
                </div>
                
                <!-- Not Ekleme Formu -->
                <div class="admin-card" style="margin-bottom:20px">
                    <div class="admin-card-header">
                        <div class="admin-card-title">+ Yeni Not Ekle</div>
                    </div>
                    <div style="display:grid;grid-template-columns:200px 1fr auto;gap:12px;align-items:end">
                        <div class="form-group" style="margin:0">
                            <label class="form-label">Åžube</label>
                            <select id="notlarSube" class="form-select"></select>
                        </div>
                        <div class="form-group" style="margin:0">
                            <label class="form-label">Not</label>
                            <input type="text" id="notlarText" class="form-input" placeholder="Not iÃ§eriÄŸi...">
                        </div>
                        <button class="btn btn-primary" onclick="addManagerNote()">Ekle</button>
                    </div>
                </div>
                
                <!-- Notlar Listesi -->
                <div id="notlarContainer">
                    <p style="text-align:center;color:var(--tx2);padding:40px">Notlar yÃ¼kleniyor...</p>
                </div>
            </div>

            <!-- Katalog -->
            <div class="page" id="page-katalog">
                <div class="back-link" onclick="goTo('dashboard')">â† Ana Sayfa</div>
                <div class="page-header">
                    <div class="page-title">Ä°hlal KataloÄŸu</div>
                </div>
                <div class="tabs" id="katalogTabs">
                    <button class="tab active" onclick="filterKatalog('all',this)">TÃ¼mÃ¼</button>
                    <button class="tab" onclick="filterKatalog('low',this)">DÃ¼ÅŸÃ¼k</button>
                    <button class="tab" onclick="filterKatalog('medium',this)">Orta</button>
                    <button class="tab" onclick="filterKatalog('high',this)">YÃ¼ksek</button>
                </div>
                <div class="violation-list" id="violationList"></div>
            </div>

            <!-- Personel Listesi -->
            <div class="page" id="page-personel">
                <div class="back-link" onclick="goTo('dashboard')">â† Ana Sayfa</div>
                <div class="page-header">
                    <div class="page-title" style="display:flex;align-items:center;gap:10px">
                        <div style="width:36px;height:36px;background:linear-gradient(135deg,#ff8674,#ff6b5b);border-radius:8px;display:flex;align-items:center;justify-content:center">
                            <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
                        </div>
                        Personel Listesi
                    </div>
                    <div class="page-subtitle">TÃ¼m personeli gÃ¶rÃ¼ntÃ¼le ve yÃ¶net</div>
                </div>
                <div class="form-section">
                    <div class="form-section-title" style="justify-content:space-between">
                        <span style="display:flex;align-items:center;gap:8px">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
                            KayÄ±tlÄ± Personel
                        </span>
                        <button id="btnNewPersonel" class="btn btn-primary btn-sm" onclick="showAddPersonelModal()">+ Yeni Personel</button>
                    </div>
                    <div class="form-group">
                        <input type="text" id="personelSearch" class="form-input" placeholder="Ä°sim, TC veya ÅŸube ara..." oninput="filterPersonel()">
                    </div>
                    <div id="personelListContainer" style="margin-top:16px">
                        <p style="color:var(--tx2);text-align:center;padding:40px">HenÃ¼z personel kaydÄ± yok. "Yeni Personel" butonuna tÄ±klayarak ekleyin.</p>
                    </div>
                </div>
            </div>

            <!-- Shift PlanÄ± -->
            <div class="page" id="page-shift">
                <div class="back-link" onclick="goTo('dashboard')">â† Ana Sayfa</div>
                <div class="page-header">
                    <div class="page-title" style="display:flex;align-items:center;gap:10px">
                        <div style="width:36px;height:36px;background:linear-gradient(135deg,#008c95,#00a8a8);border-radius:8px;display:flex;align-items:center;justify-content:center">
                            <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                        </div>
                        Shift PlanÄ±
                    </div>
                    <div class="page-subtitle">HaftalÄ±k vardiya planlamasÄ±</div>
                </div>
                <div class="form-section">
                    <div class="form-section-title" style="display:flex;align-items:center;gap:8px">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>
                        MaÄŸaza ve DÃ¶nem SeÃ§imi
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">MaÄŸaza</label>
                            <select id="shiftSube" class="form-select" onchange="loadShiftList()"></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Hafta</label>
                            <select id="shiftHafta" class="form-select" onchange="loadShiftWeek()">
                                <option value="">-- Ã–nce MaÄŸaza SeÃ§in --</option>
                            </select>
                        </div>
                    </div>
                    <!-- Aksiyon ButonlarÄ± - Modern Minimalist -->
                    <div id="shiftActionButtons" style="display:flex;gap:8px;margin-top:16px;flex-wrap:wrap">
                        <button id="btnCreateShiftWeek" class="btn" onclick="showNewShiftModal()" style="padding:10px 16px;background:var(--accent);color:#fff;border:none;border-radius:8px;display:flex;align-items:center;gap:6px;font-size:.85rem;font-weight:500;cursor:pointer">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
                            Yeni Hafta
                        </button>
                        <button class="btn" onclick="printShift()" style="padding:10px 16px;background:var(--bg3);color:var(--tx);border:1px solid var(--bg4);border-radius:8px;display:flex;align-items:center;gap:6px;font-size:.85rem;font-weight:500;cursor:pointer">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
                            YazdÄ±r
                        </button>
                        <button class="btn" onclick="downloadShiftPDF()" style="padding:10px 16px;background:#ff8674;color:#fff;border:none;border-radius:8px;display:flex;align-items:center;gap:6px;font-size:.85rem;font-weight:500;cursor:pointer">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
                            PDF Ä°ndir
                        </button>
                        <button id="deleteShiftBtn" class="btn" onclick="deleteCurrentShift()" style="padding:10px 16px;background:#fff0f0;color:#dc3545;border:1px solid #ffcdd2;border-radius:8px;display:flex;align-items:center;gap:6px;font-size:.85rem;font-weight:500;cursor:pointer" title="Bu HaftayÄ± Sil">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                            Sil
                        </button>
                    </div>
                </div>
                
                <!-- Shift Tablosu -->
                <div class="form-section">
                    <div class="form-section-title" style="display:flex;align-items:center;gap:8px">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                        Shift Tablosu
                    </div>
                    <div id="shiftTableContainer">
                        <p style="color:var(--tx2);text-align:center;padding:40px">â¬†ï¸ YukarÄ±dan maÄŸaza ve hafta seÃ§erek shift planÄ±nÄ± gÃ¶rÃ¼ntÃ¼leyin.</p>
                    </div>
                </div>
                
                <!-- GeÃ§miÅŸ Shiftler -->
                <div class="form-section">
                    <div class="form-section-title" style="display:flex;align-items:center;gap:8px">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        GeÃ§miÅŸ Shiftler
                    </div>
                    <div id="shiftHistoryContainer">
                        <p style="color:var(--tx2);text-align:center;padding:20px">MaÄŸaza seÃ§erek geÃ§miÅŸ shiftleri gÃ¶rÃ¼ntÃ¼leyin.</p>
                    </div>
                </div>
            </div>

            <!-- Checklist -->
            <div class="page" id="page-checklist">
                <div class="back-link" onclick="goTo('dashboard')">â† Ana Sayfa</div>
                <div class="page-header">
                    <div class="page-title" style="display:flex;align-items:center;gap:10px">
                        <div style="width:36px;height:36px;background:linear-gradient(135deg,#00c9a7,#008c95);border-radius:8px;display:flex;align-items:center;justify-content:center">
                            <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
                        </div>
                        Checklist
                    </div>
                    <div class="page-subtitle">GÃ¼nlÃ¼k kontrol listeleri</div>
                </div>
                
                <!-- Åžube ve TÃ¼r SeÃ§imi -->
                <div class="form-section" style="margin-bottom:20px">
                    <div style="display:flex;flex-wrap:wrap;gap:16px;align-items:flex-start">
                        <div class="form-group" style="margin-bottom:0;min-width:160px">
                            <label class="form-label">Åžube</label>
                            <select id="checklistSube" class="form-select" onchange="loadChecklistTypes()"></select>
                        </div>
                        <div class="form-group" style="margin-bottom:0;min-width:140px">
                            <label class="form-label">Tarih</label>
                            <input type="date" id="checklistDate" class="form-input" disabled readonly style="background:var(--bg3);cursor:not-allowed;opacity:0.7" title="Checklist sadece bugÃ¼n iÃ§in yapÄ±labilir">
                        </div>
                        <div class="form-group" style="margin-bottom:0;min-width:120px;display:none" id="checklistTimeSlotGroup">
                            <label class="form-label">Saat Dilimi</label>
                            <select id="checklistTimeSlot" class="form-select" onchange="loadChecklist()">
                                <option value="">-- SeÃ§in --</option>
                            </select>
                        </div>
                    </div>
                    <!-- Checklist TÃ¼rÃ¼ - Yan Yana Butonlar -->
                    <div style="margin-top:16px">
                        <label class="form-label" style="margin-bottom:10px">Checklist TÃ¼rÃ¼</label>
                        <div id="checklistTypeButtons" style="display:flex;flex-wrap:wrap;gap:8px">
                            <div style="color:var(--tx3);font-size:.9rem;padding:10px">Ã–nce ÅŸube seÃ§in</div>
                        </div>
                    </div>
                    <!-- Hidden select for compatibility -->
                    <select id="checklistType" style="display:none" onchange="loadChecklist()">
                        <option value="">-- SeÃ§in --</option>
                    </select>
                </div>
                
                <!-- Checklist Formu -->
                <div id="checklistFormContainer">
                    <div style="text-align:center;padding:60px;color:var(--tx2)">
                        <div style="font-size:4rem;margin-bottom:16px">ðŸ“‹</div>
                        <div style="font-size:1.1rem;margin-bottom:8px">Checklist SeÃ§in</div>
                        <div style="font-size:.9rem">YukarÄ±dan ÅŸube ve checklist tÃ¼rÃ¼ seÃ§erek baÅŸlayÄ±n</div>
                    </div>
                </div>
            </div>

            <!-- Puantaj -->
            <div class="page" id="page-puantaj">
                <div class="back-link" onclick="goTo('dashboard')">â† Ana Sayfa</div>
                <div class="page-header">
                    <div class="page-title" style="display:flex;align-items:center;gap:10px">
                        <div style="width:36px;height:36px;background:linear-gradient(135deg,#f093fb,#f5576c);border-radius:8px;display:flex;align-items:center;justify-content:center">
                            <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                        </div>
                        Performans Sistemi
                    </div>
                    <div class="page-subtitle">Personel performans ve olay takibi</div>
                </div>
                
                <!-- Sekmeler -->
                <div style="display:flex;gap:8px;margin-bottom:20px;border-bottom:1px solid var(--cardBorder);padding-bottom:12px;flex-wrap:wrap">
                    <button class="puantaj-tab active" onclick="showPuantajTab('kayit', this)" style="padding:10px 20px;border:none;background:linear-gradient(135deg,var(--accent),#ff6b5b);color:#fff;border-radius:8px;cursor:pointer;font-weight:600;transition:all .2s;box-shadow:0 2px 12px rgba(255,134,116,.3);display:flex;align-items:center;gap:6px">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                        KayÄ±t
                    </button>
                    <button class="puantaj-tab" onclick="showPuantajTab('analiz', this)" style="padding:10px 20px;border:none;background:var(--bg3);color:var(--tx);border-radius:8px;cursor:pointer;font-weight:600;transition:all .2s;display:flex;align-items:center;gap:6px">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
                        Analiz
                    </button>
                    <button class="puantaj-tab" onclick="showPuantajTab('arsiv', this)" style="padding:10px 20px;border:none;background:var(--bg3);color:var(--tx);border-radius:8px;cursor:pointer;font-weight:600;transition:all .2s;display:flex;align-items:center;gap:6px">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 8v13H3V8M1 3h22v5H1zM10 12h4"/></svg>
                        ArÅŸiv
                    </button>
                    <button class="puantaj-tab" id="checklistlerTabBtn" onclick="showPuantajTab('checklistler', this)" style="padding:10px 20px;border:none;background:var(--bg3);color:var(--tx);border-radius:8px;cursor:pointer;font-weight:600;transition:all .2s;display:none;align-items:center;gap:6px">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
                        Checklistler
                    </button>
                </div>
                
                <!-- KAYIT SEKMESÄ° -->
                <div id="puantajKayitTab">
                    <div class="form-section" style="padding:12px 16px">
                        <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
                            <div style="display:flex;align-items:center;gap:6px">
                                <svg width="14" height="14" fill="none" stroke="var(--tx2)" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                <span style="font-size:.8rem;color:var(--tx2);font-weight:600">DÃ¶nem:</span>
                            </div>
                            <select id="puantajAy" class="form-select" style="width:auto;min-width:90px;padding:6px 10px;font-size:.85rem" onchange="loadPuantaj()">
                                <option value="01">Ocak</option>
                                <option value="02">Åžubat</option>
                                <option value="03">Mart</option>
                                <option value="04">Nisan</option>
                                <option value="05">MayÄ±s</option>
                                <option value="06">Haziran</option>
                                <option value="07">Temmuz</option>
                                <option value="08">AÄŸustos</option>
                                <option value="09">EylÃ¼l</option>
                                <option value="10">Ekim</option>
                                <option value="11">KasÄ±m</option>
                                <option value="12">AralÄ±k</option>
                            </select>
                            <select id="puantajYil" class="form-select" style="width:auto;min-width:80px;padding:6px 10px;font-size:.85rem" onchange="loadPuantaj()">
                                <option value="2027">2027</option>
                                <option value="2026">2026</option>
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                            </select>
                            <div style="width:1px;height:20px;background:var(--bg4)"></div>
                            <select id="puantajSube" class="form-select" style="width:auto;min-width:120px;padding:6px 10px;font-size:.85rem" onchange="loadPuantaj()"></select>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="form-section-title" style="justify-content:space-between">
                            <div style="display:flex;align-items:center;gap:8px">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
                                <span>Ekip Durumu</span>
                            </div>
                        </div>
                        <div id="puantajTableContainer">
                            <p style="color:var(--tx2);text-align:center;padding:40px">YÃ¼kleniyor...</p>
                        </div>
                    </div>
                </div>
                
                <!-- ANALÄ°Z SEKMESÄ° -->
                <div id="puantajAnalizTab" style="display:none">
                    <div class="form-section">
                        <div class="form-section-title" style="display:flex;align-items:center;gap:8px">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
                            Performans Analizi
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">DÃ¶nem</label>
                                <select id="analizDonem" class="form-select" onchange="loadPuantajAnaliz()">
                                    <option value="current">Bu Ay</option>
                                    <option value="all">TÃ¼m Zamanlar</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Åžube</label>
                                <select id="analizSube" class="form-select" onchange="loadPuantajAnaliz()"></select>
                            </div>
                        </div>
                    </div>
                    <div id="puantajAnalizContainer">
                        <p style="color:var(--tx2);text-align:center;padding:40px">Analiz yÃ¼kleniyor...</p>
                    </div>
                </div>
                
                <!-- ARÅžÄ°V SEKMESÄ° -->
                <div id="puantajArsivTab" style="display:none">
                    <div class="form-section">
                        <div class="form-section-title" style="display:flex;align-items:center;gap:8px">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 8v13H3V8M1 3h22v5H1zM10 12h4"/></svg>
                            GeÃ§miÅŸ DÃ¶nemler
                        </div>
                        <div class="form-grid" style="grid-template-columns:repeat(auto-fit,minmax(150px,1fr))">
                            <div class="form-group">
                                <label class="form-label">Åžube</label>
                                <select id="arsivSube" class="form-select" onchange="loadPuantajArsiv()"></select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">YÄ±l</label>
                                <select id="arsivYil" class="form-select" onchange="loadPuantajArsiv()">
                                    <option value="2026">2026</option>
                                    <option value="2025">2025</option>
                                    <option value="2024">2024</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ã–zet Ä°statistikler -->
                    <div id="arsivSummary" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:20px">
                        <!-- Dinamik doldurulacak -->
                    </div>
                    
                    <!-- Grafikler -->
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;margin-bottom:20px">
                        <!-- AylÄ±k Trend -->
                        <div style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:16px">
                            <div style="font-weight:600;margin-bottom:16px;font-size:.9rem;color:var(--tx)">AylÄ±k Puan Trendi</div>
                            <div id="arsivTrendChart" style="height:200px;position:relative">
                                <!-- Chart SVG -->
                            </div>
                        </div>
                        
                        <!-- DaÄŸÄ±lÄ±m Pasta -->
                        <div style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:16px">
                            <div style="font-weight:600;margin-bottom:16px;font-size:.9rem;color:var(--tx)">Puan DaÄŸÄ±lÄ±mÄ±</div>
                            <div id="arsivPieChart" style="height:200px;display:flex;align-items:center;justify-content:center">
                                <!-- Pie Chart SVG -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- AylÄ±k DÃ¶nem KartlarÄ± -->
                    <div id="puantajArsivContainer" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px">
                        <p style="color:var(--tx2);text-align:center;padding:40px;grid-column:1/-1">ArÅŸiv yÃ¼kleniyor...</p>
                    </div>
                    
                    <!-- Detay Modal AlanÄ± -->
                    <div id="arsivDetailPanel" style="display:none;margin-top:20px;background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:20px">
                        <!-- Dinamik detay iÃ§eriÄŸi -->
                    </div>
                </div>
                
                <!-- CHECKLISTLER SEKMESÄ° (Sadece YÃ¶neticiler) -->
                <div id="puantajChecklistlerTab" style="display:none">
                    <div class="form-section">
                        <div class="form-section-title" style="display:flex;align-items:center;gap:8px">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
                            Doldurulan Checklistler
                        </div>
                        <div class="form-grid" style="grid-template-columns:repeat(auto-fit,minmax(150px,1fr))">
                            <div class="form-group">
                                <label class="form-label">Tarih</label>
                                <input type="date" id="checklistlerTarih" class="form-input" onchange="loadFilledChecklists()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Åžube</label>
                                <select id="checklistlerSube" class="form-select" onchange="loadFilledChecklists()">
                                    <option value="all">TÃ¼m Åžubeler</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">TÃ¼r</label>
                                <select id="checklistlerTur" class="form-select" onchange="loadFilledChecklists()">
                                    <option value="all">TÃ¼mÃ¼</option>
                                    <option value="acilis">AÃ§Ä±lÄ±ÅŸ</option>
                                    <option value="kapanis">KapanÄ±ÅŸ</option>
                                    <option value="gunluk">GÃ¼nlÃ¼k</option>
                                    <option value="mudur">MÃ¼dÃ¼r</option>
                                    <option value="platform">Platform</option>
                                    <option value="aylik">Temizlik</option>
                                    <option value="haftalik">HaftalÄ±k</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ã–zet KartlarÄ± -->
                    <div id="checklistlerSummary" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:20px">
                        <!-- Dinamik doldurulacak -->
                    </div>
                    
                    <!-- Checklist Listesi -->
                    <div id="checklistlerContainer" style="display:grid;gap:12px">
                        <p style="color:var(--tx2);text-align:center;padding:40px">Tarih seÃ§in...</p>
                    </div>
                </div>
            </div>

            <!-- Prim Sistemi SayfasÄ± -->
            <div class="page" id="page-primSistemi">
                <div class="back-link" onclick="goTo('dashboard')">â† Ana Sayfa</div>
                <div class="page-header">
                    <div class="page-title" style="display:flex;align-items:center;gap:10px">
                        <div style="width:36px;height:36px;background:linear-gradient(135deg,#27ae60,#2ecc71);border-radius:8px;display:flex;align-items:center;justify-content:center">
                            <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
                        </div>
                        Prim Sistemi
                    </div>
                    <div class="page-subtitle">Prim kurallarÄ± ve motivasyon</div>
                </div>
                <div id="primSistemiContainer">
                    <p style="color:var(--tx2);text-align:center;padding:40px">YÃ¼kleniyor...</p>
                </div>
            </div>

            <!-- Preview -->
            <div class="page" id="page-preview">
                <div class="back-link" onclick="goBack()">â† Geri</div>
                <div class="preview-container">
                    <div class="preview-toolbar">
                        <div class="preview-title" id="previewTitle">Ã–nizleme</div>
                        <div class="preview-actions">
                            <button class="btn btn-sm btn-ghost" onclick="printDoc()">ðŸ–¨ï¸ YazdÄ±r</button>
                            <button class="btn btn-sm btn-primary" onclick="downloadPDF()">ðŸ“¥ PDF</button>
                        </div>
                    </div>
                    <div class="preview-content" id="previewContent"></div>
                </div>
            </div>

            <!-- Admin Panel -->
            <div class="page" id="page-admin">
                <div class="back-link" onclick="goTo('dashboard')">â† Ana Sayfa</div>
                <div class="page-header">
                    <div class="page-title">âš™ï¸ YÃ¶netim Paneli</div>
                    <div class="page-subtitle">Sistem ayarlarÄ±nÄ± yÃ¶netin</div>
                </div>
                <div class="admin-tabs" id="adminTabsContainer">
                    <button class="admin-tab active" id="tab-genel" onclick="showAdminTab('genel',this)">Genel</button>
                    <button class="admin-tab" id="tab-tumCheckler" onclick="showAdminTab('tumCheckler',this)">TÃ¼m Checkler</button>
                    <button class="admin-tab tab-hidden" id="tab-kullanicilar" onclick="showAdminTab('kullanicilar',this)">Pozisyonlar ve Yetkiler</button>
                    <button class="admin-tab tab-hidden" id="tab-oturumlar" onclick="showAdminTab('oturumlar',this)">Oturumlar & Aktiviteler</button>
                    <button class="admin-tab tab-hidden" id="tab-magazaSaatleri" onclick="showAdminTab('magazaSaatleri',this)">MaÄŸaza Saatleri</button>
                    <button class="admin-tab tab-hidden" id="tab-checkKurallari" onclick="showAdminTab('checkKurallari',this)">Check & Puantaj KurallarÄ±</button>
                    <button class="admin-tab tab-hidden" id="tab-checklistTurleri" onclick="showAdminTab('checklistTurleri',this)">Checklist TÃ¼rleri</button>
                    <button class="admin-tab tab-hidden" id="tab-subeler" onclick="showAdminTab('subeler',this)">Åžubeler</button>
                    <button class="admin-tab tab-hidden" id="tab-ihlaller" onclick="showAdminTab('ihlaller',this)">Ä°hlaller</button>
                    <button class="admin-tab tab-hidden" id="tab-sablonlar" onclick="showAdminTab('sablonlar',this)">SÃ¶zleÅŸme ÅžablonlarÄ±</button>
                    <button class="admin-tab tab-hidden" id="tab-belgeler" onclick="showAdminTab('belgeler',this)">Belge ÅžablonlarÄ±</button>
                    <button class="admin-tab tab-hidden" id="tab-yedekler" onclick="showAdminTab('yedekler',this)">Yedekler</button>
                </div>
                
                <!-- TÃ¼m Checkler Ã–zet -->
                <div class="admin-section" id="admin-tumCheckler">
                    <div class="admin-card">
                        <div class="admin-card-header">
                            <div class="admin-card-title" style="display:flex;align-items:center;gap:8px">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
                                BugÃ¼nkÃ¼ TÃ¼m Checkler
                            </div>
                            <div style="display:flex;gap:10px;align-items:center">
                                <select id="allChecksDateFilter" class="form-select" style="width:auto" onchange="loadAllChecksOverview()">
                                    <option value="today">BugÃ¼n</option>
                                    <option value="yesterday">DÃ¼n</option>
                                    <option value="week">Bu Hafta</option>
                                </select>
                                <select id="allChecksBranchFilter" class="form-select" style="width:auto" onchange="loadAllChecksOverview()">
                                    <option value="all">TÃ¼m Åžubeler</option>
                                </select>
                                <button class="btn btn-sm btn-ghost" onclick="loadAllChecksOverview()" title="Yenile">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
                                </button>
                            </div>
                        </div>
                        
                        <div id="allChecksOverviewContainer">
                            <div style="text-align:center;padding:40px;color:var(--tx2)">YÃ¼kleniyor...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Genel -->
                <div class="admin-section active" id="admin-genel">
                    <!-- PROFÄ°LÄ°M - TÃ¼m kullanÄ±cÄ±lar gÃ¶recek -->
                    <div class="admin-card" id="myProfileCard" style="margin-bottom:20px">
                        <div class="admin-card-header">
                            <div class="admin-card-title" style="display:flex;align-items:center;gap:8px">
                                <svg width="18" height="18" fill="none" stroke="#008c95" stroke-width="2" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                Profilim
                            </div>
                        </div>
                        <div id="myProfileContainer">
                            <div style="text-align:center;padding:20px;color:var(--tx2)">YÃ¼kleniyor...</div>
                        </div>
                    </div>
                    
                    <div class="admin-card" id="companySettingsCard">
                        <div class="admin-card-header"><div class="admin-card-title">Åžirket Bilgileri</div></div>
                        <div class="form-grid">
                            <div class="form-group full"><label class="form-label">Åžirket AdÄ±</label><input type="text" id="admin_company_name" class="form-input"></div>
                            <div class="form-group"><label class="form-label">MERSÄ°S No</label><input type="text" id="admin_mersis" class="form-input"></div>
                            <div class="form-group full"><label class="form-label">Adres</label><input type="text" id="admin_address" class="form-input"></div>
                        </div>
                        <div class="btn-group"><button class="btn btn-primary btn-sm" onclick="saveCompany()">Kaydet</button></div>
                    </div>
                    <!-- Admin Åžifre DeÄŸiÅŸtirme - Sadece admin gÃ¶recek -->
                    <div class="admin-card" id="adminPasswordCard" style="margin-top:20px;display:none">
                        <div class="admin-card-header"><div class="admin-card-title">ðŸ” YÃ¶netici GiriÅŸ Bilgileri</div></div>
                        <p style="color:var(--tx2);font-size:.85rem;margin-bottom:16px">YÃ¶netici hesabÄ±nÄ±n kullanÄ±cÄ± adÄ± ve ÅŸifresini deÄŸiÅŸtirin.</p>
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Yeni KullanÄ±cÄ± AdÄ±</label><input type="text" id="admin_new_username" class="form-input" placeholder="Mevcut: admin"></div>
                            <div class="form-group"><label class="form-label">Yeni Åžifre</label><input type="password" id="admin_new_password" class="form-input" placeholder="Yeni ÅŸifre girin"></div>
                            <div class="form-group"><label class="form-label">Åžifre Tekrar</label><input type="password" id="admin_confirm_password" class="form-input" placeholder="Åžifreyi tekrar girin"></div>
                        </div>
                        <div class="btn-group"><button class="btn btn-primary btn-sm" onclick="updateAdminCredentials()">ðŸ”‘ GÃ¼ncelle</button></div>
                    </div>
                    <!-- Admin Email Listesi - Sadece admin gÃ¶recek -->
                    <div class="admin-card" id="adminEmailsCard" style="margin-top:20px;display:none">
                        <div class="admin-card-header"><div class="admin-card-title">ðŸ‘‘ YÃ¶netici E-posta Listesi</div></div>
                        <p style="color:var(--tx2);font-size:.85rem;margin-bottom:16px">Bu listedeki e-postalar personel kaydÄ± olmasa bile sisteme eriÅŸebilir.</p>
                        <div class="form-group">
                            <label class="form-label">Admin E-postalar (her satÄ±ra bir tane)</label>
                            <textarea id="adminEmailsList" class="form-input" rows="5" placeholder="admin@moonberrycoffee.com&#10;tamer@moonberrycoffee.com" style="font-family:monospace;font-size:.85rem"></textarea>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-ghost btn-sm" onclick="loadAdminEmailsToUI()">â†» Yenile</button>
                            <button class="btn btn-primary btn-sm" onclick="saveAdminEmailsFromUI()">ðŸ’¾ Kaydet</button>
                        </div>
                    </div>
                    <!-- Puan SÄ±fÄ±rlama - Sadece admin gÃ¶recek -->
                    <div class="admin-card" id="dataCleanupCard" style="margin-top:20px;display:none">
                        <div class="admin-card-header"><div class="admin-card-title">ðŸ”„ Puan YÃ¶netimi</div></div>
                        <p style="color:var(--tx2);font-size:.85rem;margin-bottom:16px">Personel puanlarÄ±nÄ± sÄ±fÄ±rlayÄ±n.</p>
                        
                        <div style="padding:16px;background:rgba(231,76,60,.05);border:1px solid rgba(231,76,60,.2);border-radius:10px">
                            <div style="font-weight:600;color:#e74c3c;margin-bottom:8px">âš ï¸ Dikkat</div>
                            <p style="color:var(--tx2);font-size:.8rem;margin-bottom:12px">Bu iÅŸlem tÃ¼m personelin puanlarÄ±nÄ± sÄ±fÄ±rlar. Checklist geÃ§miÅŸi korunur.</p>
                            <button class="btn btn-sm" style="background:#e74c3c;border-color:#e74c3c;color:#fff" onclick="resetAllPoints()">ðŸ—‘ï¸ TÃ¼m PuanlarÄ± SÄ±fÄ±rla</button>
                        </div>
                        <div id="cleanupResults" style="margin-top:12px;padding:12px;background:var(--bg3);border-radius:8px;display:none"></div>
                    </div>
                </div>

                <!-- MaÄŸaza Saatleri -->
                <div class="admin-section" id="admin-magazaSaatleri">
                    <div class="admin-card">
                        <div class="admin-card-header">
                            <div class="admin-card-title">ðŸ• MaÄŸaza Ã‡alÄ±ÅŸma Saatleri</div>
                            <button class="btn btn-sm btn-primary" onclick="saveBranchHours()">ðŸ’¾ Kaydet</button>
                        </div>
                        <p style="color:var(--tx2);font-size:.85rem;margin-bottom:20px">Her maÄŸazanÄ±n aÃ§Ä±lÄ±ÅŸ ve kapanÄ±ÅŸ saatlerini belirleyin. KapanÄ±ÅŸ saati shift hesaplamalarÄ±nda kullanÄ±lÄ±r.</p>
                        
                        <div id="branchHoursContainer" style="display:grid;gap:20px">
                            <!-- Dinamik olarak doldurulacak -->
                        </div>
                    </div>
                </div>

                <!-- Check KurallarÄ± - GeliÅŸmiÅŸ -->
                <div class="admin-section" id="admin-checkKurallari">
                    <div class="admin-card">
                        <div class="admin-card-header">
                            <div class="admin-card-title" style="display:flex;align-items:center;gap:8px">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/><path d="M9 14l2 2 4-4"/></svg>
                                Check Zamanlama & Puanlama Sistemi
                            </div>
                            <div style="display:flex;gap:8px">
                                <button class="btn btn-sm btn-ghost" onclick="loadCheckRulesFromFirebase()" style="display:flex;align-items:center;gap:4px">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                                    Yenile
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="saveAdvancedCheckRules()" style="display:flex;align-items:center;gap:4px">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                                    TÃ¼mÃ¼nÃ¼ Kaydet
                                </button>
                            </div>
                        </div>
                        
                        <!-- AÃ§Ä±klama -->
                        <div style="background:linear-gradient(135deg,rgba(0,140,149,.08),rgba(0,140,149,.02));border:1px solid rgba(0,140,149,.15);border-radius:12px;padding:16px;margin-bottom:24px">
                            <div style="display:flex;align-items:flex-start;gap:12px">
                                <div style="width:40px;height:40px;background:#008c95;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0">
                                    <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                                </div>
                                <div>
                                    <div style="font-weight:600;color:var(--tx);margin-bottom:4px">NasÄ±l Ã‡alÄ±ÅŸÄ±r?</div>
                                    <div style="font-size:.85rem;color:var(--tx2);line-height:1.5">
                                        Her check tÃ¼rÃ¼ iÃ§in <strong>aktif zaman pencereleri</strong> tanÄ±mlayabilirsiniz. Check'ler bu saatler arasÄ±nda yapÄ±labilir. 
                                        <strong>Vaktinde</strong> yapÄ±lan checkler + puan, <strong>geÃ§ penceresi</strong> iÃ§inde yapÄ±lanlar 0 veya eksi puan, 
                                        <strong>yapÄ±lmayan</strong> checkler tam eksi puan alÄ±r. <strong>Sorumlu vardiya</strong> shift planÄ±ndan otomatik atanÄ±r.
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Check TÃ¼rleri TablarÄ± -->
                        <div style="display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap" id="checkTypeTabs">
                            <!-- Dinamik olarak doldurulacak -->
                        </div>
                        
                        <!-- SeÃ§ili Check TÃ¼rÃ¼ DetaylarÄ± -->
                        <div id="checkRuleDetails" style="background:var(--bg2);border:1px solid var(--cardBorder);border-radius:16px;padding:24px">
                            <!-- Dinamik olarak doldurulacak -->
                        </div>
                    </div>
                    
                    <!-- Dashboard MesajlarÄ± -->
                    <div class="admin-card" style="margin-top:20px">
                        <div class="admin-card-header">
                            <div class="admin-card-title" style="display:flex;align-items:center;gap:8px">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                                Dashboard GÃ¶rev MesajlarÄ±
                            </div>
                        </div>
                        <p style="color:var(--tx2);font-size:.85rem;margin-bottom:16px">Personeli motive edecek ve gÃ¶revleri hatÄ±rlatacak mesajlar. Dashboard'da check kartlarÄ±nda gÃ¶rÃ¼nÃ¼r.</p>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                            <div class="form-group">
                                <label class="form-label">Aktif Check MesajÄ±</label>
                                <input type="text" class="form-input" id="dashboardMsgActive" placeholder="Ã¶rn: Åžimdi yapÄ±lmalÄ±! âš¡" value="YapÄ±lmasÄ± gereken gÃ¶rev var!">
                            </div>
                            <div class="form-group">
                                <label class="form-label">YaklaÅŸan Check MesajÄ±</label>
                                <input type="text" class="form-input" id="dashboardMsgUpcoming" placeholder="Ã¶rn: HazÄ±rlan, birazdan aktif!" value="Birazdan aktif olacak">
                            </div>
                            <div class="form-group">
                                <label class="form-label">TamamlanmÄ±ÅŸ Mesaj</label>
                                <input type="text" class="form-input" id="dashboardMsgCompleted" placeholder="Ã¶rn: Harika! âœ“" value="TamamlandÄ± âœ“">
                            </div>
                            <div class="form-group">
                                <label class="form-label">KaÃ§Ä±rÄ±lmÄ±ÅŸ Mesaj</label>
                                <input type="text" class="form-input" id="dashboardMsgMissed" placeholder="Ã¶rn: Maalesef kaÃ§Ä±rÄ±ldÄ±" value="KaÃ§Ä±rÄ±ldÄ±">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Puantaj DeÄŸerlendirme KurallarÄ± (YÄ±ldÄ±z Sistemi) -->
                    <div class="admin-card" style="margin-top:20px">
                        <div class="admin-card-header">
                            <div class="admin-card-title" style="display:flex;align-items:center;gap:8px">
                                <svg width="16" height="16" fill="none" stroke="#DAA520" stroke-width="2" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                                Puantaj DeÄŸerlendirme KurallarÄ±
                            </div>
                        </div>
                        <p style="color:var(--tx2);font-size:.85rem;margin-bottom:16px">YÃ¶netici deÄŸerlendirmelerinde kullanÄ±lan yÄ±ldÄ±z-puan karÅŸÄ±lÄ±klarÄ±nÄ± ayarlayÄ±n.</p>
                        <div class="admin-list" id="puantajRulesList">
                            <p style="color:var(--tx2);text-align:center;padding:20px">Kurallar yÃ¼kleniyor...</p>
                        </div>
                    </div>
                </div>

                <!-- Checklist TÃ¼rleri YÃ¶netimi -->
                <div class="admin-section" id="admin-checklistTurleri">
                    <div class="admin-card">
                        <div class="admin-card-header">
                            <div class="admin-card-title" style="display:flex;align-items:center;gap:8px">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/><path d="M9 14l2 2 4-4"/></svg>
                                Checklist TÃ¼rleri YÃ¶netimi
                            </div>
                            <div style="display:flex;gap:8px">
                                <button class="btn btn-sm btn-ghost" onclick="loadChecklistTypesConfig()" style="display:flex;align-items:center;gap:4px">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                                    Yenile
                                </button>
                                <button class="btn btn-sm btn-ghost" onclick="syncChecklistTypesWithSeed()" style="display:flex;align-items:center;gap:4px;color:#f39c12">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>
                                    Orijinale SÄ±fÄ±rla
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="saveChecklistTypesConfig()" style="display:flex;align-items:center;gap:4px">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                                    Kaydet
                                </button>
                            </div>
                        </div>
                        
                        <div style="background:linear-gradient(135deg,rgba(0,140,149,.08),rgba(0,140,149,.02));border:1px solid rgba(0,140,149,.15);border-radius:12px;padding:16px;margin-bottom:24px">
                            <div style="font-size:.85rem;color:var(--tx2);line-height:1.5">
                                Her ÅŸube iÃ§in checklist tÃ¼rlerini dÃ¼zenleyebilirsiniz. TÃ¼rlerin <strong>isimlerini</strong>, <strong>ikonlarÄ±nÄ±</strong> ve <strong>sÄ±ralamalarÄ±nÄ±</strong> deÄŸiÅŸtirebilirsiniz. 
                                Bu deÄŸiÅŸiklikler dashboard ve checklist sayfalarÄ±nda gÃ¶rÃ¼nÃ¼r.
                            </div>
                        </div>
                        
                        <!-- Åžube SeÃ§imi - Dinamik -->
                        <div id="checklistTypeBranchTabs" style="display:flex;gap:12px;margin-bottom:20px">
                            <!-- JavaScript ile STATE.branches'dan doldurulacak -->
                        </div>
                        
                        <!-- Checklist TÃ¼rleri Listesi -->
                        <div id="checklistTypesContainer" style="display:grid;gap:12px">
                            <!-- Dinamik olarak doldurulacak -->
                        </div>
                        
                        <!-- Yeni TÃ¼r Ekleme -->
                        <div style="margin-top:20px;padding-top:20px;border-top:1px solid var(--bg4)">
                            <div style="font-weight:600;color:var(--tx);margin-bottom:12px">Yeni Checklist TÃ¼rÃ¼ Ekle</div>
                            <div style="display:grid;grid-template-columns:1fr 150px 120px auto;gap:12px;align-items:end">
                                <div class="form-group" style="margin:0">
                                    <label class="form-label">TÃ¼r AdÄ±</label>
                                    <input type="text" class="form-input" id="newChecklistTypeName" placeholder="Ã¶rn: HaftalÄ±k GÃ¶revler">
                                </div>
                                <div class="form-group" style="margin:0">
                                    <label class="form-label">TÃ¼r ID</label>
                                    <input type="text" class="form-input" id="newChecklistTypeId" placeholder="Ã¶rn: haftalik">
                                </div>
                                <div class="form-group" style="margin:0">
                                    <label class="form-label">Ä°kon</label>
                                    <select class="form-select" id="newChecklistTypeIcon">
                                        <option value="clipboard-check">ðŸ“‹ Checklist</option>
                                        <option value="sunrise">ðŸŒ… AÃ§Ä±lÄ±ÅŸ</option>
                                        <option value="sunset">ðŸŒ† KapanÄ±ÅŸ</option>
                                        <option value="smartphone">ðŸ“± Platform</option>
                                        <option value="user-check">ðŸ‘¤ MÃ¼dÃ¼r</option>
                                        <option value="calendar">ðŸ“† Takvim</option>
                                        <option value="calendar-week">ðŸ“… HaftalÄ±k</option>
                                        <option value="sparkle">âœ¨ Temizlik</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary" onclick="addNewChecklistType()" style="height:42px">Ekle</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pozisyonlar ve Yetkiler (BirleÅŸik) -->
                <div class="admin-section" id="admin-kullanicilar">
                    <!-- BÃ–LÃœM 1: Pozisyon YÃ¶netimi - Kompakt -->
                    <div class="admin-card" style="margin-bottom:16px;padding:16px">
                        <div class="admin-card-header" style="margin-bottom:12px">
                            <div class="admin-card-title" style="display:flex;align-items:center;gap:8px;font-size:.95rem">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
                                Pozisyonlar
                            </div>
                            <button class="btn btn-sm btn-primary" onclick="addPosition()" style="padding:6px 12px;font-size:.8rem">+ Yeni</button>
                        </div>
                        <div id="positionListCombined" class="admin-list" style="display:flex;flex-wrap:wrap;gap:8px"></div>
                    </div>
                    
                    <!-- BÃ–LÃœM 2: Yetki Matrisi -->
                    <div class="admin-card" style="padding:16px">
                        <div class="admin-card-header" style="margin-bottom:12px">
                            <div class="admin-card-title" style="font-size:.95rem">ðŸ” Pozisyon Yetkileri</div>
                            <button class="btn btn-primary" onclick="saveMatrixPermissions()" style="padding:6px 12px;font-size:.8rem">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                                Kaydet
                            </button>
                        </div>
                        <p style="color:var(--tx2);font-size:.78rem;margin-bottom:12px">
                            G=GÃ¶rme, D=DÃ¼zenleme. YÃ¶netici tÃ¼m yetkilere sahiptir.
                        </p>
                        
                        <!-- Permission Matrix Table -->
                        <div id="permissionMatrixContainer" style="overflow-x:auto;border:1px solid var(--cardBorder);border-radius:10px">
                            <table id="permissionMatrix" style="width:100%;border-collapse:collapse;font-size:.85rem">
                                <!-- JavaScript ile doldurulacak -->
                            </table>
                        </div>
                        
                        <!-- Kaydetme durumu -->
                        <div id="matrixSaveStatus" style="margin-top:12px;text-align:right;font-size:.8rem;color:var(--tx2)"></div>
                    </div>
                </div>

                <!-- Oturum YÃ¶netimi -->
                <div class="admin-section" id="admin-oturumlar">
                    <div class="admin-card">
                        <div class="admin-card-header">
                            <div class="admin-card-title">â±ï¸ Oturum AyarlarÄ±</div>
                        </div>
                        <p style="color:var(--txdark2);font-size:.85rem;margin-bottom:20px">
                            GÃ¼venlik iÃ§in oturum zaman aÅŸÄ±mÄ± ve otomatik Ã§Ä±kÄ±ÅŸ ayarlarÄ±nÄ± yapÄ±landÄ±rÄ±n.
                        </p>
                        
                        <div class="form-grid" style="margin-bottom:24px">
                            <div class="form-group">
                                <label class="form-label">â° Ä°naktivite SÃ¼resi (dakika)</label>
                                <select id="sessionTimeout" class="form-select">
                                    <option value="15">15 dakika</option>
                                    <option value="30" selected>30 dakika</option>
                                    <option value="60">1 saat</option>
                                    <option value="120">2 saat</option>
                                    <option value="0">Devre DÄ±ÅŸÄ±</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ðŸ”” UyarÄ± SÃ¼resi (saniye)</label>
                                <select id="sessionWarning" class="form-select">
                                    <option value="30">30 saniye Ã¶nce</option>
                                    <option value="60" selected>1 dakika Ã¶nce</option>
                                    <option value="120">2 dakika Ã¶nce</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:20px">
                            <label style="display:flex;align-items:center;gap:8px;padding:12px 16px;background:var(--bg3);border-radius:10px;cursor:pointer">
                                <input type="checkbox" id="sessionLogoutOnClose" style="width:18px;height:18px;accent-color:#ff8674">
                                <span style="font-size:.9rem;color:var(--tx)">TarayÄ±cÄ± kapatÄ±lÄ±nca Ã§Ä±kÄ±ÅŸ yap</span>
                            </label>
                            <label style="display:flex;align-items:center;gap:8px;padding:12px 16px;background:var(--bg3);border-radius:10px;cursor:pointer">
                                <input type="checkbox" id="sessionSingleDevice" style="width:18px;height:18px;accent-color:#ff8674">
                                <span style="font-size:.9rem;color:var(--tx)">Tek cihaz politikasÄ±</span>
                            </label>
                        </div>
                        
                        <div class="btn-group">
                            <button class="btn btn-primary btn-sm" onclick="saveSessionSettings()">ðŸ’¾ AyarlarÄ± Kaydet</button>
                        </div>
                    </div>
                    
                    <!-- Aktif Oturumlar -->
                    <div class="admin-card" style="margin-top:16px">
                        <div class="admin-card-header">
                            <div class="admin-card-title" style="display:flex;align-items:center;gap:8px">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
                                Aktif Oturumlar
                            </div>
                            <button class="btn btn-sm btn-ghost" onclick="loadActiveSessions()" style="display:flex;align-items:center;gap:4px">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
                                Yenile
                            </button>
                        </div>
                        <p style="color:var(--txdark2);font-size:.85rem;margin-bottom:16px">
                            Sisteme giriÅŸ yapmÄ±ÅŸ tÃ¼m kullanÄ±cÄ±larÄ±n aktif oturumlarÄ±nÄ± gÃ¶rÃ¼ntÃ¼leyin ve yÃ¶netin.
                        </p>
                        
                        <div id="activeSessionsList" style="margin-top:16px">
                            <div style="text-align:center;padding:40px;color:var(--tx2)">
                                <div class="loading-spinner" style="margin:0 auto 12px"></div>
                                <div>Oturumlar yÃ¼kleniyor...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Oturum GeÃ§miÅŸi -->
                    <div class="admin-card" style="margin-top:16px">
                        <div class="admin-card-header">
                            <div class="admin-card-title">ðŸ“Š Son GiriÅŸ Aktiviteleri</div>
                        </div>
                        <div id="sessionHistoryList" style="margin-top:16px">
                            <div style="text-align:center;padding:40px;color:var(--tx2)">
                                <div style="font-size:2rem;margin-bottom:12px">ðŸ“Š</div>
                                <div>GeÃ§miÅŸ yÃ¼kleniyor...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- KullanÄ±cÄ± Aktiviteleri (Oturumlar ile birleÅŸtirildi) -->
                    <div class="admin-card" style="margin-top:16px">
                        <div class="admin-card-header">
                            <div class="admin-card-title" style="display:flex;align-items:center;gap:8px">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
                                KullanÄ±cÄ± Aktiviteleri
                            </div>
                            <button class="btn btn-sm btn-ghost" onclick="loadActivityLogs()" style="display:flex;align-items:center;gap:4px">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
                                Yenile
                            </button>
                        </div>
                        <p style="color:var(--tx2);font-size:.85rem;margin-bottom:16px">KullanÄ±cÄ±larÄ±n sistem Ã¼zerindeki hareketlerini takip edin.</p>
                        <div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap">
                            <select id="activityUserFilter" class="form-select" style="min-width:160px" onchange="loadActivityLogs()">
                                <option value="">TÃ¼m KullanÄ±cÄ±lar</option>
                            </select>
                            <select id="activityTypeFilter" class="form-select" style="min-width:140px" onchange="loadActivityLogs()">
                                <option value="">TÃ¼m Aktiviteler</option>
                                <option value="login">GiriÅŸ</option>
                                <option value="logout">Ã‡Ä±kÄ±ÅŸ</option>
                                <option value="page_view">Sayfa GÃ¶rÃ¼ntÃ¼leme</option>
                                <option value="document_create">Belge OluÅŸturma</option>
                                <option value="data_edit">Veri DÃ¼zenleme</option>
                            </select>
                            <input type="date" id="activityDateFilter" class="form-input" style="width:160px" onchange="loadActivityLogs()">
                        </div>
                        <div class="admin-list" id="activityLogList" style="max-height:400px;overflow-y:auto">
                            <p style="color:var(--tx2);text-align:center;padding:20px">Aktiviteler yÃ¼kleniyor...</p>
                        </div>
                    </div>
                </div>

                <!-- Puantaj KurallarÄ± -->
                <div class="admin-section" id="admin-puantajKurallar">
                    <div class="admin-card">
                        <div class="admin-card-header">
                            <div class="admin-card-title" style="display:flex;align-items:center;gap:8px">
                                <svg width="16" height="16" fill="none" stroke="#DAA520" stroke-width="2" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                                Puantaj KurallarÄ±
                            </div>
                        </div>
                        <p style="color:var(--txdark2);font-size:.85rem;margin-bottom:16px">YÃ¶netici deÄŸerlendirmelerinde kullanÄ±lan yÄ±ldÄ±z-puan karÅŸÄ±lÄ±klarÄ±nÄ± ayarlayÄ±n.</p>
                        <div class="admin-list" id="puantajRulesList">
                            <p style="color:var(--tx2);text-align:center;padding:20px">Kurallar yÃ¼kleniyor...</p>
                        </div>
                    </div>
                    
                    <!-- Checklist Saatleri AyarlarÄ± -->
                    <div class="admin-card" style="margin-top:20px">
                        <div class="admin-card-header">
                            <div class="admin-card-title">ðŸ“± Platform Check Saatleri</div>
                            <button class="btn btn-sm btn-ghost" onclick="savePlatformCheckTimes()">ðŸ’¾ Kaydet</button>
                        </div>
                        <p style="color:var(--txdark2);font-size:.85rem;margin-bottom:16px">Platform check'lerinin yapÄ±lmasÄ± gereken saatleri dÃ¼zenleyin. Her saat iÃ§in belirlenen tolerans sÃ¼resi geÃ§erlidir.</p>
                        <div style="display:flex;flex-wrap:wrap;gap:8px" id="platformCheckTimesContainer">
                            <input type="time" class="form-input platform-time" value="10:00" style="width:100px">
                            <input type="time" class="form-input platform-time" value="12:00" style="width:100px">
                            <input type="time" class="form-input platform-time" value="15:00" style="width:100px">
                            <input type="time" class="form-input platform-time" value="18:00" style="width:100px">
                            <input type="time" class="form-input platform-time" value="21:00" style="width:100px">
                            <input type="time" class="form-input platform-time" value="00:00" style="width:100px">
                        </div>
                        <div style="display:flex;gap:8px;margin-top:12px">
                            <button class="btn btn-sm btn-ghost" onclick="addPlatformCheckTime()" style="font-size:.75rem">+ Saat Ekle</button>
                            <button class="btn btn-sm btn-ghost" onclick="removePlatformCheckTime()" style="font-size:.75rem;color:var(--danger)">- Saat Ã‡Ä±kar</button>
                        </div>
                    </div>
                    
                    <!-- CHECK KURALLARI YÃ–NETÄ°M PANELÄ° -->
                    <div class="admin-card" style="margin-top:20px">
                        <div class="admin-card-header">
                            <div class="admin-card-title">âš™ï¸ Check Sistem AyarlarÄ±</div>
                            <button class="btn btn-sm btn-primary" onclick="saveCheckSystemSettings()">ðŸ’¾ Kaydet</button>
                        </div>
                        <p style="color:var(--txdark2);font-size:.85rem;margin-bottom:16px">Checklist ve platform kontrol sisteminin temel ayarlarÄ±nÄ± yapÄ±landÄ±rÄ±n.</p>
                        
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px">
                            <!-- SÃ¼re AyarlarÄ± -->
                            <div style="background:var(--bg2);border-radius:12px;padding:16px">
                                <div style="font-weight:600;color:var(--tx);margin-bottom:12px;display:flex;align-items:center;gap:8px">
                                    <span style="font-size:1.1rem">â±ï¸</span> SÃ¼re AyarlarÄ±
                                </div>
                                <div class="form-group" style="margin-bottom:12px">
                                    <label style="font-size:.75rem;color:var(--tx2)">Check Tolerans SÃ¼resi (dk)</label>
                                    <input type="number" id="checkTolerance" class="form-input" value="30" min="5" max="120" style="font-size:.85rem">
                                    <small style="color:var(--tx3);font-size:.7rem">Belirlenen saatten Â± bu sÃ¼re iÃ§inde check yapÄ±labilir</small>
                                </div>
                                <div class="form-group" style="margin-bottom:12px">
                                    <label style="font-size:.75rem;color:var(--tx2)">Ekranda Kalma SÃ¼resi (sn)</label>
                                    <input type="number" id="checkScreenTime" class="form-input" value="5" min="1" max="30" style="font-size:.85rem">
                                    <small style="color:var(--tx3);font-size:.7rem">Onay ekranÄ±nÄ±n gÃ¶rÃ¼ntÃ¼lenme sÃ¼resi</small>
                                </div>
                                <div class="form-group" style="margin-bottom:0">
                                    <label style="font-size:.75rem;color:var(--tx2)">Gecikmeli Check CezasÄ± (dk)</label>
                                    <input type="number" id="checkLatePenalty" class="form-input" value="15" min="0" max="60" style="font-size:.85rem">
                                    <small style="color:var(--tx3);font-size:.7rem">Bu sÃ¼reden sonra puan dÃ¼ÅŸer</small>
                                </div>
                            </div>
                            
                            <!-- Puanlama AyarlarÄ± -->
                            <div style="background:var(--bg2);border-radius:12px;padding:16px">
                                <div style="font-weight:600;color:var(--tx);margin-bottom:12px;display:flex;align-items:center;gap:8px">
                                    <span style="font-size:1.1rem">â­</span> Puanlama
                                </div>
                                <div class="form-group" style="margin-bottom:12px">
                                    <label style="font-size:.75rem;color:var(--tx2)">Platform Check PuanÄ±</label>
                                    <input type="number" id="checkPointPlatform" class="form-input" value="10" min="0" max="100" style="font-size:.85rem">
                                </div>
                                <div class="form-group" style="margin-bottom:12px">
                                    <label style="font-size:.75rem;color:var(--tx2)">Temizlik Check PuanÄ±</label>
                                    <input type="number" id="checkPointCleaning" class="form-input" value="5" min="0" max="100" style="font-size:.85rem">
                                </div>
                                <div class="form-group" style="margin-bottom:12px">
                                    <label style="font-size:.75rem;color:var(--tx2)">AÃ§Ä±lÄ±ÅŸ/KapanÄ±ÅŸ PuanÄ±</label>
                                    <input type="number" id="checkPointShift" class="form-input" value="15" min="0" max="100" style="font-size:.85rem">
                                </div>
                                <div class="form-group" style="margin-bottom:0">
                                    <label style="font-size:.75rem;color:var(--tx2)">Gecikme Puan DÃ¼ÅŸÃ¼mÃ¼ (%)</label>
                                    <input type="number" id="checkLateDeduction" class="form-input" value="50" min="0" max="100" style="font-size:.85rem">
                                    <small style="color:var(--tx3);font-size:.7rem">Gecikmeli check'te puandan dÃ¼ÅŸÃ¼lecek yÃ¼zde</small>
                                </div>
                            </div>
                            
                            <!-- Genel Ayarlar -->
                            <div style="background:var(--bg2);border-radius:12px;padding:16px">
                                <div style="font-weight:600;color:var(--tx);margin-bottom:12px;display:flex;align-items:center;gap:8px">
                                    <span style="font-size:1.1rem">ðŸ”§</span> Genel Ayarlar
                                </div>
                                <div class="form-group" style="margin-bottom:12px">
                                    <label style="font-size:.75rem;color:var(--tx2)">GÃ¼nlÃ¼k Maksimum Check</label>
                                    <input type="number" id="checkMaxDaily" class="form-input" value="20" min="1" max="50" style="font-size:.85rem">
                                </div>
                                <div class="form-group" style="margin-bottom:12px">
                                    <label style="font-size:.75rem;color:var(--tx2)">FotoÄŸraf ZorunluluÄŸu</label>
                                    <select id="checkPhotoRequired" class="form-select" style="font-size:.85rem">
                                        <option value="always">Her Zaman</option>
                                        <option value="platform" selected>Sadece Platform Check</option>
                                        <option value="never">HiÃ§bir Zaman</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom:12px">
                                    <label style="font-size:.75rem;color:var(--tx2)">Konum KontrolÃ¼</label>
                                    <select id="checkLocationRequired" class="form-select" style="font-size:.85rem">
                                        <option value="yes">Aktif</option>
                                        <option value="no" selected>Pasif</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom:0">
                                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                                        <input type="checkbox" id="checkNotifyManager" checked style="width:16px;height:16px">
                                        <span style="font-size:.8rem;color:var(--tx2)">Eksik check'lerde yÃ¶neticiyi bilgilendir</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Temizlik Ã‡izelgesi AyarlarÄ± -->
                    <div class="admin-card" style="margin-top:20px">
                        <div class="admin-card-header">
                            <div class="admin-card-title">ðŸ§¹ Temizlik Ã‡izelgesi Vardiya TanÄ±mlarÄ±</div>
                            <button class="btn btn-sm btn-ghost" onclick="saveTemizlikShiftRules()">ðŸ’¾ Kaydet</button>
                        </div>
                        <p style="color:var(--txdark2);font-size:.85rem;margin-bottom:16px">Her vardiya tÃ¼rÃ¼ iÃ§in shift baÅŸlangÄ±Ã§ saatlerini ve gÃ¶rev bitiÅŸ saatlerini belirleyin. Personel shift baÅŸlangÄ±Ã§ saatine gÃ¶re otomatik atanÄ±r.</p>
                        
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px">
                            <!-- AÃ§Ä±lÄ±ÅŸÃ§Ä± -->
                            <div style="background:rgba(241,196,15,.08);border-radius:12px;padding:16px">
                                <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
                                    <span style="font-size:1.2rem">ðŸŒ…</span>
                                    <span style="font-weight:600;color:var(--tx)">AÃ§Ä±lÄ±ÅŸÃ§Ä±</span>
                                </div>
                                <div class="form-group" style="margin-bottom:8px">
                                    <label style="font-size:.75rem;color:var(--tx2)">Shift BaÅŸlangÄ±Ã§</label>
                                    <div style="display:flex;gap:4px;align-items:center">
                                        <input type="time" id="acilisci_start" class="form-input" value="10:00" style="flex:1;font-size:.85rem">
                                        <span style="color:var(--tx2)">-</span>
                                        <input type="time" id="acilisci_end" class="form-input" value="11:00" style="flex:1;font-size:.85rem">
                                    </div>
                                </div>
                                <div class="form-group" style="margin-bottom:0">
                                    <label style="font-size:.75rem;color:var(--tx2)">GÃ¶rev BitiÅŸi</label>
                                    <input type="time" id="acilisci_deadline" class="form-input" value="15:00" style="font-size:.85rem">
                                </div>
                            </div>
                            
                            <!-- AracÄ± -->
                            <div style="background:rgba(52,152,219,.08);border-radius:12px;padding:16px">
                                <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
                                    <span style="font-size:1.2rem">â˜€ï¸</span>
                                    <span style="font-weight:600;color:var(--tx)">AracÄ±</span>
                                </div>
                                <div class="form-group" style="margin-bottom:8px">
                                    <label style="font-size:.75rem;color:var(--tx2)">Shift BaÅŸlangÄ±Ã§</label>
                                    <div style="display:flex;gap:4px;align-items:center">
                                        <input type="time" id="araci_start" class="form-input" value="11:00" style="flex:1;font-size:.85rem">
                                        <span style="color:var(--tx2)">-</span>
                                        <input type="time" id="araci_end" class="form-input" value="16:00" style="flex:1;font-size:.85rem">
                                    </div>
                                </div>
                                <div class="form-group" style="margin-bottom:0">
                                    <label style="font-size:.75rem;color:var(--tx2)">GÃ¶rev BitiÅŸi</label>
                                    <input type="time" id="araci_deadline" class="form-input" value="19:00" style="font-size:.85rem">
                                </div>
                            </div>
                            
                            <!-- KapanÄ±ÅŸÃ§Ä± -->
                            <div style="background:rgba(155,89,182,.08);border-radius:12px;padding:16px">
                                <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
                                    <span style="font-size:1.2rem">ðŸŒ™</span>
                                    <span style="font-weight:600;color:var(--tx)">KapanÄ±ÅŸÃ§Ä±</span>
                                </div>
                                <div class="form-group" style="margin-bottom:8px">
                                    <label style="font-size:.75rem;color:var(--tx2)">Shift BaÅŸlangÄ±Ã§</label>
                                    <div style="display:flex;gap:4px;align-items:center">
                                        <input type="time" id="kapanisci_start" class="form-input" value="16:00" style="flex:1;font-size:.85rem">
                                        <span style="color:var(--tx2)">-</span>
                                        <input type="time" id="kapanisci_end" class="form-input" value="23:59" style="flex:1;font-size:.85rem">
                                    </div>
                                </div>
                                <div class="form-group" style="margin-bottom:0">
                                    <label style="font-size:.75rem;color:var(--tx2)">GÃ¶rev BitiÅŸi</label>
                                    <input type="time" id="kapanisci_deadline" class="form-input" value="02:00" style="font-size:.85rem">
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top:12px;padding:10px;background:var(--bg3);border-radius:8px;font-size:.8rem;color:var(--tx2)">
                            ðŸ’¡ <strong>Ã–rnek:</strong> Shift baÅŸlangÄ±cÄ± 10:30 olan personel â†’ AÃ§Ä±lÄ±ÅŸÃ§Ä±. Shift baÅŸlangÄ±cÄ± 13:00 olan â†’ AracÄ±. Shift baÅŸlangÄ±cÄ± 17:00 olan â†’ KapanÄ±ÅŸÃ§Ä±.
                        </div>
                    </div>
                </div>

                <!-- Åžubeler -->
                <div class="admin-section" id="admin-subeler">
                    <div class="admin-card">
                        <div class="admin-card-header">
                            <div class="admin-card-title">ðŸ“ Åžubeler</div>
                            <button id="btnAddBranch" class="btn btn-sm btn-primary" onclick="addBranch()">+ Ekle</button>
                        </div>
                        <div class="admin-list" id="branchList"></div>
                    </div>
                </div>

                <!-- Pozisyonlar -->
                <!-- Pozisyonlar sekmesi artÄ±k Pozisyon Yetkileri ile birleÅŸtirildi - admin-kullanicilar iÃ§inde -->

                <!-- Ä°hlaller -->
                <div class="admin-section" id="admin-ihlaller">
                    <div class="admin-card">
                        <div class="admin-card-header">
                            <div class="admin-card-title" style="display:flex;align-items:center;gap:8px">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                Ä°hlal KataloÄŸu
                            </div>
                            <button class="btn btn-sm btn-primary" onclick="addViolation()">+ Ekle</button>
                        </div>
                        <div class="admin-list" id="violationAdminList"></div>
                    </div>
                </div>

                <!-- Åžablonlar -->
                <div class="admin-section" id="admin-sablonlar">
                    <div class="admin-card">
                        <div class="admin-card-header">
                            <div class="admin-card-title" style="display:flex;align-items:center;gap:8px">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                                SÃ¶zleÅŸme ÅžablonlarÄ±
                            </div>
                        </div>
                        <p style="color:var(--txdark2);font-size:.85rem;margin-bottom:16px">Her pozisyon iÃ§in HTML ÅŸablon dÃ¼zenleyin. Placeholder'lar: <code style="background:var(--surface3);padding:2px 6px;border-radius:4px">{{AD_SOYAD}}</code>, <code style="background:var(--surface3);padding:2px 6px;border-radius:4px">{{TC}}</code>, <code style="background:var(--surface3);padding:2px 6px;border-radius:4px">{{ADRES}}</code>, <code style="background:var(--surface3);padding:2px 6px;border-radius:4px">{{IBAN}}</code>, <code style="background:var(--surface3);padding:2px 6px;border-radius:4px">{{UCRET}}</code>, <code style="background:var(--surface3);padding:2px 6px;border-radius:4px">{{BASLAMA}}</code>, <code style="background:var(--surface3);padding:2px 6px;border-radius:4px">{{SUBE}}</code></p>
                        <div class="form-group">
                            <label class="form-label">Pozisyon SeÃ§</label>
                            <select id="template_pozisyon" class="form-select" onchange="loadTemplate()"></select>
                        </div>
                        <div class="form-group" style="margin-top:16px">
                            <label class="form-label">Åžablon Ä°Ã§eriÄŸi (HTML)</label>
                            <textarea id="template_content" class="form-textarea" style="min-height:300px;font-family:var(--mono);font-size:.8rem"></textarea>
                        </div>
                        <div class="btn-group"><button class="btn btn-primary btn-sm" onclick="saveTemplate()">Åžablonu Kaydet</button></div>
                    </div>
                </div>

                <!-- Belge ÅžablonlarÄ± -->
                <div class="admin-section" id="admin-belgeler">
                    <div class="admin-card">
                        <div class="admin-card-header">
                            <div class="admin-card-title" style="display:flex;align-items:center;gap:8px">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                Belge ÅžablonlarÄ± DÃ¼zenleyici
                            </div>
                            <div id="docTemplateUnsaved" style="display:none;color:var(--yellow);font-size:.8rem;font-weight:500">KaydedilmemiÅŸ deÄŸiÅŸiklikler</div>
                        </div>
                        <p style="color:var(--txdark2);font-size:.85rem;margin-bottom:16px">Tutanak, savunma, fesih ve borÃ§ ikrar belgelerinin iÃ§eriklerini dÃ¼zenleyin. DeÄŸiÅŸiklikler kaydedilmezse varsayÄ±lan ÅŸablonlar kullanÄ±lÄ±r.</p>
                        
                        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px">
                            <button class="btn btn-sm btn-primary" onclick="selectDocTemplateCategory('tutanak')">ðŸ“‹ Tutanak</button>
                            <button class="btn btn-sm btn-ghost" onclick="selectDocTemplateCategory('savunma')">ðŸ“ Savunma</button>
                            <button class="btn btn-sm btn-ghost" onclick="selectDocTemplateCategory('fesih')">âš ï¸ Fesih</button>
                            <button class="btn btn-sm btn-ghost" onclick="selectDocTemplateCategory('borc')">ðŸ’° BorÃ§ Ä°krar</button>
                        </div>
                        
                        <!-- Tutanak Alt TÃ¼rleri -->
                        <div id="docTemplate-tutanak" class="doc-template-panel">
                            <div class="form-group">
                                <label class="form-label">Tutanak TÃ¼rÃ¼</label>
                                <select class="form-select" id="tutanak_sub_type" onchange="loadDocTemplate('tutanak', this.value)">
                                    <option value="olay">Olay Tespit TutanaÄŸÄ±</option>
                                    <option value="devamsizlik">DevamsÄ±zlÄ±k TutanaÄŸÄ±</option>
                                    <option value="kasa">Kasa AÃ§Ä±ÄŸÄ± TutanaÄŸÄ±</option>
                                    <option value="imza">Ä°mzadan Ä°mtina TutanaÄŸÄ±</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Savunma -->
                        <div id="docTemplate-savunma" class="doc-template-panel" style="display:none">
                            <p style="color:var(--txdark2);font-size:.85rem">Savunma isteme yazÄ±sÄ± ÅŸablonu</p>
                        </div>
                        
                        <!-- Fesih Alt TÃ¼rleri -->
                        <div id="docTemplate-fesih" class="doc-template-panel" style="display:none">
                            <div class="form-group">
                                <label class="form-label">Fesih TÃ¼rÃ¼</label>
                                <select class="form-select" id="fesih_sub_type" onchange="loadDocTemplate('fesih', this.value)">
                                    <option value="hakli">HaklÄ± Fesih (25/II)</option>
                                    <option value="gecerli">GeÃ§erli Fesih (18)</option>
                                    <option value="deneme">Deneme SÃ¼resi Feshi</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- BorÃ§ Ä°krar -->
                        <div id="docTemplate-borc" class="doc-template-panel" style="display:none">
                            <p style="color:var(--txdark2);font-size:.85rem">BorÃ§ ikrar ve mahsup muvafakatnamesi ÅŸablonu</p>
                        </div>
                        
                        <div class="form-group" style="margin-top:16px">
                            <label class="form-label">Åžablon AÃ§Ä±klamasÄ± <span style="color:var(--txdark2);font-size:.75rem">(Yer tutucular: {{PERSONEL}}, {{TC}}, {{SUBE}}, {{TARIH}}, {{SAAT}}, {{ACIKLAMA}}, {{DAYANAK}})</span></label>
                            <textarea id="doc_template_content" class="form-textarea" style="min-height:250px;font-family:var(--mono);font-size:.8rem" oninput="trackDocTemplateChanges()"></textarea>
                        </div>
                        
                        <div class="btn-group" style="display:flex;gap:8px;flex-wrap:wrap">
                            <button class="btn btn-primary btn-sm" onclick="saveDocTemplate()" style="display:flex;align-items:center;gap:4px">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                                Åžablonu Kaydet
                            </button>
                            <button class="btn btn-ghost btn-sm" onclick="previewDocTemplate()" style="display:flex;align-items:center;gap:4px">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                                Ã–nizle
                            </button>
                            <button class="btn btn-sm" style="background:var(--yellow);color:#000;display:flex;align-items:center;gap:4px" onclick="resetDocTemplate()">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
                                VarsayÄ±lana DÃ¶n
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Aktiviteler artÄ±k Oturumlar ile birleÅŸtirildi - admin-oturumlar iÃ§inde -->
                
                <!-- G15: Yedekler -->
                <div class="admin-section" id="admin-yedekler">
                    <div class="admin-card">
                        <div class="admin-card-header">
                            <div class="admin-card-title" style="display:flex;align-items:center;gap:8px">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                Yedekler
                            </div>
                            <button class="btn btn-sm" style="background:#008c95;color:#fff" onclick="takeManualBackup()">+ Manuel Yedek Al</button>
                        </div>
                        <p style="color:var(--tx2);font-size:.85rem;margin-bottom:16px">Manuel yedek alÄ±n ve indirin</p>
                        <div id="backupsListContainer">
                            <div style="text-align:center;padding:40px">
                                <button class="btn btn-primary" onclick="loadBackupsList()">Yedekleri GÃ¶ster</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script>
// ==================== FIREBASE CONFIG ====================
console.log('ðŸ”· Moonberry Ä°K v2.9 yÃ¼klendi - BUILD 20260130-0710 - PRÄ°M SÄ°STEMÄ°');
const firebaseConfig = {
    apiKey: "AIzaSyCbc-8oWwOj2eR0J19f3T-UYT9vGI8PL7M",
    authDomain: "moonberry-ik.firebaseapp.com",
    projectId: "moonberry-ik",
    storageBucket: "moonberry-ik.firebasestorage.app",
    messagingSenderId: "4872042742",
    appId: "1:4872042742:web:24a9e5935e2b5591a794d7"
};

// Firebase deÄŸiÅŸkenleri - DOMContentLoaded'da initialize edilecek
let db = null;

// ==================== GLOBAL YARDIMCI FONKSÄ°YONLAR ====================
// TÃ¼rkÃ§e karakter destekli isim normalize - puantajNotes ID iÃ§in
function normalizePersonelId(name) {
    if (!name) return '';
    return name
        .toLowerCase()
        .replace(/ÄŸ/g, 'g').replace(/Ã¼/g, 'u').replace(/ÅŸ/g, 's')
        .replace(/Ä±/g, 'i').replace(/Ã¶/g, 'o').replace(/Ã§/g, 'c')
        .replace(/Äž/g, 'g').replace(/Ãœ/g, 'u').replace(/Åž/g, 's')
        .replace(/Ä°/g, 'i').replace(/Ã–/g, 'o').replace(/Ã‡/g, 'c')
        .replace(/[^a-z0-9]/g, '_')
        .replace(/_+/g, '_')
        .replace(/^_|_$/g, '');
}

// Tam isimden kÄ±sa gÃ¶rÃ¼ntÃ¼ formatÄ±: "BÃœÅžRA SÃ–ÄžÃœT" â†’ "BÃ¼ÅŸra S."
function formatDisplayName(fullName) {
    if (!fullName) return '';
    const parts = fullName.trim().split(/\s+/);
    if (parts.length === 0) return '';
    const capitalize = (s) => s.charAt(0).toUpperCase() + s.slice(1).toLowerCase();
    if (parts.length === 1) return capitalize(parts[0]);
    const firstName = capitalize(parts[0]);
    const lastInitial = parts[parts.length - 1].charAt(0).toUpperCase();
    return `${firstName} ${lastInitial}.`;
}

// ==================== ANA GÃ–RÃœNTÃœ FONKSÄ°YONU ====================
// codeName varsa onu, yoksa formatDisplayName(name) dÃ¶ndÃ¼r
// BU FONKSÄ°YON HER YERDE KULLANILMALI!
function getPersonelDisplayName(personelData) {
    if (!personelData) return '';
    
    // personelData obje ise
    if (typeof personelData === 'object') {
        // codeName varsa ve boÅŸ deÄŸilse onu kullan
        if (personelData.codeName && personelData.codeName.trim()) {
            return personelData.codeName.trim();
        }
        // Yoksa name'den formatla
        return formatDisplayName(personelData.name || '');
    }
    
    // String ise direkt formatla
    return formatDisplayName(personelData);
}

// Personel listesinden isim getir (cache kullanarak)
let _personelDisplayCache = null;
async function getPersonelDisplayNameFromList(searchKey, branch) {
    if (!searchKey) return searchKey;
    
    // Cache'i kontrol et
    if (!_personelDisplayCache) {
        try {
            const snapshot = await db.collection('personel').get();
            _personelDisplayCache = new Map();
            snapshot.forEach(doc => {
                const data = doc.data();
                const displayName = getPersonelDisplayName(data);
                const uniqueId = data.uniqueId || normalizePersonelId(data.name);
                
                // Underscore formatÄ± oluÅŸtur (Ã¶rn: "baran_akdemir")
                const underscoreName = data.name?.toLowerCase().replace(/\s+/g, '_').replace(/[ÄŸ]/g, 'g').replace(/[Ã¼]/g, 'u').replace(/[ÅŸ]/g, 's').replace(/[Ä±]/g, 'i').replace(/[Ã¶]/g, 'o').replace(/[Ã§]/g, 'c');
                const underscoreCodeName = data.codeName?.toLowerCase().replace(/\s+/g, '_').replace(/[ÄŸ]/g, 'g').replace(/[Ã¼]/g, 'u').replace(/[ÅŸ]/g, 's').replace(/[Ä±]/g, 'i').replace(/[Ã¶]/g, 'o').replace(/[Ã§]/g, 'c');
                
                // Ä°smin ilk harfini al (Ã¶rn: "Baran" -> "baran", "BARAN" -> "baran")
                const firstName = data.name?.split(' ')[0];
                const firstNameLower = firstName?.toLowerCase();
                const firstNameNorm = normalizeTurkishChars(firstName);
                
                const codeFirst = data.codeName?.split(' ')[0];
                const codeFirstLower = codeFirst?.toLowerCase();
                const codeFirstNorm = normalizeTurkishChars(codeFirst);
                
                const keys = [
                    data.name,
                    data.name?.toLowerCase(),
                    data.name?.toUpperCase(),
                    data.codeName,
                    data.codeName?.toLowerCase(),
                    data.codeName?.toUpperCase(),
                    firstName,
                    firstNameLower,
                    firstNameNorm,
                    codeFirst,
                    codeFirstLower,
                    codeFirstNorm,
                    uniqueId,
                    normalizePersonelId(data.name),
                    normalizePersonelId(data.codeName),
                    normalizeTurkishChars(data.name),
                    normalizeTurkishChars(data.codeName),
                    // Underscore formatlarÄ± (shift'ten gelen)
                    underscoreName,
                    underscoreCodeName,
                    // KarÄ±ÅŸÄ±k format denemeleri
                    underscoreName?.replace(/_/g, ' '),
                    underscoreCodeName?.replace(/_/g, ' '),
                    // Ä°lk isim underscore (Ã¶rn: "tuana" veya "busra")
                    underscoreName?.split('_')[0],
                    underscoreCodeName?.split('_')[0],
                    // EK: Normalize edilmiÅŸ tÃ¼m varyasyonlar (TÃ¼rkÃ§e Ä° sorunu iÃ§in)
                    normalizeTurkishChars(data.name?.toLowerCase()),
                    normalizeTurkishChars(underscoreName),
                    normalizeTurkishChars(underscoreName?.replace(/_/g, ' ')),
                    // displayName formatÄ± (Ad S.)
                    formatDisplayName(data.name),
                    formatDisplayName(data.name)?.toLowerCase(),
                    normalizeTurkishChars(formatDisplayName(data.name)),
                ].filter(k => k);
                
                // TÃ¼m keyleri kaydet
                keys.forEach(key => {
                    if (key && !_personelDisplayCache.has(key)) {
                        _personelDisplayCache.set(key, { 
                            displayName, 
                            fullName: data.name,
                            codeName: data.codeName,
                            uniqueId,
                            branch: data.branch
                        });
                    }
                });
            });
            console.log('[Cache] Personel cache oluÅŸturuldu:', _personelDisplayCache.size, 'kayÄ±t');
        } catch (e) {
            console.error('Personel cache hatasÄ±:', e);
            return searchKey;
        }
    }
    
    // Arama varyasyonlarÄ± oluÅŸtur
    const underscoreSearch = searchKey?.toLowerCase().replace(/\s+/g, '_').replace(/[ÄŸ]/g, 'g').replace(/[Ã¼]/g, 'u').replace(/[ÅŸ]/g, 's').replace(/[Ä±]/g, 'i').replace(/[Ã¶]/g, 'o').replace(/[Ã§]/g, 'c');
    const spaceSearch = searchKey?.replace(/_/g, ' ');
    const firstWord = searchKey?.split(/[_\s]/)[0];
    const normalizedSearch = normalizeTurkishChars(searchKey);
    const displayFormatSearch = formatDisplayName(searchKey?.replace(/_/g, ' '));
    
    // Cache'ten ara - Ã§oklu deneme (GÃœÃ‡LENDIRILDI)
    const result = _personelDisplayCache.get(searchKey) || 
                   _personelDisplayCache.get(searchKey?.toLowerCase()) ||
                   _personelDisplayCache.get(searchKey?.toUpperCase()) ||
                   _personelDisplayCache.get(normalizedSearch) ||
                   _personelDisplayCache.get(normalizePersonelId(searchKey)) ||
                   _personelDisplayCache.get(underscoreSearch) ||
                   _personelDisplayCache.get(spaceSearch) ||
                   _personelDisplayCache.get(spaceSearch?.toLowerCase()) ||
                   _personelDisplayCache.get(normalizeTurkishChars(spaceSearch)) ||
                   _personelDisplayCache.get(firstWord) ||
                   _personelDisplayCache.get(firstWord?.toLowerCase()) ||
                   _personelDisplayCache.get(normalizeTurkishChars(firstWord)) ||
                   _personelDisplayCache.get(displayFormatSearch) ||
                   _personelDisplayCache.get(displayFormatSearch?.toLowerCase()) ||
                   _personelDisplayCache.get(normalizeTurkishChars(displayFormatSearch));
    
    if (result) {
        // Branch kontrolÃ¼ - branch null/"all" ise veya eÅŸleÅŸiyorsa dÃ¶ndÃ¼r
        if (!branch || branch === 'all' || !result.branch || result.branch === branch || result.branch === 'all') {
            return result.displayName;
        }
    }
    
    console.warn('[Cache] Personel bulunamadÄ±:', searchKey, '-> orijinal deÄŸer kullanÄ±lÄ±yor');
    return searchKey; // BulunamadÄ±, gelen deÄŸeri dÃ¶ndÃ¼r
}

// Cache'i temizle (yeni personel eklendiÄŸinde)
function clearPersonelDisplayCache() {
    _personelDisplayCache = null;
}

// ==================== MÄ°GRASYON FONKSÄ°YONLARI ====================

// Personel cache for migration
let _migrationPersonelMap = null;

// Helper: TÃ¼rkÃ§e karakterleri normalize et
// Ã–NEMLÄ°: Ã–nce bÃ¼yÃ¼k TÃ¼rkÃ§e harfleri replace et, sonra toLowerCase!
function normalizeTurkishChars(str) {
    if (!str) return '';
    return str
        // Ã–nce bÃ¼yÃ¼k TÃ¼rkÃ§e harfleri kÃ¼Ã§Ã¼lt (toLowerCase'dan Ã¶nce!)
        .replace(/Ä°/g, 'i').replace(/I/g, 'i')
        .replace(/Äž/g, 'g').replace(/Ãœ/g, 'u').replace(/Åž/g, 's')
        .replace(/Ã–/g, 'o').replace(/Ã‡/g, 'c')
        // Sonra toLowerCase
        .toLowerCase()
        // Sonra kÃ¼Ã§Ã¼k TÃ¼rkÃ§e harfleri normalize et
        .replace(/ÄŸ/g, 'g').replace(/Ã¼/g, 'u').replace(/ÅŸ/g, 's')
        .replace(/Ä±/g, 'i').replace(/Ã¶/g, 'o').replace(/Ã§/g, 'c')
        .replace(/iÌ‡/g, 'i'); // combining dot varsa temizle
}

// ==================== ÅžÄ°FRE ENCODE/DECODE ====================
// Base64 ile basit ÅŸifreleme (admin gÃ¶rebilsin diye)
// ==================== GÃœVENLÄ°K: ÅžÄ°FRE SÄ°STEMÄ° ====================

// Salt Ã¼ret (4 karakter rastgele)
function generateSalt() {
    const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
    let salt = '';
    for (let i = 0; i < 4; i++) {
        salt += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return salt;
}

// Åžifre encode (obfuscation + salt)
function encodePassword(plainPassword) {
    if (!plainPassword) return '';
    try {
        const salt = generateSalt();
        const withSalt = plainPassword + salt;
        const encoded = btoa(unescape(encodeURIComponent(withSalt)));
        return { k: encoded, s: salt };
    } catch (e) {
        console.error('Åžifre encode hatasÄ±:', e);
        return '';
    }
}

// Åžifre decode (credentials formatÄ±ndan)
function decodePassword(credentialData) {
    if (!credentialData) return '';
    
    // Eski format (string) - geriye uyumluluk
    if (typeof credentialData === 'string') {
        try {
            // Eski reversed base64 formatÄ± dene
            const reversed = decodeURIComponent(escape(atob(credentialData)));
            return reversed.split('').reverse().join('');
        } catch (e) {
            return credentialData; // Plain text olabilir
        }
    }
    
    // Yeni format (object: {k, s})
    if (credentialData.k) {
        try {
            const decoded = decodeURIComponent(escape(atob(credentialData.k)));
            // Salt'Ä± kaldÄ±r
            if (credentialData.s && decoded.endsWith(credentialData.s)) {
                return decoded.slice(0, -credentialData.s.length);
            }
            return decoded;
        } catch (e) {
            console.error('Åžifre decode hatasÄ±:', e);
            return '';
        }
    }
    
    return '';
}

// Email'i gÃ¼venli doc ID'ye Ã§evir
function emailToDocId(email) {
    return email.toLowerCase().replace(/[@.]/g, '_');
}

// Credentials koleksiyonuna ÅŸifre kaydet
async function saveCredential(email, password, personelId = null) {
    if (!email || !password) return false;
    
    try {
        const docId = emailToDocId(email);
        const encoded = encodePassword(password);
        
        await db.collection('credentials').doc(docId).set({
            e: email,                    // Email (aÃ§Ä±k - arama iÃ§in)
            k: encoded.k,                // Encoded password
            s: encoded.s,                // Salt
            p: personelId,               // Personel ID (referans)
            u: firebase.firestore.FieldValue.serverTimestamp(), // GÃ¼ncelleme zamanÄ±
            v: 2                         // Versiyon
        });
        
        console.log('Credential kaydedildi:', docId);
        return true;
    } catch (e) {
        console.error('Credential kaydetme hatasÄ±:', e);
        return false;
    }
}

// Credentials'dan ÅŸifre oku (admin iÃ§in)
async function getCredential(email) {
    if (!email) return null;
    
    try {
        const docId = emailToDocId(email);
        const doc = await db.collection('credentials').doc(docId).get();
        
        if (doc.exists) {
            const data = doc.data();
            return decodePassword({ k: data.k, s: data.s });
        }
        return null;
    } catch (e) {
        console.error('Credential okuma hatasÄ±:', e);
        return null;
    }
}

// Credentials koleksiyonundan sil
async function deleteCredential(email) {
    if (!email) return false;
    
    try {
        const docId = emailToDocId(email);
        await db.collection('credentials').doc(docId).delete();
        return true;
    } catch (e) {
        console.error('Credential silme hatasÄ±:', e);
        return false;
    }
}

// Personel map oluÅŸtur: displayName/codeName â†’ {uniqueId, fullName}
// Belirsiz key'ler (aynÄ± ilk isim iÃ§in birden fazla personel) iÅŸaretlenir
async function buildPersonelMap() {
    if (_migrationPersonelMap) return _migrationPersonelMap;
    
    const snapshot = await db.collection('personel').get();
    _migrationPersonelMap = new Map();
    
    // Ã–nce tÃ¼m personeli topla ve ilk isim sayÄ±larÄ±nÄ± hesapla
    const allPersonel = [];
    const firstNameCount = {}; // "BÃœÅžRA" â†’ 2 gibi
    
    snapshot.forEach(doc => {
        const data = doc.data();
        const uniqueId = data.uniqueId || normalizePersonelId(data.name);
        const fullName = data.name;
        const displayName = getPersonelDisplayName(data);
        const codeName = data.codeName || formatDisplayName(fullName);
        const firstName = fullName?.split(' ')[0] || '';
        const firstNameNorm = normalizeTurkishChars(firstName);
        
        allPersonel.push({ doc, data, uniqueId, fullName, displayName, codeName, firstName, firstNameNorm, branch: data.branch });
        
        // Ä°lk isim sayÄ±sÄ±nÄ± artÄ±r (branch bazlÄ±)
        const countKey = `${data.branch}_${firstNameNorm}`;
        firstNameCount[countKey] = (firstNameCount[countKey] || 0) + 1;
    });
    
    // Åžimdi map'i oluÅŸtur
    allPersonel.forEach(p => {
        const { uniqueId, fullName, displayName, codeName, firstName, firstNameNorm, branch, data } = p;
        const codeFirstPart = codeName?.split(' ')[0] || '';
        
        // Bu ilk isim belirsiz mi? (aynÄ± branch'te 2+ kiÅŸi)
        const countKey = `${branch}_${firstNameNorm}`;
        const isAmbiguous = firstNameCount[countKey] > 1;
        
        // Kesin eÅŸleÅŸme key'leri (her zaman ekle)
        const certainKeys = [
            // Tam isim varyasyonlarÄ±
            fullName,
            fullName?.toLowerCase(),
            fullName?.toUpperCase(),
            normalizeTurkishChars(fullName),
            
            // Display name varyasyonlarÄ± (codeName veya "Ä°sim S.")
            displayName,
            displayName?.toLowerCase(),
            displayName?.toUpperCase(),
            normalizeTurkishChars(displayName),
            
            // Kod adÄ± varyasyonlarÄ± (TAM)
            data.codeName,
            data.codeName?.toLowerCase(),
            data.codeName?.toUpperCase(),
            normalizeTurkishChars(data.codeName),
            
            // Normalize ID (benzersiz)
            normalizePersonelId(fullName),
            uniqueId,
        ].filter(k => k);
        
        // Belirsiz olabilecek key'ler (sadece tek personel varsa ekle)
        const ambiguousKeys = isAmbiguous ? [] : [
            // Ä°lk isim varyasyonlarÄ± (BÃœÅžRA, BÃ¼ÅŸra, busra)
            firstName,
            firstName?.toLowerCase(),
            firstName?.toUpperCase(),
            normalizeTurkishChars(firstName),
            
            // Kod adÄ± ilk kÄ±sÄ±m
            codeFirstPart,
            codeFirstPart?.toLowerCase(),
            codeFirstPart?.toUpperCase(),
            normalizeTurkishChars(codeFirstPart),
        ].filter(k => k);
        
        const info = { uniqueId, fullName, displayName, codeName: data.codeName, branch };
        
        certainKeys.forEach(key => {
            if (!_migrationPersonelMap.has(key)) {
                _migrationPersonelMap.set(key, info);
            }
        });
        
        ambiguousKeys.forEach(key => {
            if (!_migrationPersonelMap.has(key)) {
                _migrationPersonelMap.set(key, info);
            }
        });
        
        // Belirsiz ilk isimleri logla
        if (isAmbiguous) {
            console.log(`[Migration] âš ï¸ Belirsiz ilk isim: "${firstName}" (${branch}) - ${firstNameCount[countKey]} kiÅŸi`);
        }
    });
    
    console.log(`[Migration] Personel map oluÅŸturuldu: ${_migrationPersonelMap.size} key`);
    return _migrationPersonelMap;
}

// 1. Mevcut personellere uniqueId ekle
async function migratePersonelUniqueIds() {
    if (!db) {
        console.error('Firebase baÄŸlantÄ±sÄ± yok');
        return { updated: 0, skipped: 0 };
    }
    
    console.log('[Migration] 1/3 Personel uniqueId migrasyon baÅŸlÄ±yor...');
    
    try {
        const snapshot = await db.collection('personel').get();
        let updated = 0, skipped = 0;
        
        for (const doc of snapshot.docs) {
            const data = doc.data();
            
            // Zaten uniqueId varsa atla
            if (data.uniqueId) {
                skipped++;
                continue;
            }
            
            // uniqueId oluÅŸtur
            const uniqueId = normalizePersonelId(data.name);
            
            // GÃ¼ncelle
            await db.collection('personel').doc(doc.id).update({ uniqueId });
            console.log(`  âœ“ ${data.name} â†’ ${uniqueId}`);
            updated++;
        }
        
        console.log(`[Migration] Personel: ${updated} gÃ¼ncellendi, ${skipped} atlandÄ±`);
        return { updated, skipped };
    } catch (e) {
        console.error('[Migration] Personel hatasÄ±:', e);
        return { updated: 0, skipped: 0, error: e.message };
    }
}

// 2. Shift verilerini gÃ¼ncelle - KEY'LERÄ° DEÄžÄ°ÅžTÄ°RME, SADECE MAPPING EKLE
async function migrateShiftData() {
    if (!db) {
        console.error('Firebase baÄŸlantÄ±sÄ± yok');
        return { updated: 0, skipped: 0 };
    }
    
    console.log('[Migration] 2/4 Shift mapping gÃ¼ncelleniyor (key deÄŸiÅŸikliÄŸi YOK)...');
    
    try {
        const personelMap = await buildPersonelMap();
        const shiftsSnapshot = await db.collection('shifts').get();
        let updated = 0, skipped = 0;
        
        for (const doc of shiftsSnapshot.docs) {
            const shift = doc.data();
            const personelShifts = shift.personelShifts || {};
            const newPersonelNames = shift.personelNames || {};
            const newPersonelFullNames = shift.personelFullNames || {};
            let hasChanges = false;
            
            // Key'leri DEÄžÄ°ÅžTÄ°RME - sadece mapping ekle
            for (const oldKey of Object.keys(personelShifts)) {
                // Zaten mapping varsa atla
                if (newPersonelNames[oldKey] && newPersonelFullNames[oldKey]) {
                    continue;
                }
                
                // Personel bilgisi bul
                let personelInfo = personelMap.get(oldKey) || 
                                   personelMap.get(oldKey.toLowerCase()) ||
                                   personelMap.get(oldKey.toUpperCase()) ||
                                   personelMap.get(normalizeTurkishChars(oldKey)) ||
                                   personelMap.get(normalizePersonelId(oldKey));
                
                if (personelInfo) {
                    newPersonelNames[oldKey] = personelInfo.displayName;
                    newPersonelFullNames[oldKey] = personelInfo.fullName;
                    hasChanges = true;
                    console.log(`  âœ“ ${oldKey} â†’ display: "${personelInfo.displayName}"`);
                } else {
                    // BulunamadÄ± - key'i displayName olarak kullan
                    if (!newPersonelNames[oldKey]) {
                        newPersonelNames[oldKey] = oldKey;
                        newPersonelFullNames[oldKey] = oldKey;
                        hasChanges = true;
                        console.warn(`  âš ï¸ "${oldKey}" iÃ§in personel bulunamadÄ±, olduÄŸu gibi bÄ±rakÄ±ldÄ±`);
                    }
                }
            }
            
            if (hasChanges) {
                await db.collection('shifts').doc(doc.id).update({
                    personelNames: newPersonelNames,
                    personelFullNames: newPersonelFullNames,
                    migratedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                updated++;
            } else {
                skipped++;
            }
        }
        
        console.log(`[Migration] Shift: ${updated} gÃ¼ncellendi, ${skipped} atlandÄ±`);
        return { updated, skipped };
    } catch (e) {
        console.error('[Migration] Shift hatasÄ±:', e);
        return { updated: 0, skipped: 0, error: e.message };
    }
}

// 3. Eski puantajNotes kayÄ±tlarÄ±nÄ± temizle
async function cleanOldPuantajNotes() {
    if (!db) {
        console.error('Firebase baÄŸlantÄ±sÄ± yok');
        return { deleted: 0 };
    }
    
    console.log('[Migration] 3/3 Eski puantajNotes temizleniyor...');
    
    try {
        const snapshot = await db.collection('puantajNotes').get();
        let deleted = 0, kept = 0;
        
        const toDelete = [];
        
        for (const doc of snapshot.docs) {
            const data = doc.data();
            
            // Eski format kontrolÃ¼: personelId kÄ±sa isim formatÄ±nda mÄ±?
            // Yeni format: busra_sogut (tam isim normalize)
            // Eski format: busra, b__ra, balra (kÄ±sa isim)
            const personelId = data.personelId || '';
            const hasUnderscore = personelId.includes('_');
            const partsCount = personelId.split('_').filter(p => p).length;
            
            // Eski format: tek kelime veya Ã§ok kÄ±sa
            const isOldFormat = !hasUnderscore || partsCount < 2 || personelId.length < 8;
            
            if (isOldFormat && data.autoGenerated) {
                toDelete.push(doc.ref);
                deleted++;
            } else {
                kept++;
            }
        }
        
        // Batch halinde sil (500'lÃ¼k gruplar)
        const batchSize = 450;
        for (let i = 0; i < toDelete.length; i += batchSize) {
            const batch = db.batch();
            const chunk = toDelete.slice(i, i + batchSize);
            chunk.forEach(ref => batch.delete(ref));
            await batch.commit();
            console.log(`  ${Math.min(i + batchSize, toDelete.length)}/${toDelete.length} silindi...`);
        }
        
        console.log(`[Migration] PuantajNotes: ${deleted} silindi, ${kept} korundu`);
        return { deleted, kept };
    } catch (e) {
        console.error('[Migration] PuantajNotes hatasÄ±:', e);
        return { deleted: 0, error: e.message };
    }
}

// 4. Shift sÄ±ralama dÃ¼zeltme - BÃ–LGE MÃœDÃœRÃœ TÃœM ÅžUBELERDE + ROLE SIRALAMA
async function fixShiftOrdering() {
    console.log('[Migration] 4/4 Shift sÄ±ralamasÄ± dÃ¼zeltiliyor...');
    
    try {
        // Ã–nce tÃ¼m personeli Ã§ek
        const personelSnap = await db.collection('personel').get();
        const allPersonel = [];
        const bolgeMudurleri = []; // BÃ¶lge mÃ¼dÃ¼rleri TÃœM ÅŸubelerde gÃ¶rÃ¼necek
        
        personelSnap.forEach(doc => {
            const p = doc.data();
            const info = {
                docId: doc.id,
                name: p.name,
                codeName: p.codeName,
                displayName: getPersonelDisplayName(p),
                uniqueId: p.uniqueId || normalizePersonelId(p.name),
                role: p.role || 'barista',
                branch: p.branch
            };
            allPersonel.push(info);
            
            // BÃ¶lge mÃ¼dÃ¼rlerini ayÄ±r - TÃœM ÅŸubelerde gÃ¶rÃ¼necekler
            if (p.role === 'bolge_muduru') {
                bolgeMudurleri.push(info);
                console.log(`[BÃ¶lge MÃ¼dÃ¼rÃ¼] ${info.displayName} tÃ¼m ÅŸubelerde gÃ¶rÃ¼necek`);
            }
        });
        
        // Åžubelere gÃ¶re grupla
        const branches = [...new Set(allPersonel.map(p => p.branch))];
        const personelByBranch = {};
        
        branches.forEach(branch => {
            // Bu ÅŸubenin personeli + TÃœM bÃ¶lge mÃ¼dÃ¼rleri
            const branchPersonel = allPersonel.filter(p => p.branch === branch);
            
            // BÃ¶lge mÃ¼dÃ¼rlerini ekle (zaten bu ÅŸubede deÄŸilse)
            bolgeMudurleri.forEach(bm => {
                if (!branchPersonel.find(p => p.uniqueId === bm.uniqueId)) {
                    branchPersonel.push(bm);
                }
            });
            
            personelByBranch[branch] = branchPersonel;
        });
        
        // Her ÅŸube iÃ§in RÃœTBEYE GÃ–RE sÄ±rala
        const roleOrder = ['bolge_muduru', 'magaza_muduru', 'magaza_muduru_yardimcisi', 'kidemli_barista', 'barista', 'part_time'];
        Object.keys(personelByBranch).forEach(branch => {
            personelByBranch[branch].sort((a, b) => {
                const aRoleIdx = roleOrder.indexOf(a.role);
                const bRoleIdx = roleOrder.indexOf(b.role);
                const aIdx = aRoleIdx === -1 ? 100 : aRoleIdx;
                const bIdx = bRoleIdx === -1 ? 100 : bRoleIdx;
                return aIdx - bIdx;
            });
            console.log(`[SÄ±ralama] ${branch}:`, personelByBranch[branch].map(p => `${p.displayName}(${p.role})`).join(', '));
        });
        
        // TÃ¼m shift'leri gÃ¼ncelle
        const shiftsSnap = await db.collection('shifts').get();
        let updated = 0;
        
        for (const doc of shiftsSnap.docs) {
            const shift = doc.data();
            const branch = shift.branch;
            const orderedPersonel = personelByBranch[branch] || [];
            let personelShifts = shift.personelShifts || {};
            let personelNames = shift.personelNames || {};
            let personelFullNames = shift.personelFullNames || {};
            
            // BÃ¶lge mÃ¼dÃ¼rlerini shift'e ekle (yoksa)
            bolgeMudurleri.forEach(bm => {
                const key = bm.displayName;
                if (!personelShifts[key]) {
                    personelShifts[key] = {}; // BoÅŸ vardiya
                    personelNames[key] = bm.displayName;
                    personelFullNames[key] = bm.name;
                    console.log(`  âœ“ ${branch}: BÃ¶lge mÃ¼dÃ¼rÃ¼ "${key}" eklendi`);
                }
            });
            
            // Yeni sÄ±ralama oluÅŸtur
            const newOrder = [];
            const matched = new Set();
            
            // SÄ±ralÄ± listedeki her personel iÃ§in
            orderedPersonel.forEach(p => {
                const existingKey = Object.keys(personelShifts).find(key => {
                    if (matched.has(key)) return false;
                    
                    const keyNorm = normalizeTurkishChars(key);
                    const displayNorm = normalizeTurkishChars(p.displayName);
                    const codeNorm = normalizeTurkishChars(p.codeName);
                    const nameNorm = normalizeTurkishChars(p.name);
                    const uniqueNorm = normalizeTurkishChars(p.uniqueId);
                    
                    return keyNorm === displayNorm || 
                           keyNorm === codeNorm || 
                           keyNorm === nameNorm ||
                           keyNorm === uniqueNorm ||
                           key === p.displayName ||
                           key === p.codeName ||
                           key === p.name ||
                           key === p.uniqueId;
                });
                
                if (existingKey) {
                    newOrder.push(existingKey);
                    matched.add(existingKey);
                }
            });
            
            // SÄ±ralamada olmayan personeli EN SONA ekle
            Object.keys(personelShifts).forEach(key => {
                if (!newOrder.includes(key)) {
                    newOrder.push(key);
                }
            });
            
            // GÃ¼ncelle
            await db.collection('shifts').doc(doc.id).update({ 
                personelOrder: newOrder,
                personelShifts: personelShifts,
                personelNames: personelNames,
                personelFullNames: personelFullNames
            });
            updated++;
        }
        
        console.log(`[Migration] Shift sÄ±ralama: ${updated} gÃ¼ncellendi`);
        return { updated };
    } catch (e) {
        console.error('[Migration] Shift sÄ±ralama hatasÄ±:', e);
        return { updated: 0, error: e.message };
    }
}

// ANA MÄ°GRASYON FONKSÄ°YONU
async function fullSystemMigration() {
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('   ðŸš€ TAM SÄ°STEM MÄ°GRASYONU BAÅžLIYOR');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    
    const startTime = Date.now();
    
    // 0. Esin'i bÃ¶lge mÃ¼dÃ¼rÃ¼ yap (codeName "Esin Ä°." olan)
    console.log('[Migration] 0/4 BÃ¶lge mÃ¼dÃ¼rÃ¼ rol kontrolÃ¼...');
    try {
        const personelSnap = await db.collection('personel').get();
        for (const doc of personelSnap.docs) {
            const p = doc.data();
            // Esin Ä°. veya Merve Ä°lgar â†’ bolge_muduru
            if ((p.codeName && p.codeName.toLowerCase().includes('esin')) || 
                (p.name && p.name.toLowerCase().includes('merve') && p.name.toLowerCase().includes('ilgar'))) {
                if (p.role !== 'bolge_muduru') {
                    await db.collection('personel').doc(doc.id).update({ role: 'bolge_muduru' });
                    console.log(`  âœ“ ${p.name || p.codeName} â†’ bolge_muduru`);
                }
            }
        }
    } catch (e) {
        console.warn('[Migration] BÃ¶lge mÃ¼dÃ¼rÃ¼ rol hatasÄ±:', e);
    }
    
    // 1. Personel uniqueId
    const personelResult = await migratePersonelUniqueIds();
    
    // Cache'i sÄ±fÄ±rla
    _migrationPersonelMap = null;
    
    // 2. Shift verileri
    const shiftResult = await migrateShiftData();
    
    // 3. Eski puantajNotes temizle
    const notesResult = await cleanOldPuantajNotes();
    
    // 4. Shift sÄ±ralamasÄ±nÄ± dÃ¼zelt + bÃ¶lge mÃ¼dÃ¼rÃ¼nÃ¼ tÃ¼m ÅŸubelere ekle
    const orderResult = await fixShiftOrdering();
    
    const duration = ((Date.now() - startTime) / 1000).toFixed(1);
    
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('   âœ… MÄ°GRASYON TAMAMLANDI');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log(`   Personel: ${personelResult.updated} gÃ¼ncellendi`);
    console.log(`   Shift: ${shiftResult.updated} gÃ¼ncellendi`);
    console.log(`   PuantajNotes: ${notesResult.deleted} silindi`);
    console.log(`   SÄ±ralama: ${orderResult.updated} shift dÃ¼zeltildi`);
    console.log(`   SÃ¼re: ${duration} saniye`);
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    
    toast(`Migrasyon tamamlandÄ±! (${duration}s)`, 'success');
    
    // SayfayÄ± yenile
    setTimeout(() => {
        if (typeof loadPuantaj === 'function') loadPuantaj();
        if (typeof loadShiftWeek === 'function') loadShiftWeek();
    }, 1000);
    
    return { personelResult, shiftResult, notesResult, orderResult, duration };
}

// Console'dan Ã§aÄŸrÄ±labilir
window.migratePersonelUniqueIds = migratePersonelUniqueIds;
window.migrateShiftData = migrateShiftData;
window.cleanOldPuantajNotes = cleanOldPuantajNotes;
window.fixShiftOrdering = fixShiftOrdering;
window.fullSystemMigration = fullSystemMigration;
window.syncAllShiftPersonelNames = syncAllShiftPersonelNames; // Manuel senkronizasyon iÃ§in

// Ä°sim kÄ±saltma: "BÃœÅžRA SÃ–ÄžÃœT" â†’ "BÃ¼ÅŸra S."
function formatShortName(fullName) {
    if (!fullName) return '';
    const parts = fullName.trim().split(/\s+/);
    if (parts.length === 0) return '';
    
    // Ä°lk harf bÃ¼yÃ¼k, geri kalan kÃ¼Ã§Ã¼k
    const capitalize = (s) => s.charAt(0).toUpperCase() + s.slice(1).toLowerCase();
    
    if (parts.length === 1) {
        return capitalize(parts[0]);
    }
    
    // "Ä°sim S." formatÄ±
    const firstName = capitalize(parts[0]);
    const lastInitial = parts[parts.length - 1].charAt(0).toUpperCase();
    return `${firstName} ${lastInitial}.`;
}

// ==================== AUTH & SESSION ====================
let currentUser = null;

// ==================== GLOBAL PERSONEL CACHE (SENKRON) ====================
// Sayfa yÃ¼klendiÄŸinde doldurulur, her yerde kullanÄ±lÄ±r
let PERSONEL_DISPLAY_CACHE = new Map();

// Cache'i doldur (sayfa yÃ¼klendiÄŸinde Ã§aÄŸrÄ±lÄ±r)
async function loadPersonelDisplayCache() {
    try {
        const snapshot = await db.collection('personel').get();
        PERSONEL_DISPLAY_CACHE.clear();
        
        snapshot.forEach(doc => {
            const p = doc.data();
            const uniqueId = p.uniqueId || normalizePersonelId(p.name);
            // codeName varsa onu, yoksa formatDisplayName
            const displayName = (p.codeName && p.codeName.trim()) ? p.codeName.trim() : formatDisplayName(p.name);
            
            const info = { 
                displayName, 
                fullName: p.name, 
                codeName: p.codeName,
                uniqueId, 
                branch: p.branch 
            };
            
            // TÃ¼m olasÄ± key'leri ekle
            const keys = [
                p.name,
                p.name?.toLowerCase(),
                p.name?.toUpperCase(),
                p.codeName,
                p.codeName?.toLowerCase(),
                p.codeName?.toUpperCase(),
                p.codeName?.split(' ')[0],
                p.codeName?.split(' ')[0]?.toLowerCase(),
                p.codeName?.split(' ')[0]?.toUpperCase(),
                p.name?.split(' ')[0],
                p.name?.split(' ')[0]?.toLowerCase(),
                p.name?.split(' ')[0]?.toUpperCase(),
                uniqueId,
                normalizePersonelId(p.name),
                normalizePersonelId(p.codeName),
                normalizeTurkishChars(p.name),
                normalizeTurkishChars(p.codeName),
                normalizeTurkishChars(p.name?.split(' ')[0]),
                normalizeTurkishChars(p.codeName?.split(' ')[0]),
                formatDisplayName(p.name),
                formatDisplayName(p.name)?.toLowerCase(),
                formatDisplayName(p.name)?.toUpperCase(),
            ].filter(k => k);
            
            keys.forEach(key => {
                if (!PERSONEL_DISPLAY_CACHE.has(key)) {
                    PERSONEL_DISPLAY_CACHE.set(key, info);
                }
            });
        });
        
        console.log(`[Cache] Personel cache yÃ¼klendi: ${PERSONEL_DISPLAY_CACHE.size} key`);
    } catch (e) {
        console.error('[Cache] Personel cache yÃ¼klenemedi:', e);
    }
}

// Senkron lookup: herhangi bir isimden displayName al
function lookupPersonelDisplay(searchKey, branch = null) {
    if (!searchKey) return searchKey;
    
    // Cache'te ara
    let info = PERSONEL_DISPLAY_CACHE.get(searchKey) ||
               PERSONEL_DISPLAY_CACHE.get(searchKey?.toLowerCase()) ||
               PERSONEL_DISPLAY_CACHE.get(searchKey?.toUpperCase()) ||
               PERSONEL_DISPLAY_CACHE.get(normalizeTurkishChars(searchKey)) ||
               PERSONEL_DISPLAY_CACHE.get(normalizePersonelId(searchKey));
    
    // Branch filtresi
    if (info && branch && info.branch !== branch) {
        // Branch uyuÅŸmuyor, baÅŸka aday ara
        const candidates = [];
        PERSONEL_DISPLAY_CACHE.forEach((val, key) => {
            if (val.branch === branch && (
                key === searchKey || 
                key === searchKey?.toLowerCase() ||
                normalizeTurkishChars(key) === normalizeTurkishChars(searchKey)
            )) {
                candidates.push(val);
            }
        });
        if (candidates.length > 0) info = candidates[0];
    }
    
    return info ? info.displayName : searchKey;
}

// Cache'i temizle (yeni personel eklendiÄŸinde)
function refreshPersonelCache() {
    loadPersonelDisplayCache();
    // Arka planda shift'leri senkronize et
    syncAllShiftPersonelNames();
}

// ==================== OTOMATÄ°K SHIFT-PERSONEL SENKRONÄ°ZASYONU ====================
// Bu fonksiyon TÃœM shift'lerdeki personel isimlerini gÃ¼ncel personel verileriyle eÅŸleÅŸtirir
async function syncAllShiftPersonelNames() {
    if (!db) return;
    
    try {
        // 1. TÃ¼m personeli Ã§ek ve map oluÅŸtur
        const personelSnap = await db.collection('personel').get();
        const personelList = [];
        
        personelSnap.forEach(doc => {
            const p = doc.data();
            personelList.push({
                name: p.name,
                codeName: p.codeName,
                displayName: getPersonelDisplayName(p),
                uniqueId: p.uniqueId || normalizePersonelId(p.name),
                branch: p.branch,
                role: p.role
            });
        });
        
        // 2. TÃ¼m shift'leri Ã§ek - SADECE SON 2 HAFTA (tarihsel stabilite iÃ§in)
        const shiftsSnap = await db.collection('shifts').get();
        let totalUpdated = 0;
        let skippedOld = 0;
        
        // Son 2 haftanÄ±n baÅŸlangÄ±Ã§ tarihi
        const twoWeeksAgo = new Date();
        twoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);
        const twoWeeksAgoStr = twoWeeksAgo.toISOString().split('T')[0];
        
        for (const shiftDoc of shiftsSnap.docs) {
            const shift = shiftDoc.data();
            const shiftBranch = shift.branch;
            const personelShifts = shift.personelShifts || {};
            const currentNames = shift.personelNames || {};
            const currentFullNames = shift.personelFullNames || {};
            
            // TARÄ°HSEL STABÄ°LÄ°TE: 2 haftadan eski shiftleri ATLÃ
            const weekStart = shift.weekStart || '';
            if (weekStart && weekStart < twoWeeksAgoStr) {
                skippedOld++;
                continue; // Eski shift - dokunma
            }
            
            let newNames = { ...currentNames };
            let newFullNames = { ...currentFullNames };
            let needsUpdate = false;
            
            // 3. Her key iÃ§in doÄŸru personeli bul
            for (const key of Object.keys(personelShifts)) {
                const keyLower = key.toLowerCase();
                const keyNorm = normalizeTurkishChars(key);
                
                // Ã–nce aynÄ± ÅŸubeden ara, sonra bÃ¶lge mÃ¼dÃ¼rlerinden
                let matchedPersonel = null;
                
                // Ã–ncelik 1: AynÄ± ÅŸubeden + tam eÅŸleÅŸme (SADECE TAM EÅžLEÅžME)
                matchedPersonel = personelList.find(p => {
                    if (p.branch !== shiftBranch && p.role !== 'bolge_muduru') return false;
                    
                    const pDisplayNorm = normalizeTurkishChars(p.displayName);
                    const pCodeNorm = normalizeTurkishChars(p.codeName || '');
                    const pNameNorm = normalizeTurkishChars(p.name);
                    const pUniqueNorm = normalizeTurkishChars(p.uniqueId);
                    
                    // Tam eÅŸleÅŸmeler
                    if (key === p.displayName || key === p.codeName || key === p.name || key === p.uniqueId) return true;
                    if (keyLower === p.uniqueId) return true;
                    if (keyNorm === pDisplayNorm || keyNorm === pCodeNorm || keyNorm === pNameNorm || keyNorm === pUniqueNorm) return true;
                    
                    // BÃœYÃœK/KÃœÃ‡ÃœK HARF FARKI Ä°Ã‡Ä°N
                    if (key.toUpperCase() === p.displayName?.toUpperCase()) return true;
                    if (key.toUpperCase() === p.codeName?.toUpperCase()) return true;
                    
                    return false;
                });
                
                // Ã–ncelik 2: fullName eÅŸleÅŸmesi (TAM EÅžLEÅžme - ilk isim eÅŸleÅŸmesi KALDIRILDI)
                if (!matchedPersonel && currentFullNames[key]) {
                    const currentFullNorm = normalizeTurkishChars(currentFullNames[key]);
                    matchedPersonel = personelList.find(p => {
                        if (p.branch !== shiftBranch && p.role !== 'bolge_muduru') return false;
                        const pNameNorm = normalizeTurkishChars(p.name);
                        // SADECE TAM EÅžLEÅžME - ilk isim eÅŸleÅŸmesi KALDIRILDI (Ã§akÄ±ÅŸma riski)
                        return pNameNorm === currentFullNorm;
                    });
                }
                
                // Ã–NCELÄ°K 3 KALDIRILDI: Ä°lk isim eÅŸleÅŸmesi artÄ±k yapÄ±lmÄ±yor
                // Bu, aynÄ± isimli farklÄ± kiÅŸilerin Ã§akÄ±ÅŸmasÄ±nÄ± Ã¶nler
                // EÄŸer tam eÅŸleÅŸme bulunamazsa, mevcut deÄŸerler korunur
                
                if (matchedPersonel) {
                    // GÃ¼ncelleme gerekli mi kontrol et
                    if (newNames[key] !== matchedPersonel.displayName || newFullNames[key] !== matchedPersonel.name) {
                        console.log(`[Senkron] ${shiftBranch}: "${key}" â†’ "${matchedPersonel.displayName}" (${matchedPersonel.name})`);
                        newNames[key] = matchedPersonel.displayName;
                        newFullNames[key] = matchedPersonel.name;
                        needsUpdate = true;
                    }
                }
                // else: EÅŸleÅŸme bulunamadÄ± - mevcut deÄŸerler korunur (log yok, sessiz)
            }
            
            // 4. GÃ¼ncelleme gerekiyorsa kaydet
            if (needsUpdate) {
                await db.collection('shifts').doc(shiftDoc.id).update({
                    personelNames: newNames,
                    personelFullNames: newFullNames
                });
                totalUpdated++;
            }
        }
        
        if (totalUpdated > 0 || skippedOld > 0) {
            console.log(`[Senkron] âœ“ ${totalUpdated} shift gÃ¼ncellendi, ${skippedOld} eski shift atlandÄ± (tarihsel stabilite)`);
        } else {
            console.log(`[Senkron] âœ“ TÃ¼m shift'ler gÃ¼ncel`);
        }
    } catch (e) {
        console.warn('[Senkron] Hata:', e.message);
    }
}

// ==================== ONE-SHOT SHIFT REPAIR ====================
// Bu fonksiyon geÃ§miÅŸte yanlÄ±ÅŸ eÅŸleÅŸmiÅŸ shift verilerini tamir eder
// SADECE exact uniqueId match kullanÄ±r - fuzzy match YOK
// Parametreler:
//   - monthsBack: kaÃ§ ay geriye git (varsayÄ±lan 12)
//   - dryRun: true ise sadece log Ã¼ret, yazma yapma (varsayÄ±lan true)
//   - branch: belirli ÅŸube (null ise tÃ¼mÃ¼)
window.repairShiftPersonelNames = async function(monthsBack = 12, dryRun = true, branch = null) {
    if (!db) {
        console.error('[Repair] Firestore baÄŸlantÄ±sÄ± yok!');
        return;
    }
    
    console.log(`\n========== SHIFT PERSONEL REPAIR ==========`);
    console.log(`Mod: ${dryRun ? 'ðŸ” DRY-RUN (yazma yok)' : 'âš ï¸ GERÃ‡EK YAZMA'}`);
    console.log(`Kapsam: Son ${monthsBack} ay`);
    console.log(`Åžube: ${branch || 'TÃ¼mÃ¼'}`);
    console.log(`==========================================\n`);
    
    try {
        // 1. Personel listesini Ã§ek ve uniqueId bazlÄ± map oluÅŸtur
        const personelSnap = await db.collection('personel').get();
        const personelByUniqueId = new Map();
        const personelByFullName = new Map();
        
        personelSnap.forEach(doc => {
            const p = doc.data();
            const uniqueId = p.uniqueId || normalizePersonelId(p.name);
            const displayName = getPersonelDisplayName(p);
            const fullName = p.name;
            
            const info = { uniqueId, displayName, fullName, branch: p.branch, role: p.role };
            
            // uniqueId ile index
            personelByUniqueId.set(uniqueId, info);
            personelByUniqueId.set(uniqueId.toLowerCase(), info);
            personelByUniqueId.set(normalizeTurkishChars(uniqueId), info);
            
            // fullName ile index (exact match iÃ§in)
            personelByFullName.set(fullName, info);
            personelByFullName.set(fullName?.toLowerCase(), info);
            personelByFullName.set(normalizeTurkishChars(fullName), info);
        });
        
        console.log(`[Repair] ${personelByUniqueId.size / 3} personel yÃ¼klendi`);
        
        // 2. Tarih filtresi hesapla
        const cutoffDate = new Date();
        cutoffDate.setMonth(cutoffDate.getMonth() - monthsBack);
        const cutoffStr = cutoffDate.toISOString().split('T')[0];
        console.log(`[Repair] Cutoff tarihi: ${cutoffStr}`);
        
        // 3. Shift'leri Ã§ek
        let query = db.collection('shifts');
        if (branch) {
            query = query.where('branch', '==', branch);
        }
        const shiftsSnap = await query.get();
        
        let totalShifts = 0;
        let repairedShifts = 0;
        let skippedOld = 0;
        let totalKeysFixed = 0;
        let totalKeysNotFound = 0;
        const notFoundKeys = [];
        
        for (const shiftDoc of shiftsSnap.docs) {
            const shift = shiftDoc.data();
            const shiftBranch = shift.branch;
            const weekStart = shift.weekStart || '';
            
            // Tarih filtresi
            if (weekStart && weekStart < cutoffStr) {
                skippedOld++;
                continue;
            }
            
            totalShifts++;
            const personelShifts = shift.personelShifts || {};
            const currentNames = shift.personelNames || {};
            const currentFullNames = shift.personelFullNames || {};
            
            let newNames = {};
            let newFullNames = {};
            let hasChanges = false;
            let keysFixed = 0;
            let keysNotFound = 0;
            
            // Her key iÃ§in SADECE exact uniqueId match
            for (const key of Object.keys(personelShifts)) {
                const keyLower = key.toLowerCase();
                const keyNorm = normalizeTurkishChars(key);
                
                // Exact uniqueId match
                let matched = personelByUniqueId.get(key) || 
                              personelByUniqueId.get(keyLower) ||
                              personelByUniqueId.get(keyNorm);
                
                // Åžube kontrolÃ¼
                if (matched && matched.branch !== shiftBranch && matched.role !== 'bolge_muduru') {
                    matched = null; // Åžube uyuÅŸmuyor
                }
                
                if (matched) {
                    newNames[key] = matched.displayName;
                    newFullNames[key] = matched.fullName;
                    
                    // DeÄŸiÅŸiklik var mÄ±?
                    if (currentNames[key] !== matched.displayName || currentFullNames[key] !== matched.fullName) {
                        hasChanges = true;
                        keysFixed++;
                        console.log(`  [FIX] ${shiftBranch} ${weekStart}: "${key}" â†’ "${matched.displayName}" (${matched.fullName})`);
                    }
                } else {
                    // BulunamadÄ± - mevcut deÄŸerleri koru
                    newNames[key] = currentNames[key] || key;
                    newFullNames[key] = currentFullNames[key] || key;
                    keysNotFound++;
                    
                    if (!currentNames[key] || currentNames[key] === key) {
                        notFoundKeys.push({ branch: shiftBranch, week: weekStart, key });
                        console.warn(`  [NOT FOUND] ${shiftBranch} ${weekStart}: "${key}" - mevcut deÄŸer korunuyor`);
                    }
                }
            }
            
            totalKeysFixed += keysFixed;
            totalKeysNotFound += keysNotFound;
            
            // GÃ¼ncelleme
            if (hasChanges) {
                repairedShifts++;
                if (!dryRun) {
                    await db.collection('shifts').doc(shiftDoc.id).update({
                        personelNames: newNames,
                        personelFullNames: newFullNames
                    });
                    console.log(`  âœ“ ${shiftBranch} ${weekStart} gÃ¼ncellendi (${keysFixed} key)`);
                } else {
                    console.log(`  [DRY-RUN] ${shiftBranch} ${weekStart} gÃ¼ncellenecek (${keysFixed} key)`);
                }
            }
        }
        
        // Ã–zet rapor
        console.log(`\n========== REPAIR SONUÃ‡ ==========`);
        console.log(`Taranan shift: ${totalShifts}`);
        console.log(`Atlanan (eski): ${skippedOld}`);
        console.log(`Tamir edilen shift: ${repairedShifts}`);
        console.log(`DÃ¼zeltilen key: ${totalKeysFixed}`);
        console.log(`Bulunamayan key: ${totalKeysNotFound}`);
        console.log(`Mod: ${dryRun ? 'DRY-RUN (deÄŸiÅŸiklik yapÄ±lmadÄ±)' : 'GERÃ‡EK YAZMA'}`);
        
        if (notFoundKeys.length > 0 && notFoundKeys.length <= 20) {
            console.log(`\nBulunamayan key'ler:`);
            notFoundKeys.forEach(nf => console.log(`  - ${nf.branch} ${nf.week}: "${nf.key}"`));
        } else if (notFoundKeys.length > 20) {
            console.log(`\nBulunamayan key sayÄ±sÄ± Ã§ok fazla (${notFoundKeys.length}), ilk 20:`);
            notFoundKeys.slice(0, 20).forEach(nf => console.log(`  - ${nf.branch} ${nf.week}: "${nf.key}"`));
        }
        
        console.log(`==================================\n`);
        
        if (dryRun && repairedShifts > 0) {
            console.log(`ðŸ’¡ DeÄŸiÅŸiklikleri uygulamak iÃ§in: repairShiftPersonelNames(${monthsBack}, false${branch ? `, '${branch}'` : ''})`);
        }
        
        return { totalShifts, repairedShifts, totalKeysFixed, totalKeysNotFound, notFoundKeys };
        
    } catch (e) {
        console.error('[Repair] Hata:', e);
        throw e;
    }
};

// VarsayÄ±lan puantaj kurallarÄ±
const DEFAULT_PUANTAJ_RULES = [
    { id: 'R01', title: '5x "1 YÄ±ldÄ±z"', effect: 'prim_yok', desc: 'AynÄ± ay iÃ§inde 5 kez 1 yÄ±ldÄ±z alan personel prim hakkÄ±nÄ± kaybeder' },
    { id: 'R02', title: 'Online â‰¤2 YÄ±ldÄ±z', effect: '-1', desc: 'Online platformlarda (Google, Yemeksepeti vb.) 2 veya altÄ± yÄ±ldÄ±z alÄ±nmasÄ±' },
    { id: 'R03', title: 'Mazeretsiz DevamsÄ±zlÄ±k', effect: '-2', desc: 'Mazeretsiz devamsÄ±zlÄ±k yapÄ±lmasÄ±' },
    { id: 'R04', title: 'MÃ¼ÅŸteri Åžikayeti', effect: '-1', desc: 'DoÄŸrulanmÄ±ÅŸ mÃ¼ÅŸteri ÅŸikayeti' }
];

// ==================== DEFAULT STATE ====================
const DEFAULT_STATE = {
    company: {
        name: 'TAMASLAN KAFE RESTORAN VE GIDA HÄ°ZMETLERÄ° SANAYÄ° Ä°Ã‡ VE DIÅž TÄ°CARET LÄ°MÄ°TED ÅžÄ°RKETÄ°',
        short: 'MOONBERRY COFFEE',
        mersis: '0817072351000001',
        address: 'DUATEPE MAH. ERGENEKON CAD. KONAK APT NO: 109 C ÅžÄ°ÅžLÄ° / Ä°STANBUL',
        tel: '+90 533 486 63 66',
        email: 'info@moonberrycoffee.com',
        vergiNo: '8170723510',
        vergiDairesi: 'ÅžiÅŸli',
        kep: 'tamaslan@hs01.kep.tr'
    },
    branches: ['Tuzla TRC', 'ÅžiÅŸli (Merkez)'],
    branchCodes: {'ÅžiÅŸli (Merkez)': 'SIS', 'Tuzla TRC': 'TZL'},
    positions: [
        {id: 'barista', name: 'Barista / Servis', type: 'Mavi Yaka', role: 'barista', icon: 'ðŸ§‘â€ðŸ³'},
        {id: 'mudur_yardimcisi', name: 'MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±', type: 'Gri Yaka', role: 'mudur_yardimcisi', icon: 'ðŸ‘”'},
        {id: 'magaza_muduru', name: 'MaÄŸaza MÃ¼dÃ¼rÃ¼', type: 'Beyaz Yaka', role: 'magaza_muduru', icon: 'ðŸª'},
        {id: 'bolge_muduru', name: 'BÃ¶lge MÃ¼dÃ¼rÃ¼', type: 'Stratejik', role: 'bolge_muduru', icon: 'ðŸŒ'}
    ],
    violations: [
        {id:'V01',title:'Telefon KullanÄ±mÄ±',risk:'low',legal:'Ä°ÅŸ K. 25/II-h',steps:['SÃ¶zlÃ¼ uyarÄ±','YazÄ±lÄ± uyarÄ±','Ä°htar'],desc:'Mesai saatinde telefon kullanÄ±mÄ±'},
        {id:'V02',title:'GeÃ§ Kalma (<30dk)',risk:'low',legal:'Ä°ÅŸ K. 25/II-h',steps:['SÃ¶zlÃ¼ uyarÄ±','Tekrarda yazÄ±lÄ±','Ä°htar'],desc:'30 dakika altÄ± geÃ§ kalma'},
        {id:'V03',title:'GeÃ§ Kalma (>30dk)',risk:'medium',legal:'Ä°ÅŸ K. 25/II-g',steps:['Tutanak','Savunma','Ä°htar','Fesih'],desc:'30 dakika Ã¼stÃ¼ geÃ§ kalma'},
        {id:'V04',title:'1 GÃ¼n DevamsÄ±zlÄ±k',risk:'medium',legal:'Ä°ÅŸ K. 25/II-g',steps:['Tutanak','Savunma','Ä°htar'],desc:'Mazeretsiz 1 gÃ¼n devamsÄ±zlÄ±k'},
        {id:'V05',title:'2+ GÃ¼n DevamsÄ±zlÄ±k',risk:'high',legal:'Ä°ÅŸ K. 25/II-g',steps:['Her gÃ¼n tutanak','Savunma','6 iÅŸ gÃ¼nÃ¼ iÃ§inde fesih'],desc:'ArdÄ± ardÄ±na 2+ gÃ¼n mazeretsiz devamsÄ±zlÄ±k - HaklÄ± fesih sebebi'},
        {id:'V06',title:'Kasa AÃ§Ä±ÄŸÄ±',risk:'medium',legal:'TBK 407',steps:['SayÄ±m tutanaÄŸÄ±','Savunma','BorÃ§ Ä°krar'],desc:'Kasada nakit eksikliÄŸi tespit edilmesi'},
        {id:'V07',title:'ÃœrÃ¼n GÃ¶tÃ¼rme',risk:'high',legal:'Ä°ÅŸ K. 25/II-e',steps:['Tutanak','Kamera kayÄ±t','Savunma','Fesih'],desc:'Ä°zinsiz Ã¼rÃ¼n gÃ¶tÃ¼rme - GÃ¼veni kÃ¶tÃ¼ye kullanma'},
        {id:'V08',title:'MÃ¼ÅŸteriye Hakaret',risk:'high',legal:'Ä°ÅŸ K. 25/II-d',steps:['Tutanak','Åžikayet kaydÄ±','Savunma','Fesih'],desc:'MÃ¼ÅŸteriye kaba davranÄ±ÅŸ veya hakaret'},
        {id:'V09',title:'Ä°ÅŸyerinde Kavga',risk:'high',legal:'Ä°ÅŸ K. 25/II-d',steps:['Ä°ki taraf tutanak','Åžahit ifadeleri','Savunma','Fesih'],desc:'Ä°ÅŸyerinde fiziksel veya sÃ¶zlÃ¼ kavga'},
        {id:'V10',title:'Hijyen Ä°hlali',risk:'high',legal:'Ä°ÅŸ K. 25/II-Ä±',steps:['Tutanak','Savunma','Derhal fesih'],desc:'El yÄ±kamama, SKT ihlali, Ã§apraz bulaÅŸma'},
        {id:'V11',title:'Alkol/UyuÅŸturucu',risk:'high',legal:'Ä°ÅŸ K. 25/II-d',steps:['Tutanak (2 ÅŸahit)','Derhal fesih'],desc:'Ä°ÅŸe alkollÃ¼ veya uyuÅŸturucu etkisinde gelme'},
        {id:'V12',title:'Ä°ÅŸ Reddi',risk:'medium',legal:'Ä°ÅŸ K. 25/II-h',steps:['Tutanak','Savunma','Ä°htar','Fesih'],desc:'Verilen gÃ¶revi reddetme - "Benim iÅŸim deÄŸil" tutumu'},
        {id:'V13',title:'Ticari SÄ±r Ä°fÅŸasÄ±',risk:'high',legal:'TCK 239',steps:['Delil toplama','Tutanak','Fesih + SuÃ§ duyurusu'],desc:'ReÃ§ete, maliyet, tedarikÃ§i bilgisi paylaÅŸÄ±mÄ±'},
        {id:'V14',title:'Sosyal Medya Ä°hlali',risk:'medium',legal:'Ä°ÅŸ K. 25/II-b',steps:['Ekran gÃ¶rÃ¼ntÃ¼sÃ¼','Tutanak','Savunma'],desc:'Ä°ÅŸveren aleyhine sosyal medya paylaÅŸÄ±mÄ±'},
        {id:'V15',title:'Ä°mzadan Ä°mtina',risk:'low',legal:'YargÄ±tay iÃ§tihatÄ±',steps:['Ä°mtina tutanaÄŸÄ±','2 ÅŸahit imzasÄ±'],desc:'Belge imzalamaktan kaÃ§Ä±nma'},
        {id:'V16',title:'KÄ±lÄ±k KÄ±yafet',risk:'low',legal:'Ä°ÅŸ K. 25/II-h',steps:['SÃ¶zlÃ¼ uyarÄ±','YazÄ±lÄ± uyarÄ±','Ä°htar'],desc:'Ãœniforma giymeme veya uygunsuz kÄ±yafet'},
        {id:'V17',title:'DemirbaÅŸ HasarÄ±',risk:'medium',legal:'TBK 407',steps:['Hasar tutanaÄŸÄ±','Savunma','BorÃ§ Ä°krar'],desc:'POS, tablet, ekipman hasarÄ±'},
        {id:'V18',title:'Yetkisiz Ä°ndirim',risk:'high',legal:'Ä°ÅŸ K. 25/II-e',steps:['POS kaydÄ± kontrolÃ¼','Tutanak','Fesih'],desc:'Ä°zinsiz Ã¼cretsiz Ã¼rÃ¼n verme veya indirim yapma'},
        {id:'V19',title:'HÄ±rsÄ±zlÄ±k',risk:'high',legal:'Ä°ÅŸ K. 25/II-e + TCK 141',steps:['Tutanak','Kamera kayÄ±t','Kolluk bildirimi','Derhal fesih + SuÃ§ duyurusu'],desc:'Ä°ÅŸyerinden para, Ã¼rÃ¼n veya malzeme Ã§alma'},
        {id:'V20',title:'Zimmet',risk:'high',legal:'TCK 247',steps:['Mali denetim','Tutanak','Fesih + SuÃ§ duyurusu'],desc:'Kendisine tevdi edilen ÅŸirket malÄ±nÄ± sahiplenme'},
        {id:'V21',title:'Sahte Belge',risk:'high',legal:'TCK 204 + Ä°ÅŸ K. 25/II-a',steps:['Belge incelemesi','Tutanak','Fesih + SuÃ§ duyurusu'],desc:'Sahte rapor, diploma veya evrak sunma'},
        {id:'V22',title:'Ä°zinsiz Ä°ÅŸten AyrÄ±lma',risk:'high',legal:'Ä°ÅŸ K. 25/II-g',steps:['DevamsÄ±zlÄ±k tutanaÄŸÄ±','Noter ihtarÄ±','Fesih'],desc:'Haber vermeden iÅŸi terk etme'},
        {id:'V23',title:'Cinsel Taciz',risk:'high',legal:'Ä°ÅŸ K. 25/II-c + TCK 105',steps:['Åžikayet kaydÄ±','Ä°fade alma','Fesih + SuÃ§ duyurusu'],desc:'Ä°ÅŸyerinde cinsel taciz'},
        {id:'V24',title:'SÃ¶zlÃ¼ Taciz',risk:'medium',legal:'Ä°ÅŸ K. 25/II-d',steps:['Tutanak','Åžahit ifadeleri','Savunma','Fesih'],desc:'SÃ¶zlÃ¼ sarkÄ±ntÄ±lÄ±k, uygunsuz espri veya laf atma'},
        {id:'V25',title:'Tehdit',risk:'high',legal:'Ä°ÅŸ K. 25/II-d + TCK 106',steps:['Tutanak','Åžahit ifadeleri','Fesih + SuÃ§ duyurusu'],desc:'Ä°ÅŸ arkadaÅŸÄ± veya yÃ¶neticiye tehdit'},
        {id:'V26',title:'Mobbing Uygulama',risk:'high',legal:'Ä°ÅŸ K. 25/II-d + TBK 417',steps:['Åžikayet kaydÄ±','SoruÅŸturma','Savunma','Fesih'],desc:'Sistematik psikolojik baskÄ± uygulama'},
        {id:'V27',title:'GÃ¼venlik KuralÄ± Ä°hlali',risk:'high',legal:'Ä°ÅŸ K. 25/II-Ä±',steps:['Tutanak','Savunma','Ä°htar veya Fesih'],desc:'Ä°ÅŸ gÃ¼venliÄŸi kurallarÄ±nÄ± ihlal etme'},
        {id:'V28',title:'YangÄ±n GÃ¼venliÄŸi Ä°hlali',risk:'high',legal:'Ä°ÅŸ K. 25/II-Ä±',steps:['Tutanak','Savunma','Derhal fesih'],desc:'YangÄ±n Ã§Ä±kÄ±ÅŸÄ±nÄ± engelleme, yangÄ±n sÃ¶ndÃ¼rÃ¼cÃ¼ ile oynama'},
        {id:'V29',title:'Ä°ÅŸ KazasÄ± Gizleme',risk:'high',legal:'5510 SK + Ä°ÅŸ K. 25/II',steps:['Tutanak','SGK bildirimi','Savunma','Fesih'],desc:'Ä°ÅŸ kazasÄ±nÄ± bildirmeme veya gizleme'},
        {id:'V30',title:'MÃ¼ÅŸteri Verisi PaylaÅŸma',risk:'high',legal:'KVKK + Ä°ÅŸ K. 25/II-e',steps:['Delil toplama','Tutanak','Fesih'],desc:'MÃ¼ÅŸteri bilgilerini izinsiz paylaÅŸma'},
        {id:'V31',title:'RÃ¼ÅŸvet/Komisyon',risk:'high',legal:'TCK 252 + Ä°ÅŸ K. 25/II-e',steps:['Delil toplama','Tutanak','Fesih + SuÃ§ duyurusu'],desc:'TedarikÃ§i veya mÃ¼ÅŸteriden rÃ¼ÅŸvet/komisyon alma'},
        {id:'V32',title:'Rakiple Ä°ÅŸbirliÄŸi',risk:'high',legal:'TBK 396 + Ä°ÅŸ K. 25/II-e',steps:['Delil toplama','Tutanak','Fesih'],desc:'Rakip firma ile gizli iÅŸbirliÄŸi'},
        {id:'V33',title:'Dedikodu/Fitne',risk:'low',legal:'Ä°ÅŸ K. 25/II-d',steps:['SÃ¶zlÃ¼ uyarÄ±','Tutanak','Savunma','Ä°htar'],desc:'Ä°ÅŸyeri huzurunu bozucu dedikodu yayma'},
        {id:'V34',title:'Mal Kabul UsulsÃ¼zlÃ¼ÄŸÃ¼',risk:'high',legal:'Ä°ÅŸ K. 25/II-e',steps:['Stok kontrolÃ¼','Tutanak','Fesih'],desc:'Teslim alÄ±nmayan malÄ± kabul etmiÅŸ gibi gÃ¶sterme'},
        {id:'V35',title:'EÄŸitime KatÄ±lmama',risk:'low',legal:'Ä°ÅŸ K. 25/II-h',steps:['SÃ¶zlÃ¼ uyarÄ±','YazÄ±lÄ± uyarÄ±','Ä°htar'],desc:'Zorunlu eÄŸitimlere mazeretsiz katÄ±lmama'},
        {id:'V36',title:'Ä°zinsiz FotoÄŸraf/Video',risk:'medium',legal:'KVKK + Ä°ÅŸ K. 25/II-e',steps:['Tutanak','Savunma','Ä°htar veya Fesih'],desc:'Ä°ÅŸyerinde izinsiz fotoÄŸraf veya video Ã§ekme'},
        {id:'V37',title:'Mesai Saati ManipÃ¼lasyonu',risk:'high',legal:'Ä°ÅŸ K. 25/II-e',steps:['PDKS kaydÄ±','Tutanak','Fesih'],desc:'GiriÅŸ-Ã§Ä±kÄ±ÅŸ saatlerini manipÃ¼le etme'},
        {id:'V38',title:'Sahte Mazeret',risk:'medium',legal:'Ä°ÅŸ K. 25/II-a',steps:['Belge doÄŸrulama','Tutanak','Savunma','Fesih'],desc:'GerÃ§ek dÄ±ÅŸÄ± mazeret beyan etme'}
    ],
    templates: {
        barista: `<div class="doc-article"><div class="doc-article-title">MADDE 2: GÃ–REV TANIMI, YETKÄ° VE SORUMLULUKLAR</div><div class="doc-article-content">
<p><strong>2.1. Pozisyonun NiteliÄŸi:</strong> Personel, iÅŸletmede "BARÄ°STA VE MAÄžAZA OPERASYON SORUMLUSU" unvanÄ± ile istihdam edilmiÅŸtir. Taraflar, bu pozisyonun doÄŸasÄ± gereÄŸi sadece iÃ§ecek hazÄ±rlamayÄ± deÄŸil; maÄŸazanÄ±n genel dÃ¼zenini, hijyenini, lojistiÄŸini ve operasyonel akÄ±ÅŸÄ±nÄ± saÄŸlamayÄ± kapsayan bÃ¼tÃ¼nleÅŸik bir gÃ¶rev olduÄŸu konusunda mutabÄ±ktÄ±r.</p>
<p><strong>2.2. Asli GÃ¶revler (Ã‡ok YÃ¶nlÃ¼ Ã‡alÄ±ÅŸma TaahhÃ¼dÃ¼):</strong> Personel, aÅŸaÄŸÄ±da belirtilen gÃ¶revlerin iÅŸ tanÄ±mÄ±nÄ±n asli unsurlarÄ± olduÄŸunu, bu gÃ¶revlerin kendisinden talep edilmesinin 4857 sayÄ±lÄ± Ä°ÅŸ Kanunu'nun 22. maddesi kapsamÄ±nda "Ã§alÄ±ÅŸma koÅŸullarÄ±nda esaslÄ± deÄŸiÅŸiklik" sayÄ±lmayacaÄŸÄ±nÄ± peÅŸinen kabul ve taahhÃ¼t eder:</p>
<p>a) <strong>Ãœretim ve Servis:</strong> Ä°ÅŸletmenin standart reÃ§etelerine (gramaj, Ä±sÄ±, sunum) birebir uyarak kahve, soÄŸuk/sÄ±cak iÃ§ecek ve yiyecek hazÄ±rlamak; mÃ¼ÅŸteriyi karÅŸÄ±lamak, sipariÅŸ almak, masaya servis yapmak ve boÅŸlarÄ± toplamak.</p>
<p>b) <strong>Sanitasyon ve Temizlik:</strong> GÄ±da gÃ¼venliÄŸi (HACCP) ve iÅŸletme standartlarÄ± gereÄŸi; bar istasyonu, espresso makinesi, mÃ¼ÅŸteri masalarÄ±, zeminler, depo alanlarÄ±, camlar ve maÄŸaza tuvaletlerinin (WC) hijyen planÄ±na uygun olarak periyodik temizliÄŸini, dezenfeksiyonunu ve kontrolÃ¼nÃ¼ bizzat yapmak.</p>
<p>c) <strong>Lojistik ve Stok:</strong> Mal kabulÃ¼ yapmak, kolileri taÅŸÄ±mak, raflarÄ± dÃ¼zenlemek, FIFO (Ä°lk Giren Ä°lk Ã‡Ä±kar) kuralÄ±na gÃ¶re stok takibi ve Son Kullanma Tarihi (SKT) kontrollerini gerÃ§ekleÅŸtirmek.</p>
<p>d) <strong>Destek Hizmetleri (Kurye/Valet):</strong> Ä°ÅŸverenin talep etmesi ve Personelin gerekli yasal ehliyet ve yetkinlik belgelerine (SÃ¼rÃ¼cÃ¼ Belgesi, SRC, Psikoteknik vb.) sahip olmasÄ± kaydÄ±yla; paket servis lojistiÄŸi ve otopark dÃ¼zeni konularÄ±nda destek vermek. Personel, bu gÃ¶revleri ifa ederken KarayollarÄ± Trafik Kanunu'na ve Ä°SG kurallarÄ±na tam uyum saÄŸlamakla yÃ¼kÃ¼mlÃ¼dÃ¼r.</p>
<p><strong>2.3. Nakil Yetkisi:</strong> Ä°ÅŸveren, operasyonel gereklilikler halinde Personel'i, aynÄ± il sÄ±nÄ±rlarÄ± iÃ§erisindeki mevcut veya ileride aÃ§Ä±lacak diÄŸer "Moonberry Coffee" ÅŸubelerinde, unvanÄ± ve Ã¼creti korunmak kaydÄ±yla geÃ§ici veya sÃ¼rekli olarak gÃ¶revlendirme hakkÄ±na sahiptir. Personel, bu deÄŸiÅŸikliÄŸi peÅŸinen kabul eder.</p>
</div></div>

<div class="doc-article"><div class="doc-article-title">MADDE 3: Ã‡ALIÅžMA SÃœRESÄ°, FAZLA MESAÄ° VE ÃœCRET</div><div class="doc-article-content">
<p><strong>3.1. Ã‡alÄ±ÅŸma SÃ¼resi:</strong> HaftalÄ±k Ã§alÄ±ÅŸma sÃ¼resi yasal sÄ±nÄ±r olan 45 saattir. Ä°ÅŸveren, bu sÃ¼reyi iÅŸyerinin aÃ§Ä±lÄ±ÅŸ-kapanÄ±ÅŸ saatlerine ve yoÄŸunluÄŸuna gÃ¶re, gÃ¼nde 11 saati aÅŸmamak kaydÄ±yla haftanÄ±n Ã§alÄ±ÅŸÄ±lan gÃ¼nlerine farklÄ± ÅŸekillerde bÃ¶lebilir. Ä°ÅŸveren, Ä°ÅŸ Kanunu m. 63 uyarÄ±nca 2 (iki) aylÄ±k sÃ¼reler iÃ§inde "DenkleÅŸtirme" uygulayabilir.</p>
<p><strong>3.2. Ãœcret ve Fazla Mesai (YÄ±llÄ±k 270 Saat Dahil):</strong></p>
<p>a) Personelin aylÄ±k maktu brÃ¼t Ã¼creti {{UCRET}} TL'dir.</p>
<p>b) Belirlenen bu Ã¼cret, yasal asgari Ã¼cretin Ã¼zerinde (emsal Ã¼cret) tespit edilmiÅŸtir. Taraflar; Ä°ÅŸ Kanunu'nun 41. maddesi uyarÄ±nca yapÄ±labilecek yÄ±llÄ±k 270 saate kadar olan fazla Ã§alÄ±ÅŸmalarÄ±n ile ulusal bayram ve genel tatil gÃ¼nlerindeki Ã§alÄ±ÅŸmalarÄ±n karÅŸÄ±lÄ±ÄŸÄ±nÄ±n, kararlaÅŸtÄ±rÄ±lan bu aylÄ±k Ã¼crete dahil olduÄŸu hususunda mutabÄ±k kalmÄ±ÅŸlardÄ±r.</p>
<p>c) Personel, yÄ±llÄ±k 270 saati aÅŸmayan bu Ã§alÄ±ÅŸmalar iÃ§in aylÄ±k maaÅŸÄ± dÄ±ÅŸÄ±nda ayrÄ±ca bir fazla mesai Ã¼creti talep etmeyeceÄŸini beyan eder.</p>
<p>d) YÄ±llÄ±k 270 saati aÅŸan fazla Ã§alÄ±ÅŸmalarÄ±n Ã¼creti, Ä°ÅŸ Kanunu hÃ¼kÃ¼mleri uyarÄ±nca ayrÄ±ca Ã¶denir veya mevzuata uygun olarak serbest zaman ÅŸeklinde kullandÄ±rÄ±lÄ±r.</p>
</div></div>

<div class="doc-article"><div class="doc-article-title">MADDE 4: KASA TAZMÄ°NATI VE AÃ‡IKLAR (TBK m. 407/2 Uyumlu)</div><div class="doc-article-content">
<p><strong>4.1. Kasa TazminatÄ±:</strong> Kasa sorumluluÄŸu verilen Personele, Ã¼stlendiÄŸi finansal riskin ve Ã¶zen borcunun karÅŸÄ±lÄ±ÄŸÄ± olarak, aylÄ±k Ã¼cret bordrosunda "Kasa TazminatÄ±" adÄ± altÄ±nda ayrÄ± bir ek Ã¶deme yapÄ±lÄ±r.</p>
<p><strong>4.2. AÃ§Ä±klarÄ±n Mahsubu:</strong> Kasada oluÅŸacak nakit veya hesaben aÃ§Ä±klar, Ã¶ncelikle ve mÃ¼nhasÄ±ran o ay Personele tahakkuk ettirilen Kasa TazminatÄ± tutarÄ±ndan mahsup edilir.</p>
<p><strong>4.3. TazminatÄ± AÅŸan AÃ§Ä±klar:</strong> Kasa aÃ§Ä±ÄŸÄ±nÄ±n, Ã¶denen kasa tazminatÄ± tutarÄ±nÄ± aÅŸmasÄ± halinde; Personel, sÃ¶z konusu aÃ§Ä±ÄŸÄ±n kendi kusurundan veya ihmalinden (hatalÄ± iÅŸlem, eksik tahsilat, kayÄ±p vb.) kaynaklandÄ±ÄŸÄ±nÄ± kabul ettiÄŸi takdirde, ilgili tutarÄ±n Ã¼cretinin yasal olarak haczedilebilir kÄ±smÄ±ndan (1/4 oranÄ±nda) kesilmesine her somut olayda ayrÄ±ca yazÄ±lÄ± onay verecektir. Personelin rÄ±zasÄ±nÄ±n olmadÄ±ÄŸÄ± veya kasÄ±t/aÄŸÄ±r ihmal ÅŸÃ¼phesinin bulunduÄŸu durumlarda Ä°ÅŸverenin yasal yollara baÅŸvurma hakkÄ± saklÄ±dÄ±r.</p>
<p><strong>4.4. BahÅŸiÅŸ (Tip) PolitikasÄ±:</strong> Ä°ÅŸletmede mÃ¼ÅŸteriler tarafÄ±ndan bÄ±rakÄ±lan bahÅŸiÅŸler (tip), Ä°ÅŸveren tarafÄ±ndan verilen bir Ã¼cret veya Ã¼cret eki deÄŸildir. Ä°ÅŸveren, kredi kartÄ± veya nakit olarak toplanan bahÅŸiÅŸlerin personele daÄŸÄ±tÄ±lmasÄ±nda sadece "aracÄ±" sÄ±fatÄ±na sahiptir. BahÅŸiÅŸ gelirleri, kÄ±dem ve ihbar tazminatÄ± hesabÄ±na dahil edilen giydirilmiÅŸ Ã¼cret kavramÄ±na dahil edilmez.</p>
</div></div>

<div class="doc-article"><div class="doc-article-title">MADDE 5: EÄžÄ°TÄ°M GÄ°DERLERÄ° VE CEZAÄ° ÅžART</div><div class="doc-article-content">
<p><strong>5.1.</strong> Ä°ÅŸveren tarafÄ±ndan Personele, mesleki geliÅŸimini saÄŸlamak amacÄ±yla verilecek olan sertifikalÄ± barista eÄŸitimleri, Ã¶zel kahve teknikleri kurslarÄ± ve benzeri yÃ¼ksek maliyetli eÄŸitimler karÅŸÄ±lÄ±ÄŸÄ±nda; Personel, eÄŸitimin tamamlandÄ±ÄŸÄ± tarihten itibaren en az 12 (on iki) ay sÃ¼reyle Ä°ÅŸveren nezdinde Ã§alÄ±ÅŸmayÄ± taahhÃ¼t eder.</p>
<p><strong>5.2.</strong> Personelin, bu sÃ¼re dolmadan haklÄ± bir neden olmaksÄ±zÄ±n istifa etmesi veya Ä°ÅŸveren tarafÄ±ndan haklÄ± nedenle (Ä°ÅŸ K. m. 25/II - Ahlak ve iyi niyet kurallarÄ±na aykÄ±rÄ±lÄ±k) iÅŸten Ã§Ä±karÄ±lmasÄ± halinde; Personel, kendisine yapÄ±lan belgelendirilmiÅŸ eÄŸitim masraflarÄ±nÄ± (eÄŸitmen Ã¼creti, kurs bedeli, materyal vb.), kalan Ã§alÄ±ÅŸma sÃ¼resiyle orantÄ±lÄ± olarak Ä°ÅŸverene nakden ve defaten Ã¶demeyi kabul ve taahhÃ¼t eder.</p>
</div></div>

<div class="doc-article"><div class="doc-article-title">MADDE 6: YASAKLAR VE FESÄ°H NEDENLERÄ°</div><div class="doc-article-content">
<p><strong>6.1. ArtÄ±k ÃœrÃ¼n (Leftover/Waste):</strong> Ä°ÅŸyerinde satÄ±lamayan, zayi olan veya mÃ¼ÅŸteriden dÃ¶nen Ã¼rÃ¼nlerin (waste) Personel tarafÄ±ndan izinsiz tÃ¼ketilmesi, eve gÃ¶tÃ¼rÃ¼lmesi veya Ã¼Ã§Ã¼ncÃ¼ ÅŸahÄ±slara ikram edilmesi kesinlikle yasaktÄ±r. Bu eylem, deÄŸeri ne olursa olsun "Ä°ÅŸverenin GÃ¼venini KÃ¶tÃ¼ye Kullanma" (Ä°ÅŸ K. m. 25/II-e) ve TCK m. 155 kapsamÄ±nda suÃ§ teÅŸkil eder; tazminatsÄ±z derhal fesih sebebidir.</p>
<p><strong>6.2. TÄ±bbi Gizleme:</strong> Personel, gÄ±da gÃ¼venliÄŸini tehdit eden bulaÅŸÄ±cÄ± hastalÄ±klarÄ± (sarÄ±lÄ±k, tÃ¼berkÃ¼loz, aÃ§Ä±k yara, ishal vb.) derhal iÅŸverene bildirmek zorundadÄ±r. Bu durumun gizlenerek Ã§alÄ±ÅŸmaya devam edilmesi, halk saÄŸlÄ±ÄŸÄ±nÄ± tehlikeye attÄ±ÄŸÄ± gerekÃ§esiyle haklÄ± fesih nedenidir.</p>
<p><strong>6.3. KiÅŸisel Veriler ve SÄ±r Saklama:</strong> Personel, iÅŸyeri sÄ±nÄ±rlarÄ± iÃ§erisinde (mutfak, bar, depo vb.) izinsiz fotoÄŸraf veya video Ã§ekemez. Ä°ÅŸletmenin reÃ§etelerini, operasyonel sÄ±rlarÄ±nÄ± veya mÃ¼ÅŸterileri iÃ§eren gÃ¶rsellerin sosyal medyada paylaÅŸÄ±lmasÄ± "Sadakat Borcuna AykÄ±rÄ±lÄ±k" sayÄ±lÄ±r ve haklÄ± fesih nedenidir.</p>
</div></div>

<div class="doc-article"><div class="doc-article-title">MADDE 7: Ä°ÅžYERÄ° GÃœVENLÄ°ÄžÄ° VE KAMERA KAYDI (KVKK AYDINLATMA)</div><div class="doc-article-content">
<p><strong>7.1.</strong> Ä°ÅŸyeri gÃ¼venliÄŸi, gÄ±da gÃ¼venliÄŸi sÃ¼reÃ§lerinin takibi, iÅŸ saÄŸlÄ±ÄŸÄ± ve gÃ¼venliÄŸi ile hÄ±rsÄ±zlÄ±k gibi suÃ§larÄ±n Ã¶nlenmesi amacÄ±yla; iÅŸyerinin ortak alanlarÄ±nda, Ã¼retim bÃ¶lÃ¼mlerinde, kasa noktalarÄ±nda ve depo alanlarÄ±nda 7/24 gÃ¶rÃ¼ntÃ¼ (CCTV/Video) kaydÄ± yapÄ±lmaktadÄ±r.</p>
<p><strong>7.2.</strong> Ä°ÅŸyerinde, yasal zorunluluklar ve istisnalar saklÄ± kalmak kaydÄ±yla, ses (audio) kaydÄ± alÄ±nmamaktadÄ±r. Tuvalet, soyunma odasÄ± gibi mahremiyet iÃ§eren alanlarda kesinlikle izleme yapÄ±lmaz.</p>
<p><strong>7.3.</strong> PERSONEL, iÅŸyerinde gÃ¼venlik kameralarÄ±nÄ±n bulunduÄŸunu bildiÄŸini, bu verilerin iÅŸlenmesine iliÅŸkin KVKK AydÄ±nlatma Metni'nin kendisine tebliÄŸ edildiÄŸini ve Ä°ÅŸverenin meÅŸru menfaati kapsamÄ±nda gÃ¶rÃ¼ntÃ¼ kaydÄ± alÄ±nmasÄ±na rÄ±za gÃ¶sterdiÄŸini kabul eder.</p>
</div></div>

<div class="doc-article"><div class="doc-article-title">MADDE 8: DENEME SÃœRESÄ° VE YÃœRÃœRLÃœK</div><div class="doc-article-content">
<p><strong>8.1.</strong> Ä°ÅŸbu sÃ¶zleÅŸmede deneme sÃ¼resi 2 (Ä°ki) aydÄ±r. Taraflar bu sÃ¼re iÃ§inde iÅŸ sÃ¶zleÅŸmesini bildirim sÃ¼resine gerek olmaksÄ±zÄ±n ve tazminatsÄ±z feshedebilir.</p>
<p><strong>8.2.</strong> 8 (Sekiz) maddeden ve 3 (Ã¼Ã§) sayfadan ibaret iÅŸbu sÃ¶zleÅŸme, {{BASLAMA}} tarihinde taraflarca okunarak, iÃ§eriÄŸi tam olarak anlaÅŸÄ±lmak suretiyle tek nÃ¼sha olarak imzalanmÄ±ÅŸ ve aslÄ± Ä°ÅŸverende kalmak Ã¼zere, bir sureti (fotokopisi) PERSONEL'e elden teslim edilmiÅŸtir.</p>
</div></div>`,
        mudur_yardimcisi: `<div class="doc-article"><div class="doc-article-title">MADDE 2: SÃ–ZLEÅžMENÄ°N KONUSU VE HUKUKÄ° STATÃœ</div><div class="doc-article-content">
<p>Ä°ÅŸbu sÃ¶zleÅŸmenin konusu, PERSONEL'in Ä°ÅžVEREN'e ait "Moonberry Coffee" markalÄ± iÅŸyerlerinde "MaÄŸaza MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±" unvanÄ± ile, aÅŸaÄŸÄ±da belirtilen gÃ¶rev tanÄ±mÄ±, 4857 sayÄ±lÄ± Ä°ÅŸ Kanunu, 6098 sayÄ±lÄ± TÃ¼rk BorÃ§lar Kanunu ve iÅŸletme prosedÃ¼rleri Ã§erÃ§evesinde iÅŸ gÃ¶rme edimini; Ä°ÅžVEREN'in de buna karÅŸÄ±lÄ±k Ã¼cret Ã¶deme edimini yerine getirmesidir. PERSONEL, kendisine baÄŸlÄ± alt ekipler (barista, servis elemanÄ±, temizlik personeli vb.) Ã¼zerinde yÃ¶netim, denetim, vardiya dÃ¼zenleme ve talimat verme yetkisine sahip olup; iÅŸletmenin iÅŸleyiÅŸinden sorumlu yÃ¶netici sÄ±fatÄ±nÄ± haizdir.</p>
</div></div>

<div class="doc-article"><div class="doc-article-title">MADDE 3: GÃ–REV TANIMI VE "HÄ°BRÄ°T Ã‡ALIÅžMA" ESASI</div><div class="doc-article-content">
<p><strong>3.1. Entegre ve Ã‡ok YÃ¶nlÃ¼ GÃ¶rev TanÄ±mÄ±:</strong> PERSONEL, bu pozisyonun sadece "idari/masa baÅŸÄ±" bir yÃ¶neticilik olmadÄ±ÄŸÄ±nÄ±; perakende ve hizmet sektÃ¶rÃ¼nÃ¼n doÄŸasÄ± gereÄŸi hem yÃ¶netimsel hem de operasyonel (fiili) gÃ¶revleri kapsadÄ±ÄŸÄ±nÄ± kabul eder. AÅŸaÄŸÄ±daki gÃ¶revlerin tamamÄ± PERSONEL'in "Asli Ä°ÅŸi" sayÄ±lÄ±r ve bu gÃ¶revlerin talep edilmesi "Ã§alÄ±ÅŸma koÅŸullarÄ±nda esaslÄ± deÄŸiÅŸiklik" (Ä°ÅŸ K. m. 22) teÅŸkil etmez:</p>
<p>a) <strong>YÃ¶netim ve Temsil:</strong> MaÄŸaza MÃ¼dÃ¼rÃ¼'nÃ¼n bulunmadÄ±ÄŸÄ± zamanlarda iÅŸletmeyi tam yetkili olarak sevk ve idare etmek, vardiya Ã§izelgelerini (shift plan) yasal mevzuata ve operasyonel verimliliÄŸe uygun hazÄ±rlamak, personelin kÄ±lÄ±k-kÄ±yafet, mesai ve hijyen denetimini yapmak.</p>
<p>b) <strong>Fiili Operasyonel Destek:</strong> Ä°ÅŸletmenin yoÄŸun olduÄŸu saatlerde, personel eksikliÄŸinde, mola deÄŸiÅŸimlerinde veya iÅŸin gerektirdiÄŸi hallerde; bizzat bar arkasÄ±na geÃ§erek Ã¼rÃ¼n hazÄ±rlamak, servis yapmak, masalarÄ± toplamak, bulaÅŸÄ±k alanÄ±nÄ± koordine etmek ve kasaya bakmak.</p>
<p>c) <strong>Sanitasyon ve Denetim:</strong> GÄ±da gÃ¼venliÄŸi (HACCP) standartlarÄ±nÄ±n uygulanmasÄ±nÄ± denetlemek ve bizzat saÄŸlamak. GerektiÄŸinde; mÃ¼ÅŸteri tuvaletleri, zemin, depo ve Ã¼retim alanlarÄ±nÄ±n temizlik kontrollerini yapmak ve temizlik operasyonuna fiilen katÄ±lmak.</p>
<p>d) <strong>Stok ve Maliyet KontrolÃ¼:</strong> GÃ¼nlÃ¼k, haftalÄ±k ve aylÄ±k stok sayÄ±mlarÄ±nÄ± bizzat yÃ¶netmek; zayi (waste) oranlarÄ±nÄ± raporlamak, Son Kullanma Tarihi (SKT) kontrollerini yapmak, mal kabul sÃ¼reÃ§lerini yÃ¼rÃ¼tmek.</p>
<p><strong>3.2. GÃ¶rev Yeri ve Nakil Yetkisi:</strong> Ä°ÅžVEREN, iÅŸletmesel gereklilik halinde PERSONEL'i, aynÄ± il sÄ±nÄ±rlarÄ± (BÃ¼yÃ¼kÅŸehir Belediyesi sÄ±nÄ±rlarÄ± dahil) iÃ§erisindeki mevcut veya aÃ§Ä±lacak diÄŸer ÅŸubelerinde, personelin ikametgahÄ±na makul ulaÅŸÄ±m imkanlarÄ± gÃ¶zetilerek aynÄ± veya eÅŸdeÄŸer bir pozisyonda gÃ¶revlendirme hakkÄ±na sahiptir. PERSONEL, bu nakil yetkisini peÅŸinen kabul ettiÄŸini beyan eder.</p>
</div></div>

<div class="doc-article"><div class="doc-article-title">MADDE 4: Ã‡ALIÅžMA SÃœRELERÄ°, FAZLA MESAÄ° VE ÃœCRET SÄ°STEMÄ°</div><div class="doc-article-content">
<p><strong>4.1. Ã‡alÄ±ÅŸma DÃ¼zeni:</strong> HaftalÄ±k Ã§alÄ±ÅŸma sÃ¼resi yasal sÄ±nÄ±r olan 45 saattir. PERSONEL, yÃ¶netici sÄ±fatÄ±yla maÄŸazanÄ±n aÃ§Ä±lÄ±ÅŸ-kapanÄ±ÅŸ, sayÄ±m ve raporlama sÃ¼reÃ§lerinden sorumlu olduÄŸundan, mesai saatleri bu gerekliliklere gÃ¶re Ä°ÅžVEREN tarafÄ±ndan dÃ¼zenlenir. Ä°ÅžVEREN, Ä°ÅŸ Kanunu m. 63 uyarÄ±nca 2 (iki) aylÄ±k denkleÅŸtirme uygulayabilir.</p>
<p><strong>4.2. YÄ±llÄ±k 270 Saat Fazla Mesainin Ãœcrete Dahil OlmasÄ±:</strong> PERSONEL'in aylÄ±k brÃ¼t Ã¼creti, Ã¼stlendiÄŸi yÃ¶netim sorumluluÄŸu ve operasyonel yÃ¼k dikkate alÄ±narak yasal asgari Ã¼cretin Ã¼zerinde (emsal Ã¼cret) tespit edilmiÅŸtir. Taraflar, yÄ±llÄ±k 270 saate kadar (aylÄ±k ortalama 22,5 saat) yapÄ±lacak fazla Ã§alÄ±ÅŸma Ã¼cretlerinin, kararlaÅŸtÄ±rÄ±lan aylÄ±k Ã¼crete dahil olduÄŸu hususunda mutabÄ±k kalmÄ±ÅŸlardÄ±r. PERSONEL, yÄ±llÄ±k 270 saati aÅŸmayan fazla Ã§alÄ±ÅŸmalar iÃ§in ayrÄ±ca bir Ã¼cret talep etmeyeceÄŸini kabul eder. (Not: Ulusal Bayram ve Genel Tatil gÃ¼nlerinde yapÄ±lan Ã§alÄ±ÅŸmalar ile hafta tatili Ã§alÄ±ÅŸmalarÄ± bu 270 saatlik kapsama dahil olmayÄ±p, Ã§alÄ±ÅŸÄ±lmasÄ± halinde ayrÄ±ca Ã¶denir.)</p>
</div></div>

<div class="doc-article"><div class="doc-article-title">MADDE 5: ÃœCRET, YAN HAKLAR VE MALÄ° SORUMLULUK</div><div class="doc-article-content">
<p><strong>5.1. Ãœcret:</strong> PERSONEL'e aylÄ±k BrÃ¼t {{UCRET}} TL Ã¼cret Ã¶denecektir. Ãœcret Ã¶demeleri banka kanalÄ±yla yapÄ±lÄ±r. Varsa yol ve yemek yardÄ±mlarÄ± ÅŸirket politikalarÄ±na gÃ¶re ayni veya nakdi olarak ayrÄ±ca belirlenir.</p>
<p><strong>5.2. Kasa TazminatÄ± ve Mali Sorumluluk:</strong> Nakit, stok ve zimmet gÃ¼venliÄŸini yÃ¶netmesi sebebiyle PERSONEL'e, aylÄ±k Ã¼cretine ek olarak (bordroda belirtilmek suretiyle) "Mali Sorumluluk / Kasa TazminatÄ±" Ã¶denir. PERSONEL, kendi gÃ¶rev alanÄ± ve denetim sorumluluÄŸundaki kasa aÃ§Ä±klarÄ±ndan ve stok kayÄ±plarÄ±ndan (hÄ±rsÄ±zlÄ±k, kayÄ±p, usulsÃ¼z ikram vb.), kusurunun tespiti halinde ÅŸahsen sorumludur. Tespit edilen ve PERSONEL'in kusuruna (kasÄ±t, ihmal veya dikkatsizlik) dayanan zararlar; Ã¶ncelikle olay bazÄ±nda alÄ±nacak yazÄ±lÄ± onayÄ± ile kasa tazminatÄ±ndan ve hakediÅŸinden mahsup edilir. Personelin onay vermemesi halinde Ä°ÅžVEREN'in BorÃ§lar Kanunu ve Ä°ÅŸ Kanunu hÃ¼kÃ¼mleri uyarÄ±nca yasal takip ve tazminat talep etme hakkÄ± saklÄ±dÄ±r.</p>
<p><strong>5.3. BahÅŸiÅŸ (Tip) PolitikasÄ±:</strong> Ä°ÅŸletmede mÃ¼ÅŸteriler tarafÄ±ndan bÄ±rakÄ±lan bahÅŸiÅŸler, Ã¼cretin bir parÃ§asÄ± olmayÄ±p, Ä°ÅžVEREN sadece daÄŸÄ±tÄ±m iÃ§in aracÄ± konumundadÄ±r. PERSONEL, bahÅŸiÅŸlerin kÄ±dem/ihbar tazminatÄ± hesabÄ±na dahil edilmeyeceÄŸini kabul eder.</p>
</div></div>

<div class="doc-article"><div class="doc-article-title">MADDE 6: GÄ°ZLÄ°LÄ°K VE REKABET YASAÄžI</div><div class="doc-article-content">
<p><strong>6.1. Ticari SÄ±rlar:</strong> PERSONEL, gÃ¶revi gereÄŸi eriÅŸtiÄŸi; maÄŸaza ciro bilgileri, karlÄ±lÄ±k raporlarÄ±, tedarikÃ§i fiyatlarÄ±, Ã¶zel Ã¼rÃ¼n reÃ§eteleri, personel maaÅŸ bilgileri ve mÃ¼ÅŸteri datalarÄ±nÄ± "Ticari SÄ±r" olarak saklamakla yÃ¼kÃ¼mlÃ¼dÃ¼r. Bu bilgilerin rakip firmalarla veya yetkisiz Ã¼Ã§Ã¼ncÃ¼ kiÅŸilerle paylaÅŸÄ±lmasÄ±, TCK m. 239 kapsamÄ±nda suÃ§ duyurusu ve haklÄ± nedenle derhal fesih sebebidir.</p>
<p><strong>6.2. Rekabet YasaÄŸÄ± (SÄ±nÄ±rlÄ±):</strong> PERSONEL, iÅŸ sÃ¶zleÅŸmesi herhangi bir nedenle sona erdikten sonra 1 (bir) yÄ±l sÃ¼reyle, son gÃ¶rev yaptÄ±ÄŸÄ± ÅŸubenin bulunduÄŸu ilÃ§e sÄ±nÄ±rlarÄ± iÃ§erisinde, Moonberry Coffee ile doÄŸrudan rakip olan (benzer konseptteki kahve zincirleri) bir iÅŸletmede yÃ¶netici, ortak veya danÄ±ÅŸman olarak Ã§alÄ±ÅŸmamayÄ± taahhÃ¼t eder. Bu yasaÄŸÄ±n ihlali halinde, son brÃ¼t maaÅŸÄ±nÄ±n 3 (Ã¼Ã§) katÄ± tutarÄ±nda cezai ÅŸartÄ± Ä°ÅžVEREN'e Ã¶demeyi kabul ve taahhÃ¼t eder.</p>
</div></div>

<div class="doc-article"><div class="doc-article-title">MADDE 7: YASAKLAR VE FESÄ°H NEDENLERÄ°</div><div class="doc-article-content">
<p>AÅŸaÄŸÄ±daki haller, Ä°ÅžVEREN iÃ§in 4857 sayÄ±lÄ± Ä°ÅŸ Kanunu m. 25/II kapsamÄ±nda haklÄ± nedenle derhal fesih sebebidir:</p>
<p>a) Kasa iÅŸlemlerinde usulsÃ¼zlÃ¼k (fiÅŸsiz satÄ±ÅŸ, hileli iptal/iade, zimmet).</p>
<p>b) Ä°ÅŸletme Ã¼rÃ¼nlerinin (yemek, kahve, pasta vb.) izinsiz tÃ¼ketilmesi, dÄ±ÅŸarÄ± Ã§Ä±karÄ±lmasÄ± veya Ã¼Ã§Ã¼ncÃ¼ ÅŸahÄ±slara bedelsiz ikram edilmesi (GÃ¼veni KÃ¶tÃ¼ye Kullanma).</p>
<p>c) AstÄ± konumundaki personele mobbing uygulamak, hakaret etmek, ayrÄ±mcÄ±lÄ±k yapmak veya cinsel tacizde bulunmak.</p>
<p>d) GÄ±da gÃ¼venliÄŸini (HACCP) tehlikeye atacak hijyen ihlallerine gÃ¶z yumulmasÄ± veya bizzat yapÄ±lmasÄ±.</p>
<p>e) Ä°ÅŸ SaÄŸlÄ±ÄŸÄ± ve GÃ¼venliÄŸi (Ä°SG) talimatlarÄ±na uymamak, kiÅŸisel koruyucu donanÄ±m kullanmamak, iÅŸyerini ve mÃ¼ÅŸterileri tehlikeye dÃ¼ÅŸÃ¼recek davranÄ±ÅŸlarda bulunmak.</p>
</div></div>

<div class="doc-article"><div class="doc-article-title">MADDE 8: KÄ°ÅžÄ°SEL VERÄ°LER, KAMERA KAYDI VE TEBLÄ°GAT</div><div class="doc-article-content">
<p><strong>8.1. Kamera KaydÄ±:</strong> Ä°ÅŸyeri gÃ¼venliÄŸi, hÄ±rsÄ±zlÄ±k olaylarÄ±nÄ±n Ã¶nlenmesi ve operasyonel standartlarÄ±n takibi amacÄ±yla; iÅŸyerinin ortak alanlarÄ±nda, ofis, depo ve kasa noktalarÄ±nda 7/24 gÃ¶rÃ¼ntÃ¼ kaydÄ± (CCTV) yapÄ±lmaktadÄ±r. Ses kaydÄ± yapÄ±lmamaktadÄ±r. PERSONEL, iÅŸyerinde gÃ¼venlik kameralarÄ±nÄ±n bulunduÄŸunu bildiÄŸini, bu kayÄ±tlarÄ±n KVKK ve Ä°ÅžVEREN'in meÅŸru menfaati kapsamÄ±nda iÅŸlendiÄŸini kabul eder.</p>
<p><strong>8.2. Tebligat:</strong> TaraflarÄ±n Madde 1'de belirtilen adresleri yasal tebligat adresleridir. Adres deÄŸiÅŸikliÄŸi yazÄ±lÄ± olarak bildirilmediÄŸi sÃ¼rece, bu adreslere yapÄ±lacak tebligatlar geÃ§erli sayÄ±lacaktÄ±r.</p>
</div></div>

<div class="doc-article"><div class="doc-article-title">MADDE 9: DENEME SÃœRESÄ° VE YÃœRÃœRLÃœK</div><div class="doc-article-content">
<p><strong>9.1.</strong> Ä°ÅŸbu sÃ¶zleÅŸmede deneme sÃ¼resi 2 (Ä°ki) aydÄ±r. Taraflar bu sÃ¼re iÃ§inde iÅŸ sÃ¶zleÅŸmesini bildirim sÃ¼resine gerek olmaksÄ±zÄ±n ve tazminatsÄ±z feshedebilir.</p>
<p><strong>9.2.</strong> Ä°ÅŸbu sÃ¶zleÅŸme, 9 maddeden ibaret olup, {{BASLAMA}} tarihinde taraflarca okunarak, iÃ§eriÄŸi tam olarak anlaÅŸÄ±lmak suretiyle tek nÃ¼sha olarak imzalanmÄ±ÅŸ ve aslÄ± Ä°ÅžVEREN'de kalmak Ã¼zere bir kopyasÄ± PERSONEL'e teslim edilmiÅŸtir.</p>
</div></div>`,
        magaza_muduru: `<div class="doc-article"><div class="doc-article-title">MADDE 2: GÃ–REV TANIMI, YETKÄ° VE Ä°ÅžVEREN VEKÄ°LLÄ°ÄžÄ° STATÃœSÃœ</div><div class="doc-article-content">
<p><strong>2.1. GÃ¶rev TanÄ±mÄ±:</strong> YÃ–NETÄ°CÄ°, ÅžÄ°RKET'e ait "Moonberry Coffee" maÄŸazasÄ±nda MAÄžAZA MÃœDÃœRÃœ unvanÄ± ile gÃ¶rev yapacaktÄ±r. YÃ–NETÄ°CÄ°; maÄŸazanÄ±n ticari baÅŸarÄ±sÄ±ndan, operasyonel standartlarÄ±ndan, yasal mevzuata uyumundan (GÄ±da gÃ¼venliÄŸi, Ä°SG vb.) ve ekibin sevk ve idaresinden tam yetkili ve sorumludur.</p>
<p><strong>2.2. Ä°ÅŸveren VekilliÄŸi (Hukuki StatÃ¼):</strong> Taraflar; YÃ–NETÄ°CÄ°'nin iÅŸyerindeki konumu itibarÄ±yla, 4857 sayÄ±lÄ± Ä°ÅŸ Kanunu'nun 2. maddesi ve 18. maddesinin son fÄ±krasÄ± anlamÄ±nda "Ä°ÅŸyerinin bÃ¼tÃ¼nÃ¼nÃ¼ sevk ve idare eden ve iÅŸÃ§iyi iÅŸe alma ve iÅŸten Ã§Ä±karma yetkisi bulunan Ä°ÅžVEREN VEKÄ°LÄ°" statÃ¼sÃ¼nde olduÄŸunu kabul ve beyan ederler. Bu statÃ¼nÃ¼n gereÄŸi olarak YÃ–NETÄ°CÄ°;</p>
<p>â€¢ MaÄŸaza personel kadrosunu belirleme,</p>
<p>â€¢ Adaylarla mÃ¼lakat yapÄ±p iÅŸe alma kararÄ±nÄ± tek baÅŸÄ±na verme,</p>
<p>â€¢ Performans dÃ¼ÅŸÃ¼klÃ¼ÄŸÃ¼, disiplin suÃ§larÄ± veya iÅŸletme gerekleri nedeniyle alt kademe personelin iÅŸ sÃ¶zleÅŸmelerini tek baÅŸÄ±na ve nihai karar verici olarak feshetme yetkisine haizdir.</p>
<p>YÃ–NETÄ°CÄ°, bu nitelikli yetkileri haiz olmasÄ± sebebiyle, 4857 sayÄ±lÄ± Kanun'un iÅŸ gÃ¼vencesi (iÅŸe iade davasÄ±) hÃ¼kÃ¼mlerinden yararlanamayacaÄŸÄ±nÄ± bildiÄŸini gayrikabili rÃ¼cu kabul eder.</p>
</div></div>

<div class="doc-article"><div class="doc-article-title">MADDE 3: Ã‡ALIÅžMA SÃœRESÄ° VE FAZLA MESAÄ° DÃœZENLEMESÄ°</div><div class="doc-article-content">
<p><strong>3.1. Mesaiyi Belirleme Serbestisi:</strong> YÃ–NETÄ°CÄ°, iÅŸyerinin en Ã¼st dÃ¼zey amiri sÄ±fatÄ±yla; gÃ¶rev ve sorumluluklarÄ±nÄ±n gerektirdiÄŸi ÅŸekilde mesai saatlerini, iÅŸe baÅŸlama-bitiÅŸ zamanlarÄ±nÄ±, ara dinlenmelerini ve izin dÃ¼zenini ÅŸahsen belirleme ve tanzim etme yetkisine sahiptir. YÃ–NETÄ°CÄ°'ye kart basma veya saatlik puantaj zorunluluÄŸu uygulanmaz; esas olan sonuÃ§ odaklÄ± yÃ¶netimdir.</p>
<p><strong>3.2. Fazla Ã‡alÄ±ÅŸma Ãœcrete Dahildir:</strong> YÃ–NETÄ°CÄ°'ye Ã¶denen aylÄ±k Ã¼cret, Ã¼stlendiÄŸi idari sorumluluk, baÄŸÄ±msÄ±z karar alma yetkisi ve mesaisini kendisinin belirlemesi hususlarÄ± dikkate alÄ±narak, yasal asgari Ã¼cretin ve emsal Ã¼cretlerin Ã¼zerinde (nitelikli Ã¼cret) tespit edilmiÅŸtir. Bu sebeple;</p>
<p>â€¢ Yasal haftalÄ±k 45 saati aÅŸan Ã§alÄ±ÅŸmalarÄ±n (Fazla Mesai),</p>
<p>â€¢ Hafta tatili Ã§alÄ±ÅŸmalarÄ±nÄ±n,</p>
<p>â€¢ Ulusal Bayram ve Genel Tatil gÃ¼nlerinde yapÄ±lan Ã§alÄ±ÅŸmalarÄ±n,</p>
<p>karÅŸÄ±lÄ±ÄŸÄ± olan Ã¼cretler, YÃ–NETÄ°CÄ°'nin kararlaÅŸtÄ±rÄ±lan aylÄ±k Ã¼cretine dahildir. YÃ–NETÄ°CÄ°, yÄ±llÄ±k 270 saate kadar olan bu tÃ¼r Ã§alÄ±ÅŸmalarÄ± iÃ§in ayrÄ±ca bir Ã¼cret, zamlÄ± Ã¶deme veya serbest zaman talep etmeyeceÄŸini kabul ve taahhÃ¼t eder.</p>
</div></div>

<div class="doc-article"><div class="doc-article-title">MADDE 4: ÃœCRET VE YAN HAKLAR</div><div class="doc-article-content">
<p><strong>4.1. KÃ¶k Ãœcret:</strong> YÃ–NETÄ°CÄ°'ye, yukarÄ±daki Ã§alÄ±ÅŸma ÅŸartlarÄ± karÅŸÄ±lÄ±ÄŸÄ±nda aylÄ±k BrÃ¼t {{UCRET}} TL Ã¼cret Ã¶denecektir.</p>
<p><strong>4.2. Mali Sorumluluk (Kasa) TazminatÄ±:</strong> YÃ–NETÄ°CÄ°'ye, maÄŸazadaki nakit akÄ±ÅŸÄ±, stok, emtia ve demirbaÅŸlarÄ±n korunmasÄ± riskini Ã¼stlenmesi karÅŸÄ±lÄ±ÄŸÄ±nda, aylÄ±k kÃ¶k Ã¼cretine ek olarak ve bordroda ayrÄ± bir kalem olarak gÃ¶sterilmek suretiyle her ay "Mali Sorumluluk (Kasa) TazminatÄ±" Ã¶denir.</p>
</div></div>

<div class="doc-article"><div class="doc-article-title">MADDE 5: MALÄ° SORUMLULUK, ZAYÄ°AT VE KESÄ°NTÄ°LER</div><div class="doc-article-content">
<p><strong>5.1. ZararÄ±n Tazmini ve Mahsup:</strong> MaÄŸaza kasasÄ±nda, stok sayÄ±mlarÄ±nda veya zimmetli demirbaÅŸlarda; hÄ±rsÄ±zlÄ±k, dikkatsizlik, prosedÃ¼r hatasÄ± veya YÃ–NETÄ°CÄ°'nin Ã¶zen borcuna aykÄ±rÄ±lÄ±ÄŸÄ± nedeniyle oluÅŸan noksanlÄ±klar (aÃ§Ä±klar/zararlar), Ã¶ncelikle ve mÃ¼nhasÄ±ran YÃ–NETÄ°CÄ°'ye o ay Ã¶denen "Mali Sorumluluk TazminatÄ±"ndan mahsup edilir.</p>
<p><strong>5.2. TazminatÄ± AÅŸan Zararlar:</strong> OluÅŸan zarar miktarÄ±nÄ±n, Ã¶denen Mali Sorumluluk TazminatÄ±nÄ± aÅŸmasÄ± durumunda; aÅŸan kÄ±sÄ±m iÃ§in YÃ–NETÄ°CÄ°'nin kusuru oranÄ±nda rÃ¼cu edilir. YÃ–NETÄ°CÄ°, tazminatÄ± aÅŸan zararlarÄ±n tahsili iÃ§in olayÄ±n vuku bulduÄŸu tarihte dÃ¼zenlenecek mutabakat tutanaÄŸÄ± ile Ã¼cretinden kesinti yapÄ±lmasÄ±nÄ± veya borcu def'aten Ã¶demeyi kabul eder.</p>
<p><strong>5.3. KasÄ±tlÄ± Haller:</strong> Zimmet, emniyeti suistimal, hÄ±rsÄ±zlÄ±k veya ÅžÄ°RKET'e kasten zarar verme halleri, tazminat limitine bakÄ±lmaksÄ±zÄ±n 4857 sayÄ±lÄ± Ä°ÅŸ Kanunu m. 25/II uyarÄ±nca haklÄ± nedenle derhal fesih sebebidir ve oluÅŸan tÃ¼m zarar yasal yollarla YÃ–NETÄ°CÄ°'den tahsil edilir.</p>
</div></div>

<div class="doc-article"><div class="doc-article-title">MADDE 6: PERFORMANS, REKABET YASAÄžI VE GÄ°ZLÄ°LÄ°K</div><div class="doc-article-content">
<p><strong>6.1. Performans Hedefleri:</strong> YÃ–NETÄ°CÄ°, kendisine tebliÄŸ edilen ciro, kÃ¢rlÄ±lÄ±k (P&L), fire/zayi oranÄ± ve denetim puanÄ± hedeflerini (KPI) tutturmakla yÃ¼kÃ¼mlÃ¼dÃ¼r. Makul mazeret (mÃ¼cbir sebep) olmaksÄ±zÄ±n hedeflerin sÃ¼reklilik arz edecek ÅŸekilde tutturulamamasÄ±, "Performans DÃ¼ÅŸÃ¼klÃ¼ÄŸÃ¼/Yetersizlik" sayÄ±lÄ±r. ÅžÄ°RKET, bu durumda YÃ–NETÄ°CÄ°'den yazÄ±lÄ± savunma almak kaydÄ±yla iÅŸ sÃ¶zleÅŸmesini geÃ§erli nedenle feshedebilir.</p>
<p><strong>6.2. Rekabet YasaÄŸÄ±:</strong> YÃ–NETÄ°CÄ°, iÅŸ sÃ¶zleÅŸmesi herhangi bir nedenle sona erdikten sonra 1 (Bir) yÄ±l sÃ¼reyle; son gÃ¶rev yaptÄ±ÄŸÄ± maÄŸazanÄ±n bulunduÄŸu ilÃ§e sÄ±nÄ±rlarÄ± iÃ§erisinde, Moonberry Coffee ile doÄŸrudan rakip olan (Kahve Zinciri/Kafe/Restoran) iÅŸletmelerde Ã§alÄ±ÅŸmamayÄ±, ortak olmamayÄ± veya danÄ±ÅŸmanlÄ±k yapmamayÄ± taahhÃ¼t eder.</p>
<p><strong>6.3. Cezai Åžart (KarÅŸÄ±lÄ±klÄ±lÄ±k EsasÄ±):</strong> YÃ–NETÄ°CÄ°'nin Rekabet YasaÄŸÄ±nÄ± (Madde 6.2) ihlal etmesi halinde, son brÃ¼t Ã¼cretinin 6 (AltÄ±) katÄ± tutarÄ±nda cezai ÅŸartÄ± ÅžÄ°RKET'e Ã¶demeyi kabul eder. ÅžÄ°RKET'in iÅŸ sÃ¶zleÅŸmesini haksÄ±z yere feshetmesi durumunda da, ÅžÄ°RKET aynÄ± tutarda (6 brÃ¼t maaÅŸ) cezai ÅŸartÄ± YÃ–NETÄ°CÄ°'ye Ã¶demeyi taahhÃ¼t eder. (TBK m. 420 ve YargÄ±tay iÃ§tihatlarÄ± gereÄŸi karÅŸÄ±lÄ±klÄ±lÄ±k ilkesi).</p>
<p><strong>6.4. Gizlilik:</strong> ÅžÄ°RKET'e ait kahve reÃ§eteleri, tedarikÃ§i sÃ¶zleÅŸmeleri, personel Ã¼cret bilgileri, mali veriler ve mÃ¼ÅŸteri veri tabanÄ± "Ticari SÄ±r" niteliÄŸindedir. Bu bilgilerin Ã¼Ã§Ã¼ncÃ¼ kiÅŸilerle veya rakip firmalarla paylaÅŸÄ±lmasÄ±, tazminatsÄ±z derhal fesih nedenidir ve ayrÄ±ca cezai sorumluluk (TCK m. 239) doÄŸurur.</p>
</div></div>

<div class="doc-article"><div class="doc-article-title">MADDE 7: Ä°ÅžYERÄ° GÃœVENLÄ°ÄžÄ° VE KÄ°ÅžÄ°SEL VERÄ°LER (KVKK)</div><div class="doc-article-content">
<p><strong>7.1. GÃ¶rÃ¼ntÃ¼ KaydÄ± (CCTV):</strong> Ä°ÅŸyeri gÃ¼venliÄŸi, iÅŸ saÄŸlÄ±ÄŸÄ± ve gÃ¼venliÄŸi ile operasyonel denetim amacÄ±yla maÄŸaza genelinde, kasa noktalarÄ±nda ve Ã§alÄ±ÅŸma alanlarÄ±nda (tuvalet/giyinme kabini hariÃ§) 7/24 GÃ¶rÃ¼ntÃ¼ KaydÄ± (Video) yapÄ±lmaktadÄ±r. YÃ–NETÄ°CÄ°, bu uygulamanÄ±n KVKK m. 5/2-f (MeÅŸru Menfaat) kapsamÄ±nda olduÄŸunu bilir, kabul eder ve maÄŸaza genelinde bu sistemin sÃ¼rekli Ã§alÄ±ÅŸÄ±r durumda olmasÄ±nÄ± saÄŸlamakla yÃ¼kÃ¼mlÃ¼dÃ¼r.</p>
<p><strong>7.2. Ses KaydÄ± YasaÄŸÄ±:</strong> TÃ¼rk Ceza Kanunu'nun 133. maddesi ve KVKK ilkeleri gereÄŸi, iÅŸyerinde Ã§alÄ±ÅŸanlarÄ±n ve mÃ¼ÅŸterilerin Ã¶zel hayatÄ±nÄ±n gizliliÄŸini ihlal edecek ÅŸekilde genel ve sÃ¼rekli ses kaydÄ± yapÄ±lmamaktadÄ±r. YÃ–NETÄ°CÄ°, maÄŸaza iÃ§inde izinsiz ses kaydÄ± alan cihazlarÄ±n kullanÄ±lmasÄ±nÄ± engellemekle sorumludur.</p>
</div></div>

<div class="doc-article"><div class="doc-article-title">MADDE 8: SON HÃœKÃœMLER</div><div class="doc-article-content">
<p><strong>8.1. Delil SÃ¶zleÅŸmesi:</strong> Ä°ÅŸbu sÃ¶zleÅŸmeden doÄŸacak uyuÅŸmazlÄ±klarda ÅžÄ°RKET'in ticari defterleri, bordrolarÄ±, banka kayÄ±tlarÄ±, e-posta yazÄ±ÅŸmalarÄ± ve kamera gÃ¶rÃ¼ntÃ¼leri HMK m. 193 uyarÄ±nca kesin delil niteliÄŸindedir.</p>
<p><strong>8.2. YÃ¼rÃ¼rlÃ¼k:</strong> Ä°ÅŸbu sÃ¶zleÅŸme, 2 (iki) sayfa ve 8 (sekiz) maddeden ibaret olup, {{BASLAMA}} tarihinde taraflarca okunup, mÃ¼zakere edilerek tam bir mutabakatla imzalanmÄ±ÅŸ ve bir nÃ¼shasÄ± YÃ–NETÄ°CÄ°'ye teslim edilmiÅŸtir.</p>
</div></div>`,
        bolge_muduru: `<div class="doc-article"><div class="doc-article-title">MADDE 2: GÃ–REV TANIMI VE "Ä°ÅžVEREN VEKÄ°LÄ°" STATÃœSÃœ</div><div class="doc-article-content">
<p><strong>2.1. GÃ¶rev:</strong> PERSONEL, ÅžÄ°RKET bÃ¼nyesinde "BÃ–LGE MÃœDÃœRÃœ" unvanÄ± ile istihdam edilmiÅŸtir. Sorumluluk alanÄ±, Åžirket tarafÄ±ndan kendisine yazÄ±lÄ± olarak veya ÅŸirket veri sistemleri Ã¼zerinden bildirilen coÄŸrafi bÃ¶lge ve bu bÃ¶lgedeki tÃ¼m ÅŸubelerdir.</p>
<p><strong>2.2. Hukuki StatÃ¼ (Ä°ÅŸveren VekilliÄŸi):</strong> PERSONEL, kendisine baÄŸlÄ± bÃ¶lgedeki iÅŸyerlerini (ÅŸubeleri) sevk ve idare eden, iÅŸletmenin stratejik hedeflerine yÃ¶n veren ve sorumluluk bÃ¶lgesindeki alt kademe Ã§alÄ±ÅŸanlarÄ± (Åžube MÃ¼dÃ¼rÃ¼, Barista, Servis ElemanÄ± vb.) iÅŸe alma, iÅŸten Ã§Ä±karma, terfi ettirme ve disiplin cezasÄ± verme yetkisine mÃ¼stakil olarak (tek baÅŸÄ±na) sahip olan yÃ¶neticidir. Taraflar; PERSONEL'in bu yetki ve sorumluluklarÄ± gereÄŸi, 4857 sayÄ±lÄ± Ä°ÅŸ Kanunu'nun 18. maddesinin son fÄ±krasÄ± ve 2. maddesi anlamÄ±nda "Ä°ÅŸletmenin BÃ¼tÃ¼nÃ¼nÃ¼ Sevk ve Ä°dare Eden Ä°ÅŸveren Vekili YardÄ±mcÄ±sÄ±" veya "Ä°ÅŸyerinin BÃ¼tÃ¼nÃ¼nÃ¼ Sevk ve Ä°dare Eden ve Ä°ÅŸÃ§i Alma/Ã‡Ä±karma Yetkisi Bulunan Ä°ÅŸveren Vekili" statÃ¼sÃ¼nde olduÄŸunu ve bu statÃ¼nÃ¼n yasal sonuÃ§larÄ±nÄ± (iÅŸ gÃ¼vencesi hÃ¼kÃ¼mlerinin uygulanmayacaÄŸÄ±nÄ±) bildiÄŸini kabul ve beyan ederler.</p>
</div></div>

<div class="doc-article"><div class="doc-article-title">MADDE 3: GÃ–REV, YETKÄ° VE SORUMLULUKLAR</div><div class="doc-article-content">
<p>PERSONEL, sorumluluk alanÄ±ndaki bÃ¶lgenin kÃ¢rlÄ±lÄ±ÄŸÄ±, bÃ¼yÃ¼mesi ve marka standartlarÄ±nÄ±n korunmasÄ±ndan tam sorumludur. Asli gÃ¶revleri ÅŸunlardÄ±r:</p>
<p>a) <strong>Stratejik YÃ¶netim:</strong> BÃ¶lgedeki ÅŸubelerin ciro, kÃ¢rlÄ±lÄ±k (P&L) ve bÃ¼yÃ¼me hedeflerini belirlemek, bÃ¼tÃ§eyi yÃ¶netmek ve Genel MÃ¼dÃ¼rlÃ¼k stratejilerini sahada bizzat uygulamak.</p>
<p>b) <strong>Ä°K ve Organizasyon YÃ¶netimi:</strong> BÃ¶lge kadrosunu oluÅŸturmak, norm kadro Ã§alÄ±ÅŸmalarÄ± yapmak, Åžube MÃ¼dÃ¼rlerini atamak, performanslarÄ±nÄ± deÄŸerlendirmek, iÅŸe alÄ±m ve fesih kararlarÄ±nÄ± nihai merci olarak vermek.</p>
<p>c) <strong>Denetim ve Standartlar:</strong> Åžubelerin operasyonel standartlara (hijyen, servis kalitesi, Ã¼rÃ¼n reÃ§eteleri, Moonberry marka kimliÄŸi) uygunluÄŸunu denetlemek, "Gizli MÃ¼ÅŸteri" skorlarÄ±nÄ± yÃ¼kseltmek.</p>
<p>d) <strong>Yasal Temsil:</strong> BÃ¶lgesindeki resmi kurumlar, belediyeler ve tedarikÃ§iler nezdinde ÅžÄ°RKET'i temsil etmek, gerekli ruhsat ve izin sÃ¼reÃ§lerini yÃ¶netmek.</p>
<p>e) <strong>Kriz YÃ¶netimi:</strong> BÃ¶lgesinde oluÅŸabilecek operasyonel krizleri (gÄ±da gÃ¼venliÄŸi, iÅŸ kazasÄ±, sosyal medya krizi vb.) yÃ¶netmek.</p>
</div></div>

<div class="doc-article"><div class="doc-article-title">MADDE 4: Ã‡ALIÅžMA SÃœRELERÄ° VE FAZLA Ã‡ALIÅžMA DÃœZENÄ°</div><div class="doc-article-content">
<p><strong>4.1. Mesai DÃ¼zeni (Time Sovereignty):</strong> PERSONEL, "Ãœst DÃ¼zey YÃ¶netici" konumunda olup; gÃ¶rev ve sorumluluklarÄ±nÄ±n gerektirdiÄŸi ÅŸekilde mesai saatlerini, ÅŸube ziyaret planlarÄ±nÄ± ve Ã§alÄ±ÅŸma dÃ¼zenini iÅŸin gerekliliklerine gÃ¶re bizzat kendisi belirleme yetkisine sahiptir. Ä°ÅžVEREN, PERSONEL'e gÃ¼nlÃ¼k kart basma/imza atma zorunluluÄŸu uygulamaz; esas olan hedeflerin gerÃ§ekleÅŸmesidir.</p>
<p><strong>4.2. Ãœcretin KapsamÄ±:</strong> PERSONEL'in aylÄ±k brÃ¼t Ã¼creti, Ã¼stlendiÄŸi yÃ¶netim sorumluluÄŸu, yetkileri ve mesaisini kendisinin belirlemesi hususlarÄ± dikkate alÄ±narak, asgari Ã¼cretten ve emsal Ã§alÄ±ÅŸanlardan belirgin ÅŸekilde yÃ¼ksek tespit edilmiÅŸtir. Bu Ã§erÃ§evede; yasal sÄ±nÄ±r olan yÄ±llÄ±k 270 saate kadar yapÄ±lacak fazla Ã§alÄ±ÅŸmalar, hafta tatili Ã§alÄ±ÅŸmalarÄ± ve ulusal bayram/genel tatil gÃ¼nÃ¼ Ã§alÄ±ÅŸmalarÄ± kararlaÅŸtÄ±rÄ±lan aylÄ±k Ã¼crete dahildir. PERSONEL, bu Ã§alÄ±ÅŸmalar iÃ§in ayrÄ±ca Ã¼cret talep etmeyeceÄŸini kabul eder.</p>
<p><strong>4.3. DenkleÅŸtirme ve Serbest Zaman:</strong> YÄ±llÄ±k 270 saati aÅŸan bir fazla Ã§alÄ±ÅŸma yapÄ±lmasÄ± ve bunun yazÄ±lÄ± delillerle ispatlanmasÄ± durumunda; aÅŸan kÄ±smÄ±n karÅŸÄ±lÄ±ÄŸÄ± nakdi Ã¼cret olarak deÄŸil, 4857 sayÄ±lÄ± Ä°ÅŸ Kanunu'nun 41. maddesi uyarÄ±nca zamlÄ± oran Ã¼zerinden hesaplanacak "Serbest Zaman" (Ä°zin) olarak kullandÄ±rÄ±lacaktÄ±r.</p>
</div></div>

<div class="doc-article"><div class="doc-article-title">MADDE 5: ÃœCRET VE YAN HAKLAR</div><div class="doc-article-content">
<p><strong>5.1. Ãœcret:</strong> PERSONEL'e aylÄ±k BrÃ¼t {{UCRET}} TL Ã¼cret Ã¶denecektir. Ãœcret, her ayÄ±n sonunda PERSONEL'in banka hesabÄ±na yatÄ±rÄ±lÄ±r.</p>
<p><strong>5.2. Performans Primi:</strong> Ä°ÅžVEREN, tek taraflÄ± inisiyatifi ile belirleyeceÄŸi yÄ±llÄ±k hedeflerin (KPI) tutturulmasÄ± halinde PERSONEL'e prim Ã¶demesi yapabilir. Prim uygulamasÄ±, "Ä°ÅŸyeri ÅžartÄ±" niteliÄŸinde olmayÄ±p, Ä°ÅžVEREN tarafÄ±ndan her dÃ¶nem deÄŸiÅŸtirilebilir veya tamamen kaldÄ±rÄ±labilir.</p>
<p><strong>5.3. AraÃ§ ve Ekipman:</strong> GÃ¶rev gereÄŸi tahsis edilen ÅŸirket aracÄ±, bilgisayar ve telefon, sadece iÅŸ amaÃ§lÄ± kullanÄ±m iÃ§indir. Ä°ÅŸ sÃ¶zleÅŸmesinin sona ermesi veya Ä°ÅžVEREN'in talebi halinde bu ekipmanlar derhal ve eksiksiz iade edilecektir.</p>
</div></div>

<div class="doc-article"><div class="doc-article-title">MADDE 6: ÅžÄ°RKET ARACI KULLANIMI VE TRAFÄ°K CEZALARI</div><div class="doc-article-content">
<p><strong>6.1. Sorumluluk:</strong> PERSONEL, kendisine tahsis edilen ÅŸirket aracÄ±nÄ± KarayollarÄ± Trafik Kanunu'na ve iÅŸ gÃ¼venliÄŸi kurallarÄ±na uygun kullanmakla yÃ¼kÃ¼mlÃ¼dÃ¼r.</p>
<p><strong>6.2. CezalarÄ±n RÃ¼cu Edilmesi:</strong> PERSONEL'in kullanÄ±mÄ±nda iken (ister mesai iÃ§inde ister dÄ±ÅŸÄ±nda) araca kesilen trafik cezalarÄ±ndan (hÄ±z, park, kÄ±rmÄ±zÄ± Ä±ÅŸÄ±k vb.) PERSONEL ÅŸahsen sorumludur. ÅžÄ°RKET, yasal zorunluluk gereÄŸi cezayÄ± Ã¶demek zorunda kalÄ±rsa; PERSONEL, Ã¶denen tutarÄ± ilk yazÄ±lÄ± bildirimde ÅžÄ°RKET'e nakden Ã¶demeyi veya ilgili tutarÄ±n Ã¼cretinden mahsup edilmesi iÃ§in her olay Ã¶zelinde ayrÄ±ca muvafakatname vermeyi kabul ve taahhÃ¼t eder.</p>
<p><strong>6.3. Disiplin:</strong> PERSONEL'in kusurlu davranÄ±ÅŸÄ± sonucu oluÅŸan trafik cezalarÄ±nÄ± Ã¶demekten imtina etmesi veya rÃ¼cu iÅŸlemine onay vermemesi, iÅŸverene zarar verme kastÄ± taÅŸÄ±dÄ±ÄŸÄ±ndan, Ä°ÅŸ Kanunu m. 25/II kapsamÄ±nda haklÄ± fesih nedeni sayÄ±labilecektir.</p>
</div></div>

<div class="doc-article"><div class="doc-article-title">MADDE 7: REKABET YASAÄžI, GÄ°ZLÄ°LÄ°K VE CEZAÄ° ÅžART</div><div class="doc-article-content">
<p><strong>7.1. Gizlilik ve Ticari SÄ±r:</strong> PERSONEL; ÅžÄ°RKET'in maliyet yapÄ±larÄ±, franchise koÅŸullarÄ±, tedarikÃ§i anlaÅŸmalarÄ±, mÃ¼ÅŸteri veritabanÄ±, Ã¶zel tarifeleri ve bÃ¼yÃ¼me stratejileri gibi "Ticari SÄ±r" niteliÄŸindeki bilgilere vakÄ±ftÄ±r. Bu bilgilerin sÃ¶zleÅŸme sÃ¼resince veya sona erdikten sonra Ã¼Ã§Ã¼ncÃ¼ kiÅŸilerle paylaÅŸÄ±lmasÄ±, TCK m. 239 kapsamÄ±nda suÃ§ teÅŸkil eder ve tazminatsÄ±z derhal fesih nedenidir.</p>
<p><strong>7.2. Rekabet YasaÄŸÄ± (TBK 444-447):</strong> PERSONEL, iÅŸ sÃ¶zleÅŸmesi herhangi bir nedenle (iÅŸverenin haklÄ± feshi veya personelin istifasÄ±/haksÄ±z feshi ile) sona erdikten sonra 2 (iki) yÄ±l sÃ¼reyle; son gÃ¶rev yaptÄ±ÄŸÄ± il sÄ±nÄ±rlarÄ± iÃ§erisinde, "Kahve Zinciri, Kafe-Restoran ve GÄ±da PerakendeciliÄŸi" sektÃ¶rÃ¼nde faaliyet gÃ¶steren rakip bir firmada Ã§alÄ±ÅŸmamayÄ±, ortak olmamayÄ± veya danÄ±ÅŸmanlÄ±k yapmamayÄ± taahhÃ¼t eder.</p>
<p><strong>7.3. Cezai Åžart:</strong> PERSONEL'in iÅŸbu 7. maddede dÃ¼zenlenen rekabet yasaÄŸÄ±nÄ± ihlal etmesi halinde; ÅžÄ°RKET'in uÄŸradÄ±ÄŸÄ± zararÄ±n miktarÄ±nÄ± ispat etmesine gerek kalmaksÄ±zÄ±n, PERSONEL, son brÃ¼t maaÅŸÄ±nÄ±n 6 (AltÄ±) katÄ± tutarÄ±nda cezai ÅŸartÄ± Ä°ÅžVEREN'e derhal ve nakden Ã¶demeyi kabul ve taahhÃ¼t eder. Ä°ÅžVEREN'in bu miktarÄ± aÅŸan zararlarÄ±nÄ± talep hakkÄ± ve TBK m. 446/2 uyarÄ±nca rekabet edici davranÄ±ÅŸa son verilmesini talep hakkÄ± saklÄ±dÄ±r.</p>
<p><strong>7.4. Ayartma YasaÄŸÄ± (Non-Solicitation):</strong> PERSONEL, iÅŸten ayrÄ±ldÄ±ktan sonra 2 yÄ±l sÃ¼reyle, ÅžÄ°RKET Ã§alÄ±ÅŸanlarÄ±nÄ± yeni iÅŸyerine transfer etmeyeceÄŸini, onlara iÅŸ teklifinde bulunmayacaÄŸÄ±nÄ± taahhÃ¼t eder.</p>
</div></div>

<div class="doc-article"><div class="doc-article-title">MADDE 8: FÄ°KRÄ° MÃœLKÄ°YET HAKLARININ DEVRÄ°</div><div class="doc-article-content">
<p>PERSONEL, iÅŸbu sÃ¶zleÅŸme kapsamÄ±nda gÃ¶revi sÄ±rasÄ±nda veya gÃ¶revi nedeniyle meydana getirdiÄŸi/getireceÄŸi her tÃ¼rlÃ¼ fikir, sanat eseri, rapor, operasyonel sÃ¼reÃ§ tasarÄ±mÄ±, eÄŸitim materyali, bilgisayar programÄ±, veri tabanÄ± ve iÅŸ geliÅŸtirme projeleri Ã¼zerindeki 5846 sayÄ±lÄ± FSEK kapsamÄ±ndaki tÃ¼m mali haklarÄ± (iÅŸleme, Ã§oÄŸaltma, yayma, temsil, umuma iletim) yer, sÃ¼re ve sayÄ± sÄ±nÄ±rÄ± olmaksÄ±zÄ±n, iÅŸbu sÃ¶zleÅŸmedeki Ã¼cret karÅŸÄ±lÄ±ÄŸÄ±nda mÃ¼nhasÄ±ran ÅžÄ°RKET'e devrettiÄŸini; bu haklarÄ±n kullanÄ±mÄ± ve devri konusunda ÅžÄ°RKET'in tam yetkili olduÄŸunu kabul ve beyan eder.</p>
</div></div>

<div class="doc-article"><div class="doc-article-title">MADDE 9: ÃœCRETLÄ° UZAKLAÅžTIRMA (GARDEN LEAVE)</div><div class="doc-article-content">
<p>Ä°ÅŸ sÃ¶zleÅŸmesinin herhangi bir nedenle feshi ihbarÄ±nda bulunulmasÄ± halinde (taraflardan hangisinin ihbar ettiÄŸine bakÄ±lmaksÄ±zÄ±n); ÅžÄ°RKET, ihbar sÃ¼resinin tamamÄ±nda veya bir kÄ±smÄ±nda PERSONEL'i iÅŸyerine gelmekten, iÅŸ gÃ¶rme borcunu ifa etmekten ve ÅŸirket sistemlerine eriÅŸmekten muaf tutma (Garden Leave) hakkÄ±na sahiptir. Bu sÃ¼re zarfÄ±nda PERSONEL'in Ã¼cret ve yan haklarÄ± (prim hariÃ§) Ã¶denmeye devam eder. PERSONEL, bu sÃ¼re iÃ§inde baÅŸka bir iÅŸverene hizmet veremez, rekabet edemez ve sadakat borcuna aykÄ±rÄ± davranamaz.</p>
</div></div>

<div class="doc-article"><div class="doc-article-title">MADDE 10: KÄ°ÅžÄ°SEL VERÄ°LERÄ°N KORUNMASI (KVKK) VE Ä°ZLEME</div><div class="doc-article-content">
<p><strong>10.1.</strong> ÅžÄ°RKET; iÅŸ saÄŸlÄ±ÄŸÄ± gÃ¼venliÄŸi, operasyonel verimlilik, ÅŸirket varlÄ±klarÄ±nÄ±n korunmasÄ± ve yasal yÃ¼kÃ¼mlÃ¼lÃ¼kler (iÅŸin ifasÄ± ve meÅŸru menfaat) sebepleriyle; iÅŸyerlerinde, ofislerde kamera ile gÃ¶rÃ¼ntÃ¼ kaydÄ± ve ÅŸirket araÃ§larÄ±nda GPS (Konum) takip sistemi kullanmaktadÄ±r.</p>
<p><strong>10.2.</strong> PERSONEL, bu veri iÅŸleme faaliyetleri, kameralarÄ±n bulunduÄŸu yerler ve araÃ§ takip sisteminin Ã§alÄ±ÅŸma prensipleri hakkÄ±nda kendisine ayrÄ±ca tebliÄŸ edilen "Ã‡alÄ±ÅŸan AydÄ±nlatma Metni" ile 6698 sayÄ±lÄ± KVKK kapsamÄ±nda detaylÄ±ca bilgilendirildiÄŸini, mesai saatleri dÄ±ÅŸÄ±nda ÅŸirket aracÄ±nÄ±n kullanÄ±mÄ± durumunda da (Ã¶zel kullanÄ±m izni varsa) GPS kaydÄ±nÄ±n devam edebileceÄŸini bildiÄŸini beyan eder.</p>
</div></div>

<div class="doc-article"><div class="doc-article-title">MADDE 11: MOBBÄ°NG VE ETÄ°K HAT</div><div class="doc-article-content">
<p>PERSONEL, iÅŸyerinde karÅŸÄ±laÅŸabileceÄŸi her tÃ¼rlÃ¼ etik dÄ±ÅŸÄ± davranÄ±ÅŸ, ayrÄ±mcÄ±lÄ±k veya psikolojik taciz (mobbing) iddiasÄ±nÄ±, yasal yollara baÅŸvurmadan Ã¶nce ivedilikle Åžirket YÃ¶netim Kurulu'na veya varsa "Etik HattÄ±"na yazÄ±lÄ± olarak bildirmeyi kabul eder. ÅžÄ°RKET, bu baÅŸvurularÄ± gizlilik iÃ§inde inceleyip sonuÃ§landÄ±racaÄŸÄ±nÄ± taahhÃ¼t eder.</p>
</div></div>

<div class="doc-article"><div class="doc-article-title">MADDE 12: SON HÃœKÃœMLER VE YÃœRÃœRLÃœK</div><div class="doc-article-content">
<p><strong>12.1.</strong> Ä°ÅŸbu sÃ¶zleÅŸmede hÃ¼kÃ¼m bulunmayan hallerde 4857 sayÄ±lÄ± Ä°ÅŸ Kanunu, 6098 sayÄ±lÄ± TBK ve ilgili mevzuat hÃ¼kÃ¼mleri uygulanÄ±r.</p>
<p><strong>12.2.</strong> UyuÅŸmazlÄ±k halinde Ä°stanbul (Ã‡aÄŸlayan) Mahkemeleri ve Ä°cra Daireleri yetkilidir.</p>
<p><strong>12.3.</strong> Ä°ki sayfadan ve 12 maddeden ibaret iÅŸbu sÃ¶zleÅŸme, {{BASLAMA}} tarihinde taraflarca okunarak, iÃ§eriÄŸi mÃ¼zakere edilip tam olarak anlaÅŸÄ±larak serbest iradeleriyle imzalanmÄ±ÅŸ ve bir nÃ¼shasÄ± PERSONEL'e teslim edilmiÅŸtir.</p>
</div></div>`
    },
    fesihDayanaklari: {
        hakli: [
            {v:'25_2_a',t:'25/II-a: YanÄ±ltma'},
            {v:'25_2_b',t:'25/II-b: Hakaret'},
            {v:'25_2_d',t:'25/II-d: SataÅŸma/SarhoÅŸluk'},
            {v:'25_2_e',t:'25/II-e: GÃ¼veni kÃ¶tÃ¼ye kullanma'},
            {v:'25_2_g',t:'25/II-g: DevamsÄ±zlÄ±k'},
            {v:'25_2_h',t:'25/II-h: GÃ¶rev reddi'},
            {v:'25_2_i',t:'25/II-Ä±: Ä°ÅŸ gÃ¼venliÄŸi'}
        ],
        gecerli: [
            {v:'18_y',t:'Yetersizlik'},
            {v:'18_d',t:'DavranÄ±ÅŸ'},
            {v:'18_i',t:'Ä°ÅŸletme gerekleri'}
        ],
        deneme: [{v:'deneme',t:'Deneme deÄŸerlendirmesi'}]
    },
    documentTemplates: {
        tutanak: {
            olay: '<p><strong>OLAY:</strong></p><p>{{TARIH}} tarihinde saat {{SAAT}} sÄ±ralarÄ±nda, {{SUBE}} ÅŸubesinde gÃ¶revli {{PERSONEL}} ({{TC}}) aÅŸaÄŸÄ±da aÃ§Ä±klanan olayÄ± gerÃ§ekleÅŸtirmiÅŸtir:</p><p style="background:#f9f9f9;padding:15px;border-left:4px solid #ff8674;margin:15px 0">{{ACIKLAMA}}</p><p>Ä°ÅŸbu tutanak, olayÄ±n tespiti amacÄ±yla dÃ¼zenlenmiÅŸ olup, ilgili personele tebliÄŸ edilmiÅŸtir.</p>',
            devamsizlik: '<p><strong>DEVAMSIZLIK TESPÄ°TÄ°:</strong></p><p>{{PERSONEL}} ({{TC}}), {{TARIH}} tarihinde {{SUBE}} ÅŸubesinde gÃ¶reve gelmemiÅŸtir.</p><p>YapÄ±lan araÅŸtÄ±rmada herhangi bir mazeret bildirimi tespit edilememiÅŸtir.</p><p style="background:#fef9e7;padding:12px;border-radius:6px;margin:15px 0">âš ï¸ Ä°ÅŸ Kanunu Md. 25/II-g: ArdÄ± ardÄ±na 2 iÅŸ gÃ¼nÃ¼ veya ay iÃ§inde 3 iÅŸ gÃ¼nÃ¼ devamsÄ±zlÄ±k haklÄ± fesih sebebidir.</p>',
            kasa: '<p><strong>KASA SAYIM TESPÄ°TÄ°:</strong></p><p>{{TARIH}} tarihinde saat {{SAAT}} itibarÄ±yla {{SUBE}} ÅŸubesinde yapÄ±lan kasa sayÄ±mÄ±nda aÅŸaÄŸÄ±daki tespit yapÄ±lmÄ±ÅŸtÄ±r:</p><p>Sorumlu personel: {{PERSONEL}} ({{TC}})</p><p style="background:#f9f9f9;padding:15px;border-left:4px solid #ff8674;margin:15px 0">{{ACIKLAMA}}</p><p>TBK Md. 407/2 uyarÄ±nca personelin yazÄ±lÄ± muvafakati ile Ã¼cretinden kesinti yapÄ±labilir.</p>',
            imza: '<p><strong>Ä°MZADAN Ä°MTÄ°NA TESPÄ°TÄ°:</strong></p><p>{{TARIH}} tarihinde {{PERSONEL}} ({{TC}}) adlÄ± personele tebliÄŸ edilmek istenen belgeyi imzalamaktan imtina etmiÅŸtir.</p><p>Ä°mtina edilen belge: {{ACIKLAMA}}</p><p style="background:#ebf5fb;padding:12px;border-radius:6px;margin:15px 0">ðŸ“Œ YargÄ±tay iÃ§tihadÄ± gereÄŸi, 2 ÅŸahit huzurunda dÃ¼zenlenen imtina tutanaÄŸÄ± tebliÄŸ yerine geÃ§er.</p>'
        },
        savunma: '<p>Åžirketimiz {{SUBE}} ÅŸubesinde {{POZISYON}} olarak gÃ¶rev yapmaktasÄ±nÄ±z.</p><p><strong>{{TARIH}}</strong> tarihinde gerÃ§ekleÅŸtirdiÄŸiniz aÅŸaÄŸÄ±daki davranÄ±ÅŸ/eylem nedeniyle savunmanÄ±z istenmektedir:</p><p style="background:#f9f9f9;padding:15px;border-left:4px solid #ff8674;margin:15px 0">{{ACIKLAMA}}</p><p>Bu davranÄ±ÅŸ <strong>{{DAYANAK}}</strong> kapsamÄ±nda deÄŸerlendirilmektedir.</p><p style="background:#fef9e7;padding:12px;border-radius:6px;margin:15px 0">âš ï¸ SavunmanÄ±zÄ± bu yazÄ±nÄ±n tebliÄŸinden itibaren <strong>{{SURE}}</strong> iÃ§inde yazÄ±lÄ± olarak vermeniz gerekmektedir. SÃ¼resinde savunma verilmemesi, savunma hakkÄ±ndan vazgeÃ§ilmiÅŸ sayÄ±lacaktÄ±r.</p>',
        fesih: {
            hakli: '<p>{{TARIH}} tarihinde gerÃ§ekleÅŸtirdiÄŸiniz aÅŸaÄŸÄ±daki eylem/davranÄ±ÅŸ nedeniyle iÅŸ sÃ¶zleÅŸmeniz <strong>4857 sayÄ±lÄ± Ä°ÅŸ Kanunu\'nun {{DAYANAK}} maddesi</strong> uyarÄ±nca haklÄ± nedenle ve derhal feshedilmiÅŸtir:</p><p style="background:#f9f9f9;padding:15px;border-left:4px solid #c0392b;margin:15px 0">{{ACIKLAMA}}</p><p>Bu fesih iÅŸlemi sonucunda kÄ±dem ve ihbar tazminatÄ± Ã¶denmeyecektir.</p>',
            gecerli: '<p>AÅŸaÄŸÄ±da belirtilen nedenlerle iÅŸ sÃ¶zleÅŸmeniz <strong>4857 sayÄ±lÄ± Ä°ÅŸ Kanunu\'nun 17. ve 18. maddeleri</strong> uyarÄ±nca geÃ§erli nedenle feshedilmiÅŸtir:</p><p style="background:#f9f9f9;padding:15px;border-left:4px solid #ff8674;margin:15px 0">{{ACIKLAMA}}</p><p>Ä°hbar sÃ¼reniz: {{IHBAR_SURE}}<br>Son Ã§alÄ±ÅŸma gÃ¼nÃ¼nÃ¼z: {{SON_GUN}}</p><p>KÄ±dem tazminatÄ± ve diÄŸer yasal haklarÄ±nÄ±z Ã¶denecektir.</p>',
            deneme: '<p>{{BASLAMA}} tarihinde baÅŸlayan iÅŸ sÃ¶zleÅŸmeniz, 2 aylÄ±k deneme sÃ¼resi iÃ§inde <strong>4857 sayÄ±lÄ± Ä°ÅŸ Kanunu\'nun 15. maddesi</strong> uyarÄ±nca sona erdirilmiÅŸtir.</p><p style="background:#f9f9f9;padding:15px;border-left:4px solid #3498db;margin:15px 0">{{ACIKLAMA}}</p><p>Deneme sÃ¼resi iÃ§inde fesih bildirim sÃ¼resine ve tazminata tabi deÄŸildir.</p>'
        },
        borc: '<p>Ben {{PERSONEL}}, {{TARIH}} tarihli olayda kusurum nedeniyle <strong>{{TUTAR}} TL</strong> borcu kabul ediyorum.</p><p style="background:#f9f9f9;padding:15px;border-left:4px solid #ff8674;margin:15px 0">{{ACIKLAMA}}</p><p>TBK Md. 407/2 uyarÄ±nca bu borcun {{ODEME_SEKLI}} kabul ve taahhÃ¼t ediyorum.</p><p>BaskÄ± altÄ±nda olmadÄ±ÄŸÄ±mÄ±, borcumu ve kesinti koÅŸullarÄ±nÄ± anladÄ±ÄŸÄ±mÄ± beyan ederim.</p>'
    }
};

// ==================== STATE MANAGEMENT ====================
let STATE = {};
let currentPage = 'dashboard';
let previousPage = 'dashboard';
let selectedTypes = {sozlesme: 'barista', tutanak: null, fesih: null};

function loadState() {
    const saved = localStorage.getItem('moonberry_state');
    if (saved) {
        try {
            const parsed = JSON.parse(saved);
            // Deep merge for nested objects like company
            STATE = {...DEFAULT_STATE, ...parsed};
            STATE.company = {...DEFAULT_STATE.company, ...parsed.company};
            
            // Pozisyon migration - eksik role ve icon alanlarÄ±nÄ± ekle
            migratePositions();
        } catch(e) {
            STATE = {...DEFAULT_STATE};
        }
    } else {
        STATE = {...DEFAULT_STATE};
    }
    saveState();
}

// Eski pozisyonlara role ve icon ekle
function migratePositions() {
    const defaultRoles = {
        'barista': { role: 'barista', icon: 'ðŸ§‘â€ðŸ³' },
        'mudur_yardimcisi': { role: 'mudur_yardimcisi', icon: 'ðŸ‘”' },
        'magaza_muduru': { role: 'magaza_muduru', icon: 'ðŸª' },
        'bolge_muduru': { role: 'bolge_muduru', icon: 'ðŸŒ' }
    };
    
    STATE.positions = STATE.positions.map(p => {
        // role yoksa ekle
        if (!p.role) {
            p.role = defaultRoles[p.id]?.role || 'barista';
        }
        // icon yoksa ekle
        if (!p.icon) {
            p.icon = defaultRoles[p.id]?.icon || 'ðŸ‘¤';
        }
        return p;
    });
}

function saveState() {
    localStorage.setItem('moonberry_state', JSON.stringify(STATE));
    
    // PozisyonlarÄ± Firebase'e de kaydet
    if (db && STATE.positions && STATE.positions.length > 0) {
        db.collection('systemConfig').doc('positions').set({
            positions: STATE.positions,
            updatedAt: new Date().toISOString()
        }).then(() => {
            console.log('[saveState] Pozisyonlar Firebase\'e kaydedildi');
        }).catch(err => {
            console.warn('[saveState] Firebase kaydetme hatasÄ±:', err.message);
        });
    }
}

// ==================== INIT ====================
document.addEventListener('DOMContentLoaded', () => {
    // Firebase Initialize
    if (typeof firebase !== 'undefined') {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        console.log('Firebase initialized');
        
        // Auth State Listener - KullanÄ±cÄ± oturum durumunu takip et
        firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                // KullanÄ±cÄ± giriÅŸ yapmÄ±ÅŸ
                console.log('User logged in:', user.email || 'Anonymous');
                
                // KullanÄ±cÄ± bilgilerini Firestore'dan al
                try {
                    // Ã–nce config'i yÃ¼kle (email mapping iÃ§in)
                    await loadSystemConfig();
                    
                    // ========== ANONYMOUS AUTH KONTROLÃœ ==========
                    if (user.isAnonymous || !user.email) {
                        // localStorage'dan kullanÄ±cÄ± bilgisini al
                        const storedUser = localStorage.getItem('mb_user');
                        
                        if (!storedUser) {
                            console.log('ðŸš« Anonymous user ama localStorage boÅŸ - login\'e yÃ¶nlendir');
                            await firebase.auth().signOut();
                            window.location.replace('login.html');
                            return;
                        }
                        
                        const userData = JSON.parse(storedUser);
                        console.log('âœ… Anonymous Auth - localStorage\'dan kullanÄ±cÄ±:', userData.name);
                        
                        // Admin kontrolÃ¼ - systemConfig'den
                        let isAdmin = false;
                        try {
                            const configDoc = await db.collection('systemConfig').doc('main').get();
                            if (configDoc.exists) {
                                const adminEmails = configDoc.data().adminEmails || [];
                                isAdmin = adminEmails.includes(userData.email);
                            }
                        } catch (e) {
                            console.log('Config okunamadÄ±:', e);
                        }
                        
                        if (isAdmin) {
                            // Admin kullanÄ±cÄ± - personel kontrolÃ¼ atla
                            console.log('âœ… Admin kullanÄ±cÄ± tanÄ±ndÄ±');
                            currentUser = {
                                id: user.uid,
                                email: userData.email,
                                name: userData.name || 'YÃ¶netici',
                                role: 'yonetici',
                                branch: 'all',
                                uniqueId: 'admin',
                                authType: 'anonymous'
                            };
                        } else {
                            // Personel hala aktif mi kontrol et
                            const personelCheck = await db.collection('personel')
                                .where('email', '==', userData.email)
                                .limit(1)
                                .get();
                            
                            if (personelCheck.empty) {
                                console.log('ðŸš« Personel kaydÄ± silinmiÅŸ - logout');
                                localStorage.removeItem('mb_user');
                                await firebase.auth().signOut();
                                alert('Bu hesap artÄ±k aktif deÄŸil.');
                                window.location.replace('login.html');
                                return;
                            }
                            
                            // GÃ¼ncel personel verisini al (rol deÄŸiÅŸmiÅŸ olabilir)
                            const personelData = personelCheck.docs[0].data();
                            
                            currentUser = {
                                id: user.uid,
                                personelId: personelCheck.docs[0].id,
                                email: userData.email,
                                name: personelData.name || userData.name,
                                codeName: personelData.codeName || '',
                                uniqueId: personelData.uniqueId || userData.uniqueId,
                                role: personelData.role || userData.role,
                                branch: personelData.branch || userData.branch || 'all',
                                position: personelData.position || userData.position,
                                authType: 'anonymous'
                            };
                        }
                        
                        // localStorage'Ä± gÃ¼ncelle (rol/branch deÄŸiÅŸmiÅŸ olabilir)
                        localStorage.setItem('mb_user', JSON.stringify(currentUser));
                        
                    } else {
                        // ========== NORMAL EMAIL AUTH ==========
                        // Admin kontrolÃ¼ - Config'den dinamik liste
                        const isAdmin = await checkAdminEmail(user.email);
                        
                        // 1. Ã–NCE PERSONEL koleksiyonundan email ile bul
                        let foundInPersonel = false;
                        const personelSnapshot = await db.collection('personel').where('email', '==', user.email).limit(1).get();
                        
                        if (!personelSnapshot.empty) {
                            const personelDoc = personelSnapshot.docs[0];
                            const personelData = personelDoc.data();
                            
                            if (personelData.role) {
                                currentUser = {
                                    id: user.uid,
                                    personelId: personelDoc.id,
                                    email: user.email,
                                    name: personelData.name,
                                    codeName: personelData.codeName || '',
                                    uniqueId: personelData.uniqueId,
                                    role: personelData.role,
                                    branch: personelData.branch || 'all',
                                    position: personelData.position,
                                    authType: 'email'
                                };
                                foundInPersonel = true;
                                console.log('âœ… Personel koleksiyonundan kullanÄ±cÄ± bulundu:', currentUser.name, currentUser.role);
                                
                                // localStorage'a da kaydet
                                localStorage.setItem('mb_user', JSON.stringify(currentUser));
                            }
                        }
                        
                        // 2. GÃœVENLÄ°K: Personel'de bulunamadÄ± VE admin deÄŸilse â†’ LOGOUT
                        if (!foundInPersonel && !isAdmin) {
                            console.log('ðŸš« Personel kaydÄ± bulunamadÄ±, eriÅŸim engellendi:', user.email);
                            await firebase.auth().signOut();
                            alert('Bu hesap artÄ±k aktif deÄŸil.');
                            window.location.replace('login.html');
                            return;
                        }
                        
                        // 3. Admin ise Ã¶zel ayar
                        if (!foundInPersonel && isAdmin) {
                            currentUser = {
                                id: user.uid,
                                email: user.email,
                                name: 'YÃ¶netici',
                                role: 'yonetici',
                                branch: 'all',
                                authType: 'email'
                            };
                            console.log('âœ… Admin kullanÄ±cÄ±:', currentUser.email);
                            localStorage.setItem('mb_user', JSON.stringify(currentUser));
                        }
                    }
                    
                    // KullanÄ±cÄ± adÄ±nÄ± sidebar'da gÃ¶ster
                    document.getElementById('userName').textContent = currentUser.name || currentUser.email;
                    document.getElementById('userRole').textContent = getRoleName(currentUser.role);
                    
                    // Session durumunu kontrol et
                    const sessionValid = await checkSessionValidity();
                    if (!sessionValid) {
                        console.log('Session invalid - logging out');
                        await firebase.auth().signOut();
                        window.location.replace('login.html');
                        return;
                    }
                    
                    // Uygulama gÃ¶rÃ¼nÃ¼r
                    document.querySelector('.app').style.opacity = '1';
                    applyUserPermissions();
                    loadFirebaseData();
                    
                    // Barista kÄ±sÄ±tlamalarÄ±nÄ± uygula
                    if (currentUser?.role === 'barista') {
                        applyBaristaRestrictions();
                    }
                    
                    // Config yÃ¼kle ve Dashboard verilerini yÃ¼kle
                    loadSystemConfig().then(async () => {
                        console.log('Config yÃ¼klendi, personel cache yÃ¼kleniyor...');
                        await loadPersonelDisplayCache();
                        console.log('Cache yÃ¼klendi, dashboard yÃ¼kleniyor...');
                        loadTodayChecks();
                        initChecklistlerTab(); // Checklistler tabÄ±nÄ± yÃ¶netici iÃ§in gÃ¶ster
                    });
                    
                    // Ã–nizleme modunu kontrol et
                    checkPreviewMode();
                    
                    // GiriÅŸ aktivitesini logla
                    logActivity('login', { device: navigator.userAgent });
                    
                    // NOT: Otomatik yedekleme devre dÄ±ÅŸÄ± - manuel yedekleme kullanÄ±n
                } catch (error) {
                    console.error('Error loading user data:', error);
                }
            } else {
                // KullanÄ±cÄ± Ã§Ä±kÄ±ÅŸ yapmÄ±ÅŸ - Login sayfasÄ±na yÃ¶nlendir
                console.log('User logged out - redirecting to login');
                window.location.replace('login.html');
            }
        });
    } else {
        console.error('Firebase SDK not loaded');
    }
    
    loadState();
    initDefaultData();
    initUI();
});

// Ã‡Ä±kÄ±ÅŸ yap fonksiyonu
async function logout() {
    try {
        // Ã‡Ä±kÄ±ÅŸ aktivitesini logla (currentUser silinmeden Ã¶nce)
        await logActivity('logout', { reason: 'user_initiated' });
        
        // Oturumu sonlandÄ±r
        if (currentUser?.sessionId) {
            try {
                await db.collection('sessions').doc(currentUser.sessionId).update({
                    status: 'ended',
                    endedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (e) {
                console.error('Oturum sonlandÄ±rma hatasÄ±:', e);
            }
        }
        
        // Session bilgilerini temizle
        localStorage.removeItem('mb_session_id');
        localStorage.removeItem('mb_user');
        
        // Session timeout'larÄ± temizle
        if (sessionTimeoutId) clearTimeout(sessionTimeoutId);
        if (sessionWarningId) clearTimeout(sessionWarningId);
        
        await firebase.auth().signOut();
        currentUser = null;
        
        // Login sayfasÄ±na yÃ¶nlendir
        window.location.replace('login.html');
    } catch (error) {
        console.error('Logout error:', error);
        toast('Ã‡Ä±kÄ±ÅŸ hatasÄ±', 'error');
    }
}

// Sidebar nav grup toggle
function toggleNavGroup(label) {
    label.classList.toggle('collapsed');
    const items = label.nextElementSibling;
    if (items) {
        items.classList.toggle('collapsed');
    }
}

// Sidebar toggle (collapse/expand)
function toggleSidebar() {
    const sidebar = document.querySelector('.sidebar');
    const main = document.querySelector('.main');
    
    sidebar.classList.toggle('collapsed');
    main.classList.toggle('sidebar-collapsed');
    
    // Tercihi kaydet
    localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
}

function initSidebarState() {
    const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
    const sidebar = document.querySelector('.sidebar');
    const main = document.querySelector('.main');
    
    if (isCollapsed && sidebar && main) {
        sidebar.classList.add('collapsed');
        main.classList.add('sidebar-collapsed');
    }
    
    // Nav item'lara tooltip ekle
    document.querySelectorAll('.nav-item[data-page]').forEach(item => {
        const text = item.textContent.trim();
        item.setAttribute('data-tooltip', text);
    });
    
    // Collapsed sidebar'a tÄ±klayÄ±nca aÃ§ (toggle butonu ve nav-item hariÃ§)
    if (sidebar) {
        sidebar.addEventListener('click', (e) => {
            if (sidebar.classList.contains('collapsed')) {
                // Nav-item veya sidebar-action-btn'a tÄ±klanmadÄ±ysa aÃ§
                const isNavItem = e.target.closest('.nav-item');
                const isUserInfo = e.target.closest('#userInfo');
                if (!isNavItem && !isUserInfo) {
                    toggleSidebar();
                }
            }
        });
    }
    
    // Main alana tÄ±klayÄ±nca sidebar'Ä± kapat (aÃ§Ä±ksa)
    if (main) {
        main.addEventListener('click', () => {
            if (sidebar && !sidebar.classList.contains('collapsed')) {
                // Sadece mobilde veya kullanÄ±cÄ± isterse - ÅŸimdilik pasif
                // toggleSidebar();
            }
        });
    }
}

function initUI() {
    initSidebarState();
    loadMotivationQuote();
    populateSelects();
    renderPositionCards();
    renderViolations();
    renderAdminLists();
    loadAdminFields();
    setDefaultDates();
    
    // Belge ÅŸablonlarÄ± iÃ§in varsayÄ±lanÄ± yÃ¼kle
    if (document.getElementById('doc_template_content')) {
        loadDocTemplate('tutanak', 'olay');
    }
}

function setDefaultDates() {
    const now = new Date();
    const dateStr = now.toISOString().split('T')[0];
    const timeStr = now.toTimeString().slice(0, 5);
    
    // Tutanak varsayÄ±lan tarih/saatleri
    const tutTarih = document.getElementById('tut_tarih');
    const tutSaat = document.getElementById('tut_saat');
    const tutDuzTarih = document.getElementById('tut_duz_tarih');
    const tutDuzSaat = document.getElementById('tut_duz_saat');
    if (tutTarih) tutTarih.value = dateStr;
    if (tutSaat) tutSaat.value = timeStr;
    if (tutDuzTarih) tutDuzTarih.value = dateStr;
    if (tutDuzSaat) tutDuzSaat.value = timeStr;
    
    // Savunma varsayÄ±lan tarih
    const savTarih = document.getElementById('sav_tarih');
    const savDuzTarih = document.getElementById('sav_duz_tarih');
    const savDuzSaat = document.getElementById('sav_duz_saat');
    if (savTarih) savTarih.value = dateStr;
    if (savDuzTarih) savDuzTarih.value = dateStr;
    if (savDuzSaat) savDuzSaat.value = timeStr;
    
    // Fesih varsayÄ±lan tarihler
    const fesOgrenme = document.getElementById('fes_ogrenme');
    const fesTarih = document.getElementById('fes_tarih');
    if (fesOgrenme) fesOgrenme.value = dateStr;
    if (fesTarih) fesTarih.value = dateStr;
    
    // BorÃ§ varsayÄ±lan tarih
    const borcTarih = document.getElementById('borc_tarih');
    const borcDuzTarih = document.getElementById('borc_duz_tarih');
    if (borcTarih) borcTarih.value = dateStr;
    if (borcDuzTarih) borcDuzTarih.value = dateStr;
    
    // Avans varsayÄ±lan tarih
    const avansTarih = document.getElementById('avans_tarih');
    if (avansTarih) avansTarih.value = dateStr;
    
    // Zimmet varsayÄ±lan tarih
    const zimmetTarih = document.getElementById('zimmet_tarih');
    if (zimmetTarih) zimmetTarih.value = dateStr;
    
    // SÃ¶zleÅŸme varsayÄ±lan baÅŸlama tarihi
    const sozBaslama = document.getElementById('soz_baslama');
    if (sozBaslama) sozBaslama.value = dateStr;
}

function populateSelects() {
    // Åžube selectleri
    const branchSelects = ['soz_sube', 'tut_sube', 'sav_sube', 'borc_sube', 'fes_sube', 'avans_sube', 'zimmet_sube'];
    branchSelects.forEach(id => {
        const sel = document.getElementById(id);
        if (sel) {
            sel.innerHTML = STATE.branches.map(b => `<option>${b}</option>`).join('');
        }
    });
    
    // Pozisyon selectleri
    const posSelects = ['tut_pozisyon', 'sav_pozisyon', 'fes_pozisyon', 'avans_pozisyon', 'zimmet_pozisyon'];
    posSelects.forEach(id => {
        const sel = document.getElementById(id);
        if (sel) {
            sel.innerHTML = STATE.positions.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        }
    });
    
    // Template select
    const tplSel = document.getElementById('template_pozisyon');
    if (tplSel) {
        tplSel.innerHTML = STATE.positions.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    }
}

// Åžube select populate - kullanÄ±cÄ± yetkisine gÃ¶re filtrele
function populateSubeSelect(selectId) {
    const sel = document.getElementById(selectId);
    if (!sel) return;
    
    const userBranch = currentUser?.branch;
    const isAdmin = currentUser?.role === 'yonetici' || currentUser?.role === 'bolge_muduru';
    
    let branches = STATE.branches || [];
    
    // MaÄŸaza mÃ¼dÃ¼rÃ¼ sadece kendi ÅŸubesini gÃ¶rsÃ¼n
    if (!isAdmin && userBranch) {
        branches = branches.filter(b => b === userBranch);
    }
    
    sel.innerHTML = branches.map(b => `<option value="${b}">${b}</option>`).join('');
    
    // MaÄŸaza mÃ¼dÃ¼rÃ¼ ise kendi ÅŸubesini seÃ§
    if (!isAdmin && userBranch) {
        sel.value = userBranch;
    } else {
        // Admin/BÃ¶lge MÃ¼dÃ¼rÃ¼ iÃ§in default: Tuzla Port
        const tuzlaOption = Array.from(sel.options).find(o => o.value.toLowerCase().includes('tuzla'));
        if (tuzlaOption) {
            sel.value = tuzlaOption.value;
        }
    }
}

function renderPositionCards() {
    const container = document.getElementById('sozlesmePozisyonlar');
    if (!container) return;
    container.innerHTML = STATE.positions.map((p, i) => `
        <div class="type-card${i === 0 ? ' selected' : ''}" data-type="${p.id}" onclick="selectType('sozlesme','${p.id}',this)">
            <div class="type-card-icon">${p.type === 'Mavi Yaka' ? 'â˜•' : p.type === 'Gri Yaka' ? 'ðŸ“‹' : p.type === 'Beyaz Yaka' ? 'ðŸª' : 'ðŸŒ'}</div>
            <div class="type-card-title">${p.name}</div>
            <div class="type-card-sub">${p.type}</div>
        </div>
    `).join('');
}

// BirleÅŸik sekmedeki pozisyon listesi
function renderPositionListCombined() {
    const container = document.getElementById('positionListCombined');
    if (!container) return;
    
    if (STATE.positions.length === 0) {
        container.innerHTML = '<p style="color:var(--tx2);text-align:center;padding:12px;font-size:.85rem">HenÃ¼z pozisyon eklenmemiÅŸ.</p>';
        return;
    }
    
    const roleColors = {
        'barista': '#3498db',
        'mudur_yardimcisi': '#ff8674',
        'magaza_muduru': '#008c95',
        'bolge_muduru': '#9b59b6'
    };
    
    // Kompakt chip formatÄ± - SVG ikonlarla
    container.innerHTML = STATE.positions.map((p, i) => {
        const color = roleColors[p.role] || '#888';
        return `
            <div class="position-chip" style="display:inline-flex;align-items:center;gap:6px;padding:5px 10px;background:${color}15;border:1px solid ${color}40;border-radius:16px;font-size:.8rem">
                ${getPositionIconHtml(p.icon, 16)}
                <span style="font-weight:500;color:var(--tx)">${p.name}</span>
                <button onclick="editPosition(${i})" style="background:none;border:none;cursor:pointer;padding:2px;display:flex;align-items:center;color:var(--tx3)" title="DÃ¼zenle">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                </button>
                <button onclick="confirmDeletePosition(${i})" style="background:none;border:none;cursor:pointer;padding:2px;display:flex;align-items:center;color:var(--tx3)" title="Sil">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                </button>
            </div>
        `;
    }).join('');
    
    // Permission Matrix'i de render et
    renderPermissionMatrix();
}

// Pozisyon silme onay modalÄ±
function confirmDeletePosition(index) {
    const pos = STATE.positions[index];
    if (!pos) return;
    
    const modalHtml = `
        <div id="deletePositionModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:10000">
            <div style="background:var(--bg2);border-radius:12px;padding:20px;max-width:340px;width:90%;box-shadow:var(--shadow)">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px">
                    <div style="width:40px;height:40px;background:rgba(231,76,60,.12);border-radius:10px;display:flex;align-items:center;justify-content:center">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#e74c3c" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                    </div>
                    <div>
                        <div style="font-weight:600;color:var(--tx);font-size:1rem">Pozisyonu Sil</div>
                        <div style="font-size:.8rem;color:var(--tx2)">${pos.name}</div>
                    </div>
                </div>
                <p style="color:var(--tx2);font-size:.85rem;margin-bottom:16px">Bu pozisyonu silmek istediÄŸinize emin misiniz? Bu iÅŸlem geri alÄ±namaz.</p>
                <div style="display:flex;gap:10px;justify-content:flex-end">
                    <button onclick="document.getElementById('deletePositionModal').remove()" class="btn btn-ghost" style="padding:6px 14px;font-size:.85rem">Ä°ptal</button>
                    <button onclick="deletePosition(${index});document.getElementById('deletePositionModal').remove()" class="btn" style="background:var(--red);color:white;padding:6px 14px;font-size:.85rem">Sil</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// Dinamik yetki kartlarÄ± (pozisyonlara gÃ¶re)
function renderDynamicPositionCards() {
    const container = document.getElementById('dynamicPositionCards');
    if (!container) return;
    
    const roleColors = {
        'barista': '#3498db',
        'mudur_yardimcisi': '#ff8674',
        'magaza_muduru': '#008c95',
        'bolge_muduru': '#9b59b6'
    };
    
    const roleLevels = {
        'barista': 'SÄ±nÄ±rlÄ±',
        'mudur_yardimcisi': 'Orta',
        'magaza_muduru': 'GeniÅŸ',
        'bolge_muduru': 'Tam'
    };
    
    container.innerHTML = STATE.positions.map(p => {
        const color = roleColors[p.role] || '#888';
        const level = roleLevels[p.role] || 'Ã–zel';
        
        return `
            <div class="permission-card" onclick="selectRoleForPermissions('${p.id}')" 
                 style="background:var(--bg3);border:2px solid var(--bg4);border-radius:16px;padding:20px;text-align:center;cursor:pointer;transition:all .2s" 
                 onmouseover="this.style.borderColor='${color}';this.style.transform='translateY(-2px)'" 
                 onmouseout="this.style.borderColor='var(--bg4)';this.style.transform='none'">
                <div style="font-size:2rem;margin-bottom:8px">${p.icon || 'ðŸ‘¤'}</div>
                <div style="font-weight:600;color:var(--tx);font-size:.95rem;margin-bottom:4px">${p.name}</div>
                <div style="font-size:.7rem;color:var(--tx2)">${p.type}</div>
                <div style="margin-top:8px;padding:4px 8px;background:${color}22;color:${color};border-radius:6px;font-size:.65rem;font-weight:500">${level}</div>
            </div>
        `;
    }).join('');
}

// Rol bazlÄ± varsayÄ±lan yetkiler
function getDefaultPermissions(role) {
    const defaults = {
        'barista': {
            pages: { dashboard: true, shift: true, checklist: true, documents: false, personel: false, admin: false },
            docs: { sozlesme: false, savunma: false, tutanak: false, ihtar: false, fesih: false },
            forms: { checklist: true, izin: true, avans: true },
            admin: { admin_genel: false, admin_kullanicilar: false, admin_puantaj: false, admin_subeler: false, admin_ihlaller: false, admin_sablonlar: false, admin_oturumlar: false, admin_yedekler: false },
            special: { canViewAllBranches: false, canEditShift: false, canDeletePersonel: false, canExportData: false, view_password: false, change_others_password: false },
            limits: { maxAvans: 3000, maxIzin: 14 }
        },
        'mudur_yardimcisi': {
            pages: { dashboard: true, shift: true, checklist: true, documents: true, personel: false, admin: false },
            docs: { sozlesme: false, savunma: true, tutanak: true, ihtar: false, fesih: false },
            forms: { checklist: true, izin: true, avans: true },
            admin: { admin_genel: false, admin_kullanicilar: false, admin_puantaj: false, admin_subeler: false, admin_ihlaller: true, admin_sablonlar: false, admin_oturumlar: false, admin_yedekler: false },
            special: { canViewAllBranches: false, canEditShift: true, canDeletePersonel: false, canExportData: false, view_password: false, change_others_password: false },
            limits: { maxAvans: 5000, maxIzin: 14 }
        },
        'magaza_muduru': {
            pages: { dashboard: true, shift: true, checklist: true, documents: true, personel: true, admin: false },
            docs: { sozlesme: true, savunma: true, tutanak: true, ihtar: true, fesih: false },
            forms: { checklist: true, izin: true, avans: true },
            admin: { admin_genel: false, admin_kullanicilar: false, admin_puantaj: false, admin_subeler: false, admin_ihlaller: true, admin_sablonlar: false, admin_oturumlar: false, admin_yedekler: false },
            special: { canViewAllBranches: false, canEditShift: true, canDeletePersonel: false, canExportData: true, view_password: false, change_others_password: false },
            limits: { maxAvans: 10000, maxIzin: 21 }
        },
        'bolge_muduru': {
            pages: { dashboard: true, shift: true, checklist: true, documents: true, personel: true, admin: true },
            docs: { sozlesme: true, savunma: true, tutanak: true, ihtar: true, fesih: true },
            forms: { checklist: true, izin: true, avans: true },
            admin: { admin_genel: true, admin_kullanicilar: false, admin_puantaj: true, admin_subeler: true, admin_ihlaller: true, admin_sablonlar: true, admin_oturumlar: true, admin_yedekler: false },
            special: { canViewAllBranches: true, canEditShift: true, canDeletePersonel: true, canExportData: true, view_password: true, change_others_password: true },
            limits: { maxAvans: 50000, maxIzin: 30 }
        },
        'yonetici': {
            pages: { dashboard: true, shift: true, checklist: true, documents: true, personel: true, admin: true },
            docs: { sozlesme: true, savunma: true, tutanak: true, ihtar: true, fesih: true },
            forms: { checklist: true, izin: true, avans: true },
            admin: { admin_genel: true, admin_kullanicilar: true, admin_puantaj: true, admin_subeler: true, admin_ihlaller: true, admin_sablonlar: true, admin_oturumlar: true, admin_yedekler: true },
            special: { canViewAllBranches: true, canEditShift: true, canDeletePersonel: true, canExportData: true, view_password: true, change_others_password: true, manage_branches: true },
            limits: { maxAvans: 999999, maxIzin: 365 }
        }
    };
    
    return defaults[role] || defaults['barista'];
}

// ==================== VARSAYILAN VERÄ°LERÄ° KONTROL ET ====================
function initDefaultData() {
    // VarsayÄ±lan verileri kontrol et ve oluÅŸtur
    initializeDefaultData();
}

async function initializeDefaultData() {
    try {
        // VarsayÄ±lan puantaj kurallarÄ±nÄ± kontrol et
        const rulesRef = db.collection('puantajRules');
        const rulesSnapshot = await rulesRef.get();
        if (rulesSnapshot.empty) {
            for (const rule of DEFAULT_PUANTAJ_RULES) {
                await rulesRef.doc(rule.id).set(rule);
            }
            console.log('VarsayÄ±lan puantaj kurallarÄ± oluÅŸturuldu');
        }
        
        // VarsayÄ±lan geliÅŸmiÅŸ izinleri kontrol et
        const advPermsRef = db.collection('advancedPermissions');
        const advPermsSnapshot = await advPermsRef.get();
        if (advPermsSnapshot.empty) {
            for (const [role, perms] of Object.entries(DEFAULT_ROLE_PERMISSIONS)) {
                await advPermsRef.doc(role).set(perms);
            }
            console.log('VarsayÄ±lan geliÅŸmiÅŸ izinler oluÅŸturuldu');
        }
    } catch (error) {
        console.error('Firebase initialization error:', error);
    }
}

async function handleLogin(event) {
    // Login artÄ±k login.html'de yapÄ±lÄ±yor
    if (event) event.preventDefault();
    window.location.replace('login.html');
}

// Åžifremi unuttum - login.html'e yÃ¶nlendir
function showForgotPassword(event) {
    if (event) event.preventDefault();
    window.location.replace('login.html');
}

async function sendPasswordReset() {
    const email = document.getElementById('resetEmail').value.trim();
    if (!email) {
        toast('E-posta adresi girin', 'error');
        return;
    }
    
    try {
        await firebase.auth().sendPasswordResetEmail(email);
        closeModal();
        toast('Åžifre sÄ±fÄ±rlama baÄŸlantÄ±sÄ± gÃ¶nderildi', 'success');
    } catch (error) {
        console.error('Password reset error:', error);
        let msg = 'Hata oluÅŸtu';
        if (error.code === 'auth/user-not-found') {
            msg = 'Bu e-posta ile kayÄ±tlÄ± kullanÄ±cÄ± bulunamadÄ±';
        }
        toast(msg, 'error');
    }
}

function applyUserPermissions() {
    if (!currentUser) return;
    
    // Sidebar'da kullanÄ±cÄ± bilgilerini gÃ¼ncelle
    const userNameEl = document.getElementById('userName');
    const userRoleEl = document.getElementById('userRole');
    const userAvatarEl = document.getElementById('userAvatar');
    
    if (userNameEl) userNameEl.textContent = currentUser.name || currentUser.email;
    if (userRoleEl) {
        const roleNames = {
            'yonetici': 'YÃ¶netici',
            'bolge_muduru': 'BÃ¶lge MÃ¼dÃ¼rÃ¼',
            'magaza_muduru': 'MaÄŸaza MÃ¼dÃ¼rÃ¼',
            'magaza_mudur_yardimcisi': 'MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±',
            'mudur_yardimcisi': 'MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±',
            'barista': 'Barista'
        };
        userRoleEl.textContent = roleNames[currentUser.role] || currentUser.role;
    }
    
    // Avatar - fotoÄŸraf varsa gÃ¶ster, yoksa baÅŸ harf
    if (userAvatarEl) {
        // Firestore'dan fotoÄŸrafÄ± Ã§ek
        loadUserAvatar();
    }
    
    // GeliÅŸmiÅŸ izin sistemini yÃ¼kle ve uygula (tÃ¼m roller iÃ§in)
    loadUserAdvancedPermissions();
    
    // YÃ¶netici her ÅŸeye eriÅŸebilir - ek kÄ±sÄ±tlama yok
    if (currentUser.role === 'yonetici') return;
    
    // MÃ¼dÃ¼r NotlarÄ± sadece yÃ¶netici gÃ¶rebilir
    const navNotlar = document.getElementById('nav-notlar');
    if (navNotlar) navNotlar.style.display = 'none';
}

// Rol kÄ±sÄ±tlamalarÄ± - ArtÄ±k Firebase yetkilerine gÃ¶re Ã§alÄ±ÅŸÄ±yor
function applyBaristaRestrictions() {
    // Bu fonksiyon artÄ±k sadece yetkilerin yÃ¼klenmesini tetikliyor
    // AsÄ±l kÄ±sÄ±tlama updateSidebarByPermissions tarafÄ±ndan yapÄ±lÄ±yor
    
    // userAdvancedPermissions yÃ¼klendiyse sidebar'Ä± gÃ¼ncelle
    if (window.userAdvancedPermissions) {
        updateSidebarByPermissions(window.userAdvancedPermissions);
    }
    
    // Dashboard kartlarÄ±nÄ± yetkilere gÃ¶re kontrol et
    updateDashboardByPermissions();
    
    console.log('âœ… Yetki kÄ±sÄ±tlamalarÄ± uygulandÄ± (Firebase bazlÄ±)');
}

// Dashboard kartlarÄ±nÄ± yetkilere gÃ¶re gÃ¼ncelle
function updateDashboardByPermissions() {
    const perms = window.userAdvancedPermissions;
    if (!perms) return;
    
    // YÃ¶netici her ÅŸeyi gÃ¶rÃ¼r
    if (currentUser?.role === 'yonetici') return;
    
    // Dashboard kartlarÄ±nÄ± kontrol et
    document.querySelectorAll('.dashboard-card').forEach(card => {
        const onclick = card.getAttribute('onclick') || '';
        
        // goTo('sayfa') formatÄ±nÄ± bul
        const match = onclick.match(/goTo\(['"](\w+)['"]\)/);
        if (!match) return;
        
        const page = match[1];
        const hasAccess = perms.pages?.[page]?.view === true;
        
        if (!hasAccess) {
            card.style.display = 'none';
        }
    });
    
    // Dashboard formlar section
    const formlarSection = document.getElementById('dashboard-formlar-section');
    if (formlarSection) {
        const anyFormVisible = Object.values(perms.forms || {}).some(f => f.view === true);
        formlarSection.style.display = anyFormVisible ? '' : 'none';
    }
    
    // Dashboard belgeler section (varsa)
    document.querySelectorAll('.dashboard-section').forEach(section => {
        const header = section.querySelector('div');
        if (header) {
            const text = header.textContent || '';
            if (text.includes('Belgeler')) {
                const anyDocVisible = Object.values(perms.documents || {}).some(d => d.view === true);
                section.style.display = anyDocVisible ? '' : 'none';
            }
        }
    });
}

// DOM deÄŸiÅŸikliklerinde yetki kÄ±sÄ±tlamalarÄ±nÄ± tekrar uygula
function setupBaristaObserver() {
    // YÃ¶netici iÃ§in gerek yok
    if (currentUser?.role === 'yonetici') return;
    
    const dashboardPage = document.getElementById('page-dashboard');
    if (!dashboardPage) return;
    
    const observer = new MutationObserver(() => {
        // Yetkiler yÃ¼klendiyse uygula
        if (window.userAdvancedPermissions) {
            updateDashboardByPermissions();
        }
    });
    
    observer.observe(dashboardPage, { childList: true, subtree: true });
}

async function loadFirebaseData() {
    // Personel listesini yÃ¼kle
    loadPersonelList();
    
    // Puantaj ÅŸube seÃ§eneklerini doldur - kullanÄ±cÄ± yetkisine gÃ¶re filtrele
    populateSubeSelect('puantajSube');
    
    // Mevcut ayÄ± seÃ§
    const now = new Date();
    const aySelect = document.getElementById('puantajAy');
    if (aySelect) aySelect.value = String(now.getMonth() + 1).padStart(2, '0');
}

// ==================== NAVIGATION ====================
const PAGE_NAMES = {
    'dashboard': 'Ana Sayfa',
    'personel': 'Personel Listesi',
    'puantaj': 'Performans',
    'primSistemi': 'Prim Sistemi',
    'shift': 'Shift PlanÄ±',
    'checklist': 'Checklist',
    'sozlesme': 'Ä°ÅŸ SÃ¶zleÅŸmesi',
    'tutanak': 'Tutanak',
    'savunma': 'Savunma Ä°steme',
    'fesih': 'Fesih',
    'borc': 'BorÃ§ Ä°krar',
    'avans': 'Avans Talebi',
    'zimmet': 'Zimmet Formu',
    'katalog': 'Ä°hlal KataloÄŸu',
    'admin': 'YÃ¶netim'
};

function goTo(page) {
    // page-xxx formatÄ±nda geldiyse dÃ¼zelt
    if (page && page.startsWith('page-')) {
        page = page.replace('page-', '');
    }
    
    // KaydedilmemiÅŸ deÄŸiÅŸiklik kontrolÃ¼ (admin sayfasÄ±ndan Ã§Ä±kÄ±yorsa)
    if (matrixHasUnsavedChanges && currentPage === 'admin' && page !== 'admin') {
        showUnsavedChangesModal(() => goTo(page));
        return;
    }
    
    // Checklist sayfasÄ±ndan Ã§Ä±kÄ±yorsan listener'Ä± temizle
    if (currentPage === 'checklist' && page !== 'checklist') {
        cleanupShiftListener();
    }
    
    // Aktivite logla
    logActivity('page_view', { page: page, from: currentPage });
    
    // Yetki kontrolÃ¼
    if (currentUser && currentUser.role !== 'yonetici') {
        // Permission check from Firebase would go here
    }
    
    previousPage = currentPage;
    currentPage = page;
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    
    const targetPage = document.getElementById('page-' + page);
    if (targetPage) {
        targetPage.classList.add('active');
    } else {
        console.error('Sayfa bulunamadÄ±:', 'page-' + page);
        return;
    }
    
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    const navItem = document.querySelector(`.nav-item[data-page="${page}"]`);
    if (navItem) navItem.classList.add('active');
    
    // Breadcrumb gÃ¼ncelle (tam sayfa adÄ±)
    const pageName = document.getElementById('currentPageName');
    if (pageName) pageName.textContent = PAGE_NAMES[page] || page;
    
    // Dashboard - BugÃ¼nkÃ¼ Checkleri yÃ¼kle
    if (page === 'dashboard') {
        loadTodayChecks();
    }
    
    if (page === 'katalog') renderViolations();
    if (page === 'admin') { 
        renderAdminLists(); 
        loadMyProfile(); // Profilim kartÄ±nÄ± yÃ¼kle
        
        // Barista iÃ§in sadece Genel sekmesi gÃ¶rÃ¼nsÃ¼n
        const isBarista = currentUser?.role === 'barista' || currentUser?.role === 'magaza_mudur_yardimcisi';
        // NOT: 'kullanicilar' ve 'oturumlar' burada YOK - bunlar sadece yÃ¶netici iÃ§in (renderAdminLists'te kontrol ediliyor)
        const adminTabs = ['tumCheckler', 'magazaSaatleri', 'checkKurallari', 'checklistTurleri', 'subeler', 'ihlaller', 'sablonlar', 'belgeler', 'yedekler'];
        
        adminTabs.forEach(tabId => {
            const tab = document.getElementById('tab-' + tabId);
            if (tab) {
                tab.style.display = isBarista ? 'none' : '';
            }
        });
        
        // Barista iÃ§in Genel sekmesini gÃ¶ster ve aktif yap
        if (isBarista) {
            showAdminTab('genel', document.getElementById('tab-genel'));
        }
    }
    if (page === 'personel') loadPersonelList();
    if (page === 'puantaj') { 
        populateSubeSelect('puantajSube'); 
        // Åžimdiki ay ve yÄ±lÄ± seÃ§
        const now = new Date();
        const aySelect = document.getElementById('puantajAy');
        const yilSelect = document.getElementById('puantajYil');
        if (aySelect) aySelect.value = String(now.getMonth() + 1).padStart(2, '0');
        if (yilSelect) yilSelect.value = String(now.getFullYear());
        loadPuantaj(); 
    }
    if (page === 'primSistemi') {
        loadPrimSistemiPage();
    }
    if (page === 'shift') { 
        populateSubeSelect('shiftSube'); 
        loadShiftList();
        // YÃ¶netici iÃ§in Excel yÃ¼kleme butonunu gÃ¶ster
        const adminExcel = document.getElementById('adminExcelUpload');
        if (adminExcel) {
            adminExcel.style.display = currentUser?.role === 'yonetici' ? 'block' : 'none';
        }
    }
    // Yeni sayfalar iÃ§in dropdown'larÄ± doldur
    if (page === 'istifa') { 
        populateSubeSelect('istifa_sube'); 
        populatePozisyonSelect('istifa_pozisyon');
    }
    if (page === 'ibraname') { 
        populateSubeSelect('ibra_sube'); 
        populatePozisyonSelect('ibra_pozisyon');
    }
    // TÃ¼m belgeler ve formlar iÃ§in ÅŸube seÃ§imi (Tuzla Port default)
    if (page === 'sozlesme') populateSubeSelect('soz_sube');
    if (page === 'tutanak') populateSubeSelect('tut_sube');
    if (page === 'savunma') populateSubeSelect('sav_sube');
    if (page === 'fesih') populateSubeSelect('fes_sube');
    if (page === 'borc') populateSubeSelect('borc_sube');
    if (page === 'avans') populateSubeSelect('avans_sube');
    if (page === 'zimmet') populateSubeSelect('zimmet_sube');
    // Checklist sayfasÄ±
    if (page === 'checklist') {
        // Immediate pre-fill (loadSystemConfig beklemeden)
        const subeSelectPre = document.getElementById('checklistSube');
        if (subeSelectPre && subeSelectPre.options.length === 0) {
            const branchesPre = STATE.branches || DEFAULT_STATE.branches || [];
            if (branchesPre.length > 0) {
                subeSelectPre.innerHTML = branchesPre.map(b => `<option value="${b}">${b}</option>`).join('');
                // KullanÄ±cÄ±nÄ±n ÅŸubesini hemen seÃ§ (flash Ã¶nleme)
                const userBrPre = currentUser?.branch;
                if (userBrPre && userBrPre !== 'all') {
                    const optPre = Array.from(subeSelectPre.options).find(o => o.value === userBrPre);
                    if (optPre) subeSelectPre.value = optPre.value;
                }
                console.log('[Checklist] Pre-fill dropdown:', branchesPre.length, 'ÅŸube, seÃ§ili:', subeSelectPre.value);
            }
        }
        
        // Init baÅŸlat
        initChecklistPage().catch(err => {
            console.error('[Checklist Init] Hata:', err);
        });
        
        // 3 saniye gÃ¼vence - dropdown hala boÅŸsa zorla doldur
        // Ama checklist zaten yÃ¼klendiyse atlA
        setTimeout(() => {
            const subeSelect = document.getElementById('checklistSube');
            const typeButtons = document.getElementById('checklistTypeButtons');
            const hasTypes = typeButtons && typeButtons.querySelectorAll('.checklist-type-btn').length > 0;
            
            // Sadece dropdown boÅŸ VE tÃ¼rler yÃ¼klenmemiÅŸse Ã§alÄ±ÅŸ
            if (subeSelect && subeSelect.options.length === 0 && !hasTypes) {
                const branches = STATE.branches || DEFAULT_STATE.branches || [];
                subeSelect.innerHTML = branches.map(b => `<option value="${b}">${b}</option>`).join('');
                // KullanÄ±cÄ±nÄ±n ÅŸubesini seÃ§
                const userBr = currentUser?.branch;
                if (userBr && userBr !== 'all') {
                    const opt = Array.from(subeSelect.options).find(o => o.value === userBr);
                    if (opt) subeSelect.value = opt.value;
                }
                console.warn('[Checklist Init] 3s gÃ¼vence fallback tetiklendi');
                if (typeof loadChecklistTypes === 'function') loadChecklistTypes();
            }
        }, 3000);
    }
    // Dashboard iÃ§in bugÃ¼nkÃ¼ checkler
    if (page === 'dashboard') {
        loadTodayChecks();
    }
}

function goBack() { goTo(previousPage); }

// Checklist sayfasÄ±na parametre ile gitme
let _pendingChecklistParams = null;

function goToChecklist(branch, type, timeSlot) {
    // Canonical type id kullan
    const canonType = canonicalChecklistTypeId(type);
    _pendingChecklistParams = { branch, type: canonType, timeSlot };
    goTo('checklist');
}

// ==================== MODAL SYSTEM ====================
function showModal(title, body, footer) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalBody').innerHTML = body;
    document.getElementById('modalFooter').innerHTML = footer || '';
    document.getElementById('modalOverlay').classList.add('show');
}

function closeModal() {
    document.getElementById('modalOverlay').classList.remove('show');
}

// Global confirm callback
let _confirmCallback = null;

function confirmModal(title, message, onConfirm, type = 'warning') {
    const icons = {
        warning: '<svg width="32" height="32" fill="none" stroke="#f39c12" stroke-width="2" viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
        danger: '<svg width="32" height="32" fill="none" stroke="#e74c3c" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>',
        success: '<svg width="32" height="32" fill="none" stroke="#27ae60" stroke-width="2" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
        info: '<svg width="32" height="32" fill="none" stroke="#3498db" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>'
    };
    _confirmCallback = onConfirm;
    showModal(title, `
        <div class="modal-icon ${type}" style="display:flex;justify-content:center">${icons[type]}</div>
        <div class="modal-message">${message}</div>
    `, `
        <button class="btn btn-ghost" onclick="closeModal()">Ä°ptal</button>
        <button class="btn ${type === 'danger' ? 'btn-danger' : 'btn-primary'}" onclick="executeConfirmCallback()">Onayla</button>
    `);
}

async function executeConfirmCallback() {
    closeModal();
    if (_confirmCallback) {
        try {
            await _confirmCallback();
        } catch (error) {
            console.error('Confirm callback hatasÄ±:', error);
            toast('Ä°ÅŸlem hatasÄ±: ' + error.message, 'error');
        }
        _confirmCallback = null;
    }
}

function successModal(message) {
    showModal('BaÅŸarÄ±lÄ±', `
        <div class="modal-icon success" style="display:flex;justify-content:center">
            <svg width="32" height="32" fill="none" stroke="#27ae60" stroke-width="2" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        </div>
        <div class="modal-message">${message}</div>
    `, `<button class="btn btn-primary" onclick="closeModal()">Tamam</button>`);
}

// ==================== TOAST ====================
function toast(message, type = '') {
    const container = document.getElementById('toastContainer');
    const t = document.createElement('div');
    t.className = 'toast ' + type;
    const icons = {
        success: '<svg width="16" height="16" fill="none" stroke="#27ae60" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>',
        error: '<svg width="16" height="16" fill="none" stroke="#e74c3c" stroke-width="2.5" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
        warning: '<svg width="16" height="16" fill="none" stroke="#f39c12" stroke-width="2.5" viewBox="0 0 24 24"><path d="M12 9v4M12 17h.01"/><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/></svg>',
        info: '<svg width="16" height="16" fill="none" stroke="#3498db" stroke-width="2.5" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>',
        '': '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>'
    };
    t.innerHTML = `<span class="toast-icon" style="display:flex;align-items:center">${icons[type] || icons['']}</span>${message}`;
    container.appendChild(t);
    setTimeout(() => t.classList.add('show'), 10);
    setTimeout(() => {
        t.classList.remove('show');
        setTimeout(() => t.remove(), 300);
    }, 3000);
}

// Alias for showToast
const showToast = toast;

// ==================== TYPE SELECTION ====================
function selectType(form, type, el) {
    selectedTypes[form] = type;
    el.parentElement.querySelectorAll('.type-card').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    
    if (form === 'tutanak') {
        document.getElementById('tut_kasa_field').style.display = type === 'kasa' ? 'block' : 'none';
    }
}

function selectFesihType(type, el) {
    selectedTypes.fesih = type;
    el.parentElement.querySelectorAll('.type-card').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    
    document.getElementById('fes_ogrenme_field').style.display = type === 'hakli' ? 'block' : 'none';
    document.getElementById('fesih_6gun_alert').style.display = 'none';
    
    // Dayanak gÃ¼ncelle
    const sel = document.getElementById('fes_dayanak');
    const opts = STATE.fesihDayanaklari[type] || [];
    sel.innerHTML = '<option value="">SeÃ§iniz</option>' + opts.map(d => `<option value="${d.v}">${d.t}</option>`).join('');
}

function check6Gun() {
    if (selectedTypes.fesih !== 'hakli') return;
    const og = document.getElementById('fes_ogrenme').value;
    if (!og) return;
    const ogDate = new Date(og);
    const now = new Date();
    let gun = 0, tmp = new Date(ogDate);
    while (tmp <= now) {
        const d = tmp.getDay();
        if (d !== 0 && d !== 6) gun++;
        tmp.setDate(tmp.getDate() + 1);
    }
    document.getElementById('fesih_6gun_alert').style.display = gun > 6 ? 'flex' : 'none';
}

// ==================== FORM HELPERS ====================
function clearForm(prefix) {
    document.querySelectorAll(`[id^="${prefix}_"]`).forEach(el => {
        if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') el.value = '';
        if (el.tagName === 'SELECT') el.selectedIndex = 0;
    });
}

function getVal(id) {
    const el = document.getElementById(id);
    return el ? el.value.trim() : '';
}

function formatDate(d) {
    if (!d) return '___/___/______';
    return new Date(d).toLocaleDateString('tr-TR');
}

function today() {
    return new Date().toLocaleDateString('tr-TR');
}

function nowTime() {
    return new Date().toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'});
}

function nowDateTime() {
    const now = new Date();
    return now.toLocaleDateString('tr-TR') + ' ' + now.toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'});
}

// Benzersiz Belge NumaralandÄ±rma: YIL-ÅžUBEKODU-GGAASS
function docNo(prefix, sube) {
    const now = new Date();
    const yil = now.getFullYear().toString().slice(-2);
    const gun = now.getDate().toString().padStart(2, '0');
    const ay = (now.getMonth() + 1).toString().padStart(2, '0');
    const saat = now.getHours().toString().padStart(2, '0');
    const dakika = now.getMinutes().toString().padStart(2, '0');
    
    // Åžube kodunu bul
    let subeKod = 'MRK';
    if (sube && STATE.branchCodes) {
        subeKod = STATE.branchCodes[sube] || 'MRK';
    } else if (sube) {
        // Fallback: Ä°lk 3 harf
        subeKod = sube.replace(/[^A-Za-zÃ‡ÄžÄ°Ã–ÅžÃœÃ§ÄŸÄ±Ã¶ÅŸÃ¼]/g, '').substring(0, 3).toUpperCase();
        if (subeKod === 'ÅžÄ°Åž' || subeKod === 'SIS') subeKod = 'SIS';
        if (subeKod === 'TUZ') subeKod = 'TZL';
    }
    
    return `${yil}-${subeKod}-${gun}${ay}${saat}${dakika}`;
}

// ==================== DOCUMENT GENERATION ====================
function showPreview(title, html) {
    document.getElementById('previewTitle').textContent = title;
    document.getElementById('previewContent').innerHTML = html;
    goTo('preview');
}

function printDoc() { window.print(); }

function downloadPDF() {
    const content = document.getElementById('previewContent');
    const title = document.getElementById('previewTitle').textContent;
    
    // PDF iÃ§in wrapper oluÅŸtur
    const wrapper = document.createElement('div');
    wrapper.style.fontFamily = "'Times New Roman', Times, serif";
    wrapper.style.fontSize = '11pt';
    wrapper.style.lineHeight = '1.6';
    wrapper.style.color = '#000';
    wrapper.style.backgroundColor = '#fff';
    
    // Ä°Ã§eriÄŸi kopyala
    const clone = content.cloneNode(true);
    clone.style.padding = '0';
    
    // TÃ¼m doc-article elementlerine page-break-inside: avoid ekle
    clone.querySelectorAll('.doc-article').forEach(el => {
        el.style.pageBreakInside = 'avoid';
        el.style.breakInside = 'avoid';
        el.style.marginBottom = '15px';
    });
    
    // TÃ¼m doc-article-title elementlerine page-break-after: avoid ekle
    clone.querySelectorAll('.doc-article-title').forEach(el => {
        el.style.pageBreakAfter = 'avoid';
        el.style.breakAfter = 'avoid';
    });
    
    wrapper.appendChild(clone);
    
    html2pdf().set({
        margin: [15, 15, 20, 15], // Ã¼st, saÄŸ, alt, sol
        filename: title.replace(/[^a-zA-Z0-9ÄŸÃ¼ÅŸÄ±Ã¶Ã§ÄžÃœÅžÄ°Ã–Ã‡\s-]/g, '') + '.pdf',
        image: {type: 'jpeg', quality: 0.98},
        html2canvas: {scale: 2, useCORS: true, letterRendering: true, backgroundColor: null},
        jsPDF: {unit: 'mm', format: 'a4', orientation: 'portrait'},
        pagebreak: {mode: ['avoid-all', 'css', 'legacy'], avoid: ['.doc-article', '.doc-article-title', '.no-break']}
    }).from(wrapper).toPdf().get('pdf').then(function(pdf) {
        const totalPages = pdf.internal.getNumberOfPages();
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        
        for (let i = 1; i <= totalPages; i++) {
            pdf.setPage(i);
            
            // Alt Ã§izgi
            pdf.setDrawColor(200);
            pdf.line(15, pageHeight - 15, pageWidth - 15, pageHeight - 15);
            
            // Sayfa numarasÄ± (orta alt)
            pdf.setFontSize(8);
            pdf.setTextColor(100);
            pdf.text('Sayfa ' + i + ' / ' + totalPages, pageWidth / 2, pageHeight - 8, {align: 'center'});
        }
    }).save();
}

// Logo Base64 (Yeni Moonberry Coffee Logo)
const LOGO_BASE64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAACwCAQAAADgIOm5AAAAAmJLR0QA/4ePzL8AAAAHdElNRQfpDB0CKim0QQKDAAAeIUlEQVR42u2deXwUVbbHv9XZ9xBCAlnAJEDYRSOjLCMqqCMoIDx1VNxQGZc3H2FwHYUZGRa38SkjIugAIijM4AIyuLKJIvuOJOxhCwlJyL531/sjlU5Xd1V1d3V3quPkdz8fPqTrVtW599S999xzzj1HwB8hEEEiXUgng84kE08sEYQRAoBIJTWUUkwepznBMU5ynlLMRpPtnab7EwSiSedyrqQPXWhPBIFO77FQwyXOcpjd7OEIRa2bMf7CEBMJZHEDg+hOO91UVXCKHWzkZ3KpM7pJ+uAPDIniKkYxnG7SlOQpzOSxjbVs4HTrHi0tD4EUJrKOckSvFzMnmM+NRBndyNYCE12ZyiEafMCM5lLBOh4i0S9mAj+GQDp/4RgWnzKjqdSzi6foZHSj/RcdmEx2CzGjeQLbzaPEGd10/0MIo9js42lKfaSs51YvCQ6/EmQwjzJDmNFUylhAptHd4B8IYhz7DWVGU8nmfsKM7g6j0YFXDR4btqWKBXQxukuMRF/WYjacDfKylev8URj2PUkCN/N3eum8u4oi8rlAPoWUUQaASAixxJJARzrSgRgCdD37PNP4yN9ULL5mSCD3MZtEN+8SKeEYe9nNYc5QTBX1iA6Umwglmo5kcDlX0Jtkgtx8TyVv8jrlPu4DP0IwUyh1ayKxkMcX/JGriMXkxptCSON25rCfGrfeV8984o3uppZCOC9T6UbnVLKJyfTxYKdgIpHRLOKsW5/Acjoa3VUtgTBmUOtytxTzMSOI9sqbA+nFVA65IUascHtSbXUIZprL7LjEYgZ7eQctkMJkDrmsoFn+62ZJAJOocKkjaljF9T5SZwhcxnTOuciSD4k1utt8h/FccqkTDvIAkT6lxEQWK1xa6M28+Wvdvw93aVGtZAEZLUJPBI9y3KXR+rTOHY1foyd7XWj8CR4gtMVoEujPGhcW+WLGGd193kZ7VrnAjvVkGUDZqy4I4Ue4wugu9CYCmen0O6xnEUmGUBfMRPKdsuSrX9NGcZzTfXk1s72029ADE6M56YRCCzN+LStJN6f2jkqeb8GVQxnDOep0JRlpdFd6A6F84JQdzxFsd5fJbYWg5xjqlCVbSTa6Oz3HXU6WzGpecGBHKHfS1wBab+SUE5bMcku16YdIZZdmAxt41WGySmAuq4gxhN6xXNSkt4Brje5STyAw3ckXt8Sh43uwlhruNYziJ6jSpHhVa/Z5zHKyN99Eqt0dV7Edkc0GekqF8Kam6rGG+4ztVP0I4n1NduQy0O6OQRxCpIGJhtKdwDeadG9rrXaSaynSXMwftat/hSQe7zNog9iM35CrQbmZSQbTpwvBLHGyeoTL6ndli3TlJaNJB/6XOg3aDzhMta0A12jKKzl2/ibt+Vy6cpY+RpMORGvq3iw8ZTSB7sLEOxoNqucJWe0gXrEupEtcOK7WEhiiqd/aQYLRBLqHTM0t1re0k9W+0+q9WOs3im4Tb2h+UuONJtA9/EmjMRXcJqvbjQM2s7M3zmt4R/GSyTGNVqyxWwP9GjH8oNGUf8tMosG8Z3Ntrldc9Dpxu1ee85JGKy4x2KDe1YEbNE4HlnOzrO4IG9V8nZcmrNF85xXXhK6aY+TVlu9YvXhVc6hH2NSMkW3CTpLmhbeH8jG13O7zluxtLS5C7dmh2og6fi+rO17mpbXaC44/QTxJJSI76O2FtlxFgWpbqluLfWSoxoS1WyYuxrJBdnWaR+8ViGIg71oltoM8RoaHLA7mXxpjZI7RXe0aXtRownRZzbEyz6g6RrvwdIFglQU7mLvZJrPdV/I5gz1c3u+hXrU1e+hgdGc7RyhrNCSTQTY1Q/i37Gq+S3v0MMaofPUCwaTxF6sGbSt30dHjbWZnjmgIKNcZ3d3OkabhLrBJZku40m5+3u/S95bBd3TVuG7iAUoR+cErAgKYWKgx4l9oqW7Vb6jM1NjabZQdgrnFjgHnpZNQ2hjOdQzXuG5hGUupZCYnvdITFtZhUb06yP+PUz+r+jVVcaNNvSg22l1f6MLTL2M3ItudOBsMZoUX7Xo9NByzT/j7IVGThtI9R9aNAxysJbOdPr0Dy6S68zU3frGytcpTRLBeQ/S9qaU6Vh8iNeb3gxTY/HW1g5m2UPPJQQziQ+6W/nqYRRpnR0rZ6sW+qGSP6rVQ+nnxTRrQK5vEaVj79lFv/X+Ag/kWqlXvbM9NjGEY7W3uH8P1bGYFayl2qC8i4k3sRVQVnkdwTvF3kWqqESnjLAU2LdcJvQxJsFOsN8PMLzZ/tVPYR9eqPrWBOiwOQcdKyKWwRUKRHaFc1dH1elXR14wZqCWfHazke2NO9Y5W3UZd4iqbev0pdKjxgOaTg7iST6xPr+NDerSY01qqS+dItEo1nxvjP/8HVZKOy+zQYxQY97jTp0cxFxERM//n4xNW9u/d4iFDRESO2Om53YLeb0/dsFko22WkKUyKzo1K5cxiJ7CRWVR4p69dQjV5XnhKN/7BlXpv1ssQ9b12oWzRTlGo0R7nOMdH1DCPi17oINfRIJMP9aMbL+i1M+pjiKCxOyimwebpSpYE16wL37GOn7zSPe6gyEvPuZmr9d2ojyEmjfOqFTYKiEBFxiU7eMEr4RRzvdY9rsNbE2QUw/TdqI8hARoD0rZJgYqKjVSX1B01fKch1Yeqit2ewRUtm2voo88BQy9D1M9BVTq9u5NLHiciDRrbvl6M1UW5M3gvWFO8PnWkEcdS4rwQ9XAME33iwua9cFUB+p7lfYY4P0MYyAAP3zGEhxjAYz7wffRefxRpaCS8TkCDxuJnq3oQbSQuWwz0QGkeyE3MIwWBZ3jW6/FJvHeeK1vf9KePIRYN7ofbDNV6ShXr9NE5aQUyhPdZIZmAI3mZNUz0qr3bW16K1azXd6M+hpg1pJE4m4mkQUFD21jnBl3vFSnmmM1msYZ8Cr0aNdFbJ7o2t/Qe6nVVTc5Psunob6pWd/2TQ0/J6e4sd3nZsBrAci/oskTydH5wHuAZDdWaraXkUZValfzOg7f34BefHIgLdzA36ykXuE+/tKZXqshT3SPEyeb0U9SoNP0eDzzXs1nEdj7Vfb8aYjx2Gq1nE/eyTL/hTK/geJ4aFfVJNJ3ZZ/0rlyIVR4VbuIqfdTd8Lfk+UKwkau5tLBrXGqimgD2s4hvP6NLLkDzKVBgSRE++tKl3SoUh8TzCTt0mzyNecv6RI10jMM4G3tW4s4IiznvDhKsX8exTnUOXyqLpzFGtV8T1RpGvgr9qrAzPtQwJeteQUk6oXusrEx63qFrD45jkV9ESgjWMrzUaHilehV6G1HNI9dpldLf5a6eKtwbA77irZZrpEjppHGzI40jLEKFfd7NP9cuP5hqbv3I1fKeCmeJH6VX6Kto3G/GLV4y7LkA/Qw5pmFevs1Ex1vMfDReeHvqNnV7HdRrbzG36VIUtiUg2aexUbaNgpfKLpuOMsRFPmhCvEWCqUtPt26vQP0IqNKaijrIGnGG1xnNCedGrHrp6kUUP1WsnOWg0ea5gpEbE6A0yif4KzmsqGzYb7lsu8K4GfR+0jvhySRpTUYXMWzxAcnxTL8sMjryeoeGzWM+dhtLmMkzM1+jixTJd1ZVOxoiZNw1d3Cdr0HaEzkZ3tasYozFp5fMbm5omXnEyRmqZatgppUSNA94i77eOCauxIVpx3ufJVChpTqP6VvFng1jysEbu0Wq7iC1+jpkaHZwv2yDCeCdhJ0WqmCGL/9Ay6Mg2DZq2ueT66jcYoBm+bKnMByWMfzphiEgd77b4mfBJmvHqW+z8rXcQohkBocIuEkk6O52yxMJqjR2B95FJjgY1p3VnYDQMozQnoi12R99uJM8pS0T2c1sLxZsLciKQz209C3oTYvhes0mzZUu7wESXslMVM7tFgrTerpmht1DhhGQrwO81czzZ5xpwNX+bhZ+4zcdSV5qTAOlLXPLT9zs4GyO77Y5Qh/Omiynuy1nCb3yWPyFcM5iGSCFDjO5avRjrJDPCJ3ZeWFG8pRkv17YUsIAhHuZPExTcckxMcjJS3/OTuKk6EMFKzaY1MNNu8EfwstNdSXO5xGoe5DIdHRRAAjcwQUGUHuUkP8JpLje6Wz3BYCfZnSp50k5eCeFJJ11iz9QTLGMiWcQ5TUlkIpI0hjGZpRzmKPc4yErXaARjaixTjcm27q2XmpjJ85o1inmKj2W+TSZG8IqbAfpESjhFDkc4yXmKqaCWWkAgjBCiiCORzqSRQWc6EAbs5RnWIXdc68dCJ3nitjKO817qG4OQwnYn39xFhS+1ByvcSGEsl8JqKOECuRzlKMc4RwFl1MpSUFTwHpc5UJrJj06eXcYYo7vTGxjtNEdbAeMdWBLFE5zQxRLtYmYrYxXE5n785PTeOQZkxvIBgjR84ptKIY87yPYCvXmfEq+y4xjPKW4sr3FBebO19dg/nKEj65w2t4LpCg6bwQzjc40op+6UXGbTXVHQHeU0P5tIviz8WqvH1U4TN4rUs1QxTmI4N/KRC7k4taapbP6mEqwmnEkuSHW1TGl92ittjNfUDjWVHdykKLwG05+X+FnHWLnEdzxGZ5XuTGOhS0m8Fxhgj/ExApmmEQG3uVzkryqWD4FYrmUqX3PahU6s5iT/4QWuUY0bFMzt7HaJqV97JWeDR/DF5ieSN5jowpMt/MgrrFM9IxhKEpn0pDtdSCCWMIIJAuqpo4oS8sklh8McIU/Vr1CgO5O41yWn7p3cz2Ef9IcfIN4udLJ6KeV9+jvZeQuE0I4UutOPAQygL91IJpYQp0xPZLILy3hjOaw3XEzrQBKrXZ79z/IGfbyeoTmBR9jholZZJKd1Z/Z0BZfxtRtL8lnmMthDnW4TAsjgT+x0aSX7r2EHQCpfuCknreFhMjxQegvEcwvzOKGZw9O+HPzvYAdAEss0PTocSwOnWMYE+hDllsARQhdu4+/sckOp31h+1h+OzxfwtYo5jmk85rYh1kIhR9jDHo5wjktUKYRqEjARSgyJpNOPK+ntYmA0W4h8yRSO+bgP3ILvdf5hPM6LOkNWiFRSRD4XyKeYEqtwG0AssSSQSEc6EK1TIKhmATNbOKqjXyCA0ZpHdowpZ/mDC6GkfrXozWduSD2+LmY2MMgYi6D/IIZnXHKS830pYmZrS6jqG5gYyH9c9jbxTWlgA8NbrzeJ9xHLE2Qbxo4TTCHe6C7wNwh05Q0DJq+LvEPP//Z1Qw0BZPGeR6Yo98olljLo12En9x0CGcAcTrul5NBTCljMUP9P6eUfCKAHL7DDJVuengU8m9fIahsZ7kEgntF8wDEv7lMs5LOKCaS2Pvu4vyxyAaRwNcO5hjSPUrg0cIE9rGcDOSrBBf0c/sKQRpiIpwdZDKAXycS6sV+ooZDj7GYrezjt/4Fi1OFfDGlCALEkk05X0kklkTgiCSXIZjWop54ayijiAqc4ylFOcIEqvJu1zQD4J0Ns6QsijEiiiCKUKGlNsFBONeWUU0EV5tbPhja0oQ1taEMb2tCGNvgWAm8DJs7wntMMZWncQTAmcljZIqmC9bTmToYoxGi3UEkNxRxkPyVGE+kMjdqfep51oveJsiadX+236joTH2vquCr4wes5R7yOZgPOLRq1BJ62Gl/9mSHLnCoeK5npN5GCFdCsLYpnFsc4qlJvOM/4LRsccZzv7SbVMOLpRjrBhPM0+cwxmkR12H49n6ika0iTHXn2/xGy2EElJBBEJx4hFxGRHNKNJlUdjfaDSmkleUFhJYmQgrSYJb/Z1siQJvyeSkQsPGI0qWponLLqmMOdpBPIFA6wRlZDYAL3ArCJs9yn+iSBdnQjjQ4EUMZJssnXzEkTQhe6k0Q4dZwnh5MK9osAUggDCikEouhLH9pRzUkOckYlR6I2vmIfAxHI4gPF3kghk85EUE8+xzlGuQJNnQkBCigGBOLoTVeq+YxaIIwUAjBzhhrARDJ9SOMo35NGBwTKyFGUUAUyiEeksnGE1HEL90oHLffZ5SsYyjlERE4ygOmqI6QTT7OdEquveyWHmGkXlsmWGSNYyTmrmFBPHp9yq4NrZxRfcZGL/Am4ka+tgQnqOMG79HMYB85HiMBiRES+cGiDiSzmc8JqTm6giI084pAEOY4NFFDARCCSR9hGBSI7pUDQ/TlKAdn0BpKZTg61iCxE4C0qKeeQSp/EsYFKytnYxJARCMySuvNfNsGUUqUwFOXcB8xQYchv2aLorHCYOxQcoeN5W/GUbTlz7Q77x0hr1wyepNCh/gnutJtgnTPExFJERFbY0RXC45xVoKmeNXbRWOI5gIjIU8TyvjUsSBNDBlCKSDH96GmT8W0hMIZqRESeVKTrNqoRqWdKs5Ql8jrdGQeMZT+zMQOh/JnBgIV3WI4abuAD6dx5Ifs4hYUULicJ6MF8olkos1fE8Rb3IAC1HOUIZUTQnUxCieQJknmMCw5vuJt4oqklm2xqSKA/nYA05lDCt7iDBClvw1HZxBHEZKYSDojk8Qt5BJJBbyIIZCSJPKiQviac6dJKVEEhR2QTqIVUpjCUxmA5xeQCP7CHgcBYljhMhIGMIxTI4bPmEQLQXQp5V8QoAB6VuPqFdJxAaYR0ZQ8iItX8kyzCEBAIoRevcQkRkQuyJIsBzJTG0g7uIoFABAKI5w5r7Ny3bJ4eYyPdHWA8HTAhEEIfPpC+zU2yqLpNI2SRyggJ5WUaECm1y341XhqxebxML8IQMBHLLXwjzRlrbd7SNEJ2U4FIEe8wlBSipTc2jpBytmBG5Dh/JouO0tn3KYiIlHGdA129OCPNBMgZAsOkGO0HyORqTiMisp+e0lVHhgRISb9qeNFuBQjgXmma+dpGmL5W+m0dGXZEpfMtIiIlNqkumhmyW5aRBCKYJ1F+hwJDlhJJOKEEE0wwIUQQTSdu5mPpA1soozWdQ4iIHGW4HSPbMw8zImYmOTBEROQ0t9tNfQNsAvD8RH/ZtUxOISLytsPn8iwiIvmNZ7nkDBF4TBJuv2KztINvDmLpyJB+EgMXKRzYNDENCyJV1icEskhqiFK0qv4SwR9Zn9/EkHJpxNqim5TP4H2b5jUxpIDNrOdb1rKWtXzND2zlsCTaN/C5XXCZ56Uvd5wCTXGsQURkj3V1a2ZIqUIGrWaGZDtEpDPxHiIiR+xCRsWxBRGRjxtPgMkZAiH8n80CLY/94ciQSRJvr0IJnaWDOu9If2dIXf6GypTSGLA/1yqJNDFko8LBf5MkL22xueaK6iSXobLnRPMDIiKfqxzf+R2ViNRaP4lmhsxXkDabGFKvuNMZRjkiZh6W/XorVYhUNcaYd9wG1jKLr6x/LeU9jd1EgJQBYRsHFK+f5nsAsqRJqzdJQAVrUHZL+IZKoJOUnrsZBxX2AxZ+kTrI0Y9LpI5aWamztqIzC3nURsGYLOWU245AlEOJ5BjngGCHT+4SizXSSO5jlcKv2/gZMDHWRpsWyP8QBuzix8Y/HXGR5+hCb+BH/kol6giXMuMcUPWE2o6IQDLxlAFpBAHnVVPQHeMCGQQ5yOqFirUbU5wGKbRhI6/Zbb9MxJDEFVxPKum8TRxvSDU6SR/Lw9ymOG4DpUyl6Zhkn+Y+lY+wERsUzy5W8G+GYWIQ/dki/dadYYDIv7ikxhA4yPMsppJnOYMWAiVO56vWaMyZGy7JGRFS7VKV2kWcJgMcznAoj1HR5l85cvlG8fcAejGbkYTxLLuk0Rsq9UGGg5ghRyQBMjoOUKFaV2SvypVvOEIPYhltZchIUoDjTfoRNRvIWqbxosvJg9U9DAW3PL/MXkpWr/ZOMwd4ioNAHA9IVFvQ59V1VuNarWrWw9NSnuCR0riLk9IVrOZUYwW1rrSwwAVCG6gC0IjSnkwIUC3VKwEggWiViTBaCo9UiO9wnJX0AbKI5wJQQi3BiPyTHRrHq02csJsEtT4drQ/rUybQnkyuYxkwiP5AMSubelv923ZFdVdFLoOAfoRRrXBd4GoE4JzUxSepJYRkeqh8Qd3oAtT7OM1pNhZMxEjCwAWKiEIghwVuPUVr5Fs0em8fP3A7gYxjJQ2MIwzY2Jxp1zN3fTPbAchykIsa0YVhAOyQVo3DnAciGaXSnFHEAOc18ux6AxGYaBT3AS5IOQpvsQuH3oRoutCFFDejRKjPLjWsoB74Lb3oynCgjuXNmm5Pz0+sJw+I53EFKd7EA2QCVayVfjnDRgDulCUMa0IW9wCwiVwPqdJCsKTKKZQ+khpWYwGGMF7hM4ngFTazmWVu5f0RNaf7DewH4rmNW0kB9rLBttM8wy98BsDdPGn3DZm4iz8CsL5RwgbMLKYYSOJVutk9KZ1XSQVK+FCXpUPeIWoI4SFpi7eVYum3L9kJBDOVO+1WkTAmMYFUUtnlVnJibVGmQOqz+3kUgJW2a6anJ7YbeJshXE4o00lnPkepQSCUy7ibx2kP5PG6zbZuCwt4DoGhfMzf2UAxDQTSjqE8LY2ahWz2kCZoTz8siJKYKmAiAAinOyO5hQjgPIusQuwFZrGIdiQyjytZxnGqEQmlJ09yDyHAPuZqGtuUWKKFVTxBsiRm58oT03p+hP4ok3mfDMJ5grEc4jyBJNGdjghAEc/LOriB10niPgSuYjHHOUYJMWTQVZryPuMVjf2vq7iZwYgyhggIBBEuzQil/EVa/RqxhqnMIpp2PMODZHMWM8n0keI95DKF4x7TZIscvuUh6f9r7R1L7HVZWlAzUA1kk2IwvcP8j4IoGcfrinGsy3mHRFnNJl3WNEVqJkhmqlTrL67osszs4w6HDzGQ8Sr5EnbZqeqbdFmTFWlqUr87S5X0O0nVWWKnWSOQfKDexUNgFRQiKPj+/cwd3MHv6UO0JMFUcpzVLFGMRVXMi3zFBK4lUVp36ilgCx/yvR0dFoooBJVdSwUXCKBAtuKUU6Vgsxapp4EGijjCetYo6B8aWMYOHmAkGYRLE04Vx/icRXYihoUiLqrS1EABNVQ4HeX7OEt34Ed2yC8IZAIi5zUUAc2IJx4o57zCsikQTTe6koBAMSfJoUhz3g0mlUxSCaeas+SQq7CZkjs52COKJKCWs1aWCCSThOMMbqGWOuopoUyzq0zEk8llxCFQygkOU+jQhgBSJSeHSwpPCCUVExbOKu7LmjGQNcTRwAQ+cqHf2+BjmCSz3t4WyUTXBqfoKTnsTTWakDY0YioiIudU9BttaGEkSXmzFyptOn4NobzacQVBbKIGSKQ/1fzkp+dXGjGCXkAFyz3WSLQATHTnMeawgJcZ5VKwsT58Rz37SAQGs5UGvvJShGzfIIYNiIh871KCAIMRyv+Si4Vy8rhEDVsZ4UTbFsRH1PIe1xFEBN9QzjSy/DrkTH9+YDe7JX9pv4aJKVSzmz9wJWn05UmOkW+XSdceCWSzUTINdyOfVX6fvTaYdsQSq3aCwJ/WkIE8z3Ye5KT09wF2sYzp7JEyCkaQRT8COcx2aVOWziA6UMowLFhIJxIzg7nIYcxAJH3pisAp2clCgRSuIJVS9pBjwCxe5yUztc9hYj5V3Gz36628JTk7Z/JvKqiiimrWcQ0Ab1KDiJlaaqihDpFaylhNGNCXLyijnHIqrfUhiIfIoZpyqslnhuQi3QYFdOAQ2xWsdo22hSQ2colZXMsQXuIih+gF9OJB8tnNeO7mLp6lilXcxAAEUthCKbP5LYN5kQsckmT+ByhnN/fzG0aykjpe89vDR4Yjk0KWqNoRnqOOP1qv3k8NbwLQieN8KXVqP0r5h1TjBcw8ba1/FzXMBTqxn2PW7VgMn3LJOnb8BP4jj5gQVONdRTCCo/zLevULdnG9w1GaZoRzI4XspSs96EEmp8jletrTl55so56e9KQnCfxErL3622j4z6JeSgmJBClqY6NIJttqcoUysrmJSEV9K0AY7enAcomBAgIxFBBNEoGMsVmngsDf1Hv+w5AiDjOADLJlv6bQnYM00EAoAVZmmQijQUO5b8ZMCUuolCYtEQvlFFOJyE42WecFC1g9CNvggImYmSOLsxDNCs7TnwC+IM/maFkq2awjHLU1JIBPuGTjHh1KDzoD/Slmuc1OJYHeKgfB2wB04HtqmEUqAUAA6bxLLa8RCNxLLR9KNu52zKFeOquntqiPoYpPJeNuJNMo5E9AKJ9QwSMS0/uxmf12R1zbIEMf1lHPUZYzjxWcoJK3pZ1CBHOpZQdv8Co/UccyaUlXY0gIM6jiIG8zg2+p5RuSpDfsoIIvmcEcjlPGY34fddJgJPEiv2BGpIHtjLc5RxHLS9IRuzPMsjpDdGAd86WVMJPdNiafCJ7gMBZECviHzZmlXiyVjs3s4V7/U7T8P68zDur5qie+AAAAHnRFWHRpY2M6Y29weXJpZ2h0AEdvb2dsZSBJbmMuIDIwMTasCzM4AAAAFHRFWHRpY2M6ZGVzY3JpcHRpb24Ac1JHQrqQcwcAAAAASUVORK5CYII=';

function docHeader(title) {
    return `<div class="doc-header" style="display:flex;align-items:center;justify-content:space-between;border-bottom:2px solid #000;padding-bottom:15px;margin-bottom:20px">
        <img src="${LOGO_BASE64}" alt="Moonberry Coffee" style="height:60px;width:auto">
        <div style="text-align:right;flex:1;margin-left:20px">
            <div class="doc-company" style="font-size:11pt;font-weight:700">${STATE.company.name}</div>
        </div>
    </div>
    <div class="doc-title" style="text-align:center;font-size:14pt;font-weight:700;margin:15px 0;text-decoration:underline">${title}</div>`;
}

function docSignature(left, right) {
    return `<div class="doc-signature-area">
        <div class="doc-signature-block"><div class="doc-signature-title">${left.title}</div><div class="doc-signature-line">${left.name}<br>${left.role || ''}</div></div>
        <div class="doc-signature-block"><div class="doc-signature-title">${right.title}</div><div class="doc-signature-line">${right.name}<br>${right.role || ''}</div></div>
    </div>`;
}

// ==================== SÃ–ZLEÅžME ====================
function generateSozlesme() {
    const type = selectedTypes.sozlesme;
    const pos = STATE.positions.find(p => p.id === type);
    const posName = pos ? pos.name : (type || 'Pozisyon');
    
    const ad = getVal('soz_ad') || '______________________';
    const tc = getVal('soz_tc') || '___________';
    const adres = getVal('soz_adres') || '______________________';
    const iban = getVal('soz_iban') || '______________________';
    const telefon = getVal('soz_telefon') || '______________________';
    const baslama = formatDate(getVal('soz_baslama'));
    const ucret = getVal('soz_ucret') || '______';
    const sube = getVal('soz_sube') || STATE.branches[0] || '______';
    
    // Pozisyona gÃ¶re el yazÄ±sÄ± beyan metinleri
    const beyanlar = {
        barista: '"Ä°ÅŸbu iÅŸ sÃ¶zleÅŸmesini, eklerini ve KVKK AydÄ±nlatma Metnini elden teslim aldÄ±m, okudum, iÃ§eriÄŸini ve yÃ¼kÃ¼mlÃ¼lÃ¼klerimi tam olarak anladÄ±m ve hÃ¼r irademle kabul ettim."',
        mudur_yardimcisi: '"Ä°ÅŸbu iÅŸ sÃ¶zleÅŸmesini, eklerini ve KVKK AydÄ±nlatma Metnini elden teslim aldÄ±m, okudum. Ä°ÅŸverenin iÅŸleyiÅŸini, gÃ¶rev tanÄ±mÄ±mÄ±, Ã¼cret ve fazla mesai uygulamalarÄ±nÄ±, gizlilik ve rekabet yasaÄŸÄ± hÃ¼kÃ¼mlerini tam olarak anladÄ±m ve hÃ¼r irademle kabul ettim."',
        magaza_muduru: '"SÃ¶zleÅŸmeyi okudum, bir suretini teslim aldÄ±m. Ä°ÅŸveren Vekili statÃ¼sÃ¼nÃ¼, fazla mesai dÃ¼zenlemesini ve rekabet yasaÄŸÄ± hÃ¼kÃ¼mlerini anladÄ±m, hÃ¼r irademle kabul ediyorum."',
        bolge_muduru: '"Ä°ÅŸbu sÃ¶zleÅŸmeyi okudum, iÃ§eriÄŸini, Ä°ÅŸveren Vekili statÃ¼mÃ¼n sonuÃ§larÄ±nÄ± ve rekabet yasaÄŸÄ± yÃ¼kÃ¼mlÃ¼lÃ¼klerimi anladÄ±m, bir suretini elden teslim aldÄ±m."'
    };
    const elYazisiMetni = beyanlar[type] || '"Ä°ÅŸbu iÅŸ sÃ¶zleÅŸmesini okudum, anladÄ±m, bir suretini teslim aldÄ±m."';
    
    let template = STATE.templates[type] || '';
    template = template
        .replace(/\{\{AD_SOYAD\}\}/g, ad)
        .replace(/\{\{TC\}\}/g, tc)
        .replace(/\{\{ADRES\}\}/g, adres)
        .replace(/\{\{IBAN\}\}/g, iban)
        .replace(/\{\{TELEFON\}\}/g, telefon)
        .replace(/\{\{UCRET\}\}/g, ucret)
        .replace(/\{\{BASLAMA\}\}/g, baslama)
        .replace(/\{\{SUBE\}\}/g, sube);
    
    const html = `<div class="doc">
        ${docHeader('BELÄ°RSÄ°Z SÃœRELÄ° Ä°Åž SÃ–ZLEÅžMESÄ°')}
        <p style="text-align:center;font-weight:bold;margin-top:-10px;margin-bottom:15px">(${posName})</p>
        <div class="doc-section" style="margin-bottom:15px;border-bottom:1px solid #ccc;padding-bottom:8px">
            <table style="width:100%;font-size:10pt">
                <tr><td><strong>SÃ¶zleÅŸme Tarihi:</strong> ${baslama}</td><td style="text-align:right"><strong>SÃ¶zleÅŸme No:</strong> ${docNo('SOZ', sube)}</td></tr>
            </table>
        </div>
        
        <div class="doc-article"><div class="doc-article-title">MADDE 1: TARAFLAR</div>
        <div class="doc-article-content" style="font-size:9pt">
            <p style="font-weight:bold;margin:8px 0 5px 0">1.1. Ä°ÅžVEREN:</p>
            <p style="margin:2px 0"><strong>ÃœnvanÄ±:</strong> ${STATE.company.name}</p>
            <p style="margin:2px 0"><strong>Adres:</strong> ${STATE.company.address}</p>
            <p style="margin:2px 0"><strong>Tel:</strong> ${STATE.company.tel} | <strong>E-posta:</strong> ${STATE.company.email}</p>
            <p style="margin:2px 0"><strong>Vergi D./No:</strong> ${STATE.company.vergiDairesi} / ${STATE.company.vergiNo}</p>
            <p style="margin:2px 0"><strong>Mersis:</strong> ${STATE.company.mersis} | <strong>KEP:</strong> ${STATE.company.kep}</p>
            <p style="font-size:8pt;color:#666;margin:5px 0">(Bundan sonra "Ä°ÅžVEREN" olarak anÄ±lacaktÄ±r.)</p>
            
            <p style="font-weight:bold;margin:12px 0 5px 0">1.2. PERSONEL (Ä°ÅžÃ‡Ä°):</p>
            <p style="margin:2px 0"><strong>AdÄ± SoyadÄ±:</strong> ${ad || '______________________'}</p>
            <p style="margin:2px 0"><strong>T.C. Kimlik No:</strong> ${tc || '______________________'}</p>
            <p style="margin:2px 0"><strong>Adres:</strong> ${adres || '______________________'}</p>
            <p style="margin:2px 0"><strong>Cep Tel:</strong> ${telefon || '______________________'}</p>
            <p style="margin:2px 0"><strong>IBAN:</strong> ${iban || '______________________'}</p>
            <p style="font-size:8pt;color:#666;margin:5px 0">(Bundan sonra "PERSONEL" olarak anÄ±lacaktÄ±r.)</p>
        </div></div>

        ${template}

        <div style="margin-top:30px;page-break-inside:avoid;">
            <table style="width:100%;border:none;">
                <tr>
                    <td style="width:50%;text-align:center;vertical-align:bottom;padding:15px;border:none;">
                        <p style="margin-bottom:50px">(KaÅŸe / Ä°mza)</p>
                        <div style="border-top:1px solid #000;width:70%;margin:0 auto;padding-top:8px">
                            <p style="font-weight:bold;margin:0">Ä°ÅžVEREN</p>
                        </div>
                    </td>
                    <td style="width:50%;text-align:center;vertical-align:bottom;padding:15px;border:none;">
                        <p style="margin-bottom:20px">(Ä°mza)</p>
                        <div style="border-top:1px solid #000;width:70%;margin:0 auto;padding-top:8px">
                            <p style="font-weight:bold;margin:0">PERSONEL</p>
                            <p style="font-size:9pt;margin:3px 0 0 0">(AdÄ± SoyadÄ±)</p>
                        </div>
                    </td>
                </tr>
            </table>
        </div>
        
        <div style="margin-top:25px;padding:15px;border:1px solid #000;page-break-inside:avoid;">
            <p style="font-size:9pt;margin-bottom:8px;font-style:italic">(AÅŸaÄŸÄ±daki alan Personel tarafÄ±ndan kendi el yazÄ±sÄ± ile doldurulacaktÄ±r)</p>
            <p style="font-weight:bold;margin-bottom:8px;font-size:10pt">EL YAZISI Ä°LE BEYAN:</p>
            <p style="background:#f5f5f5;padding:8px;margin:8px 0;font-style:italic;font-size:9pt;border-left:3px solid #ff8674">${elYazisiMetni}</p>
            <div style="margin-top:10px;border:1px solid #ccc;height:50px;background:#fafafa"></div>
            <table style="width:100%;margin-top:10px;border:none;font-size:10pt">
                <tr>
                    <td style="border:none"><strong>Tarih:</strong> ___/___/20___</td>
                    <td style="border:none;text-align:right"><strong>Ä°mza:</strong> ________________</td>
                </tr>
            </table>
        </div>
    </div>`;
    
    showPreview(posName + ' Ä°ÅŸ SÃ¶zleÅŸmesi - ' + ad, html);
}

// ==================== TUTANAK ====================
function generateTutanak() {
    const type = selectedTypes.tutanak || 'olay';
    const titles = {olay: 'OLAY TESPÄ°T TUTANAÄžI', devamsizlik: 'DEVAMSIZLIK TUTANAÄžI', kasa: 'KASA AÃ‡IÄžI TUTANAÄžI', imza: 'Ä°MZADAN Ä°MTÄ°NA TUTANAÄžI'};
    
    const personel = getVal('tut_personel') || '______________________';
    const pozisyon = document.getElementById('tut_pozisyon')?.selectedOptions[0]?.text || '______';
    const tarih = formatDate(getVal('tut_tarih'));
    const saat = getVal('tut_saat') || '__:__';
    const duzTarih = formatDate(getVal('tut_duz_tarih')) || today();
    const duzSaat = getVal('tut_duz_saat') || nowTime();
    const sube = getVal('tut_sube') || STATE.branches[0] || '______';
    const kasa = getVal('tut_kasa');
    const aciklama = getVal('tut_aciklama') || '______________________';
    const sahit1 = getVal('tut_sahit1') || '______________________';
    const sahit2 = getVal('tut_sahit2') || '______________________';
    const duzenleyen = getVal('tut_duzenleyen') || '______________________';
    const gorev = getVal('tut_gorev') || 'Yetkili';
    
    const html = `<div class="doc">
        ${docHeader(titles[type])}
        <div class="doc-section">
            <p><strong>Tutanak No:</strong> ${docNo('TUT', sube)} | <strong>DÃ¼zenleme:</strong> ${duzTarih} ${duzSaat} | <strong>Åžube:</strong> ${sube}</p>
            <p><strong>Personel:</strong> ${personel} (${pozisyon})</p>
            <p><strong>Olay Tarihi:</strong> ${tarih} ${saat}${type === 'kasa' && kasa ? ' | <strong>AÃ§Ä±k:</strong> ' + kasa + ' TL' : ''}</p>
        </div>
        <div class="doc-section">
            <div class="doc-section-title">OLAY AÃ‡IKLAMASI</div>
            <p style="background:#f9f9f9;padding:15px;border-left:4px solid #ff8674">${aciklama}</p>
        </div>
        <p style="margin:20px 0">Ä°ÅŸbu tutanak ÅŸahitler huzurunda dÃ¼zenlenmiÅŸtir.</p>
        <div class="doc-section">
            <div class="doc-section-title">ÅžAHÄ°TLER</div>
            <p>1. ${sahit1} _________________ | 2. ${sahit2} _________________</p>
        </div>
        ${docSignature(
            {title: 'DÃœZENLEYEN', name: duzenleyen, role: gorev},
            {title: 'PERSONEL', name: personel, role: '(Ä°mza / Ä°mtina)'}
        )}
        <p style="margin-top:20px;font-size:9pt;color:#666"><strong>NOT:</strong> Ä°mzadan imtina halinde ÅŸahitler tarafÄ±ndan not edilir.</p>
    </div>`;
    
    showPreview(titles[type] + ' - ' + personel, html);
}

// ==================== SAVUNMA ====================
function generateSavunma() {
    const personel = getVal('sav_personel') || '______________________';
    const pozisyon = document.getElementById('sav_pozisyon')?.selectedOptions[0]?.text || '______';
    const tarih = formatDate(getVal('sav_tarih'));
    const sube = getVal('sav_sube') || STATE.branches[0] || '______';
    const duzTarih = formatDate(getVal('sav_duz_tarih')) || today();
    const duzSaat = getVal('sav_duz_saat') || nowTime();
    const isnat = getVal('sav_isnat') || '______________________';
    const sure = getVal('sav_sure') || '1';
    const yetkili = getVal('sav_yetkili') || 'Ä°nsan KaynaklarÄ±';
    
    const html = `<div class="doc">
        ${docHeader('SAVUNMA Ä°STEME BELGESÄ°')}
        <div class="doc-section">
            <p><strong>Tarih:</strong> ${duzTarih} ${duzSaat} | <strong>Belge No:</strong> ${docNo('SAV', sube)}</p>
            <p><strong>SayÄ±n:</strong> ${personel} (${pozisyon}) - ${sube}</p>
        </div>
        <div class="doc-section">
            <p>4857 sayÄ±lÄ± Ä°ÅŸ Kanunu'nun 19. maddesi gereÄŸince savunma hakkÄ±nÄ±z tanÄ±nmaktadÄ±r.</p>
            <p style="margin-top:15px"><strong>Ä°snat Edilen Eylem:</strong></p>
            <p style="background:#f9f9f9;padding:15px;border-left:4px solid #3498db">${isnat}</p>
            <p style="margin-top:15px"><strong>Olay Tarihi:</strong> ${tarih}</p>
            <p style="margin-top:15px"><strong>Savunma SÃ¼resi:</strong> TebliÄŸden itibaren <strong>${sure} iÅŸ gÃ¼nÃ¼</strong></p>
            <p style="margin-top:15px;background:#fef9e7;padding:12px;border-radius:6px">âš ï¸ SÃ¼re iÃ§inde savunma verilmezse feragat edilmiÅŸ sayÄ±lÄ±r.</p>
        </div>
        <div class="doc-section" style="margin-top:20px;font-size:10pt;color:#666">
            <strong>Yasal Dayanak:</strong> Ä°ÅŸ K. Md. 19: "SavunmasÄ± alÄ±nmadan iÅŸÃ§inin sÃ¶zleÅŸmesi feshedilemez."
        </div>
        ${docSignature(
            {title: 'TEBLÄ°Äž EDEN', name: yetkili, role: 'Ä°mza'},
            {title: 'PERSONEL', name: personel, role: 'TebliÄŸ Tarihi: ___/___/___'}
        )}
    </div>`;
    
    showPreview('Savunma Ä°steme - ' + personel, html);
}

// ==================== FESÄ°H ====================
function generateFesih() {
    const type = selectedTypes.fesih || 'hakli';
    const titles = {hakli: 'HAKLI NEDENLE FESÄ°H BÄ°LDÄ°RÄ°MÄ°', gecerli: 'GEÃ‡ERLÄ° NEDENLE FESÄ°H BÄ°LDÄ°RÄ°MÄ°', deneme: 'DENEME SÃœRESÄ° FESHÄ°'};
    const infos = {
        hakli: 'Ä°ÅŸ Kanunu 25/II uyarÄ±nca sÃ¶zleÅŸmeniz derhal ve tazminatsÄ±z feshedilmiÅŸtir.',
        gecerli: 'Ä°ÅŸ Kanunu 18. madde uyarÄ±nca geÃ§erli nedenle feshedilmiÅŸtir. Tazminat haklarÄ± saklÄ±dÄ±r.',
        deneme: 'Deneme sÃ¼resi iÃ§inde bildirimsiz ve tazminatsÄ±z feshedilmiÅŸtir.'
    };
    
    const personel = getVal('fes_personel') || '______________________';
    const pozisyon = document.getElementById('fes_pozisyon')?.selectedOptions[0]?.text || '______';
    const sube = getVal('fes_sube') || STATE.branches[0] || '______';
    const giris = formatDate(getVal('fes_giris'));
    const fesTarih = formatDate(getVal('fes_tarih')) || today();
    const gerekce = getVal('fes_gerekce') || '______________________';
    const yetkili = getVal('fes_yetkili') || 'Yetkili';
    
    const html = `<div class="doc">
        ${docHeader(titles[type])}
        <div class="doc-section">
            <p><strong>Tarih:</strong> ${fesTarih} | <strong>Belge No:</strong> ${docNo('FES', sube)} | <strong>Åžube:</strong> ${sube}</p>
            <p><strong>SayÄ±n:</strong> ${personel} (${pozisyon})</p>
            <p><strong>Ä°ÅŸe GiriÅŸ Tarihi:</strong> ${giris}</p>
        </div>
        <div class="doc-section">
            <div class="doc-section-title">FESÄ°H GEREKÃ‡ESÄ°</div>
            <p style="background:#fdedec;padding:15px;border-left:4px solid #e74c3c">${gerekce}</p>
        </div>
        <div class="doc-section">
            <p>${infos[type]}</p>
        </div>
        ${type === 'hakli' ? '<p style="background:#fef9e7;padding:12px;border-radius:6px;margin:20px 0">âš ï¸ Ä°ÅŸ Kanunu Md. 26 uyarÄ±nca 6 iÅŸ gÃ¼nÃ¼ iÃ§inde kullanÄ±lmÄ±ÅŸtÄ±r.</p>' : ''}
        ${docSignature(
            {title: 'Ä°ÅžVEREN', name: '(KAÅžE)', role: 'Ä°mza'},
            {title: 'PERSONEL', name: personel, role: 'TebliÄŸ: ___/___/___'}
        )}
    </div>`;
    
    showPreview(titles[type] + ' - ' + personel, html);
}

// ==================== Ä°STÄ°FA DÄ°LEKÃ‡ESÄ° ====================
function generateIstifa() {
    const personel = getVal('istifa_personel') || '______________________';
    const tc = getVal('istifa_tc') || '___________';
    const sube = getVal('istifa_sube') || STATE.branches[0] || '______';
    const pozisyon = document.getElementById('istifa_pozisyon')?.selectedOptions[0]?.text || '______';
    const giris = formatDate(getVal('istifa_giris')) || '___/___/___';
    const tarih = formatDate(getVal('istifa_tarih')) || today();
    const sonTarih = formatDate(getVal('istifa_son_tarih')) || '___/___/___';
    const ihbar = getVal('istifa_ihbar') || '0';
    const neden = getVal('istifa_neden') || 'KiÅŸisel nedenlerden dolayÄ±';
    
    const ihbarText = {
        '0': 'derhal geÃ§erli olmak Ã¼zere',
        '2': '2 haftalÄ±k ihbar sÃ¼resine uyarak',
        '4': '4 haftalÄ±k ihbar sÃ¼resine uyarak',
        '6': '6 haftalÄ±k ihbar sÃ¼resine uyarak',
        '8': '8 haftalÄ±k ihbar sÃ¼resine uyarak'
    };
    
    const html = `<div class="doc">
        ${docHeader('Ä°STÄ°FA DÄ°LEKÃ‡ESÄ°')}
        <div class="doc-section" style="text-align:right;margin-bottom:20px">
            <p><strong>Tarih:</strong> ${tarih}</p>
        </div>
        <div class="doc-section">
            <p style="margin-bottom:20px"><strong>TAMASLAN KAFE RESTORAN VE GIDA HÄ°ZMETLERÄ° TÄ°C. LTD. ÅžTÄ°.</strong></p>
            <p><strong>Åžube:</strong> ${sube}</p>
        </div>
        <div class="doc-section" style="margin-top:30px">
            <p>SayÄ±n Yetkili,</p>
            <p style="margin-top:15px">Åžirketinizde <strong>${giris}</strong> tarihinden beri <strong>${pozisyon}</strong> pozisyonunda Ã§alÄ±ÅŸmaktayÄ±m.</p>
            <p style="margin-top:15px;background:#f8f9fa;padding:15px;border-radius:8px">${neden}</p>
            <p style="margin-top:15px">YukarÄ±da belirttiÄŸim nedenlerle, Ä°ÅŸ Kanunu hÃ¼kÃ¼mlerine uygun olarak <strong>${ihbarText[ihbar]}</strong> gÃ¶revimden istifa ediyorum.</p>
            <p style="margin-top:15px"><strong>Son Ã‡alÄ±ÅŸma Tarihim:</strong> ${sonTarih}</p>
            <p style="margin-top:20px">GereÄŸini arz ederim.</p>
        </div>
        <div style="margin-top:40px;text-align:right">
            <p><strong>${personel}</strong></p>
            <p style="font-size:10pt;color:#666">TC: ${tc}</p>
            <p style="margin-top:30px">Ä°mza: _____________________</p>
        </div>
        <div style="margin-top:40px;padding-top:20px;border-top:1px dashed #ccc">
            <p><strong>Ä°ÅŸveren OnayÄ±:</strong></p>
            <p style="margin-top:10px">TebliÄŸ Alan: _____________________ Tarih: ___/___/___</p>
        </div>
    </div>`;
    
    showPreview('Ä°stifa DilekÃ§esi - ' + personel, html);
}

// ==================== Ä°BRANAME ====================
function generateIbraname() {
    const personel = getVal('ibra_personel') || '______________________';
    const tc = getVal('ibra_tc') || '___________';
    const sube = getVal('ibra_sube') || STATE.branches[0] || '______';
    const pozisyon = document.getElementById('ibra_pozisyon')?.selectedOptions[0]?.text || '______';
    const giris = formatDate(getVal('ibra_giris')) || '___/___/___';
    const cikis = formatDate(getVal('ibra_cikis')) || '___/___/___';
    const tarih = formatDate(getVal('ibra_tarih')) || today();
    const tutar = getVal('ibra_tutar') || '______';
    const iban = getVal('ibra_iban') || '______________________';
    const yetkili = getVal('ibra_yetkili') || 'Yetkili';
    
    // Ã–deme kalemleri
    const kalemler = [];
    if (document.getElementById('ibra_maas')?.checked) kalemler.push('MaaÅŸ AlacaÄŸÄ±');
    if (document.getElementById('ibra_kidem')?.checked) kalemler.push('KÄ±dem TazminatÄ±');
    if (document.getElementById('ibra_ihbar')?.checked) kalemler.push('Ä°hbar TazminatÄ±');
    if (document.getElementById('ibra_izin')?.checked) kalemler.push('KullanÄ±lmayan YÄ±llÄ±k Ä°zin');
    if (document.getElementById('ibra_fazla')?.checked) kalemler.push('Fazla Mesai Ãœcreti');
    if (document.getElementById('ibra_diger')?.checked) kalemler.push('DiÄŸer Alacaklar');
    
    const kalemlerText = kalemler.length > 0 ? kalemler.join(', ') : 'TÃ¼m alacaklar';
    
    const html = `<div class="doc">
        ${docHeader('Ä°BRANAME')}
        <p style="text-align:center;color:#666;margin-top:-15px;margin-bottom:20px">TBK Md. 420 UyarÄ±nca</p>
        <div class="doc-section">
            <p><strong>Tarih:</strong> ${tarih} | <strong>Belge No:</strong> ${docNo('IBR', sube)} | <strong>Åžube:</strong> ${sube}</p>
        </div>
        <div class="doc-section">
            <table style="width:100%;border-collapse:collapse;margin:15px 0">
                <tr><td style="padding:8px;border:1px solid #ddd;background:#f9f9f9;width:30%"><strong>Personel</strong></td><td style="padding:8px;border:1px solid #ddd">${personel}</td></tr>
                <tr><td style="padding:8px;border:1px solid #ddd;background:#f9f9f9"><strong>TC Kimlik No</strong></td><td style="padding:8px;border:1px solid #ddd">${tc}</td></tr>
                <tr><td style="padding:8px;border:1px solid #ddd;background:#f9f9f9"><strong>Pozisyon</strong></td><td style="padding:8px;border:1px solid #ddd">${pozisyon}</td></tr>
                <tr><td style="padding:8px;border:1px solid #ddd;background:#f9f9f9"><strong>Ä°ÅŸe GiriÅŸ</strong></td><td style="padding:8px;border:1px solid #ddd">${giris}</td></tr>
                <tr><td style="padding:8px;border:1px solid #ddd;background:#f9f9f9"><strong>Ä°ÅŸten AyrÄ±lÄ±ÅŸ</strong></td><td style="padding:8px;border:1px solid #ddd">${cikis}</td></tr>
                <tr><td style="padding:8px;border:1px solid #ddd;background:#f9f9f9"><strong>IBAN</strong></td><td style="padding:8px;border:1px solid #ddd">${iban}</td></tr>
            </table>
        </div>
        <div class="doc-section">
            <div class="doc-section-title">Ã–DEME KALEMLERÄ°</div>
            <p style="background:#e8f5e9;padding:15px;border-radius:8px">${kalemlerText}</p>
            <p style="margin-top:15px;font-size:14pt"><strong>TOPLAM Ã–DEME: ${tutar} TL</strong></p>
        </div>
        <div class="doc-section" style="background:#fff3e0;padding:15px;border-radius:8px;margin-top:20px">
            <p>Ben ${personel}, <strong>${giris}</strong> ile <strong>${cikis}</strong> tarihleri arasÄ±nda ${sube} ÅŸubesinde Ã§alÄ±ÅŸtÄ±m.</p>
            <p style="margin-top:10px">YukarÄ±da belirtilen <strong>${kalemlerText}</strong> dahil tÃ¼m iÅŸÃ§ilik alacaklarÄ±mÄ±n toplamÄ± olan <strong>${tutar} TL</strong>'yi IBAN hesabÄ±ma aldÄ±m.</p>
            <p style="margin-top:10px">Ä°ÅŸverenden hiÃ§bir alacaÄŸÄ±m kalmadÄ±ÄŸÄ±nÄ±, ibra ettiÄŸimi beyan ederim.</p>
        </div>
        <div style="background:#e3f2fd;padding:12px;border-radius:6px;font-size:10pt;margin:20px 0">
            <strong>TBK Md. 420:</strong> Ä°ÅŸÃ§i ibrasÄ± yazÄ±lÄ± olmalÄ± ve banka kanalÄ±yla Ã¶denmelidir. Ä°mza tarihinden itibaren 1 ay iÃ§inde itiraz hakkÄ± saklÄ±dÄ±r.
        </div>
        ${docSignature(
            {title: 'Ä°ÅžVEREN', name: yetkili, role: '(KAÅžE / Ä°mza)'},
            {title: 'PERSONEL', name: personel, role: 'El yazÄ±sÄ±: Okudum, aldÄ±m, ibra ediyorum'}
        )}
    </div>`;
    
    showPreview('Ä°braname - ' + personel, html);
}

// ==================== BORÃ‡ Ä°KRAR ====================
function generateBorc() {
    const turLabels = {kasa: 'Kasa AÃ§Ä±ÄŸÄ±', zimmet: 'Zimmet HasarÄ±', stok: 'Stok KaybÄ±'};
    const odemeLabels = {tek: 'maaÅŸtan tek seferde mahsup edilmesini', taksit: 'maaÅŸtan taksitlerle mahsup edilmesini'};
    
    const personel = getVal('borc_personel') || '______________________';
    const tc = getVal('borc_tc');
    const sube = getVal('borc_sube') || STATE.branches[0] || '______';
    const tur = getVal('borc_tur') || 'kasa';
    const tutar = getVal('borc_tutar') || '______';
    const tarih = formatDate(getVal('borc_tarih'));
    const duzTarih = formatDate(getVal('borc_duz_tarih')) || today();
    const odeme = getVal('borc_odeme') || 'tek';
    const aciklama = getVal('borc_aciklama') || '______________________';
    const sahit = getVal('borc_sahit');
    const yetkili = getVal('borc_yetkili') || 'Yetkili';
    
    const html = `<div class="doc">
        ${docHeader('BORÃ‡ Ä°KRAR VE MAHSUP MUVAFAKATNAMESÄ°')}
        <p style="text-align:center;color:#666;margin-top:-15px;margin-bottom:20px">TBK Md. 407/2 UyarÄ±nca</p>
        <div class="doc-section">
            <p><strong>Tarih:</strong> ${duzTarih} | <strong>Belge No:</strong> ${docNo('BRC', sube)} | <strong>Åžube:</strong> ${sube}</p>
            <p><strong>Personel:</strong> ${personel}${tc ? ' | TC: ' + tc : ''}</p>
            <p><strong>BorÃ§ TÃ¼rÃ¼:</strong> ${turLabels[tur]} | <strong>Tutar:</strong> ${tutar} TL | <strong>Olay:</strong> ${tarih}</p>
        </div>
        <div class="doc-section">
            <div class="doc-section-title">OLAY AÃ‡IKLAMASI</div>
            <p style="background:#f9f9f9;padding:15px;border-left:4px solid #ff8674">${aciklama}</p>
        </div>
        <div class="doc-section">
            <p>Ben ${personel}, ${tarih} tarihli olayda kusurum nedeniyle <strong>${tutar} TL</strong> borcumu kabul ediyor, TBK 407/2 uyarÄ±nca ${odemeLabels[odeme]} kendi irademle taahhÃ¼t ediyorum.</p>
            <p style="margin-top:10px">BaskÄ± altÄ±nda deÄŸilim, borcumu ve kesinti koÅŸullarÄ±nÄ± anladÄ±ÄŸÄ±mÄ± beyan ederim.</p>
        </div>
        <div style="background:#ebf5fb;padding:12px;border-radius:6px;font-size:10pt;margin:20px 0">
            <strong>TBK 407/2:</strong> Ä°ÅŸveren, iÅŸÃ§iden alacaÄŸÄ±nÄ± iÅŸÃ§i rÄ±zasÄ± olmadan takas edemez.
        </div>
        ${docSignature(
            {title: 'Ä°ÅžVEREN', name: '(KAÅžE)', role: 'Ä°mza'},
            {title: 'PERSONEL', name: personel, role: 'El yazÄ±sÄ±: Okudum, kabul ediyorum'}
        )}
        ${sahit ? '<p style="margin-top:20px"><strong>Åžahit:</strong> ' + sahit + ' _________________</p>' : ''}
    </div>`;
    
    showPreview('BorÃ§ Ä°krar - ' + personel, html);
}

function generateAvans() {
    const personel = getVal('avans_personel') || '______________________';
    const tc = getVal('avans_tc') || '___________';
    const sube = getVal('avans_sube') || STATE.branches[0] || '______';
    const pozisyon = getVal('avans_pozisyon');
    const pozAd = STATE.positions.find(p => p.id === pozisyon)?.name || '______';
    const iban = getVal('avans_iban') || '______________________';
    const tutarRaw = getVal('avans_tutar') || '______';
    const tarih = formatDate(getVal('avans_tarih')) || today();
    const gerekce = getVal('avans_gerekce') || '______________________';
    
    // Tutar formatla ve yazÄ±ya Ã§evir
    const tutarNum = parseInt(tutarRaw.replace(/\D/g, '')) || 0;
    const tutarFormat = tutarNum > 0 ? tutarNum.toLocaleString('tr-TR') : tutarRaw;
    const tutarYazi = tutarNum > 0 ? sayiyiYaziyaCevir(tutarNum) : '______';
    
    const html = `<div class="doc" style="font-size:11pt;line-height:1.5;-webkit-print-color-adjust:exact;print-color-adjust:exact">
        ${docHeader('AVANS TALEBÄ° FORMU')}
        <table style="width:100%;border-collapse:collapse;margin:15px 0">
            <tr>
                <td style="padding:8px;border:1px solid #ddd;background-color:#f9f9f9;-webkit-print-color-adjust:exact;width:25%"><strong>Ad Soyad</strong></td>
                <td style="padding:8px;border:1px solid #ddd;width:25%">${personel}</td>
                <td style="padding:8px;border:1px solid #ddd;background-color:#f9f9f9;-webkit-print-color-adjust:exact;width:25%"><strong>TC Kimlik No</strong></td>
                <td style="padding:8px;border:1px solid #ddd;width:25%">${tc}</td>
            </tr>
            <tr>
                <td style="padding:8px;border:1px solid #ddd;background-color:#f9f9f9;-webkit-print-color-adjust:exact"><strong>Åžube</strong></td>
                <td style="padding:8px;border:1px solid #ddd">${sube}</td>
                <td style="padding:8px;border:1px solid #ddd;background-color:#f9f9f9;-webkit-print-color-adjust:exact"><strong>Pozisyon</strong></td>
                <td style="padding:8px;border:1px solid #ddd">${pozAd}</td>
            </tr>
            <tr>
                <td style="padding:8px;border:1px solid #ddd;background-color:#f9f9f9;-webkit-print-color-adjust:exact"><strong>IBAN</strong></td>
                <td style="padding:8px;border:1px solid #ddd" colspan="3">${iban}</td>
            </tr>
            <tr>
                <td style="padding:8px;border:1px solid #ddd;background-color:#f9f9f9;-webkit-print-color-adjust:exact"><strong>Talep Tarihi</strong></td>
                <td style="padding:8px;border:1px solid #ddd">${tarih}</td>
                <td style="padding:8px;border:1px solid #ddd;background-color:#f9f9f9;-webkit-print-color-adjust:exact"><strong>Belge No</strong></td>
                <td style="padding:8px;border:1px solid #ddd">${docNo('AVS', sube)}</td>
            </tr>
            <tr>
                <td style="padding:8px;border:1px solid #ddd;background-color:#f9f9f9;-webkit-print-color-adjust:exact"><strong>Talep Edilen Tutar</strong></td>
                <td style="padding:8px;border:1px solid #ddd" colspan="3"><strong>${tutarFormat} TL</strong> (${tutarYazi} TÃ¼rk LirasÄ±)</td>
            </tr>
            <tr>
                <td style="padding:8px;border:1px solid #ddd;background-color:#f9f9f9;-webkit-print-color-adjust:exact"><strong>Geri Ã–deme</strong></td>
                <td style="padding:8px;border:1px solid #ddd" colspan="3">Gelecek ay maaÅŸÄ±ndan tek seferde kesilecektir</td>
            </tr>
        </table>
        <div style="margin:15px 0">
            <strong>Talep GerekÃ§esi:</strong>
            <p style="background-color:#f9f9f9;-webkit-print-color-adjust:exact;padding:12px;border-left:3px solid #ff8674;margin:8px 0;min-height:50px">${gerekce}</p>
        </div>
        <div style="background-color:#f5f5f5;-webkit-print-color-adjust:exact;padding:10px;border-radius:4px;margin:15px 0">
            <strong>PERSONEL BEYANI:</strong> Ben ${personel}, yukarÄ±da belirtilen tutarda avans talep ettiÄŸimi, bu avansÄ±n onaylanmasÄ± halinde gelecek ay maaÅŸÄ±mdan tek seferde kesilerek mahsup edileceÄŸini kabul ve taahhÃ¼t ederim.
        </div>
        <div style="background-color:#ebf5fb;-webkit-print-color-adjust:exact;padding:10px;border-radius:4px;font-size:10pt;margin:15px 0">
            <strong>YASAL BÄ°LGÄ°LENDÄ°RME:</strong> 4857 sayÄ±lÄ± Ä°ÅŸ Kanunu'nda avans Ã¶denmesine iliÅŸkin herhangi bir dÃ¼zenleme bulunmamaktadÄ±r. Avans talebi tamamen iÅŸverenin inisiyatifinde olup, iÅŸveren avans verip vermemekte ve Ã¶deme zamanÄ±nÄ± belirlemekte serbesttir. Talep, 7 iÅŸ gÃ¼nÃ¼ iÃ§inde deÄŸerlendirilecek olup; onaylanmasÄ± halinde en yakÄ±n Ã¶deme dÃ¶ngÃ¼sÃ¼nde, TBK Md. 407/2 uyarÄ±nca personelin yazÄ±lÄ± muvafakati ile maaÅŸÄ±ndan mahsup edilecektir. Ä°ÅŸveren, gerekÃ§e gÃ¶stermeksizin talebi reddetme hakkÄ±nÄ± saklÄ± tutar.
        </div>
        <table style="width:100%;margin-top:20px">
            <tr>
                <td style="width:50%;text-align:center;padding:15px;vertical-align:bottom">
                    <div style="margin-bottom:40px">${personel}</div>
                    <div style="border-top:1px solid #000;padding-top:8px"><strong>PERSONEL</strong><br><span style="font-size:10pt">Ad Soyad / Ä°mza</span></div>
                </td>
                <td style="width:50%;text-align:center;padding:15px;vertical-align:bottom">
                    <div style="margin-bottom:15px">â˜ ONAYLANDI &nbsp; â˜ REDDEDÄ°LDÄ°</div>
                    <div style="margin-bottom:15px;font-size:10pt">Tarih: ___/___/________</div>
                    <div style="border-top:1px solid #000;padding-top:8px"><strong>Ä°ÅžVEREN</strong><br><span style="font-size:10pt">KaÅŸe / Ä°mza</span></div>
                </td>
            </tr>
        </table>
    </div>`;
    
    showPreview('Avans Talebi - ' + personel, html);
}

// SayÄ±yÄ± yazÄ±ya Ã§evir fonksiyonu
function sayiyiYaziyaCevir(sayi) {
    if (sayi === 0) return 'sÄ±fÄ±r';
    if (sayi < 0) return 'eksi ' + sayiyiYaziyaCevir(-sayi);
    
    const birler = ['', 'bir', 'iki', 'Ã¼Ã§', 'dÃ¶rt', 'beÅŸ', 'altÄ±', 'yedi', 'sekiz', 'dokuz'];
    const onlar = ['', 'on', 'yirmi', 'otuz', 'kÄ±rk', 'elli', 'altmÄ±ÅŸ', 'yetmiÅŸ', 'seksen', 'doksan'];
    
    let sonuc = '';
    
    if (sayi >= 1000000) {
        const milyon = Math.floor(sayi / 1000000);
        sonuc += (milyon === 1 ? '' : sayiyiYaziyaCevir(milyon) + ' ') + 'milyon ';
        sayi %= 1000000;
    }
    
    if (sayi >= 1000) {
        const bin = Math.floor(sayi / 1000);
        sonuc += (bin === 1 ? '' : sayiyiYaziyaCevir(bin) + ' ') + 'bin ';
        sayi %= 1000;
    }
    
    if (sayi >= 100) {
        const yuz = Math.floor(sayi / 100);
        sonuc += (yuz === 1 ? '' : birler[yuz] + ' ') + 'yÃ¼z ';
        sayi %= 100;
    }
    
    if (sayi >= 10) {
        sonuc += onlar[Math.floor(sayi / 10)] + ' ';
        sayi %= 10;
    }
    
    if (sayi > 0) {
        sonuc += birler[sayi] + ' ';
    }
    
    return sonuc.trim();
}

// ==================== ZÄ°MMET ====================
let zimmetSayaci = 0;

function zimmetEkle() {
    zimmetSayaci++;
    const container = document.getElementById('zimmetListesi');
    const div = document.createElement('div');
    div.className = 'zimmet-item';
    div.id = `zimmet_item_${zimmetSayaci}`;
    div.style.cssText = 'display:grid;grid-template-columns:1fr 60px 1fr 1fr 1fr auto;gap:10px;padding:15px;background:#f9f9f9;border-radius:8px;margin-bottom:10px;align-items:end';
    div.innerHTML = `
        <div class="form-group" style="margin:0"><label class="form-label">EÅŸya TÃ¼rÃ¼</label>
            <select class="form-select" id="zimmet_tur_${zimmetSayaci}">
                <option value="telefon">Cep Telefonu</option>
                <option value="notebook">Notebook / Laptop</option>
                <option value="tablet">Tablet</option>
                <option value="pos">POS CihazÄ±</option>
                <option value="anahtar">Anahtar</option>
                <option value="kart">GiriÅŸ KartÄ±</option>
                <option value="kiyafet">Ãœniforma / KÄ±yafet</option>
                <option value="diger">DiÄŸer</option>
            </select>
        </div>
        <div class="form-group" style="margin:0"><label class="form-label">Adet</label><input type="number" class="form-input" id="zimmet_adet_${zimmetSayaci}" value="1" min="1" style="text-align:center"></div>
        <div class="form-group" style="margin:0"><label class="form-label">Marka / Model</label><input type="text" class="form-input" id="zimmet_marka_${zimmetSayaci}" placeholder="Ã–rn: iPhone 17 Pro"></div>
        <div class="form-group" style="margin:0"><label class="form-label">Seri No / IMEI</label><input type="text" class="form-input" id="zimmet_seri_${zimmetSayaci}" placeholder="Varsa seri numarasÄ±"></div>
        <div class="form-group" style="margin:0"><label class="form-label">Tahmini DeÄŸer (TL)</label><input type="text" class="form-input" id="zimmet_deger_${zimmetSayaci}" placeholder="0"></div>
        <button class="btn btn-ghost" onclick="zimmetSil(${zimmetSayaci})" style="color:#e74c3c;padding:8px">ðŸ—‘ï¸</button>
    `;
    container.appendChild(div);
}

function zimmetSil(id) {
    const item = document.getElementById(`zimmet_item_${id}`);
    if (item) item.remove();
}

function getZimmetListesi() {
    const items = document.querySelectorAll('[id^="zimmet_item_"]');
    const liste = [];
    items.forEach(item => {
        const id = item.id.replace('zimmet_item_', '');
        const turSelect = document.getElementById(`zimmet_tur_${id}`);
        const tur = turSelect ? turSelect.options[turSelect.selectedIndex].text : '';
        const adet = document.getElementById(`zimmet_adet_${id}`)?.value || '1';
        const marka = document.getElementById(`zimmet_marka_${id}`)?.value || '';
        const seri = document.getElementById(`zimmet_seri_${id}`)?.value || '-';
        const deger = document.getElementById(`zimmet_deger_${id}`)?.value || '0';
        if (tur || marka) {
            liste.push({ tur, adet, marka, seri, deger });
        }
    });
    return liste;
}

function generateZimmet() {
    const islemLabels = {teslim: 'TESLÄ°M (ZÄ°MMET)', iade: 'Ä°ADE'};
    
    const personel = getVal('zimmet_personel') || '______________________';
    const tc = getVal('zimmet_tc') || '___________';
    const sube = getVal('zimmet_sube') || STATE.branches[0] || '______';
    const pozisyon = getVal('zimmet_pozisyon');
    const pozAd = STATE.positions.find(p => p.id === pozisyon)?.name || '______';
    const tarih = formatDate(getVal('zimmet_tarih')) || today();
    const islem = getVal('zimmet_islem') || 'teslim';
    const notlar = getVal('zimmet_notlar') || '';
    const yetkili = getVal('zimmet_yetkili') || '______________________';
    
    const liste = getZimmetListesi();
    
    if (liste.length === 0) {
        alert('LÃ¼tfen en az bir eÅŸya ekleyin.');
        return;
    }
    
    let toplamDeger = 0;
    const esyaRows = liste.map((item, idx) => {
        const degerNum = parseInt(item.deger.replace(/\D/g, '')) || 0;
        toplamDeger += degerNum;
        return `<tr>
            <td style="padding:8px;border:1px solid #ddd;text-align:center">${idx + 1}</td>
            <td style="padding:8px;border:1px solid #ddd">${item.tur}</td>
            <td style="padding:8px;border:1px solid #ddd;text-align:center">${item.adet}</td>
            <td style="padding:8px;border:1px solid #ddd">${item.marka}</td>
            <td style="padding:8px;border:1px solid #ddd">${item.seri}</td>
            <td style="padding:8px;border:1px solid #ddd;text-align:right">${degerNum.toLocaleString('tr-TR')} TL</td>
        </tr>`;
    }).join('');
    
    const html = `<div class="doc" style="font-size:11pt;line-height:1.5;-webkit-print-color-adjust:exact;print-color-adjust:exact">
        ${docHeader('DEMÄ°RBAÅž TESLÄ°M VE ZÄ°MMET TUTANAÄžI')}
        <p style="text-align:center;font-weight:bold;margin-top:-10px;margin-bottom:20px;color:#ff8674">${islemLabels[islem]}</p>
        <div class="doc-section" style="margin-bottom:15px">
            <table style="width:100%;font-size:10pt">
                <tr><td><strong>Tarih:</strong> ${tarih}</td><td style="text-align:right"><strong>Belge No:</strong> ${docNo('ZMT', sube)}</td></tr>
            </table>
        </div>
        
        <table style="width:100%;border-collapse:collapse;margin:15px 0">
            <tr>
                <td style="padding:8px;border:1px solid #ddd;background-color:#f9f9f9;-webkit-print-color-adjust:exact;width:25%"><strong>Personel</strong></td>
                <td style="padding:8px;border:1px solid #ddd;width:25%">${personel}</td>
                <td style="padding:8px;border:1px solid #ddd;background-color:#f9f9f9;-webkit-print-color-adjust:exact;width:25%"><strong>TC Kimlik No</strong></td>
                <td style="padding:8px;border:1px solid #ddd;width:25%">${tc}</td>
            </tr>
            <tr>
                <td style="padding:8px;border:1px solid #ddd;background-color:#f9f9f9;-webkit-print-color-adjust:exact"><strong>Åžube</strong></td>
                <td style="padding:8px;border:1px solid #ddd">${sube}</td>
                <td style="padding:8px;border:1px solid #ddd;background-color:#f9f9f9;-webkit-print-color-adjust:exact"><strong>Pozisyon</strong></td>
                <td style="padding:8px;border:1px solid #ddd">${pozAd}</td>
            </tr>
        </table>
        
        <div style="margin:20px 0">
            <strong style="font-size:12pt">ZÄ°MMET EDÄ°LEN EÅžYALAR</strong>
            <table style="width:100%;border-collapse:collapse;margin:10px 0">
                <thead>
                    <tr style="background-color:#f0f0f0;-webkit-print-color-adjust:exact">
                        <th style="padding:10px;border:1px solid #ddd;width:40px">No</th>
                        <th style="padding:10px;border:1px solid #ddd">EÅŸya TÃ¼rÃ¼</th>
                        <th style="padding:10px;border:1px solid #ddd;width:50px">Adet</th>
                        <th style="padding:10px;border:1px solid #ddd">Marka / Model</th>
                        <th style="padding:10px;border:1px solid #ddd">Seri No / IMEI</th>
                        <th style="padding:10px;border:1px solid #ddd;width:100px">DeÄŸer</th>
                    </tr>
                </thead>
                <tbody>
                    ${esyaRows}
                </tbody>
                <tfoot>
                    <tr style="background-color:#f9f9f9;-webkit-print-color-adjust:exact">
                        <td colspan="5" style="padding:10px;border:1px solid #ddd;text-align:right"><strong>TOPLAM DEÄžER:</strong></td>
                        <td style="padding:10px;border:1px solid #ddd;text-align:right"><strong>${toplamDeger.toLocaleString('tr-TR')} TL</strong></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        ${notlar ? `<div style="margin:15px 0"><strong>Ek Notlar:</strong><p style="background-color:#f9f9f9;-webkit-print-color-adjust:exact;padding:10px;border-left:3px solid #ff8674;margin:5px 0">${notlar}</p></div>` : ''}
        
        <div style="background-color:#ebf5fb;-webkit-print-color-adjust:exact;padding:12px;border-radius:6px;font-size:10pt;margin:20px 0">
            <strong>PERSONEL TAAHHÃœDÃœ:</strong><br>
            YukarÄ±da belirtilen demirbaÅŸ/eÅŸyalarÄ± eksiksiz ve Ã§alÄ±ÅŸÄ±r durumda teslim aldÄ±ÄŸÄ±mÄ±; bunlarÄ± Ã¶zenle kullanacaÄŸÄ±mÄ±, iÅŸveren izni olmaksÄ±zÄ±n Ã¼Ã§Ã¼ncÃ¼ kiÅŸilere devretmeyeceÄŸimi, iÅŸten ayrÄ±lmam veya talep halinde derhal iade edeceÄŸimi kabul ve taahhÃ¼t ederim.<br><br>
            <strong>Yasal Dayanak:</strong> TBK Md. 390 (Ã¶zen borcu), TBK Md. 462 (teslim edilen eÅŸyalarÄ±n korunmasÄ±), 4857 sayÄ±lÄ± Ä°ÅŸ Kanunu Md. 25/II-e (gÃ¼veni kÃ¶tÃ¼ye kullanma). Zimmet edilen eÅŸyalarÄ±n kaybÄ±, hasarÄ± veya iadeden imtina halinde, gÃ¼ncel rayiÃ§ bedeli Ã¼zerinden tazmin yÃ¼kÃ¼mlÃ¼lÃ¼ÄŸÃ¼ doÄŸar.
        </div>
        
        <table style="width:100%;margin-top:40px;border:none;">
            <tr>
                <td style="width:50%;text-align:center;vertical-align:bottom;padding:20px;border:none;">
                    <p style="margin-bottom:60px">(KaÅŸe / Ä°mza)</p>
                    <div style="border-top:1px solid #000;width:70%;margin:0 auto;padding-top:10px">
                        <p style="font-weight:bold">TESLÄ°M EDEN</p>
                        <p style="font-size:10pt">${yetkili}</p>
                    </div>
                </td>
                <td style="width:50%;text-align:center;vertical-align:bottom;padding:20px;border:none;">
                    <p style="margin-bottom:40px">${personel}</p>
                    <p style="margin-bottom:20px">(Ä°mza)</p>
                    <div style="border-top:1px solid #000;width:70%;margin:0 auto;padding-top:10px">
                        <p style="font-weight:bold">TESLÄ°M ALAN</p>
                    </div>
                </td>
            </tr>
        </table>
    </div>`;
    
    showPreview('Zimmet Formu - ' + personel, html);
}

// Sayfa yÃ¼klendiÄŸinde varsayÄ±lan bir eÅŸya satÄ±rÄ± ekle
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        if (document.getElementById('zimmetListesi') && document.getElementById('zimmetListesi').children.length === 0) {
            zimmetEkle();
        }
    }, 500);
});

// ==================== KATALOG ====================
function renderViolations(filter = 'all') {
    const list = document.getElementById('violationList');
    if (!list) return;
    let items = filter === 'all' ? STATE.violations : STATE.violations.filter(v => v.risk === filter);
    list.innerHTML = items.map(v => `
        <div class="violation-item" onclick="showViolation('${v.id}')">
            <div class="violation-header">
                <div class="violation-title">${v.id}: ${v.title}</div>
                <span class="violation-badge ${v.risk}">${v.risk === 'low' ? 'DÃ¼ÅŸÃ¼k' : v.risk === 'medium' ? 'Orta' : 'YÃ¼ksek'}</span>
            </div>
            <div class="violation-legal">${v.legal}</div>
        </div>
    `).join('');
}

function filterKatalog(filter, btn) {
    document.querySelectorAll('#katalogTabs .tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    renderViolations(filter);
}

function showViolation(id) {
    const v = STATE.violations.find(x => x.id === id);
    if (!v) return;
    const colors = {low: '#e9f7ef', medium: '#fef9e7', high: '#fdedec'};
    const html = `<div class="doc">
        <div class="doc-header" style="border-bottom-color:${v.risk === 'high' ? '#e74c3c' : v.risk === 'medium' ? '#f39c12' : '#2ecc71'}">
            <div class="doc-title" style="text-decoration:none">${v.title}</div>
            <div class="doc-company-info">${v.id}</div>
        </div>
        <div class="doc-section"><div class="doc-section-title">YASAL DAYANAK</div><p>${v.legal}</p></div>
        <div class="doc-section"><div class="doc-section-title">AÃ‡IKLAMA</div><p>${v.desc}</p></div>
        <div class="doc-section"><div class="doc-section-title">Ä°ZLENECEK PROSEDÃœR</div><ol style="margin-left:20px;line-height:2">${v.steps.map(s => '<li>' + s + '</li>').join('')}</ol></div>
        <div style="background:${colors[v.risk]};padding:15px;border-radius:6px"><strong>Risk:</strong> ${v.risk === 'low' ? 'DÃœÅžÃœK - UyarÄ± ile Ã§Ã¶zÃ¼lebilir' : v.risk === 'medium' ? 'ORTA - Savunma ve ihtar gerektirir' : 'YÃœKSEK - HaklÄ± fesih sebebi'}</div>
    </div>`;
    showPreview(v.title, html);
}

// ==================== ADMIN PANEL ====================
function openAdminWithPin() {
    // ArtÄ±k PIN sormuyoruz, giriÅŸ yapÄ±lmÄ±ÅŸ kullanÄ±cÄ±nÄ±n yetkisini kontrol ediyoruz
    if (!currentUser) {
        toast('LÃ¼tfen Ã¶nce giriÅŸ yapÄ±n', 'error');
        return;
    }
    
    // YÃ¶netici her zaman eriÅŸebilir
    if (currentUser.role === 'yonetici') {
        goTo('admin');
        return;
    }
    
    // Barista ve MÃ¼dÃ¼r YardÄ±mcÄ±sÄ± - sadece Genel sekmesine eriÅŸebilir (kendi profilini dÃ¼zenlemek iÃ§in)
    if (currentUser.role === 'barista' || currentUser.role === 'magaza_mudur_yardimcisi') {
        goTo('admin');
        showAdminTab('genel', document.getElementById('tab-genel'));
        return;
    }
    
    // DiÄŸer roller iÃ§in geliÅŸmiÅŸ izin kontrolÃ¼
    if (checkPermission('admin', 'admin_genel', 'access')) {
        goTo('admin');
    } else {
        toast('Bu sayfaya eriÅŸim yetkiniz yok', 'error');
    }
}

function autoCheckAdminPin() {
    const input = document.getElementById('adminPinInput');
    if (input && input.value.length === 4) {
        if (input.value === STATE.pin) {
            input.style.borderColor = 'var(--green)';
            setTimeout(() => {
                closeModal();
                goTo('admin');
            }, 200);
        } else {
            input.style.borderColor = 'var(--red)';
            toast('HatalÄ± PIN', 'error');
            setTimeout(() => {
                input.value = '';
                input.style.borderColor = '';
            }, 500);
        }
    }
}

function checkAdminPin() {
    const input = document.getElementById('adminPinInput');
    if (input && input.value === STATE.pin) {
        closeModal();
        goTo('admin');
    } else {
        toast('HatalÄ± PIN', 'error');
        if (input) input.value = '';
    }
}

function showAdminTab(tab, btn) {
    // KaydedilmemiÅŸ belge ÅŸablonu deÄŸiÅŸikliÄŸi kontrolÃ¼
    if (hasUnsavedDocChanges && currentPage === 'admin') {
        showUnsavedChangesModal(() => {
            saveDocTemplate();
            hasUnsavedDocChanges = false;
            switchAdminTab(tab, btn);
        }, () => {
            hasUnsavedDocChanges = false;
            switchAdminTab(tab, btn);
        });
        return;
    }
    switchAdminTab(tab, btn);
}

function switchAdminTab(tab, btn) {
    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
    document.getElementById('admin-' + tab).classList.add('active');
    if (tab === 'genel') loadMyProfile();
    if (tab === 'kullanicilar') {
        renderPositionListCombined();
        renderDynamicPositionCards();
    }
    if (tab === 'sablonlar') loadTemplate();
    if (tab === 'belgeler') loadDocTemplate('tutanak', 'olay');
    if (tab === 'oturumlar') {
        loadSessionSettings();
        loadActiveSessions();
        loadSessionHistory();
        loadActivityLogs(); // Aktiviteler de oturumlar sekmesinde
    }
    // aktiviteler artÄ±k oturumlar ile birleÅŸtirildi
    // yedekler lazy-load: butona tÄ±klayÄ±nca yÃ¼klenir
    if (tab === 'magazaSaatleri') renderBranchHoursSettings();
    if (tab === 'checkKurallari') renderCheckRulesSettings();
    if (tab === 'checklistTurleri') loadChecklistTypesConfig();
    if (tab === 'tumCheckler') {
        populateSubeSelect('allChecksBranchFilter', true);
        loadAllChecksOverview();
    }
}

function loadAdminFields() {
    document.getElementById('admin_company_name').value = STATE.company.name;
    document.getElementById('admin_mersis').value = STATE.company.mersis;
    document.getElementById('admin_address').value = STATE.company.address;
}

// ==================== PROFÄ°LÄ°M ====================
async function loadMyProfile() {
    const container = document.getElementById('myProfileContainer');
    if (!container) return;
    
    container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--tx2)">YÃ¼kleniyor...</div>';
    
    try {
        // Mevcut kullanÄ±cÄ±nÄ±n personel kaydÄ±nÄ± bul
        const email = currentUser?.email;
        if (!email) {
            container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--tx3)">KullanÄ±cÄ± bilgisi bulunamadÄ±</div>';
            return;
        }
        
        const personelSnap = await db.collection('personel').where('email', '==', email).limit(1).get();
        
        if (personelSnap.empty) {
            // Admin kontrolÃ¼ - systemConfig'den
            let isAdmin = false;
            try {
                const configDoc = await db.collection('systemConfig').doc('main').get();
                if (configDoc.exists) {
                    const adminEmails = configDoc.data().adminEmails || [];
                    isAdmin = adminEmails.includes(email);
                }
            } catch (e) {
                console.log('Config okunamadÄ±:', e);
            }
            
            if (isAdmin) {
                // Admin profil sayfasÄ±
                container.innerHTML = `
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                        <!-- Sol: Admin Bilgileri -->
                        <div>
                            <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid var(--bg4)">
                                <div style="width:70px;height:70px;background:linear-gradient(135deg,#008c95,#00a8a8);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.5rem;font-weight:600;overflow:hidden">
                                    <svg width="32" height="32" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 15c-3.87 0-7 1.79-7 4v2h14v-2c0-2.21-3.13-4-7-4zM12 12a4 4 0 100-8 4 4 0 000 8z"/><path d="M17 11l2 2 4-4"/></svg>
                                </div>
                                <div>
                                    <div style="font-weight:600;font-size:1.1rem;color:var(--tx)">YÃ¶netici</div>
                                    <div style="font-size:.85rem;color:var(--tx2)">Sistem YÃ¶neticisi</div>
                                </div>
                            </div>
                            
                            <div style="display:grid;gap:10px">
                                <div style="display:flex;align-items:center;gap:8px">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--tx3)" stroke-width="2" style="flex-shrink:0"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                                    <span style="color:var(--tx2);opacity:.7;flex:1">${email}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- SaÄŸ: Åžifre DeÄŸiÅŸtirme -->
                        <div style="background:var(--bg3);padding:16px;border-radius:12px">
                            <div style="font-weight:600;color:var(--tx);margin-bottom:12px;display:flex;align-items:center;gap:8px">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
                                Åžifre DeÄŸiÅŸtir
                            </div>
                            
                            <div style="display:grid;gap:10px">
                                <div>
                                    <label style="font-size:.75rem;color:var(--tx3);display:block;margin-bottom:4px">Mevcut Åžifre</label>
                                    <div style="position:relative">
                                        <input type="password" id="adminCurrentPassword" class="form-input" style="padding-right:40px;width:100%" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                                        <button type="button" onclick="togglePasswordVisibility('adminCurrentPassword', this)" 
                                            style="position:absolute;right:4px;top:50%;transform:translateY(-50%);width:32px;height:32px;background:transparent;border:none;cursor:pointer;color:var(--tx3);display:flex;align-items:center;justify-content:center;border-radius:4px;transition:all .12s"
                                            onmouseover="this.style.color='var(--tx)'"
                                            onmouseout="this.style.color='var(--tx3)'"
                                            title="Åžifreyi GÃ¶ster/Gizle">
                                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label style="font-size:.75rem;color:var(--tx3);display:block;margin-bottom:4px">Yeni Åžifre</label>
                                    <div style="position:relative">
                                        <input type="password" id="adminNewPassword" class="form-input" style="padding-right:40px;width:100%" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                                        <button type="button" onclick="togglePasswordVisibility('adminNewPassword', this)" 
                                            style="position:absolute;right:4px;top:50%;transform:translateY(-50%);width:32px;height:32px;background:transparent;border:none;cursor:pointer;color:var(--tx3);display:flex;align-items:center;justify-content:center;border-radius:4px;transition:all .12s"
                                            onmouseover="this.style.color='var(--tx)'"
                                            onmouseout="this.style.color='var(--tx3)'"
                                            title="Åžifreyi GÃ¶ster/Gizle">
                                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label style="font-size:.75rem;color:var(--tx3);display:block;margin-bottom:4px">Yeni Åžifre (Tekrar)</label>
                                    <div style="position:relative">
                                        <input type="password" id="adminConfirmPassword" class="form-input" style="padding-right:40px;width:100%" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                                        <button type="button" onclick="togglePasswordVisibility('adminConfirmPassword', this)" 
                                            style="position:absolute;right:4px;top:50%;transform:translateY(-50%);width:32px;height:32px;background:transparent;border:none;cursor:pointer;color:var(--tx3);display:flex;align-items:center;justify-content:center;border-radius:4px;transition:all .12s"
                                            onmouseover="this.style.color='var(--tx)'"
                                            onmouseout="this.style.color='var(--tx3)'"
                                            title="Åžifreyi GÃ¶ster/Gizle">
                                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-top:10px;padding:10px;background:var(--bg);border-radius:8px;font-size:.75rem;color:var(--tx3)">
                                <div style="font-weight:500;margin-bottom:4px;color:var(--tx2)">Åžifre gereksinimleri:</div>
                                <div style="display:flex;flex-wrap:wrap;gap:8px">
                                    <span>â€¢ En az 8 karakter</span>
                                    <span>â€¢ BÃ¼yÃ¼k harf</span>
                                    <span>â€¢ KÃ¼Ã§Ã¼k harf</span>
                                    <span>â€¢ Rakam</span>
                                    <span>â€¢ Ã–zel karakter (!@#$...)</span>
                                </div>
                            </div>
                            
                            <button onclick="changeAdminPassword()" class="btn btn-sm" style="margin-top:12px;background:#008c95;color:#fff;border:none;display:flex;align-items:center;gap:6px;transition:background .2s" onmouseover="this.style.background='#006d73'" onmouseout="this.style.background='#008c95'">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
                                Åžifremi DeÄŸiÅŸtir
                            </button>
                        </div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--tx3)">Personel kaydÄ± bulunamadÄ±</div>';
            return;
        }
        
        const personelDoc = personelSnap.docs[0];
        const p = personelDoc.data();
        const docId = personelDoc.id;
        
        // Pozisyon bilgisi
        const roleNames = {
            'yonetici': 'YÃ¶netici',
            'bolge_muduru': 'BÃ¶lge MÃ¼dÃ¼rÃ¼',
            'magaza_muduru': 'MaÄŸaza MÃ¼dÃ¼rÃ¼',
            'magaza_mudur_yardimcisi': 'MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±',
            'barista': 'Barista'
        };
        
        // Profil fotoÄŸrafÄ± - varsa gÃ¶ster
        const photoUrl = p.photoUrl || '';
        const photoDisplay = photoUrl 
            ? `<img src="${photoUrl}" style="width:100%;height:100%;object-fit:cover">`
            : `${(p.name || 'U').charAt(0).toUpperCase()}`;
        
        container.innerHTML = `
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                <!-- Sol: Bilgiler -->
                <div>
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid var(--bg4)">
                        <div style="position:relative">
                            <div id="profilePhotoPreview" style="width:70px;height:70px;background:linear-gradient(135deg,#008c95,#00a8a8);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.5rem;font-weight:600;overflow:hidden;cursor:pointer" onclick="openAvatarModal('${docId}')" title="Profil resmi deÄŸiÅŸtir">
                                ${photoDisplay}
                            </div>
                            <div style="position:absolute;bottom:0;right:0;width:24px;height:24px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;border:2px solid var(--cardBg)" onclick="openAvatarModal('${docId}')">
                                <svg width="12" height="12" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
                            </div>
                        </div>
                        <div>
                            <div style="font-size:1.2rem;font-weight:600;color:var(--tx)">${p.name || '-'}</div>
                            <div style="font-size:.85rem;color:var(--tx2)">${p.position || roleNames[p.role] || 'Personel'}</div>
                            <div style="font-size:.75rem;color:var(--tx3)">${p.branch || '-'}</div>
                        </div>
                    </div>
                    <div style="font-size:.7rem;color:var(--tx3);margin-bottom:12px;display:flex;align-items:center;gap:6px">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
                        Profil resmine tÄ±klayarak fotoÄŸraf yÃ¼kle veya avatar seÃ§
                    </div>
                    
                    <div style="display:grid;gap:10px;font-size:.85rem">
                        <div style="display:flex;align-items:center;gap:8px">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--tx3)" stroke-width="2" style="flex-shrink:0"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                            <span style="color:var(--tx2);opacity:.7;flex:1">${p.email || '-'}</span>
                            <span style="font-size:.65rem;color:var(--tx3)">(deÄŸiÅŸtirilemez)</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--tx3)" stroke-width="2" style="flex-shrink:0"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                            <input type="tel" id="myProfile_phone" value="${p.phone || ''}" class="form-input" style="flex:1" placeholder="+90 5XX XXX XX XX">
                        </div>
                        <div style="display:flex;align-items:center;gap:8px">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--tx3)" stroke-width="2" style="flex-shrink:0"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                            <input type="text" id="myProfile_address" value="${p.address || ''}" class="form-input" style="flex:1" placeholder="Ev adresinizi girin">
                        </div>
                        <div style="display:flex;align-items:center;gap:8px">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--tx3)" stroke-width="2" style="flex-shrink:0"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
                            <div style="flex:1;position:relative">
                                <input type="text" id="myProfile_bankName" value="${p.bankName || ''}" class="form-input" style="width:100%" placeholder="Banka seÃ§in veya yazÄ±n" autocomplete="off" onclick="showBankDropdown()" oninput="filterBanks(this.value)">
                                <div id="bankDropdown" style="display:none;position:absolute;top:100%;left:0;right:0;background:var(--bg);border:1px solid var(--bg4);border-radius:8px;max-height:200px;overflow-y:auto;z-index:100;box-shadow:0 4px 12px rgba(0,0,0,.15);margin-top:4px"></div>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--tx3)" stroke-width="2" style="flex-shrink:0"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                            <input type="text" id="myProfile_iban" value="${p.iban || ''}" class="form-input" style="flex:1" placeholder="TR00 0000 0000 0000 0000 0000 00">
                            <button type="button" onclick="copyIban()" style="background:var(--bg3);border:1px solid var(--bg4);border-radius:6px;padding:6px 10px;cursor:pointer;display:flex;align-items:center;gap:4px;color:var(--tx2);font-size:.75rem;transition:all .15s" onmouseover="this.style.background='var(--bg4)'" onmouseout="this.style.background='var(--bg3)'" title="IBAN'Ä± kopyala">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                            </button>
                        </div>
                    </div>
                    
                    <button onclick="saveMyProfile('${docId}')" class="btn btn-primary btn-sm" style="margin-top:16px;display:flex;align-items:center;gap:6px;justify-content:center">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                        Bilgilerimi Kaydet
                    </button>
                </div>
                
                <!-- SaÄŸ: Åžifre DeÄŸiÅŸtirme -->
                <div style="background:var(--bg3);padding:16px;border-radius:12px">
                    <div style="font-weight:600;color:var(--tx);margin-bottom:12px;display:flex;align-items:center;gap:8px">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
                        Åžifre DeÄŸiÅŸtir
                    </div>
                    
                    <div style="display:grid;gap:10px">
                        <div>
                            <label style="font-size:.75rem;color:var(--tx3);display:block;margin-bottom:4px">Mevcut Åžifre</label>
                            <div style="position:relative">
                                <input type="password" id="myProfile_currentPassword" class="form-input" style="padding-right:40px;width:100%" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                                <button type="button" onclick="togglePasswordVisibility('myProfile_currentPassword', this)" 
                                    style="position:absolute;right:4px;top:50%;transform:translateY(-50%);width:32px;height:32px;background:transparent;border:none;cursor:pointer;color:var(--tx3);display:flex;align-items:center;justify-content:center;border-radius:4px;transition:all .12s"
                                    onmouseover="this.style.color='var(--tx)'"
                                    onmouseout="this.style.color='var(--tx3)'"
                                    title="Åžifreyi GÃ¶ster/Gizle">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label style="font-size:.75rem;color:var(--tx3);display:block;margin-bottom:4px">Yeni Åžifre</label>
                            <div style="position:relative">
                                <input type="password" id="myProfile_newPassword" class="form-input" style="padding-right:40px;width:100%" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                                <button type="button" onclick="togglePasswordVisibility('myProfile_newPassword', this)" 
                                    style="position:absolute;right:4px;top:50%;transform:translateY(-50%);width:32px;height:32px;background:transparent;border:none;cursor:pointer;color:var(--tx3);display:flex;align-items:center;justify-content:center;border-radius:4px;transition:all .12s"
                                    onmouseover="this.style.color='var(--tx)'"
                                    onmouseout="this.style.color='var(--tx3)'"
                                    title="Åžifreyi GÃ¶ster/Gizle">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label style="font-size:.75rem;color:var(--tx3);display:block;margin-bottom:4px">Yeni Åžifre (Tekrar)</label>
                            <div style="position:relative">
                                <input type="password" id="myProfile_confirmPassword" class="form-input" style="padding-right:40px;width:100%" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                                <button type="button" onclick="togglePasswordVisibility('myProfile_confirmPassword', this)" 
                                    style="position:absolute;right:4px;top:50%;transform:translateY(-50%);width:32px;height:32px;background:transparent;border:none;cursor:pointer;color:var(--tx3);display:flex;align-items:center;justify-content:center;border-radius:4px;transition:all .12s"
                                    onmouseover="this.style.color='var(--tx)'"
                                    onmouseout="this.style.color='var(--tx3)'"
                                    title="Åžifreyi GÃ¶ster/Gizle">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top:10px;padding:10px;background:var(--bg);border-radius:8px;font-size:.75rem;color:var(--tx3)">
                        <div style="font-weight:500;margin-bottom:4px;color:var(--tx2)">Åžifre gereksinimleri:</div>
                        <div style="display:flex;flex-wrap:wrap;gap:8px">
                            <span>â€¢ En az 8 karakter</span>
                            <span>â€¢ BÃ¼yÃ¼k harf</span>
                            <span>â€¢ KÃ¼Ã§Ã¼k harf</span>
                            <span>â€¢ Rakam</span>
                            <span>â€¢ Ã–zel karakter (!@#$...)</span>
                        </div>
                    </div>
                    
                    <button onclick="changeMyPassword('${docId}')" class="btn btn-sm" style="margin-top:12px;background:#008c95;color:#fff;border:none;display:flex;align-items:center;gap:6px;transition:background .2s" onmouseover="this.style.background='#006d73'" onmouseout="this.style.background='#008c95'">
                        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
                        Åžifremi DeÄŸiÅŸtir
                    </button>
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('Profil yÃ¼kleme hatasÄ±:', error);
        container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--red)">YÃ¼kleme hatasÄ±: ' + error.message + '</div>';
    }
}

// Avatar seÃ§enekleri - 60 adet Ã§eÅŸitli avatarlar
// Avatar seÃ§enekleri - 100 adet tatlÄ±, sempatik avatarlar
const AVATAR_OPTIONS = [
    // === SEVÄ°MLÄ° HAYVANLAR (20) ===
    { label: 'Kedi', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=CuteCat&backgroundColor=ffdfbf' },
    { label: 'KÃ¶pek', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=HappyDog&backgroundColor=ffd5dc' },
    { label: 'TavÅŸan', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=BunnyHop&backgroundColor=d1d4f9' },
    { label: 'AyÄ±', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=TeddyBear&backgroundColor=c0aede' },
    { label: 'Panda', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=PandaLove&backgroundColor=b6e3f4' },
    { label: 'Tilki', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=CuteF0x&backgroundColor=ffdfbf' },
    { label: 'Aslan', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=LionKing&backgroundColor=ffd5dc' },
    { label: 'Kaplan', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=TigerCub&backgroundColor=ffdfbf' },
    { label: 'Koala', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=KoalaBaby&backgroundColor=c0aede' },
    { label: 'Penguen', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=PenguinIce&backgroundColor=b6e3f4' },
    { label: 'BaykuÅŸ', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=WiseOwl&backgroundColor=d1d4f9' },
    { label: 'Maymun', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=FunnyMonkey&backgroundColor=ffdfbf' },
    { label: 'Fil', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=BabyElephant&backgroundColor=b6e3f4' },
    { label: 'ZÃ¼rafa', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=TallGiraffe&backgroundColor=ffd5dc' },
    { label: 'KaplumbaÄŸa', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=SlowTurtle&backgroundColor=c0aede' },
    { label: 'Kelebek', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=Butterfly1&backgroundColor=d1d4f9' },
    { label: 'ArÄ±', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=BusyBee&backgroundColor=ffdfbf' },
    { label: 'KuÅŸ', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=LittleBird&backgroundColor=b6e3f4' },
    { label: 'BalÄ±k', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=GoldFish&backgroundColor=ffd5dc' },
    { label: 'Yunus', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=Dolphin1&backgroundColor=b6e3f4' },
    // === Ã‡Ä°Ã‡EKLER & DOÄžA (15) ===
    { label: 'GÃ¼l', url: 'https://api.dicebear.com/7.x/thumbs/svg?seed=Rose1&backgroundColor=ffd5dc' },
    { label: 'Papatya', url: 'https://api.dicebear.com/7.x/thumbs/svg?seed=Daisy1&backgroundColor=ffdfbf' },
    { label: 'Lale', url: 'https://api.dicebear.com/7.x/thumbs/svg?seed=Tulip1&backgroundColor=d1d4f9' },
    { label: 'AyÃ§iÃ§eÄŸi', url: 'https://api.dicebear.com/7.x/thumbs/svg?seed=Sunflower&backgroundColor=ffdfbf' },
    { label: 'Orkide', url: 'https://api.dicebear.com/7.x/thumbs/svg?seed=Orchid1&backgroundColor=c0aede' },
    { label: 'Yonca', url: 'https://api.dicebear.com/7.x/thumbs/svg?seed=Clover1&backgroundColor=b6e3f4' },
    { label: 'KaktÃ¼s', url: 'https://api.dicebear.com/7.x/thumbs/svg?seed=Cactus1&backgroundColor=c0aede' },
    { label: 'AÄŸaÃ§', url: 'https://api.dicebear.com/7.x/thumbs/svg?seed=Tree123&backgroundColor=b6e3f4' },
    { label: 'Yaprak', url: 'https://api.dicebear.com/7.x/thumbs/svg?seed=Leaf123&backgroundColor=c0aede' },
    { label: 'Mantar', url: 'https://api.dicebear.com/7.x/thumbs/svg?seed=Mushroom&backgroundColor=ffd5dc' },
    { label: 'GÃ¶kkuÅŸaÄŸÄ±', url: 'https://api.dicebear.com/7.x/thumbs/svg?seed=Rainbow1&backgroundColor=d1d4f9' },
    { label: 'YÄ±ldÄ±z', url: 'https://api.dicebear.com/7.x/thumbs/svg?seed=Star123&backgroundColor=ffdfbf' },
    { label: 'Ay', url: 'https://api.dicebear.com/7.x/thumbs/svg?seed=Moon123&backgroundColor=d1d4f9' },
    { label: 'GÃ¼neÅŸ', url: 'https://api.dicebear.com/7.x/thumbs/svg?seed=Sun1234&backgroundColor=ffdfbf' },
    { label: 'Bulut', url: 'https://api.dicebear.com/7.x/thumbs/svg?seed=Cloud12&backgroundColor=b6e3f4' },
    // === KAHVE & Ä°Ã‡ECEKLER (15) ===
    { label: 'Espresso', url: 'https://api.dicebear.com/7.x/bottts/svg?seed=Espresso&backgroundColor=6f4e37' },
    { label: 'Latte', url: 'https://api.dicebear.com/7.x/bottts/svg?seed=Latte123&backgroundColor=d2691e' },
    { label: 'Cappuccino', url: 'https://api.dicebear.com/7.x/bottts/svg?seed=Cappuccino&backgroundColor=8b4513' },
    { label: 'Mocha', url: 'https://api.dicebear.com/7.x/bottts/svg?seed=Mocha123&backgroundColor=6f4e37' },
    { label: 'Americano', url: 'https://api.dicebear.com/7.x/bottts/svg?seed=Americano&backgroundColor=3c2415' },
    { label: 'Filtre', url: 'https://api.dicebear.com/7.x/bottts/svg?seed=FilterCoffee&backgroundColor=8b4513' },
    { label: 'Frappe', url: 'https://api.dicebear.com/7.x/bottts/svg?seed=Frappe12&backgroundColor=d2691e' },
    { label: 'Ã‡ay', url: 'https://api.dicebear.com/7.x/bottts/svg?seed=Tea12345&backgroundColor=228b22' },
    { label: 'Smoothie', url: 'https://api.dicebear.com/7.x/bottts/svg?seed=Smoothie&backgroundColor=ff6b6b' },
    { label: 'Milkshake', url: 'https://api.dicebear.com/7.x/bottts/svg?seed=Milkshake&backgroundColor=ffb6c1' },
    { label: 'Limonata', url: 'https://api.dicebear.com/7.x/bottts/svg?seed=Lemonade&backgroundColor=f1c40f' },
    { label: 'Mojito', url: 'https://api.dicebear.com/7.x/bottts/svg?seed=Mojito12&backgroundColor=2ecc71' },
    { label: 'Moonberry', url: 'https://api.dicebear.com/7.x/bottts/svg?seed=Moonberry&backgroundColor=008c95' },
    { label: 'Sunberry', url: 'https://api.dicebear.com/7.x/bottts/svg?seed=Sunberry&backgroundColor=ff8674' },
    { label: 'IceTea', url: 'https://api.dicebear.com/7.x/bottts/svg?seed=IceTea12&backgroundColor=e67e22' },
    // === MEYVELER (15) ===
    { label: 'Elma', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=RedApple&backgroundColor=e74c3c' },
    { label: 'Portakal', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=Orange12&backgroundColor=f39c12' },
    { label: 'Muz', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=Banana12&backgroundColor=f1c40f' },
    { label: 'Ã‡ilek', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=Strawberry&backgroundColor=e74c3c' },
    { label: 'ÃœzÃ¼m', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=Grapes12&backgroundColor=9b59b6' },
    { label: 'Karpuz', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=Watermelon&backgroundColor=27ae60' },
    { label: 'Kiraz', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=Cherry12&backgroundColor=c0392b' },
    { label: 'Åžeftali', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=Peach123&backgroundColor=f39c12' },
    { label: 'Ananas', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=Pineapple&backgroundColor=f1c40f' },
    { label: 'Limon', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=Lemon123&backgroundColor=f1c40f' },
    { label: 'Avokado', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=Avocado1&backgroundColor=27ae60' },
    { label: 'Hindistan', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=Coconut1&backgroundColor=8b4513' },
    { label: 'Mango', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=Mango123&backgroundColor=f39c12' },
    { label: 'Armut', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=Pear1234&backgroundColor=27ae60' },
    { label: 'BÃ¶ÄŸÃ¼rtlen', url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=Blackberry&backgroundColor=9b59b6' },
    // === SEMPATÄ°K YÃœZLER SET 1 (20) - big-smile & big-ears ===
    { label: 'Smile 1', url: 'https://api.dicebear.com/7.x/big-smile/svg?seed=Happy1&backgroundColor=b6e3f4' },
    { label: 'Smile 2', url: 'https://api.dicebear.com/7.x/big-smile/svg?seed=Happy2&backgroundColor=c0aede' },
    { label: 'Smile 3', url: 'https://api.dicebear.com/7.x/big-smile/svg?seed=Happy3&backgroundColor=d1d4f9' },
    { label: 'Smile 4', url: 'https://api.dicebear.com/7.x/big-smile/svg?seed=Happy4&backgroundColor=ffd5dc' },
    { label: 'Smile 5', url: 'https://api.dicebear.com/7.x/big-smile/svg?seed=Happy5&backgroundColor=ffdfbf' },
    { label: 'Smile 6', url: 'https://api.dicebear.com/7.x/big-smile/svg?seed=Joy123&backgroundColor=b6e3f4' },
    { label: 'Smile 7', url: 'https://api.dicebear.com/7.x/big-smile/svg?seed=Joy456&backgroundColor=c0aede' },
    { label: 'Smile 8', url: 'https://api.dicebear.com/7.x/big-smile/svg?seed=Joy789&backgroundColor=d1d4f9' },
    { label: 'Smile 9', url: 'https://api.dicebear.com/7.x/big-smile/svg?seed=Fun123&backgroundColor=ffd5dc' },
    { label: 'Smile 10', url: 'https://api.dicebear.com/7.x/big-smile/svg?seed=Fun456&backgroundColor=ffdfbf' },
    { label: 'Ears 1', url: 'https://api.dicebear.com/7.x/big-ears/svg?seed=Fluffy1&backgroundColor=b6e3f4' },
    { label: 'Ears 2', url: 'https://api.dicebear.com/7.x/big-ears/svg?seed=Snowy12&backgroundColor=c0aede' },
    { label: 'Ears 3', url: 'https://api.dicebear.com/7.x/big-ears/svg?seed=Patches&backgroundColor=d1d4f9' },
    { label: 'Ears 4', url: 'https://api.dicebear.com/7.x/big-ears/svg?seed=Whisker&backgroundColor=ffd5dc' },
    { label: 'Ears 5', url: 'https://api.dicebear.com/7.x/big-ears/svg?seed=Bubbles&backgroundColor=ffdfbf' },
    { label: 'Ears 6', url: 'https://api.dicebear.com/7.x/big-ears/svg?seed=Sparkle&backgroundColor=b6e3f4' },
    { label: 'Ears 7', url: 'https://api.dicebear.com/7.x/big-ears/svg?seed=Cuddles&backgroundColor=c0aede' },
    { label: 'Ears 8', url: 'https://api.dicebear.com/7.x/big-ears/svg?seed=Muffin1&backgroundColor=d1d4f9' },
    { label: 'Ears 9', url: 'https://api.dicebear.com/7.x/big-ears/svg?seed=Cookie1&backgroundColor=ffd5dc' },
    { label: 'Ears 10', url: 'https://api.dicebear.com/7.x/big-ears/svg?seed=Honey12&backgroundColor=ffdfbf' },
    // === SEMPATÄ°K YÃœZLER SET 2 (15) - adventurer & lorelei ===
    { label: 'Adv 1', url: 'https://api.dicebear.com/7.x/adventurer/svg?seed=Storm12&backgroundColor=b6e3f4' },
    { label: 'Adv 2', url: 'https://api.dicebear.com/7.x/adventurer/svg?seed=Shadow1&backgroundColor=c0aede' },
    { label: 'Adv 3', url: 'https://api.dicebear.com/7.x/adventurer/svg?seed=Blaze12&backgroundColor=d1d4f9' },
    { label: 'Adv 4', url: 'https://api.dicebear.com/7.x/adventurer/svg?seed=Frost12&backgroundColor=ffd5dc' },
    { label: 'Adv 5', url: 'https://api.dicebear.com/7.x/adventurer/svg?seed=Thunder&backgroundColor=ffdfbf' },
    { label: 'Adv 6', url: 'https://api.dicebear.com/7.x/adventurer/svg?seed=River12&backgroundColor=b6e3f4' },
    { label: 'Adv 7', url: 'https://api.dicebear.com/7.x/adventurer/svg?seed=Phoenix&backgroundColor=c0aede' },
    { label: 'Adv 8', url: 'https://api.dicebear.com/7.x/adventurer/svg?seed=Crystal&backgroundColor=d1d4f9' },
    { label: 'Lor 1', url: 'https://api.dicebear.com/7.x/lorelei/svg?seed=Alice12&backgroundColor=b6e3f4' },
    { label: 'Lor 2', url: 'https://api.dicebear.com/7.x/lorelei/svg?seed=Bob1234&backgroundColor=c0aede' },
    { label: 'Lor 3', url: 'https://api.dicebear.com/7.x/lorelei/svg?seed=Carol12&backgroundColor=d1d4f9' },
    { label: 'Lor 4', url: 'https://api.dicebear.com/7.x/lorelei/svg?seed=David12&backgroundColor=ffd5dc' },
    { label: 'Lor 5', url: 'https://api.dicebear.com/7.x/lorelei/svg?seed=Eva1234&backgroundColor=ffdfbf' },
    { label: 'Lor 6', url: 'https://api.dicebear.com/7.x/lorelei/svg?seed=Frank12&backgroundColor=b6e3f4' },
    { label: 'Lor 7', url: 'https://api.dicebear.com/7.x/lorelei/svg?seed=Grace12&backgroundColor=c0aede' }
];

// Avatar seÃ§me fonksiyonu
async function selectAvatar(avatarIndex, docId) {
    try {
        const avatar = AVATAR_OPTIONS[avatarIndex];
        if (!avatar || !avatar.url) return;
        
        toast('Avatar kaydediliyor...', 'info');
        
        // DiceBear URL'sini doÄŸrudan kaydet
        const avatarUrl = avatar.url;
        
        // Firebase'e kaydet
        await db.collection('personel').doc(docId).update({
            photoUrl: avatarUrl,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // UI gÃ¼ncelle
        const preview = document.getElementById('profilePhotoPreview');
        if (preview) {
            preview.innerHTML = `<img src="${avatarUrl}" style="width:100%;height:100%;object-fit:cover">`;
        }
        
        // Sidebar avatar gÃ¼ncelle
        const sidebarAvatar = document.getElementById('userAvatar');
        if (sidebarAvatar && currentUser?.personelId === docId) {
            sidebarAvatar.innerHTML = `<img src="${avatarUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
        }
        
        // Modal'Ä± kapat
        closeAvatarModal();
        
        toast('Avatar gÃ¼ncellendi!', 'success');
        
    } catch (error) {
        console.error('Avatar kaydetme hatasÄ±:', error);
        toast('Avatar kaydedilemedi: ' + error.message, 'error');
    }
}

// Avatar modal aÃ§
function openAvatarModal(docId) {
    const modal = document.createElement('div');
    modal.id = 'avatarModal';
    modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:10000;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px)';
    modal.onclick = (e) => { if (e.target === modal) closeAvatarModal(); };
    
    // Kategorilere ayÄ±r (toplam 100 avatar)
    const hayvanlar = AVATAR_OPTIONS.slice(0, 20);      // 0-19
    const cicekler = AVATAR_OPTIONS.slice(20, 35);      // 20-34
    const kahveler = AVATAR_OPTIONS.slice(35, 50);      // 35-49
    const meyveler = AVATAR_OPTIONS.slice(50, 65);      // 50-64
    const yuzler1 = AVATAR_OPTIONS.slice(65, 85);       // 65-84
    const yuzler2 = AVATAR_OPTIONS.slice(85, 100);      // 85-99
    
    modal.innerHTML = `
        <style>
            .avatar-grid-8 { display:grid; grid-template-columns:repeat(8,1fr); gap:8px; }
            .avatar-item-big { aspect-ratio:1; border-radius:12px; cursor:pointer; transition:all .15s; border:3px solid transparent; overflow:hidden; background:var(--bg3); min-width:52px; }
            .avatar-item-big:hover { border-color:var(--accent); transform:scale(1.1); box-shadow:0 4px 12px rgba(0,0,0,.2); }
            .avatar-item-big img { width:100%; height:100%; object-fit:cover; }
            @media (max-width:480px) { .avatar-grid-8 { grid-template-columns:repeat(5,1fr); gap:6px; } }
        </style>
        <div style="background:var(--cardBg);border-radius:16px;padding:16px;max-width:480px;width:95%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;position:sticky;top:-16px;background:var(--cardBg);padding:16px 0 8px;margin:-16px -16px 12px;padding-left:16px;padding-right:16px;z-index:1">
                <h3 style="margin:0;color:var(--tx);font-size:1rem">Profil Resmi SeÃ§</h3>
                <button onclick="closeAvatarModal()" style="background:var(--bg3);border:none;cursor:pointer;padding:8px;border-radius:8px">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--tx3)" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            
            <div style="background:var(--bg3);border:2px dashed var(--bg4);border-radius:12px;padding:16px;text-align:center;margin-bottom:16px;cursor:pointer;transition:all .2s" onclick="document.getElementById('avatarFileInput').click()" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--bg4)'">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--tx3)" stroke-width="1.5" style="margin-bottom:4px"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>
                <div style="font-size:.85rem;color:var(--tx2)">Kendi FotoÄŸrafÄ±nÄ± YÃ¼kle</div>
                <input type="file" id="avatarFileInput" accept="image/jpeg,image/png,image/webp" style="display:none" onchange="handleProfilePhotoUpload(this, '${docId}');closeAvatarModal();">
            </div>
            
            <div style="font-size:.75rem;color:var(--accent);font-weight:600;margin:12px 0 8px">ðŸ¾ Sevimli Hayvanlar</div>
            <div class="avatar-grid-8" style="margin-bottom:16px">${hayvanlar.map((a, i) => `<div class="avatar-item-big" onclick="selectAvatar(${i}, '${docId}')" title="${a.label}"><img src="${a.url}" loading="lazy"></div>`).join('')}</div>
            
            <div style="font-size:.75rem;color:var(--accent);font-weight:600;margin:12px 0 8px">ðŸŒ¸ Ã‡iÃ§ekler & DoÄŸa</div>
            <div class="avatar-grid-8" style="margin-bottom:16px">${cicekler.map((a, i) => `<div class="avatar-item-big" onclick="selectAvatar(${i + 20}, '${docId}')" title="${a.label}"><img src="${a.url}" loading="lazy"></div>`).join('')}</div>
            
            <div style="font-size:.75rem;color:var(--accent);font-weight:600;margin:12px 0 8px">â˜• Kahve & Ä°Ã§ecekler</div>
            <div class="avatar-grid-8" style="margin-bottom:16px">${kahveler.map((a, i) => `<div class="avatar-item-big" onclick="selectAvatar(${i + 35}, '${docId}')" title="${a.label}"><img src="${a.url}" loading="lazy"></div>`).join('')}</div>
            
            <div style="font-size:.75rem;color:var(--accent);font-weight:600;margin:12px 0 8px">ðŸŽ Meyveler</div>
            <div class="avatar-grid-8" style="margin-bottom:16px">${meyveler.map((a, i) => `<div class="avatar-item-big" onclick="selectAvatar(${i + 50}, '${docId}')" title="${a.label}"><img src="${a.url}" loading="lazy"></div>`).join('')}</div>
            
            <div style="font-size:.75rem;color:var(--accent);font-weight:600;margin:12px 0 8px">ðŸ˜Š Sempatik YÃ¼zler</div>
            <div class="avatar-grid-8" style="margin-bottom:16px">${yuzler1.map((a, i) => `<div class="avatar-item-big" onclick="selectAvatar(${i + 65}, '${docId}')" title="${a.label}"><img src="${a.url}" loading="lazy"></div>`).join('')}</div>
            
            <div style="font-size:.75rem;color:var(--accent);font-weight:600;margin:12px 0 8px">ðŸŽ¨ Ã‡izim Karakterleri</div>
            <div class="avatar-grid-8">${yuzler2.map((a, i) => `<div class="avatar-item-big" onclick="selectAvatar(${i + 85}, '${docId}')" title="${a.label}"><img src="${a.url}" loading="lazy"></div>`).join('')}</div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Avatar modal kapat
function closeAvatarModal() {
    const modal = document.getElementById('avatarModal');
    if (modal) modal.remove();
}

// Profil fotoÄŸrafÄ± yÃ¼kleme
async function handleProfilePhotoUpload(input, docId) {
    const file = input.files[0];
    if (!file) return;
    
    // Sadece format kontrolÃ¼
    if (!file.type.match(/^image\/(jpeg|png|webp)$/)) {
        toast('Sadece JPG, PNG veya WebP formatÄ± desteklenir', 'error');
        return;
    }
    
    try {
        toast('FotoÄŸraf iÅŸleniyor...', 'info');
        
        // Resmi otomatik kÃ¼Ã§Ã¼lt ve sÄ±kÄ±ÅŸtÄ±r (max 300KB hedefle)
        const resizedBase64 = await resizeAndCompressImage(file, 400, 400, 0.7);
        
        // Base64 boyutunu kontrol et, hala bÃ¼yÃ¼kse daha fazla sÄ±kÄ±ÅŸtÄ±r
        let finalBase64 = resizedBase64;
        const maxBase64Size = 300 * 1024; // 300KB (Firestore iÃ§in gÃ¼venli)
        
        if (finalBase64.length > maxBase64Size) {
            // Daha agresif sÄ±kÄ±ÅŸtÄ±rma
            finalBase64 = await resizeAndCompressImage(file, 300, 300, 0.5);
        }
        
        if (finalBase64.length > maxBase64Size) {
            // En son Ã§are - Ã§ok kÃ¼Ã§Ã¼k
            finalBase64 = await resizeAndCompressImage(file, 200, 200, 0.4);
        }
        
        // Firestore'a kaydet
        await db.collection('personel').doc(docId).update({
            photoUrl: finalBase64,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Preview'u gÃ¼ncelle
        const preview = document.getElementById('profilePhotoPreview');
        if (preview) {
            preview.innerHTML = `<img src="${finalBase64}" style="width:100%;height:100%;object-fit:cover">`;
        }
        
        // Sidebar avatar'Ä± gÃ¼ncelle
        const sidebarAvatar = document.getElementById('userAvatar');
        if (sidebarAvatar) {
            sidebarAvatar.innerHTML = `<img src="${finalBase64}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
        }
        
        // Ekip durumu kartlarÄ±ndaki avatarlarÄ± gÃ¼ncelle (email ile eÅŸleÅŸtir)
        if (currentUser?.email) {
            document.querySelectorAll('.team-member-avatar, .shift-avatar, [data-email="' + currentUser.email + '"]').forEach(avatar => {
                if (avatar.dataset?.email === currentUser.email || avatar.closest('[data-email="' + currentUser.email + '"]')) {
                    avatar.innerHTML = `<img src="${finalBase64}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
                }
            });
            
            // Personel cache'ini gÃ¼ncelle
            if (_personelDisplayCache && _personelDisplayCache.has(currentUser.email)) {
                const cached = _personelDisplayCache.get(currentUser.email);
                if (cached) cached.photoUrl = finalBase64;
            }
        }
        
        // Dashboard'Ä± yenile (ekip durumu gÃ¼ncellensin)
        if (typeof loadDashboardData === 'function') {
            loadDashboardData();
        }
        
        toast('FotoÄŸraf gÃ¼ncellendi', 'success');
        
    } catch (error) {
        console.error('FotoÄŸraf yÃ¼kleme hatasÄ±:', error);
        toast('FotoÄŸraf yÃ¼klenemedi: ' + error.message, 'error');
    }
}

// Resmi kÃ¼Ã§Ã¼lt ve sÄ±kÄ±ÅŸtÄ±r
function resizeAndCompressImage(file, maxWidth, maxHeight, quality) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                
                // OranÄ± koru
                if (width > height) {
                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }
                } else {
                    if (height > maxHeight) {
                        width *= maxHeight / height;
                        height = maxHeight;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                // JPEG olarak sÄ±kÄ±ÅŸtÄ±r
                const base64 = canvas.toDataURL('image/jpeg', quality);
                resolve(base64);
            };
            img.onerror = reject;
            img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

// Profil bilgilerini kaydet
async function saveMyProfile(docId) {
    const rawPhone = document.getElementById('myProfile_phone')?.value?.trim() || '';
    const address = document.getElementById('myProfile_address')?.value?.trim() || '';
    const bankName = document.getElementById('myProfile_bankName')?.value?.trim() || '';
    const iban = document.getElementById('myProfile_iban')?.value?.trim() || '';
    
    // Telefon formatÄ±: +90 XXX XXX XX XX
    const phone = formatPhoneNumber(rawPhone);
    
    // Address ve bankName Latin harflere Ã§evrilir (uniqueId iÃ§in deÄŸil, tutarlÄ±lÄ±k iÃ§in)
    const addressLatin = address; // Adres olduÄŸu gibi kalabilir
    
    try {
        await db.collection('personel').doc(docId).update({
            phone,
            address,
            bankName,
            iban,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Input'u formatlanmÄ±ÅŸ haliyle gÃ¼ncelle
        if (phone && document.getElementById('myProfile_phone')) {
            document.getElementById('myProfile_phone').value = phone;
        }
        
        toast('Bilgileriniz gÃ¼ncellendi', 'success');
    } catch (error) {
        console.error('Profil kaydetme hatasÄ±:', error);
        toast('Kaydetme hatasÄ±: ' + error.message, 'error');
    }
}

// Telefon numarasÄ± formatÄ±: +90 XXX XXX XX XX
function formatPhoneNumber(phone) {
    if (!phone) return '';
    
    // Sadece rakamlarÄ± al
    let digits = phone.replace(/\D/g, '');
    
    // BaÅŸÄ±ndaki 0'Ä± kaldÄ±r (varsa)
    if (digits.startsWith('0')) {
        digits = digits.substring(1);
    }
    
    // BaÅŸÄ±ndaki 90'Ä± kaldÄ±r (varsa)
    if (digits.startsWith('90') && digits.length > 10) {
        digits = digits.substring(2);
    }
    
    // 10 rakam olmalÄ± (5XX XXX XX XX)
    if (digits.length !== 10) {
        // Format yapÄ±lamadÄ±, olduÄŸu gibi dÃ¶ndÃ¼r
        return phone;
    }
    
    // Format: +90 XXX XXX XX XX
    return `+90 ${digits.substring(0, 3)} ${digits.substring(3, 6)} ${digits.substring(6, 8)} ${digits.substring(8, 10)}`;
}

// TR Banka Listesi (en Ã§ok kullanÄ±lanlar Ã¶nde)
const TR_BANKS = [
    'Ziraat BankasÄ±',
    'VakÄ±fbank',
    'Halkbank',
    'Ä°ÅŸ BankasÄ±',
    'Garanti BBVA',
    'YapÄ± Kredi',
    'Akbank',
    'QNB Finansbank',
    'Denizbank',
    'TEB',
    'ING',
    'HSBC',
    'Åžekerbank',
    'Enpara',
    'Papara',
    'Kuveyt TÃ¼rk',
    'TÃ¼rkiye Finans',
    'Albaraka TÃ¼rk',
    'Ziraat KatÄ±lÄ±m',
    'VakÄ±f KatÄ±lÄ±m',
    'Emlak KatÄ±lÄ±m',
    'ICBC Turkey',
    'Odeabank',
    'Anadolubank',
    'Fibabanka',
    'Alternatifbank',
    'Burgan Bank',
    'Citibank',
    'Turkish Bank',
    'Pasha Bank'
];

// Banka dropdown gÃ¶ster
function showBankDropdown() {
    const dropdown = document.getElementById('bankDropdown');
    if (!dropdown) return;
    
    renderBankOptions(TR_BANKS);
    dropdown.style.display = 'block';
    
    // DÄ±ÅŸarÄ± tÄ±klanÄ±nca kapat
    setTimeout(() => {
        document.addEventListener('click', closeBankDropdownOnClickOutside);
    }, 10);
}

function closeBankDropdownOnClickOutside(e) {
    const dropdown = document.getElementById('bankDropdown');
    const input = document.getElementById('myProfile_bankName');
    
    if (dropdown && input && !dropdown.contains(e.target) && e.target !== input) {
        dropdown.style.display = 'none';
        document.removeEventListener('click', closeBankDropdownOnClickOutside);
    }
}

// Banka seÃ§eneklerini filtrele
function filterBanks(query) {
    const dropdown = document.getElementById('bankDropdown');
    if (!dropdown) return;
    
    const q = query.toLowerCase();
    const filtered = TR_BANKS.filter(bank => 
        bank.toLowerCase().includes(q) || 
        normalizeTurkishChars(bank.toLowerCase()).includes(normalizeTurkishChars(q))
    );
    
    renderBankOptions(filtered);
    dropdown.style.display = 'block';
}

// Banka seÃ§eneklerini render et
function renderBankOptions(banks) {
    const dropdown = document.getElementById('bankDropdown');
    if (!dropdown) return;
    
    if (banks.length === 0) {
        dropdown.innerHTML = '<div style="padding:12px;color:var(--tx3);text-align:center;font-size:.85rem">SonuÃ§ bulunamadÄ±</div>';
        return;
    }
    
    dropdown.innerHTML = banks.map(bank => `
        <div onclick="selectBank('${bank}')" style="padding:10px 14px;cursor:pointer;font-size:.9rem;transition:background .1s;border-bottom:1px solid var(--bg3);background:var(--bg)" onmouseover="this.style.background='var(--bg3)'" onmouseout="this.style.background='var(--bg)'">
            ${bank}
        </div>
    `).join('');
}

// Banka seÃ§
function selectBank(bankName) {
    const input = document.getElementById('myProfile_bankName');
    const dropdown = document.getElementById('bankDropdown');
    
    if (input) input.value = bankName;
    if (dropdown) dropdown.style.display = 'none';
    
    document.removeEventListener('click', closeBankDropdownOnClickOutside);
}

// IBAN kopyalama
function copyIban() {
    const ibanInput = document.getElementById('myProfile_iban');
    if (!ibanInput || !ibanInput.value) {
        toast('Kopyalanacak IBAN yok', 'error');
        return;
    }
    
    navigator.clipboard.writeText(ibanInput.value).then(() => {
        toast('IBAN kopyalandÄ±!', 'success');
    }).catch(err => {
        // Fallback
        ibanInput.select();
        document.execCommand('copy');
        toast('IBAN kopyalandÄ±!', 'success');
    });
}

// Personel modal IBAN kopyala
function copyPersonelIban() {
    const ibanInput = document.getElementById('personelIBAN');
    if (!ibanInput || !ibanInput.value) {
        toast('Kopyalanacak IBAN yok', 'error');
        return;
    }
    
    navigator.clipboard.writeText(ibanInput.value).then(() => {
        toast('IBAN kopyalandÄ±!', 'success');
    }).catch(err => {
        // Fallback
        const textarea = document.createElement('textarea');
        textarea.value = ibanInput.value;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        toast('IBAN kopyalandÄ±!', 'success');
    });
}

// ========== PERSONEL MODAL Ä°Ã‡Ä°N BANKA DROPDOWN ==========
function showPersonelBankDropdown() {
    const dropdown = document.getElementById('personelBankDropdown');
    if (!dropdown) return;
    
    renderPersonelBankOptions(TR_BANKS);
    dropdown.style.display = 'block';
    
    setTimeout(() => {
        document.addEventListener('click', closePersonelBankDropdownOnClickOutside);
    }, 10);
}

function closePersonelBankDropdownOnClickOutside(e) {
    const dropdown = document.getElementById('personelBankDropdown');
    const input = document.getElementById('personelBankName');
    
    if (dropdown && input && !dropdown.contains(e.target) && e.target !== input) {
        dropdown.style.display = 'none';
        document.removeEventListener('click', closePersonelBankDropdownOnClickOutside);
    }
}

function filterPersonelBanks(query) {
    const dropdown = document.getElementById('personelBankDropdown');
    if (!dropdown) return;
    
    const q = query.toLowerCase();
    const filtered = TR_BANKS.filter(bank => 
        bank.toLowerCase().includes(q) || 
        normalizeTurkishChars(bank.toLowerCase()).includes(normalizeTurkishChars(q))
    );
    
    renderPersonelBankOptions(filtered);
    dropdown.style.display = 'block';
}

function renderPersonelBankOptions(banks) {
    const dropdown = document.getElementById('personelBankDropdown');
    if (!dropdown) return;
    
    if (banks.length === 0) {
        dropdown.innerHTML = '<div style="padding:12px;color:var(--tx3);text-align:center;font-size:.85rem">SonuÃ§ bulunamadÄ±</div>';
        return;
    }
    
    dropdown.innerHTML = banks.map(bank => `
        <div onclick="selectPersonelBank('${bank}')" style="padding:10px 14px;cursor:pointer;font-size:.9rem;transition:background .1s;border-bottom:1px solid var(--bg3);background:var(--bg)" onmouseover="this.style.background='var(--bg3)'" onmouseout="this.style.background='var(--bg)'">
            ${bank}
        </div>
    `).join('');
}

function selectPersonelBank(bankName) {
    const input = document.getElementById('personelBankName');
    const dropdown = document.getElementById('personelBankDropdown');
    
    if (input) input.value = bankName;
    if (dropdown) dropdown.style.display = 'none';
    
    document.removeEventListener('click', closePersonelBankDropdownOnClickOutside);
}

// ========== TELEFON VE IBAN FORMAT FONKSÄ°YONLARI ==========
function formatPhoneInput(input) {
    let value = input.value.replace(/\D/g, '');
    
    // BaÅŸÄ±ndaki 0 veya 90'Ä± kaldÄ±r
    if (value.startsWith('0')) value = value.substring(1);
    if (value.startsWith('90') && value.length > 10) value = value.substring(2);
    
    // Max 10 rakam
    value = value.substring(0, 10);
    
    // Format: +90 5XX XXX XX XX
    let formatted = '';
    if (value.length > 0) {
        formatted = '+90 ' + value.substring(0, 3);
    }
    if (value.length > 3) {
        formatted += ' ' + value.substring(3, 6);
    }
    if (value.length > 6) {
        formatted += ' ' + value.substring(6, 8);
    }
    if (value.length > 8) {
        formatted += ' ' + value.substring(8, 10);
    }
    
    input.value = formatted;
}

function formatIbanInput(input) {
    let value = input.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    
    // TR ile baÅŸlamalÄ±
    if (!value.startsWith('TR') && value.length > 0) {
        if (value.match(/^[0-9]/)) {
            value = 'TR' + value;
        }
    }
    
    // Max 26 karakter (TR + 24 rakam)
    value = value.substring(0, 26);
    
    // Format: TRXX XXXX XXXX XXXX XXXX XXXX XX
    let formatted = '';
    for (let i = 0; i < value.length; i++) {
        if (i > 0 && i % 4 === 0) formatted += ' ';
        formatted += value[i];
    }
    
    input.value = formatted;
}

// Kendi ÅŸifremi deÄŸiÅŸtir (Credentials tabanlÄ±)
async function changeMyPassword(docId) {
    const currentPassword = document.getElementById('myProfile_currentPassword')?.value || '';
    const newPassword = document.getElementById('myProfile_newPassword')?.value || '';
    const confirmPassword = document.getElementById('myProfile_confirmPassword')?.value || '';
    
    // 1. Mevcut ÅŸifre kontrolÃ¼
    if (!currentPassword) {
        toast('Mevcut ÅŸifrenizi girin', 'error');
        return;
    }
    
    // 2. Yeni ÅŸifre validasyonu
    const passwordValidation = validatePassword(newPassword);
    if (!passwordValidation.valid) {
        toast(passwordValidation.message, 'error');
        return;
    }
    
    // 3. Åžifre tekrar kontrolÃ¼
    if (newPassword !== confirmPassword) {
        toast('Yeni ÅŸifreler eÅŸleÅŸmiyor', 'error');
        return;
    }
    
    try {
        // 4. Mevcut ÅŸifreyi credentials'dan kontrol et
        const email = currentUser?.email;
        if (!email) {
            toast('Oturum bilgisi bulunamadÄ±', 'error');
            return;
        }
        
        const emailDocId = email.toLowerCase().replace(/[@.]/g, '_');
        const credDoc = await db.collection('credentials').doc(emailDocId).get();
        
        if (!credDoc.exists) {
            toast('Åžifre kaydÄ± bulunamadÄ±', 'error');
            return;
        }
        
        const storedPassword = decodePassword(credDoc.data());
        
        if (storedPassword !== currentPassword) {
            toast('Mevcut ÅŸifre yanlÄ±ÅŸ', 'error');
            return;
        }
        
        // 5. Yeni ÅŸifreyi kaydet
        await saveCredential(email, newPassword, docId);
        
        // 6. Personel dokÃ¼manÄ±nÄ± gÃ¼ncelle
        await db.collection('personel').doc(docId).update({
            hasPassword: true,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        toast('Åžifreniz baÅŸarÄ±yla deÄŸiÅŸtirildi', 'success');
        
        // AlanlarÄ± temizle
        document.getElementById('myProfile_currentPassword').value = '';
        document.getElementById('myProfile_newPassword').value = '';
        document.getElementById('myProfile_confirmPassword').value = '';
        
    } catch (error) {
        console.error('Åžifre deÄŸiÅŸtirme hatasÄ±:', error);
        toast('Åžifre deÄŸiÅŸtirme hatasÄ±: ' + error.message, 'error');
    }
}

// Admin ÅŸifre deÄŸiÅŸtirme
async function changeAdminPassword() {
    const currentPassword = document.getElementById('adminCurrentPassword')?.value || '';
    const newPassword = document.getElementById('adminNewPassword')?.value || '';
    const confirmPassword = document.getElementById('adminConfirmPassword')?.value || '';
    
    // 1. Mevcut ÅŸifre kontrolÃ¼
    if (!currentPassword) {
        toast('Mevcut ÅŸifrenizi girin', 'error');
        return;
    }
    
    // 2. Yeni ÅŸifre validasyonu
    const passwordValidation = validatePassword(newPassword);
    if (!passwordValidation.valid) {
        toast(passwordValidation.message, 'error');
        return;
    }
    
    // 3. Åžifre tekrar kontrolÃ¼
    if (newPassword !== confirmPassword) {
        toast('Yeni ÅŸifreler eÅŸleÅŸmiyor', 'error');
        return;
    }
    
    try {
        // 4. Mevcut ÅŸifreyi credentials'dan kontrol et
        const email = currentUser?.email;
        if (!email) {
            toast('Oturum bilgisi bulunamadÄ±', 'error');
            return;
        }
        
        const emailDocId = email.toLowerCase().replace(/[@.]/g, '_');
        const credDoc = await db.collection('credentials').doc(emailDocId).get();
        
        if (!credDoc.exists) {
            toast('Åžifre kaydÄ± bulunamadÄ±', 'error');
            return;
        }
        
        const storedPassword = decodePassword(credDoc.data());
        
        if (storedPassword !== currentPassword) {
            toast('Mevcut ÅŸifre yanlÄ±ÅŸ', 'error');
            return;
        }
        
        // 5. Yeni ÅŸifreyi kaydet
        await saveCredential(email, newPassword, null);
        
        toast('Åžifreniz baÅŸarÄ±yla deÄŸiÅŸtirildi', 'success');
        
        // AlanlarÄ± temizle
        document.getElementById('adminCurrentPassword').value = '';
        document.getElementById('adminNewPassword').value = '';
        document.getElementById('adminConfirmPassword').value = '';
        
    } catch (error) {
        console.error('Admin ÅŸifre deÄŸiÅŸtirme hatasÄ±:', error);
        toast('Åžifre deÄŸiÅŸtirme hatasÄ±: ' + error.message, 'error');
    }
}

// Åžifre validasyonu - en az 8 karakter, bÃ¼yÃ¼k harf, kÃ¼Ã§Ã¼k harf, rakam, Ã¶zel karakter
function validatePassword(password) {
    const errors = [];
    
    if (!password || password.length < 8) {
        errors.push('En az 8 karakter');
    }
    
    if (!/[a-z]/.test(password)) {
        errors.push('KÃ¼Ã§Ã¼k harf');
    }
    
    if (!/[A-Z]/.test(password)) {
        errors.push('BÃ¼yÃ¼k harf');
    }
    
    if (!/[0-9]/.test(password)) {
        errors.push('Rakam');
    }
    
    if (!/[!@#$%^&*(),.?":{}|<>_\-+=\[\]\\\/~`]/.test(password)) {
        errors.push('Ã–zel karakter (!@#$...)');
    }
    
    if (errors.length > 0) {
        return { valid: false, message: 'Åžifre eksik: ' + errors.join(', ') };
    }
    
    return { valid: true, message: '' };
}

// Åžifre gÃ¶ster/gizle toggle
function togglePasswordVisibility(inputId, btn) {
    const input = document.getElementById(inputId);
    if (!input) return;
    
    if (input.type === 'password') {
        input.type = 'text';
        btn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>`;
    } else {
        input.type = 'password';
        btn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>`;
    }
}

function renderAdminLists() {
    // Bu sekmeler SADECE YÃ–NETÄ°CÄ° tarafÄ±ndan gÃ¶rÃ¼lecek
    const adminOnlyTabs = ['tab-kullanicilar', 'tab-oturumlar', 'tab-aktiviteler'];
    const adminOnlySections = ['admin-kullanicilar', 'admin-oturumlar'];
    
    if (currentUser?.role === 'yonetici') {
        // YÃ¶netici iÃ§in gÃ¶ster (class kaldÄ±r)
        adminOnlyTabs.forEach(tabId => {
            const tab = document.getElementById(tabId);
            if (tab) tab.classList.remove('tab-hidden');
        });
        adminOnlySections.forEach(sectionId => {
            const section = document.getElementById(sectionId);
            if (section) section.style.display = '';
        });
    } else {
        // YÃ¶netici HARÄ°Ã‡ herkes iÃ§in gizle (class ekle)
        adminOnlyTabs.forEach(tabId => {
            const tab = document.getElementById(tabId);
            if (tab) tab.classList.add('tab-hidden');
        });
        adminOnlySections.forEach(sectionId => {
            const section = document.getElementById(sectionId);
            if (section) section.style.display = 'none';
        });
    }
    
    // YÃ¶netici iÃ§in Ã¶zel kartlarÄ± gÃ¶ster
    const adminPasswordCard = document.getElementById('adminPasswordCard');
    const adminEmailsCard = document.getElementById('adminEmailsCard');
    const dataCleanupCard = document.getElementById('dataCleanupCard');
    const rolePreviewCard = document.getElementById('rolePreviewCard');
    if (currentUser?.role === 'yonetici') {
        if (adminPasswordCard) adminPasswordCard.style.display = 'block';
        if (adminEmailsCard) {
            adminEmailsCard.style.display = 'block';
            loadAdminEmailsToUI(); // Listeyi yÃ¼kle
        }
        if (dataCleanupCard) dataCleanupCard.style.display = 'block';
        if (rolePreviewCard) rolePreviewCard.style.display = 'block';
    }
    
    // Branches - yetki kontrolÃ¼ ile
    const branchList = document.getElementById('branchList');
    if (branchList) {
        const isYonetici = currentUser?.role === 'yonetici';
        const perms = window.userAdvancedPermissions;
        const canManageBranches = isYonetici || perms?.special?.manage_branches;
        
        branchList.innerHTML = STATE.branches.map((b, i) => `
            <div class="admin-list-item">
                <div class="admin-list-item-text">${b}</div>
                ${canManageBranches ? `
                <div class="admin-list-item-actions">
                    <button class="admin-btn-icon admin-btn-edit" onclick="editBranch(${i})">âœï¸</button>
                    <button class="admin-btn-icon admin-btn-delete" onclick="deleteBranch(${i})">ðŸ—‘ï¸</button>
                </div>
                ` : ''}
            </div>
        `).join('');
    }
    
    // Positions
    const posList = document.getElementById('positionList');
    if (posList) {
        posList.innerHTML = STATE.positions.map((p, i) => `
            <div class="admin-list-item">
                <div class="admin-list-item-text">${p.name} <span style="color:var(--txdark2);font-size:.8rem">(${p.type})</span></div>
                <div class="admin-list-item-actions">
                    <button class="admin-btn-icon admin-btn-edit" onclick="editPosition(${i})">âœï¸</button>
                    <button class="admin-btn-icon admin-btn-delete" onclick="deletePosition(${i})">ðŸ—‘ï¸</button>
                </div>
            </div>
        `).join('');
    }
    
    // Violations
    const violList = document.getElementById('violationAdminList');
    if (violList) {
        violList.innerHTML = STATE.violations.map((v, i) => `
            <div class="admin-list-item">
                <div class="admin-list-item-text">${v.id}: ${v.title} <span class="violation-badge ${v.risk}" style="margin-left:8px">${v.risk}</span></div>
                <div class="admin-list-item-actions">
                    <button class="admin-btn-icon admin-btn-edit" onclick="editViolation(${i})">âœï¸</button>
                    <button class="admin-btn-icon admin-btn-delete" onclick="deleteViolation(${i})">ðŸ—‘ï¸</button>
                </div>
            </div>
        `).join('');
    }
}

// Duplicate personel temizleme
async function cleanDuplicatePersonel() {
    const resultsDiv = document.getElementById('cleanupResults');
    resultsDiv.style.display = 'block';
    resultsDiv.innerHTML = '<p style="color:var(--tx2)">â³ TaranÄ±yor...</p>';
    
    try {
        const snapshot = await db.collection('personel').get();
        const personelMap = {};
        const toDelete = [];
        
        snapshot.forEach(doc => {
            const d = doc.data();
            const key = `${d.name}-${d.branch}`;
            if (personelMap[key]) {
                // Bu bir duplicate
                toDelete.push({ id: doc.id, name: d.name, branch: d.branch });
            } else {
                personelMap[key] = doc.id;
            }
        });
        
        if (toDelete.length === 0) {
            resultsDiv.innerHTML = '<p style="color:var(--green)">âœ… Duplicate personel bulunamadÄ±.</p>';
            return;
        }
        
        // Silme iÅŸlemi iÃ§in onay
        resultsDiv.innerHTML = `
            <p style="color:var(--yellow);margin-bottom:12px">âš ï¸ ${toDelete.length} duplicate personel bulundu:</p>
            <ul style="font-size:.85rem;margin-bottom:12px;padding-left:20px">
                ${toDelete.slice(0, 10).map(p => `<li>${p.name} (${p.branch})</li>`).join('')}
                ${toDelete.length > 10 ? `<li>...ve ${toDelete.length - 10} daha</li>` : ''}
            </ul>
            <button class="btn btn-primary btn-sm" onclick="confirmDeleteDuplicates('${JSON.stringify(toDelete.map(p => p.id)).replace(/"/g, '&quot;')}')">Sil (${toDelete.length} kayÄ±t)</button>
            <button class="btn btn-ghost btn-sm" onclick="document.getElementById('cleanupResults').style.display='none'">Ä°ptal</button>
        `;
    } catch (e) {
        resultsDiv.innerHTML = `<p style="color:var(--red)">âŒ Hata: ${e.message}</p>`;
    }
}

async function confirmDeleteDuplicates(idsJson) {
    const ids = JSON.parse(idsJson.replace(/&quot;/g, '"'));
    const resultsDiv = document.getElementById('cleanupResults');
    resultsDiv.innerHTML = '<p style="color:var(--tx2)">â³ Siliniyor...</p>';
    
    try {
        const batch = db.batch();
        ids.forEach(id => {
            batch.delete(db.collection('personel').doc(id));
        });
        await batch.commit();
        resultsDiv.innerHTML = `<p style="color:var(--green)">âœ… ${ids.length} duplicate personel silindi.</p>`;
        toast(`${ids.length} duplicate personel silindi`, 'success');
    } catch (e) {
        resultsDiv.innerHTML = `<p style="color:var(--red)">âŒ Hata: ${e.message}</p>`;
    }
}

// Duplicate shift temizleme
async function cleanDuplicateShifts() {
    const resultsDiv = document.getElementById('cleanupResults');
    resultsDiv.style.display = 'block';
    resultsDiv.innerHTML = '<p style="color:var(--tx2)">â³ TaranÄ±yor...</p>';
    
    try {
        const snapshot = await db.collection('shifts').get();
        const shiftMap = {};
        const toDelete = [];
        
        snapshot.forEach(doc => {
            const d = doc.data();
            const key = `${d.branch}-${d.weekStart}`;
            if (shiftMap[key]) {
                // Bu bir duplicate - daha eski olanÄ± sil
                toDelete.push({ id: doc.id, branch: d.branch, weekStart: d.weekStart });
            } else {
                shiftMap[key] = doc.id;
            }
        });
        
        if (toDelete.length === 0) {
            resultsDiv.innerHTML = '<p style="color:var(--green)">âœ… Duplicate shift bulunamadÄ±.</p>';
            return;
        }
        
        resultsDiv.innerHTML = `
            <p style="color:var(--yellow);margin-bottom:12px">âš ï¸ ${toDelete.length} duplicate shift bulundu.</p>
            <button class="btn btn-primary btn-sm" onclick="confirmDeleteDuplicateShifts('${JSON.stringify(toDelete.map(p => p.id)).replace(/"/g, '&quot;')}')">Sil (${toDelete.length} kayÄ±t)</button>
            <button class="btn btn-ghost btn-sm" onclick="document.getElementById('cleanupResults').style.display='none'">Ä°ptal</button>
        `;
    } catch (e) {
        resultsDiv.innerHTML = `<p style="color:var(--red)">âŒ Hata: ${e.message}</p>`;
    }
}

async function confirmDeleteDuplicateShifts(idsJson) {
    const ids = JSON.parse(idsJson.replace(/&quot;/g, '"'));
    const resultsDiv = document.getElementById('cleanupResults');
    resultsDiv.innerHTML = '<p style="color:var(--tx2)">â³ Siliniyor...</p>';
    
    try {
        const batch = db.batch();
        ids.forEach(id => {
            batch.delete(db.collection('shifts').doc(id));
        });
        await batch.commit();
        resultsDiv.innerHTML = `<p style="color:var(--green)">âœ… ${ids.length} duplicate shift silindi.</p>`;
        toast(`${ids.length} duplicate shift silindi`, 'success');
    } catch (e) {
        resultsDiv.innerHTML = `<p style="color:var(--red)">âŒ Hata: ${e.message}</p>`;
    }
}

// Sadece PuanlarÄ± SÄ±fÄ±rla - Checklist geÃ§miÅŸi korunur
async function resetAllPoints() {
    // Sadece admin
    if (currentUser?.role !== 'admin') {
        toast('Bu iÅŸlem iÃ§in yetkiniz yok', 'error');
        return;
    }
    
    confirmModal(
        'PuanlarÄ± SÄ±fÄ±rla',
        `<div style="text-align:center">
            <div style="font-size:3rem;margin-bottom:16px">âš ï¸</div>
            <div style="font-weight:600;color:#e74c3c;font-size:1.1rem;margin-bottom:12px">DÄ°KKAT!</div>
            <div style="color:var(--tx2);margin-bottom:20px">Bu iÅŸlem ÅŸunlarÄ± <strong>kalÄ±cÄ± olarak</strong> silecek:</div>
            <div style="background:rgba(231,76,60,.1);border-radius:10px;padding:16px;text-align:left;margin-bottom:20px">
                <div style="margin-bottom:8px">ðŸ—‘ï¸ TÃ¼m otomatik puanlar (puantajNotes)</div>
                <div>ðŸ—‘ï¸ TÃ¼m manuel puanlar (puantaj)</div>
            </div>
            <div style="background:rgba(39,174,96,.1);border-radius:10px;padding:12px;margin-bottom:16px">
                <div style="color:#27ae60">âœ… Checklist kayÄ±tlarÄ± KORUNACAK</div>
            </div>
            <div style="background:var(--bg3);border-radius:8px;padding:12px">
                <input type="text" id="confirmResetText" placeholder="Onaylamak iÃ§in 'SIFIRLA' yazÄ±n" style="width:100%;padding:8px;border:2px solid var(--bg4);border-radius:6px;text-align:center;font-weight:600" />
            </div>
        </div>`,
        async () => {
            const confirmText = document.getElementById('confirmResetText')?.value;
            if (confirmText !== 'SIFIRLA') {
                toast('Onay metni yanlÄ±ÅŸ', 'error');
                return;
            }
            
            try {
                toast('Puan sÄ±fÄ±rlama baÅŸlatÄ±lÄ±yor...', 'info');
                
                let totalDeleted = 0;
                
                // 1. puantajNotes - otomatik puanlar
                const notesSnap = await db.collection('puantajNotes').get();
                if (notesSnap.size > 0) {
                    const notesBatch = db.batch();
                    notesSnap.docs.forEach(doc => {
                        notesBatch.delete(doc.ref);
                        totalDeleted++;
                    });
                    await notesBatch.commit();
                    console.log(`âœ… ${notesSnap.size} otomatik puan silindi`);
                }
                
                // 2. puantaj - manuel puanlar
                const puantajSnap = await db.collection('puantaj').get();
                if (puantajSnap.size > 0) {
                    const puantajBatch = db.batch();
                    puantajSnap.docs.forEach(doc => {
                        puantajBatch.delete(doc.ref);
                        totalDeleted++;
                    });
                    await puantajBatch.commit();
                    console.log(`âœ… ${puantajSnap.size} manuel puan silindi`);
                }
                
                toast(`âœ… Toplam ${totalDeleted} puan kaydÄ± silindi`, 'success');
                
                // Dashboard'u yenile
                setTimeout(() => location.reload(), 1500);
                
            } catch (err) {
                console.error('Puan sÄ±fÄ±rlama hatasÄ±:', err);
                toast('Hata: ' + err.message, 'error');
            }
        },
        'SÄ±fÄ±rla',
        'btn-danger'
    );
}

// TÃ¼m Check ve Puan GeÃ§miÅŸini Sil - SADECE ADMIN
async function deleteAllHistory() {
    // Sadece admin
    if (currentUser?.role !== 'admin') {
        toast('Bu iÅŸlem iÃ§in yetkiniz yok', 'error');
        return;
    }
    
    confirmModal(
        'TÃ¼m GeÃ§miÅŸi Sil',
        `<div style="text-align:center">
            <div style="font-size:3rem;margin-bottom:16px">âš ï¸</div>
            <div style="font-weight:600;color:#e74c3c;font-size:1.1rem;margin-bottom:12px">TEHLÄ°KELÄ° Ä°ÅžLEM!</div>
            <div style="color:var(--tx2);margin-bottom:20px">Bu iÅŸlem ÅŸunlarÄ± <strong>kalÄ±cÄ± olarak</strong> silecek:</div>
            <div style="background:rgba(231,76,60,.1);border-radius:10px;padding:16px;text-align:left;margin-bottom:20px">
                <div style="margin-bottom:8px">ðŸ—‘ï¸ TÃ¼m checklist kayÄ±tlarÄ± (checklistSubmissions)</div>
                <div style="margin-bottom:8px">ðŸ—‘ï¸ TÃ¼m otomatik puanlar (puantajNotes)</div>
                <div>ðŸ—‘ï¸ TÃ¼m manuel puanlar (puantaj)</div>
            </div>
            <div style="font-size:.85rem;color:var(--tx3);margin-bottom:16px">HTML'de hiÃ§bir geÃ§miÅŸ kayÄ±t gÃ¶rÃ¼nmez hale gelir.</div>
            <div style="background:var(--bg3);border-radius:8px;padding:12px">
                <input type="text" id="confirmDeleteText" placeholder="Onaylamak iÃ§in 'SÄ°L' yazÄ±n" style="width:100%;padding:8px;border:2px solid var(--bg4);border-radius:6px;text-align:center;font-weight:600" />
            </div>
        </div>`,
        async () => {
            const confirmText = document.getElementById('confirmDeleteText')?.value;
            if (confirmText !== 'SÄ°L') {
                toast('Onay metni yanlÄ±ÅŸ', 'error');
                return;
            }
            
            try {
                toast('Silme iÅŸlemi baÅŸlatÄ±lÄ±yor...', 'info');
                
                let totalDeleted = 0;
                
                // 1. checklistSubmissions
                const checklistsSnap = await db.collection('checklistSubmissions').get();
                const checklistsBatch = db.batch();
                checklistsSnap.docs.forEach(doc => {
                    checklistsBatch.delete(doc.ref);
                    totalDeleted++;
                });
                await checklistsBatch.commit();
                console.log(`âœ… ${checklistsSnap.size} checklist silindi`);
                
                // 2. puantajNotes
                const notesSnap = await db.collection('puantajNotes').get();
                const notesBatch = db.batch();
                notesSnap.docs.forEach(doc => {
                    notesBatch.delete(doc.ref);
                    totalDeleted++;
                });
                await notesBatch.commit();
                console.log(`âœ… ${notesSnap.size} otomatik puan silindi`);
                
                // 3. puantaj
                const puantajSnap = await db.collection('puantaj').get();
                const puantajBatch = db.batch();
                puantajSnap.docs.forEach(doc => {
                    puantajBatch.delete(doc.ref);
                    totalDeleted++;
                });
                await puantajBatch.commit();
                console.log(`âœ… ${puantajSnap.size} manuel puan silindi`);
                
                toast(`âœ… ${totalDeleted} kayÄ±t silindi`, 'success');
                
                // SayfayÄ± yenile
                setTimeout(() => {
                    location.reload();
                }, 2000);
                
            } catch (error) {
                console.error('Silme hatasÄ±:', error);
                toast('Silme iÅŸlemi baÅŸarÄ±sÄ±z: ' + error.message, 'error');
            }
        },
        'danger'
    );
}

// ========== ROL Ã–NÄ°ZLEME ==========
let originalUser = null;
let isPreviewMode = false;

// Sayfa yÃ¼klendiÄŸinde Ã¶nizleme durumunu kontrol et
function checkPreviewMode() {
    const saved = localStorage.getItem('moonberry_preview');
    if (saved) {
        try {
            const data = JSON.parse(saved);
            if (data.originalUser && data.previewUser) {
                originalUser = data.originalUser;
                isPreviewMode = true;
                currentUser = data.previewUser;
                
                // UI gÃ¼ncelle
                const roleNames = { 'barista': 'Barista', 'magaza_mudur_yardimcisi': 'MaÄŸaza MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±', 'bolge_muduru': 'BÃ¶lge MÃ¼dÃ¼rÃ¼', 'magaza_muduru': 'MaÄŸaza MÃ¼dÃ¼rÃ¼', 'yonetici': 'YÃ¶netici' };
                
                document.getElementById('previewRoleName').textContent = roleNames[currentUser.role];
                document.getElementById('previewBranchName').textContent = currentUser.branch || 'TÃ¼m Åžubeler';
                document.getElementById('rolePreviewContent').style.display = 'none';
                document.getElementById('rolePreviewActive').style.display = 'block';
                
                const userNameEl = document.getElementById('userName');
                if (userNameEl) userNameEl.innerHTML = `<span style="background:var(--yellow);color:#000;padding:2px 6px;border-radius:4px;font-size:.7rem;margin-right:6px">Ã–NÄ°ZLEME</span>${roleNames[currentUser.role]}`;
                
                const userRoleEl = document.getElementById('userRole');
                if (userRoleEl) userRoleEl.textContent = currentUser.branch || 'TÃ¼m Åžubeler';
                
                // Ãœst bar ekle
                showPreviewTopBar();
                
                // Yetkileri uygula
                applyRolePreviewPermissions(currentUser.role, currentUser.branch);
            }
        } catch (e) {
            localStorage.removeItem('moonberry_preview');
        }
    }
}

// Ã–nizleme Ã¼st barÄ±
function showPreviewTopBar() {
    if (document.getElementById('previewTopBar')) return;
    
    const roleNames = { 'barista': 'Barista', 'magaza_mudur_yardimcisi': 'MaÄŸaza MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±', 'bolge_muduru': 'BÃ¶lge MÃ¼dÃ¼rÃ¼', 'magaza_muduru': 'MaÄŸaza MÃ¼dÃ¼rÃ¼', 'yonetici': 'YÃ¶netici' };
    const bar = document.createElement('div');
    bar.id = 'previewTopBar';
    bar.style.cssText = 'position:fixed;top:0;left:0;right:0;background:linear-gradient(135deg,#f39c12,#e67e22);color:#fff;padding:10px 20px;display:flex;justify-content:space-between;align-items:center;z-index:10000;font-size:.9rem;box-shadow:0 2px 10px rgba(0,0,0,.3)';
    bar.innerHTML = `
        <div style="display:flex;align-items:center;gap:12px">
            <span style="font-size:1.2rem">ðŸ‘ï¸</span>
            <span><strong>Ã–nizleme Modu:</strong> ${roleNames[currentUser.role]} ${currentUser.branch && currentUser.branch !== 'all' ? 'â€¢ ' + currentUser.branch : ''}</span>
        </div>
        <button onclick="stopRolePreview()" style="background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.4);color:#fff;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:.85rem;font-weight:500">âœ• Ã–nizlemeyi SonlandÄ±r</button>
    `;
    document.body.prepend(bar);
    document.body.style.paddingTop = '50px';
}

function startRolePreview() {
    const role = document.getElementById('previewRoleSelect').value;
    const branch = document.getElementById('previewBranchSelect').value;
    
    if (!role) {
        toast('LÃ¼tfen bir rol seÃ§in', 'error');
        return;
    }
    if (!branch && role === 'magaza_muduru') {
        toast('MaÄŸaza MÃ¼dÃ¼rÃ¼ iÃ§in ÅŸube seÃ§imi gerekli', 'error');
        return;
    }
    
    // Mevcut kullanÄ±cÄ±yÄ± sakla
    originalUser = { ...currentUser };
    isPreviewMode = true;
    
    // Ã–nizleme kullanÄ±cÄ±sÄ±nÄ± ayarla
    const roleNames = {
        'barista': 'Barista',
        'magaza_mudur_yardimcisi': 'MaÄŸaza MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±',
        'bolge_muduru': 'BÃ¶lge MÃ¼dÃ¼rÃ¼',
        'magaza_muduru': 'MaÄŸaza MÃ¼dÃ¼rÃ¼',
        'yonetici': 'YÃ¶netici'
    };
    
    currentUser = {
        ...currentUser,
        role: role,
        branch: role === 'magaza_muduru' || role === 'magaza_mudur_yardimcisi' ? branch : (role === 'barista' ? branch : 'all'),
        name: `Ã–nizleme: ${roleNames[role]}`
    };
    
    // UI gÃ¼ncelle
    document.getElementById('previewRoleName').textContent = roleNames[role];
    document.getElementById('previewBranchName').textContent = branch || 'TÃ¼m Åžubeler';
    document.getElementById('rolePreviewContent').style.display = 'none';
    document.getElementById('rolePreviewActive').style.display = 'block';
    
    // Sidebar'a Ã¶nizleme badge'i ekle
    const userNameEl = document.getElementById('userName');
    if (userNameEl) {
        userNameEl.innerHTML = `<span style="background:var(--yellow);color:#000;padding:2px 6px;border-radius:4px;font-size:.7rem;margin-right:6px">Ã–NÄ°ZLEME</span>${roleNames[role]}`;
    }
    const userRoleEl = document.getElementById('userRole');
    if (userRoleEl) {
        userRoleEl.textContent = branch || 'TÃ¼m Åžubeler';
    }
    
    // LocalStorage'a kaydet
    localStorage.setItem('moonberry_preview', JSON.stringify({ originalUser, previewUser: currentUser }));
    
    // Ãœst bar ekle
    showPreviewTopBar();
    
    // Yetkileri uygula
    applyRolePreviewPermissions(role, branch);
    
    toast(`${roleNames[role]} olarak Ã¶nizleme baÅŸladÄ±`, 'info');
}

function applyRolePreviewPermissions(role, branch) {
    // Barista iÃ§in Ã¶zel kÄ±sÄ±tlamalar
    if (role === 'barista') {
        applyBaristaRestrictions();
        setupBaristaObserver(); // DOM deÄŸiÅŸikliklerini izle
        if (branch) {
            document.querySelectorAll('select[id*="Sube"]').forEach(select => {
                select.value = branch;
                select.disabled = true;
            });
        }
        return;
    }
    
    // MenÃ¼ Ã¶ÄŸelerini gÃ¶ster/gizle
    const hiddenForMagaza = ['admin', 'sozlesme', 'fesih'];
    const hiddenForBolge = [];
    
    document.querySelectorAll('.nav-item[data-page]').forEach(item => {
        const page = item.dataset.page;
        item.style.display = '';
        
        if (role === 'magaza_muduru' && hiddenForMagaza.includes(page)) {
            item.style.display = 'none';
        }
        if (role === 'bolge_muduru' && hiddenForBolge.includes(page)) {
            item.style.display = 'none';
        }
    });
    
    // Åžube filtreleme (maÄŸaza mÃ¼dÃ¼rÃ¼ sadece kendi ÅŸubesini gÃ¶rÃ¼r)
    if (role === 'magaza_muduru' && branch) {
        // Åžube seÃ§icileri kilitle
        document.querySelectorAll('select[id*="Sube"]').forEach(select => {
            select.value = branch;
            select.disabled = true;
        });
    }
}

function stopRolePreview() {
    if (!originalUser) return;
    
    // Orijinal kullanÄ±cÄ±yÄ± geri yÃ¼kle
    currentUser = { ...originalUser };
    originalUser = null;
    isPreviewMode = false;
    
    // LocalStorage'dan sil
    localStorage.removeItem('moonberry_preview');
    
    // Ãœst barÄ± kaldÄ±r
    const topBar = document.getElementById('previewTopBar');
    if (topBar) topBar.remove();
    document.body.style.paddingTop = '';
    
    // UI'Ä± sÄ±fÄ±rla
    document.getElementById('rolePreviewContent').style.display = 'block';
    document.getElementById('rolePreviewActive').style.display = 'none';
    document.getElementById('previewRoleSelect').value = '';
    document.getElementById('previewBranchSelect').value = '';
    
    // Sidebar kullanÄ±cÄ± bilgisini geri yÃ¼kle
    applyUserPermissions();
    
    // TÃ¼m menÃ¼ Ã¶ÄŸelerini gÃ¶ster
    document.querySelectorAll('.nav-item[data-page]').forEach(item => {
        item.style.display = '';
    });
    
    // TÃ¼m nav gruplarÄ±nÄ± gÃ¶ster
    document.querySelectorAll('.nav-group').forEach(group => {
        group.style.display = '';
    });
    
    // TÃ¼m dashboard kartlarÄ±nÄ± gÃ¶ster
    document.querySelectorAll('.dashboard-card').forEach(card => {
        card.style.display = '';
    });
    
    // TÃ¼m dashboard section'larÄ± gÃ¶ster
    document.querySelectorAll('.dashboard-section').forEach(section => {
        section.style.display = '';
    });
    
    // Åžube seÃ§icileri aÃ§
    document.querySelectorAll('select[id*="Sube"]').forEach(select => {
        select.disabled = false;
    });
    
    toast('Ã–nizleme sonlandÄ±rÄ±ldÄ±, yÃ¶netici gÃ¶rÃ¼nÃ¼mÃ¼ne dÃ¶nÃ¼ldÃ¼', 'success');
}

// ========== PIN ==========
function changePin() {
    const current = document.getElementById('admin_pin_current').value;
    const newPin = document.getElementById('admin_pin_new').value;
    if (current !== STATE.pin) {
        toast('Mevcut PIN hatalÄ±', 'error');
        return;
    }
    if (newPin.length !== 4 || !/^\d+$/.test(newPin)) {
        toast('Yeni PIN 4 haneli rakam olmalÄ±', 'error');
        return;
    }
    STATE.pin = newPin;
    saveState();
    document.getElementById('admin_pin_current').value = '';
    document.getElementById('admin_pin_new').value = '';
    successModal('PIN baÅŸarÄ±yla deÄŸiÅŸtirildi!');
}

// ========== COMPANY ==========
function saveCompany() {
    STATE.company.name = getVal('admin_company_name') || STATE.company.name;
    STATE.company.mersis = getVal('admin_mersis') || STATE.company.mersis;
    STATE.company.address = getVal('admin_address') || STATE.company.address;
    saveState();
    toast('Åžirket bilgileri kaydedildi', 'success');
}

// ========== BRANCHES ==========
function addBranch() {
    showModal('Åžube Ekle', `
        <div class="form-group">
            <label class="form-label">Åžube AdÄ±</label>
            <input type="text" id="newBranchName" class="form-input" placeholder="Ã–rn: KadÄ±kÃ¶y">
        </div>
    `, `
        <button class="btn btn-ghost" onclick="closeModal()">Ä°ptal</button>
        <button class="btn btn-primary" onclick="saveBranch()">Ekle</button>
    `);
}

async function saveBranch() {
    const name = getVal('newBranchName')?.trim();
    if (!name) {
        toast('Åžube adÄ± boÅŸ olamaz', 'error');
        return;
    }
    
    if (STATE.branches.includes(name)) {
        toast('Bu ÅŸube zaten mevcut', 'error');
        return;
    }
    
    closeModal();
    
    // Progress modal gÃ¶ster
    showModal('Åžube OluÅŸturuluyor', `
        <div style="text-align:center;padding:20px">
            <div style="font-size:2rem;margin-bottom:16px">ðŸª</div>
            <div style="font-weight:600;margin-bottom:12px">"${name}" oluÅŸturuluyor...</div>
            <div id="branchCreateStatus" style="color:var(--tx2);font-size:0.9rem">HazÄ±rlanÄ±yor...</div>
            <div style="margin-top:16px;background:var(--bg3);border-radius:8px;overflow:hidden;height:8px">
                <div id="branchCreateProgress" style="width:0%;height:100%;background:#008c95;transition:width .3s"></div>
            </div>
            <div id="branchCreateLog" style="margin-top:16px;text-align:left;font-size:0.75rem;color:var(--tx3);max-height:150px;overflow-y:auto"></div>
        </div>
    `, '');
    
    const statusEl = document.getElementById('branchCreateStatus');
    const progressEl = document.getElementById('branchCreateProgress');
    const logEl = document.getElementById('branchCreateLog');
    
    const log = (msg) => {
        logEl.innerHTML += msg + '<br>';
        logEl.scrollTop = logEl.scrollHeight;
    };
    
    const setProgress = (pct, msg) => {
        progressEl.style.width = pct + '%';
        statusEl.textContent = msg;
    };
    
    try {
        // Kaynak ÅŸube - ilk mevcut ÅŸube (genelde Tuzla Port)
        const sourceSourceBranch = STATE.branches[0] || 'Tuzla Port';
        const sourceBranchKey = sourceSourceBranch.replace(/[^a-zA-Z0-9]/g, '_');
        const newBranchKey = name.replace(/[^a-zA-Z0-9]/g, '_');
        const branchCreatedDate = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
        
        // 1. STATE.branches'a ekle (10%)
        setProgress(10, 'Åžube listesine ekleniyor...');
        STATE.branches.push(name);
        log(`âœ“ Åžube listesine eklendi`);
        
        // 2. Firebase systemConfig/checkRules.branches gÃ¼ncelle (20%)
        setProgress(20, 'Firebase ayarlarÄ± gÃ¼ncelleniyor...');
        await db.collection('systemConfig').doc('checkRules').update({
            branches: firebase.firestore.FieldValue.arrayUnion(name),
            [`branchCreatedAt.${name}`]: branchCreatedDate
        });
        log(`âœ“ Firebase branches gÃ¼ncellendi`);
        
        // 3. branchHours ekle (30%)
        setProgress(30, 'MaÄŸaza saatleri ayarlanÄ±yor...');
        const defaultHours = BRANCH_HOURS[sourceSourceBranch] || { open: '09:00', close: '23:00' };
        await db.collection('systemConfig').doc('checkRules').update({
            [`branchHours.${name}`]: defaultHours
        });
        BRANCH_HOURS[name] = defaultHours;
        log(`âœ“ MaÄŸaza saatleri ayarlandÄ± (${defaultHours.open}-${defaultHours.close})`);
        
        // 4. Checklist'leri kopyala (40-80%)
        setProgress(40, 'Checklist ÅŸablonlarÄ± kopyalanÄ±yor...');
        
        // DÄ°NAMÄ°K: Kaynak ÅŸubedeki TÃœM checklist'leri bul
        const sourceChecklists = await db.collection('checklists')
            .where('branch', '==', sourceSourceBranch)
            .get();
        
        // Checklist tÃ¼rlerini Ã§Ä±kar (branch_TYPE formatÄ±ndan TYPE'Ä± al)
        const checklistTypes = [];
        sourceChecklists.forEach(doc => {
            const docId = doc.id;
            // sourceBranchKey_TYPE formatÄ±ndan TYPE'Ä± Ã§Ä±kar
            if (docId.startsWith(sourceBranchKey + '_')) {
                const type = docId.replace(sourceBranchKey + '_', '');
                if (!checklistTypes.includes(type)) {
                    checklistTypes.push(type);
                }
            }
        });
        
        log(`ðŸ“‹ Kaynak ÅŸubede ${checklistTypes.length} checklist tÃ¼rÃ¼ bulundu: ${checklistTypes.join(', ')}`);
        
        let copiedCount = 0;
        
        for (let i = 0; i < checklistTypes.length; i++) {
            const type = checklistTypes[i];
            const sourceDocId = `${sourceBranchKey}_${type}`;
            const targetDocId = `${newBranchKey}_${type}`;
            
            try {
                const sourceDoc = await db.collection('checklists').doc(sourceDocId).get();
                if (sourceDoc.exists) {
                    const sourceData = sourceDoc.data();
                    await db.collection('checklists').doc(targetDocId).set({
                        ...sourceData,
                        branch: name,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    copiedCount++;
                    log(`âœ“ ${type}: ${sourceData.items?.length || 0} madde kopyalandÄ±`);
                }
            } catch (e) {
                log(`âš  ${type}: KopyalanamadÄ±`);
            }
            
            setProgress(40 + Math.round((i + 1) / checklistTypes.length * 40), `Checklist'ler kopyalanÄ±yor... (${i + 1}/${checklistTypes.length})`);
        }
        
        // 5. CHECKLIST_TYPES gÃ¼ncelle (85%)
        setProgress(85, 'Checklist tÃ¼rleri ayarlanÄ±yor...');
        const sourceTypes = CHECKLIST_TYPES[sourceSourceBranch] || [];
        CHECKLIST_TYPES[name] = JSON.parse(JSON.stringify(sourceTypes)); // Deep copy
        
        // Firebase'e kaydet
        await db.collection('config').doc('checklistTypes').update({
            [name]: CHECKLIST_TYPES[name]
        });
        log(`âœ“ Checklist tÃ¼rleri ayarlandÄ± (${CHECKLIST_TYPES[name].length} tÃ¼r)`);
        
        // 6. Test kullanÄ±cÄ±larÄ± oluÅŸtur (85-95%)
        setProgress(85, 'Test kullanÄ±cÄ±larÄ± oluÅŸturuluyor...');
        const branchShortName = normalizeTurkishChars(name).replace(/[^a-z0-9]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g, '');
        const testPassword = 'Test.123*';
        
        // Pozisyon isimlerini STATE.positions'dan dinamik al
        const getPositionName = (role) => {
            const pos = STATE.positions.find(p => p.role === role);
            return pos?.name || role;
        };
        
        const testUsers = [
            { role: 'magaza_muduru', suffix: 'mudur', displayName: `${name} Test MÃ¼dÃ¼r`, position: getPositionName('magaza_muduru') },
            { role: 'mudur_yardimcisi', suffix: 'mudur_yrd', displayName: `${name} Test Md. Yrd.`, position: getPositionName('mudur_yardimcisi') },
            { role: 'barista', suffix: 'barista1', displayName: `${name} Barista 1`, position: getPositionName('barista') },
            { role: 'barista', suffix: 'barista2', displayName: `${name} Barista 2`, position: getPositionName('barista') },
            { role: 'barista', suffix: 'barista3', displayName: `${name} Barista 3`, position: getPositionName('barista') }
        ];
        
        const createdPersonelIds = [];
        
        for (let i = 0; i < testUsers.length; i++) {
            const user = testUsers[i];
            const email = `${branchShortName}_${user.suffix}@moonberrycoffee.com`;
            const uniqueId = normalizePersonelId(user.displayName);
            
            try {
                // 1. Credentials koleksiyonuna kaydet
                await saveCredential(email, testPassword, null);
                log(`âœ“ Credentials: ${email}`);
                
                // 2. Firebase Auth'a ekle (secondary app ile)
                try {
                    const secondaryApp = firebase.initializeApp(firebase.app().options, `Secondary_${Date.now()}_${i}`);
                    const secondaryAuth = secondaryApp.auth();
                    await secondaryAuth.createUserWithEmailAndPassword(email, testPassword);
                    await secondaryApp.delete();
                    log(`âœ“ Auth: ${email}`);
                } catch (authErr) {
                    if (authErr.code !== 'auth/email-already-in-use') {
                        console.warn('Auth hatasÄ±:', authErr);
                        log(`âš  Auth (login'de oluÅŸturulacak): ${email}`);
                    }
                }
                
                // 3. Personel koleksiyonuna ekle (ÅŸifre artÄ±k credentials'da)
                const personelRef = await db.collection('personel').add({
                    name: user.displayName,
                    codeName: user.displayName,
                    uniqueId: uniqueId,
                    email: email,
                    role: user.role,
                    position: user.position,
                    branch: name,
                    status: 'active',
                    isTestUser: true,
                    hasFirebaseAuth: true,
                    hasPassword: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                createdPersonelIds.push({ id: personelRef.id, ...user, email, uniqueId });
                
                // Users koleksiyonuna ekle
                await db.collection('users').doc(email).set({
                    email: email,
                    role: user.role,
                    branch: name,
                    name: user.displayName,
                    personelId: personelRef.id,
                    isTestUser: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                log(`âœ“ Personel: ${user.displayName}`);
            } catch (userErr) {
                log(`âš  KullanÄ±cÄ± hatasÄ±: ${user.displayName} - ${userErr.message}`);
            }
            
            setProgress(85 + Math.round((i + 1) / testUsers.length * 5), `KullanÄ±cÄ±lar oluÅŸturuluyor... (${i + 1}/${testUsers.length})`);
        }
        
        // 7. Bu hafta iÃ§in shift planÄ± oluÅŸtur (95%)
        setProgress(95, 'Shift planÄ± oluÅŸturuluyor...');
        
        // Bu haftanÄ±n pazartesisini bul
        const today = new Date();
        const dayOfWeek = today.getDay(); // 0=Pazar, 1=Pazartesi...
        const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
        const weekStart = new Date(today);
        weekStart.setDate(today.getDate() + mondayOffset);
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);
        
        const weekStartStr = weekStart.toISOString().split('T')[0];
        const weekEndStr = weekEnd.toISOString().split('T')[0];
        const weekLabel = `${weekStart.getDate()} ${weekStart.toLocaleDateString('tr-TR', {month: 'long'})} - ${weekEnd.getDate()} ${weekEnd.toLocaleDateString('tr-TR', {month: 'long'})}`;
        
        // Personel shift atamalarÄ± (aÃ§Ä±lÄ±ÅŸ/kapanÄ±ÅŸ dÃ¶nÃ¼ÅŸÃ¼mlÃ¼)
        const personelShifts = {};
        const personelOrder = [];
        const personelNames = {};
        const personelFullNames = {};
        
        createdPersonelIds.forEach((p, idx) => {
            // uniqueId kullan (zaten oluÅŸturuldu)
            const odaId = p.uniqueId || normalizeTurkishChars(p.displayName).replace(/[^a-z0-9]/g, '_').replace(/_+/g, '_');
            personelOrder.push(odaId);
            
            // KÄ±sa isim: Åžube adÄ±nÄ± Ã§Ä±kar, kalan kÄ±smÄ± kullan
            // "AtaÅŸehir Marina Test MÃ¼dÃ¼r" â†’ "Test MÃ¼dÃ¼r"
            // "AtaÅŸehir Marina Barista 1" â†’ "Barista 1"
            const shortName = p.displayName.replace(name, '').trim();
            personelNames[odaId] = shortName || p.displayName;
            personelFullNames[odaId] = p.displayName;
            
            // HaftalÄ±k shift atamasÄ± (0=Pazartesi, 6=Pazar)
            const shifts = {};
            for (let day = 0; day < 7; day++) {
                if (p.role === 'magaza_muduru') {
                    // MÃ¼dÃ¼r: Ara vardiya + 1 gÃ¼n OFF
                    shifts[day] = day === 6 ? 'OFF' : '12:00/21:00';
                } else if (p.role === 'mudur_yardimcisi') {
                    // MÃ¼dÃ¼r yardÄ±mcÄ±sÄ±: KapanÄ±ÅŸ aÄŸÄ±rlÄ±klÄ± + 1 gÃ¼n OFF
                    shifts[day] = day === 0 ? 'OFF' : (day % 2 === 0 ? 'AÃ‡ILIÅž' : 'KAPANIÅž');
                } else {
                    // Barista: DÃ¶nÃ¼ÅŸÃ¼mlÃ¼ aÃ§Ä±lÄ±ÅŸ/kapanÄ±ÅŸ + 1 gÃ¼n OFF
                    const offDay = (idx + 1) % 7; // Her barista farklÄ± gÃ¼n OFF
                    if (day === offDay) {
                        shifts[day] = 'OFF';
                    } else {
                        shifts[day] = (day + idx) % 2 === 0 ? 'AÃ‡ILIÅž' : 'KAPANIÅž';
                    }
                }
            }
            personelShifts[odaId] = shifts;
        });
        
        // HaftalÄ±k shift dokÃ¼manÄ± oluÅŸtur
        const shiftDocData = {
            branch: name,
            weekStart: weekStartStr,
            weekEnd: weekEndStr,
            weekLabel: weekLabel,
            personelShifts: personelShifts,
            personelOrder: personelOrder,
            personelNames: personelNames,
            personelFullNames: personelFullNames,
            customRules: [
                { text: 'AÃ‡ILIÅž PERSONELÄ° Ä°ÅžE GEÃ‡ KALMAMALIDIR!', color: '#2E7D32', bg: '#C6EFCE' },
                { text: 'Ä°ZÄ°N GÃœNÃœ YOKSA; YEMEK VE MOLA SÃœRESÄ° SEÃ‡Ä°MÄ° PERSONELÄ°N KENDÄ° SEÃ‡Ä°MÄ°NDEDÄ°R.', color: '#2E7D32', bg: '#C6EFCE' },
                { text: "SHIFT'E YILDIZ (*) SEMBOLÃœ OLAN GÃœNLER Ã–ZEL Ä°STEK GÃœNLERÄ°DÄ°R.", color: '#9C5700', bg: '#FFEB9C' },
                { text: 'SHIFT YÃ–NETÄ°CÄ°LERÄ°NÄ°ZE BÄ°LGÄ° VERÄ°LMEDEN HABERSÄ°Z DEÄžÄ°ÅžTÄ°RÄ°LEMEZ!', color: '#C00000', bg: '#FFC7CE' }
            ],
            createdBy: currentUser?.email || 'admin',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            isAutoGenerated: true
        };
        
        await db.collection('shifts').add(shiftDocData);
        log(`âœ“ HaftalÄ±k shift planÄ± oluÅŸturuldu: ${weekLabel}`);
        log(`   â€¢ ${createdPersonelIds.length} personel atandÄ±`);
        
        // 8. Local state kaydet (98%)
        setProgress(98, 'Yerel ayarlar kaydediliyor...');
        saveState();
        
        // 9. TamamlandÄ± (100%)
        setProgress(100, 'TamamlandÄ±!');
        log(`\nâœ… "${name}" ÅŸubesi oluÅŸturuldu!`);
        log(`   â€¢ ${copiedCount} checklist kopyalandÄ±`);
        log(`   â€¢ ${createdPersonelIds.length} test kullanÄ±cÄ± eklendi`);
        log(`   â€¢ HaftalÄ±k shift planÄ± oluÅŸturuldu`);
        log(`\nðŸ“§ Test kullanÄ±cÄ± ÅŸifresi: ${testPassword}`);
        
        // Yeni ÅŸube adÄ±nÄ± kaydet (shift sayfasÄ±nda kullanÄ±lacak)
        window._newBranchName = name;
        
        setTimeout(() => {
            closeModal();
            populateSelects();
            renderAdminLists();
            toast(`"${name}" ÅŸubesi oluÅŸturuldu! Shift planÄ±na yÃ¶nlendiriliyorsunuz...`, 'success');
            
            // Shift sayfasÄ±na git ve yeni ÅŸubeyi seÃ§
            setTimeout(() => {
                goTo('shift');
                // Åžube seÃ§imini ayarla (sayfa yÃ¼klenmesi iÃ§in bekle)
                setTimeout(async () => {
                    const shiftBranchSelect = document.getElementById('shiftSube');
                    if (shiftBranchSelect) {
                        shiftBranchSelect.value = name;
                        // Ã–nce shift listesini yÃ¼kle (hafta dropdown'Ä± dolsun)
                        if (typeof loadShiftList === 'function') {
                            await loadShiftList();
                        }
                        // Hafta dropdown'Ä± yÃ¼klendikten sonra "Bu hafta" seÃ§
                        setTimeout(() => {
                            const weekSelect = document.getElementById('shiftHafta');
                            if (weekSelect && weekSelect.options.length > 0) {
                                // "Bu hafta" seÃ§eneÄŸini bul veya ilk seÃ§eneÄŸi seÃ§
                                for (let i = 0; i < weekSelect.options.length; i++) {
                                    if (weekSelect.options[i].text.includes('Bu hafta')) {
                                        weekSelect.selectedIndex = i;
                                        break;
                                    }
                                }
                                // HiÃ§ "Bu hafta" yoksa ilk seÃ§eneÄŸi al
                                if (weekSelect.selectedIndex < 0) {
                                    weekSelect.selectedIndex = 0;
                                }
                            }
                            if (typeof loadShiftWeek === 'function') {
                                loadShiftWeek();
                            }
                        }, 1000);
                    }
                }, 800);
            }, 1000);
        }, 2000);
        
    } catch (e) {
        console.error('Åžube oluÅŸturma hatasÄ±:', e);
        log(`\nâŒ Hata: ${e.message}`);
        setProgress(100, 'Hata oluÅŸtu!');
        
        setTimeout(() => {
            closeModal();
            toast('Åžube oluÅŸturma hatasÄ±: ' + e.message, 'error');
        }, 2000);
    }
}

function editBranch(i) {
    showModal('Åžube DÃ¼zenle', `
        <div class="form-group">
            <label class="form-label">Åžube AdÄ±</label>
            <input type="text" id="editBranchName" class="form-input" value="${STATE.branches[i]}">
        </div>
    `, `
        <button class="btn btn-ghost" onclick="closeModal()">Ä°ptal</button>
        <button class="btn btn-primary" onclick="updateBranch(${i})">Kaydet</button>
    `);
}

function updateBranch(i) {
    const newName = getVal('editBranchName')?.trim();
    const oldName = STATE.branches[i];
    
    if (!newName) {
        toast('Åžube adÄ± boÅŸ olamaz', 'error');
        return;
    }
    
    if (newName === oldName) {
        closeModal();
        return;
    }
    
    // EÄŸer sadece isim deÄŸiÅŸikliÄŸi varsa, migration yap
    closeModal();
    migrateBranchName(oldName, newName);
}

// Åžube adÄ± deÄŸiÅŸikliÄŸi - tÃ¼m Firebase kayÄ±tlarÄ±nÄ± gÃ¼ncelle
async function migrateBranchName(oldName, newName) {
    showModal('Åžube GÃ¼ncelleniyor', `
        <div style="text-align:center;padding:20px">
            <div style="font-size:2rem;margin-bottom:16px">ðŸ”„</div>
            <div style="font-weight:600;margin-bottom:12px">"${oldName}" â†’ "${newName}"</div>
            <div id="migrationStatus" style="color:var(--tx2);font-size:0.9rem">HazÄ±rlanÄ±yor...</div>
            <div style="margin-top:16px;background:var(--bg3);border-radius:8px;overflow:hidden;height:8px">
                <div id="migrationProgress" style="width:0%;height:100%;background:#008c95;transition:width .3s"></div>
            </div>
            <div id="migrationLog" style="margin-top:16px;text-align:left;font-size:0.75rem;color:var(--tx3);max-height:150px;overflow-y:auto"></div>
        </div>
    `, '');
    
    const statusEl = document.getElementById('migrationStatus');
    const progressEl = document.getElementById('migrationProgress');
    const logEl = document.getElementById('migrationLog');
    
    const log = (msg) => {
        logEl.innerHTML += msg + '<br>';
        logEl.scrollTop = logEl.scrollHeight;
    };
    
    const setProgress = (pct, msg) => {
        progressEl.style.width = pct + '%';
        statusEl.textContent = msg;
    };
    
    try {
        let totalUpdated = 0;
        
        // 1. PERSONEL (10%)
        setProgress(5, 'Personel kayÄ±tlarÄ± gÃ¼ncelleniyor...');
        const personelSnap = await db.collection('personel').where('branch', '==', oldName).get();
        for (const doc of personelSnap.docs) {
            await doc.ref.update({ branch: newName });
            totalUpdated++;
        }
        log(`âœ“ Personel: ${personelSnap.size} kayÄ±t`);
        setProgress(15, 'Vardiya kayÄ±tlarÄ± gÃ¼ncelleniyor...');
        
        // 2. SHIFTS (30%)
        const shiftsSnap = await db.collection('shifts').where('branch', '==', oldName).get();
        for (const doc of shiftsSnap.docs) {
            await doc.ref.update({ branch: newName });
            totalUpdated++;
        }
        log(`âœ“ Vardiyalar: ${shiftsSnap.size} kayÄ±t`);
        setProgress(35, 'Checklist kayÄ±tlarÄ± gÃ¼ncelleniyor...');
        
        // 3. CHECKLIST SUBMISSIONS (50%)
        const subSnap = await db.collection('checklistSubmissions').where('branch', '==', oldName).get();
        for (const doc of subSnap.docs) {
            await doc.ref.update({ branch: newName });
            totalUpdated++;
        }
        log(`âœ“ Checklist Submissions: ${subSnap.size} kayÄ±t`);
        setProgress(55, 'Checklist maddeleri taÅŸÄ±nÄ±yor...');
        
        // 4. CHECKLISTS - Doc ID deÄŸiÅŸmeli (70%)
        const oldPrefix = oldName.replace(/\s+/g, '_').replace(/[()]/g, '');
        const newPrefix = newName.replace(/\s+/g, '_').replace(/[()]/g, '');
        const checkSnap = await db.collection('checklists').get();
        const toMigrate = [];
        checkSnap.forEach(doc => {
            if (doc.id.startsWith(oldPrefix)) {
                toMigrate.push({ oldId: doc.id, newId: doc.id.replace(oldPrefix, newPrefix), data: doc.data() });
            }
        });
        for (const m of toMigrate) {
            await db.collection('checklists').doc(m.newId).set(m.data);
            await db.collection('checklists').doc(m.oldId).delete();
            totalUpdated++;
        }
        log(`âœ“ Checklist Maddeleri: ${toMigrate.length} dÃ¶kÃ¼man`);
        setProgress(75, 'Sistem ayarlarÄ± gÃ¼ncelleniyor...');
        
        // 5. SYSTEM CONFIG - branches array (85%)
        const configDoc = await db.collection('systemConfig').doc('checkRules').get();
        if (configDoc.exists) {
            const branches = configDoc.data().branches || [];
            const idx = branches.indexOf(oldName);
            if (idx !== -1) {
                branches[idx] = newName;
                await configDoc.ref.update({ branches });
                log(`âœ“ systemConfig/checkRules.branches`);
            }
        }
        setProgress(85, 'Checklist tÃ¼rleri gÃ¼ncelleniyor...');
        
        // 6. CONFIG/CHECKLIST TYPES (95%)
        const typesDoc = await db.collection('config').doc('checklistTypes').get();
        if (typesDoc.exists && typesDoc.data()[oldName]) {
            const data = typesDoc.data();
            data[newName] = data[oldName];
            delete data[oldName];
            await typesDoc.ref.set(data);
            log(`âœ“ config/checklistTypes`);
        }
        
        // 7. STATE.branches (local)
        const stateIdx = STATE.branches.indexOf(oldName);
        if (stateIdx !== -1) {
            STATE.branches[stateIdx] = newName;
        }
        
        // 8. BRANCH_HOURS gÃ¼ncelle
        if (BRANCH_HOURS && BRANCH_HOURS[oldName]) {
            BRANCH_HOURS[newName] = BRANCH_HOURS[oldName];
            delete BRANCH_HOURS[oldName];
        }
        
        setProgress(100, 'TamamlandÄ±!');
        log(`<strong style="color:#27ae60">âœ“ Toplam ${totalUpdated} kayÄ±t gÃ¼ncellendi</strong>`);
        
        // BaÅŸarÄ± mesajÄ± ve kapat
        setTimeout(() => {
            closeModal();
            saveState();
            populateSelects();
            renderAdminLists();
            toast(`Åžube "${newName}" olarak gÃ¼ncellendi`, 'success');
            
            // Dashboard'u yenile
            if (typeof loadTodayChecks === 'function') {
                loadTodayChecks();
            }
        }, 1500);
        
    } catch (error) {
        console.error('Migration hatasÄ±:', error);
        setProgress(0, 'Hata oluÅŸtu!');
        log(`<strong style="color:#e74c3c">âœ— Hata: ${error.message}</strong>`);
        
        setTimeout(() => {
            closeModal();
            toast('Åžube gÃ¼ncellenirken hata oluÅŸtu', 'error');
        }, 2000);
    }
}

function deleteBranch(i) {
    const branchName = STATE.branches[i];
    confirmModal('Åžube Sil', `
        <div style="text-align:left">
            <p><strong>"${branchName}"</strong> ÅŸubesini silmek istediÄŸinize emin misiniz?</p>
            <div style="margin-top:12px;padding:12px;background:rgba(231,76,60,.1);border-radius:8px;font-size:.85rem;color:#c0392b">
                <strong>âš ï¸ DÄ°KKAT:</strong> Bu iÅŸlem geri alÄ±namaz!<br>
                Silinecekler:
                <ul style="margin:8px 0 0 16px;padding:0">
                    <li>TÃ¼m checklist tanÄ±mlarÄ±</li>
                    <li>TÃ¼m checklist kayÄ±tlarÄ±</li>
                    <li>TÃ¼m personel kayÄ±tlarÄ±</li>
                    <li>TÃ¼m shift kayÄ±tlarÄ±</li>
                    <li>TÃ¼m puantaj notlarÄ±</li>
                    <li>TÃ¼m haftalÄ±k atamalar</li>
                </ul>
            </div>
        </div>
    `, () => executeDeleteBranch(branchName, i), 'danger');
}

async function executeDeleteBranch(branchName, index) {
    // Progress modal gÃ¶ster
    showModal('Åžube Siliniyor', `
        <div style="text-align:center;padding:20px">
            <div style="font-size:2rem;margin-bottom:16px">ðŸ—‘ï¸</div>
            <div style="font-weight:600;margin-bottom:12px">"${branchName}" siliniyor...</div>
            <div id="branchDeleteStatus" style="color:var(--tx2);font-size:0.9rem">HazÄ±rlanÄ±yor...</div>
            <div style="margin-top:16px;background:var(--bg3);border-radius:8px;overflow:hidden;height:8px">
                <div id="branchDeleteProgress" style="width:0%;height:100%;background:#e74c3c;transition:width .3s"></div>
            </div>
            <div id="branchDeleteLog" style="margin-top:16px;text-align:left;font-size:0.75rem;color:var(--tx3);max-height:200px;overflow-y:auto"></div>
        </div>
    `, '');
    
    const statusEl = document.getElementById('branchDeleteStatus');
    const progressEl = document.getElementById('branchDeleteProgress');
    const logEl = document.getElementById('branchDeleteLog');
    
    const log = (msg) => {
        logEl.innerHTML += msg + '<br>';
        logEl.scrollTop = logEl.scrollHeight;
    };
    
    const setProgress = (pct, msg) => {
        progressEl.style.width = pct + '%';
        statusEl.textContent = msg;
    };
    
    const branchKey = branchName.replace(/[^a-zA-Z0-9]/g, '_');
    let totalDeleted = 0;
    
    try {
        // 1. Checklist tanÄ±mlarÄ±nÄ± sil (10%)
        setProgress(10, 'Checklist tanÄ±mlarÄ± siliniyor...');
        const checklistTypes = ['acilis', 'kapanis', 'gunluk', 'haftalik', 'mudur', 'platform', 'aylik'];
        for (const type of checklistTypes) {
            const docId = `${branchKey}_${type}`;
            try {
                await db.collection('checklists').doc(docId).delete();
                totalDeleted++;
            } catch (e) {}
        }
        log(`âœ“ Checklist tanÄ±mlarÄ± silindi`);
        
        // 2. Checklist submissions sil (25%)
        setProgress(25, 'Checklist kayÄ±tlarÄ± siliniyor...');
        const submissionsSnap = await db.collection('checklistSubmissions')
            .where('branch', '==', branchName).get();
        for (const doc of submissionsSnap.docs) {
            await doc.ref.delete();
            totalDeleted++;
        }
        log(`âœ“ ${submissionsSnap.size} checklist kaydÄ± silindi`);
        
        // 3. Personel sil (40%)
        setProgress(40, 'Personel kayÄ±tlarÄ± siliniyor...');
        const personelSnap = await db.collection('personel')
            .where('branch', '==', branchName).get();
        const deletedEmails = [];
        for (const doc of personelSnap.docs) {
            const data = doc.data();
            if (data.email) deletedEmails.push(data.email);
            await doc.ref.delete();
            totalDeleted++;
        }
        log(`âœ“ ${personelSnap.size} personel silindi`);
        
        // 4. Users ve Credentials koleksiyonundan sil (50%)
        setProgress(50, 'KullanÄ±cÄ± kayÄ±tlarÄ± siliniyor...');
        for (const email of deletedEmails) {
            try {
                await db.collection('users').doc(email).delete();
                totalDeleted++;
            } catch (e) {}
            // Credentials'Ä± da sil
            try {
                const credDocId = email.toLowerCase().replace(/[@.]/g, '_');
                await db.collection('credentials').doc(credDocId).delete();
                totalDeleted++;
            } catch (e) {}
        }
        log(`âœ“ ${deletedEmails.length} kullanÄ±cÄ± ve credentials kaydÄ± silindi`);
        
        // 5. Shift'leri sil (60%)
        setProgress(60, 'Shift kayÄ±tlarÄ± siliniyor...');
        const shiftsSnap = await db.collection('shifts')
            .where('branch', '==', branchName).get();
        for (const doc of shiftsSnap.docs) {
            await doc.ref.delete();
            totalDeleted++;
        }
        log(`âœ“ ${shiftsSnap.size} shift silindi`);
        
        // 6. Weekly assignments sil (70%)
        setProgress(70, 'HaftalÄ±k atamalar siliniyor...');
        const weeklySnap = await db.collection('weeklyAssignments')
            .where('branch', '==', branchName).get();
        for (const doc of weeklySnap.docs) {
            await doc.ref.delete();
            totalDeleted++;
        }
        log(`âœ“ ${weeklySnap.size} haftalÄ±k atama silindi`);
        
        // 7. Puantaj notlarÄ± sil (80%)
        setProgress(80, 'Puantaj notlarÄ± siliniyor...');
        const puantajSnap = await db.collection('puantajNotes')
            .where('branch', '==', branchName).get();
        for (const doc of puantajSnap.docs) {
            await doc.ref.delete();
            totalDeleted++;
        }
        log(`âœ“ ${puantajSnap.size} puantaj notu silindi`);
        
        // 8. Manager notlarÄ± sil (85%)
        setProgress(85, 'YÃ¶netici notlarÄ± siliniyor...');
        const managerSnap = await db.collection('managerNotes')
            .where('branch', '==', branchName).get();
        for (const doc of managerSnap.docs) {
            await doc.ref.delete();
            totalDeleted++;
        }
        log(`âœ“ ${managerSnap.size} yÃ¶netici notu silindi`);
        
        // 9. Firebase systemConfig gÃ¼ncelle (90%)
        setProgress(90, 'Sistem ayarlarÄ± gÃ¼ncelleniyor...');
        await db.collection('systemConfig').doc('checkRules').update({
            branches: firebase.firestore.FieldValue.arrayRemove(branchName),
            [`branchHours.${branchName}`]: firebase.firestore.FieldValue.delete(),
            [`branchCreatedAt.${branchName}`]: firebase.firestore.FieldValue.delete()
        });
        log(`âœ“ Sistem ayarlarÄ± gÃ¼ncellendi`);
        
        // 10. CHECKLIST_TYPES gÃ¼ncelle (92%)
        delete CHECKLIST_TYPES[branchName];
        try {
            await db.collection('config').doc('checklistTypes').update({
                [branchName]: firebase.firestore.FieldValue.delete()
            });
        } catch (e) {}
        log(`âœ“ Checklist tÃ¼rleri gÃ¼ncellendi`);
        
        // 11. BRANCH_HOURS gÃ¼ncelle (94%)
        delete BRANCH_HOURS[branchName];
        
        // 12. STATE gÃ¼ncelle (96%)
        setProgress(96, 'Yerel ayarlar gÃ¼ncelleniyor...');
        STATE.branches.splice(index, 1);
        saveState();
        log(`âœ“ Yerel ayarlar gÃ¼ncellendi`);
        
        // 13. TamamlandÄ± (100%)
        setProgress(100, 'TamamlandÄ±!');
        log(`\nâœ… "${branchName}" ÅŸubesi tamamen silindi!`);
        log(`   â€¢ Toplam ${totalDeleted} kayÄ±t silindi`);
        log(`\nâš ï¸ Not: Firebase Auth kullanÄ±cÄ±larÄ± manuel silinmeli`);
        
        setTimeout(() => {
            closeModal();
            populateSelects();
            renderAdminLists();
            toast(`"${branchName}" ÅŸubesi silindi (${totalDeleted} kayÄ±t)`, 'success');
        }, 2000);
        
    } catch (e) {
        console.error('Åžube silme hatasÄ±:', e);
        log(`\nâŒ Hata: ${e.message}`);
        setProgress(100, 'Hata oluÅŸtu!');
        
        setTimeout(() => {
            closeModal();
            toast('Åžube silme hatasÄ±: ' + e.message, 'error');
        }, 2000);
    }
}

// ========== POSITIONS ==========
function addPosition() {
    // Mevcut roller ve varsayÄ±lan seviyeleri
    const roles = [
        { id: 'barista', name: 'Barista (SÄ±nÄ±rlÄ± Yetki)', defaultLevel: 1 },
        { id: 'mudur_yardimcisi', name: 'MÃ¼dÃ¼r YardÄ±mcÄ±sÄ± (Orta Yetki)', defaultLevel: 2 },
        { id: 'magaza_muduru', name: 'MaÄŸaza MÃ¼dÃ¼rÃ¼ (GeniÅŸ Yetki)', defaultLevel: 3 },
        { id: 'bolge_muduru', name: 'BÃ¶lge MÃ¼dÃ¼rÃ¼ (Tam Yetki)', defaultLevel: 4 }
    ];
    
    showModal('Yeni Pozisyon Ekle', `
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">Pozisyon ID *</label>
                <input type="text" id="newPosId" class="form-input" placeholder="ornek_pozisyon">
                <small style="color:var(--tx2);font-size:.7rem">Sistem tarafÄ±ndan kullanÄ±lÄ±r, TÃ¼rkÃ§e karakter kullanmayÄ±n</small>
            </div>
            <div class="form-group">
                <label class="form-label">Pozisyon AdÄ± *</label>
                <input type="text" id="newPosName" class="form-input" placeholder="Ã–rnek Pozisyon">
            </div>
            <div class="form-group">
                <label class="form-label">Yaka Tipi</label>
                <select id="newPosType" class="form-select">
                    <option value="Mavi Yaka">Mavi Yaka</option>
                    <option value="Gri Yaka">Gri Yaka</option>
                    <option value="Beyaz Yaka">Beyaz Yaka</option>
                    <option value="Stratejik">Stratejik</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Sistem RolÃ¼ *</label>
                <select id="newPosRole" class="form-select" onchange="updateLevelFromRole()">
                    ${roles.map(r => `<option value="${r.id}" data-level="${r.defaultLevel}">${r.name}</option>`).join('')}
                </select>
                <small style="color:var(--tx2);font-size:.7rem">Bu rol, pozisyonun yetkilerini belirler</small>
            </div>
            <div class="form-group">
                <label class="form-label">HiyerarÅŸi Seviyesi *</label>
                <select id="newPosLevel" class="form-select">
                    <option value="1">1 - En Alt (Barista)</option>
                    <option value="2">2 - Alt-Orta (MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±)</option>
                    <option value="3">3 - Orta (MaÄŸaza MÃ¼dÃ¼rÃ¼)</option>
                    <option value="4">4 - Ãœst (BÃ¶lge MÃ¼dÃ¼rÃ¼)</option>
                    <option value="5">5 - En Ãœst (YÃ¶netici)</option>
                </select>
                <small style="color:var(--tx2);font-size:.7rem">DÃ¼ÅŸÃ¼k seviye, yÃ¼ksek seviyeyi dÃ¼zenleyemez</small>
            </div>
            <div class="form-group full">
                <label class="form-label">Ä°kon</label>
                <div style="display:flex;align-items:center;gap:12px">
                    <div id="newPosIconPreview" style="width:48px;height:48px;display:flex;align-items:center;justify-content:center;background:var(--bg3);border-radius:12px;cursor:pointer;color:var(--tx)" onclick="toggleEmojiPicker('newPosIcon')">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    </div>
                    <input type="hidden" id="newPosIcon" value="user">
                    <button type="button" class="btn btn-ghost btn-sm" onclick="toggleEmojiPicker('newPosIcon')">Ä°kon SeÃ§</button>
                </div>
                <div id="emojiPickerNewPosIcon" class="emoji-picker" style="display:none"></div>
            </div>
        </div>
    `, `
        <button class="btn btn-ghost" onclick="closeModal()">Ä°ptal</button>
        <button class="btn btn-primary" onclick="savePosition()">Ekle</button>
    `);
}

// Rol deÄŸiÅŸince level otomatik gÃ¼ncelle
function updateLevelFromRole() {
    const roleSelect = document.getElementById('newPosRole') || document.getElementById('editPosRole');
    const levelSelect = document.getElementById('newPosLevel') || document.getElementById('editPosLevel');
    if (roleSelect && levelSelect) {
        const selectedOption = roleSelect.options[roleSelect.selectedIndex];
        const defaultLevel = selectedOption.dataset.level || '1';
        levelSelect.value = defaultLevel;
    }
}

// SVG Ä°kon Seti - Premium ve Minimalist
const ICON_LIBRARY = {
    'Pozisyon': [
        { id: 'user', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>', label: 'KullanÄ±cÄ±' },
        { id: 'chef', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8h1a4 4 0 010 8h-1"/><path d="M2 8h16v9a4 4 0 01-4 4H6a4 4 0 01-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>', label: 'Barista' },
        { id: 'briefcase', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v16"/></svg>', label: 'Ä°ÅŸ' },
        { id: 'store', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>', label: 'MaÄŸaza' },
        { id: 'globe', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg>', label: 'BÃ¶lge' },
        { id: 'users', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>', label: 'Ekip' },
        { id: 'usercheck', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></svg>', label: 'OnaylÄ±' }
    ],
    'YÃ¶netim': [
        { id: 'star', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>', label: 'YÄ±ldÄ±z' },
        { id: 'award', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>', label: 'Ã–dÃ¼l' },
        { id: 'target', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>', label: 'Hedef' },
        { id: 'shield', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>', label: 'Kalkan' },
        { id: 'key', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 11-7.778 7.778 5.5 5.5 0 017.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>', label: 'Anahtar' },
        { id: 'settings', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>', label: 'Ayarlar' },
        { id: 'crown', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 18l3-10 5 5 2-9 2 9 5-5 3 10H2z"/><path d="M2 18h20v2H2z"/></svg>', label: 'TaÃ§' }
    ],
    'Operasyon': [
        { id: 'clipboard', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>', label: 'Checklist' },
        { id: 'calendar', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>', label: 'Takvim' },
        { id: 'clock', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>', label: 'Saat' },
        { id: 'bell', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>', label: 'Bildirim' },
        { id: 'check', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>', label: 'Onay' },
        { id: 'activity', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>', label: 'Aktivite' },
        { id: 'layers', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>', label: 'Katman' }
    ],
    'Finans': [
        { id: 'dollar', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>', label: 'Para' },
        { id: 'creditcard', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>', label: 'Kart' },
        { id: 'trending', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>', label: 'Trend' },
        { id: 'piechart', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.21 15.89A10 10 0 118 2.83"/><path d="M22 12A10 10 0 0012 2v10z"/></svg>', label: 'Grafik' },
        { id: 'percent', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="5" x2="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></svg>', label: 'YÃ¼zde' }
    ],
    'DiÄŸer': [
        { id: 'coffee', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8h1a4 4 0 010 8h-1"/><path d="M2 8h16v9a4 4 0 01-4 4H6a4 4 0 01-4-4V8z"/></svg>', label: 'Kahve' },
        { id: 'heart', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>', label: 'Kalp' },
        { id: 'zap', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>', label: 'Enerji' },
        { id: 'sun', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>', label: 'GÃ¼neÅŸ' },
        { id: 'moon', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>', label: 'Ay' },
        { id: 'flag', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></svg>', label: 'Bayrak' }
    ]
};

// Ä°kon ID'sinden SVG HTML dÃ¶ndÃ¼r
function getPositionIconHtml(iconId, size = 24) {
    // Emoji kontrolÃ¼ (eski veriler iÃ§in)
    if (iconId && iconId.length <= 4 && /[\u{1F300}-\u{1F9FF}]/u.test(iconId)) {
        return `<span style="font-size:${size}px">${iconId}</span>`;
    }
    
    // ICON_LIBRARY'den bul
    const icon = Object.values(ICON_LIBRARY).flat().find(i => i.id === iconId);
    if (icon) {
        return `<span style="width:${size}px;height:${size}px;display:inline-flex;align-items:center;justify-content:center;color:var(--tx)">${icon.svg}</span>`;
    }
    
    // VarsayÄ±lan user ikonu
    const defaultIcon = ICON_LIBRARY['Pozisyon'].find(i => i.id === 'user');
    return `<span style="width:${size}px;height:${size}px;display:inline-flex;align-items:center;justify-content:center;color:var(--tx)">${defaultIcon?.svg || 'ðŸ‘¤'}</span>`;
}

// Geriye uyumluluk iÃ§in emoji mapping
const EMOJI_TO_ICON = {
    'ðŸ‘¤': 'user', 'ðŸ§‘â€ðŸ³': 'chef', 'ðŸ‘”': 'briefcase', 'ðŸª': 'store', 'ðŸŒ': 'globe',
    'â­': 'star', 'ðŸŽ¯': 'target', 'ðŸ”‘': 'key', 'âš™ï¸': 'settings', 'ðŸ“‹': 'clipboard',
    'ðŸ“…': 'calendar', 'â°': 'clock', 'ðŸ””': 'bell', 'âœ…': 'check', 'ðŸ’°': 'dollar',
    'â˜•': 'coffee', 'â¤ï¸': 'heart', 'âš¡': 'zap'
};

// Icon ID'den SVG al
function getIconSvgById(iconId) {
    if (!iconId) return null;
    // Emoji ise ID'ye Ã§evir
    if (EMOJI_TO_ICON[iconId]) {
        iconId = EMOJI_TO_ICON[iconId];
    }
    // ICON_LIBRARY'den bul
    for (const icons of Object.values(ICON_LIBRARY)) {
        const found = icons.find(i => i.id === iconId);
        if (found) {
            return `<span style="width:24px;height:24px">${found.svg}</span>`;
        }
    }
    return null;
}

function toggleEmojiPicker(inputId) {
    const pickerId = 'emojiPicker' + inputId.charAt(0).toUpperCase() + inputId.slice(1);
    const picker = document.getElementById(pickerId);
    if (!picker) return;
    
    if (picker.style.display === 'none') {
        renderIconPicker(picker, inputId);
        picker.style.display = 'block';
    } else {
        picker.style.display = 'none';
    }
}

function renderIconPicker(container, inputId) {
    let html = '<div style="background:var(--bg2);border:1px solid var(--cardBorder);border-radius:12px;padding:16px;margin-top:12px;max-height:320px;overflow-y:auto">';
    
    for (const [category, icons] of Object.entries(ICON_LIBRARY)) {
        html += `<div style="margin-bottom:14px">
            <div style="font-size:.7rem;color:var(--tx3);margin-bottom:8px;font-weight:600;text-transform:uppercase;letter-spacing:.5px">${category}</div>
            <div style="display:flex;flex-wrap:wrap;gap:6px">
                ${icons.map(icon => `
                    <button type="button" onclick="selectIcon('${inputId}', '${icon.id}')" 
                        style="width:42px;height:42px;border:1px solid var(--cardBorder);background:var(--bg3);border-radius:8px;cursor:pointer;transition:all .12s;display:flex;align-items:center;justify-content:center;color:var(--tx2)"
                        onmouseover="this.style.background='var(--bg4)';this.style.borderColor='#008c95';this.style.color='#008c95'"
                        onmouseout="this.style.background='var(--bg3)';this.style.borderColor='var(--cardBorder)';this.style.color='var(--tx2)'"
                        title="${icon.label}">
                        <span style="width:20px;height:20px">${icon.svg}</span>
                    </button>
                `).join('')}
            </div>
        </div>`;
    }
    
    html += '</div>';
    container.innerHTML = html;
}

function selectIcon(inputId, iconId) {
    // Hidden input'u gÃ¼ncelle
    const input = document.getElementById(inputId);
    if (input) input.value = iconId;
    
    // Preview'Ä± gÃ¼ncelle
    const preview = document.getElementById(inputId + 'Preview');
    if (preview) {
        const icon = Object.values(ICON_LIBRARY).flat().find(i => i.id === iconId);
        if (icon) {
            preview.innerHTML = `<span style="width:24px;height:24px;color:var(--tx)">${icon.svg}</span>`;
        }
    }
    
    // Picker'Ä± kapat
    const pickerId = 'emojiPicker' + inputId.charAt(0).toUpperCase() + inputId.slice(1);
    const picker = document.getElementById(pickerId);
    if (picker) picker.style.display = 'none';
}

// Eski emoji seÃ§imi iÃ§in geriye uyumluluk
function selectEmoji(inputId, emoji) {
    const iconId = EMOJI_TO_ICON[emoji] || 'user';
    selectIcon(inputId, iconId);
}

function savePosition() {
    const id = getVal('newPosId');
    const name = getVal('newPosName');
    const type = getVal('newPosType');
    const role = getVal('newPosRole');
    const icon = getVal('newPosIcon') || 'ðŸ‘¤';
    const level = parseInt(getVal('newPosLevel')) || 1;
    
    if (!id || !name) {
        toast('ID ve Ad zorunludur', 'error');
        return;
    }
    
    // ID kontrolÃ¼ - mevcut mu?
    if (STATE.positions.find(p => p.id === id)) {
        toast('Bu ID zaten kullanÄ±lÄ±yor', 'error');
        return;
    }
    
    STATE.positions.push({ id, name, type, role, icon, level });
    if (!STATE.templates[id]) STATE.templates[id] = '';
    
    // Yetki varsayÄ±lanlarÄ±nÄ± oluÅŸtur (rol bazlÄ±)
    if (!STATE.rolePermissions) STATE.rolePermissions = {};
    if (!STATE.rolePermissions[id]) {
        // SeÃ§ilen rolÃ¼n varsayÄ±lan yetkilerini kopyala
        const basePerms = STATE.rolePermissions[role] || getDefaultPermissions(role);
        STATE.rolePermissions[id] = JSON.parse(JSON.stringify(basePerms));
    }
    
    saveState();
    populateSelects();
    renderPositionCards();
    renderPositionListCombined();
    renderDynamicPositionCards();
    renderAdminLists();
    closeModal();
    toast('Pozisyon eklendi', 'success');
}

function editPosition(i) {
    const p = STATE.positions[i];
    const roles = [
        { id: 'barista', name: 'Barista (SÄ±nÄ±rlÄ± Yetki)', defaultLevel: 1 },
        { id: 'mudur_yardimcisi', name: 'MÃ¼dÃ¼r YardÄ±mcÄ±sÄ± (Orta Yetki)', defaultLevel: 2 },
        { id: 'magaza_muduru', name: 'MaÄŸaza MÃ¼dÃ¼rÃ¼ (GeniÅŸ Yetki)', defaultLevel: 3 },
        { id: 'bolge_muduru', name: 'BÃ¶lge MÃ¼dÃ¼rÃ¼ (Tam Yetki)', defaultLevel: 4 }
    ];
    
    // Mevcut level veya role'e gÃ¶re varsayÄ±lan
    const currentLevel = p.level || (roles.find(r => r.id === p.role)?.defaultLevel || 1);
    
    showModal('Pozisyon DÃ¼zenle', `
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">Pozisyon ID</label>
                <input type="text" id="editPosId" class="form-input" value="${p.id}">
            </div>
            <div class="form-group">
                <label class="form-label">Pozisyon AdÄ±</label>
                <input type="text" id="editPosName" class="form-input" value="${p.name}">
            </div>
            <div class="form-group">
                <label class="form-label">Yaka Tipi</label>
                <select id="editPosType" class="form-select">
                    <option value="Mavi Yaka" ${p.type==='Mavi Yaka'?'selected':''}>Mavi Yaka</option>
                    <option value="Gri Yaka" ${p.type==='Gri Yaka'?'selected':''}>Gri Yaka</option>
                    <option value="Beyaz Yaka" ${p.type==='Beyaz Yaka'?'selected':''}>Beyaz Yaka</option>
                    <option value="Stratejik" ${p.type==='Stratejik'?'selected':''}>Stratejik</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Sistem RolÃ¼</label>
                <select id="editPosRole" class="form-select" onchange="updateLevelFromRole()">
                    ${roles.map(r => `<option value="${r.id}" data-level="${r.defaultLevel}" ${p.role===r.id?'selected':''}>${r.name}</option>`).join('')}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">HiyerarÅŸi Seviyesi</label>
                <select id="editPosLevel" class="form-select">
                    <option value="1" ${currentLevel===1?'selected':''}>1 - En Alt (Barista)</option>
                    <option value="2" ${currentLevel===2?'selected':''}>2 - Alt-Orta (MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±)</option>
                    <option value="3" ${currentLevel===3?'selected':''}>3 - Orta (MaÄŸaza MÃ¼dÃ¼rÃ¼)</option>
                    <option value="4" ${currentLevel===4?'selected':''}>4 - Ãœst (BÃ¶lge MÃ¼dÃ¼rÃ¼)</option>
                    <option value="5" ${currentLevel===5?'selected':''}>5 - En Ãœst (YÃ¶netici)</option>
                </select>
                <small style="color:var(--tx2);font-size:.7rem">DÃ¼ÅŸÃ¼k seviye, yÃ¼ksek seviyeyi dÃ¼zenleyemez</small>
            </div>
            <div class="form-group full">
                <label class="form-label">Ä°kon</label>
                <div style="display:flex;align-items:center;gap:12px">
                    <div id="editPosIconPreview" style="width:48px;height:48px;display:flex;align-items:center;justify-content:center;background:var(--bg3);border-radius:12px;cursor:pointer;color:var(--tx)" onclick="toggleEmojiPicker('editPosIcon')">
                        ${getIconSvgById(p.icon) || '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>'}
                    </div>
                    <input type="hidden" id="editPosIcon" value="${p.icon || 'user'}">
                    <button type="button" class="btn btn-ghost btn-sm" onclick="toggleEmojiPicker('editPosIcon')">Ä°kon SeÃ§</button>
                </div>
                <div id="emojiPickerEditPosIcon" class="emoji-picker" style="display:none"></div>
            </div>
        </div>
    `, `
        <button class="btn btn-ghost" onclick="closeModal()">Ä°ptal</button>
        <button class="btn btn-primary" onclick="updatePosition(${i})">Kaydet</button>
    `);
}

function updatePosition(i) {
    const oldId = STATE.positions[i].id;
    const newId = getVal('editPosId');
    const role = getVal('editPosRole');
    const icon = getVal('editPosIcon') || 'ðŸ‘¤';
    const level = parseInt(getVal('editPosLevel')) || 1;
    
    STATE.positions[i] = {
        id: newId,
        name: getVal('editPosName'),
        type: getVal('editPosType'),
        role: role,
        icon: icon,
        level: level
    };
    
    // Template'i taÅŸÄ±
    if (oldId !== newId && STATE.templates[oldId]) {
        STATE.templates[newId] = STATE.templates[oldId];
        delete STATE.templates[oldId];
    }
    
    // Yetkileri taÅŸÄ±
    if (oldId !== newId && STATE.rolePermissions && STATE.rolePermissions[oldId]) {
        STATE.rolePermissions[newId] = STATE.rolePermissions[oldId];
        delete STATE.rolePermissions[oldId];
    }
    
    saveState();
    populateSelects();
    renderPositionCards();
    renderPositionListCombined();
    renderDynamicPositionCards();
    renderAdminLists();
    closeModal();
    toast('GÃ¼ncellendi', 'success');
}

function deletePosition(i) {
    confirmModal('Pozisyon Sil', `"${STATE.positions[i].name}" pozisyonunu silmek istediÄŸinize emin misiniz?`, () => {
        const id = STATE.positions[i].id;
        STATE.positions.splice(i, 1);
        delete STATE.templates[id];
        saveState();
        populateSelects();
        renderPositionCards();
        renderAdminLists();
        toast('Pozisyon silindi', 'success');
    }, 'danger');
}

// ========== VIOLATIONS ==========
function addViolation() {
    showModal('Ä°hlal Ekle', `
        <div class="form-grid">
            <div class="form-group"><label class="form-label">Kod</label><input type="text" id="newViolId" class="form-input" placeholder="V19"></div>
            <div class="form-group"><label class="form-label">BaÅŸlÄ±k</label><input type="text" id="newViolTitle" class="form-input"></div>
            <div class="form-group"><label class="form-label">Risk</label>
                <select id="newViolRisk" class="form-select"><option value="low">DÃ¼ÅŸÃ¼k</option><option value="medium">Orta</option><option value="high">YÃ¼ksek</option></select>
            </div>
            <div class="form-group"><label class="form-label">Yasal Dayanak</label><input type="text" id="newViolLegal" class="form-input" placeholder="Ä°ÅŸ K. 25/II-x"></div>
            <div class="form-group full"><label class="form-label">AÃ§Ä±klama</label><input type="text" id="newViolDesc" class="form-input"></div>
            <div class="form-group full"><label class="form-label">ProsedÃ¼r AdÄ±mlarÄ± (virgÃ¼lle ayÄ±rÄ±n)</label><input type="text" id="newViolSteps" class="form-input" placeholder="Tutanak,Savunma,Ä°htar"></div>
        </div>
    `, `
        <button class="btn btn-ghost" onclick="closeModal()">Ä°ptal</button>
        <button class="btn btn-primary" onclick="saveViolation()">Ekle</button>
    `);
}

function saveViolation() {
    const v = {
        id: getVal('newViolId'),
        title: getVal('newViolTitle'),
        risk: getVal('newViolRisk'),
        legal: getVal('newViolLegal'),
        desc: getVal('newViolDesc'),
        steps: getVal('newViolSteps').split(',').map(s => s.trim()).filter(s => s)
    };
    if (v.id && v.title) {
        STATE.violations.push(v);
        saveState();
        renderViolations();
        renderAdminLists();
        closeModal();
        toast('Ä°hlal eklendi', 'success');
    }
}

function editViolation(i) {
    const v = STATE.violations[i];
    showModal('Ä°hlal DÃ¼zenle', `
        <div class="form-grid">
            <div class="form-group"><label class="form-label">Kod</label><input type="text" id="editViolId" class="form-input" value="${v.id}"></div>
            <div class="form-group"><label class="form-label">BaÅŸlÄ±k</label><input type="text" id="editViolTitle" class="form-input" value="${v.title}"></div>
            <div class="form-group"><label class="form-label">Risk</label>
                <select id="editViolRisk" class="form-select">
                    <option value="low" ${v.risk==='low'?'selected':''}>DÃ¼ÅŸÃ¼k</option>
                    <option value="medium" ${v.risk==='medium'?'selected':''}>Orta</option>
                    <option value="high" ${v.risk==='high'?'selected':''}>YÃ¼ksek</option>
                </select>
            </div>
            <div class="form-group"><label class="form-label">Yasal Dayanak</label><input type="text" id="editViolLegal" class="form-input" value="${v.legal}"></div>
            <div class="form-group full"><label class="form-label">AÃ§Ä±klama</label><input type="text" id="editViolDesc" class="form-input" value="${v.desc}"></div>
            <div class="form-group full"><label class="form-label">ProsedÃ¼r AdÄ±mlarÄ±</label><input type="text" id="editViolSteps" class="form-input" value="${v.steps.join(', ')}"></div>
        </div>
    `, `
        <button class="btn btn-ghost" onclick="closeModal()">Ä°ptal</button>
        <button class="btn btn-primary" onclick="updateViolation(${i})">Kaydet</button>
    `);
}

function updateViolation(i) {
    STATE.violations[i] = {
        id: getVal('editViolId'),
        title: getVal('editViolTitle'),
        risk: getVal('editViolRisk'),
        legal: getVal('editViolLegal'),
        desc: getVal('editViolDesc'),
        steps: getVal('editViolSteps').split(',').map(s => s.trim()).filter(s => s)
    };
    saveState();
    renderViolations();
    renderAdminLists();
    closeModal();
    toast('GÃ¼ncellendi', 'success');
}

function deleteViolation(i) {
    confirmModal('Ä°hlal Sil', `"${STATE.violations[i].title}" ihlalini silmek istediÄŸinize emin misiniz?`, () => {
        STATE.violations.splice(i, 1);
        saveState();
        renderViolations();
        renderAdminLists();
        toast('Ä°hlal silindi', 'success');
    }, 'danger');
}

// ========== TEMPLATES ==========
function loadTemplate() {
    const sel = document.getElementById('template_pozisyon');
    const content = document.getElementById('template_content');
    if (sel && content) {
        const posId = sel.value;
        content.value = STATE.templates[posId] || '';
    }
}

function saveTemplate() {
    const posId = document.getElementById('template_pozisyon').value;
    const content = document.getElementById('template_content').value;
    STATE.templates[posId] = content;
    saveState();
    toast('Åžablon kaydedildi', 'success');
}

// ========== SYNC ==========
function generateExportCode() {
    try {
        const json = JSON.stringify(STATE);
        const compressed = LZString.compressToBase64(json);
        document.getElementById('exportCode').value = compressed;
        toast('Kod oluÅŸturuldu', 'success');
    } catch(e) {
        toast('Kod oluÅŸturulamadÄ±', 'error');
    }
}

function copyExportCode() {
    const code = document.getElementById('exportCode').value;
    if (code) {
        navigator.clipboard.writeText(code).then(() => {
            toast('KopyalandÄ±!', 'success');
        }).catch(() => {
            // Fallback
            const ta = document.createElement('textarea');
            ta.value = code;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
            toast('KopyalandÄ±!', 'success');
        });
    }
}

function importCode() {
    const code = document.getElementById('importCode').value.trim();
    if (!code) {
        toast('Kod boÅŸ', 'error');
        return;
    }
    
    confirmModal('Ä°Ã§e Aktar', 'Mevcut tÃ¼m ayarlarÄ±nÄ±z deÄŸiÅŸtirilecek. Emin misiniz?', () => {
        try {
            const json = LZString.decompressFromBase64(code);
            if (!json) throw new Error('Invalid');
            const data = JSON.parse(json);
            
            // Validate basic structure
            if (!data.pin || !data.company || !data.branches) {
                throw new Error('Invalid structure');
            }
            
            STATE = {...DEFAULT_STATE, ...data};
            saveState();
            initUI();
            document.getElementById('importCode').value = '';
            successModal('Veriler baÅŸarÄ±yla iÃ§e aktarÄ±ldÄ±!');
        } catch(e) {
            toast('GeÃ§ersiz kod!', 'error');
        }
    }, 'danger');
}

// ========== DOSYA YEDEKLEMESÄ° ==========
function downloadBackup() {
    try {
        const data = JSON.stringify(STATE, null, 2);
        const blob = new Blob([data], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const date = new Date().toISOString().split('T')[0];
        a.href = url;
        a.download = `moonberry-ik-yedek-${date}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        toast('Yedek dosyasÄ± indirildi', 'success');
    } catch(e) {
        toast('Yedek oluÅŸturulamadÄ±', 'error');
    }
}

function uploadBackup(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!file.name.endsWith('.json')) {
        toast('Sadece .json dosyasÄ± yÃ¼kleyebilirsiniz', 'error');
        return;
    }
    
    confirmModal('Yedek YÃ¼kle', `"${file.name}" dosyasÄ±nÄ± yÃ¼klemek istediÄŸinize emin misiniz? Mevcut tÃ¼m ayarlarÄ±nÄ±z deÄŸiÅŸtirilecek.`, () => {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                
                // Validate basic structure
                if (!data.pin || !data.company || !data.branches) {
                    throw new Error('Invalid structure');
                }
                
                STATE = {...DEFAULT_STATE, ...data};
                saveState();
                initUI();
                successModal('Yedek baÅŸarÄ±yla yÃ¼klendi!');
            } catch(err) {
                toast('GeÃ§ersiz yedek dosyasÄ±!', 'error');
            }
        };
        reader.onerror = () => toast('Dosya okunamadÄ±', 'error');
        reader.readAsText(file);
    }, 'danger');
    
    // Reset input
    event.target.value = '';
}

// Drag & Drop desteÄŸi
document.addEventListener('DOMContentLoaded', () => {
    const dropZone = document.getElementById('dropZone');
    if (dropZone) {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
        });
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.style.borderColor = 'var(--green)';
                dropZone.style.background = 'var(--bg)';
            });
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.style.borderColor = 'var(--accent)';
                dropZone.style.background = '';
            });
        });
        
        dropZone.addEventListener('drop', (e) => {
            const file = e.dataTransfer.files[0];
            if (file) {
                document.getElementById('backupFileInput').files = e.dataTransfer.files;
                uploadBackup({target: {files: [file], value: ''}});
            }
        });
    }
});

// ========== BELGE ÅžABLONLARI ==========
let currentDocTemplateCategory = 'tutanak';
let currentDocTemplateSubType = 'olay';
let originalDocTemplateContent = '';
let hasUnsavedDocChanges = false;

function selectDocTemplateCategory(category) {
    // KaydedilmemiÅŸ deÄŸiÅŸiklik kontrolÃ¼
    if (hasUnsavedDocChanges) {
        showUnsavedChangesModal(() => {
            saveDocTemplate();
            switchDocTemplateCategory(category);
        }, () => {
            hasUnsavedDocChanges = false;
            switchDocTemplateCategory(category);
        });
        return;
    }
    switchDocTemplateCategory(category);
}

function switchDocTemplateCategory(category) {
    currentDocTemplateCategory = category;
    
    // ButonlarÄ± gÃ¼ncelle
    document.querySelectorAll('#admin-belgeler .btn-group .btn').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-ghost');
    });
    event.target.classList.remove('btn-ghost');
    event.target.classList.add('btn-primary');
    
    // Panelleri gizle/gÃ¶ster
    document.querySelectorAll('.doc-template-panel').forEach(p => p.style.display = 'none');
    const panel = document.getElementById('docTemplate-' + category);
    if (panel) panel.style.display = 'block';
    
    // Alt tÃ¼rÃ¼ belirle
    if (category === 'tutanak') {
        currentDocTemplateSubType = document.getElementById('tutanak_sub_type')?.value || 'olay';
    } else if (category === 'fesih') {
        currentDocTemplateSubType = document.getElementById('fesih_sub_type')?.value || 'hakli';
    } else {
        currentDocTemplateSubType = null;
    }
    
    loadDocTemplate(category, currentDocTemplateSubType);
}

function loadDocTemplate(category, subType) {
    currentDocTemplateCategory = category;
    currentDocTemplateSubType = subType;
    
    let template = '';
    const templates = STATE.documentTemplates || DEFAULT_STATE.documentTemplates;
    
    if (subType && templates[category] && typeof templates[category] === 'object') {
        template = templates[category][subType] || DEFAULT_STATE.documentTemplates[category][subType] || '';
    } else {
        template = templates[category] || DEFAULT_STATE.documentTemplates[category] || '';
    }
    
    const textarea = document.getElementById('doc_template_content');
    if (textarea) {
        textarea.value = template;
        originalDocTemplateContent = template;
        hasUnsavedDocChanges = false;
        updateUnsavedIndicator();
    }
}

function trackDocTemplateChanges() {
    const textarea = document.getElementById('doc_template_content');
    if (textarea) {
        hasUnsavedDocChanges = textarea.value !== originalDocTemplateContent;
        updateUnsavedIndicator();
    }
}

function updateUnsavedIndicator() {
    const indicator = document.getElementById('docTemplateUnsaved');
    if (indicator) {
        indicator.style.display = hasUnsavedDocChanges ? 'block' : 'none';
    }
}

function saveDocTemplate() {
    const textarea = document.getElementById('doc_template_content');
    if (!textarea) return;
    
    const content = textarea.value;
    
    // documentTemplates yoksa oluÅŸtur
    if (!STATE.documentTemplates) {
        STATE.documentTemplates = JSON.parse(JSON.stringify(DEFAULT_STATE.documentTemplates));
    }
    
    if (currentDocTemplateSubType && typeof STATE.documentTemplates[currentDocTemplateCategory] === 'object') {
        STATE.documentTemplates[currentDocTemplateCategory][currentDocTemplateSubType] = content;
    } else {
        STATE.documentTemplates[currentDocTemplateCategory] = content;
    }
    
    saveState();
    originalDocTemplateContent = content;
    hasUnsavedDocChanges = false;
    updateUnsavedIndicator();
    toast('Åžablon kaydedildi', 'success');
}

function resetDocTemplate() {
    confirmModal('VarsayÄ±lana DÃ¶n', 'Bu ÅŸablonu varsayÄ±lan haline dÃ¶ndÃ¼rmek istediÄŸinize emin misiniz?', () => {
        let defaultTemplate = '';
        
        if (currentDocTemplateSubType && typeof DEFAULT_STATE.documentTemplates[currentDocTemplateCategory] === 'object') {
            defaultTemplate = DEFAULT_STATE.documentTemplates[currentDocTemplateCategory][currentDocTemplateSubType];
        } else {
            defaultTemplate = DEFAULT_STATE.documentTemplates[currentDocTemplateCategory];
        }
        
        const textarea = document.getElementById('doc_template_content');
        if (textarea) {
            textarea.value = defaultTemplate;
            
            // STATE'i de gÃ¼ncelle
            if (!STATE.documentTemplates) {
                STATE.documentTemplates = JSON.parse(JSON.stringify(DEFAULT_STATE.documentTemplates));
            }
            
            if (currentDocTemplateSubType && typeof STATE.documentTemplates[currentDocTemplateCategory] === 'object') {
                STATE.documentTemplates[currentDocTemplateCategory][currentDocTemplateSubType] = defaultTemplate;
            } else {
                STATE.documentTemplates[currentDocTemplateCategory] = defaultTemplate;
            }
            
            saveState();
            originalDocTemplateContent = defaultTemplate;
            hasUnsavedDocChanges = false;
            updateUnsavedIndicator();
            toast('VarsayÄ±lana dÃ¶ndÃ¼rÃ¼ldÃ¼', 'success');
        }
    }, 'warning');
}

function previewDocTemplate() {
    const content = document.getElementById('doc_template_content')?.value || '';
    
    // Ã–rnek verilerle doldur
    const preview = content
        .replace(/\{\{PERSONEL\}\}/g, 'Ã–rnek Personel')
        .replace(/\{\{TC\}\}/g, '12345678901')
        .replace(/\{\{SUBE\}\}/g, 'ÅžiÅŸli (Merkez)')
        .replace(/\{\{TARIH\}\}/g, today())
        .replace(/\{\{SAAT\}\}/g, nowTime())
        .replace(/\{\{ACIKLAMA\}\}/g, 'Ã–rnek aÃ§Ä±klama metni burada gÃ¶rÃ¼necektir.')
        .replace(/\{\{DAYANAK\}\}/g, '25/II-e')
        .replace(/\{\{SURE\}\}/g, '1 iÅŸ gÃ¼nÃ¼')
        .replace(/\{\{POZISYON\}\}/g, 'Barista')
        .replace(/\{\{TUTAR\}\}/g, '500')
        .replace(/\{\{ODEME_SEKLI\}\}/g, 'maaÅŸtan tek seferde mahsup edilmesini')
        .replace(/\{\{IHBAR_SURE\}\}/g, '4 hafta')
        .replace(/\{\{SON_GUN\}\}/g, today())
        .replace(/\{\{BASLAMA\}\}/g, today());
    
    const categoryTitles = {
        tutanak: {olay: 'OLAY TESPÄ°T TUTANAÄžI', devamsizlik: 'DEVAMSIZLIK TUTANAÄžI', kasa: 'KASA AÃ‡IÄžI TUTANAÄžI', imza: 'Ä°MZADAN Ä°MTÄ°NA TUTANAÄžI'},
        savunma: 'SAVUNMA Ä°STEME YAZISI',
        fesih: {hakli: 'HAKLI FESÄ°H BÄ°LDÄ°RÄ°MÄ°', gecerli: 'GEÃ‡ERLÄ° FESÄ°H BÄ°LDÄ°RÄ°MÄ°', deneme: 'DENEME SÃœRESÄ° FESHÄ°'},
        borc: 'BORÃ‡ Ä°KRAR VE MAHSUP MUVAFAKATNAMESÄ°'
    };
    
    let title = '';
    if (currentDocTemplateSubType && typeof categoryTitles[currentDocTemplateCategory] === 'object') {
        title = categoryTitles[currentDocTemplateCategory][currentDocTemplateSubType];
    } else {
        title = categoryTitles[currentDocTemplateCategory];
    }
    
    const html = `<div class="doc">
        ${docHeader(title)}
        <div class="doc-section">${preview}</div>
        ${docSignature(
            {title: 'Ä°ÅžVEREN', name: '(KAÅžE)', role: 'Ä°mza'},
            {title: 'PERSONEL', name: 'Ã–rnek Personel', role: 'Ä°mza'}
        )}
    </div>`;
    
    showPreview('Åžablon Ã–nizleme - ' + title, html);
}

function showUnsavedChangesModal(onSave, onDiscard) {
    openModal('KaydedilmemiÅŸ DeÄŸiÅŸiklikler', `
        <div class="modal-icon warning">âš ï¸</div>
        <p class="modal-message">Åžablonda kaydedilmemiÅŸ deÄŸiÅŸiklikler var.<br>Ne yapmak istersiniz?</p>
    `, `
        <button class="btn btn-ghost" onclick="closeModal()">Ä°ptal</button>
        <button class="btn" style="background:var(--red);color:#fff" onclick="closeModal();(${onDiscard.toString()})()">Kaydetme</button>
        <button class="btn btn-primary" onclick="closeModal();(${onSave.toString()})()">Kaydet</button>
    `);
}

// Sayfa deÄŸiÅŸtirirken kontrol
const originalGoTo = goTo;
goTo = function(page) {
    if (hasUnsavedDocChanges && currentPage === 'admin') {
        showUnsavedChangesModal(() => {
            saveDocTemplate();
            hasUnsavedDocChanges = false;
            originalGoTo(page);
        }, () => {
            hasUnsavedDocChanges = false;
            originalGoTo(page);
        });
        return;
    }
    originalGoTo(page);
};

// TarayÄ±cÄ± kapatma/yenileme korumasÄ±
window.addEventListener('beforeunload', (e) => {
    // TarayÄ±cÄ± kapatÄ±lÄ±nca Ã§Ä±kÄ±ÅŸ yap ayarÄ± aktifse oturumu sonlandÄ±r
    const logoutOnClose = document.getElementById('sessionLogoutOnClose')?.checked;
    if (logoutOnClose && currentUser?.sessionId) {
        // Senkron olarak oturumu sonlandÄ±rmaya Ã§alÄ±ÅŸ (best effort)
        navigator.sendBeacon && navigator.sendBeacon('/api/end-session', JSON.stringify({ sessionId: currentUser.sessionId }));
    }
    
    if (hasUnsavedDocChanges) {
        e.preventDefault();
        e.returnValue = 'KaydedilmemiÅŸ deÄŸiÅŸiklikler var. Sayfadan ayrÄ±lmak istediÄŸinize emin misiniz?';
        return e.returnValue;
    }
});

// Visibility change - sayfa gizlendiÄŸinde aktiviteyi duraklat
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible' && currentUser?.sessionId) {
        // Sayfa tekrar gÃ¶rÃ¼nÃ¼r olduÄŸunda aktiviteyi gÃ¼ncelle
        updateSessionActivity();
    }
});

// ==================== PERSONEL YÃ–NETÄ°MÄ° ====================

// HiyerarÅŸi seviyesi hesaplama (dinamik - STATE.positions'dan)
function getHierarchyLevel(role, position) {
    // YÃ¶netici her zaman en Ã¼st
    if (role === 'yonetici') return 5;
    
    // Pozisyona gÃ¶re seviye bul
    const pos = STATE.positions.find(p => p.name === position || p.role === role);
    if (pos?.level) return pos.level;
    
    // VarsayÄ±lan role mapping (pozisyonda level yoksa)
    const defaultLevels = {
        'barista': 1,
        'mudur_yardimcisi': 2,
        'magaza_mudur_yardimcisi': 2,
        'magaza_muduru': 3,
        'bolge_muduru': 4,
        'yonetici': 5
    };
    return defaultLevels[role] || 1;
}

// DÃ¼zenleme/silme yetkisi var mÄ±?
function canEditPersonel(targetRole, targetPosition, targetEmail) {
    // YÃ¶netici her ÅŸeyi dÃ¼zenleyebilir
    if (currentUser?.role === 'yonetici') return true;
    
    // Kendi kartÄ±nÄ± herkes dÃ¼zenleyebilir
    if (currentUser?.email === targetEmail) return true;
    
    // Personel yetkisi yoksa hiÃ§ dÃ¼zenleyemez
    const perms = window.userAdvancedPermissions;
    if (!perms?.pages?.personel?.edit) return false;
    
    // HiyerarÅŸi kontrolÃ¼
    const myLevel = getHierarchyLevel(currentUser?.role, null);
    const targetLevel = getHierarchyLevel(targetRole, targetPosition);
    
    // Sadece altÄ±ndakileri dÃ¼zenleyebilir (eÅŸit seviye dahil)
    return myLevel >= targetLevel;
}

async function loadPersonelList() {
    const container = document.getElementById('personelListContainer');
    if (!container) return;
    
    // "Yeni Personel" butonu yetki kontrolÃ¼
    const btnNewPersonel = document.getElementById('btnNewPersonel');
    if (btnNewPersonel) {
        const isYonetici = currentUser?.role === 'yonetici';
        const perms = window.userAdvancedPermissions;
        const canAddPersonel = isYonetici || perms?.pages?.personel?.add === true;
        btnNewPersonel.style.display = canAddPersonel ? '' : 'none';
        console.log('[Personel] Yeni Personel butonu:', canAddPersonel ? 'gÃ¶rÃ¼nÃ¼r' : 'gizli');
    }
    
    container.innerHTML = '<p style="color:var(--tx2);text-align:center;padding:20px">YÃ¼kleniyor...</p>';
    
    try {
        // MaÄŸaza mÃ¼dÃ¼rÃ¼ iÃ§in ÅŸube filtresi
        const isFullAdmin = ['yonetici', 'bolge_muduru'].includes(currentUser?.role);
        const isYonetici = currentUser?.role === 'yonetici';
        const userBranch = currentUser?.branch;
        
        // Åžifre yetkileri (dinamik)
        const perms = window.userAdvancedPermissions;
        const canViewPassword = isYonetici || perms?.special?.view_password;
        const canAssignPassword = isYonetici || perms?.special?.assign_password;
        const canChangePassword = isYonetici || perms?.special?.change_others_password;
        
        // KullanÄ±cÄ±nÄ±n hiyerarÅŸi seviyesi
        const myLevel = getHierarchyLevel(currentUser?.role, null);
        
        let query = db.collection('personel').orderBy('name');
        let bolgeMuduruDocs = []; // branch='all' olanlar iÃ§in
        
        // MaÄŸaza mÃ¼dÃ¼rÃ¼ sadece kendi ÅŸubesinin personelini gÃ¶rebilir
        if (!isFullAdmin && userBranch && userBranch !== 'all') {
            query = db.collection('personel').where('branch', '==', userBranch);
            
            // BÃ¶lge mÃ¼dÃ¼rlerini de Ã§ek (branch='all' - tÃ¼m ÅŸubelerde gÃ¶rÃ¼nÃ¼rler)
            const bolgeMuduruSnap = await db.collection('personel').where('branch', '==', 'all').get();
            bolgeMuduruDocs = bolgeMuduruSnap.docs;
        }
        
        const snapshot = await query.get();
        
        // Åžube personeli + bÃ¶lge mÃ¼dÃ¼rleri birleÅŸtir
        const allDocs = [...snapshot.docs, ...bolgeMuduruDocs];
        
        if (allDocs.length === 0) {
            container.innerHTML = '<p style="color:var(--tx2);text-align:center;padding:40px">HenÃ¼z personel kaydÄ± yok. "Yeni Personel" butonuna tÄ±klayarak ekleyin.</p>';
            return;
        }
        
        // Åžifre gÃ¶ster/gizle state
        window._showPasswords = window._showPasswords || false;
        
        // Pozisyondan rol belirleme (dinamik)
        function getRoleFromPosition(position) {
            // Ã–nce STATE.positions'dan dene
            const pos = STATE.positions?.find(p => p.name === position);
            if (pos?.role) return pos.role;
            
            // Fallback: Position ismine gÃ¶re tahmin et
            const posLower = (position || '').toLowerCase();
            if (posLower.includes('yÃ¶netici') || posLower.includes('admin')) return 'yonetici';
            if (posLower.includes('bÃ¶lge')) return 'bolge_muduru';
            if (posLower.includes('maÄŸaza mÃ¼dÃ¼rÃ¼') || posLower === 'mÃ¼dÃ¼r') return 'magaza_muduru';
            if (posLower.includes('yardÄ±mcÄ±') || posLower.includes('yrd')) return 'mudur_yardimcisi';
            
            // Default: barista
            return 'barista';
        }
        
        // === ROL STÄ°LLERÄ° - MARKA RENKLERÄ° ===
        // Barista: Sunberry coral (#ff8674)
        // MÃ¼dÃ¼r/YardÄ±mcÄ±: Moonberry teal (#008c95)
        // BÃ¶lge MÃ¼dÃ¼rÃ¼: Premium gold (#b8860b)
        // YÃ¶netici: Coral (#ff8674)
        const roleStyles = {
            'yonetici': { 
                name: 'YÃ¶netici', 
                badge: 'YÃ–NETÄ°CÄ°',
                color: '#ff8674', 
                gradient: 'linear-gradient(135deg,#ff8674,#ff6b5b)',
                icon: '<svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg>',
                premium: false
            },
            'bolge_muduru': { 
                name: 'BÃ¶lge MÃ¼dÃ¼rÃ¼', 
                badge: 'BÃ–LGE',
                color: '#b8860b', 
                gradient: 'linear-gradient(135deg,#b8860b,#daa520,#ffd700)',
                icon: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg>',
                premium: true
            },
            'magaza_muduru': { 
                name: 'MaÄŸaza MÃ¼dÃ¼rÃ¼', 
                badge: 'MÃœDÃœR',
                color: '#008c95', 
                gradient: 'linear-gradient(135deg,#008c95,#00a8a8)',
                icon: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>',
                premium: false
            },
            'magaza_mudur_yardimcisi': { 
                name: 'MÃ¼dÃ¼r Yrd.', 
                badge: 'YARDIMCI',
                color: '#008c95', 
                gradient: 'linear-gradient(135deg,#008c95,#00a8a8)',
                icon: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>',
                premium: false
            },
            'mudur_yardimcisi': { 
                name: 'MÃ¼dÃ¼r Yrd.', 
                badge: 'YARDIMCI',
                color: '#008c95', 
                gradient: 'linear-gradient(135deg,#008c95,#00a8a8)',
                icon: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>',
                premium: false
            },
            'barista': { 
                name: 'Barista', 
                badge: 'BARÄ°STA',
                color: '#ff8674', 
                gradient: 'linear-gradient(135deg,#ff8674,#ff9a8b)',
                icon: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 8h1a4 4 0 010 8h-1"/><path d="M2 8h16v9a4 4 0 01-4 4H6a4 4 0 01-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>',
                premium: false
            }
        };
        
        // SVG ikonlar
        const ICONS = {
            location: '<svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>',
            phone: '<svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/></svg>',
            mail: '<svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>',
            id: '<svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="16" rx="2"/><line x1="7" y1="8" x2="7" y2="8"/><line x1="7" y1="12" x2="17" y2="12"/><line x1="7" y1="16" x2="13" y2="16"/></svg>',
            unlock: '<svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 019.9-1"/></svg>',
            lock: '<svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>',
            key: '<svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 11-7.778 7.778 5.5 5.5 0 017.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>',
            edit: '<svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
            trash: '<svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>'
        };
        
        // Åžifre gÃ¶sterimi kaldÄ±rÄ±ldÄ± - sadece edit modalda gÃ¶rÃ¼necek
        let headerHtml = '';
        
        // Personelleri sÄ±rala: 1) HiyerarÅŸi seviyesi (yÃ¼ksek Ã¶nce), 2) GiriÅŸ tarihi (eski Ã¶nce)
        const sortedDocs = allDocs.sort((a, b) => {
            const pA = a.data();
            const pB = b.data();
            
            // HiyerarÅŸi seviyesi (yÃ¼ksek Ã¶nce)
            const roleA = pA.role || getRoleFromPosition(pA.position);
            const roleB = pB.role || getRoleFromPosition(pB.position);
            const levelA = getHierarchyLevel(roleA, pA.position);
            const levelB = getHierarchyLevel(roleB, pB.position);
            
            if (levelB !== levelA) return levelB - levelA; // YÃ¼ksek seviye Ã¶nce
            
            // GiriÅŸ tarihi (eski Ã¶nce)
            const dateA = pA.startDate ? new Date(pA.startDate) : new Date('9999-12-31');
            const dateB = pB.startDate ? new Date(pB.startDate) : new Date('9999-12-31');
            return dateA - dateB; // Eski tarih Ã¶nce
        });
        
        let html = headerHtml + '<div id="personelGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px">';
        sortedDocs.forEach(doc => {
            const p = doc.data();
            const docId = doc.id;
            
            if (!docId) return;
            
            const role = p.role || getRoleFromPosition(p.position);
            const roleInfo = roleStyles[role] || { 
                name: 'Personel', 
                badge: 'PERSONEL',
                color: '#ff8674', 
                gradient: 'linear-gradient(135deg,#ff8674,#ff9a8b)',
                icon: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
                premium: false
            };
            const hasAccess = !!(p.email && p.hasPassword);
            const isPremium = roleInfo.premium;
            
            // === SOL KENARLIK RENKLERÄ° ===
            // Barista/servis: Sunberry (#ff8674)
            // MÃ¼dÃ¼r/YardÄ±mcÄ±: Moonberry (#008c95)
            const isBarista = ['barista', 'part_time', 'kidemli_barista'].includes(role);
            const isMudur = ['magaza_muduru', 'mudur_yardimcisi', 'magaza_mudur_yardimcisi'].includes(role);
            const cardLeftBorder = isBarista ? '#ff8674' : (isMudur ? '#008c95' : roleInfo.color);
            
            // HiyerarÅŸi kontrolÃ¼
            const targetLevel = getHierarchyLevel(role, p.position);
            const canEdit = canEditPersonel(role, p.position, p.email);
            const isOwnCard = currentUser?.email === p.email;
            
            // Barista seviyesinde ve baÅŸkasÄ±nÄ±n kartÄ± ise kÄ±sÄ±tlÄ± gÃ¶rÃ¼nÃ¼m
            const showLimitedView = myLevel <= 1 && !isOwnCard && !isYonetici;
            
            // Kart arka plan ve gÃ¶lge
            const cardBg = isPremium 
                ? 'linear-gradient(135deg,rgba(184,134,11,.08),rgba(218,165,32,.04),rgba(255,215,0,.02))' 
                : `linear-gradient(135deg,${roleInfo.color}08,var(--bg2))`;
            const cardShadow = isPremium ? 'box-shadow:0 2px 12px rgba(184,134,11,.15);' : '';
            
            // Arama iÃ§in data attribute'lar
            const searchData = `${p.name || ''} ${p.branch || ''} ${p.tc || ''} ${p.email || ''} ${p.position || ''}`.toLowerCase();
            
            // Badge HTML
            const badgeHtml = isPremium
                ? `<span style="background:${roleInfo.gradient};color:#fff;padding:3px 8px;border-radius:5px;font-size:.6rem;font-weight:700;display:flex;align-items:center;gap:4px;box-shadow:0 2px 6px rgba(184,134,11,.3)">${roleInfo.icon} ${roleInfo.badge}</span>`
                : `<span style="background:${roleInfo.color}15;color:${roleInfo.color};padding:3px 8px;border-radius:5px;font-size:.6rem;font-weight:700;display:flex;align-items:center;gap:4px">${roleInfo.icon} ${roleInfo.badge}</span>`;
            
            html += `
                <div class="personel-card" data-search="${searchData}" data-branch="${p.branch || ''}" style="background:${cardBg};border:1px solid ${isPremium ? 'rgba(184,134,11,.2)' : 'var(--cardBorder)'};border-left:4px solid ${cardLeftBorder};border-radius:10px;padding:14px;transition:all .15s;${cardShadow}" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px ${isPremium ? 'rgba(184,134,11,.25)' : 'rgba(0,0,0,.08)'}'" onmouseout="this.style.transform='none';this.style.boxShadow='${isPremium ? '0 2px 12px rgba(184,134,11,.15)' : 'none'}'">
                    <!-- Header -->
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:${showLimitedView ? '0' : '10px'}">
                        <div style="width:40px;height:40px;background:${roleInfo.gradient};border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff;overflow:hidden;${isPremium ? 'box-shadow:0 2px 8px rgba(184,134,11,.4);' : ''}">
                            ${p.photoUrl ? `<img src="${p.photoUrl}" style="width:100%;height:100%;object-fit:cover">` : roleInfo.icon}
                        </div>
                        <div style="flex:1;min-width:0">
                            <div style="font-weight:600;color:var(--tx);font-size:.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.name || 'Ä°simsiz'}</div>
                            <div style="font-size:.75rem;color:${roleInfo.color};font-weight:500">${p.position || 'Pozisyon yok'}</div>
                        </div>
                        ${badgeHtml}
                    </div>
                    
                    ${showLimitedView ? '' : `
                    <!-- Info Grid - Sadece yetkisi olanlar gÃ¶rÃ¼r -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:.75rem;color:var(--tx2);margin-bottom:10px">
                        <div style="display:flex;align-items:center;gap:4px">${ICONS.location} ${p.branch || '-'}</div>
                        <div style="display:flex;align-items:center;gap:4px">${ICONS.phone} ${p.phone || '-'}</div>
                        <div style="display:flex;align-items:center;gap:4px;overflow:hidden">${ICONS.mail} <span style="overflow:hidden;text-overflow:ellipsis">${p.email || '-'}</span></div>
                        <div style="display:flex;align-items:center;gap:4px">${ICONS.id} ${p.tc ? p.tc.slice(0, 3) + '***' : '-'}</div>
                    </div>
                    
                    <!-- Footer - Sadece dÃ¼zenleme yetkisi olanlar gÃ¶rÃ¼r -->
                    <div style="display:flex;align-items:center;justify-content:space-between;padding-top:10px;border-top:1px solid var(--bg4)">
                        <div style="font-size:.7rem;color:${hasAccess ? '#27ae60' : 'var(--tx3)'}; display:flex;align-items:center;gap:4px">
                            ${hasAccess ? ICONS.unlock : (p.email ? ICONS.key : ICONS.lock)}
                            ${hasAccess ? 'Aktif' : (p.email ? 'Åžifre yok' : 'E-posta yok')}
                        </div>
                        ${canEdit ? `
                        <div style="display:flex;gap:4px">
                            <button onclick="showPersonelPreview('${docId}')" style="padding:5px 8px;background:var(--bg3);border:none;border-radius:5px;color:var(--accent);cursor:pointer;display:flex;align-items:center;transition:all .15s" onmouseover="this.style.background='var(--bg4)'" onmouseout="this.style.background='var(--bg3)'" title="Ã–nizleme">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                            </button>
                            <button onclick="editPersonel('${docId}')" style="padding:5px 10px;background:var(--bg3);border:none;border-radius:5px;color:var(--tx);cursor:pointer;font-size:.75rem;display:flex;align-items:center;gap:4px;transition:all .15s" onmouseover="this.style.background='var(--bg4)'" onmouseout="this.style.background='var(--bg3)'">
                                ${ICONS.edit} DÃ¼zenle
                            </button>
                            <button onclick="deletePersonel('${docId}')" style="padding:5px 8px;background:rgba(231,76,60,.08);border:none;border-radius:5px;color:#e74c3c;cursor:pointer;display:flex;align-items:center;transition:all .15s" onmouseover="this.style.background='rgba(231,76,60,.15)'" onmouseout="this.style.background='rgba(231,76,60,.08)'">
                                ${ICONS.trash}
                            </button>
                        </div>
                        ` : `<span style="font-size:.65rem;color:var(--tx3)">Sadece gÃ¶rÃ¼ntÃ¼leme</span>`}
                    </div>
                    `}
                </div>
            `;
        });
        html += '</div>';
        
        // Ä°statistik Ã¶zet
        const total = snapshot.size;
        const withAccess = snapshot.docs.filter(d => d.data().email && d.data().hasPassword).length;
        const byBranch = {};
        snapshot.forEach(doc => {
            const branch = doc.data().branch || 'BelirtilmemiÅŸ';
            byBranch[branch] = (byBranch[branch] || 0) + 1;
        });
        
        const statsHtml = `
            <div style="display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap">
                <div onclick="filterPersonelByBranch('')" style="background:linear-gradient(135deg,#008c95,#00a8a8);padding:14px 20px;border-radius:12px;color:#fff;display:flex;align-items:center;gap:12px;cursor:pointer;transition:all .2s;box-shadow:0 2px 8px rgba(0,140,149,.25)" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(0,140,149,.35)'" onmouseout="this.style.transform='none';this.style.boxShadow='0 2px 8px rgba(0,140,149,.25)'">
                    <div style="width:40px;height:40px;background:rgba(255,255,255,.2);border-radius:10px;display:flex;align-items:center;justify-content:center">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    </div>
                    <div><div style="font-size:1.5rem;font-weight:700;line-height:1">${total}</div><div style="font-size:.75rem;opacity:.85;margin-top:2px">Toplam Personel</div></div>
                </div>
                <div onclick="filterPersonelByBranch('')" style="background:linear-gradient(135deg,#27ae60,#2ecc71);padding:14px 20px;border-radius:12px;color:#fff;display:flex;align-items:center;gap:12px;cursor:pointer;transition:all .2s;box-shadow:0 2px 8px rgba(39,174,96,.25)" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(39,174,96,.35)'" onmouseout="this.style.transform='none';this.style.boxShadow='0 2px 8px rgba(39,174,96,.25)'">
                    <div style="width:40px;height:40px;background:rgba(255,255,255,.2);border-radius:10px;display:flex;align-items:center;justify-content:center">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    </div>
                    <div><div style="font-size:1.5rem;font-weight:700;line-height:1">${withAccess}</div><div style="font-size:.75rem;opacity:.85;margin-top:2px">GiriÅŸ Yapabilen</div></div>
                </div>
                ${Object.entries(byBranch).map(([branch, count]) => `
                    <div onclick="filterPersonelByBranch('${branch}')" style="background:var(--bg2);border:1px solid var(--bg4);padding:14px 20px;border-radius:12px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:all .2s" onmouseover="this.style.background='var(--bg3)';this.style.transform='translateY(-2px)';this.style.borderColor='var(--accent)'" onmouseout="this.style.background='var(--bg2)';this.style.transform='none';this.style.borderColor='var(--bg4)'">
                        <div style="width:40px;height:40px;background:var(--bg3);border-radius:10px;display:flex;align-items:center;justify-content:center;color:var(--accent)">
                            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                        </div>
                        <div><div style="font-size:1.3rem;font-weight:600;color:var(--tx);line-height:1">${count}</div><div style="font-size:.7rem;color:var(--tx2);margin-top:2px">${branch}</div></div>
                    </div>
                `).join('')}
            </div>
        `;
        
        container.innerHTML = statsHtml + html;
    } catch (error) {
        console.error('Personel yÃ¼kleme hatasÄ±:', error);
        container.innerHTML = '<p style="color:var(--red);text-align:center;padding:20px">YÃ¼kleme hatasÄ±: ' + error.message + '</p>';
    }
}

function showAddPersonelModal(editId = null) {
    const isEdit = !!editId;
    const title = isEdit ? 'Personel DÃ¼zenle' : 'Yeni Personel Ekle';
    
    // Yetki kontrolleri (dinamik)
    const isYonetici = currentUser?.role === 'yonetici';
    const isBolgeMuduru = currentUser?.role === 'bolge_muduru';
    const isMudur = currentUser?.role === 'magaza_muduru';
    const isMudurYardimcisi = currentUser?.role === 'mudur_yardimcisi' || currentUser?.role === 'magaza_mudur_yardimcisi';
    const perms = window.userAdvancedPermissions;
    const canSeeSalary = isYonetici || perms?.special?.view_salary;
    const canViewPassword = isYonetici || perms?.special?.view_password;
    const canAssignPassword = isYonetici || perms?.special?.assign_password;
    const canChangePassword = isYonetici || perms?.special?.change_others_password;
    
    // Barista/personel kÄ±sÄ±tlamasÄ± - sadece dÃ¼zenleme modunda
    // YÃ¶netici, BÃ¶lge MÃ¼dÃ¼rÃ¼, MaÄŸaza MÃ¼dÃ¼rÃ¼, MÃ¼dÃ¼r YardÄ±mcÄ±sÄ± tÃ¼m alanlarÄ± deÄŸiÅŸtirebilir
    const canEditAllFields = isYonetici || isBolgeMuduru || isMudur || isMudurYardimcisi;
    const isLimitedEdit = isEdit && !canEditAllFields;
    
    // Readonly stil
    const readonlyStyle = 'background:var(--bg3);cursor:not-allowed;color:var(--tx2)';
    const readonlyAttr = isLimitedEdit ? `readonly style="${readonlyStyle}"` : '';
    
    // Åžube deÄŸiÅŸtirme yetkisi - YÃ¶netici ve BÃ¶lge MÃ¼dÃ¼rÃ¼ deÄŸiÅŸtirebilir
    const canChangeBranch = isYonetici || isBolgeMuduru || perms?.special?.canViewAllBranches;
    
    // Åžifre alanÄ±nÄ± gÃ¶sterme koÅŸulu
    const showPasswordField = isYonetici || canAssignPassword || canChangePassword;
    
    const salaryField = canSeeSalary 
        ? `<div class="form-group"><label class="form-label">BrÃ¼t Ãœcret (TL)</label><input type="number" id="personelSalary" class="form-input"></div>`
        : `<input type="hidden" id="personelSalary" value="">`;
    
    // Åžube alanÄ± - yetkisi olmayanlar deÄŸiÅŸtiremez (editId varsa ve kendi kartÄ±ysa readonly)
    const branchField = (canChangeBranch && !isLimitedEdit)
        ? `<div class="form-group"><label class="form-label">Åžube</label><select id="personelBranch" class="form-select">${STATE.branches.map(b => `<option value="${b}">${b}</option>`).join('')}</select></div>`
        : `<div class="form-group"><label class="form-label">Åžube</label><input type="text" id="personelBranchDisplay" class="form-input" readonly style="${readonlyStyle}"><input type="hidden" id="personelBranch" value=""></div>`;
    
    // Pozisyon alanÄ± - sadece yetkili deÄŸiÅŸtirebilir
    const canChangePosition = (isYonetici || isBolgeMuduru || perms?.pages?.personel?.edit) && !isLimitedEdit;
    const positionField = canChangePosition
        ? `<div class="form-group"><label class="form-label">Pozisyon</label><select id="personelPosition" class="form-select">${STATE.positions.map(p => `<option value="${p.name}">${p.name}</option>`).join('')}</select></div>`
        : `<div class="form-group"><label class="form-label">Pozisyon</label><input type="text" id="personelPositionDisplay" class="form-input" readonly style="${readonlyStyle}"><input type="hidden" id="personelPosition" value=""></div>`;
    
    // Barista iÃ§in kÄ±sÄ±tlÄ± alanlar: Ad Soyad, TC, Adres, Ä°ÅŸe BaÅŸlama (readonly)
    // DeÄŸiÅŸtirebilecekleri: Kod AdÄ±, Telefon, Banka, IBAN
    
    const body = `
        <input type="hidden" id="personelEditId" value="${editId || ''}">
        ${isLimitedEdit ? `<div style="background:rgba(255,193,7,.1);border:1px solid rgba(255,193,7,.3);border-radius:8px;padding:10px 14px;margin-bottom:16px;display:flex;align-items:center;gap:8px">
            <svg width="16" height="16" fill="none" stroke="#f39c12" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
            <span style="font-size:.8rem;color:#b7791f">BazÄ± alanlar sadece yÃ¶neticiler tarafÄ±ndan deÄŸiÅŸtirilebilir</span>
        </div>` : ''}
        <div class="form-grid">
            <div class="form-group"><label class="form-label">Ad Soyad ${isLimitedEdit ? '<span style="color:var(--tx3);font-size:.7rem">(salt okunur)</span>' : ''}</label><input type="text" id="personelName" class="form-input" placeholder="Personel adÄ± soyadÄ±" ${readonlyAttr} required></div>
            <div class="form-group"><label class="form-label">Shift Kod AdÄ±</label><input type="text" id="personelCodeName" class="form-input" placeholder="Ã–rn: Esin Ä°."><small style="color:var(--tx2);font-size:.7rem">BoÅŸ bÄ±rakÄ±lÄ±rsa Ad S. formatÄ± kullanÄ±lÄ±r</small></div>
            <div class="form-group"><label class="form-label">T.C. Kimlik No ${isLimitedEdit ? '<span style="color:var(--tx3);font-size:.7rem">(salt okunur)</span>' : ''}</label><input type="text" id="personelTC" class="form-input" maxlength="11" placeholder="11 haneli TC kimlik no" ${readonlyAttr}></div>
            <div class="form-group"><label class="form-label">Telefon</label><input type="tel" id="personelPhone" class="form-input" placeholder="+90 5XX XXX XX XX" oninput="formatPhoneInput(this)"></div>
            <div class="form-group full"><label class="form-label">Adres ${isLimitedEdit ? '<span style="color:var(--tx3);font-size:.7rem">(salt okunur)</span>' : ''}</label><input type="text" id="personelAddress" class="form-input" placeholder="Ev adresi" ${readonlyAttr}></div>
            <div class="form-group">
                <label class="form-label">Banka</label>
                <div style="position:relative">
                    <input type="text" id="personelBankName" class="form-input" placeholder="Banka seÃ§in veya yazÄ±n" autocomplete="off" onclick="showPersonelBankDropdown()" oninput="filterPersonelBanks(this.value)">
                    <div id="personelBankDropdown" style="display:none;position:absolute;top:100%;left:0;right:0;background:var(--bg);border:1px solid var(--bg4);border-radius:8px;max-height:200px;overflow-y:auto;z-index:100;box-shadow:0 4px 12px rgba(0,0,0,.15);margin-top:4px"></div>
                </div>
            </div>
            <div class="form-group"><label class="form-label">Ä°ÅŸe BaÅŸlama ${isLimitedEdit ? '<span style="color:var(--tx3);font-size:.7rem">(salt okunur)</span>' : ''}</label><input type="date" id="personelStartDate" class="form-input" ${isLimitedEdit ? `readonly style="${readonlyStyle}"` : ''}></div>
            <div class="form-group full">
                <label class="form-label">IBAN</label>
                <div style="display:flex;gap:8px;align-items:center">
                    <input type="text" id="personelIBAN" class="form-input" style="flex:1" placeholder="TR00 0000 0000 0000 0000 0000 00" oninput="formatIbanInput(this)">
                    <button type="button" onclick="copyPersonelIban()" style="background:var(--bg3);border:1px solid var(--bg4);border-radius:6px;padding:8px 12px;cursor:pointer;display:flex;align-items:center;gap:4px;color:var(--tx2);font-size:.75rem;transition:all .15s;white-space:nowrap" onmouseover="this.style.background='var(--bg4)'" onmouseout="this.style.background='var(--bg3)'" title="IBAN'Ä± kopyala">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                        Kopyala
                    </button>
                </div>
            </div>
            ${branchField}
            ${positionField}
            ${salaryField}
        </div>
        
        ${showPasswordField ? `
        <!-- SÄ°STEM GÄ°RÄ°ÅžÄ° - Kompakt -->
        <div style="margin-top:16px;padding:12px 16px;background:linear-gradient(135deg,rgba(0,140,149,.06),rgba(255,134,116,.06));border-radius:10px;border:1px solid var(--cardBorder)">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
                <svg width="16" height="16" fill="none" stroke="#008c95" stroke-width="2" viewBox="0 0 24 24"><path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                <span style="font-weight:600;color:var(--tx);font-size:.9rem">Sistem GiriÅŸi</span>
                <span style="font-size:.7rem;color:var(--tx3);margin-left:auto">Rol pozisyona gÃ¶re belirlenir</span>
            </div>
            <div style="display:flex;gap:12px;align-items:flex-start">
                <div style="flex:1">
                    <label style="font-size:.75rem;color:var(--tx2);margin-bottom:4px;display:block">E-posta</label>
                    <input type="email" id="personelEmail" class="form-input" style="font-size:.85rem" placeholder="ornek@moonberrycoffee.com">
                </div>
                <div style="flex:1">
                    <label style="font-size:.75rem;color:var(--tx2);margin-bottom:4px;display:block">Åžifre ${isEdit ? '<span style="color:var(--tx3)">(deÄŸiÅŸtirmek iÃ§in girin)</span>' : ''}</label>
                    <div style="position:relative">
                        <input type="password" id="personelPassword" class="form-input" style="font-size:.85rem;padding-right:40px;width:100%" minlength="8" placeholder="${isEdit ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' : 'Abc123!@'}">
                        <button type="button" onclick="togglePasswordVisibility('personelPassword', this)" 
                            style="position:absolute;right:4px;top:50%;transform:translateY(-50%);width:32px;height:32px;background:transparent;border:none;cursor:pointer;color:var(--tx3);display:flex;align-items:center;justify-content:center;border-radius:4px;transition:all .12s"
                            onmouseover="this.style.color='var(--tx)'"
                            onmouseout="this.style.color='var(--tx3)'"
                            title="Åžifreyi GÃ¶ster/Gizle">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
                            </svg>
                        </button>
                    </div>
                    <div style="margin-top:6px;font-size:.65rem;color:var(--tx3)">8+ karakter, bÃ¼yÃ¼k/kÃ¼Ã§Ã¼k harf, rakam, Ã¶zel karakter (!@#$...)</div>
                </div>
            </div>
        </div>
        ` : `
        <input type="hidden" id="personelEmail" value="">
        <input type="hidden" id="personelPassword" value="">
        `}
    `;
    
    const footer = `
        <button class="btn btn-ghost" onclick="closeModal()">Ä°ptal</button>
        <button class="btn btn-primary" onclick="savePersonel()">ðŸ’¾ Kaydet</button>
    `;
    
    showModal(title, body, footer);
    
    if (isEdit) {
        loadPersonelForEdit(editId);
    }
}

async function loadPersonelForEdit(id) {
    try {
        const doc = await db.collection('personel').doc(id).get();
        if (doc.exists) {
            const p = doc.data();
            document.getElementById('personelName').value = p.name || '';
            document.getElementById('personelCodeName').value = p.codeName || '';
            document.getElementById('personelTC').value = p.tc || '';
            
            // Telefon - format dÃ¼zelt
            const phoneInput = document.getElementById('personelPhone');
            if (phoneInput) {
                phoneInput.value = p.phone || '';
                if (p.phone) formatPhoneInput(phoneInput);
            }
            
            const emailEl = document.getElementById('personelEmail');
            if (emailEl) emailEl.value = p.email || '';
            document.getElementById('personelAddress').value = p.address || '';
            
            // Banka bilgisi
            const bankNameInput = document.getElementById('personelBankName');
            if (bankNameInput) bankNameInput.value = p.bankName || '';
            
            // IBAN - format dÃ¼zelt
            const ibanInput = document.getElementById('personelIBAN');
            if (ibanInput) {
                ibanInput.value = p.iban || '';
                if (p.iban) formatIbanInput(ibanInput);
            }
            
            // Åžube - hem hidden hem display varsa ikisini de set et
            const branchSelect = document.getElementById('personelBranch');
            const branchDisplay = document.getElementById('personelBranchDisplay');
            if (branchSelect) branchSelect.value = p.branch || '';
            if (branchDisplay) branchDisplay.value = p.branch || '';
            
            // Pozisyon - hem hidden hem display varsa ikisini de set et
            const positionSelect = document.getElementById('personelPosition');
            const positionDisplay = document.getElementById('personelPositionDisplay');
            if (positionSelect) positionSelect.value = p.position || '';
            if (positionDisplay) positionDisplay.value = p.position || '';
            
            document.getElementById('personelStartDate').value = p.startDate || '';
            const salaryEl = document.getElementById('personelSalary');
            if (salaryEl) salaryEl.value = p.salary || '';
            // Åžifre alanÄ± - dÃ¼zenleme modunda boÅŸ bÄ±rakÄ±lÄ±r (deÄŸiÅŸmeyecekse)
            
            // Åžifre gÃ¶rme yetkisi olan iÃ§in mevcut ÅŸifreyi credentials'dan al
            const isYonetici = currentUser?.role === 'yonetici';
            const perms = window.userAdvancedPermissions;
            const canViewPassword = isYonetici || perms?.special?.view_password;
            
            if (canViewPassword && p.email) {
                // Credentials koleksiyonundan ÅŸifre Ã§ek
                const credPassword = await getCredential(p.email);
                window._currentPersonelPassword = credPassword;
                window._currentPersonelEmail = p.email;
            } else {
                window._currentPersonelPassword = null;
                window._currentPersonelEmail = null;
            }
        }
    } catch (error) {
        console.error('Personel yÃ¼kleme hatasÄ±:', error);
    }
}

// Admin iÃ§in ÅŸifre gÃ¶ster/gizle (minimalist toggle)
function togglePersonelPasswordView() {
    if (currentUser?.role !== 'yonetici') return;
    
    const pwInput = document.getElementById('personelPassword');
    const eyeIcon = document.getElementById('pwEyeIcon');
    
    if (!pwInput) return;
    
    // Åžifre yoksa veya yÃ¼klenmediyse
    if (!window._currentPersonelPassword) {
        toast('KayÄ±tlÄ± ÅŸifre bulunamadÄ±', 'error');
        return;
    }
    
    const isShown = pwInput.type === 'text';
    
    if (isShown) {
        // Gizle - placeholder'a geri dÃ¶n
        pwInput.type = 'password';
        pwInput.value = '';
        pwInput.placeholder = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
        if (eyeIcon) {
            eyeIcon.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>';
        }
    } else {
        // GÃ¶ster - credentials'dan alÄ±nan ÅŸifre zaten decoded
        pwInput.type = 'text';
        pwInput.value = window._currentPersonelPassword || '';
        pwInput.placeholder = '';
        if (eyeIcon) {
            eyeIcon.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/>';
        }
    }
}

async function savePersonel() {
    const editId = document.getElementById('personelEditId').value;
    const name = document.getElementById('personelName').value.trim();
    const tc = document.getElementById('personelTC').value.trim();
    let codeName = document.getElementById('personelCodeName').value.trim();
    const email = document.getElementById('personelEmail').value.trim().toLowerCase();
    const password = document.getElementById('personelPassword')?.value || '';
    const position = document.getElementById('personelPosition').value;
    
    if (!name) {
        toast('Ad soyad zorunludur', 'error');
        return;
    }
    
    // Yeni kullanÄ±cÄ± ve email + ÅŸifre girildiyse ÅŸifre kontrolÃ¼
    if (email && password) {
        const passwordValidation = validatePassword(password);
        if (!passwordValidation.valid) {
            toast(passwordValidation.message, 'error');
            return;
        }
    }
    
    // Kod adÄ± boÅŸsa otomatik oluÅŸtur: "Ad S."
    if (!codeName) {
        const parts = name.split(' ');
        if (parts.length >= 2) {
            codeName = parts[0] + ' ' + parts[parts.length - 1].charAt(0) + '.';
        } else {
            codeName = name;
        }
    }
    
    // ====== YENÄ°: BENZERSÄ°Z uniqueId OLUÅžTUR ======
    // Format: busra_sogut (tam isim, TÃ¼rkÃ§e karakterler transliterate)
    const uniqueId = normalizePersonelId(name);
    
    // Pozisyondan rol belirleme - DÄ°NAMÄ°K (STATE.positions'dan)
    let role = 'barista'; // varsayÄ±lan
    const matchedPosition = STATE.positions.find(p => p.name === position || p.id === position);
    if (matchedPosition) {
        role = matchedPosition.role;
    }
    console.log(`[Personel] Pozisyon: "${position}" â†’ Rol: "${role}"`);
    
    // Telefon formatÄ±nÄ± dÃ¼zelt
    const rawPhone = document.getElementById('personelPhone').value.trim();
    const phone = formatPhoneNumber(rawPhone);
    
    // IBAN formatÄ±nÄ± temizle (boÅŸluklarÄ± kaldÄ±r)
    const rawIban = document.getElementById('personelIBAN').value.trim();
    const iban = rawIban.replace(/\s/g, '');
    
    // Banka adÄ±
    const bankName = document.getElementById('personelBankName')?.value?.trim() || '';
    
    // BÃ¶lge mÃ¼dÃ¼rÃ¼ ve yÃ¶netici iÃ§in branch otomatik 'all'
    const formBranch = document.getElementById('personelBranch').value;
    const finalBranch = (role === 'bolge_muduru' || role === 'yonetici') ? 'all' : formBranch;
    
    const data = {
        name,
        codeName,
        uniqueId,  // â† YENÄ°: Benzersiz ID
        tc,
        phone,
        email,
        address: document.getElementById('personelAddress').value.trim(),
        bankName,
        iban,
        branch: finalBranch,
        position,
        role,
        startDate: document.getElementById('personelStartDate').value,
        salary: document.getElementById('personelSalary').value,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedBy: currentUser?.username || 'admin'
    };
    
    // ====== uniqueId Ã‡AKIÅžMA KONTROLÃœ ======
    if (!editId) {
        // Yeni personel ekleniyor, aynÄ± uniqueId var mÄ± kontrol et
        const existingCheck = await db.collection('personel').where('uniqueId', '==', uniqueId).get();
        if (!existingCheck.empty) {
            toast(`"${name}" ile aynÄ± ID'ye sahip personel zaten var!`, 'error');
            return;
        }
    }
    
    // Åžifre girilmiÅŸse credentials koleksiyonuna kaydet (personel'e DEÄžÄ°L)
    if (password) {
        data.hasPassword = true;
        // NOT: data.password artÄ±k YOK - gÃ¼venlik iÃ§in credentials'da
    }
    
    try {
        // Email ve ÅŸifre varsa iÅŸlem yap
        if (email && password) {
            // Credentials koleksiyonuna kaydet (tek kaynak)
            const personelDocId = editId || 'new_' + Date.now();
            await saveCredential(email, password, personelDocId);
            console.log('âœ… Credentials kaydedildi:', email);
            toast('Åžifre kaydedildi âœ“', 'success');
        }
        
        // passwordPlain kaldÄ± ise temizle
        delete data.passwordPlain;
        
        // Email varsa users koleksiyonunu da gÃ¼ncelle
        if (email) {
            await db.collection('users').doc(email).set({
                email,
                role,
                branch: data.branch,
                name,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
        }
        
        if (editId) {
            // ====== Ã–NCE ESKÄ° VERÄ°YÄ° AL ======
            const oldDoc = await db.collection('personel').doc(editId).get();
            const oldData = oldDoc.exists ? oldDoc.data() : {};
            const oldName = oldData.name || '';
            const oldCodeName = oldData.codeName || '';
            const oldUniqueId = oldData.uniqueId || '';
            const oldDisplayName = getPersonelDisplayName(oldData);
            
            // Ä°lk isimler (TÃ¼rkÃ§e normalize)
            const oldFirstName = normalizeTurkishChars(oldName.split(' ')[0] || '');
            const newFirstName = normalizeTurkishChars(name.split(' ')[0] || '');
            
            console.log(`[Personel GÃ¼ncelleme] Eski: "${oldName}" (${oldCodeName}) â†’ Yeni: "${name}" (${codeName})`);
            
            // Åžimdi gÃ¼ncelle
            await db.collection('personel').doc(editId).update(data);
            
            // ====== SHIFT'LERDE Ä°SÄ°M GÃœNCELLEMESÄ° ======
            // Personel adÄ±/kod adÄ± deÄŸiÅŸince mevcut shift'leri gÃ¼ncelle
            try {
                const newDisplayName = getPersonelDisplayName(data);
                
                // TÃœM shift'leri kontrol et (bÃ¶lge mÃ¼dÃ¼rÃ¼ tÃ¼m ÅŸubelerde olabilir)
                const shiftsSnap = await db.collection('shifts').get();
                let updatedCount = 0;
                
                for (const shiftDoc of shiftsSnap.docs) {
                    const shift = shiftDoc.data();
                    
                    // Branch kontrolÃ¼ (bÃ¶lge mÃ¼dÃ¼rÃ¼ hariÃ§ tÃ¼m ÅŸubeler)
                    if (shift.branch !== data.branch && role !== 'bolge_muduru') continue;
                    
                    const personelShifts = shift.personelShifts || {};
                    const personelNames = shift.personelNames || {};
                    const personelFullNames = shift.personelFullNames || {};
                    let needsUpdate = false;
                    let matchedKey = null;
                    
                    // Bu personelin shift'teki key'ini bul - GENÄ°ÅžLETÄ°LMÄ°Åž EÅžLEÅžME
                    for (const key of Object.keys(personelShifts)) {
                        const keyLower = key.toLowerCase();
                        const keyNorm = normalizeTurkishChars(key);
                        const keyFirst = keyNorm.split(/[_\s\.]/)[0]; // Ä°lk isim
                        
                        // EÅŸleÅŸme kontrolleri (eski ve yeni deÄŸerlerle)
                        const matches = 
                            // TAM EÅžLEÅžMEler
                            key === codeName ||
                            key === name ||
                            key === oldCodeName ||
                            key === oldName ||
                            key === oldDisplayName ||
                            key === oldUniqueId ||
                            keyLower === uniqueId ||
                            keyLower === oldUniqueId ||
                            
                            // NORMALÄ°ZE EÅžLEÅžMEler
                            keyNorm === normalizeTurkishChars(uniqueId) ||
                            keyNorm === normalizeTurkishChars(codeName) ||
                            keyNorm === normalizeTurkishChars(name) ||
                            keyNorm === normalizeTurkishChars(oldUniqueId) ||
                            keyNorm === normalizeTurkishChars(oldCodeName) ||
                            keyNorm === normalizeTurkishChars(oldName) ||
                            keyNorm === normalizeTurkishChars(oldDisplayName) ||
                            
                            // personelNames/personelFullNames EÅžLEÅžMEsi
                            personelNames[key] === oldDisplayName ||
                            personelNames[key] === oldCodeName ||
                            personelFullNames[key] === oldName ||
                            normalizeTurkishChars(personelFullNames[key] || '') === normalizeTurkishChars(oldName) ||
                            
                            // Ä°LK Ä°SÄ°M EÅžLEÅžMESÄ° (en Ã¶nemli!)
                            (keyFirst && keyFirst.length > 2 && keyFirst === oldFirstName);
                        
                        if (matches) {
                            matchedKey = key;
                            console.log(`[Shift EÅŸleÅŸme] ${shiftDoc.id}: key="${key}" â†’ "${newDisplayName}"`);
                            break;
                        }
                    }
                    
                    if (matchedKey) {
                        // Ä°sim deÄŸiÅŸtiyse gÃ¼ncelle
                        if (personelNames[matchedKey] !== newDisplayName || personelFullNames[matchedKey] !== name) {
                            personelNames[matchedKey] = newDisplayName;
                            personelFullNames[matchedKey] = name;
                            needsUpdate = true;
                        }
                    }
                    
                    if (needsUpdate) {
                        await db.collection('shifts').doc(shiftDoc.id).update({
                            personelNames,
                            personelFullNames
                        });
                        updatedCount++;
                        console.log(`[Shift GÃ¼ncelleme] ${shiftDoc.id}: "${matchedKey}" â†’ "${newDisplayName}"`);
                    }
                }
                
                if (updatedCount > 0) {
                    console.log(`[Shift GÃ¼ncelleme] Toplam ${updatedCount} shift gÃ¼ncellendi`);
                }
            } catch (shiftErr) {
                console.warn('Shift gÃ¼ncelleme hatasÄ± (kritik deÄŸil):', shiftErr);
            }
            
            toast('Personel gÃ¼ncellendi âœ“', 'success');
        } else {
            data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            await db.collection('personel').add(data);
            toast('Personel eklendi âœ“', 'success');
        }
        
        // Personel cache'ini yenile
        refreshPersonelCache();
        
        // Shift sayfasÄ± aÃ§Ä±ksa tabloyu yenile
        if (document.querySelector('#shiftPage')?.style.display !== 'none') {
            setTimeout(() => loadShiftWeek(), 500);
        }
        
        closeModal();
        loadPersonelList();
    } catch (error) {
        console.error('KayÄ±t hatasÄ±:', error);
        toast('KayÄ±t hatasÄ±: ' + error.message, 'error');
    }
}

// Åžifreleri gÃ¶ster/gizle toggle (sadece yÃ¶netici)
function toggleShowPasswords() {
    if (currentUser?.role !== 'yonetici') {
        toast('Bu iÅŸlem iÃ§in yetkiniz yok', 'error');
        return;
    }
    window._showPasswords = !window._showPasswords;
    loadPersonelList(); // Listeyi yeniden yÃ¼kle
    toast(window._showPasswords ? 'Åžifreler gÃ¶steriliyor' : 'Åžifreler gizlendi', 'info');
}

function editPersonel(id) {
    if (!id || id === 'undefined' || id === '') {
        toast('GeÃ§ersiz personel ID!', 'error');
        return;
    }
    showAddPersonelModal(id);
}

// Personel Ã–nizleme ModalÄ±
async function showPersonelPreview(docId) {
    if (!docId) {
        toast('GeÃ§ersiz personel ID!', 'error');
        return;
    }
    
    try {
        const doc = await db.collection('personel').doc(docId).get();
        if (!doc.exists) {
            toast('Personel bulunamadÄ±!', 'error');
            return;
        }
        
        const p = doc.data();
        
        // Yetki kontrolleri (dinamik - rol bazlÄ±)
        const isYonetici = currentUser?.role === 'yonetici';
        const isBolgeMuduru = currentUser?.role === 'bolge_muduru';
        const canViewPassword = isYonetici; // Sadece yÃ¶netici ÅŸifre gÃ¶rebilir
        const canChangePassword = isYonetici || isBolgeMuduru; // YÃ¶netici veya bÃ¶lge mÃ¼dÃ¼rÃ¼ deÄŸiÅŸtirebilir
        
        // Åžifre bilgisi (sadece admin iÃ§in)
        let passwordHtml = '';
        if (canViewPassword && p.email) {
            try {
                const credPassword = await getCredential(p.email);
                if (credPassword) {
                    passwordHtml = `
                        <div style="display:flex;align-items:center;gap:8px;padding:10px 12px;background:rgba(231,76,60,.08);border-radius:8px;border:1px solid rgba(231,76,60,.15)">
                            <svg width="16" height="16" fill="none" stroke="#e74c3c" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
                            <span style="flex:1;font-family:monospace;font-size:.85rem;color:#e74c3c">${credPassword}</span>
                            <button onclick="copyToClipboard('${credPassword}', 'Åžifre')" style="background:none;border:none;cursor:pointer;color:#e74c3c;padding:4px;display:flex;opacity:.7;transition:opacity .2s" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='.7'" title="Åžifreyi Kopyala">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                            </button>
                        </div>
                    `;
                }
            } catch (e) {
                console.log('Åžifre alÄ±namadÄ±:', e);
            }
        }
        
        // Rol bilgisi
        const roleNames = {
            'yonetici': 'YÃ¶netici',
            'bolge_muduru': 'BÃ¶lge MÃ¼dÃ¼rÃ¼',
            'magaza_muduru': 'MaÄŸaza MÃ¼dÃ¼rÃ¼',
            'magaza_mudur_yardimcisi': 'MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±',
            'barista': 'Barista'
        };
        
        const body = `
            <div style="display:flex;flex-direction:column;gap:16px">
                <!-- Header -->
                <div style="display:flex;align-items:center;gap:14px;padding-bottom:16px;border-bottom:1px solid var(--bg4)">
                    <div style="width:60px;height:60px;background:linear-gradient(135deg,#008c95,#00a8a8);border-radius:12px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.4rem;font-weight:600;overflow:hidden">
                        ${p.photoUrl ? `<img src="${p.photoUrl}" style="width:100%;height:100%;object-fit:cover">` : (p.name || 'P').charAt(0).toUpperCase()}
                    </div>
                    <div style="flex:1">
                        <div style="display:flex;align-items:center;gap:8px">
                            <span style="font-size:1.1rem;font-weight:600;color:var(--tx)">${p.name || '-'}</span>
                            <button onclick="copyToClipboard('${(p.name || '').replace(/'/g, "\\'")}', 'Ad Soyad')" style="background:none;border:none;cursor:pointer;color:var(--tx3);padding:2px;display:flex;opacity:.6;transition:opacity .2s" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='.6'" title="AdÄ± Kopyala">
                                <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                            </button>
                        </div>
                        <div style="font-size:.85rem;color:var(--tx2)">${p.position || roleNames[p.role] || 'Personel'}</div>
                        <div style="font-size:.75rem;color:var(--tx3)">${p.branch || '-'}</div>
                    </div>
                </div>
                
                <!-- Bilgiler Grid -->
                <div style="display:grid;gap:12px">
                    <!-- Ä°letiÅŸim -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                        <div style="padding:10px 12px;background:var(--bg3);border-radius:8px">
                            <div style="font-size:.65rem;color:var(--tx3);margin-bottom:4px;text-transform:uppercase">Telefon</div>
                            <div style="display:flex;align-items:center;gap:6px">
                                <span style="font-size:.85rem;color:var(--tx);flex:1">${p.phone || '-'}</span>
                                ${p.phone ? `<button onclick="copyToClipboard('${p.phone}', 'Telefon')" style="background:none;border:none;cursor:pointer;color:var(--tx3);padding:2px;display:flex;opacity:.6;transition:opacity .2s" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='.6'" title="Kopyala"><svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>` : ''}
                            </div>
                        </div>
                        <div style="padding:10px 12px;background:var(--bg3);border-radius:8px">
                            <div style="font-size:.65rem;color:var(--tx3);margin-bottom:4px;text-transform:uppercase">E-posta</div>
                            <div style="display:flex;align-items:center;gap:6px">
                                <span style="font-size:.85rem;color:var(--tx);flex:1;overflow:hidden;text-overflow:ellipsis">${p.email || '-'}</span>
                                ${p.email ? `<button onclick="copyToClipboard('${p.email}', 'E-posta')" style="background:none;border:none;cursor:pointer;color:var(--tx3);padding:2px;display:flex;opacity:.6;transition:opacity .2s" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='.6'" title="Kopyala"><svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <!-- TC ve Adres -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                        <div style="padding:10px 12px;background:var(--bg3);border-radius:8px">
                            <div style="font-size:.65rem;color:var(--tx3);margin-bottom:4px;text-transform:uppercase">T.C. Kimlik No</div>
                            <div style="display:flex;align-items:center;gap:6px">
                                <span style="font-size:.85rem;color:var(--tx);flex:1">${p.tc || '-'}</span>
                                ${p.tc ? `<button onclick="copyToClipboard('${p.tc}', 'TC')" style="background:none;border:none;cursor:pointer;color:var(--tx3);padding:2px;display:flex;opacity:.6;transition:opacity .2s" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='.6'" title="Kopyala"><svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>` : ''}
                            </div>
                        </div>
                        <div style="padding:10px 12px;background:var(--bg3);border-radius:8px">
                            <div style="font-size:.65rem;color:var(--tx3);margin-bottom:4px;text-transform:uppercase">Ä°ÅŸe BaÅŸlama</div>
                            <span style="font-size:.85rem;color:var(--tx)">${p.startDate || '-'}</span>
                        </div>
                    </div>
                    
                    <!-- Adres (Full Width) -->
                    <div style="padding:10px 12px;background:var(--bg3);border-radius:8px">
                        <div style="font-size:.65rem;color:var(--tx3);margin-bottom:4px;text-transform:uppercase">Adres</div>
                        <div style="display:flex;align-items:center;gap:6px">
                            <span style="font-size:.85rem;color:var(--tx);flex:1">${p.address || '-'}</span>
                            ${p.address ? `<button onclick="copyToClipboard('${(p.address || '').replace(/'/g, "\\'")}', 'Adres')" style="background:none;border:none;cursor:pointer;color:var(--tx3);padding:2px;display:flex;opacity:.6;transition:opacity .2s" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='.6'" title="Kopyala"><svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>` : ''}
                        </div>
                    </div>
                    
                    <!-- Banka Bilgileri -->
                    <div style="padding:12px;background:linear-gradient(135deg,rgba(0,140,149,.06),rgba(0,140,149,.02));border:1px solid rgba(0,140,149,.15);border-radius:10px">
                        <div style="font-size:.7rem;font-weight:600;color:var(--accent);margin-bottom:10px;display:flex;align-items:center;gap:6px">
                            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                            Banka Bilgileri
                        </div>
                        <div style="display:grid;gap:8px">
                            <div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--bg);border-radius:6px">
                                <span style="font-size:.7rem;color:var(--tx3);width:50px">Banka</span>
                                <span style="font-size:.85rem;color:var(--tx);flex:1;font-weight:500">${p.bankName || '-'}</span>
                                ${p.bankName ? `<button onclick="copyToClipboard('${(p.bankName || '').replace(/'/g, "\\'")}', 'Banka')" style="background:none;border:none;cursor:pointer;color:var(--tx3);padding:2px;display:flex;opacity:.6;transition:opacity .2s" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='.6'" title="Kopyala"><svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>` : ''}
                            </div>
                            <div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--bg);border-radius:6px">
                                <span style="font-size:.7rem;color:var(--tx3);width:50px">IBAN</span>
                                <span style="font-size:.85rem;color:var(--tx);flex:1;font-family:monospace;letter-spacing:.5px">${p.iban || '-'}</span>
                                ${p.iban ? `<button onclick="copyToClipboard('${p.iban}', 'IBAN')" style="background:none;border:none;cursor:pointer;color:var(--tx3);padding:2px;display:flex;opacity:.6;transition:opacity .2s" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='.6'" title="Kopyala"><svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Åžifre (Sadece Admin) -->
                    ${canViewPassword ? `
                    <div>
                        <div style="font-size:.7rem;font-weight:600;color:#e74c3c;margin-bottom:8px;display:flex;align-items:center;gap:6px">
                            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
                            Åžifre (Sadece YÃ¶netici GÃ¶rebilir)
                        </div>
                        ${passwordHtml || '<div style="padding:10px 12px;background:var(--bg3);border-radius:8px;font-size:.85rem;color:var(--tx3)">Åžifre atanmamÄ±ÅŸ</div>'}
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
        
        const footer = `
            <button class="btn btn-ghost" onclick="closeModal()">Kapat</button>
            <button class="btn btn-primary" onclick="closeModal(); editPersonel('${docId}')">
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                DÃ¼zenle
            </button>
        `;
        
        showModal(`${p.name || 'Personel'} - Ã–nizleme`, body, footer);
        
    } catch (error) {
        console.error('Ã–nizleme hatasÄ±:', error);
        toast('Ã–nizleme yÃ¼klenemedi: ' + error.message, 'error');
    }
}

// Genel kopyalama fonksiyonu
function copyToClipboard(text, label = 'Metin') {
    if (!text) {
        toast('Kopyalanacak veri yok', 'error');
        return;
    }
    
    navigator.clipboard.writeText(text).then(() => {
        toast(`${label} kopyalandÄ±!`, 'success');
    }).catch(err => {
        // Fallback
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        toast(`${label} kopyalandÄ±!`, 'success');
    });
}

async function deletePersonel(id) {
    // ID kontrolÃ¼
    if (!id || id === 'undefined' || id === '') {
        toast('GeÃ§ersiz personel ID!', 'error');
        console.error('deletePersonel: BoÅŸ veya geÃ§ersiz ID:', id);
        return;
    }
    
    confirmModal('Personel Sil', 'Bu personeli silmek istediÄŸinize emin misiniz?', async () => {
        try {
            // Ã–nce personel verisini al (email iÃ§in)
            const personelDoc = await db.collection('personel').doc(id).get();
            const personelData = personelDoc.exists ? personelDoc.data() : null;
            const email = personelData?.email;
            
            // 1. Personel'i sil
            await db.collection('personel').doc(id).delete();
            
            // 2. Credentials'Ä± sil (varsa)
            if (email) {
                await deleteCredential(email);
                console.log('Credentials silindi:', email);
            }
            
            // 3. Users koleksiyonundan sil (varsa)
            if (email) {
                try {
                    await db.collection('users').doc(email).delete();
                } catch (e) { /* Users'ta yoksa sorun deÄŸil */ }
            }
            
            toast('Personel silindi âœ“', 'success');
            refreshPersonelCache();
            loadPersonelList();
        } catch (error) {
            console.error('Silme hatasÄ±:', error);
            toast('Silme hatasÄ±: ' + error.message, 'error');
        }
    });
}

function filterPersonel() {
    const search = document.getElementById('personelSearch').value.toLowerCase().trim();
    const cards = document.querySelectorAll('.personel-card');
    
    cards.forEach(card => {
        const searchData = card.dataset.search || '';
        const match = !search || searchData.includes(search);
        card.style.display = match ? 'block' : 'none';
    });
}

// Åžubeye gÃ¶re filtrele
function filterPersonelByBranch(branch) {
    const searchInput = document.getElementById('personelSearch');
    const cards = document.querySelectorAll('.personel-card');
    
    // Arama alanÄ±nÄ± gÃ¼ncelle
    if (searchInput) {
        searchInput.value = branch;
    }
    
    cards.forEach(card => {
        const cardBranch = card.dataset.branch || '';
        const match = !branch || cardBranch === branch;
        card.style.display = match ? 'block' : 'none';
    });
    
    if (branch) {
        toast(`${branch} personeli gÃ¶steriliyor`, 'info');
    } else {
        toast('TÃ¼m personel gÃ¶steriliyor', 'info');
    }
}

// ==================== PUANTAJ SÄ°STEMÄ° ====================
let puantajRulesCache = [];
let primSettingsCache = null;
let starPointsConfig = null; // YÄ±ldÄ±z-Puan config cache

// YÄ±ldÄ±z-Puan config'i yÃ¼kle
async function loadStarPointsConfig() {
    if (starPointsConfig) return starPointsConfig;
    try {
        const doc = await db.collection('config').doc('starPoints').get();
        if (doc.exists) {
            starPointsConfig = doc.data();
        } else {
            // VarsayÄ±lan (fallback)
            starPointsConfig = {
                1: { label: 'Ciddi Ä°hlal', points: -3, color: '#c0392b' },
                2: { label: 'Orta Ä°hlal', points: -2, color: '#e74c3c' },
                3: { label: 'Hafif Ä°hlal', points: -1, color: '#e67e22' },
                4: { label: 'Ä°yi', points: 1, color: '#f1c40f' },
                5: { label: 'MÃ¼kemmel', points: 2, color: '#f39c12' }
            };
        }
    } catch (e) {
        console.error('StarPoints config yÃ¼klenemedi:', e);
        starPointsConfig = {
            1: { label: 'Ciddi Ä°hlal', points: -3, color: '#c0392b' },
            2: { label: 'Orta Ä°hlal', points: -2, color: '#e74c3c' },
            3: { label: 'Hafif Ä°hlal', points: -1, color: '#e67e22' },
            4: { label: 'Ä°yi', points: 1, color: '#f1c40f' },
            5: { label: 'MÃ¼kemmel', points: 2, color: '#f39c12' }
        };
    }
    return starPointsConfig;
}

// YÄ±ldÄ±zdan puan hesapla (config'den dinamik)
function getPointsFromStar(star) {
    const s = parseInt(star) || 3;
    if (starPointsConfig && starPointsConfig[s]) {
        return starPointsConfig[s].points;
    }
    // Fallback: eski sistem
    return s - 3;
}

// YÄ±ldÄ±z rengi al (config'den dinamik)
function getStarColor(star) {
    const s = parseInt(star) || 3;
    if (starPointsConfig && starPointsConfig[s]) {
        return starPointsConfig[s].color;
    }
    // Fallback
    return s >= 4 ? '#f1c40f' : (s >= 3 ? '#e67e22' : '#e74c3c');
}

// YÄ±ldÄ±z etiketi al (config'den dinamik)
function getStarLabel(star) {
    const s = parseInt(star) || 3;
    if (starPointsConfig && starPointsConfig[s]) {
        return starPointsConfig[s].label;
    }
    return '';
}

// Prim Sistemi YÃ¼kle
async function loadPrimSettings() {
    const container = document.getElementById('primSystemContainer');
    if (!container) return;
    
    const canEdit = ['yonetici', 'bolge_muduru'].includes(currentUser?.role);
    const aylar = ['', 'Ocak', 'Åžubat', 'Mart', 'Nisan', 'MayÄ±s', 'Haziran', 'Temmuz', 'AÄŸustos', 'EylÃ¼l', 'Ekim', 'KasÄ±m', 'AralÄ±k'];
    const currentMonth = aylar[new Date().getMonth() + 1];
    const currentYear = new Date().getFullYear();
    
    // Firebase'den ayarlarÄ± Ã§ek
    try {
        const doc = await db.collection('settings').doc('primSystem').get();
        if (doc.exists) {
            primSettingsCache = doc.data();
        } else {
            // VarsayÄ±lan ayarlar
            primSettingsCache = {
                month: `${currentMonth} ${currentYear}`,
                tiers: [
                    { minCiro: '55-65K', prim: '500 TL' },
                    { minCiro: '65-75K', prim: '1.000 TL' },
                    { minCiro: '75K+', prim: '2.000 TL' }
                ],
                warning: '-5 puana dÃ¼ÅŸersen prim hakkÄ±nÄ± kaybedersin!',
                motivation: 'Prim sisteminde baÅŸarÄ±lÄ± olmanÄ±n en Ã¶nemli adÄ±mÄ± check listelerini zamanÄ±nda doldurmak. Her vaktinde tamamlanan check sana +1 puan kazandÄ±rÄ±r. GÃ¼n iÃ§inde 3 check varsa, hepsini vaktinde yaparsan gÃ¼nde +3 puan biriktirirsin.',
                motivation2: 'Ciro hedefini tutturmanÄ±n yolu ek Ã¼rÃ¼n satÄ±ÅŸÄ±ndan geÃ§er. Ã–zellikle Cuma, Cumartesi ve Pazar gÃ¼nleri mÃ¼ÅŸteri yoÄŸunluÄŸu yÃ¼ksek. Kasada her mÃ¼ÅŸteriye kurabiye, Ã§ikolata veya sezonluk iÃ§ecek Ã¶nermek, kiÅŸi baÅŸÄ± harcamayÄ± artÄ±rÄ±r. Hafta sonu 500 mÃ¼ÅŸteriye ortalama 5 TL ek Ã¼rÃ¼n satÄ±ÅŸÄ± = 2.500 TL ekstra ciro demek!',
                quote: 'Checklist\'i doldur, ek Ã¼rÃ¼n Ã¶ner, prim cebinde kalsÄ±n.'
            };
        }
    } catch (e) {
        console.error('Prim ayarlarÄ± yÃ¼klenemedi:', e);
        primSettingsCache = { month: `${currentMonth} ${currentYear}`, tiers: [], motivation: '', quote: '' };
    }
    
    const s = primSettingsCache;
    
    container.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
            <div style="display:flex;align-items:center;gap:10px">
                <svg width="20" height="20" fill="none" stroke="#008c95" stroke-width="2" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                <span style="font-size:1.1rem;font-weight:700;color:var(--tx)">Performans & Prim Sistemi</span>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
                <span style="font-size:.75rem;color:var(--tx3);background:var(--bg3);padding:4px 10px;border-radius:6px">${s.month || currentMonth + ' ' + currentYear}</span>
                ${canEdit ? `<button onclick="editPrimSettings()" style="background:none;border:none;color:var(--accent);cursor:pointer;padding:4px"><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>` : ''}
            </div>
        </div>
        
        <!-- PUAN TABLOSU - DÄ°NAMÄ°K -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px">
            <div style="background:var(--bg2);border-radius:10px;padding:14px">
                <div style="font-size:.8rem;font-weight:600;color:var(--tx);margin-bottom:10px">Check PuanlarÄ±</div>
                <div id="popupCheckPoints" style="display:flex;flex-direction:column;gap:6px;font-size:.75rem">
                    <div style="display:flex;justify-content:space-between"><span style="color:var(--tx2)">Vaktinde</span><span style="color:#27ae60;font-weight:600">+1</span></div>
                    <div style="display:flex;justify-content:space-between"><span style="color:var(--tx2)">GeÃ§</span><span style="color:#e67e22;font-weight:600">-1</span></div>
                    <div style="display:flex;justify-content:space-between"><span style="color:var(--tx2)">YapÄ±lmadÄ±</span><span style="color:#e74c3c;font-weight:600">-2</span></div>
                </div>
            </div>
            <div style="background:var(--bg2);border-radius:10px;padding:14px">
                <div style="font-size:.8rem;font-weight:600;color:var(--tx);margin-bottom:10px">YÃ¶netici DeÄŸerlendirmesi</div>
                <div id="popupStarPoints" style="display:flex;flex-direction:column;gap:6px;font-size:.75rem">
                    ${(() => {
                        const sc = starPointsConfig || {};
                        let html = '';
                        for (let i = 1; i <= 5; i++) {
                            const cfg = sc[i] || { label: i + ' YÄ±ldÄ±z', points: i - 3, color: '#888' };
                            if (cfg.points !== 0) {
                                const stars = 'â˜…'.repeat(i);
                                html += `<div style="display:flex;justify-content:space-between"><span style="color:var(--tx2)">${stars} ${cfg.label}</span><span style="color:${cfg.color};font-weight:600">${cfg.points > 0 ? '+' : ''}${cfg.points}</span></div>`;
                            }
                        }
                        return html || '<div style="color:var(--tx3)">YapÄ±landÄ±rÄ±lmamÄ±ÅŸ</div>';
                    })()}
                </div>
            </div>
        </div>
        
        <!-- PRÄ°M TABLOSU -->
        <div style="background:linear-gradient(135deg,rgba(39,174,96,.08),rgba(46,204,113,.04));border:1px solid rgba(39,174,96,.2);border-radius:12px;padding:16px;margin-bottom:16px">
            <div style="font-size:.9rem;font-weight:700;color:#27ae60;margin-bottom:12px;display:flex;align-items:center;gap:8px">
                <svg width="18" height="18" fill="none" stroke="#27ae60" stroke-width="2" viewBox="0 0 24 24"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
                ${s.month || currentMonth} Prim Tablosu
            </div>
            <div style="display:grid;grid-template-columns:repeat(${s.tiers?.length || 3},1fr);gap:10px;margin-bottom:12px">
                ${(s.tiers || []).map((t, i) => `
                    <div style="background:${i === (s.tiers?.length || 3) - 1 ? 'rgba(46,204,113,.15)' : 'rgba(255,255,255,.5)'};border-radius:8px;padding:12px;text-align:center;${i === (s.tiers?.length || 3) - 1 ? 'border:1px solid rgba(46,204,113,.3)' : ''}">
                        <div style="font-size:.7rem;color:${i === (s.tiers?.length || 3) - 1 ? '#1e8449' : 'var(--tx3)'}">${t.minCiro}</div>
                        <div style="font-size:1.1rem;font-weight:800;color:${i === (s.tiers?.length || 3) - 1 ? '#2ecc71' : '#27ae60'}">${t.prim}</div>
                    </div>
                `).join('')}
            </div>
            <div style="background:rgba(231,76,60,.1);border-radius:8px;padding:10px;display:flex;align-items:center;gap:10px">
                <svg width="16" height="16" fill="none" stroke="#e74c3c" stroke-width="2" viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                <span style="font-size:.75rem;color:#c0392b"><strong>Dikkat:</strong> ${s.warning || '-5 puana dÃ¼ÅŸersen prim hakkÄ±nÄ± kaybedersin!'}</span>
            </div>
        </div>
        
        <!-- MOTÄ°VASYON -->
        <div style="background:var(--bg2);border-radius:10px;padding:16px">
            <div style="font-size:.85rem;font-weight:600;color:var(--tx);margin-bottom:10px">Primi NasÄ±l KazanÄ±rsÄ±n?</div>
            <div style="font-size:.8rem;color:var(--tx2);line-height:1.7">${s.motivation || ''}</div>
            ${s.motivation2 ? `<div style="font-size:.8rem;color:var(--tx2);line-height:1.7;margin-top:10px">${s.motivation2}</div>` : ''}
            ${s.quote ? `
                <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--bg4)">
                    <div style="font-size:.75rem;color:var(--tx3);font-style:italic">"${s.quote}"</div>
                </div>
            ` : ''}
        </div>
    `;
}

// Prim AyarlarÄ±nÄ± DÃ¼zenle
// Prim dÃ¼zenleme modalÄ± iÃ§in geÃ§ici state
let primEditTiers = [];
let primEditCheckPoints = [];
let primEditAnnouncements = [];

// SVG simge kÃ¼tÃ¼phanesi
const primSvgIcons = {
    dollar: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>',
    trophy: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 9H4.5a2.5 2.5 0 010-5H6"/><path d="M18 9h1.5a2.5 2.5 0 000-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 1012 0V2z"/></svg>',
    star: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
    crown: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M2 4l3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"/></svg>',
    medal: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89L17 22l-5-3-5 3 1.523-9.11"/></svg>',
    gift: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 01-2 2H7a2 2 0 01-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 010-5A4.8 8 0 0112 8a4.8 8 0 014.5-5 2.5 2.5 0 010 5"/></svg>',
    target: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>',
    zap: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
    check: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5"/></svg>',
    clock: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>',
    x: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg>',
    alert: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
    info: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>',
    bulb: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>'
};

function showPrimEditModal() {
    const perms = window.userAdvancedPermissions || {};
    const canEdit = currentUser?.role === 'yonetici' || perms.pages?.primSistemi?.edit === true;
    if (!canEdit) {
        toast('Bu iÅŸlem iÃ§in yetkiniz yok', 'error');
        return;
    }
    
    const s = primSettingsCache || {};
    primEditTiers = JSON.parse(JSON.stringify(s.tiers || []));
    
    renderPrimTiersModal(s);
}

function renderPrimTiersModal(s) {
    const iconList = ['dollar', 'trophy', 'star', 'crown', 'medal', 'gift', 'target', 'zap'];
    
    let tiersHtml = '';
    primEditTiers.forEach((t, i) => {
        tiersHtml += `
            <div class="prim-tier-row" data-index="${i}" style="padding:12px;background:var(--bg2);border-radius:10px;border:1px solid var(--bg4);position:relative">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
                    <div style="cursor:grab;padding:4px;color:var(--tx3)" draggable="true" ondragstart="startDragTier(event,${i})" ondragend="endDragTier(event)">
                        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M8 6h.01M8 12h.01M8 18h.01M16 6h.01M16 12h.01M16 18h.01"/></svg>
                    </div>
                    <span style="font-size:.75rem;font-weight:600;color:var(--tx)">Kademe ${i + 1}</span>
                    <button onclick="removePrimTierNew(${i})" style="margin-left:auto;background:rgba(231,76,60,.1);border:none;color:#e74c3c;width:24px;height:24px;border-radius:6px;cursor:pointer;font-size:.9rem" title="Sil">Ã—</button>
                </div>
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
                    <div>
                        <label style="font-size:.6rem;color:var(--tx3);display:block;margin-bottom:3px">Simge</label>
                        <select data-field="icon" style="width:100%;padding:8px;border:1px solid var(--bg4);border-radius:6px;background:var(--bg);color:var(--tx);font-size:.75rem">
                            ${iconList.map(k => `<option value="${k}" ${t.icon === k ? 'selected' : ''}>${k}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label style="font-size:.6rem;color:var(--tx3);display:block;margin-bottom:3px">Etiket</label>
                        <input type="text" data-field="badge" value="${t.badge || ''}" 
                            style="width:100%;padding:8px;border:1px solid var(--bg4);border-radius:6px;background:var(--bg);color:var(--tx);font-size:.75rem;box-sizing:border-box"
                            placeholder="EN YÃœKSEK">
                    </div>
                    <div>
                        <label style="font-size:.6rem;color:var(--tx3);display:block;margin-bottom:3px">BaÅŸlÄ±k</label>
                        <input type="text" data-field="label" value="${t.label || 'Ciro'}" 
                            style="width:100%;padding:8px;border:1px solid var(--bg4);border-radius:6px;background:var(--bg);color:var(--tx);font-size:.75rem;box-sizing:border-box"
                            placeholder="Ciro">
                    </div>
                    <div>
                        <label style="font-size:.6rem;color:var(--tx3);display:block;margin-bottom:3px">AralÄ±k</label>
                        <input type="text" data-field="minCiro" value="${t.minCiro || ''}" 
                            style="width:100%;padding:8px;border:1px solid var(--bg4);border-radius:6px;background:var(--bg);color:var(--tx);font-size:.75rem;box-sizing:border-box"
                            placeholder="55-65K">
                    </div>
                    <div style="grid-column:1/-1">
                        <label style="font-size:.6rem;color:var(--tx3);display:block;margin-bottom:3px">Prim TutarÄ±</label>
                        <input type="text" data-field="prim" value="${t.prim || ''}" 
                            style="width:100%;padding:8px;border:1px solid var(--bg4);border-radius:6px;background:var(--bg);color:var(--tx);font-size:.85rem;font-weight:600;box-sizing:border-box"
                            placeholder="500 TL">
                    </div>
                </div>
            </div>
        `;
    });
    
    if (primEditTiers.length === 0) {
        tiersHtml = '<div style="text-align:center;padding:24px;color:var(--tx3);font-size:.85rem">HenÃ¼z kademe yok</div>';
    }
    
    const body = `
        <div style="display:flex;flex-direction:column;gap:16px;max-height:65vh;overflow-y:auto;padding:4px">
            <div>
                <label style="font-size:.85rem;font-weight:600;color:var(--tx);display:block;margin-bottom:6px">DÃ¶nem</label>
                <input type="text" id="primMonth" value="${s.month || ''}" placeholder="Åžubat 2026"
                    style="width:100%;padding:10px;border:1px solid var(--bg4);border-radius:8px;background:var(--bg);color:var(--tx);font-size:.85rem;box-sizing:border-box">
            </div>
            
            <div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                    <label style="font-size:.85rem;font-weight:600;color:var(--tx)">Prim Kademeleri</label>
                    <button onclick="addPrimTierNew()" style="background:linear-gradient(135deg,#27ae60,#2ecc71);border:none;color:#fff;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:.75rem;font-weight:500;display:flex;align-items:center;gap:4px">
                        <svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
                        Ekle
                    </button>
                </div>
                <div id="primTiersContainer" style="display:flex;flex-direction:column;gap:8px" ondragover="handleDragOver(event)" ondrop="handleDropTier(event)">
                    ${tiersHtml}
                </div>
            </div>
        </div>
    `;
    
    showModal('Prim Kademeleri', body, `
        <button class="btn btn-ghost" onclick="closeModal()">Ä°ptal</button>
        <button class="btn btn-primary" onclick="savePrimTiersNew()">Kaydet</button>
    `);
}

// Yeni sÃ¼rÃ¼kle-bÄ±rak sistemi
let draggedTierIdx = null;

function startDragTier(e, idx) {
    draggedTierIdx = idx;
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', idx);
    e.target.closest('.prim-tier-row').style.opacity = '0.5';
}

function endDragTier(e) {
    e.target.closest('.prim-tier-row').style.opacity = '1';
}

function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
}

function handleDropTier(e) {
    e.preventDefault();
    const container = document.getElementById('primTiersContainer');
    const rows = Array.from(container.querySelectorAll('.prim-tier-row'));
    
    // Hedef satÄ±rÄ± bul
    let targetIdx = rows.length - 1;
    for (let i = 0; i < rows.length; i++) {
        const rect = rows[i].getBoundingClientRect();
        if (e.clientY < rect.top + rect.height / 2) {
            targetIdx = i;
            break;
        }
    }
    
    if (draggedTierIdx !== null && draggedTierIdx !== targetIdx) {
        // Ã–nce mevcut deÄŸerleri kaydet
        collectTierValues();
        
        // SÄ±ralamayÄ± deÄŸiÅŸtir
        const item = primEditTiers.splice(draggedTierIdx, 1)[0];
        primEditTiers.splice(targetIdx, 0, item);
        
        // Yeniden render
        renderPrimTiersModal(primSettingsCache || {});
    }
    draggedTierIdx = null;
}

function collectTierValues() {
    const container = document.getElementById('primTiersContainer');
    if (!container) return;
    
    const rows = container.querySelectorAll('.prim-tier-row');
    rows.forEach((row, i) => {
        if (primEditTiers[i]) {
            const icon = row.querySelector('[data-field="icon"]');
            const badge = row.querySelector('[data-field="badge"]');
            const label = row.querySelector('[data-field="label"]');
            const minCiro = row.querySelector('[data-field="minCiro"]');
            const prim = row.querySelector('[data-field="prim"]');
            
            if (icon) primEditTiers[i].icon = icon.value;
            if (badge) primEditTiers[i].badge = badge.value;
            if (label) primEditTiers[i].label = label.value;
            if (minCiro) primEditTiers[i].minCiro = minCiro.value;
            if (prim) primEditTiers[i].prim = prim.value;
        }
    });
}

function addPrimTierNew() {
    collectTierValues();
    primEditTiers.push({ icon: 'dollar', badge: '', label: 'Ciro', minCiro: '', prim: '' });
    renderPrimTiersModal(primSettingsCache || {});
}

function removePrimTierNew(index) {
    collectTierValues();
    primEditTiers.splice(index, 1);
    renderPrimTiersModal(primSettingsCache || {});
}

async function savePrimTiersNew() {
    collectTierValues();
    
    const validTiers = primEditTiers.filter(t => t.minCiro && t.prim);
    
    try {
        const settings = {
            ...primSettingsCache,
            month: document.getElementById('primMonth')?.value || '',
            tiers: validTiers,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedBy: currentUser?.email || currentUser?.username
        };
        
        await db.collection('settings').doc('primSystem').set(settings, { merge: true });
        primSettingsCache = settings;
        
        closeModal();
        toast('Prim kademeleri kaydedildi', 'success');
        loadPrimSistemiPage();
    } catch (e) {
        console.error('Kaydetme hatasÄ±:', e);
        toast('Kaydetme hatasÄ±', 'error');
    }
}

// Eski fonksiyonlar iÃ§in alias
function addPrimTier() { addPrimTierNew(); }
function removePrimTier(i) { removePrimTierNew(i); }
function dragPrimTier(e, i) { startDragTier(e, i); }
function dropPrimTier(e, i) { handleDropTier(e); }
function savePrimTiers() { savePrimTiersNew(); }

// CHECK PUANLARI DÃœZENLEME
function showCheckPointsEditModal() {
    const s = primSettingsCache || {};
    primEditCheckPoints = JSON.parse(JSON.stringify(s.checkPoints || [
        { name: 'Vaktinde', points: 1, color: '#27ae60', icon: 'check' },
        { name: 'GeÃ§', points: -1, color: '#e67e22', icon: 'clock' },
        { name: 'YapÄ±lmayan', points: -2, color: '#e74c3c', icon: 'x' }
    ]));
    
    renderCheckPointsModal();
}

function renderCheckPointsModal() {
    const iconOptions = ['check', 'clock', 'x', 'alert', 'star', 'zap'].map(k => 
        `<option value="${k}">${k}</option>`
    ).join('');
    
    const colorOptions = [
        { value: '#27ae60', name: 'YeÅŸil' },
        { value: '#e67e22', name: 'Turuncu' },
        { value: '#e74c3c', name: 'KÄ±rmÄ±zÄ±' },
        { value: '#3498db', name: 'Mavi' },
        { value: '#9b59b6', name: 'Mor' }
    ];
    
    let html = primEditCheckPoints.map((cp, i) => `
        <div style="display:flex;align-items:center;gap:8px;padding:12px;background:var(--bg2);border-radius:10px;border:1px solid var(--bg4)">
            <div style="width:50px">
                <select onchange="primEditCheckPoints[${i}].icon=this.value" style="width:100%;padding:6px;border:1px solid var(--bg4);border-radius:6px;background:var(--bg);color:var(--tx);font-size:.75rem">
                    ${['check', 'clock', 'x', 'alert', 'star', 'zap'].map(k => `<option value="${k}" ${cp.icon === k ? 'selected' : ''}>${k}</option>`).join('')}
                </select>
            </div>
            <div style="flex:1">
                <input type="text" value="${cp.name}" onchange="primEditCheckPoints[${i}].name=this.value" 
                    style="width:100%;padding:8px;border:1px solid var(--bg4);border-radius:6px;background:var(--bg);color:var(--tx);font-size:.85rem"
                    placeholder="Ä°sim">
            </div>
            <div style="width:70px">
                <input type="number" value="${cp.points}" onchange="primEditCheckPoints[${i}].points=parseInt(this.value)||0" 
                    style="width:100%;padding:8px;border:1px solid var(--bg4);border-radius:6px;background:var(--bg);color:var(--tx);font-size:.85rem;text-align:center"
                    placeholder="Puan">
            </div>
            <div style="width:40px">
                <input type="color" value="${cp.color}" onchange="primEditCheckPoints[${i}].color=this.value" 
                    style="width:32px;height:32px;border:none;border-radius:6px;cursor:pointer;padding:0">
            </div>
            <button onclick="primEditCheckPoints.splice(${i},1);renderCheckPointsModal()" style="background:rgba(231,76,60,.1);border:none;color:#e74c3c;width:28px;height:28px;border-radius:6px;cursor:pointer">Ã—</button>
        </div>
    `).join('');
    
    const body = `
        <div style="display:flex;flex-direction:column;gap:16px">
            <div style="display:flex;justify-content:space-between;align-items:center">
                <span style="font-size:.85rem;color:var(--tx2)">Check tamamlama durumlarÄ±na gÃ¶re puanlar</span>
                <button onclick="primEditCheckPoints.push({name:'',points:0,color:'#888',icon:'check'});renderCheckPointsModal()" style="background:var(--bg2);border:1px solid var(--bg4);color:var(--tx);padding:6px 12px;border-radius:6px;cursor:pointer;font-size:.8rem;display:flex;align-items:center;gap:4px">
                    <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
                    Ekle
                </button>
            </div>
            <div id="checkPointsContainer" style="display:flex;flex-direction:column;gap:8px">
                ${html || '<div style="text-align:center;padding:20px;color:var(--tx3)">HenÃ¼z tanÄ±mlÄ± yok</div>'}
            </div>
        </div>
    `;
    
    showModal('Check PuanlarÄ±', body, `
        <button class="btn btn-ghost" onclick="closeModal()">Ä°ptal</button>
        <button class="btn btn-primary" onclick="saveCheckPoints()">Kaydet</button>
    `);
}

async function saveCheckPoints() {
    const container = document.getElementById('checkPointsContainer');
    if (container) {
        const rows = container.querySelectorAll('div[style*="display:flex"]');
        rows.forEach((row, i) => {
            if (primEditCheckPoints[i]) {
                const select = row.querySelector('select');
                const inputs = row.querySelectorAll('input');
                if (select) primEditCheckPoints[i].icon = select.value;
                if (inputs[0]) primEditCheckPoints[i].name = inputs[0].value;
                if (inputs[1]) primEditCheckPoints[i].points = parseInt(inputs[1].value) || 0;
                if (inputs[2]) primEditCheckPoints[i].color = inputs[2].value;
            }
        });
    }
    
    try {
        const settings = {
            ...primSettingsCache,
            checkPoints: primEditCheckPoints.filter(cp => cp.name),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedBy: currentUser?.email || currentUser?.username
        };
        
        await db.collection('settings').doc('primSystem').set(settings, { merge: true });
        primSettingsCache = settings;
        
        closeModal();
        toast('Check puanlarÄ± kaydedildi', 'success');
        loadPrimSistemiPage();
    } catch (e) {
        toast('Kaydetme hatasÄ±', 'error');
    }
}

// DUYURULAR/BÄ°LGÄ°LENDÄ°RMELER DÃœZENLEME
function showAnnouncementsEditModal() {
    const s = primSettingsCache || {};
    primEditAnnouncements = JSON.parse(JSON.stringify(s.announcements || []));
    
    renderAnnouncementsModal();
}

function renderAnnouncementsModal() {
    const typeOptions = [
        { value: 'warning', label: 'UyarÄ±', color: '#e74c3c' },
        { value: 'info', label: 'Bilgi', color: '#008c95' },
        { value: 'success', label: 'BaÅŸarÄ±', color: '#27ae60' },
        { value: 'tip', label: 'Ä°pucu', color: '#9b59b6' }
    ];
    
    let html = primEditAnnouncements.map((a, i) => `
        <div style="padding:14px;background:var(--bg2);border-radius:10px;border:1px solid var(--bg4)">
            <div style="display:flex;gap:8px;margin-bottom:10px">
                <select onchange="primEditAnnouncements[${i}].type=this.value" style="padding:8px;border:1px solid var(--bg4);border-radius:6px;background:var(--bg);color:var(--tx);font-size:.85rem">
                    ${typeOptions.map(t => `<option value="${t.value}" ${a.type === t.value ? 'selected' : ''}>${t.label}</option>`).join('')}
                </select>
                <input type="text" value="${a.title || ''}" onchange="primEditAnnouncements[${i}].title=this.value" 
                    style="flex:1;padding:8px;border:1px solid var(--bg4);border-radius:6px;background:var(--bg);color:var(--tx);font-size:.85rem"
                    placeholder="BaÅŸlÄ±k (opsiyonel)">
                <button onclick="primEditAnnouncements.splice(${i},1);renderAnnouncementsModal()" style="background:rgba(231,76,60,.1);border:none;color:#e74c3c;width:32px;height:32px;border-radius:6px;cursor:pointer">Ã—</button>
            </div>
            <textarea onchange="primEditAnnouncements[${i}].content=this.value" rows="2"
                style="width:100%;padding:10px;border:1px solid var(--bg4);border-radius:6px;background:var(--bg);color:var(--tx);font-size:.85rem;resize:vertical"
                placeholder="Ä°Ã§erik...">${a.content || ''}</textarea>
        </div>
    `).join('');
    
    const body = `
        <div style="display:flex;flex-direction:column;gap:16px;max-height:60vh;overflow-y:auto">
            <div style="display:flex;justify-content:space-between;align-items:center">
                <span style="font-size:.85rem;color:var(--tx2)">Prim sayfasÄ±nda gÃ¶sterilecek bilgilendirmeler</span>
                <button onclick="primEditAnnouncements.push({type:'info',title:'',content:''});renderAnnouncementsModal()" style="background:var(--bg2);border:1px solid var(--bg4);color:var(--tx);padding:6px 12px;border-radius:6px;cursor:pointer;font-size:.8rem;display:flex;align-items:center;gap:4px">
                    <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
                    Ekle
                </button>
            </div>
            <div id="announcementsContainer" style="display:flex;flex-direction:column;gap:10px">
                ${html || '<div style="text-align:center;padding:24px;color:var(--tx3)">HenÃ¼z bilgilendirme yok</div>'}
            </div>
        </div>
    `;
    
    showModal('Bilgilendirmeler', body, `
        <button class="btn btn-ghost" onclick="closeModal()">Ä°ptal</button>
        <button class="btn btn-primary" onclick="saveAnnouncements()">Kaydet</button>
    `);
}

async function saveAnnouncements() {
    const container = document.getElementById('announcementsContainer');
    if (container) {
        const items = container.querySelectorAll('div[style*="padding:14px"]');
        items.forEach((item, i) => {
            if (primEditAnnouncements[i]) {
                const select = item.querySelector('select');
                const input = item.querySelector('input');
                const textarea = item.querySelector('textarea');
                if (select) primEditAnnouncements[i].type = select.value;
                if (input) primEditAnnouncements[i].title = input.value;
                if (textarea) primEditAnnouncements[i].content = textarea.value;
            }
        });
    }
    
    try {
        const settings = {
            ...primSettingsCache,
            announcements: primEditAnnouncements.filter(a => a.content),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedBy: currentUser?.email || currentUser?.username
        };
        
        await db.collection('settings').doc('primSystem').set(settings, { merge: true });
        primSettingsCache = settings;
        
        closeModal();
        toast('Bilgilendirmeler kaydedildi', 'success');
        loadPrimSistemiPage();
    } catch (e) {
        toast('Kaydetme hatasÄ±', 'error');
    }
}

// Eski fonksiyon iÃ§in alias
function editPrimSettings() { showPrimEditModal(); }

// Prim Sistemi SayfasÄ± YÃ¼kle
async function loadPrimSistemiPage() {
    const container = document.getElementById('primSistemiContainer');
    if (!container) return;
    
    await loadStarPointsConfig();
    
    const perms = window.userAdvancedPermissions || {};
    const canEdit = currentUser?.role === 'yonetici' || perms.pages?.primSistemi?.edit === true;
    const canEditAnn = canEdit || currentUser?.role === 'bolge_muduru'; // BÃ¶lge mÃ¼dÃ¼rÃ¼ de bilgilendirme ekleyebilir
    const aylar = ['', 'Ocak', 'Åžubat', 'Mart', 'Nisan', 'MayÄ±s', 'Haziran', 'Temmuz', 'AÄŸustos', 'EylÃ¼l', 'Ekim', 'KasÄ±m', 'AralÄ±k'];
    const currentMonth = aylar[new Date().getMonth() + 1];
    const currentYear = new Date().getFullYear();
    const userBranch = currentUser?.branch || '';
    
    // Mevcut ÅŸubeleri DÄ°NAMÄ°K al (ðŸ“ Åžubeler'den)
    const branches = STATE.branches || window.BRANCHES || [];
    
    // SeÃ§ili ÅŸube (yÃ¶netici ise dropdown'dan, deÄŸilse kendi ÅŸubesi)
    const selectedBranch = window.primSelectedBranch || userBranch || branches[0] || '';
    
    // Prim ayarlarÄ±nÄ± yÃ¼kle
    let s = primSettingsCache;
    if (!s || !s.tiers) {
        try {
            const doc = await db.collection('settings').doc('primSystem').get();
            if (doc.exists) {
                s = doc.data();
                primSettingsCache = s;
            } else {
                s = { month: `${currentMonth} ${currentYear}`, tiers: [], primThreshold: -5 };
            }
        } catch (e) {
            s = { month: `${currentMonth} ${currentYear}`, tiers: [], primThreshold: -5 };
        }
    }
    
    // Åžube bazlÄ± prim (varsa)
    const branchTiers = s.branchSettings?.[selectedBranch]?.tiers;
    const activeTiers = branchTiers || s.tiers || [];
    const activeMonth = s.branchSettings?.[selectedBranch]?.month || s.month || `${currentMonth} ${currentYear}`;
    
    // Check kurallarÄ±nÄ± DÄ°NAMÄ°K olarak Ã§ek
    // 1. CHECKLIST_TYPES'dan isimler
    // 2. CHECK_RULES'dan puanlar
    let checkRulesData = [];
    try {
        // CHECKLIST_TYPES yÃ¼klÃ¼ deÄŸilse Firebase'den yÃ¼kle
        if (Object.keys(CHECKLIST_TYPES).length === 0) {
            const typesDoc = await db.collection('config').doc('checklistTypes').get();
            if (typesDoc.exists) {
                const data = typesDoc.data();
                for (const [branch, types] of Object.entries(data)) {
                    if (Array.isArray(types)) {
                        CHECKLIST_TYPES[branch] = types;
                    }
                }
            }
        }
        
        // Åžubeye ait checklist tÃ¼rlerini bul
        // Ã–nce tam eÅŸleÅŸme, yoksa benzer ÅŸube adÄ± ara
        let branchTypes = CHECKLIST_TYPES[selectedBranch];
        if (!branchTypes) {
            // Åžube adÄ± eÅŸleÅŸmesi ara (Tuzla Port -> Tuzla TRC gibi)
            const branchKey = Object.keys(CHECKLIST_TYPES).find(k => 
                k.toLowerCase().includes(selectedBranch.toLowerCase().split(' ')[0]) ||
                selectedBranch.toLowerCase().includes(k.toLowerCase().split(' ')[0])
            );
            branchTypes = branchKey ? CHECKLIST_TYPES[branchKey] : null;
        }
        
        // TÃ¼m ÅŸubelerden unique tÃ¼rleri topla (fallback)
        if (!branchTypes || branchTypes.length === 0) {
            const allTypes = new Map();
            Object.values(CHECKLIST_TYPES).forEach(types => {
                if (Array.isArray(types)) {
                    types.forEach(t => {
                        if (!allTypes.has(t.id)) {
                            allTypes.set(t.id, t);
                        }
                    });
                }
            });
            branchTypes = Array.from(allTypes.values());
        }
        
        // Her checklist tÃ¼rÃ¼ iÃ§in puanlarÄ± CHECK_RULES'dan al
        if (branchTypes && branchTypes.length > 0) {
            branchTypes.forEach(type => {
                const typeId = type.id || type.name?.toLowerCase();
                const rules = CHECK_RULES[typeId] || CHECK_RULES[canonicalChecklistTypeId?.(typeId)] || {};
                const points = rules.points || { onTime: 1, late: 0, missed: -1 };
                
                checkRulesData.push({
                    name: type.name || rules.name || typeId,
                    onTime: points.onTime ?? 1,
                    late: points.late ?? 0,
                    missed: points.missed ?? -1
                });
            });
        }
        
        // HÃ¢lÃ¢ boÅŸsa config/system.checkRules'dan al
        if (checkRulesData.length === 0) {
            const configDoc = await db.collection('config').doc('system').get();
            if (configDoc.exists && configDoc.data().checkRules) {
                const rules = configDoc.data().checkRules;
                Object.entries(rules).forEach(([id, rule]) => {
                    if (rule.points) {
                        checkRulesData.push({
                            name: rule.name || id,
                            onTime: rule.points.onTime ?? 1,
                            late: rule.points.late ?? 0,
                            missed: rule.points.missed ?? -1
                        });
                    }
                });
            }
        }
    } catch (e) {
        console.log('Check kurallarÄ± yÃ¼klenemedi:', e);
    }
    
    // YÄ±ldÄ±z config
    const starConfig = starPointsConfig || {};
    
    // SVG ikonlarÄ±
    const icons = {
        trophy: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 9H4.5a2.5 2.5 0 010-5H6M18 9h1.5a2.5 2.5 0 000-5H18M4 22h16M18 2H6v7a6 6 0 1012 0V2z"/></svg>',
        dollar: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>',
        star: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
        crown: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M2 4l3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"/></svg>',
        medal: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89L17 22l-5-3-5 3 1.523-9.11"/></svg>',
        gift: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13M19 12v7a2 2 0 01-2 2H7a2 2 0 01-2-2v-7"/></svg>',
        target: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>',
        zap: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>'
    };
    
    // Åžube seÃ§ici (sadece yÃ¶netici iÃ§in)
    let branchSelectorHtml = '';
    if (canEdit && branches.length > 1) {
        branchSelectorHtml = `
            <select id="primBranchSelector" onchange="changePrimBranch(this.value)" style="background:var(--bg2);border:1px solid var(--bg4);color:var(--tx);padding:8px 14px;border-radius:10px;font-size:.85rem;cursor:pointer;font-weight:500">
                ${branches.map(b => `<option value="${b}" ${selectedBranch === b ? 'selected' : ''}>${b}</option>`).join('')}
            </select>
        `;
    }
    
    // Tier HTML - GRID RESPONSIVE
    let tiersHtml = '';
    if (activeTiers.length === 0) {
        tiersHtml = `<div style="text-align:center;padding:24px;color:var(--tx3);grid-column:1/-1">
            <svg width="36" height="36" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" style="margin-bottom:8px;opacity:.4"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
            <div style="font-size:.8rem">HenÃ¼z prim kademesi tanÄ±mlanmamÄ±ÅŸ</div>
        </div>`;
    } else {
        tiersHtml = activeTiers.map((t) => {
            const tierColor = t.color || '#27ae60';
            const tierIcon = t.icon || 'dollar';
            const badge = t.badge || '';
            const hasBadge = badge.trim() !== '';
            return `<div style="background:${hasBadge ? `linear-gradient(135deg,${tierColor}10,${tierColor}05)` : 'var(--bg)'};border:${hasBadge ? `2px solid ${tierColor}30` : '1px solid var(--bg4)'};border-radius:10px;padding:14px 10px;padding-top:${hasBadge ? '20px' : '14px'};text-align:center;position:relative">
                ${hasBadge ? `<div style="position:absolute;top:-10px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,${tierColor},${tierColor}dd);color:#fff;font-size:.65rem;padding:4px 8px;border-radius:6px;font-weight:700;white-space:nowrap;box-shadow:0 2px 6px ${tierColor}30;display:inline-flex;align-items:center;gap:3px">${icons[tierIcon] ? icons[tierIcon].replace(/16/g, '10') : ''}${badge}</div>` : ''}
                <div style="width:26px;height:26px;background:${tierColor}12;border-radius:6px;display:flex;align-items:center;justify-content:center;margin:0 auto 6px;color:${tierColor}">${(icons[tierIcon] || icons.dollar).replace(/16/g, '13')}</div>
                <div style="font-size:.55rem;color:var(--tx3);margin-bottom:2px;text-transform:uppercase;letter-spacing:.3px;font-weight:600">${t.label || 'Ciro'}</div>
                <div style="font-size:.75rem;font-weight:600;color:var(--tx);margin-bottom:4px">${t.minCiro}</div>
                <div style="font-size:1.05rem;font-weight:800;color:${tierColor};line-height:1">${t.prim}</div>
            </div>`;
        }).join('');
    }
    
    // YÄ±ldÄ±z puanlarÄ± HTML - KOMPAKT YAN YANA
    let starPointsHtml = '';
    for (let star = 1; star <= 5; star++) {
        const cfg = starConfig[star] || { label: `${star} YÄ±ldÄ±z`, points: star - 3, color: '#888' };
        if (cfg.points !== 0) {
            const starStr = 'â˜…'.repeat(star);
            const isPositive = cfg.points > 0;
            starPointsHtml += `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:${cfg.color}08;border-radius:6px;border:1px solid ${cfg.color}15">
                    <span style="display:flex;align-items:center;gap:5px">
                        <span style="color:${cfg.color};font-size:.7rem">${starStr}</span>
                        <span style="color:var(--tx2);font-size:.65rem">${cfg.label}</span>
                    </span>
                    <span style="color:${cfg.color};font-weight:700;font-size:.75rem">${isPositive ? '+' : ''}${cfg.points}</span>
                </div>
            `;
        }
    }
    
    // Check puanlarÄ± HTML - BÃœYÃœK KARTLAR, 4'LÃœ GRÄ°D
    let checkPointsHtml = checkRulesData.map(c => `
        <div style="padding:14px;background:var(--bg2);border-radius:10px;border:1px solid var(--bg4)">
            <div style="font-weight:700;color:var(--tx);font-size:.85rem;margin-bottom:10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${c.name}</div>
            <div style="display:flex;gap:6px">
                <div style="flex:1;text-align:center;padding:8px 6px;background:rgba(39,174,96,.12);border-radius:6px">
                    <div style="font-size:.55rem;color:#27ae60;margin-bottom:3px;font-weight:600">VAKTÄ°NDE</div>
                    <div style="font-weight:800;color:#27ae60;font-size:1rem">${c.onTime > 0 ? '+' : ''}${c.onTime}</div>
                </div>
                <div style="flex:1;text-align:center;padding:8px 6px;background:rgba(230,126,34,.12);border-radius:6px">
                    <div style="font-size:.55rem;color:#e67e22;margin-bottom:3px;font-weight:600">GEÃ‡</div>
                    <div style="font-weight:800;color:#e67e22;font-size:1rem">${c.late}</div>
                </div>
                <div style="flex:1;text-align:center;padding:8px 6px;background:rgba(231,76,60,.12);border-radius:6px">
                    <div style="font-size:.55rem;color:#e74c3c;margin-bottom:3px;font-weight:600">YAPILMADI</div>
                    <div style="font-weight:800;color:#e74c3c;font-size:1rem">${c.missed}</div>
                </div>
            </div>
        </div>
    `).join('');
    
    // Bilgilendirmeler
    let announcementsHtml = '';
    try {
        const annSnap = await db.collection('primAnnouncements')
            .orderBy('createdAt', 'desc')
            .limit(20)
            .get();
        
        const now = new Date();
        const announcements = [];
        annSnap.forEach(doc => {
            const data = { id: doc.id, ...doc.data() };
            
            // SÃ¼re dolmuÅŸ duyurularÄ± atla
            if (data.expiresAt) {
                const expiresDate = data.expiresAt.toDate ? data.expiresAt.toDate() : new Date(data.expiresAt);
                if (expiresDate < now) return; // SÃ¼resi dolmuÅŸ, gÃ¶sterme
            }
            
            const targetBranches = data.branches || ['all'];
            // YÃ¶netici ve bÃ¶lge mÃ¼dÃ¼rÃ¼ tÃ¼m bilgilendirmeleri gÃ¶rÃ¼r
            const canSeeAll = currentUser?.role === 'yonetici' || currentUser?.role === 'bolge_muduru';
            if (targetBranches.includes('all') || targetBranches.includes(selectedBranch) || canSeeAll) {
                announcements.push(data);
            }
        });
        
        if (announcements.length > 0) {
            const typeConfig = {
                info: { icon: '<svg width="18" height="18" fill="none" stroke="#3498db" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>', color: '#3498db', bg: 'rgba(52,152,219,.06)' },
                success: { icon: '<svg width="18" height="18" fill="none" stroke="#27ae60" stroke-width="2" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><path d="M22 4L12 14.01l-3-3"/></svg>', color: '#27ae60', bg: 'rgba(39,174,96,.06)' },
                warning: { icon: '<svg width="18" height="18" fill="none" stroke="#f39c12" stroke-width="2" viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>', color: '#f39c12', bg: 'rgba(243,156,18,.06)' },
                urgent: { icon: '<svg width="18" height="18" fill="none" stroke="#e74c3c" stroke-width="2" viewBox="0 0 24 24"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>', color: '#e74c3c', bg: 'rgba(231,76,60,.08)' },
                tip: { icon: '<svg width="18" height="18" fill="none" stroke="#9b59b6" stroke-width="2" viewBox="0 0 24 24"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>', color: '#9b59b6', bg: 'rgba(155,89,182,.06)' }
            };
            
            announcementsHtml = announcements.map(a => {
                const cfg = typeConfig[a.type] || typeConfig.info;
                const animClass = a.animation && a.animation !== 'none' ? `ann-${a.animation}` : '';
                // Tarih formatla (sadece gÃ¼n)
                let dateStr = '';
                if (a.createdAt) {
                    const d = a.createdAt.toDate ? a.createdAt.toDate() : new Date(a.createdAt);
                    dateStr = d.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' });
                }
                // Kalan gÃ¼n hesapla
                let expiresStr = '';
                if (a.expiresAt) {
                    const exp = a.expiresAt.toDate ? a.expiresAt.toDate() : new Date(a.expiresAt);
                    const daysLeft = Math.ceil((exp - new Date()) / (1000 * 60 * 60 * 24));
                    if (daysLeft <= 3) {
                        expiresStr = `<span style="font-size:.55rem;color:#e74c3c;font-weight:600;margin-left:4px">${daysLeft} gÃ¼n</span>`;
                    }
                }
                return `
                    <div class="${animClass}" style="background:${cfg.bg};border:1px solid ${cfg.color}20;border-radius:10px;padding:12px 14px;display:flex;align-items:flex-start;gap:10px;position:relative">
                        <div style="color:${cfg.color};flex-shrink:0;margin-top:1px">${cfg.icon.replace(/18/g, '16')}</div>
                        <div style="flex:1;min-width:0">
                            <div style="display:flex;align-items:center;gap:6px;margin-bottom:2px;flex-wrap:wrap">
                                ${a.title ? `<div style="font-weight:700;color:${cfg.color};font-size:.8rem">${a.title}</div>` : ''}
                                ${dateStr ? `<span style="font-size:.6rem;color:var(--tx3);font-weight:500">${dateStr}</span>` : ''}
                                ${expiresStr}
                            </div>
                            <div style="color:var(--tx2);font-size:.75rem;line-height:1.4">${a.content}</div>
                        </div>
                        ${canEditAnn ? `
                            <div style="position:absolute;top:6px;right:6px;display:flex;gap:4px">
                                <button onclick="showAddPrimAnnouncementModal('${a.id}')" style="background:none;border:none;color:var(--tx3);cursor:pointer;padding:2px;opacity:.5" title="DÃ¼zenle">
                                    <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                </button>
                                <button onclick="deletePrimAnnouncement('${a.id}')" style="background:none;border:none;color:var(--tx3);cursor:pointer;padding:2px;opacity:.5" title="Sil">
                                    <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg>
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
    } catch (e) {
        console.log('Prim duyurularÄ±:', e.message);
    }
    
    // KullanÄ±cÄ± ÅŸube bilgisi
    const userBranchDisplay = currentUser?.role === 'yonetici' ? '' : (currentUser?.role === 'bolge_muduru' ? '' : `<span style="font-size:.75rem;color:var(--tx3);margin-left:6px">(${userBranch})</span>`);
    
    container.innerHTML = `
        <div style="max-width:100%;overflow-x:hidden">
            <!-- Header + Prim Kademeleri -->
            <div style="background:linear-gradient(135deg,rgba(39,174,96,.08),rgba(46,204,113,.04));border:1px solid rgba(39,174,96,.15);border-radius:14px;padding:16px;margin-bottom:12px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px">
                    <div style="display:flex;align-items:center;gap:10px">
                        <div style="width:38px;height:38px;background:linear-gradient(135deg,#27ae60,#2ecc71);border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0">
                            <svg width="18" height="18" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
                        </div>
                        <div>
                            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                                <div style="font-size:1.1rem;font-weight:800;color:var(--tx)">Prim Sistemi</div>
                                ${branchSelectorHtml}
                            </div>
                            <div style="font-size:.75rem;color:var(--tx3)">${activeMonth} DÃ¶nemi${userBranchDisplay}</div>
                        </div>
                    </div>
                    <div style="display:flex;gap:6px;flex-wrap:wrap">
                        <button onclick="showPrimCalculatorModal()" style="background:var(--bg);border:1px solid var(--bg4);color:var(--tx2);padding:7px 12px;border-radius:8px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:4px;font-size:.75rem;flex-shrink:0">
                            <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="8" y1="10" x2="10" y2="10"/><line x1="14" y1="10" x2="16" y2="10"/><line x1="8" y1="14" x2="10" y2="14"/><line x1="14" y1="14" x2="16" y2="14"/><line x1="8" y1="18" x2="16" y2="18"/></svg>
                            Hesapla
                        </button>
                        ${canEdit ? `<button onclick="showPrimEditModal()" style="background:linear-gradient(135deg,#27ae60,#2ecc71);border:none;color:#fff;padding:7px 14px;border-radius:8px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:4px;font-size:.75rem;flex-shrink:0">
                            <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                            DÃ¼zenle
                        </button>` : ''}
                    </div>
                </div>
                
                <!-- Prim Kademeleri - Responsive Grid -->
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));gap:6px">
                    ${tiersHtml}
                </div>
            </div>
            
            <!-- Bilgilendirmeler - ÃœSTTE, TEK SÃœTUN -->
            ${(announcementsHtml || canEditAnn) ? `
            <div style="background:var(--bg);border:1px solid var(--bg4);border-radius:12px;padding:14px;margin-bottom:12px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                    <div style="display:flex;align-items:center;gap:8px">
                        <div style="width:28px;height:28px;background:linear-gradient(135deg,#3498db,#2980b9);border-radius:7px;display:flex;align-items:center;justify-content:center;flex-shrink:0">
                            <svg width="13" height="13" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>
                        </div>
                        <div style="font-size:.85rem;font-weight:700;color:var(--tx)">Bilgilendirmeler</div>
                    </div>
                    ${canEditAnn ? `<button onclick="showAddPrimAnnouncementModal()" style="background:var(--bg2);border:1px solid var(--bg4);color:var(--tx2);padding:5px 10px;border-radius:6px;cursor:pointer;font-size:.7rem;display:flex;align-items:center;gap:4px">
                        <svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
                        Ekle
                    </button>` : ''}
                </div>
                <div style="display:flex;flex-direction:column;gap:8px">
                    ${announcementsHtml || '<div style="text-align:center;padding:16px;color:var(--tx3);font-size:.75rem">HenÃ¼z bilgilendirme yok</div>'}
                </div>
            </div>
            ` : ''}
            
            <!-- YÃ¶netici DeÄŸerlendirmesi -->
            <div style="background:var(--bg);border:1px solid var(--bg4);border-radius:12px;padding:14px;margin-bottom:12px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                    <div style="display:flex;align-items:center;gap:8px">
                        <div style="width:28px;height:28px;background:linear-gradient(135deg,#DAA520,#FFD700);border-radius:7px;display:flex;align-items:center;justify-content:center;flex-shrink:0">
                            <svg width="13" height="13" fill="#fff" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                        </div>
                        <div style="font-weight:700;color:var(--tx);font-size:.85rem">YÃ¶netici DeÄŸerlendirmesi</div>
                    </div>
                    ${canEdit ? `<button onclick="showStarPointsEditModal()" style="background:none;border:none;color:var(--tx3);cursor:pointer;padding:4px;opacity:.6" title="DÃ¼zenle">
                        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                    </button>` : ''}
                </div>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:6px">
                    ${starPointsHtml || '<div style="text-align:center;padding:12px;color:var(--tx3);font-size:.75rem;grid-column:1/-1">YapÄ±landÄ±rÄ±lmamÄ±ÅŸ</div>'}
                </div>
            </div>
            
            <!-- Check PuanlarÄ± - EN ALTTA, 4'LÃœ GRÄ°D -->
            <div style="background:var(--bg);border:1px solid var(--bg4);border-radius:12px;padding:14px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <div style="display:flex;align-items:center;gap:8px">
                        <div style="width:28px;height:28px;background:linear-gradient(135deg,#008c95,#00a8b5);border-radius:7px;display:flex;align-items:center;justify-content:center;flex-shrink:0">
                            <svg width="13" height="13" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
                        </div>
                        <div>
                            <div style="font-weight:700;color:var(--tx);font-size:.85rem">Check PuanlarÄ±</div>
                            <div style="font-size:.6rem;color:var(--tx3)">${checkRulesData.length} check tipi</div>
                        </div>
                    </div>
                    ${canEdit ? `<button onclick="showCheckRulesEditModal()" style="background:none;border:none;color:var(--tx3);cursor:pointer;padding:4px;opacity:.6" title="DÃ¼zenle">
                        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                    </button>` : ''}
                </div>
                <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px">
                    ${checkPointsHtml}
                </div>
            </div>
        </div>
    `;
}

// Åžube deÄŸiÅŸtirme fonksiyonu
function changePrimBranch(branch) {
    window.primSelectedBranch = branch;
    primSettingsCache = null; // Cache'i temizle
    loadPrimSistemiPage();
}


// Prim Bilgilendirmesi Ekle/DÃ¼zenle Modal
async function showAddPrimAnnouncementModal(editId = null) {
    const branches = STATE.branches || [];
    const selectedBranch = window.primSelectedBranch || currentUser?.branch || branches[0] || '';
    const isEdit = !!editId;
    
    // DÃ¼zenleme modunda mevcut veriyi Firebase'den al
    let editData = null;
    if (isEdit) {
        try {
            const doc = await db.collection('primAnnouncements').doc(editId).get();
            if (doc.exists) {
                editData = { id: doc.id, ...doc.data() };
            }
        } catch (e) {
            console.error('Duyuru yÃ¼klenemedi:', e);
        }
    }
    
    const currentType = editData?.type || 'info';
    const currentAnimation = editData?.animation || 'none';
    
    const bodyHtml = `
        <div style="margin-bottom:16px">
            <label style="display:block;font-size:.8rem;font-weight:600;color:var(--tx2);margin-bottom:6px">BaÅŸlÄ±k</label>
            <input type="text" id="primAnnTitle" placeholder="Duyuru baÅŸlÄ±ÄŸÄ±..." value="${editData?.title || ''}"
                style="width:100%;padding:12px;border:1px solid var(--cardBorder);border-radius:8px;font-size:.9rem;background:var(--bg2);color:var(--tx);box-sizing:border-box">
        </div>
        
        <div style="margin-bottom:16px">
            <label style="display:block;font-size:.8rem;font-weight:600;color:var(--tx2);margin-bottom:6px">Ä°Ã§erik</label>
            <textarea id="primAnnContent" rows="3" placeholder="Duyuru iÃ§eriÄŸi..." 
                style="width:100%;padding:12px;border:1px solid var(--cardBorder);border-radius:8px;font-size:.9rem;background:var(--bg2);color:var(--tx);resize:vertical;box-sizing:border-box">${editData?.content || ''}</textarea>
        </div>
        
        <div style="margin-bottom:16px">
            <label style="display:block;font-size:.8rem;font-weight:600;color:var(--tx2);margin-bottom:6px">Duyuru TÃ¼rÃ¼</label>
            <div style="display:flex;flex-wrap:wrap;gap:8px">
                <label class="prim-ann-type-option" data-type="info" style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--bg3);border:2px solid ${currentType === 'info' ? '#008c95' : 'var(--bg4)'};border-radius:10px;cursor:pointer;transition:all .2s">
                    <input type="radio" name="primAnnType" value="info" ${currentType === 'info' ? 'checked' : ''} style="display:none">
                    <svg width="18" height="18" fill="none" stroke="#3498db" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                    <span style="font-size:.85rem;font-weight:500">Bilgilendirme</span>
                </label>
                <label class="prim-ann-type-option" data-type="success" style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--bg3);border:2px solid ${currentType === 'success' ? '#008c95' : 'var(--bg4)'};border-radius:10px;cursor:pointer;transition:all .2s">
                    <input type="radio" name="primAnnType" value="success" ${currentType === 'success' ? 'checked' : ''} style="display:none">
                    <svg width="18" height="18" fill="none" stroke="#27ae60" stroke-width="2" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                    <span style="font-size:.85rem;font-weight:500">Ä°yi Haber</span>
                </label>
                <label class="prim-ann-type-option" data-type="warning" style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--bg3);border:2px solid ${currentType === 'warning' ? '#008c95' : 'var(--bg4)'};border-radius:10px;cursor:pointer;transition:all .2s">
                    <input type="radio" name="primAnnType" value="warning" ${currentType === 'warning' ? 'checked' : ''} style="display:none">
                    <svg width="18" height="18" fill="none" stroke="#f39c12" stroke-width="2" viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                    <span style="font-size:.85rem;font-weight:500">UyarÄ±</span>
                </label>
                <label class="prim-ann-type-option" data-type="urgent" style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--bg3);border:2px solid ${currentType === 'urgent' ? '#008c95' : 'var(--bg4)'};border-radius:10px;cursor:pointer;transition:all .2s">
                    <input type="radio" name="primAnnType" value="urgent" ${currentType === 'urgent' ? 'checked' : ''} style="display:none">
                    <svg width="18" height="18" fill="none" stroke="#e74c3c" stroke-width="2" viewBox="0 0 24 24"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                    <span style="font-size:.85rem;font-weight:500">Acil</span>
                </label>
                <label class="prim-ann-type-option" data-type="tip" style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--bg3);border:2px solid ${currentType === 'tip' ? '#008c95' : 'var(--bg4)'};border-radius:10px;cursor:pointer;transition:all .2s">
                    <input type="radio" name="primAnnType" value="tip" ${currentType === 'tip' ? 'checked' : ''} style="display:none">
                    <svg width="18" height="18" fill="none" stroke="#9b59b6" stroke-width="2" viewBox="0 0 24 24"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                    <span style="font-size:.85rem;font-weight:500">Ä°pucu</span>
                </label>
            </div>
        </div>
        
        <div style="margin-bottom:16px">
            <label style="display:block;font-size:.8rem;font-weight:600;color:var(--tx2);margin-bottom:6px">Animasyon</label>
            <div style="display:flex;flex-wrap:wrap;gap:8px">
                <button type="button" class="prim-animation-option ${currentAnimation === 'none' ? 'selected' : ''}" data-animation="none" 
                    style="padding:8px 14px;background:var(--bg3);border:2px solid ${currentAnimation === 'none' ? '#008c95' : 'var(--bg4)'};border-radius:8px;cursor:pointer;font-size:.8rem;color:var(--tx)">Yok</button>
                <button type="button" class="prim-animation-option ${currentAnimation === 'pulse' ? 'selected' : ''}" data-animation="pulse" 
                    style="padding:8px 14px;background:var(--bg3);border:2px solid ${currentAnimation === 'pulse' ? '#008c95' : 'var(--bg4)'};border-radius:8px;cursor:pointer;font-size:.8rem;color:var(--tx);animation:ann-pulse 2s ease-in-out infinite">NabÄ±z</button>
                <button type="button" class="prim-animation-option ${currentAnimation === 'shake' ? 'selected' : ''}" data-animation="shake" 
                    style="padding:8px 14px;background:var(--bg3);border:2px solid ${currentAnimation === 'shake' ? '#008c95' : 'var(--bg4)'};border-radius:8px;cursor:pointer;font-size:.8rem;color:var(--tx);animation:ann-shake 1s ease-in-out infinite">Sallama</button>
                <button type="button" class="prim-animation-option ${currentAnimation === 'glow' ? 'selected' : ''}" data-animation="glow" 
                    style="padding:8px 14px;background:var(--bg3);border:2px solid ${currentAnimation === 'glow' ? '#008c95' : 'var(--bg4)'};border-radius:8px;cursor:pointer;font-size:.8rem;color:var(--tx);animation:ann-glow 2s ease-in-out infinite">Parlama</button>
                <button type="button" class="prim-animation-option ${currentAnimation === 'bounce' ? 'selected' : ''}" data-animation="bounce" 
                    style="padding:8px 14px;background:var(--bg3);border:2px solid ${currentAnimation === 'bounce' ? '#008c95' : 'var(--bg4)'};border-radius:8px;cursor:pointer;font-size:.8rem;color:var(--tx);animation:ann-bounce 1s ease-in-out infinite">ZÄ±plama</button>
                <button type="button" class="prim-animation-option ${currentAnimation === 'blink' ? 'selected' : ''}" data-animation="blink" 
                    style="padding:8px 14px;background:var(--bg3);border:2px solid ${currentAnimation === 'blink' ? '#008c95' : 'var(--bg4)'};border-radius:8px;cursor:pointer;font-size:.8rem;color:var(--tx);animation:ann-blink 1s ease-in-out infinite">YanÄ±p SÃ¶nme</button>
                <button type="button" class="prim-animation-option ${currentAnimation === 'heartbeat' ? 'selected' : ''}" data-animation="heartbeat" 
                    style="padding:8px 14px;background:var(--bg3);border:2px solid ${currentAnimation === 'heartbeat' ? '#008c95' : 'var(--bg4)'};border-radius:8px;cursor:pointer;font-size:.8rem;color:var(--tx);animation:ann-heartbeat 1.5s ease-in-out infinite">Kalp AtÄ±ÅŸÄ±</button>
            </div>
            <input type="hidden" id="primAnnAnimation" value="${currentAnimation}">
        </div>
        
        <div style="margin-bottom:16px">
            <label style="display:block;font-size:.8rem;font-weight:600;color:var(--tx2);margin-bottom:6px">Otomatik Silinme</label>
            <div style="display:flex;align-items:center;gap:10px">
                <select id="primAnnAutoDelete" style="padding:8px 12px;border:1px solid var(--cardBorder);border-radius:8px;font-size:.85rem;background:var(--bg2);color:var(--tx);cursor:pointer">
                    <option value="0" ${!editData?.expiresAt ? 'selected' : ''}>Silinmesin</option>
                    <option value="1" ${editData?.expiresDays === 1 ? 'selected' : ''}>1 gÃ¼n sonra</option>
                    <option value="3" ${editData?.expiresDays === 3 ? 'selected' : ''}>3 gÃ¼n sonra</option>
                    <option value="7" ${editData?.expiresDays === 7 ? 'selected' : ''}>7 gÃ¼n sonra</option>
                    <option value="14" ${editData?.expiresDays === 14 ? 'selected' : ''}>14 gÃ¼n sonra</option>
                    <option value="30" ${editData?.expiresDays === 30 ? 'selected' : ''}>30 gÃ¼n sonra</option>
                </select>
                <span style="font-size:.75rem;color:var(--tx3)">SÃ¼re dolunca duyuru otomatik silinir</span>
            </div>
        </div>
        
        <div style="margin-bottom:16px">
            <label style="display:block;font-size:.8rem;font-weight:600;color:var(--tx2);margin-bottom:6px">Hedef Åžubeler</label>
            <div id="primBranchSelectionContainer" style="display:flex;flex-wrap:wrap;gap:8px">
                <label class="prim-branch-option selected" data-branch="all" 
                    style="display:flex;align-items:center;gap:6px;padding:8px 12px;background:rgba(0,140,149,.1);border:2px solid #008c95;border-radius:8px;cursor:pointer;font-size:.85rem;transition:all .2s">
                    <span>TÃ¼m Åžubeler</span>
                </label>
                ${branches.map(b => `
                    <label class="prim-branch-option" data-branch="${b}" 
                        style="display:flex;align-items:center;gap:6px;padding:8px 12px;background:var(--bg3);border:2px solid var(--bg4);border-radius:8px;cursor:pointer;font-size:.85rem;transition:all .2s">
                        <span>${b}</span>
                    </label>
                `).join('')}
            </div>
        </div>
    `;
    
    const footerHtml = `
        <button class="btn btn-ghost" onclick="closeModal()">Ä°ptal</button>
        <button class="btn btn-primary" onclick="savePrimAnnouncement('${editId || ''}')" style="background:linear-gradient(135deg,#27ae60,#2ecc71);border:none">${isEdit ? 'Kaydet' : 'Ekle'}</button>
    `;
    
    showModal(isEdit ? 'Bilgilendirme DÃ¼zenle' : 'Yeni Bilgilendirme', bodyHtml, footerHtml);
    
    // Event listener'larÄ± ekle
    setTimeout(() => {
        // Duyuru tÃ¼rÃ¼ seÃ§imi
        document.querySelectorAll('.prim-ann-type-option').forEach(opt => {
            opt.addEventListener('click', function() {
                document.querySelectorAll('.prim-ann-type-option').forEach(o => {
                    o.style.borderColor = 'var(--bg4)';
                    o.style.background = 'var(--bg3)';
                });
                this.style.borderColor = '#008c95';
                this.style.background = 'rgba(0,140,149,.1)';
                this.querySelector('input').checked = true;
            });
            if (opt.querySelector('input:checked')) {
                opt.style.borderColor = '#008c95';
                opt.style.background = 'rgba(0,140,149,.1)';
            }
        });
        
        // Animasyon seÃ§imi
        document.querySelectorAll('.prim-animation-option').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.prim-animation-option').forEach(b => {
                    b.style.borderColor = 'var(--bg4)';
                    b.classList.remove('selected');
                });
                this.style.borderColor = '#008c95';
                this.classList.add('selected');
                document.getElementById('primAnnAnimation').value = this.dataset.animation;
            });
        });
        
        // Åžube seÃ§imi
        document.querySelectorAll('.prim-branch-option').forEach(label => {
            label.addEventListener('click', function() {
                const branch = this.dataset.branch;
                const allOption = document.querySelector('.prim-branch-option[data-branch="all"]');
                
                if (branch === 'all') {
                    document.querySelectorAll('.prim-branch-option').forEach(l => {
                        l.classList.remove('selected');
                        l.style.borderColor = 'var(--bg4)';
                        l.style.background = 'var(--bg3)';
                    });
                    this.classList.add('selected');
                    this.style.borderColor = '#008c95';
                    this.style.background = 'rgba(0,140,149,.1)';
                } else {
                    if (allOption.classList.contains('selected')) {
                        allOption.classList.remove('selected');
                        allOption.style.borderColor = 'var(--bg4)';
                        allOption.style.background = 'var(--bg3)';
                    }
                    this.classList.toggle('selected');
                    if (this.classList.contains('selected')) {
                        this.style.borderColor = '#008c95';
                        this.style.background = 'rgba(0,140,149,.1)';
                    } else {
                        this.style.borderColor = 'var(--bg4)';
                        this.style.background = 'var(--bg3)';
                    }
                    
                    const selectedBranches = document.querySelectorAll('.prim-branch-option.selected:not([data-branch="all"])');
                    if (selectedBranches.length === 0) {
                        allOption.classList.add('selected');
                        allOption.style.borderColor = '#008c95';
                        allOption.style.background = 'rgba(0,140,149,.1)';
                    }
                }
            });
        });
    }, 100);
}

async function savePrimAnnouncement(editId = '') {
    const title = document.getElementById('primAnnTitle')?.value?.trim();
    const content = document.getElementById('primAnnContent')?.value?.trim();
    const announcementType = document.querySelector('input[name="primAnnType"]:checked')?.value || 'info';
    const animation = document.getElementById('primAnnAnimation')?.value || 'none';
    const autoDeleteDays = parseInt(document.getElementById('primAnnAutoDelete')?.value) || 0;
    
    if (!title && !content) {
        toast('BaÅŸlÄ±k veya iÃ§erik gerekli', 'error');
        return;
    }
    
    // SeÃ§ili ÅŸubeleri al
    const allSelected = document.querySelector('.prim-branch-option[data-branch="all"].selected');
    let branches = ['all'];
    if (!allSelected) {
        branches = Array.from(document.querySelectorAll('.prim-branch-option.selected:not([data-branch="all"])')).map(l => l.dataset.branch);
        if (branches.length === 0) branches = ['all'];
    }
    
    const data = {
        title: title || '',
        content: content || '',
        branches,
        type: announcementType,
        animation,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    // Otomatik silinme
    if (autoDeleteDays > 0) {
        const expiresAt = new Date();
        expiresAt.setDate(expiresAt.getDate() + autoDeleteDays);
        data.expiresAt = firebase.firestore.Timestamp.fromDate(expiresAt);
        data.expiresDays = autoDeleteDays;
    } else {
        data.expiresAt = null;
        data.expiresDays = null;
    }
    
    try {
        if (editId) {
            await db.collection('primAnnouncements').doc(editId).update(data);
            toast('Bilgilendirme gÃ¼ncellendi', 'success');
        } else {
            data.createdBy = currentUser?.email || currentUser?.username;
            data.createdByName = currentUser?.codeName?.split(' ')[0] || currentUser?.name?.split(' ')[0] || 'YÃ¶netici';
            data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            await db.collection('primAnnouncements').add(data);
            toast('Bilgilendirme eklendi', 'success');
        }
        
        closeModal();
        loadPrimSistemiPage();
    } catch (e) {
        console.error('Bilgilendirme kaydedilemedi:', e);
        toast('Kaydetme hatasÄ±', 'error');
    }
}

async function deletePrimAnnouncement(id) {
    if (!confirm('Bu bilgilendirmeyi silmek istediÄŸinize emin misiniz?')) return;
    
    try {
        await db.collection('primAnnouncements').doc(id).delete();
        toast('Bilgilendirme silindi', 'success');
        loadPrimSistemiPage();
    } catch (e) {
        toast('Silme hatasÄ±', 'error');
    }
}

// ========== CHECK PUANLARI DÃœZENLEME ==========
async function showCheckRulesEditModal() {
    // Mevcut check rules'larÄ± al
    const checkTypes = [
        { id: 'gunluk', name: 'GÃ¼nlÃ¼k Genel Check' },
        { id: 'platform', name: 'Platform Check' },
        { id: 'acilis', name: 'AÃ§Ä±lÄ±ÅŸ' },
        { id: 'kapanis', name: 'KapanÄ±ÅŸ' },
        { id: 'mudur', name: 'MÃ¼dÃ¼r Kontrol' },
        { id: 'aylik', name: 'Temizlik ve BakÄ±m' },
        { id: 'haftalik', name: 'HaftalÄ±k GÃ¶revler' }
    ];
    
    let rowsHtml = checkTypes.map(ct => {
        const rule = CHECK_RULES[ct.id] || {};
        const pts = rule.points || { onTime: 0, late: 0, missed: 0 };
        const supPenalty = rule.supervisorPenalty ?? -0.5;
        return `
            <div style="display:grid;grid-template-columns:1fr repeat(4,60px);gap:6px;align-items:center;padding:10px 12px;background:var(--bg2);border-radius:8px">
                <div style="font-weight:600;color:var(--tx);font-size:.75rem">${ct.name}</div>
                <input type="number" data-check="${ct.id}" data-field="onTime" value="${pts.onTime}" 
                    style="width:100%;padding:6px;border:1px solid var(--bg4);border-radius:6px;background:rgba(39,174,96,.08);color:#27ae60;font-weight:700;text-align:center;font-size:.8rem">
                <input type="number" data-check="${ct.id}" data-field="late" value="${pts.late}" 
                    style="width:100%;padding:6px;border:1px solid var(--bg4);border-radius:6px;background:rgba(230,126,34,.08);color:#e67e22;font-weight:700;text-align:center;font-size:.8rem">
                <input type="number" data-check="${ct.id}" data-field="missed" value="${pts.missed}" 
                    style="width:100%;padding:6px;border:1px solid var(--bg4);border-radius:6px;background:rgba(231,76,60,.08);color:#e74c3c;font-weight:700;text-align:center;font-size:.8rem">
                <input type="number" step="0.1" data-check="${ct.id}" data-field="supervisorPenalty" value="${supPenalty}" 
                    style="width:100%;padding:6px;border:1px solid var(--bg4);border-radius:6px;background:rgba(155,89,182,.08);color:#9b59b6;font-weight:700;text-align:center;font-size:.8rem">
            </div>
        `;
    }).join('');
    
    const body = `
        <div style="margin-bottom:12px">
            <div style="display:grid;grid-template-columns:1fr repeat(4,60px);gap:6px;padding:0 12px;margin-bottom:8px">
                <div style="font-size:.65rem;color:var(--tx3);font-weight:600">CHECK TÄ°PÄ°</div>
                <div style="font-size:.65rem;color:#27ae60;font-weight:600;text-align:center">VAKTÄ°NDE</div>
                <div style="font-size:.65rem;color:#e67e22;font-weight:600;text-align:center">GEÃ‡</div>
                <div style="font-size:.65rem;color:#e74c3c;font-weight:600;text-align:center">YAPILMADI</div>
                <div style="font-size:.65rem;color:#9b59b6;font-weight:600;text-align:center">MÃœDÃœR</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:6px;max-height:50vh;overflow-y:auto">
                ${rowsHtml}
            </div>
        </div>
        <div style="font-size:.7rem;color:var(--tx3);padding:10px;background:var(--bg2);border-radius:8px">
            <strong>MÃ¼dÃ¼r SÃ¼tunu:</strong> Personel check'i doldurmadÄ±ÄŸÄ±nda mÃ¼dÃ¼r/yardÄ±mcÄ±ya yazÄ±lacak eksi puan.
        </div>
    `;
    
    showModal('Check PuanlarÄ± DÃ¼zenle', body, `
        <button class="btn btn-ghost" onclick="closeModal()">Ä°ptal</button>
        <button class="btn btn-primary" onclick="saveCheckRules()">Kaydet</button>
    `);
}

async function saveCheckRules() {
    const inputs = document.querySelectorAll('[data-check][data-field]');
    const updates = {};
    
    inputs.forEach(inp => {
        const checkId = inp.dataset.check;
        const field = inp.dataset.field;
        // supervisorPenalty iÃ§in float, diÄŸerleri iÃ§in int
        const value = field === 'supervisorPenalty' 
            ? parseFloat(inp.value) || 0 
            : parseInt(inp.value) || 0;
        
        if (!updates[checkId]) updates[checkId] = { points: {}, supervisorPenalty: 0 };
        
        if (field === 'supervisorPenalty') {
            updates[checkId].supervisorPenalty = value;
        } else {
            updates[checkId].points[field] = value;
        }
    });
    
    try {
        // Global CHECK_RULES gÃ¼ncelle
        Object.keys(updates).forEach(checkId => {
            if (CHECK_RULES[checkId]) {
                CHECK_RULES[checkId].points = {
                    ...CHECK_RULES[checkId].points,
                    ...updates[checkId].points
                };
                CHECK_RULES[checkId].supervisorPenalty = updates[checkId].supervisorPenalty;
            }
        });
        
        // Firebase'e kaydet - systemConfig/checkRules
        await db.collection('systemConfig').doc('checkRules').set({
            rules: CHECK_RULES,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedBy: currentUser?.email
        }, { merge: true });
        
        // Firebase'e kaydet - config/system (sayfa yÃ¼klenirken buradan okunuyor)
        await db.collection('config').doc('system').set({
            checkRules: CHECK_RULES,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        
        console.log('[saveCheckRules] Her iki konuma da kaydedildi');
        toast('Check puanlarÄ± kaydedildi', 'success');
        closeModal();
        loadPrimSistemiPage();
    } catch (e) {
        console.error('Kaydetme hatasÄ±:', e);
        toast('Kaydetme hatasÄ±', 'error');
    }
}

// ========== YILDIZ PUANLARI DÃœZENLEME ==========
async function showStarPointsEditModal() {
    const starConfig = window.starPointsConfig || {};
    
    const defaultLabels = {
        1: 'Ã‡ok KÃ¶tÃ¼',
        2: 'KÃ¶tÃ¼', 
        3: 'Orta',
        4: 'Ä°yi',
        5: 'Ã‡ok Ä°yi'
    };
    
    const defaultColors = {
        1: '#e74c3c',
        2: '#e67e22',
        3: '#f1c40f',
        4: '#27ae60',
        5: '#2ecc71'
    };
    
    let rowsHtml = '';
    for (let star = 1; star <= 5; star++) {
        const cfg = starConfig[star] || { label: defaultLabels[star], points: star - 3, color: defaultColors[star] };
        const starStr = 'â˜…'.repeat(star) + 'â˜†'.repeat(5 - star);
        rowsHtml += `
            <div style="display:grid;grid-template-columns:80px 1fr 80px;gap:10px;align-items:center;padding:12px;background:var(--bg2);border-radius:8px">
                <div style="color:${cfg.color || defaultColors[star]};font-size:1rem;letter-spacing:-2px">${starStr}</div>
                <input type="text" data-star="${star}" data-field="label" value="${cfg.label || defaultLabels[star]}" 
                    placeholder="Etiket"
                    style="width:100%;padding:8px 10px;border:1px solid var(--bg4);border-radius:6px;background:var(--bg);color:var(--tx);font-size:.85rem">
                <input type="number" data-star="${star}" data-field="points" value="${cfg.points}" 
                    style="width:100%;padding:8px;border:1px solid var(--bg4);border-radius:6px;background:var(--bg);color:var(--tx);font-weight:700;text-align:center;font-size:.9rem">
            </div>
        `;
    }
    
    const body = `
        <div style="margin-bottom:12px">
            <div style="display:grid;grid-template-columns:80px 1fr 80px;gap:10px;padding:0 12px;margin-bottom:8px">
                <div style="font-size:.7rem;color:var(--tx3);font-weight:600">YILDIZ</div>
                <div style="font-size:.7rem;color:var(--tx3);font-weight:600">ETÄ°KET</div>
                <div style="font-size:.7rem;color:var(--tx3);font-weight:600;text-align:center">PUAN</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:6px">
                ${rowsHtml}
            </div>
        </div>
        <div style="font-size:.7rem;color:var(--tx3);padding:10px;background:var(--bg2);border-radius:8px">
            <strong>Ã–rnek:</strong> 1â˜… = -3, 2â˜… = -2, 3â˜… = 0, 4â˜… = +1, 5â˜… = +2
        </div>
    `;
    
    showModal('YÄ±ldÄ±z PuanlarÄ± DÃ¼zenle', body, `
        <button class="btn btn-ghost" onclick="closeModal()">Ä°ptal</button>
        <button class="btn btn-primary" onclick="saveStarPoints()">Kaydet</button>
    `);
}

async function saveStarPoints() {
    const inputs = document.querySelectorAll('[data-star][data-field]');
    const config = {};
    
    const defaultColors = {
        1: '#e74c3c',
        2: '#e67e22',
        3: '#f1c40f',
        4: '#27ae60',
        5: '#2ecc71'
    };
    
    inputs.forEach(inp => {
        const star = inp.dataset.star;
        const field = inp.dataset.field;
        const value = field === 'points' ? parseInt(inp.value) || 0 : inp.value;
        
        if (!config[star]) config[star] = { color: defaultColors[star] };
        config[star][field] = value;
    });
    
    try {
        // Firebase'e kaydet
        await db.collection('config').doc('starPoints').set({
            ...config,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedBy: currentUser?.email
        });
        
        // Global config gÃ¼ncelle
        window.starPointsConfig = config;
        
        toast('YÄ±ldÄ±z puanlarÄ± kaydedildi', 'success');
        closeModal();
        loadPrimSistemiPage();
    } catch (e) {
        console.error('Kaydetme hatasÄ±:', e);
        toast('Kaydetme hatasÄ±', 'error');
    }
}

// ========== PRÄ°M HESAPLAMA MODAL ==========
async function showPrimCalculatorModal() {
    const selectedBranch = window.primSelectedBranch || currentUser?.branch || '';
    const now = new Date();
    const periodKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    const monthName = now.toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' });
    
    // Prim kademelerini al
    let tiers = [];
    try {
        const settingsDoc = await db.collection('settings').doc('primSystem').get();
        if (settingsDoc.exists) {
            const s = settingsDoc.data();
            tiers = s.branchSettings?.[selectedBranch]?.tiers || s.tiers || [];
        }
    } catch (e) {
        console.error('Prim ayarlarÄ± yÃ¼klenemedi:', e);
    }
    
    // Personel listesi
    let personelOptions = '<option value="">Personel seÃ§in...</option>';
    try {
        const personelSnap = await db.collection('personel')
            .where('status', '!=', 'inactive')
            .get();
        
        personelSnap.forEach(doc => {
            const p = doc.data();
            if (p.branch === selectedBranch || selectedBranch === 'all' || p.branch === 'all') {
                const displayName = p.codeName || p.name?.split(' ')[0] || p.name;
                personelOptions += `<option value="${doc.id}" data-name="${p.name}">${displayName}</option>`;
            }
        });
    } catch (e) {
        console.error('Personel yÃ¼klenemedi:', e);
    }
    
    // Kademe gÃ¶sterimi
    const tiersHtml = tiers.length > 0 ? tiers.map((t, i) => {
        const color = t.color || '#27ae60';
        return `
            <div class="prim-calc-tier" data-min="${parseCiroValue(t.minCiro)}" data-prim="${parseCiroValue(t.prim)}" 
                style="padding:10px;background:var(--bg2);border:1px solid var(--bg4);border-radius:8px;text-align:center;transition:all .2s">
                <div style="font-size:.65rem;color:var(--tx3);margin-bottom:2px">${t.label || 'Kademe ' + (i+1)}</div>
                <div style="font-size:.8rem;font-weight:700;color:var(--tx)">${t.minCiro}</div>
                <div style="font-size:.9rem;font-weight:800;color:${color}">${t.prim}</div>
            </div>
        `;
    }).join('') : '<div style="text-align:center;color:var(--tx3);font-size:.8rem;grid-column:1/-1">Kademe tanÄ±mlÄ± deÄŸil</div>';
    
    const body = `
        <div style="margin-bottom:16px">
            <label style="display:block;font-size:.8rem;font-weight:600;color:var(--tx2);margin-bottom:6px">Personel</label>
            <select id="primCalcPersonel" onchange="updatePrimCalcPoints()" style="width:100%;padding:10px 12px;border:1px solid var(--bg4);border-radius:8px;font-size:.9rem;background:var(--bg2);color:var(--tx)">
                ${personelOptions}
            </select>
        </div>
        
        <div style="margin-bottom:16px">
            <label style="display:block;font-size:.8rem;font-weight:600;color:var(--tx2);margin-bottom:6px">AylÄ±k Ciro (â‚º)</label>
            <input type="text" id="primCalcCiro" placeholder="Ã¶rn: 55000" oninput="calculatePrim()"
                style="width:100%;padding:12px;border:1px solid var(--bg4);border-radius:8px;font-size:1.1rem;font-weight:700;background:var(--bg2);color:var(--tx);text-align:center;box-sizing:border-box">
        </div>
        
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(70px,1fr));gap:6px;margin-bottom:16px">
            ${tiersHtml}
        </div>
        
        <div id="primCalcPointsSection" style="display:none;margin-bottom:16px;padding:12px;background:var(--bg2);border-radius:10px">
            <div style="font-size:.75rem;font-weight:600;color:var(--tx2);margin-bottom:8px">Personel PuanÄ± (${monthName})</div>
            <div style="display:flex;justify-content:space-between;align-items:center">
                <div id="primCalcPointsDetail" style="font-size:.8rem;color:var(--tx3)">-</div>
                <div id="primCalcPointsTotal" style="font-size:1.2rem;font-weight:800">-</div>
            </div>
        </div>
        
        <div id="primCalcResult" style="display:none;padding:20px;background:linear-gradient(135deg,rgba(39,174,96,.1),rgba(46,204,113,.05));border:2px solid rgba(39,174,96,.2);border-radius:12px;text-align:center">
            <div style="font-size:.75rem;color:var(--tx3);margin-bottom:4px">Hesaplanan Prim</div>
            <div id="primCalcAmount" style="font-size:2rem;font-weight:800;color:#27ae60">â‚º0</div>
            <div id="primCalcTier" style="font-size:.8rem;color:var(--tx2);margin-top:4px">-</div>
        </div>
        
        <div id="primCalcNoTier" style="display:none;padding:16px;background:rgba(231,76,60,.08);border:1px solid rgba(231,76,60,.2);border-radius:10px;text-align:center">
            <div style="font-size:.85rem;color:#e74c3c;font-weight:600">Ciro prim kademesine ulaÅŸmadÄ±</div>
            <div id="primCalcNextTier" style="font-size:.75rem;color:var(--tx3);margin-top:4px">-</div>
        </div>
    `;
    
    showModal(`Prim Hesapla - ${monthName}`, body, `
        <button class="btn btn-ghost" onclick="closeModal()">Kapat</button>
    `);
}

function parseCiroValue(str) {
    if (!str) return 0;
    // "45.000â‚º" veya "45000" veya "45K" formatlarÄ±nÄ± parse et
    const cleaned = String(str).replace(/[â‚º.\s]/g, '').replace(/K/gi, '000').replace(/k/gi, '000');
    return parseInt(cleaned) || 0;
}

function formatCurrency(num) {
    return new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY', maximumFractionDigits: 0 }).format(num);
}

async function updatePrimCalcPoints() {
    const personelId = document.getElementById('primCalcPersonel')?.value;
    const pointsSection = document.getElementById('primCalcPointsSection');
    const pointsDetail = document.getElementById('primCalcPointsDetail');
    const pointsTotal = document.getElementById('primCalcPointsTotal');
    
    if (!personelId || !pointsSection) {
        if (pointsSection) pointsSection.style.display = 'none';
        return;
    }
    
    pointsSection.style.display = 'block';
    pointsDetail.textContent = 'YÃ¼kleniyor...';
    pointsTotal.textContent = '-';
    
    try {
        const now = new Date();
        const periodKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        const monthStart = `${periodKey}-01`;
        const monthEnd = `${periodKey}-31`;
        
        // Personel adÄ±nÄ± al
        const personelDoc = await db.collection('personel').doc(personelId).get();
        const personelName = personelDoc.exists ? personelDoc.data().name : '';
        const normalizedId = normalizePersonelId(personelName);
        
        let totalPoints = 0;
        let onTime = 0, late = 0, missed = 0, manual = 0;
        
        // 1. puantajNotes
        const notesSnap = await db.collection('puantajNotes')
            .where('personelId', '==', normalizedId)
            .get();
        
        notesSnap.forEach(doc => {
            const d = doc.data();
            if (d.date >= monthStart && d.date <= monthEnd) {
                totalPoints += d.points || 0;
                if (d.status === 'onTime') onTime++;
                else if (d.status === 'late') late++;
                else if (d.status === 'missed') missed++;
            }
        });
        
        // 2. puantaj (manuel)
        const puantajSnap = await db.collection('puantaj')
            .where('personelId', '==', personelId)
            .where('period', '==', periodKey)
            .get();
        
        puantajSnap.forEach(doc => {
            const d = doc.data();
            totalPoints += getPointsFromStar(d.score || 3);
            manual++;
        });
        
        // GÃ¶ster
        const details = [];
        if (onTime > 0) details.push(`${onTime} vaktinde`);
        if (late > 0) details.push(`${late} geÃ§`);
        if (missed > 0) details.push(`${missed} kaÃ§Ä±rÄ±lan`);
        if (manual > 0) details.push(`${manual} deÄŸerlendirme`);
        
        pointsDetail.textContent = details.length > 0 ? details.join(' â€¢ ') : 'KayÄ±t yok';
        
        const color = totalPoints > 0 ? '#27ae60' : totalPoints < 0 ? '#e74c3c' : 'var(--tx)';
        pointsTotal.style.color = color;
        pointsTotal.textContent = (totalPoints > 0 ? '+' : '') + totalPoints + ' puan';
        
    } catch (e) {
        console.error('Puan yÃ¼kleme hatasÄ±:', e);
        pointsDetail.textContent = 'Hata';
        pointsTotal.textContent = '-';
    }
}

function calculatePrim() {
    const ciroInput = document.getElementById('primCalcCiro');
    const resultDiv = document.getElementById('primCalcResult');
    const noTierDiv = document.getElementById('primCalcNoTier');
    const amountEl = document.getElementById('primCalcAmount');
    const tierEl = document.getElementById('primCalcTier');
    const nextTierEl = document.getElementById('primCalcNextTier');
    
    if (!ciroInput || !resultDiv) return;
    
    const ciro = parseCiroValue(ciroInput.value);
    
    // TÃ¼m tier elementlerini bul
    const tierEls = document.querySelectorAll('.prim-calc-tier');
    let matchedTier = null;
    let matchedPrim = 0;
    let nextTier = null;
    
    // En yÃ¼ksekten baÅŸlayarak kontrol et
    const tiersData = [];
    tierEls.forEach(el => {
        tiersData.push({
            el,
            min: parseInt(el.dataset.min) || 0,
            prim: parseInt(el.dataset.prim) || 0
        });
    });
    
    // minCiro'ya gÃ¶re sÄ±rala (kÃ¼Ã§Ã¼kten bÃ¼yÃ¼ÄŸe)
    tiersData.sort((a, b) => a.min - b.min);
    
    // Renkleri sÄ±fÄ±rla
    tiersData.forEach(t => {
        t.el.style.border = '1px solid var(--bg4)';
        t.el.style.background = 'var(--bg2)';
    });
    
    // EÅŸleÅŸen kademeyi bul (en yÃ¼ksek ulaÅŸÄ±lan)
    for (let i = tiersData.length - 1; i >= 0; i--) {
        if (ciro >= tiersData[i].min) {
            matchedTier = tiersData[i];
            matchedPrim = tiersData[i].prim;
            break;
        }
    }
    
    // Bir sonraki kademeyi bul
    if (!matchedTier && tiersData.length > 0) {
        nextTier = tiersData[0];
    } else if (matchedTier) {
        const idx = tiersData.indexOf(matchedTier);
        if (idx < tiersData.length - 1) {
            nextTier = tiersData[idx + 1];
        }
    }
    
    if (ciro > 0 && matchedTier) {
        // EÅŸleÅŸen kademeyi vurgula
        matchedTier.el.style.border = '2px solid #27ae60';
        matchedTier.el.style.background = 'rgba(39,174,96,.1)';
        
        resultDiv.style.display = 'block';
        noTierDiv.style.display = 'none';
        amountEl.textContent = formatCurrency(matchedPrim);
        
        if (nextTier) {
            const remaining = nextTier.min - ciro;
            tierEl.textContent = `Sonraki kademe iÃ§in ${formatCurrency(remaining)} daha`;
        } else {
            tierEl.textContent = 'En yÃ¼ksek kademedesiniz! ðŸŽ‰';
        }
    } else if (ciro > 0) {
        resultDiv.style.display = 'none';
        noTierDiv.style.display = 'block';
        if (nextTier) {
            const remaining = nextTier.min - ciro;
            nextTierEl.textContent = `Ä°lk kademe iÃ§in ${formatCurrency(remaining)} daha gerekli`;
        }
    } else {
        resultDiv.style.display = 'none';
        noTierDiv.style.display = 'none';
    }
}

// ========== SUPERVISOR PENALTY SÄ°STEMÄ° ==========
// Personel check kaÃ§Ä±rdÄ±ÄŸÄ±nda mÃ¼dÃ¼r/yardÄ±mcÄ±ya eksi puan yazÄ±lÄ±r

/**
 * ISO hafta numarasÄ±nÄ± hesapla
 */
function getWeekNumber(date) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}

/**
 * Shift verilerinden o saatteki mÃ¼dÃ¼r/yardÄ±mcÄ±larÄ± bul
 * @param {string} branch - Åžube
 * @param {string} date - Tarih (YYYY-MM-DD)
 * @param {number} hour - Saat (0-23)
 * @returns {Promise<Array>} - MÃ¼dÃ¼r/yardÄ±mcÄ± listesi
 */
async function getSupervisorsOnDuty(branch, date, hour) {
    const supervisors = [];
    
    try {
        // Shift verisini al
        const dateObj = new Date(date);
        const dayOfWeek = dateObj.getDay();
        const dayIndex = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
        
        // Shift koleksiyonundan veri Ã§ek
        const shiftKey = `${dateObj.getFullYear()}-W${getWeekNumber(dateObj)}`;
        const shiftDoc = await db.collection('shifts').doc(`${branch}_${shiftKey}`).get();
        
        if (!shiftDoc.exists) {
            // Fallback: Personel koleksiyonundan mÃ¼dÃ¼rleri al
            const personelSnap = await db.collection('personel')
                .where('branch', '==', branch)
                .where('status', '==', 'active')
                .get();
            
            personelSnap.forEach(doc => {
                const p = doc.data();
                if (['magaza_muduru', 'mudur_yardimcisi', 'magaza_mudur_yardimcisi'].includes(p.role)) {
                    supervisors.push({
                        id: doc.id,
                        name: p.codeName || p.name?.split(' ')[0] || p.name,
                        fullName: p.name,
                        role: p.role
                    });
                }
            });
            return supervisors;
        }
        
        const shiftData = shiftDoc.data();
        const { personelShifts = {}, personelNames = {}, personelFullNames = {}, personelRoles = {} } = shiftData;
        
        // Her personel iÃ§in shift kontrolÃ¼
        for (const [uniqueId, days] of Object.entries(personelShifts)) {
            const role = personelRoles[uniqueId] || '';
            if (!['magaza_muduru', 'mudur_yardimcisi', 'magaza_mudur_yardimcisi'].includes(role)) continue;
            
            const todayShift = days[dayIndex] || '';
            if (!todayShift || todayShift.toUpperCase() === 'X' || todayShift.toUpperCase() === 'OFF') continue;
            
            // Shift saatini parse et
            const shiftTime = parseShiftTime(todayShift);
            if (!shiftTime) continue;
            
            // Check saati shift iÃ§inde mi?
            let isOnDuty = false;
            if (shiftTime.endHour > shiftTime.startHour) {
                // Normal shift (Ã¶rn: 10-19)
                isOnDuty = hour >= shiftTime.startHour && hour < shiftTime.endHour;
            } else {
                // Gece geÃ§iÅŸli shift (Ã¶rn: 16-01)
                isOnDuty = hour >= shiftTime.startHour || hour < shiftTime.endHour;
            }
            
            if (isOnDuty) {
                supervisors.push({
                    id: uniqueId,
                    name: personelNames[uniqueId] || uniqueId,
                    fullName: personelFullNames[uniqueId] || uniqueId,
                    role: role
                });
            }
        }
    } catch (e) {
        console.error('[SupervisorPenalty] Shift veri hatasÄ±:', e);
    }
    
    return supervisors;
}

/**
 * Personel check kaÃ§Ä±rdÄ±ÄŸÄ±nda supervisor penalty yaz
 * @param {Object} params - Parametreler
 */
async function writeSupervisorPenalty(params) {
    const { personelId, personelName, checkType, checkTime, date, branch } = params;
    
    // CHECK_RULES'dan penalty deÄŸerini al
    const checkTypeId = canonicalChecklistTypeId?.(checkType) || checkType.toLowerCase().replace(/[^a-z]/g, '');
    const rules = CHECK_RULES[checkTypeId] || CHECK_RULES['gunluk'] || {};
    const penalty = rules.supervisorPenalty ?? -0.5;
    
    // Penalty 0 ise yazma
    if (penalty === 0) return;
    
    // Check saatini parse et
    const checkHour = parseInt(checkTime?.split(':')[0]) || 12;
    
    // O saatteki mÃ¼dÃ¼r/yardÄ±mcÄ±larÄ± bul
    const supervisors = await getSupervisorsOnDuty(branch, date, checkHour);
    
    if (supervisors.length === 0) {
        console.log('[SupervisorPenalty] GÃ¶revde mÃ¼dÃ¼r/yardÄ±mcÄ± bulunamadÄ±:', { date, checkHour, branch });
        return;
    }
    
    console.log('[SupervisorPenalty] YazÄ±lacak:', { personelName, checkType, supervisors: supervisors.map(s => s.name) });
    
    // Her mÃ¼dÃ¼r/yardÄ±mcÄ± iÃ§in penalty yaz
    const batch = db.batch();
    const now = new Date();
    
    for (const supervisor of supervisors) {
        const penaltyId = `${date}_${checkTypeId}_${checkTime?.replace(':', '')}_${personelId}_${supervisor.id}`;
        const penaltyRef = db.collection('supervisorPenalties').doc(penaltyId);
        
        batch.set(penaltyRef, {
            supervisorId: supervisor.id,
            supervisorName: supervisor.name,
            supervisorFullName: supervisor.fullName,
            supervisorRole: supervisor.role,
            personelId: personelId,
            personelName: personelName,
            checkType: checkTypeId,
            checkTypeName: rules.name || checkType,
            checkTime: checkTime || '',
            date: date,
            penalty: penalty,
            branch: branch,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            month: date.substring(0, 7) // YYYY-MM
        }, { merge: true });
    }
    
    try {
        await batch.commit();
        console.log('[SupervisorPenalty] BaÅŸarÄ±yla yazÄ±ldÄ±:', supervisors.length, 'kayÄ±t');
    } catch (e) {
        console.error('[SupervisorPenalty] Yazma hatasÄ±:', e);
    }
}

/**
 * Supervisor penalty kayÄ±tlarÄ±nÄ± yÃ¼kle
 * @param {string} supervisorId - MÃ¼dÃ¼r/yardÄ±mcÄ± ID
 * @param {string} month - Ay (YYYY-MM)
 * @returns {Promise<Array>} - Penalty kayÄ±tlarÄ±
 */
async function loadSupervisorPenalties(supervisorId, month) {
    try {
        const snap = await db.collection('supervisorPenalties')
            .where('supervisorId', '==', supervisorId)
            .where('month', '==', month)
            .orderBy('date', 'desc')
            .limit(100)
            .get();
        
        const penalties = [];
        snap.forEach(doc => {
            penalties.push({ id: doc.id, ...doc.data() });
        });
        
        return penalties;
    } catch (e) {
        console.error('[SupervisorPenalty] YÃ¼kleme hatasÄ±:', e);
        return [];
    }
}

/**
 * Supervisor penalty toplamÄ±nÄ± hesapla
 * @param {string} supervisorId - MÃ¼dÃ¼r/yardÄ±mcÄ± ID
 * @param {string} month - Ay (YYYY-MM)
 * @returns {Promise<number>} - Toplam penalty
 */
async function calculateSupervisorPenaltyTotal(supervisorId, month) {
    const penalties = await loadSupervisorPenalties(supervisorId, month);
    return penalties.reduce((sum, p) => sum + (p.penalty || 0), 0);
}

/**
 * Firebase'e supervisorPenalty default deÄŸerlerini kaydet
 * Console'dan bir kerelik Ã§alÄ±ÅŸtÄ±rÄ±lacak
 */
async function saveSupervisorPenaltyDefaults() {
    try {
        // systemConfig/checkRules'a supervisorPenalty ekle
        const doc = await db.collection('systemConfig').doc('checkRules').get();
        const existingRules = doc.exists ? (doc.data().rules || {}) : {};
        
        // Her check tipi iÃ§in supervisorPenalty ekle
        const updatedRules = {};
        Object.keys(CHECK_RULES).forEach(key => {
            updatedRules[key] = {
                ...existingRules[key],
                ...CHECK_RULES[key],
                supervisorPenalty: CHECK_RULES[key].supervisorPenalty ?? existingRules[key]?.supervisorPenalty ?? -0.5
            };
        });
        
        await db.collection('systemConfig').doc('checkRules').set({
            rules: updatedRules,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedBy: currentUser?.email
        }, { merge: true });
        
        // config/system'a da kaydet
        const sysDoc = await db.collection('config').doc('system').get();
        const sysRules = sysDoc.exists ? (sysDoc.data().checkRules || {}) : {};
        
        const updatedSysRules = {};
        Object.keys(CHECK_RULES).forEach(key => {
            updatedSysRules[key] = {
                ...sysRules[key],
                ...CHECK_RULES[key],
                supervisorPenalty: CHECK_RULES[key].supervisorPenalty ?? sysRules[key]?.supervisorPenalty ?? -0.5
            };
        });
        
        await db.collection('config').doc('system').set({
            checkRules: updatedSysRules,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        
        console.log('âœ… supervisorPenalty default deÄŸerleri Firebase\'e kaydedildi');
        toast('supervisorPenalty kaydedildi', 'success');
        return true;
    } catch (e) {
        console.error('âŒ supervisorPenalty kaydetme hatasÄ±:', e);
        toast('Kaydetme hatasÄ±', 'error');
        return false;
    }
}

/**
 * Eksik supervisor penalty kayÄ±tlarÄ±nÄ± tamamla (Fallback)
 * Puantaj sayfasÄ± yÃ¼klendiÄŸinde Ã§aÄŸrÄ±lÄ±r
 * @param {string} branch - Åžube
 * @param {string} month - Ay (YYYY-MM)
 */
async function fillMissingSupervisorPenalties(branch, month) {
    // Sadece mÃ¼dÃ¼r/yardÄ±mcÄ± yetkisi olanlar iÃ§in Ã§alÄ±ÅŸ
    const role = currentUser?.role;
    if (!['yonetici', 'bolge_muduru', 'magaza_muduru'].includes(role)) return;
    
    try {
        // Son 7 gÃ¼nÃ¼n missed check'lerini al
        const now = new Date();
        const startDate = new Date(now);
        startDate.setDate(startDate.getDate() - 7);
        const startDateStr = startDate.toISOString().split('T')[0];
        
        const missedChecks = await db.collection('puantajNotes')
            .where('branch', '==', branch)
            .where('status', '==', 'missed')
            .where('date', '>=', startDateStr)
            .limit(100)
            .get();
        
        if (missedChecks.empty) return;
        
        // Mevcut penalty'leri al (Ã§akÄ±ÅŸma kontrolÃ¼ iÃ§in)
        const existingPenalties = await db.collection('supervisorPenalties')
            .where('branch', '==', branch)
            .where('month', '==', month)
            .get();
        
        const existingIds = new Set();
        existingPenalties.forEach(doc => existingIds.add(doc.id));
        
        let writtenCount = 0;
        
        for (const doc of missedChecks.docs) {
            const check = doc.data();
            
            // Bu check iÃ§in penalty yazÄ±lmÄ±ÅŸ mÄ± kontrol et
            const checkTypeId = canonicalChecklistTypeId?.(check.checkType) || check.checkType?.toLowerCase().replace(/[^a-z]/g, '') || 'gunluk';
            const checkHour = parseInt(check.checkTime?.split(':')[0]) || 12;
            
            // O saatteki supervisorlarÄ± bul
            const supervisors = await getSupervisorsOnDuty(branch, check.date, checkHour);
            
            for (const sup of supervisors) {
                const penaltyId = `${check.date}_${checkTypeId}_${(check.checkTime || '').replace(':', '')}_${check.personelId}_${sup.id}`;
                
                // Zaten varsa atla
                if (existingIds.has(penaltyId)) continue;
                
                // Penalty yaz
                const rules = CHECK_RULES[checkTypeId] || CHECK_RULES['gunluk'] || {};
                const penalty = rules.supervisorPenalty ?? -0.5;
                
                if (penalty === 0) continue;
                
                await db.collection('supervisorPenalties').doc(penaltyId).set({
                    supervisorId: sup.id,
                    supervisorName: sup.name,
                    supervisorFullName: sup.fullName,
                    supervisorRole: sup.role,
                    personelId: check.personelId,
                    personelName: check.personelName,
                    checkType: checkTypeId,
                    checkTypeName: rules.name || check.checkType,
                    checkTime: check.checkTime || '',
                    date: check.date,
                    penalty: penalty,
                    branch: branch,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    month: check.date?.substring(0, 7) || month,
                    source: 'fallback'
                });
                
                existingIds.add(penaltyId);
                writtenCount++;
            }
        }
        
        if (writtenCount > 0) {
            console.log(`[SupervisorPenalty Fallback] ${writtenCount} eksik kayÄ±t tamamlandÄ±`);
        }
    } catch (e) {
        console.warn('[SupervisorPenalty Fallback] Hata:', e.message);
    }
}

async function loadPuantajRules() {
    try {
        const snapshot = await db.collection('puantajRules').get();
        puantajRulesCache = [];
        snapshot.forEach(doc => {
            puantajRulesCache.push({ id: doc.id, ...doc.data() });
        });
    } catch (e) {
        console.error('Kural yÃ¼kleme hatasÄ±:', e);
    }
}

/**
 * Puantaj GÃ¶rÃ¼nÃ¼rlÃ¼k KontrolÃ¼ - Ast-Ãœst Ä°liÅŸkisi
 * 
 * HiyerarÅŸi:
 * - barista: kendini + diÄŸer baristalarÄ± + mÃ¼dÃ¼r yardÄ±mcÄ±sÄ±nÄ± gÃ¶rÃ¼r
 * - mudur_yardimcisi: kendini + baristalarÄ± gÃ¶rÃ¼r
 * - magaza_muduru: kendini + yardÄ±mcÄ±yÄ± + baristalarÄ± gÃ¶rÃ¼r
 * - bolge_muduru: yÃ¶netici hariÃ§ herkesi gÃ¶rÃ¼r (tÃ¼m ÅŸubeler) - KARTI KÄ°LÄ°TLÄ° (sadece yÃ¶netici gÃ¶rebilir)
 * - yonetici: herkesi gÃ¶rÃ¼r
 */
function canViewPersonnelPuan(viewerRole, targetRole) {
    // YÃ¶netici ve admin herkesi gÃ¶rÃ¼r
    if (viewerRole === 'yonetici' || viewerRole === 'admin') return true;
    
    // BÃ–LGE MÃœDÃœRÃœ KARTI: Sadece yÃ¶netici/admin ve kendisi puanlarÄ±nÄ± gÃ¶rebilir
    // DiÄŸerleri kilitli kart gÃ¶rÃ¼r (canView=false olunca kilitli kart render edilir)
    if (targetRole === 'bolge_muduru') {
        return viewerRole === 'bolge_muduru';
    }
    
    // BÃ¶lge mÃ¼dÃ¼rÃ¼ yÃ¶netici hariÃ§ herkesi gÃ¶rÃ¼r
    if (viewerRole === 'bolge_muduru') return targetRole !== 'yonetici' && targetRole !== 'admin';
    
    // Barista: kendisi + diÄŸer baristalar + mÃ¼dÃ¼r yardÄ±mcÄ±sÄ±
    if (viewerRole === 'barista') {
        return targetRole === 'barista' || 
               targetRole === 'mudur_yardimcisi' || 
               targetRole === 'magaza_mudur_yardimcisi';
    }
    
    // MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±: kendisi + baristalar
    if (viewerRole === 'mudur_yardimcisi' || viewerRole === 'magaza_mudur_yardimcisi') {
        return targetRole === 'barista' || 
               targetRole === 'mudur_yardimcisi' || 
               targetRole === 'magaza_mudur_yardimcisi';
    }
    
    // MaÄŸaza MÃ¼dÃ¼rÃ¼: kendisi + yardÄ±mcÄ±lar + baristalar (bÃ¶lge mÃ¼dÃ¼rÃ¼ kilitli gÃ¶rÃ¼nÃ¼r)
    if (viewerRole === 'magaza_muduru') {
        return targetRole === 'barista' || 
               targetRole === 'mudur_yardimcisi' || 
               targetRole === 'magaza_mudur_yardimcisi' ||
               targetRole === 'magaza_muduru';
    }
    
    return false;
}

// Kilit SVG ikonu (puantaj iÃ§in)
const LOCK_ICON_SVG = `<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>`;

async function loadPuantaj() {
    const container = document.getElementById('puantajTableContainer');
    if (!container) return;
    
    const ay = document.getElementById('puantajAy').value;
    const yil = document.getElementById('puantajYil').value;
    const sube = document.getElementById('puantajSube').value;
    
    // Barista kontrolÃ¼
    const isBarista = currentUser?.role === 'barista';
    
    container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--tx2)">YÃ¼kleniyor...</div>';
    
    // Puantaj kurallarÄ±nÄ± ve starPoints config'i yÃ¼kle
    await loadPuantajRules();
    await loadStarPointsConfig();
    
    try {
        // Åžubeye ait personeli Ã§ek
        const personelSnapshot = await db.collection('personel').where('branch', '==', sube).get();
        
        // BÃ–LGE MÃœDÃœRLERÄ°NÄ° DE Ã‡EK (branch='all' olanlar - tÃ¼m ÅŸubelerde gÃ¶rÃ¼nÃ¼rler)
        const bolgeMuduruSnapshot = await db.collection('personel').where('branch', '==', 'all').get();
        
        // Ä°ki sorguyu birleÅŸtir
        const allPersonelDocs = [...personelSnapshot.docs, ...bolgeMuduruSnapshot.docs];
        
        if (allPersonelDocs.length === 0) {
            container.innerHTML = '<div style="text-align:center;padding:60px;color:var(--tx2)"><div style="margin-bottom:16px;opacity:.5"><svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div>Bu ÅŸubede kayÄ±tlÄ± personel yok.</div>';
            return;
        }
        
        const puantajKey = `${yil}-${ay}`;
        
        // Åžubeye ait puantaj verilerini Ã§ek
        const puantajSnapshot = await db.collection('puantaj').where('period', '==', puantajKey).where('branch', '==', sube).get();
        
        // === SUPERVISOR PENALTIES YÃœKLEMESÄ° ===
        // Bu ÅŸubedeki mÃ¼dÃ¼r/yardÄ±mcÄ±larÄ±n personel eksi puanlarÄ±nÄ± yÃ¼kle
        let supervisorPenaltiesData = {};
        try {
            const penaltiesSnap = await db.collection('supervisorPenalties')
                .where('branch', '==', sube)
                .where('month', '==', puantajKey)
                .get();
            
            penaltiesSnap.forEach(doc => {
                const d = doc.data();
                const supId = d.supervisorId;
                if (!supervisorPenaltiesData[supId]) {
                    supervisorPenaltiesData[supId] = { total: 0, records: [] };
                }
                supervisorPenaltiesData[supId].total += d.penalty || 0;
                supervisorPenaltiesData[supId].records.push({ id: doc.id, ...d });
            });
            console.log('[Puantaj] Supervisor penalties yÃ¼klendi:', Object.keys(supervisorPenaltiesData).length, 'mÃ¼dÃ¼r');
        } catch (e) {
            console.log('[Puantaj] Supervisor penalties yÃ¼klenemedi (koleksiyon henÃ¼z yok olabilir):', e.message);
        }
        // Global'e kaydet - kart detayÄ±nda kullanÄ±lacak
        window.supervisorPenaltiesCache = supervisorPenaltiesData;
        
        // Fallback: Eksik penalty kayÄ±tlarÄ±nÄ± tamamla (arka planda)
        fillMissingSupervisorPenalties(sube, puantajKey).catch(() => {});
        
        // BÃ¶lge mÃ¼dÃ¼rÃ¼ puantajlarÄ±nÄ± da Ã§ek - personelId ile (branch fark etmez)
        // BÃ¶lge mÃ¼dÃ¼rlerinin doc.id'lerini topla
        const bolgeMuduruDocIds = allPersonelDocs
            .filter(doc => doc.data().role === 'bolge_muduru' || doc.data().branch === 'all')
            .map(doc => doc.id);
        
        let bolgeMuduruPuantajSnapshot = { docs: [] };
        if (bolgeMuduruDocIds.length > 0) {
            // Her bÃ¶lge mÃ¼dÃ¼rÃ¼ iÃ§in puantaj Ã§ek
            for (const bmId of bolgeMuduruDocIds) {
                const bmPuantaj = await db.collection('puantaj')
                    .where('period', '==', puantajKey)
                    .where('personelId', '==', bmId)
                    .get();
                bolgeMuduruPuantajSnapshot.docs.push(...bmPuantaj.docs);
            }
        }
        
        // === PERSONEL ID MAPPING OLUÅžTUR ===
        // FarklÄ± dÃ¶nemlerde farklÄ± personelId formatlarÄ± kullanÄ±lmÄ±ÅŸ olabilir
        // Her personel iÃ§in tÃ¼m olasÄ± ID'leri map'le
        const personelIdMapping = {}; // personelId -> Firebase doc.id
        allPersonelDocs.forEach(doc => {
            const p = doc.data();
            const docId = doc.id;
            
            // Bu personel iÃ§in kullanÄ±labilecek tÃ¼m ID'ler
            const possibleIds = [
                docId,
                p.uniqueId,
                normalizePersonelId(p.name),
                p.name?.toLowerCase().replace(/\s+/g, '_'),
                p.name?.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, ''),
            ].filter(k => k);
            
            // Her olasÄ± ID'yi doc.id'ye map'le
            possibleIds.forEach(pid => {
                personelIdMapping[pid] = docId;
            });
        });
        
        const puantajData = {};
        
        // Åžube puantajlarÄ± - mapping kullanarak doÄŸru personele ata
        puantajSnapshot.forEach(doc => {
            const d = doc.data();
            // personelId'yi gerÃ§ek doc.id'ye Ã§evir
            const realDocId = personelIdMapping[d.personelId] || d.personelId;
            if (!puantajData[realDocId]) puantajData[realDocId] = [];
            puantajData[realDocId].push({ id: doc.id, ...d });
        });
        
        // BÃ¶lge mÃ¼dÃ¼rÃ¼ puantajlarÄ±
        bolgeMuduruPuantajSnapshot.docs.forEach(doc => {
            const d = doc.data();
            const realDocId = personelIdMapping[d.personelId] || d.personelId;
            if (!puantajData[realDocId]) puantajData[realDocId] = [];
            puantajData[realDocId].push({ id: doc.id, ...d });
        });
        
        // === OTOMATÄ°K PUANLARI DA Ã‡EK (Check Sisteminden) ===
        const startDate = `${yil}-${ay}-01`;
        const endDay = new Date(yil, parseInt(ay), 0).getDate();
        const endDate = `${yil}-${ay}-${endDay.toString().padStart(2, '0')}`;
        
        // Seed formatÄ± - TÃ¼rkÃ§e karakterler _ olur (eski veriler iÃ§in)
        const normalizeNameSeed = (name) => {
            if (!name) return '';
            return name
                .toLowerCase()
                .replace(/[^a-z0-9]/g, '_')
                .replace(/_+/g, '_')
                .replace(/^_|_$/g, '');
        };
        
        const autoNotesData = {};
        let totalAutoRecords = 0;
        try {
            const autoSnapshot = await db.collection('puantajNotes').get();
            autoSnapshot.forEach(doc => {
                const note = doc.data();
                const branchMatch = note.branch === sube || 
                                   (note.branch && note.branch.includes(sube.split(' ')[1])) ||
                                   (sube && sube.includes(note.branch));
                
                if (branchMatch && note.date >= startDate && note.date <= endDate) {
                    const pid = note.personelId;
                    
                    // personelId ile kaydet
                    if (pid) {
                        if (!autoNotesData[pid]) autoNotesData[pid] = [];
                        autoNotesData[pid].push({ id: doc.id, ...note });
                    }
                    
                    totalAutoRecords++;
                }
            });
            console.log(`[Puantaj] ${sube} iÃ§in ${totalAutoRecords} otomatik kayÄ±t bulundu`);
            console.log('[Puantaj] autoNotesData keys:', Object.keys(autoNotesData));
        } catch (e) {
            console.error('Otomatik puanlar yÃ¼klenemedi:', e);
        }
        
        let html = '';
        const personelList = [];
        
        allPersonelDocs.forEach(doc => {
            const p = doc.data();
            
            // Puantaj verilerini doc.id ile al (mapping zaten yapÄ±ldÄ±)
            const puanlar = puantajData[doc.id] || [];
            
            // Otomatik puanlarÄ± bul - Ã‡OKLU FORMAT EÅžLEÅžTÄ°RME
            const firstName = p.name?.split(' ')[0] || '';
            const lastName = p.name?.split(' ').slice(1).join(' ') || '';
            
            // TÃ¼m olasÄ± key formatlarÄ±nÄ± dene (Ã¶ncelik sÄ±rasÄ±na gÃ¶re)
            const possibleKeys = [
                p.uniqueId,                                // 1. Firebase'deki uniqueId (varsa)
                normalizePersonelId(p.name),               // 2. Global normalize tam isim (busra_sogut)
                normalizePersonelId(firstName),            // 3. Global normalize ilk isim (busra)
                doc.id,                                    // 4. Firebase doc ID
                normalizeNameSeed(p.name),                 // 5. ESKÄ°: Seed format (b__ra_s____t)
                normalizeNameSeed(firstName),              // 6. ESKÄ°: Seed ilk isim (b__ra)
                p.name,                                    // 7. Tam isim: "BÃœÅžRA SÃ–ÄžÃœT"
                p.name?.toLowerCase(),                     // 8. KÃ¼Ã§Ã¼k harf: "bÃ¼ÅŸra sÃ¶ÄŸÃ¼t"
                firstName,                                 // 9. Ä°lk isim: "BÃœÅžRA"
                firstName?.toLowerCase(),                  // 10. KÃ¼Ã§Ã¼k: "bÃ¼ÅŸra"
            ].filter(k => k);
            
            let otomatikPuanlar = [];
            for (const key of possibleKeys) {
                if (autoNotesData[key] && autoNotesData[key].length > 0) {
                    otomatikPuanlar = autoNotesData[key];
                    break;
                }
            }
            
            const kayitSayisi = puanlar.length;
            
            // === BÄ°RLEÅžÄ°K PUAN HESAPLAMA ===
            let manuelPuan = 0;
            let otomatikPuan = 0;
            let negatifOlay = 0;
            let pozitifOlay = 0;
            let primResetBonus = 0;
            let autoMissed = 0, autoLate = 0, autoOnTime = 0;
            let manuelArtiSayisi = 0, manuelEksiSayisi = 0; // YENÄ°: YÄ±ldÄ±z formÃ¼lÃ¼ iÃ§in
            let supervisionPenaltyCount = 0; // MÃ¼dÃ¼r denetim cezasÄ± sayÄ±sÄ±
            
            // Manuel puanlar (yÄ±ldÄ±z sistemi - CF puanlarÄ± hariÃ§)
            puanlar.forEach(x => {
                if (x.type === 'prim_reset' && x.resetBonus) {
                    primResetBonus += x.resetBonus;
                    return;
                }
                
                // CF otomatik puanlarÄ±nÄ± atla - bunlar ayrÄ± hesaplanacak
                if (x.type === 'checklist_auto' || x.createdBy === 'system_auto' || x.autoGenerated === true) {
                    // CF puanlarÄ±nÄ± otomatikPuan'a ekle
                    otomatikPuan += x.score || x.points || 0;
                    if (x.status === 'missed') { autoMissed++; negatifOlay++; }
                    else if (x.status === 'late') { autoLate++; negatifOlay++; }
                    else if (x.status === 'supervision_penalty') { 
                        // MÃ¼dÃ¼r denetim cezasÄ± - yÄ±ldÄ±za 1 eksi check olarak yansÄ±r
                        supervisionPenaltyCount++; 
                        negatifOlay++; 
                    }
                    else if (x.score < 0 || x.points < 0) { autoMissed++; negatifOlay++; } // CF missed iÃ§in status olmayabilir
                    return;
                }
                
                const yildiz = x.score || 3;
                // Puan sistemi: config'den dinamik (varsayÄ±lan: 1â˜…=-3, 2â˜…=-2, 3â˜…=-1, 4â˜…=+1, 5â˜…=+2)
                const puanDegeri = getPointsFromStar(yildiz);
                manuelPuan += puanDegeri;
                if (puanDegeri < 0) {
                    negatifOlay++;
                    manuelEksiSayisi++; // Her negatif deÄŸerlendirme = 1 eksi
                } else if (puanDegeri > 0) {
                    pozitifOlay++;
                    manuelArtiSayisi++; // Her pozitif deÄŸerlendirme = 1 artÄ±
                }
            });
            
            // Otomatik puanlar (eski puantajNotes'tan - varsa)
            otomatikPuanlar.forEach(n => {
                otomatikPuan += n.points || 0;
                if (n.status === 'missed') { autoMissed++; negatifOlay++; }
                else if (n.status === 'late') { autoLate++; negatifOlay++; }
                else if (n.status === 'supervision_penalty') { 
                    supervisionPenaltyCount++; 
                    negatifOlay++; 
                    // Supervision penalty = 1 eksi check gibi yÄ±ldÄ±za yansÄ±yacak
                }
                else { autoOnTime++; pozitifOlay++; }
            });
            
            // === PERSONEL EKSÄ° PUANI (Sadece MÃ¼dÃ¼r/YardÄ±mcÄ± iÃ§in) ===
            // Personel check doldurmadÄ±ÄŸÄ±nda mÃ¼dÃ¼re yazÄ±lan eksi puanlar
            const isSupervisorRole = ['magaza_muduru', 'mudur_yardimcisi', 'magaza_mudur_yardimcisi'].includes(p.role);
            let personelEksiPuan = 0;
            let personelEksiKayitlar = [];
            
            if (isSupervisorRole && window.supervisorPenaltiesCache) {
                // supervisorId olarak doc.id veya normalize edilmiÅŸ id kullanÄ±lmÄ±ÅŸ olabilir
                const normalizedId = normalizePersonelId(p.name);
                const penaltyData = window.supervisorPenaltiesCache[doc.id] || 
                                   window.supervisorPenaltiesCache[normalizedId] ||
                                   window.supervisorPenaltiesCache[p.codeName?.toLowerCase()?.replace(/\s+/g, '_')];
                
                if (penaltyData) {
                    personelEksiPuan = penaltyData.total || 0;
                    personelEksiKayitlar = penaltyData.records || [];
                }
            }
            
            // Toplam puan = Manuel + Otomatik + Reset Bonus + Personel Eksisi
            const toplamPuan = manuelPuan + otomatikPuan + primResetBonus + personelEksiPuan;
            
            const primDurumu = toplamPuan <= -5 ? 'prim_yok' : 'prim_var';
            
            personelList.push({ 
                id: doc.id, 
                name: p.name,
                codeName: p.codeName,
                displayName: getPersonelDisplayName(p),  // codeName varsa onu, yoksa "BÃ¼ÅŸra S."
                role: p.role || 'barista',  // ROL BÄ°LGÄ°SÄ° - gÃ¶rÃ¼nÃ¼rlÃ¼k kontrolÃ¼ iÃ§in
                icon: p.icon || '',  // Personel ikonu
                tc: p.tc, 
                position: p.position,
                photoUrl: p.photoUrl || '',
                startDate: p.startDate || '',  // Ä°ÅŸe giriÅŸ tarihi - sÄ±ralama iÃ§in
                toplamPuan,
                manuelPuan,
                otomatikPuan,
                personelEksiPuan, // YENÄ°: MÃ¼dÃ¼r/yardÄ±mcÄ± iÃ§in personel eksisi
                personelEksiKayitlar, // YENÄ°: Detay iÃ§in
                primDurumu, 
                kayitSayisi, 
                negatifOlay,
                pozitifOlay,
                autoMissed,
                autoLate,
                autoOnTime,
                manuelArtiSayisi,
                manuelEksiSayisi,
                supervisionPenaltyCount, // YENÄ°: Denetim cezasÄ±
                puanlar,
                otomatikPuanlar
            });
        });
        
        // === AYLIK LÄ°DERLÄ°K TABLOSU ===
        // Puanlara gÃ¶re sÄ±rala ve yÄ±ldÄ±z hesapla
        const sortedByPuan = [...personelList].sort((a, b) => b.toplamPuan - a.toplamPuan);
        const sortedByNegatif = [...personelList].filter(p => p.negatifOlay > 0).sort((a, b) => b.negatifOlay - a.negatifOlay);
        
        // === BÄ°REYSEL PERFORMANS YILDIZ HESAPLAMA ===
        // FormÃ¼l: YÄ±ldÄ±z = ((Tamamlanan + Manuel ArtÄ±) / (Atanan + Manuel Eksi)) Ã— 5
        // Atanan = autoOnTime + autoLate + autoMissed
        // Tamamlanan = autoOnTime + autoLate (missed hariÃ§)
        personelList.forEach(p => {
            // BÃ¶lge mÃ¼dÃ¼rÃ¼ yÄ±ldÄ±z sisteminden muaf
            if (p.role === 'bolge_muduru') {
                p.performansYildiz = 5;
                p.performansYildizDeger = 5;
                p.tamamlamaOrani = 100;
                return;
            }
            
            // Toplam atanan check (missed dahil) + manuel eksiler + supervision penalty
            const atanan = (p.autoOnTime || 0) + (p.autoLate || 0) + (p.autoMissed || 0) + (p.manuelEksiSayisi || 0) + (p.supervisionPenaltyCount || 0);
            // Tamamlanan check (missed hariÃ§) + manuel artÄ±lar
            const tamamlanan = (p.autoOnTime || 0) + (p.autoLate || 0) + (p.manuelArtiSayisi || 0);
            
            // YÄ±ldÄ±z hesaplama
            let yildizDeger = 3; // VarsayÄ±lan nÃ¶tr
            if (atanan > 0) {
                yildizDeger = (tamamlanan / atanan) * 5;
                yildizDeger = Math.max(0, Math.min(5, yildizDeger)); // 0-5 arasÄ± sÄ±nÄ±rla
            }
            
            p.performansYildizDeger = yildizDeger; // Tam deÄŸer (4.87 gibi)
            p.performansYildiz = Math.round(yildizDeger); // Yuvarlak (gÃ¶rsel iÃ§in)
            p.tamamlamaOrani = atanan > 0 ? Math.round((tamamlanan / atanan) * 100) : 100;
            p.atananCheck = atanan;
            p.tamamlananCheck = tamamlanan;
        });
        
        // === YILDIZ BAZLI SIRALAMA (1. iÃ§in badge) ===
        // Sadece barista ve mÃ¼dÃ¼r yardÄ±mcÄ±larÄ± arasÄ±nda ÅŸampiyonluk
        const sortedByYildiz = [...personelList]
            .filter(p => p.role !== 'bolge_muduru' && p.role !== 'magaza_muduru' && p.role !== 'yonetici') // MÃ¼dÃ¼rler hariÃ§
            .sort((a, b) => b.performansYildizDeger - a.performansYildizDeger);
        
        // 1. sÄ±radakine badge ver
        if (sortedByYildiz.length > 0) {
            sortedByYildiz[0].isChampion = true;
            sortedByYildiz[0].championRank = 1;
        }
        // DiÄŸerlerine sÄ±ra numarasÄ± ver
        sortedByYildiz.forEach((p, i) => {
            if (i > 0) p.championRank = i + 1;
        });
        
        // Ä°statistik cache'e kaydet
        const n = personelList.length;
        window.puantajStats = { n, sortedByYildiz };
        
        // Personel KartlarÄ± - DÃ¼zenli Grid, Marka Renkleri
        // Her iki ÅŸubede de Moonberry teal rengi
        const brandColor = '#008c95';
        const brandBg = 'rgba(0,140,149,.08)';
        
        // === AYLIK ÅžAMPIYONLAR ===
        // GÃ¶rÃ¼nÃ¼rlÃ¼k kontrolÃ¼ iÃ§in viewer role'Ã¼ al
        const championViewerRole = currentUser?.role || 'barista';
        
        if (personelList.length > 1 && !isBarista) {
            // Sadece gÃ¶rÃ¼lebilen personelden ÅŸampiyonlarÄ± seÃ§ (mÃ¼dÃ¼rler hariÃ§)
            const visiblePersonel = personelList.filter(p => 
                canViewPersonnelPuan(championViewerRole, p.role) &&
                p.role !== 'bolge_muduru' && 
                p.role !== 'magaza_muduru' && 
                p.role !== 'yonetici'
            );
            const sortedVisibleByPuan = [...visiblePersonel].sort((a, b) => b.toplamPuan - a.toplamPuan);
            const sortedVisibleByNegatif = [...visiblePersonel].filter(p => p.negatifOlay > 0).sort((a, b) => b.negatifOlay - a.negatifOlay);
            
            const topPerformer = sortedVisibleByPuan[0];
            const mostImproved = sortedVisibleByPuan.find(p => p.pozitifOlay > 0);
            const needsAttention = sortedVisibleByNegatif[0];
            
            if (topPerformer || mostImproved || needsAttention) {
                html += `
                    <div style="margin-bottom:20px;background:linear-gradient(135deg,${brandBg},rgba(255,255,255,.5));border:1px solid ${brandColor}25;border-radius:16px;padding:20px">
                        <div style="font-weight:700;color:var(--tx);margin-bottom:16px;font-size:1rem;display:flex;align-items:center;gap:8px">
                            <svg width="20" height="20" fill="none" stroke="${brandColor}" stroke-width="2" viewBox="0 0 24 24"><path d="M8 21h8M12 17v4M7.8 17h8.4c1.68 0 2.52 0 3.162-.327a3 3 0 001.311-1.311C21 14.72 21 13.88 21 12.2V7.8c0-1.68 0-2.52-.327-3.162a3 3 0 00-1.311-1.311C18.72 3 17.88 3 16.2 3H7.8c-1.68 0-2.52 0-3.162.327a3 3 0 00-1.311 1.311C3 5.28 3 6.12 3 7.8v4.4c0 1.68 0 2.52.327 3.162a3 3 0 001.311 1.311C5.28 17 6.12 17 7.8 17z"/></svg>
                            Bu Ay Ã–ne Ã‡Ä±kanlar
                        </div>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px">
                            ${topPerformer && topPerformer.toplamPuan > 0 ? `
                                <div style="background:linear-gradient(135deg,rgba(255,215,0,.15),rgba(255,215,0,.05));border:1px solid rgba(255,215,0,.3);border-radius:12px;padding:14px;text-align:center">
                                    <div style="width:36px;height:36px;margin:0 auto 8px;background:linear-gradient(135deg,#ffd700,#ffb700);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(255,215,0,.4)">
                                        <svg width="18" height="18" fill="#fff" viewBox="0 0 24 24"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg>
                                    </div>
                                    <div style="font-size:.7rem;color:var(--tx2);margin-bottom:4px">En YÃ¼ksek Puan</div>
                                    <div style="font-weight:700;color:var(--tx);font-size:.9rem">${topPerformer.displayName}</div>
                                    <div style="font-size:.8rem;color:#27ae60;font-weight:600">+${topPerformer.toplamPuan} puan</div>
                                </div>
                            ` : ''}
                            ${mostImproved && mostImproved.pozitifOlay >= 1 ? `
                                <div style="background:linear-gradient(135deg,rgba(39,174,96,.15),rgba(39,174,96,.05));border:1px solid rgba(39,174,96,.3);border-radius:12px;padding:14px;text-align:center">
                                    <div style="width:36px;height:36px;margin:0 auto 8px;background:linear-gradient(135deg,#27ae60,#2ecc71);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(39,174,96,.4)">
                                        <svg width="18" height="18" fill="#fff" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                                    </div>
                                    <div style="font-size:.7rem;color:var(--tx2);margin-bottom:4px">En Ã‡ok BaÅŸarÄ±</div>
                                    <div style="font-weight:700;color:var(--tx);font-size:.9rem">${mostImproved.displayName}</div>
                                    <div style="font-size:.8rem;color:#27ae60;font-weight:600">${mostImproved.pozitifOlay} baÅŸarÄ±</div>
                                </div>
                            ` : ''}
                            ${needsAttention && needsAttention.negatifOlay >= 2 ? `
                                <div style="background:linear-gradient(135deg,rgba(231,76,60,.1),rgba(231,76,60,.03));border:1px solid rgba(231,76,60,.2);border-radius:12px;padding:14px;text-align:center">
                                    <div style="width:36px;height:36px;margin:0 auto 8px;background:linear-gradient(135deg,#e74c3c,#c0392b);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(231,76,60,.4)">
                                        <svg width="18" height="18" fill="#fff" viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13" stroke="#fff" stroke-width="2"/><line x1="12" y1="17" x2="12.01" y2="17" stroke="#fff" stroke-width="2"/></svg>
                                    </div>
                                    <div style="font-size:.7rem;color:var(--tx2);margin-bottom:4px">Dikkat Gerektiren</div>
                                    <div style="font-weight:700;color:var(--tx);font-size:.9rem">${needsAttention.displayName}</div>
                                    <div style="font-size:.8rem;color:#e74c3c;font-weight:600">${needsAttention.negatifOlay} ihlal</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
        }
        
        // === EKÄ°P DURUMU (Rol bazlÄ± sÄ±ralÄ±, aynÄ± rol iÃ§inde iÅŸe giriÅŸ tarihine gÃ¶re) ===
        const viewerRole = currentUser?.role || 'barista';
        const roleOrderPuantaj = ['bolge_muduru', 'magaza_muduru', 'mudur_yardimcisi', 'magaza_mudur_yardimcisi', 'kidemli_barista', 'barista', 'part_time', 'yonetici'];
        const sortedPersonelList = [...personelList].sort((a, b) => {
            const aRoleIdx = roleOrderPuantaj.indexOf(a.role) === -1 ? 99 : roleOrderPuantaj.indexOf(a.role);
            const bRoleIdx = roleOrderPuantaj.indexOf(b.role) === -1 ? 99 : roleOrderPuantaj.indexOf(b.role);
            if (aRoleIdx !== bRoleIdx) return aRoleIdx - bRoleIdx;
            // AynÄ± rol iÃ§inde iÅŸe giriÅŸ tarihine gÃ¶re (eski â†’ yeni)
            const aStart = a.startDate || a.hireDate || '9999-99-99';
            const bStart = b.startDate || b.hireDate || '9999-99-99';
            return aStart.localeCompare(bStart);
        });
        
        // Cache'i SIRALANMIÅž liste ile gÃ¼ncelle
        window.puantajPersonelCache = sortedPersonelList;
        
        // TÃ¼m personeli gÃ¶ster - kilitli kartlar canView ile kontrol ediliyor
        // BÃ¶lge mÃ¼dÃ¼rÃ¼ kartÄ±: yÃ¶netici aÃ§Ä±k gÃ¶rÃ¼r, diÄŸerleri kilitli gÃ¶rÃ¼r (kendi kendini gÃ¶rebilir)
        const displayList = sortedPersonelList;
        
        html += `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;margin-bottom:20px">`;
        displayList.forEach(p => {
            // === GÃ–RÃœNÃœRLÄ°K KONTROLÃœ ===
            const canView = canViewPersonnelPuan(viewerRole, p.role);
            
            // === ROL STÄ°LLERÄ° - MARKA RENKLERÄ° ===
            // Barista: Sunberry coral (#ff8674)
            // MÃ¼dÃ¼r/YardÄ±mcÄ±: Moonberry teal (#008c95)
            // BÃ¶lge MÃ¼dÃ¼rÃ¼: Premium gold (#b8860b)
            const roleStylesPuantaj = {
                'yonetici': { 
                    badge: 'YÃ–NETÄ°CÄ°',
                    color: '#ff8674', 
                    gradient: 'linear-gradient(135deg,#ff8674,#ff6b5b)',
                    icon: '<svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg>',
                    premium: false
                },
                'bolge_muduru': { 
                    badge: 'BÃ–LGE',
                    color: '#b8860b', 
                    gradient: 'linear-gradient(135deg,#b8860b,#daa520,#ffd700)',
                    icon: '<svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg>',
                    premium: true
                },
                'magaza_muduru': { 
                    badge: 'MÃœDÃœR',
                    color: '#008c95', 
                    gradient: 'linear-gradient(135deg,#008c95,#00a8a8)',
                    icon: '<svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>',
                    premium: false
                },
                'magaza_mudur_yardimcisi': { 
                    badge: 'YARDIMCI',
                    color: '#008c95', 
                    gradient: 'linear-gradient(135deg,#008c95,#00a8a8)',
                    icon: '<svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>',
                    premium: false
                },
                'mudur_yardimcisi': { 
                    badge: 'YARDIMCI',
                    color: '#008c95', 
                    gradient: 'linear-gradient(135deg,#008c95,#00a8a8)',
                    icon: '<svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>',
                    premium: false
                },
                'barista': { 
                    badge: 'BARÄ°STA',
                    color: '#ff8674', 
                    gradient: 'linear-gradient(135deg,#ff8674,#ff9a8b)',
                    icon: '<svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 8h1a4 4 0 010 8h-1"/><path d="M2 8h16v9a4 4 0 01-4 4H6a4 4 0 01-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>',
                    premium: false
                }
            };
            
            const roleStyle = roleStylesPuantaj[p.role] || roleStylesPuantaj['barista'];
            const roleColor = roleStyle.color;
            const isPremium = roleStyle.premium;
            
            // BÃ–LGE MÃœDÃœRÃœ - Ã–ZEL KART (Puan/yÄ±ldÄ±z yok)
            if (p.role === 'bolge_muduru') {
                html += `
                <div style="position:relative;background:linear-gradient(135deg,rgba(184,134,11,.12),rgba(218,165,32,.06));border:2px solid rgba(184,134,11,.2);border-left:4px solid #b8860b;border-radius:12px;padding:16px;box-shadow:0 2px 12px rgba(184,134,11,.15)">
                    <!-- Premium TaÃ§ Badge -->
                    <div style="position:absolute;top:-10px;right:-10px;width:32px;height:32px;background:linear-gradient(135deg,#b8860b,#daa520,#ffd700);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 16px rgba(184,134,11,.6),inset 0 2px 4px rgba(255,255,255,.4);border:3px solid #fff">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="#fff" filter="drop-shadow(0 1px 2px rgba(0,0,0,.3))"><path d="M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11H5zm14 3c0 .55-.45 1-1 1H6c-.55 0-1-.45-1-1v-1h14v1z"/></svg>
                    </div>
                    <div style="display:flex;align-items:center;gap:12px">
                        <div style="width:44px;height:44px;background:linear-gradient(135deg,#b8860b,#daa520,#ffd700);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1rem;color:#fff;font-weight:600;box-shadow:0 2px 8px rgba(184,134,11,.4)">
                            ${p.photoUrl ? `<img src="${p.photoUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:12px">` : p.name.charAt(0).toUpperCase()}
                        </div>
                        <div style="flex:1">
                            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                                <span style="font-weight:700;font-size:1rem;color:var(--tx)">${p.displayName}</span>
                                <span style="font-size:.6rem;background:linear-gradient(135deg,#b8860b,#daa520);color:#fff;padding:3px 8px;border-radius:4px;font-weight:700;box-shadow:0 2px 6px rgba(184,134,11,.3)">BÃ–LGE MÃœDÃœRÃœ</span>
                            </div>
                            <div style="font-size:.75rem;color:#b8860b;font-weight:500;margin-top:4px">${p.position || 'BÃ¶lge MÃ¼dÃ¼rÃ¼'}</div>
                        </div>
                        <div style="text-align:right;padding:8px 12px;background:rgba(184,134,11,.1);border-radius:8px">
                            <div style="font-size:.7rem;color:#b8860b;font-weight:600">YÃ¶netici Kadro</div>
                        </div>
                    </div>
                </div>
                `;
                return;
            }
            
            const isRisk = p.toplamPuan <= -3;
            const isDanger = p.primDurumu === 'prim_yok';
            const puanColor = p.toplamPuan < 0 ? '#e74c3c' : (p.toplamPuan > 0 ? '#27ae60' : 'var(--tx)');
            const puanSign = p.toplamPuan > 0 ? '+' : '';
            
            // === SOL KENARLIK RENKLERÄ° ===
            // Barista/servis: Sunberry (#ff8674) - HER ZAMAN
            // MÃ¼dÃ¼r/YardÄ±mcÄ±: Moonberry (#008c95) - HER ZAMAN
            // DiÄŸerleri: rol rengi (risk/tehlike override edebilir)
            const isBaristaRole = ['barista', 'part_time', 'kidemli_barista'].includes(p.role);
            const isMudurRole = ['magaza_muduru', 'mudur_yardimcisi', 'magaza_mudur_yardimcisi'].includes(p.role);
            
            let cardBorder = roleColor;
            if (!canView) {
                cardBorder = '#6c757d';
            } else if (isBaristaRole) {
                cardBorder = '#ff8674'; // Sunberry - her zaman
            } else if (isMudurRole) {
                cardBorder = '#008c95'; // Moonberry - her zaman
            } else if (isDanger) {
                cardBorder = '#e74c3c';
            } else if (isRisk) {
                cardBorder = '#f39c12';
            }
            
            // === DÄ°NAMÄ°K YILDIZ GÃ–STERÄ°MÄ° ===
            // Tam deÄŸere gÃ¶re CSS gradient ile doluluk
            const yildizDeger = p.performansYildizDeger || 3;
            const yildizYuzde = Math.round((yildizDeger / 5) * 100);
            const yildizColor = yildizDeger >= 4 ? '#f1c40f' : (yildizDeger >= 3 ? '#95a5a6' : '#e74c3c');
            const yildizHtml = `<span style="position:relative;display:inline-flex;font-size:.85rem;letter-spacing:1px">
                <span style="color:#ddd">â˜†â˜†â˜†â˜†â˜†</span>
                <span style="position:absolute;left:0;top:0;overflow:hidden;width:${yildizYuzde}%;white-space:nowrap;color:${yildizColor}">â˜…â˜…â˜…â˜…â˜…</span>
            </span>`;
            
            // === MÃœDÃœR SÄ°MGESÄ° veya ÅžAMPÄ°YON BADGE ===
            const isManager = p.role === 'magaza_muduru';
            const isBolgeMuduru = p.role === 'bolge_muduru';
            const isYonetici = p.role === 'yonetici';
            
            // BÃ¶lge mÃ¼dÃ¼rÃ¼: Premium altÄ±n taÃ§ (24px - ÅŸampiyon ile aynÄ±)
            const bolgeMuduruBadge = isBolgeMuduru ? `
                <div style="position:absolute;top:-6px;right:-6px;width:24px;height:24px;background:linear-gradient(135deg,#b8860b,#daa520,#ffd700);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(184,134,11,.5);border:2px solid #fff">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="#fff"><path d="M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11H5zm14 3c0 .55-.45 1-1 1H6c-.55 0-1-.45-1-1v-1h14v1z"/></svg>
                </div>` : '';
            
            // MaÄŸaza mÃ¼dÃ¼rÃ¼: Minimalist teal kalkan (24px - ÅŸampiyon ile aynÄ±)
            const managerBadge = isManager ? `
                <div style="position:absolute;top:-6px;right:-6px;width:24px;height:24px;background:linear-gradient(135deg,#006d75,#008c95);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,140,149,.5);border:2px solid #fff">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="#fff"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg>
                </div>` : '';
            
            // YÃ¶netici: Premium mor rozet
            const yoneticiBadge = isYonetici ? `
                <div style="position:absolute;top:-6px;right:-6px;width:26px;height:26px;background:linear-gradient(135deg,#6b21a8,#9333ea,#a855f7);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 10px rgba(147,51,234,.5),inset 0 1px 2px rgba(255,255,255,.3);border:2px solid #fff">
                    <svg width="13" height="13" viewBox="0 0 24 24" fill="#fff"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 3c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm7 13H5v-.23c0-.62.28-1.2.76-1.58C7.47 15.82 9.64 15 12 15s4.53.82 6.24 2.19c.48.38.76.97.76 1.58V19z"/></svg>
                </div>` : '';
            
            // Åžampiyon badge (barista/yardÄ±mcÄ± iÃ§in)
            const championBadge = !isManager && !isBolgeMuduru && !isYonetici && p.isChampion ? `
                <div style="position:absolute;top:-6px;right:-6px;width:24px;height:24px;background:linear-gradient(135deg,#ffd700,#ffb700);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(255,215,0,.5);border:2px solid #fff">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="#fff"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg>
                </div>` : '';
            
            const cardCornerBadge = bolgeMuduruBadge || managerBadge || yoneticiBadge || championBadge;
            
            // SÄ±ralama rozeti (2+ iÃ§in, mÃ¼dÃ¼rler hariÃ§)
            const rankBadge = !isManager && !isBolgeMuduru && !isYonetici && !p.isChampion && p.championRank ? `
                <span style="font-size:.55rem;background:var(--bg3);color:var(--tx2);padding:1px 4px;border-radius:3px;margin-left:4px">#${p.championRank}</span>` : '';
            
            // Kart arka planÄ±
            const cardBg = isPremium && canView
                ? 'linear-gradient(135deg,rgba(184,134,11,.12),rgba(218,165,32,.06),rgba(255,215,0,.03))'
                : `linear-gradient(135deg,${roleColor}08,var(--cardBg))`;
            
            // Badge HTML
            const badgeHtml = isPremium
                ? `<span style="font-size:.55rem;background:${roleStyle.gradient};color:#fff;padding:2px 6px;border-radius:4px;font-weight:700;display:inline-flex;align-items:center;gap:3px;box-shadow:0 2px 6px rgba(184,134,11,.3)">${roleStyle.icon} ${roleStyle.badge}</span>`
                : `<span style="font-size:.55rem;background:${roleColor}15;color:${roleColor};padding:2px 6px;border-radius:4px;font-weight:700;display:inline-flex;align-items:center;gap:3px">${roleStyle.icon} ${roleStyle.badge}</span>`;
            
            // GÃ–RÃœNÃœRLÄ°K DURUMUNA GÃ–RE KART
            if (canView) {
                // === NORMAL KART (GÃ–RÃœNEBÄ°LÄ°R) ===
                html += `
                <div style="position:relative;background:${cardBg};border:2px solid ${cardBorder}30;border-left:4px solid ${cardBorder};border-radius:12px;padding:16px;transition:all .2s${isPremium ? ';box-shadow:0 2px 12px rgba(184,134,11,.15)' : ''}${p.isChampion ? ';box-shadow:0 4px 16px rgba(255,215,0,.25)' : ''}" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(0,0,0,.08)'" onmouseout="this.style.transform='none';this.style.boxShadow='${isPremium ? '0 2px 12px rgba(184,134,11,.15)' : p.isChampion ? '0 4px 16px rgba(255,215,0,.25)' : 'none'}'">
                    ${cardCornerBadge}
                    <!-- Header - TIKLANABÄ°LÄ°R -->
                    <div onclick="showPersonelPuanDetay('${p.id}', '${p.name.replace(/'/g, "\\'")}')" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;cursor:pointer;padding:8px;margin:-8px;border-radius:8px;transition:background .15s" onmouseover="this.style.background='var(--bg3)'" onmouseout="this.style.background='transparent'">
                        <div style="display:flex;align-items:center;gap:10px">
                            <div style="width:36px;height:36px;background:${roleStyle.gradient};border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:.9rem;color:#fff;font-weight:600;overflow:hidden${isPremium ? ';box-shadow:0 2px 8px rgba(184,134,11,.4)' : ''}">
                                ${p.photoUrl ? `<img src="${p.photoUrl}" style="width:100%;height:100%;object-fit:cover">` : p.name.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
                                    <span style="font-weight:600;font-size:.95rem;color:var(--tx)">${p.displayName}</span>
                                    ${badgeHtml}${rankBadge}
                                </div>
                                <div style="display:flex;align-items:center;gap:6px;margin-top:2px">
                                    <span style="font-size:.75rem;color:${roleColor};font-weight:500">${p.position || 'Barista'}</span>
                                    ${yildizHtml}
                                </div>
                            </div>
                        </div>
                        <div style="text-align:right">
                            <div style="font-size:1.4rem;font-weight:800;color:${puanColor};line-height:1">${puanSign}${p.toplamPuan}</div>
                            <div style="font-size:.65rem;color:var(--tx3);text-transform:uppercase">toplam</div>
                        </div>
                    </div>
                    
                    <!-- Puan DetayÄ± - Manuel/Otomatik/(Personel Eksisi)/Toplam -->
                    <div style="display:flex;gap:6px;margin-bottom:12px;background:var(--bg3);padding:10px;border-radius:8px">
                        <div style="flex:1;text-align:center;border-right:1px solid var(--bg4)">
                            <div style="font-size:.6rem;color:var(--tx3);margin-bottom:2px">Otomatik</div>
                            <div style="font-size:.85rem;font-weight:700;color:${p.otomatikPuan > 0 ? '#27ae60' : p.otomatikPuan < 0 ? '#e74c3c' : 'var(--tx2)'}">
                                ${p.otomatikPuan > 0 ? '+' : ''}${p.otomatikPuan || 0}
                            </div>
                        </div>
                        <div style="flex:1;text-align:center;border-right:1px solid var(--bg4)">
                            <div style="font-size:.6rem;color:var(--tx3);margin-bottom:2px">Manuel</div>
                            <div style="font-size:.85rem;font-weight:700;color:${p.manuelPuan > 0 ? '#27ae60' : p.manuelPuan < 0 ? '#e74c3c' : 'var(--tx2)'}">
                                ${p.manuelPuan > 0 ? '+' : ''}${p.manuelPuan || 0}
                            </div>
                        </div>
                        ${isMudurRole ? `
                        <div style="flex:1;text-align:center;border-right:1px solid var(--bg4)">
                            <div style="font-size:.6rem;color:#9b59b6;margin-bottom:2px">Personel</div>
                            <div style="font-size:.85rem;font-weight:700;color:${p.personelEksiPuan < 0 ? '#9b59b6' : 'var(--tx2)'}">
                                ${p.personelEksiPuan || 0}
                            </div>
                        </div>` : ''}
                        <div style="flex:1;text-align:center">
                            <div style="font-size:.6rem;color:var(--tx3);margin-bottom:2px">Toplam</div>
                            <div style="font-size:.85rem;font-weight:700;color:${puanColor}">
                                ${puanSign}${p.toplamPuan}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mini Stats - Marka Renkleri ile -->
                    <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">
                        ${p.autoMissed > 0 ? `<span style="font-size:.65rem;padding:3px 6px;background:rgba(231,76,60,.12);color:#c0392b;border-radius:4px">${p.autoMissed} eksik check</span>` : ''}
                        ${p.autoOnTime > 0 ? `<span style="font-size:.65rem;padding:3px 6px;background:rgba(39,174,96,.12);color:#1e8449;border-radius:4px">${p.autoOnTime} tam check</span>` : ''}
                        ${p.negatifOlay > 0 && p.kayitSayisi > 0 ? `<span style="font-size:.65rem;padding:3px 6px;background:rgba(231,76,60,.12);color:#c0392b;border-radius:4px">${p.kayitSayisi} manuel</span>` : ''}
                        ${p.negatifOlay === 0 && p.pozitifOlay === 0 ? `<span style="font-size:.65rem;padding:3px 6px;background:${brandBg};color:var(--tx3);border-radius:4px">HenÃ¼z kayÄ±t yok</span>` : ''}
                    </div>
                    
                    <!-- Action Button - Animasyonlu -->
                    ${!isBarista ? `
                    <div style="display:flex;gap:8px">
                        <button class="btn-evaluate-pulse" style="flex:1;padding:10px;background:linear-gradient(135deg,${brandBg},${brandBg});border:1px solid ${brandColor}40;color:${brandColor};border-radius:8px;font-weight:500;font-size:.8rem;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:6px" onclick="showPuantajModal('${p.id}', '${p.name}')" onmouseover="this.style.background='linear-gradient(135deg,${brandColor}20,${brandColor}10)';this.style.borderColor='${brandColor}'" onmouseout="this.style.background='linear-gradient(135deg,${brandBg},${brandBg})';this.style.borderColor='${brandColor}40'">
                            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                            DeÄŸerlendir
                        </button>
                    </div>
                    ` : ''}
                </div>
            `;
            } else {
                // === KÄ°LÄ°TLÄ° KART (GÃ–RÃœNEMÄ°YOR) ===
                // Rol rengi ve badge hÃ¢lÃ¢ gÃ¶rÃ¼nÃ¼r, sadece puanlar gizli
                
                // Sol kenarlÄ±k renkleri (barista=Sunberry, mÃ¼dÃ¼r=Moonberry)
                const isBaristaLocked = ['barista', 'part_time', 'kidemli_barista'].includes(p.role);
                const isMudurLocked = ['magaza_muduru', 'mudur_yardimcisi', 'magaza_mudur_yardimcisi'].includes(p.role);
                const lockedBorderColor = isBaristaLocked ? '#ff8674' : (isMudurLocked ? '#008c95' : roleColor);
                
                const lockedCardBg = isPremium
                    ? 'linear-gradient(135deg,rgba(184,134,11,.08),rgba(218,165,32,.04),rgba(255,215,0,.02))'
                    : `linear-gradient(135deg,${roleColor}05,var(--cardBg))`;
                const lockedGradient = isPremium
                    ? 'linear-gradient(135deg,#b8860b80,#daa52060,#ffd70040)'
                    : `linear-gradient(135deg,${roleColor}80,${roleColor}50)`;
                
                // Kilitli badge (soluk)
                const lockedBadgeHtml = isPremium
                    ? `<span style="font-size:.55rem;background:${roleStyle.gradient};color:#fff;padding:2px 6px;border-radius:4px;font-weight:700;display:inline-flex;align-items:center;gap:3px;opacity:.7">${roleStyle.icon} ${roleStyle.badge}</span>`
                    : `<span style="font-size:.55rem;background:${roleColor}15;color:${roleColor};padding:2px 6px;border-radius:4px;font-weight:700;display:inline-flex;align-items:center;gap:3px;opacity:.7">${roleStyle.icon} ${roleStyle.badge}</span>`;
                    
                html += `
                <div style="background:${lockedCardBg};border:2px solid #6c757d30;border-left:4px solid ${lockedBorderColor}60;border-radius:12px;padding:16px;transition:all .2s;opacity:0.9${isPremium ? ';box-shadow:0 1px 8px rgba(184,134,11,.1)' : ''}">
                    <!-- Header - TIKLANABÄ°LÄ°R DEÄžÄ°L -->
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding:8px;margin:-8px;border-radius:8px">
                        <div style="display:flex;align-items:center;gap:10px">
                            <div style="width:36px;height:36px;background:${lockedGradient};border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:.9rem;color:#fff;font-weight:600;overflow:hidden">
                                ${p.photoUrl ? `<img src="${p.photoUrl}" style="width:100%;height:100%;object-fit:cover;filter:grayscale(30%)">` : p.name.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
                                    <span style="font-weight:600;font-size:.95rem;color:var(--tx)">${p.displayName}</span>
                                    ${lockedBadgeHtml}
                                </div>
                                <div style="font-size:.75rem;color:${roleColor};font-weight:500;opacity:.7">${p.position || 'Personel'}</div>
                            </div>
                        </div>
                        <div style="text-align:right">
                            <div style="font-size:1.4rem;color:#6c757d;line-height:1;display:flex;align-items:center;justify-content:center">
                                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
                            </div>
                            <div style="font-size:.65rem;color:var(--tx3);text-transform:uppercase">gizli</div>
                        </div>
                    </div>
                    
                    <!-- Puan DetayÄ± - KÄ°LÄ°TLÄ° -->
                    <div style="display:flex;gap:8px;margin-bottom:12px;background:var(--bg3);padding:10px;border-radius:8px">
                        <div style="flex:1;text-align:center;border-right:1px solid var(--bg4)">
                            <div style="font-size:.65rem;color:var(--tx3);margin-bottom:2px">Manuel</div>
                            <div style="font-size:.9rem;font-weight:700;color:#6c757d">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
                            </div>
                        </div>
                        <div style="flex:1;text-align:center;border-right:1px solid var(--bg4)">
                            <div style="font-size:.65rem;color:var(--tx3);margin-bottom:2px">Otomatik</div>
                            <div style="font-size:.9rem;font-weight:700;color:#6c757d">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
                            </div>
                        </div>
                        <div style="flex:1;text-align:center">
                            <div style="font-size:.65rem;color:var(--tx3);margin-bottom:2px">Toplam</div>
                            <div style="font-size:.9rem;font-weight:700;color:#6c757d">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bilgi MesajÄ± -->
                    <div style="display:flex;gap:8px;flex-wrap:wrap">
                        <span style="font-size:.65rem;padding:3px 6px;background:rgba(108,117,125,.12);color:#6c757d;border-radius:4px;display:flex;align-items:center;gap:4px">
                            <svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
                            Sadece yÃ¶neticiler gÃ¶rebilir
                        </span>
                    </div>
                </div>
            `;
            }
        });
        html += `</div>`;
        
        // Not: YÃ¶netici DeÄŸerlendirmeleri ve CF PuanlarÄ± artÄ±k personel kartÄ±na tÄ±klayÄ±nca modal'da gÃ¶steriliyor
        
        container.innerHTML = html;
    } catch (error) {
        console.error('Puantaj yÃ¼kleme hatasÄ±:', error);
        container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--red)">YÃ¼kleme hatasÄ±!</div>';
    }
}

// Otomatik Check puanlarÄ±nÄ± yÃ¼kle - GÃ¼nlÃ¼k GÃ¶rÃ¼nÃ¼m
async function loadAutoCheckNotes(sube, ay, yil, personelList) {
    let html = '';
    
    try {
        const startDate = `${yil}-${ay}-01`;
        const endDay = new Date(yil, parseInt(ay), 0).getDate();
        const endDate = `${yil}-${ay}-${endDay.toString().padStart(2, '0')}`;
        
        // Hem puantajNotes (eski) hem puantaj (CF) koleksiyonunu oku
        const [notesSnapshot, cfSnapshot] = await Promise.all([
            db.collection('puantajNotes').where('branch', '==', sube).get(),
            db.collection('puantaj').where('branch', '==', sube).get()
        ]);
        
        const filteredDocs = [];
        const seenIds = new Set();
        
        // Eski puantajNotes kayÄ±tlarÄ± (Frontend AutoPuan)
        notesSnapshot.forEach(doc => {
            const note = doc.data();
            if (note.date >= startDate && note.date <= endDate) {
                filteredDocs.push({ 
                    id: doc.id, 
                    ...note, 
                    source: 'AP' // AutoPuan (Frontend)
                });
                seenIds.add(doc.id);
            }
        });
        
        // Yeni puantaj kayÄ±tlarÄ± (CF'den gelen)
        cfSnapshot.forEach(doc => {
            if (seenIds.has(doc.id)) return; // Duplicate Ã¶nle
            const note = doc.data();
            // Sadece otomatik puanlarÄ± al (manuel deÄŸerlendirmeler hariÃ§)
            if (note.createdBy !== 'system_auto' && note.type !== 'checklist_auto') return;
            
            const noteDate = note.eventDate || note.date;
            if (noteDate >= startDate && noteDate <= endDate) {
                filteredDocs.push({ 
                    id: doc.id, 
                    ...note,
                    date: noteDate,
                    points: note.score || note.points || 0,
                    checkTime: note.eventTime || note.checkTime,
                    checkType: note.checklistType || note.checkType,
                    source: 'CF' // Cloud Function
                });
            }
        });
        
        if (filteredDocs.length === 0) return '';
        
        // GÃ¼nlÃ¼k gruplama
        const notesByDate = {};
        const notesByPerson = {};
        let totalAutoPoints = 0;
        
        filteredDocs.forEach(note => {
            const date = note.date || 'unknown';
            if (!notesByDate[date]) notesByDate[date] = [];
            notesByDate[date].push(note);
            
            if (!notesByPerson[note.personelId]) notesByPerson[note.personelId] = [];
            notesByPerson[note.personelId].push(note);
            
            totalAutoPoints += note.points || 0;
        });
        
        // Cache'e kaydet (detay modal iÃ§in)
        window.autoNotesCache = { byDate: notesByDate, byPerson: notesByPerson, personelList };
        
        const brandColor = '#008c95';
        const canManagePoints = ['yonetici', 'bolge_muduru', 'magaza_muduru'].includes(currentUser?.role);
        
        // GÃ¼n adlarÄ±
        const gunAdi = ['Pazar', 'Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi'];
        const ayAdi = ['', 'Ocak', 'Åžubat', 'Mart', 'Nisan', 'MayÄ±s', 'Haziran', 'Temmuz', 'AÄŸustos', 'EylÃ¼l', 'Ekim', 'KasÄ±m', 'AralÄ±k'];
        
        html += `
            <div style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:16px;margin-top:16px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--bg4)">
                    <div style="display:flex;align-items:center;gap:10px">
                        <svg width="18" height="18" fill="none" stroke="${brandColor}" stroke-width="2" viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
                        <div>
                            <div style="font-weight:600;color:var(--tx);font-size:.95rem">Check Sisteminden Otomatik Puanlar</div>
                            <div style="font-size:.75rem;color:var(--tx3)">${filteredDocs.length} kayÄ±t Â· ${Object.keys(notesByPerson).length} personel</div>
                        </div>
                    </div>
                    <div style="background:${totalAutoPoints >= 0 ? 'rgba(39,174,96,.1)' : 'rgba(231,76,60,.1)'};padding:8px 14px;border-radius:8px">
                        <span style="font-size:1.1rem;font-weight:700;color:${totalAutoPoints >= 0 ? '#27ae60' : '#e74c3c'}">${totalAutoPoints >= 0 ? '+' : ''}${totalAutoPoints}</span>
                    </div>
                </div>
        `;
        
        // Personel bazlÄ± Ã¶zet kartlar
        html += `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;margin-bottom:16px">`;
        
        Object.entries(notesByPerson).forEach(([personelId, notes]) => {
            const person = personelList.find(p => p.id === personelId);
            const personName = person?.name || notes[0]?.personelName || 'Bilinmeyen';
            
            let personTotal = 0, missed = 0, late = 0, onTime = 0;
            notes.forEach(n => {
                personTotal += n.points || 0;
                if (n.status === 'missed') missed++;
                else if (n.status === 'late') late++;
                else onTime++;
            });
            
            html += `
                <div onclick="showPersonelPuanDetay('${personelId}', '${personName.replace(/'/g, "\\'")}')" style="background:linear-gradient(135deg,var(--bg3),var(--bg2));border:1px solid var(--bg4);border-radius:10px;padding:12px;cursor:pointer;transition:all .15s" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(0,0,0,.08)'" onmouseout="this.style.transform='none';this.style.boxShadow='none'">
                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
                        <div style="font-weight:600;color:var(--tx);font-size:.85rem">${personName}</div>
                        <span style="font-weight:700;color:${personTotal >= 0 ? '#27ae60' : '#e74c3c'};font-size:.95rem">${personTotal >= 0 ? '+' : ''}${personTotal}</span>
                    </div>
                    <div style="display:flex;gap:6px;flex-wrap:wrap">
                        ${missed > 0 ? `<span style="font-size:.65rem;color:#e74c3c;background:rgba(231,76,60,.1);padding:2px 6px;border-radius:4px">${missed} eksik</span>` : ''}
                        ${late > 0 ? `<span style="font-size:.65rem;color:#f39c12;background:rgba(243,156,18,.1);padding:2px 6px;border-radius:4px">${late} geÃ§</span>` : ''}
                        ${onTime > 0 ? `<span style="font-size:.65rem;color:#27ae60;background:rgba(39,174,96,.1);padding:2px 6px;border-radius:4px">${onTime} tam</span>` : ''}
                    </div>
                </div>
            `;
        });
        html += `</div>`;
        
        // GÃ¼nlÃ¼k detay listesi
        const sortedDates = Object.keys(notesByDate).sort((a, b) => b.localeCompare(a));
        
        html += `<div>`;
        sortedDates.forEach(date => {
            const notes = notesByDate[date];
            const dateObj = new Date(date);
            const gun = gunAdi[dateObj.getDay()];
            const tarih = `${dateObj.getDate()} ${ayAdi[dateObj.getMonth() + 1]}`;
            
            html += `
                <div style="margin-bottom:12px">
                    <div style="font-size:.75rem;font-weight:600;color:var(--tx2);margin-bottom:8px;padding:4px 0;border-bottom:1px dashed var(--bg4)">${tarih} ${gun}</div>
            `;
            
            notes.forEach(note => {
                const person = personelList.find(p => p.id === note.personelId || p.uniqueId === note.personelId);
                const personName = person?.name || note.personelName || 'Bilinmeyen';
                const noteColor = note.points > 0 ? '#27ae60' : (note.points < 0 ? '#e74c3c' : 'var(--tx3)');
                
                // Checklist tÃ¼rÃ¼ adlarÄ±
                const checkTypeNames = {
                    'acilis': 'AÃ§Ä±lÄ±ÅŸ',
                    'kapanis': 'KapanÄ±ÅŸ',
                    'platform': 'Platform',
                    'gunluk': 'GÃ¼nlÃ¼k',
                    'haftalik': 'HaftalÄ±k',
                    'aylik': 'AylÄ±k',
                    'mudur': 'MÃ¼dÃ¼r',
                    'temizlik': 'Temizlik'
                };
                
                const checkSaat = note.checkTime || note.eventTime || '';
                const checkTip = checkTypeNames[note.checkType] || note.checkType || 'Check';
                const source = note.source || (note.createdBy === 'system_auto' ? 'CF' : 'AP');
                
                // DetaylÄ± aÃ§Ä±klama
                let statusText = '';
                if (note.status === 'missed') {
                    statusText = 'DoldurulmadÄ±';
                } else if (note.status === 'late') {
                    statusText = 'GeÃ§ dolduruldu';
                } else {
                    statusText = 'Vaktinde';
                }
                
                const statusBg = note.status === 'onTime' ? 'rgba(39,174,96,.1)' : (note.status === 'late' ? 'rgba(243,156,18,.1)' : 'rgba(231,76,60,.1)');
                const sourceBg = source === 'CF' ? '#3498db' : '#9b59b6';
                
                html += `
                    <div style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:${statusBg};border-radius:8px;margin-bottom:6px">
                        <div style="width:28px;height:28px;min-width:28px;background:${noteColor}15;border-radius:50%;display:flex;align-items:center;justify-content:center">
                            <span style="font-size:.75rem;font-weight:700;color:${noteColor}">${note.points > 0 ? '+' : ''}${note.points}</span>
                        </div>
                        <div style="flex:1;min-width:0">
                            <div style="display:flex;align-items:center;gap:6px">
                                <span style="font-size:.8rem;font-weight:600;color:var(--tx)">${personName}</span>
                                <span style="font-size:.55rem;font-weight:600;color:#fff;background:${sourceBg};padding:1px 4px;border-radius:3px">${source}</span>
                            </div>
                            <div style="font-size:.75rem;color:var(--tx2)">${checkTip}${checkSaat ? ' Â· ' + checkSaat : ''} Â· ${statusText}</div>
                        </div>
                        ${canManagePoints ? `<button onclick="event.stopPropagation();deleteAutoNote('${note.id}', '${source}')" style="background:rgba(231,76,60,.15);border:none;color:#e74c3c;cursor:pointer;padding:6px 10px;border-radius:6px;font-size:.7rem;font-weight:500;transition:all .15s" onmouseover="this.style.background='rgba(231,76,60,.25)'" onmouseout="this.style.background='rgba(231,76,60,.15)'">Sil</button>` : ''}
                    </div>
                `;
            });
            
            html += `</div>`;
        });
        html += `</div>`;
        
        html += `</div>`;
        
    } catch (e) {
        console.error('Otomatik notlar yÃ¼klenemedi:', e);
    }
    
    return html;
}

// Personel Puan Detay Modal
function showPersonelPuanDetay(personelId, personName) {
    // Ã–nce puantajPersonelCache'den veri al (otomatik puanlar dahil)
    const personelData = window.puantajPersonelCache?.find(p => p.id === personelId);
    
    if (!personelData) {
        toast('Personel verisi bulunamadÄ±', 'error');
        return;
    }
    
    // === GÃ–RÃœNÃœRLÄ°K KONTROLÃœ ===
    const viewerRole = currentUser?.role || 'barista';
    const targetRole = personelData.role || 'barista';
    
    // YÃ¶netici ve admin her zaman gÃ¶rebilir
    const isAdmin = viewerRole === 'yonetici' || viewerRole === 'admin';
    
    if (!isAdmin && !canViewPersonnelPuan(viewerRole, targetRole)) {
        toast('Bu personelin puanlarÄ±nÄ± gÃ¶rme yetkiniz yok', 'warning');
        return;
    }
    
    const notes = personelData.otomatikPuanlar || [];
    const allPuanlar = personelData.puanlar || [];
    
    // CF ve Manuel puanlarÄ± AYIR
    const cfPuanlar = allPuanlar.filter(p => p.type === 'checklist_auto' || p.createdBy === 'system_auto' || p.autoGenerated === true);
    const manuelPuanlar = allPuanlar.filter(p => p.type !== 'checklist_auto' && p.createdBy !== 'system_auto' && !p.autoGenerated && p.type !== 'prim_reset');
    
    // CF puanlarÄ±: notes (otomatikPuanlar) + cfPuanlar (puanlar iÃ§inden)
    const tumCFPuanlar = [...notes, ...cfPuanlar];
    
    const canManage = ['yonetici', 'bolge_muduru', 'magaza_muduru', 'mudur', 'admin'].includes(currentUser?.role);
    
    // Ä°statistikler - doÄŸrudan personelData'dan al
    const autoTotal = personelData.otomatikPuan || 0;
    const manuelTotal = personelData.manuelPuan || 0;
    const missed = personelData.autoMissed || 0;
    const late = personelData.autoLate || 0;
    const onTime = personelData.autoOnTime || 0;
    
    const toplamPuan = personelData.toplamPuan || 0;
    const yildizDeger = personelData.performansYildizDeger || 3;
    const yildizYuzde = Math.round((yildizDeger / 5) * 100);
    const yildizColor = yildizDeger >= 4 ? '#f1c40f' : (yildizDeger >= 3 ? '#95a5a6' : '#e74c3c');
    
    // Personel ikonu
    const personelIcon = personelData.icon || '';
    
    const gunAdi = ['Pazar', 'Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi'];
    const ayAdi = ['', 'Ocak', 'Åžubat', 'Mart', 'Nisan', 'MayÄ±s', 'Haziran', 'Temmuz', 'AÄŸustos', 'EylÃ¼l', 'Ekim', 'KasÄ±m', 'AralÄ±k'];
    
    let body = `
        <div style="max-height:70vh;overflow-y:auto">
            <!-- Ã–zet Kart -->
            <div style="background:linear-gradient(135deg,rgba(0,140,149,.1),rgba(255,134,116,.05));border-radius:12px;padding:16px;margin-bottom:16px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <div style="display:flex;align-items:center;gap:12px">
                        ${personelIcon ? `<span style="font-size:2rem">${personelIcon}</span>` : ''}
                        <div>
                            <div style="font-size:1.1rem;font-weight:700;color:var(--tx)">${personelData.displayName || formatDisplayName(personName)}</div>
                            <div style="position:relative;display:inline-flex;font-size:1rem;letter-spacing:1px;margin-top:4px">
                                <span style="color:#ddd">â˜†â˜†â˜†â˜†â˜†</span>
                                <span style="position:absolute;left:0;top:0;overflow:hidden;width:${yildizYuzde}%;white-space:nowrap;color:${yildizColor}">â˜…â˜…â˜…â˜…â˜…</span>
                            </div>
                        </div>
                    </div>
                    <div style="text-align:right">
                        <div style="font-size:1.8rem;font-weight:800;color:${toplamPuan >= 0 ? '#27ae60' : '#e74c3c'}">${toplamPuan >= 0 ? '+' : ''}${toplamPuan}</div>
                        <div style="font-size:.7rem;color:var(--tx3)">TOPLAM PUAN</div>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
                    <div style="background:var(--bg2);border-radius:8px;padding:10px;text-align:center">
                        <div style="font-size:1rem;font-weight:700;color:${autoTotal >= 0 ? '#27ae60' : '#e74c3c'}">${autoTotal >= 0 ? '+' : ''}${autoTotal}</div>
                        <div style="font-size:.65rem;color:var(--tx3)">CF Puan</div>
                    </div>
                    <div style="background:var(--bg2);border-radius:8px;padding:10px;text-align:center">
                        <div style="font-size:1rem;font-weight:700;color:${manuelTotal >= 0 ? '#27ae60' : '#e74c3c'}">${manuelTotal >= 0 ? '+' : ''}${manuelTotal}</div>
                        <div style="font-size:.65rem;color:var(--tx3)">Manuel</div>
                    </div>
                    <div style="background:var(--bg2);border-radius:8px;padding:10px;text-align:center">
                        <div style="font-size:1rem;font-weight:700;color:#e74c3c">${missed}</div>
                        <div style="font-size:.65rem;color:var(--tx3)">Eksik</div>
                    </div>
                    <div style="background:var(--bg2);border-radius:8px;padding:10px;text-align:center">
                        <div style="font-size:1rem;font-weight:700;color:#27ae60">${onTime}</div>
                        <div style="font-size:.65rem;color:var(--tx3)">Tam</div>
                    </div>
                </div>
            </div>
            
            <!-- CF Puanlar -->
            <div style="margin-bottom:16px">
                <div style="font-size:.85rem;font-weight:600;color:var(--tx);margin-bottom:10px;display:flex;align-items:center;gap:6px">
                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
                    Check Sisteminden
                    <span style="font-size:.65rem;background:rgba(0,140,149,.15);color:#008c95;padding:2px 8px;border-radius:4px;font-weight:600">CF</span>
                    <span style="color:var(--tx3);font-weight:400">(${tumCFPuanlar.length})</span>
                    ${canManage && tumCFPuanlar.length > 0 ? `<label style="margin-left:auto;display:flex;align-items:center;gap:4px;font-size:.7rem;color:var(--tx3);cursor:pointer"><input type="checkbox" id="cfSelectAll" onchange="document.querySelectorAll('.cf-checkbox').forEach(c=>c.checked=this.checked)" style="cursor:pointer">TÃ¼mÃ¼</label>` : ''}
                </div>
    `;
    
    // CF PuanlarÄ± gÃ¶ster
    if (tumCFPuanlar.length === 0) {
        body += `<div style="text-align:center;color:var(--tx3);font-size:.8rem;padding:16px;background:var(--bg2);border-radius:8px">HenÃ¼z CF puanÄ± yok</div>`;
    } else {
        const sortedCF = [...tumCFPuanlar].sort((a, b) => {
            const dateA = a.date || a.eventDate || '';
            const dateB = b.date || b.eventDate || '';
            return dateB.localeCompare(dateA);
        }).slice(0, 15);
        
        sortedCF.forEach(note => {
            const dateStr = note.date || note.eventDate || '';
            const dateObj = new Date(dateStr);
            const tarih = isNaN(dateObj) ? '-' : `${String(dateObj.getDate()).padStart(2,'0')}.${String(dateObj.getMonth()+1).padStart(2,'0')}`;
            
            // Status'a gÃ¶re doÄŸru puanÄ± hesapla
            const status = note.status || 'missed';
            const checkType = note.checkType || note.type || 'gunluk';
            const canonicalType = canonicalChecklistTypeId?.(checkType) || checkType.toLowerCase().replace(/[^a-z]/g, '');
            const rules = CHECK_RULES[canonicalType] || CHECK_RULES['gunluk'] || { points: { onTime: 2, late: -2, missed: -2 } };
            
            // Ã–nce note.points kullan (tam sayÄ± ise), deÄŸilse status'a gÃ¶re hesapla
            let points = note.points;
            if (points === undefined || points === null || !Number.isInteger(points)) {
                if (status === 'onTime') points = rules.points?.onTime || 2;
                else if (status === 'late') points = rules.points?.late || -2;
                else points = rules.points?.missed || -2;
            }
            
            const noteColor = points > 0 ? '#27ae60' : (points < 0 ? '#e74c3c' : 'var(--tx3)');
            // YÄ±ldÄ±z: onTime=5â˜…, late=2â˜…, missed=1â˜…
            const starCount = status === 'onTime' ? 5 : (status === 'late' ? 2 : 1);
            const starStr = 'â˜…'.repeat(starCount) + 'â˜†'.repeat(5 - starCount);
            const starColor = status === 'onTime' ? '#f1c40f' : (status === 'late' ? '#f39c12' : '#e74c3c');
            
            // checkType'dan "ZamanÄ±nda", "GeÃ§", "DoldurulmadÄ±" ve parantez iÃ§i saati temizle
            let rawCheckTip = note.checkType || note.note || 'Check';
            let checkTip = rawCheckTip
                .replace(/\s*-\s*(ZamanÄ±nda|GeÃ§|DoldurulmadÄ±|YapÄ±lmadÄ±|KaÃ§Ä±rÄ±ldÄ±)/gi, '')
                .replace(/\s*\(\d{1,2}:\d{2}\)/g, '')
                .trim();
            
            // Check saati (checkTime veya parantez iÃ§inden)
            let checkSaat = note.checkTime || '';
            if (!checkSaat) {
                const saatMatch = rawCheckTip.match(/\((\d{1,2}:\d{2})\)/);
                if (saatMatch) checkSaat = saatMatch[1];
            }
            
            // YazÄ±lma saati (createdAt'ten)
            let yazilmaSaati = '';
            if (note.createdAt) {
                const ts = note.createdAt.toDate ? note.createdAt.toDate() : new Date(note.createdAt);
                yazilmaSaati = ts.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit', hour12: false });
            }
            
            const noteId = note.id || '';
            
            body += `
                <div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--bg2);border-radius:6px;margin-bottom:4px;font-size:.8rem">
                    ${canManage && noteId ? `<input type="checkbox" class="cf-checkbox" data-id="${noteId}" style="cursor:pointer;margin:0">` : ''}
                    <span style="color:${starColor};font-size:.7rem;letter-spacing:-1px;min-width:50px">${starStr}</span>
                    <span style="color:var(--tx3);min-width:40px">${tarih}</span>
                    <span style="flex:1;color:var(--tx)">${checkTip}${checkSaat ? ' Â· ' + checkSaat : ''}</span>
                    ${yazilmaSaati ? `<span style="color:var(--tx3);font-size:.65rem">${yazilmaSaati}</span>` : ''}
                    <span style="background:rgba(0,140,149,.12);color:#008c95;padding:2px 6px;border-radius:4px;font-size:.65rem;font-weight:600">CF</span>
                    <span style="font-weight:700;color:${noteColor};min-width:32px;text-align:right">${points > 0 ? '+' : ''}${points}</span>
                </div>
            `;
        });
        
        if (tumCFPuanlar.length > 15) {
            body += `<div style="text-align:center;color:var(--tx3);font-size:.7rem;padding:6px">+${tumCFPuanlar.length - 15} kayÄ±t daha</div>`;
        }
        
        // Toplu silme butonu
        if (canManage) {
            body += `<button onclick="deleteSelectedCFNotes()" style="margin-top:8px;width:100%;padding:8px;background:rgba(231,76,60,.1);border:1px solid rgba(231,76,60,.2);color:#e74c3c;border-radius:6px;font-size:.75rem;cursor:pointer;display:none" id="cfDeleteSelectedBtn">SeÃ§ilenleri Sil</button>`;
        }
    }
    
    body += `</div>`;
    
    // Manuel Puanlar
    if (manuelPuanlar.length > 0) {
        body += `
            <div>
                <div style="font-size:.85rem;font-weight:600;color:var(--tx);margin-bottom:10px;display:flex;align-items:center;gap:6px">
                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                    Manuel DeÄŸerlendirmeler
                    <span style="color:var(--tx3);font-weight:400">(${manuelPuanlar.length})</span>
                    ${canManage ? `<label style="margin-left:auto;display:flex;align-items:center;gap:4px;font-size:.7rem;color:var(--tx3);cursor:pointer"><input type="checkbox" id="manuelSelectAll" onchange="document.querySelectorAll('.manuel-checkbox').forEach(c=>c.checked=this.checked)" style="cursor:pointer">TÃ¼mÃ¼</label>` : ''}
                </div>
        `;
        
        manuelPuanlar.forEach(puan => {
            const tarihRaw = puan.eventDate || puan.createdAt?.toDate?.()?.toLocaleDateString('tr-TR') || '-';
            const tarih = tarihRaw.includes('.') ? tarihRaw.split('.').slice(0,2).join('.') : (tarihRaw.includes('-') ? tarihRaw.slice(5,10).split('-').reverse().join('.') : tarihRaw);
            const rawScore = parseInt(puan.score) || 3;
            const yildiz = Math.max(1, Math.min(5, rawScore));
            const puanEtki = getPointsFromStar(yildiz);
            const puanColor = puanEtki < 0 ? '#e74c3c' : (puanEtki > 0 ? '#27ae60' : 'var(--tx3)');
            const yildizStr = 'â˜…'.repeat(yildiz) + 'â˜†'.repeat(5-yildiz);
            const starColor = getStarColor(yildiz);
            const ikonHtml = puan.icon ? `<span style="font-size:.9rem;margin-right:4px">${puan.icon}</span>` : '';
            
            // YazÄ±lma saati (createdAt'ten)
            let yazilmaSaati = '';
            if (puan.createdAt) {
                const ts = puan.createdAt.toDate ? puan.createdAt.toDate() : new Date(puan.createdAt);
                yazilmaSaati = ts.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit', hour12: false });
            }
            
            body += `
                <div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--bg2);border-radius:6px;margin-bottom:4px;font-size:.8rem">
                    ${canManage ? `<input type="checkbox" class="manuel-checkbox" data-id="${puan.id}" style="cursor:pointer;margin:0">` : ''}
                    <span style="color:${starColor};font-size:.7rem;letter-spacing:-1px;min-width:50px">${yildizStr}</span>
                    <span style="color:var(--tx3);min-width:40px">${tarih}</span>
                    <span style="flex:1;color:var(--tx)">${ikonHtml}${puan.note || '-'}</span>
                    ${yazilmaSaati ? `<span style="color:var(--tx3);font-size:.65rem">${yazilmaSaati}</span>` : ''}
                    <span style="font-weight:700;color:${puanColor};min-width:32px;text-align:right">${puanEtki > 0 ? '+' : ''}${puanEtki}</span>
                </div>
            `;
        });
        
        // Toplu silme butonu
        if (canManage) {
            body += `<button onclick="deleteSelectedManuelNotes()" style="margin-top:8px;width:100%;padding:8px;background:rgba(231,76,60,.1);border:1px solid rgba(231,76,60,.2);color:#e74c3c;border-radius:6px;font-size:.75rem;cursor:pointer;display:none" id="manuelDeleteSelectedBtn">SeÃ§ilenleri Sil</button>`;
        }
        
        body += `</div>`;
    }
    
    // === PERSONEL CHECKLÄ°ST DOLDURMAMASI (Sadece MÃ¼dÃ¼r/YardÄ±mcÄ± iÃ§in) ===
    const isSupervisorRole = ['magaza_muduru', 'mudur_yardimcisi', 'magaza_mudur_yardimcisi'].includes(personelData?.role);
    const personelEksiKayitlar = personelData?.personelEksiKayitlar || [];
    
    if (isSupervisorRole) {
        const personelEksiTotal = personelEksiKayitlar.reduce((sum, r) => sum + (r.penalty || 0), 0);
        
        body += `
            <div style="margin-top:12px">
                <div style="font-size:.85rem;font-weight:600;color:var(--tx);margin-bottom:10px;display:flex;align-items:center;gap:6px">
                    <svg width="14" height="14" fill="none" stroke="#9b59b6" stroke-width="2" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
                    <span style="color:#9b59b6">Personel Checklist DoldurmamasÄ±</span>
                    <span style="color:var(--tx3);font-weight:400">(${personelEksiKayitlar.length})</span>
                    ${personelEksiTotal !== 0 ? `<span style="margin-left:auto;font-size:.75rem;font-weight:700;color:#9b59b6">${personelEksiTotal}</span>` : ''}
                </div>
        `;
        
        if (personelEksiKayitlar.length === 0) {
            body += `<div style="text-align:center;color:var(--tx3);font-size:.8rem;padding:16px;background:var(--bg2);border-radius:8px">Personel eksisi kaydÄ± yok ðŸ‘</div>`;
        } else {
            // Tarihe gÃ¶re sÄ±rala (yeni Ã¶nce)
            const sortedRecords = [...personelEksiKayitlar].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            
            sortedRecords.slice(0, 15).forEach(record => {
                const dateStr = record.date || '';
                const dateObj = new Date(dateStr);
                const tarih = isNaN(dateObj) ? '-' : `${String(dateObj.getDate()).padStart(2,'0')}.${String(dateObj.getMonth()+1).padStart(2,'0')}`;
                const penalty = record.penalty || 0;
                const personelName = record.personelName || 'Personel';
                const checkTypeName = record.checkTypeName || record.checkType || 'Check';
                const checkTime = record.checkTime || '';
                
                // YazÄ±lma saati (createdAt'ten)
                let yazilmaSaati = '';
                if (record.createdAt) {
                    const ts = record.createdAt.toDate ? record.createdAt.toDate() : new Date(record.createdAt);
                    yazilmaSaati = ts.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit', hour12: false });
                }
                
                body += `
                    <div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--bg2);border-radius:6px;margin-bottom:4px;font-size:.8rem">
                        <span style="color:var(--tx3);min-width:40px">${tarih}</span>
                        <span style="flex:1;color:var(--tx)">
                            <span style="font-weight:600;color:#9b59b6">${personelName}</span> - ${checkTypeName}${checkTime ? ' Â· ' + checkTime : ''}
                        </span>
                        ${yazilmaSaati ? `<span style="color:var(--tx3);font-size:.65rem">${yazilmaSaati}</span>` : ''}
                        <span style="font-weight:700;color:#9b59b6;min-width:32px;text-align:right">${penalty}</span>
                    </div>
                `;
            });
            
            if (personelEksiKayitlar.length > 15) {
                body += `<div style="text-align:center;color:var(--tx3);font-size:.7rem;padding:6px">+${personelEksiKayitlar.length - 15} kayÄ±t daha</div>`;
            }
        }
        
        body += `</div>`;
    }
    
    body += `</div>`;
    
    let footer = `<button class="btn btn-ghost" onclick="closeModal()">Kapat</button>`;
    if (canManage) {
        const evalName = (personelData.displayName || personName).replace(/'/g, "\\'");
        footer = `
            <button class="btn btn-ghost" onclick="closeModal()">Kapat</button>
            <button class="btn btn-primary" onclick="closeModal();showPuantajModal('${personelId}','${evalName}')">DeÄŸerlendir</button>
        `;
    }
    
    const modalTitle = personelData.displayName || formatDisplayName(personName);
    showModal(`${modalTitle} - Puan DetayÄ±`, body, footer);
    
    // Checkbox event listeners (modal aÃ§Ä±ldÄ±ktan sonra)
    setTimeout(() => {
        const modalBody = document.querySelector('.modal-body');
        if (!modalBody) return;
        
        // CF checkboxlarÄ±
        const cfCheckboxes = modalBody.querySelectorAll('.cf-checkbox');
        const cfDeleteBtn = modalBody.querySelector('#cfDeleteSelectedBtn');
        
        cfCheckboxes.forEach(cb => {
            cb.addEventListener('change', () => {
                const anyChecked = modalBody.querySelector('.cf-checkbox:checked');
                if (cfDeleteBtn) cfDeleteBtn.style.display = anyChecked ? 'block' : 'none';
            });
        });
        
        // CF "TÃ¼mÃ¼" checkbox
        const cfSelectAll = modalBody.querySelector('#cfSelectAll');
        if (cfSelectAll) {
            cfSelectAll.addEventListener('change', () => {
                cfCheckboxes.forEach(c => c.checked = cfSelectAll.checked);
                if (cfDeleteBtn) cfDeleteBtn.style.display = cfSelectAll.checked && cfCheckboxes.length > 0 ? 'block' : 'none';
            });
        }
        
        // Manuel checkboxlarÄ±
        const manuelCheckboxes = modalBody.querySelectorAll('.manuel-checkbox');
        const manuelDeleteBtn = modalBody.querySelector('#manuelDeleteSelectedBtn');
        
        manuelCheckboxes.forEach(cb => {
            cb.addEventListener('change', () => {
                const anyChecked = modalBody.querySelector('.manuel-checkbox:checked');
                if (manuelDeleteBtn) manuelDeleteBtn.style.display = anyChecked ? 'block' : 'none';
            });
        });
        
        // Manuel "TÃ¼mÃ¼" checkbox
        const manuelSelectAll = modalBody.querySelector('#manuelSelectAll');
        if (manuelSelectAll) {
            manuelSelectAll.addEventListener('change', () => {
                manuelCheckboxes.forEach(c => c.checked = manuelSelectAll.checked);
                if (manuelDeleteBtn) manuelDeleteBtn.style.display = manuelSelectAll.checked && manuelCheckboxes.length > 0 ? 'block' : 'none';
            });
        }
    }, 150);
}

// Otomatik puantaj notu sil
async function deleteAutoNote(noteId, source = 'AP') {
    // Yetki kontrolÃ¼
    const canManagePoints = ['yonetici', 'bolge_muduru', 'magaza_muduru', 'mudur', 'admin'].includes(currentUser?.role);
    if (!canManagePoints) {
        toast('Bu iÅŸlem iÃ§in yetkiniz yok', 'error');
        return;
    }
    
    confirmModal('Puantaj KaydÄ±nÄ± Sil', 'Bu otomatik puan kaydÄ±nÄ± silmek istediÄŸinize emin misiniz?', async () => {
        try {
            // CF kayÄ±tlarÄ± puantaj koleksiyonunda, AP kayÄ±tlarÄ± puantajNotes'da
            const collection = source === 'CF' ? 'puantaj' : 'puantajNotes';
            await db.collection(collection).doc(noteId).delete();
            toast('Puan kaydÄ± silindi', 'success');
            loadPuantaj(); // SayfayÄ± yenile
        } catch (e) {
            console.error('Silme hatasÄ±:', e);
            toast('Silme iÅŸlemi baÅŸarÄ±sÄ±z', 'error');
        }
    }, 'danger');
}

// SeÃ§ili CF notlarÄ±nÄ± toplu sil
async function deleteSelectedCFNotes() {
    const canManagePoints = ['yonetici', 'bolge_muduru', 'magaza_muduru', 'mudur', 'admin'].includes(currentUser?.role);
    if (!canManagePoints) {
        toast('Bu iÅŸlem iÃ§in yetkiniz yok', 'error');
        return;
    }
    
    const selected = document.querySelectorAll('.cf-checkbox:checked');
    if (selected.length === 0) {
        toast('Silinecek kayÄ±t seÃ§in', 'warning');
        return;
    }
    
    confirmModal('Toplu Silme', `${selected.length} CF kaydÄ±nÄ± silmek istediÄŸinize emin misiniz?`, async () => {
        try {
            const batch = db.batch();
            selected.forEach(cb => {
                const id = cb.dataset.id;
                if (id) batch.delete(db.collection('puantaj').doc(id));
            });
            await batch.commit();
            toast(`${selected.length} kayÄ±t silindi`, 'success');
            closeModal();
            setTimeout(loadPuantaj, 500);
        } catch (e) {
            console.error('Toplu silme hatasÄ±:', e);
            toast('Silme iÅŸlemi baÅŸarÄ±sÄ±z', 'error');
        }
    }, 'danger');
}

// SeÃ§ili manuel notlarÄ±nÄ± toplu sil
async function deleteSelectedManuelNotes() {
    const canManagePoints = ['yonetici', 'bolge_muduru', 'magaza_muduru', 'mudur', 'admin'].includes(currentUser?.role);
    if (!canManagePoints) {
        toast('Bu iÅŸlem iÃ§in yetkiniz yok', 'error');
        return;
    }
    
    const selected = document.querySelectorAll('.manuel-checkbox:checked');
    if (selected.length === 0) {
        toast('Silinecek kayÄ±t seÃ§in', 'warning');
        return;
    }
    
    confirmModal('Toplu Silme', `${selected.length} manuel kaydÄ± silmek istediÄŸinize emin misiniz?`, async () => {
        try {
            const batch = db.batch();
            selected.forEach(cb => {
                const id = cb.dataset.id;
                if (id) batch.delete(db.collection('puantaj').doc(id));
            });
            await batch.commit();
            toast(`${selected.length} kayÄ±t silindi`, 'success');
            closeModal();
            setTimeout(loadPuantaj, 500);
        } catch (e) {
            console.error('Toplu silme hatasÄ±:', e);
            toast('Silme iÅŸlemi baÅŸarÄ±sÄ±z', 'error');
        }
    }, 'danger');
}

// DetaylÄ± kural aÃ§Ä±klamalarÄ± modalÄ±
function showPuantajRulesDetail() {
    showModal('Performans KurallarÄ±', `
        <div style="max-height:60vh;overflow-y:auto">
            <div style="margin-bottom:20px">
                <div style="font-weight:600;color:var(--tx);margin-bottom:10px;font-size:.95rem">Checklist PuanlarÄ±</div>
                <div style="background:var(--bg3);border-radius:10px;padding:14px">
                    <div style="display:grid;gap:8px;font-size:.85rem">
                        <div style="display:flex;justify-content:space-between;color:var(--tx)">
                            <span>Vaktinde tamamlanan check</span>
                            <span style="color:#27ae60;font-weight:600">+1 puan</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;color:var(--tx)">
                            <span>GeÃ§ tamamlanan check (pencere sonrasÄ±)</span>
                            <span style="color:#f39c12;font-weight:600">-2 puan</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;color:var(--tx)">
                            <span>YapÄ±lmayan/doldurulmayan check</span>
                            <span style="color:#e74c3c;font-weight:600">-2 puan</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom:20px">
                <div style="font-weight:600;color:var(--tx);margin-bottom:10px;font-size:.95rem">Platform Check</div>
                <div style="background:var(--bg3);border-radius:10px;padding:14px">
                    <div style="font-size:.85rem;color:var(--tx);margin-bottom:8px">Saatler: 10:00, 12:00, 15:00, 18:00, 21:00, 00:00</div>
                    <div style="display:flex;justify-content:space-between;color:var(--tx);font-size:.85rem">
                        <span>Her yapÄ±lmayan saat iÃ§in</span>
                        <span style="color:#9b59b6;font-weight:600">-1 puan</span>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom:20px">
                <div style="font-weight:600;color:var(--tx);margin-bottom:10px;font-size:.95rem">Temizlik Ã‡izelgesi</div>
                <div style="background:var(--bg3);border-radius:10px;padding:14px;font-size:.85rem">
                    <div style="margin-bottom:8px;color:var(--tx)"><strong>AÃ§Ä±lÄ±ÅŸÃ§Ä±:</strong> 10:00-11:00 shift baÅŸlangÄ±cÄ± â†’ 15:00'a kadar tamamlanmalÄ±</div>
                    <div style="margin-bottom:8px;color:var(--tx)"><strong>AracÄ±:</strong> 11:00-16:00 shift baÅŸlangÄ±cÄ± â†’ 19:00'a kadar tamamlanmalÄ±</div>
                    <div style="color:var(--tx)"><strong>KapanÄ±ÅŸÃ§Ä±:</strong> 16:00+ shift baÅŸlangÄ±cÄ± â†’ 02:00'a kadar tamamlanmalÄ±</div>
                </div>
            </div>
            
            <div style="margin-bottom:20px">
                <div style="font-weight:600;color:var(--tx);margin-bottom:10px;font-size:.95rem">Manuel DeÄŸerlendirme (YÃ¶netici)</div>
                <div style="background:var(--bg3);border-radius:10px;padding:14px">
                    <div style="display:grid;gap:6px;font-size:.85rem">
                        <div style="display:flex;justify-content:space-between;color:var(--tx)">
                            <span>â­ Ciddi ihlal</span>
                            <span style="color:#e74c3c;font-weight:600">-3 puan</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;color:var(--tx)">
                            <span>â­â­ Orta ihlal</span>
                            <span style="color:#e67e22;font-weight:600">-2 puan</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;color:var(--tx)">
                            <span>â­â­â­ Hafif uyarÄ±</span>
                            <span style="color:#f39c12;font-weight:600">-1 puan</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;color:var(--tx)">
                            <span>â­â­â­â­ Ä°yi performans</span>
                            <span style="color:#27ae60;font-weight:600">+1 puan</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;color:var(--tx)">
                            <span>â­â­â­â­â­ MÃ¼kemmel</span>
                            <span style="color:#27ae60;font-weight:600">+2 puan</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="background:rgba(231,76,60,.1);border:1px solid rgba(231,76,60,.2);border-radius:10px;padding:14px">
                <div style="font-weight:600;color:#e74c3c;margin-bottom:6px;font-size:.9rem">Prim EÅŸiÄŸi</div>
                <div style="font-size:.85rem;color:var(--tx)">Toplam puan <strong>-5</strong> veya altÄ±na dÃ¼ÅŸerse, o ay prim hakkÄ± kaybedilir.</div>
                <div style="font-size:.8rem;color:var(--tx3);margin-top:6px">Her ay baÅŸÄ± puanlar sÄ±fÄ±rlanÄ±r.</div>
            </div>
        </div>
    `, '<button class="btn btn-primary" onclick="closeModal()">AnladÄ±m</button>');
}

function showPuantajModal(personelId, name, type = 'all') {
    // BÃ¶lge mÃ¼dÃ¼rÃ¼nÃ¼ sadece yÃ¶netici deÄŸerlendirebilir
    const personelData = window.puantajPersonelCache?.find(p => p.id === personelId);
    if (personelData?.role === 'bolge_muduru' && currentUser?.role !== 'yonetici') {
        toast('BÃ¶lge mÃ¼dÃ¼rÃ¼nÃ¼ sadece yÃ¶neticiler deÄŸerlendirebilir', 'warning');
        return;
    }
    
    // displayName varsa onu kullan (codeName'den geliyor)
    const displayName = personelData?.displayName || name;
    const title = `${displayName} - Manuel DeÄŸerlendirme`;
    
    // Config'den dinamik yÄ±ldÄ±z seÃ§enekleri oluÅŸtur
    const config = starPointsConfig || {
        1: { label: 'Ciddi Ä°hlal', points: -3, color: '#8B0000' },
        2: { label: 'Orta Ä°hlal', points: -2, color: '#C0392B' },
        3: { label: 'Hafif Ä°hlal', points: -1, color: '#D35400' },
        4: { label: 'Ä°yi', points: 1, color: '#DAA520' },
        5: { label: 'MÃ¼kemmel', points: 2, color: '#FFD700' }
    };
    
    // YÄ±ldÄ±z seÃ§eneklerini config'den oluÅŸtur
    let starOptions = '';
    for (let star = 1; star <= 5; star++) {
        const cfg = config[star] || { label: '', points: star - 3, color: '#888' };
        const starStr = 'â˜…'.repeat(star);
        const points = cfg.points;
        const pointsDisplay = points > 0 ? `+${points}` : points;
        const isNegative = points < 0;
        const bgOpacity = isNegative ? '0.08' : '0.1';
        
        starOptions += `
            <div class="star-option" onclick="selectPuantajStar(${star}, this)" 
                style="padding:14px 8px;background:${cfg.color}${Math.round(bgOpacity * 255).toString(16).padStart(2, '0')};border:2px solid transparent;border-radius:12px;cursor:pointer;text-align:center;transition:all .2s">
                <div style="font-size:1.2rem;margin-bottom:6px;color:${cfg.color};text-shadow:0 1px 2px rgba(0,0,0,.1)">${starStr}</div>
                <div style="font-size:.7rem;color:${cfg.color};font-weight:600;line-height:1.3">${cfg.label}</div>
                <div style="font-size:.85rem;color:${cfg.color};font-weight:700;margin-top:4px">${pointsDisplay}</div>
            </div>
        `;
    }
    
    // Åžu anki tarih ve saat
    const now = new Date();
    const dateStr = now.toISOString().split('T')[0];
    const timeStr = now.toTimeString().slice(0, 5);
    
    const body = `
        <div style="padding:8px 0">
            <div style="text-align:center;margin-bottom:20px">
                <svg width="36" height="36" fill="none" stroke="#DAA520" stroke-width="2" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                <div style="color:var(--tx);font-weight:700;font-size:1.05rem;margin-top:8px">DeÄŸerlendirme SeÃ§</div>
            </div>
            
            <div style="display:grid;grid-template-columns:repeat(5, 1fr);gap:10px;margin-bottom:24px">
                ${starOptions}
            </div>
            
            <div style="margin-bottom:20px">
                <label style="display:block;font-size:.85rem;color:var(--tx2);margin-bottom:8px;font-weight:600">AÃ§Ä±klama <span style="color:#e74c3c">*</span></label>
                <textarea id="puantajNote" class="form-input" rows="3" placeholder="DeÄŸerlendirme aÃ§Ä±klamasÄ± yazÄ±n..." style="background:var(--bg2);color:var(--tx);border-color:var(--bg4);resize:vertical;min-height:80px;font-family:inherit;border-radius:10px"></textarea>
            </div>
            
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:14px;background:var(--bg2);border-radius:10px;opacity:.7">
                <div>
                    <label style="display:block;font-size:.75rem;color:var(--tx3);margin-bottom:6px">Tarih</label>
                    <input type="date" id="puantajDate" class="form-input" value="${dateStr}" readonly style="background:var(--bg3);color:var(--tx2);border-color:var(--bg4);cursor:not-allowed;font-size:.85rem">
                </div>
                <div>
                    <label style="display:block;font-size:.75rem;color:var(--tx3);margin-bottom:6px">Saat</label>
                    <input type="time" id="puantajTime" class="form-input" value="${timeStr}" readonly style="background:var(--bg3);color:var(--tx2);border-color:var(--bg4);cursor:not-allowed;font-size:.85rem">
                </div>
            </div>
            
            <input type="hidden" id="puantajPersonelId" value="${personelId}">
            <input type="hidden" id="puantajScore" value="0">
        </div>
    `;
    
    showModal(title, body, `
        <button class="btn btn-ghost" onclick="closeModal()">Ä°ptal</button>
        <button class="btn btn-primary" onclick="savePuantajFromModal()">Kaydet</button>
    `);
}

function selectPuantajStar(value, element) {
    document.getElementById('puantajScore').value = value;
    
    // Config'den renk al
    const config = starPointsConfig || {};
    const cfg = config[value] || { color: '#888', points: value - 3 };
    
    document.querySelectorAll('.star-option').forEach(el => {
        el.style.borderColor = 'transparent';
        el.style.transform = 'scale(1)';
        el.style.boxShadow = 'none';
    });
    if (element) {
        element.style.borderColor = cfg.color;
        element.style.transform = 'scale(1.05)';
        element.style.boxShadow = `0 4px 12px ${cfg.color}40`;
    }
}

// Sekme deÄŸiÅŸtirme
function showPuantajTab(tab, btn) {
    // Sekmeleri gizle
    document.getElementById('puantajKayitTab').style.display = 'none';
    document.getElementById('puantajAnalizTab').style.display = 'none';
    document.getElementById('puantajArsivTab').style.display = 'none';
    document.getElementById('puantajChecklistlerTab').style.display = 'none';
    
    // ButonlarÄ± gÃ¼ncelle
    document.querySelectorAll('.puantaj-tab').forEach(b => {
        b.style.background = 'var(--bg3)';
        b.style.color = 'var(--tx)';
        b.style.boxShadow = 'none';
    });
    btn.style.background = 'linear-gradient(135deg, var(--accent), #ff6b5b)';
    btn.style.color = '#fff';
    btn.style.boxShadow = '0 2px 12px rgba(255,134,116,.3)';
    
    // SeÃ§ili sekmeyi gÃ¶ster
    if (tab === 'kayit') {
        document.getElementById('puantajKayitTab').style.display = 'block';
    } else if (tab === 'analiz') {
        document.getElementById('puantajAnalizTab').style.display = 'block';
        populateSubeSelect('analizSube');
        loadPuantajAnaliz();
    } else if (tab === 'arsiv') {
        document.getElementById('puantajArsivTab').style.display = 'block';
        // Barista kontrolÃ¼
        if (currentUser?.role === 'barista') {
            document.getElementById('puantajArsivContainer').innerHTML = `
                <div style="text-align:center;padding:60px 20px;grid-column:1/-1">
                    <svg width="48" height="48" fill="none" stroke="var(--tx3)" stroke-width="1.5" viewBox="0 0 24 24" style="margin-bottom:16px;opacity:.5"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
                    <div style="font-size:1.1rem;font-weight:600;color:var(--tx);margin-bottom:8px">ArÅŸiv EriÅŸimi KÄ±sÄ±tlÄ±</div>
                    <div style="font-size:.85rem;color:var(--tx3);max-width:300px;margin:0 auto">Bu bÃ¶lÃ¼m sadece yÃ¶neticiler tarafÄ±ndan gÃ¶rÃ¼ntÃ¼lenebilir.</div>
                </div>
            `;
            document.getElementById('arsivSummary').innerHTML = '';
            document.getElementById('arsivTrendChart').innerHTML = '';
            document.getElementById('arsivPieChart').innerHTML = '';
            return;
        }
        populateSubeSelect('arsivSube');
        loadPuantajArsiv();
    } else if (tab === 'checklistler') {
        document.getElementById('puantajChecklistlerTab').style.display = 'block';
        // Åžube select'ini doldur
        populateSubeSelect('checklistlerSube');
        // BugÃ¼nÃ¼n tarihini set et
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('checklistlerTarih').value = today;
        loadFilledChecklists();
    }
}

// Checklistler tabÄ± butonunu yÃ¶netici iÃ§in gÃ¶ster
function initChecklistlerTab() {
    const isManager = ['yonetici', 'bolge_muduru', 'magaza_muduru'].includes(currentUser?.role);
    const tabBtn = document.getElementById('checklistlerTabBtn');
    if (tabBtn) {
        tabBtn.style.display = isManager ? 'flex' : 'none';
    }
}

// Doldurulan checklistleri yÃ¼kle
async function loadFilledChecklists() {
    const container = document.getElementById('checklistlerContainer');
    const summaryContainer = document.getElementById('checklistlerSummary');
    const tarih = document.getElementById('checklistlerTarih')?.value;
    const sube = document.getElementById('checklistlerSube')?.value || 'all';
    const tur = document.getElementById('checklistlerTur')?.value || 'all';
    
    if (!tarih) {
        container.innerHTML = '<p style="color:var(--tx2);text-align:center;padding:40px">Tarih seÃ§in...</p>';
        summaryContainer.innerHTML = '';
        return;
    }
    
    container.innerHTML = '<p style="color:var(--tx2);text-align:center;padding:40px">YÃ¼kleniyor...</p>';
    
    try {
        // Checklistleri Ã§ek
        let query = db.collection('checklistSubmissions').where('date', '==', tarih);
        
        const snap = await query.get();
        let submissions = [];
        
        snap.forEach(doc => {
            const data = doc.data();
            // Filtrele
            if (sube !== 'all' && data.branch !== sube) return;
            if (tur !== 'all' && data.type !== tur) return;
            
            submissions.push({
                id: doc.id,
                ...data
            });
        });
        
        // Ã–zet kartlarÄ±
        const totalCount = submissions.length;
        const skippedCount = submissions.filter(s => s.skippedItems?.length > 0).length;
        const totalDuration = submissions.reduce((sum, s) => sum + (s.actualDurationMinutes || 0), 0);
        const avgDuration = totalCount > 0 ? Math.round(totalDuration / totalCount) : 0;
        
        summaryContainer.innerHTML = `
            <div style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:16px;text-align:center">
                <div style="font-size:1.8rem;font-weight:700;color:#008c95">${totalCount}</div>
                <div style="font-size:.8rem;color:var(--tx2)">Doldurulan</div>
            </div>
            <div style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:16px;text-align:center">
                <div style="font-size:1.8rem;font-weight:700;color:#f39c12">${skippedCount}</div>
                <div style="font-size:.8rem;color:var(--tx2)">Eksik Madde Var</div>
            </div>
            <div style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:16px;text-align:center">
                <div style="font-size:1.8rem;font-weight:700;color:#008c95">${avgDuration}dk</div>
                <div style="font-size:.8rem;color:var(--tx2)">Ort. SÃ¼re</div>
            </div>
            <div style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;padding:16px;text-align:center">
                <div style="font-size:1.8rem;font-weight:700;color:#008c95">${totalDuration}dk</div>
                <div style="font-size:.8rem;color:var(--tx2)">Toplam SÃ¼re</div>
            </div>
        `;
        
        if (submissions.length === 0) {
            container.innerHTML = `
                <div style="text-align:center;padding:60px 20px">
                    <svg width="48" height="48" fill="none" stroke="var(--tx3)" stroke-width="1.5" viewBox="0 0 24 24" style="margin-bottom:16px;opacity:.5"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
                    <div style="font-size:1.1rem;font-weight:600;color:var(--tx);margin-bottom:8px">Bu Tarihte Checklist Yok</div>
                    <div style="font-size:.85rem;color:var(--tx3)">SeÃ§ili tarih ve filtrelere uygun checklist bulunamadÄ±.</div>
                </div>
            `;
            return;
        }
        
        // Åžubelere gÃ¶re grupla
        const byBranch = {};
        submissions.forEach(s => {
            if (!byBranch[s.branch]) byBranch[s.branch] = [];
            byBranch[s.branch].push(s);
        });
        
        let html = '';
        
        for (const [branch, items] of Object.entries(byBranch)) {
            html += `
                <div style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:12px;overflow:hidden;margin-bottom:16px">
                    <div style="background:linear-gradient(135deg,#008c95,#00a5af);color:#fff;padding:12px 16px;font-weight:600;display:flex;align-items:center;gap:8px">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>
                        ${branch}
                    </div>
                    <div style="padding:12px">
            `;
            
            // TÃ¼re gÃ¶re grupla
            const byType = {};
            items.forEach(item => {
                if (!byType[item.type]) byType[item.type] = [];
                byType[item.type].push(item);
            });
            
            for (const [type, typeItems] of Object.entries(byType)) {
                const typeName = getChecklistTypeName(branch, type);
                
                html += `<div style="margin-bottom:12px">
                    <div style="font-weight:600;color:var(--tx);margin-bottom:8px;font-size:.9rem">${typeName}</div>
                `;
                
                for (const item of typeItems) {
                    const startTime = item.startTime ? new Date(item.startTime).toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'}) : '-';
                    const endTime = item.endTime ? new Date(item.endTime).toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'}) : '-';
                    const duration = item.actualDurationMinutes || 0;
                    const hasSkipped = item.skippedItems?.length > 0;
                    const skippedCount = item.skippedItems?.length || 0;
                    const completionRate = item.completionRate || 100;
                    
                    html += `
                        <div style="background:var(--bg2);border:1px solid var(--bg4);border-radius:8px;padding:12px;margin-bottom:8px;${hasSkipped ? 'border-left:3px solid #f39c12;' : ''}">
                            <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
                                <div>
                                    <div style="font-weight:600;color:var(--tx)">${item.personName || item.submittedByName || 'Bilinmiyor'}</div>
                                    <div style="font-size:.8rem;color:var(--tx2)">${startTime} - ${endTime} (${duration}dk)</div>
                                </div>
                                <div style="display:flex;align-items:center;gap:8px">
                                    <span style="padding:4px 8px;border-radius:4px;font-size:.75rem;font-weight:600;background:${completionRate === 100 ? 'rgba(39,174,96,.1);color:#27ae60' : 'rgba(243,156,18,.1);color:#f39c12'}">${completionRate}%</span>
                                    ${hasSkipped ? `<span style="padding:4px 8px;border-radius:4px;font-size:.75rem;font-weight:600;background:rgba(231,76,60,.1);color:#e74c3c">${skippedCount} eksik</span>` : ''}
                                </div>
                            </div>
                            ${hasSkipped ? `
                                <div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--bg4)">
                                    <div style="font-size:.75rem;font-weight:600;color:#e74c3c;margin-bottom:6px">âŒ YapÄ±lmayan Maddeler:</div>
                                    <ul style="margin:0;padding-left:20px;font-size:.8rem;color:var(--tx2)">
                                        ${item.skippedItems.map(si => `<li style="margin-bottom:4px">${si.text || si.id}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                html += '</div>';
            }
            
            html += '</div></div>';
        }
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Checklistler yÃ¼klenemedi:', error);
        container.innerHTML = '<p style="color:#e74c3c;text-align:center;padding:40px">Hata oluÅŸtu!</p>';
    }
}

// Checklist tÃ¼rÃ¼ adÄ±nÄ± al
async function savePuantajFromModal() {
    const personelId = document.getElementById('puantajPersonelId').value;
    const score = parseInt(document.getElementById('puantajScore').value);
    const note = document.getElementById('puantajNote')?.value?.trim() || '';
    const eventDate = document.getElementById('puantajDate')?.value || new Date().toISOString().split('T')[0];
    const eventTime = document.getElementById('puantajTime')?.value || new Date().toTimeString().slice(0, 5);
    
    if (score === 0) {
        toast('LÃ¼tfen yÄ±ldÄ±z seviyesi seÃ§in', 'error');
        return;
    }
    
    if (!note) {
        toast('LÃ¼tfen aÃ§Ä±klama girin', 'error');
        return;
    }
    
    const ay = document.getElementById('puantajAy').value;
    const yil = document.getElementById('puantajYil').value;
    const sube = document.getElementById('puantajSube').value;
    const puantajKey = `${yil}-${ay}`;
    
    // Personelin gerÃ§ek branch'ini bul (bÃ¶lge mÃ¼dÃ¼rÃ¼ iÃ§in 'all')
    const personelData = window.puantajPersonelCache?.find(p => p.id === personelId);
    const personelBranch = personelData?.role === 'bolge_muduru' ? 'all' : sube;
    
    try {
        await db.collection('puantaj').add({
            personelId,
            period: puantajKey,
            branch: personelBranch,
            score,
            note,
            eventDate,
            eventTime,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdBy: currentUser?.email || currentUser?.username || 'admin'
        });
        
        toast('KayÄ±t eklendi!', 'success');
        closeModal();
        loadPuantaj();
    } catch (error) {
        console.error('Puantaj kayÄ±t hatasÄ±:', error);
        toast('KayÄ±t hatasÄ±!', 'error');
    }
}

// Prim SÄ±fÄ±rlama Fonksiyonu
async function resetPersonelPrim(personelId, name) {
    // Yetki kontrolÃ¼ - sadece yÃ¶neticiler
    const canReset = ['yonetici', 'bolge_muduru', 'magaza_muduru', 'mudur', 'admin'].includes(currentUser?.role);
    if (!canReset) {
        toast('Bu iÅŸlem iÃ§in yetkiniz yok', 'error');
        return;
    }
    
    const ay = document.getElementById('puantajAy')?.value || String(new Date().getMonth() + 1).padStart(2, '0');
    const yil = document.getElementById('puantajYil')?.value || new Date().getFullYear();
    const sube = document.getElementById('puantajSube')?.value || '';
    const period = `${yil}-${ay}`;
    
    // Mevcut puanÄ± hesapla
    const personel = window.puantajPersonelCache?.find(p => p.id === personelId);
    const mevcutPuan = personel?.toplamPuan || 0;
    const telafiPuani = -mevcutPuan; // Her durumda tersini ver (pozitif ise negatif, negatif ise pozitif)
    
    confirmModal(
        'Primi SÄ±fÄ±rla',
        `<div style="text-align:center">
            <div style="font-size:2.5rem;margin-bottom:12px">ðŸ”„</div>
            <div style="font-weight:600;color:var(--tx);margin-bottom:8px">${name}</div>
            <div style="font-size:.85rem;color:var(--tx2);margin-bottom:16px">${ay}/${yil} DÃ¶nemi</div>
            <div style="background:var(--bg3);border-radius:10px;padding:12px;margin-bottom:16px">
                <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                    <span style="color:var(--tx2)">Mevcut Puan:</span>
                    <span style="font-weight:700;color:#e74c3c">${mevcutPuan}</span>
                </div>
                <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                    <span style="color:var(--tx2)">Telafi PuanÄ±:</span>
                    <span style="font-weight:700;color:${telafiPuani >= 0 ? '#27ae60' : '#e74c3c'}">${telafiPuani > 0 ? '+' : ''}${telafiPuani}</span>
                </div>
                <div style="border-top:1px solid var(--bg4);padding-top:8px;display:flex;justify-content:space-between">
                    <span style="color:var(--tx);font-weight:600">Yeni Puan:</span>
                    <span style="font-weight:700;color:#008c95">0</span>
                </div>
            </div>
            <div style="font-size:.8rem;color:var(--tx3)">TÃ¼m kayÄ±tlar geÃ§miÅŸte saklanÄ±r.</div>
        </div>`,
        async () => {
            try {
                // Telafi puanÄ± ekle (mevcut negatifi sÄ±fÄ±rla)
                await db.collection('puantaj').add({
                    personelId,
                    personelName: name,
                    period,
                    branch: sube,
                    score: telafiPuani,
                    type: 'prim_reset',
                    note: `Prim sÄ±fÄ±rlama (${mevcutPuan} â†’ 0) - ${currentUser?.name || 'YÃ¶netici'}`,
                    eventDate: new Date().toISOString().split('T')[0],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser?.email || currentUser?.username || 'admin'
                });
                
                toast(`${name} puanÄ± sÄ±fÄ±rlandÄ±`, 'success');
                loadPuantaj();
            } catch (error) {
                console.error('Prim sÄ±fÄ±rlama hatasÄ±:', error);
                toast('SÄ±fÄ±rlama hatasÄ±: ' + error.message, 'error');
            }
        },
        'warning'
    );
}

// Analiz yÃ¼kleme
async function loadPuantajAnaliz() {
    const container = document.getElementById('puantajAnalizContainer');
    if (!container) return;
    
    const donem = document.getElementById('analizDonem')?.value || 'current';
    const sube = document.getElementById('analizSube')?.value || '';
    
    container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--tx2)">Analiz yÃ¼kleniyor...</div>';
    
    try {
        // 1. Ã–nce aktif personel listesini Ã§ek
        const personelSnapshot = await db.collection('personel').get();
        const personelMap = {};
        
        personelSnapshot.forEach(doc => {
            const d = doc.data();
            if (d.status !== 'inactive' && d.status !== 'deleted') {
                personelMap[doc.id] = {
                    name: d.name,
                    codeName: d.codeName,
                    position: d.position,
                    branch: d.branch,
                    photoUrl: d.photoUrl || ''
                };
            }
        });
        
        // 2. puantaj koleksiyonundan veri Ã§ek
        let query = db.collection('puantaj');
        if (sube) query = query.where('branch', '==', sube);
        
        if (donem === 'current') {
            const now = new Date();
            const currentPeriod = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            query = query.where('period', '==', currentPeriod);
        }
        
        const snapshot = await query.get();
        
        // Personel bazÄ±nda toplama
        const personelStats = {};
        snapshot.forEach(doc => {
            const d = doc.data();
            const personelInfo = personelMap[d.personelId];
            
            // Sadece aktif personelleri dahil et
            if (!personelInfo) return;
            
            if (!personelStats[d.personelId]) {
                personelStats[d.personelId] = { 
                    id: d.personelId, 
                    name: personelInfo.name,
                    position: personelInfo.position,
                    toplamPuan: 0, 
                    negatif: 0, 
                    pozitif: 0, 
                    kayitlar: [] 
                };
            }
            
            const yildiz = d.score || 3;
            // Puan sistemi: config'den dinamik
            const puan = getPointsFromStar(yildiz);
            personelStats[d.personelId].toplamPuan += puan;
            if (puan < 0) {
                personelStats[d.personelId].negatif++;
            } else if (puan > 0) {
                personelStats[d.personelId].pozitif++;
            }
            personelStats[d.personelId].kayitlar.push(d);
        });
        
        const sortedPersonel = Object.values(personelStats).sort((a, b) => b.toplamPuan - a.toplamPuan);
        
        let html = '';
        
        // Ã–zet Kartlar
        html += `<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px">`;
        
        // En Ä°yi Personel
        const enIyi = sortedPersonel.length > 0 ? sortedPersonel[0] : null;
        html += `
            <div style="background:linear-gradient(135deg,rgba(39,174,96,.15),rgba(46,204,113,.1));border:1px solid rgba(39,174,96,.3);border-radius:16px;padding:20px;text-align:center">
                <div style="margin-bottom:8px"><svg width="32" height="32" fill="none" stroke="#f1c40f" stroke-width="2" viewBox="0 0 24 24"><path d="M8 21h8M12 17v4M7.8 17h8.4c1.68 0 2.52 0 3.162-.327a3 3 0 001.311-1.311C21 14.72 21 13.88 21 12.2V7.8c0-1.68 0-2.52-.327-3.162a3 3 0 00-1.311-1.311C18.72 3 17.88 3 16.2 3H7.8c-1.68 0-2.52 0-3.162.327a3 3 0 00-1.311 1.311C3 5.28 3 6.12 3 7.8v4.4c0 1.68 0 2.52.327 3.162a3 3 0 001.311 1.311C5.28 17 6.12 17 7.8 17z"/></svg></div>
                <div style="font-size:.75rem;color:var(--tx2);text-transform:uppercase;margin-bottom:4px">AyÄ±n En Ä°yisi</div>
                <div style="font-size:1.1rem;font-weight:700;color:#27ae60">${enIyi?.name || '-'}</div>
                <div style="font-size:.85rem;color:var(--tx2)">${enIyi ? (enIyi.toplamPuan > 0 ? '+' : '') + enIyi.toplamPuan + ' Puan' : ''}</div>
            </div>
        `;
        
        // Dikkat Edilmesi Gereken
        const dikkat = sortedPersonel.length > 0 ? sortedPersonel[sortedPersonel.length - 1] : null;
        html += `
            <div style="background:linear-gradient(135deg,rgba(231,76,60,.15),rgba(192,57,43,.1));border:1px solid rgba(231,76,60,.3);border-radius:16px;padding:20px;text-align:center">
                <div style="margin-bottom:8px"><svg width="32" height="32" fill="none" stroke="#e74c3c" stroke-width="2" viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></div>
                <div style="font-size:.75rem;color:var(--tx2);text-transform:uppercase;margin-bottom:4px">DÃ¼ÅŸÃ¼k Performans</div>
                <div style="font-size:1.1rem;font-weight:700;color:#e74c3c">${dikkat?.name || '-'}</div>
                <div style="font-size:.85rem;color:var(--tx2)">${dikkat ? (dikkat.toplamPuan > 0 ? '+' : '') + dikkat.toplamPuan + ' Puan' : ''}</div>
            </div>
        `;
        
        // Toplam KayÄ±t
        const toplamKayit = snapshot.size;
        html += `
            <div style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:16px;padding:20px;text-align:center">
                <div style="margin-bottom:8px"><svg width="32" height="32" fill="none" stroke="#008c95" stroke-width="2" viewBox="0 0 24 24"><path d="M18 20V10M12 20V4M6 20v-6"/></svg></div>
                <div style="font-size:.75rem;color:var(--tx2);text-transform:uppercase;margin-bottom:4px">Toplam KayÄ±t</div>
                <div style="font-size:1.1rem;font-weight:700;color:var(--tx)">${toplamKayit}</div>
            </div>
        `;
        
        html += `</div>`;
        
        // SÄ±ralama Tablosu
        html += `<div style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:16px;padding:20px">`;
        html += `<div style="font-weight:600;margin-bottom:16px;color:var(--tx);display:flex;align-items:center;gap:8px"><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/></svg> Personel SÄ±ralamasÄ±</div>`;
        
        if (sortedPersonel.length === 0) {
            html += `<div style="text-align:center;padding:40px;color:var(--tx3)">Bu dÃ¶nemde kayÄ±t yok</div>`;
        } else {
            sortedPersonel.forEach((p, i) => {
                // Madalya yerine numara ve renk
                const rankBg = i === 0 ? 'linear-gradient(135deg,#f1c40f,#f39c12)' : (i === 1 ? 'linear-gradient(135deg,#bdc3c7,#95a5a6)' : (i === 2 ? 'linear-gradient(135deg,#e67e22,#d35400)' : 'var(--bg4)'));
                const rankColor = i < 3 ? '#fff' : 'var(--tx)';
                const puanColor = p.toplamPuan < 0 ? '#e74c3c' : (p.toplamPuan > 0 ? '#27ae60' : 'var(--tx)');
                const primStatus = p.toplamPuan <= -5;
                
                html += `
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:14px;background:${primStatus ? 'rgba(231,76,60,.08)' : 'var(--bg3)'};border-radius:10px;margin-bottom:8px">
                        <div style="display:flex;align-items:center;gap:12px">
                            <div style="width:28px;height:28px;background:${rankBg};border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.8rem;font-weight:700;color:${rankColor}">${i + 1}</div>
                            <div>
                                <div style="font-weight:600;color:var(--tx)">${p.name || 'Bilinmiyor'}</div>
                                <div style="font-size:.75rem;color:var(--tx3)">${p.position || ''}</div>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:16px">
                            <div style="text-align:center">
                                <div style="font-size:.65rem;color:var(--tx3)">Negatif</div>
                                <div style="font-weight:600;color:#e74c3c">${p.negatif}</div>
                            </div>
                            <div style="text-align:center">
                                <div style="font-size:.65rem;color:var(--tx3)">Pozitif</div>
                                <div style="font-weight:600;color:#27ae60">${p.pozitif}</div>
                            </div>
                            <div style="min-width:60px;text-align:right">
                                <div style="font-size:1.2rem;font-weight:700;color:${puanColor}">${p.toplamPuan > 0 ? '+' : ''}${p.toplamPuan}</div>
                                ${primStatus ? '<div style="font-size:.65rem;color:#e74c3c">PRÄ°M YOK</div>' : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        html += `</div>`;
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Analiz yÃ¼kleme hatasÄ±:', error);
        container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--red)">YÃ¼kleme hatasÄ±!</div>';
    }
}

// ArÅŸiv yÃ¼kleme - GeliÅŸmiÅŸ versiyon
async function loadPuantajArsiv() {
    const container = document.getElementById('puantajArsivContainer');
    const summaryContainer = document.getElementById('arsivSummary');
    const trendChart = document.getElementById('arsivTrendChart');
    const pieChart = document.getElementById('arsivPieChart');
    
    if (!container) return;
    
    const sube = document.getElementById('arsivSube')?.value || '';
    const yil = document.getElementById('arsivYil')?.value || new Date().getFullYear();
    
    container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--tx2);grid-column:1/-1">ArÅŸiv yÃ¼kleniyor...</div>';
    
    try {
        let query = db.collection('puantaj');
        if (sube) query = query.where('branch', '==', sube);
        
        const snapshot = await query.get();
        
        // DÃ¶nem bazÄ±nda gruplama
        const donemler = {};
        let toplamKayit = 0;
        let toplamNegatif = 0;
        let toplamPozitif = 0;
        let yildizDagilim = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
        
        snapshot.forEach(doc => {
            const d = doc.data();
            const period = d.period || 'unknown';
            const [pYil] = period.split('-');
            
            // Sadece seÃ§ili yÄ±l
            if (pYil !== String(yil)) return;
            
            if (!donemler[period]) {
                donemler[period] = { kayitSayisi: 0, personeller: {}, negatif: 0, pozitif: 0, kayitlar: [] };
            }
            donemler[period].kayitSayisi++;
            toplamKayit++;
            
            if (!donemler[period].personeller[d.personelId]) {
                donemler[period].personeller[d.personelId] = { toplamPuan: 0, name: d.personelName || 'Bilinmeyen' };
            }
            
            const yildiz = d.score || 3;
            yildizDagilim[yildiz] = (yildizDagilim[yildiz] || 0) + 1;
            
            let puan = 0;
            // Puan sistemi: config'den dinamik
            puan = getPointsFromStar(yildiz);
            if (puan < 0) { toplamNegatif++; donemler[period].negatif++; }
            else if (puan > 0) { toplamPozitif++; donemler[period].pozitif++; }
            
            donemler[period].personeller[d.personelId].toplamPuan += puan;
            donemler[period].kayitlar.push({ ...d, id: doc.id, puan });
        });
        
        // Ã–zet Ä°statistikler
        const primYokToplam = Object.values(donemler).reduce((acc, d) => 
            acc + Object.values(d.personeller).filter(p => p.toplamPuan <= -5).length, 0);
        
        if (summaryContainer) {
            summaryContainer.innerHTML = `
                <div style="background:linear-gradient(135deg,rgba(0,140,149,.1),rgba(0,140,149,.05));border:1px solid rgba(0,140,149,.2);border-radius:12px;padding:16px;text-align:center">
                    <div style="font-size:1.8rem;font-weight:800;color:#008c95">${toplamKayit}</div>
                    <div style="font-size:.75rem;color:var(--tx2)">Toplam KayÄ±t</div>
                </div>
                <div style="background:linear-gradient(135deg,rgba(231,76,60,.1),rgba(231,76,60,.05));border:1px solid rgba(231,76,60,.2);border-radius:12px;padding:16px;text-align:center">
                    <div style="font-size:1.8rem;font-weight:800;color:#e74c3c">${toplamNegatif}</div>
                    <div style="font-size:.75rem;color:var(--tx2)">Negatif</div>
                </div>
                <div style="background:linear-gradient(135deg,rgba(39,174,96,.1),rgba(39,174,96,.05));border:1px solid rgba(39,174,96,.2);border-radius:12px;padding:16px;text-align:center">
                    <div style="font-size:1.8rem;font-weight:800;color:#27ae60">${toplamPozitif}</div>
                    <div style="font-size:.75rem;color:var(--tx2)">Pozitif</div>
                </div>
                <div style="background:linear-gradient(135deg,rgba(243,156,18,.1),rgba(243,156,18,.05));border:1px solid rgba(243,156,18,.2);border-radius:12px;padding:16px;text-align:center">
                    <div style="font-size:1.8rem;font-weight:800;color:#f39c12">${primYokToplam}</div>
                    <div style="font-size:.75rem;color:var(--tx2)">Prim KaybÄ±</div>
                </div>
            `;
        }
        
        // Trend Chart (AylÄ±k bar chart)
        if (trendChart) {
            const aylar = ['01','02','03','04','05','06','07','08','09','10','11','12'];
            const ayAdilar = ['Oca','Åžub','Mar','Nis','May','Haz','Tem','AÄŸu','Eyl','Eki','Kas','Ara'];
            let maxKayit = 1;
            aylar.forEach(ay => {
                const period = `${yil}-${ay}`;
                if (donemler[period]) maxKayit = Math.max(maxKayit, donemler[period].kayitSayisi);
            });
            
            let barHtml = '<svg width="100%" height="180" viewBox="0 0 360 180" preserveAspectRatio="xMidYMid meet">';
            barHtml += '<line x1="30" y1="150" x2="350" y2="150" stroke="var(--cardBorder)" stroke-width="1"/>';
            
            aylar.forEach((ay, i) => {
                const period = `${yil}-${ay}`;
                const kayit = donemler[period]?.kayitSayisi || 0;
                const negatif = donemler[period]?.negatif || 0;
                const pozitif = donemler[period]?.pozitif || 0;
                const height = kayit > 0 ? (kayit / maxKayit) * 120 : 0;
                const x = 35 + i * 27;
                
                // Negatif (kÄ±rmÄ±zÄ±) ve pozitif (yeÅŸil) yÄ±ÄŸÄ±lÄ± bar
                const negHeight = kayit > 0 ? (negatif / kayit) * height : 0;
                const posHeight = height - negHeight;
                
                if (posHeight > 0) {
                    barHtml += `<rect x="${x}" y="${150 - height}" width="20" height="${posHeight}" fill="#27ae60" rx="3" style="cursor:pointer" onclick="showArsivDetail('${period}')"><title>${ayAdilar[i]}: ${kayit} kayÄ±t</title></rect>`;
                }
                if (negHeight > 0) {
                    barHtml += `<rect x="${x}" y="${150 - negHeight}" width="20" height="${negHeight}" fill="#e74c3c" rx="3" style="cursor:pointer" onclick="showArsivDetail('${period}')"><title>${ayAdilar[i]}: ${negatif} negatif</title></rect>`;
                }
                
                // Ay etiketi
                barHtml += `<text x="${x + 10}" y="168" text-anchor="middle" font-size="9" fill="var(--tx3)">${ayAdilar[i]}</text>`;
            });
            
            barHtml += '</svg>';
            trendChart.innerHTML = barHtml;
        }
        
        // Pie Chart (YÄ±ldÄ±z daÄŸÄ±lÄ±mÄ±)
        if (pieChart) {
            const total = Object.values(yildizDagilim).reduce((a, b) => a + b, 0);
            if (total > 0) {
                const colors = ['#c0392b', '#d35400', '#f39c12', '#27ae60', '#2ecc71'];
                const labels = ['Ciddi Ä°hlal', 'Orta Ä°hlal', 'Hafif UyarÄ±', 'Ä°yi Performans', 'MÃ¼kemmel'];
                let startAngle = 0;
                let pieHtml = '<svg width="160" height="160" viewBox="0 0 160 160">';
                
                [1,2,3,4,5].forEach((star, i) => {
                    const value = yildizDagilim[star] || 0;
                    if (value === 0) return;
                    const percentage = value / total;
                    const angle = percentage * 360;
                    const endAngle = startAngle + angle;
                    
                    const startRad = (startAngle - 90) * Math.PI / 180;
                    const endRad = (endAngle - 90) * Math.PI / 180;
                    
                    const x1 = 80 + 60 * Math.cos(startRad);
                    const y1 = 80 + 60 * Math.sin(startRad);
                    const x2 = 80 + 60 * Math.cos(endRad);
                    const y2 = 80 + 60 * Math.sin(endRad);
                    
                    const largeArc = angle > 180 ? 1 : 0;
                    
                    pieHtml += `<path d="M80,80 L${x1},${y1} A60,60 0 ${largeArc},1 ${x2},${y2} Z" fill="${colors[i]}" style="cursor:pointer" onclick="alert('${labels[i]}: ${value} kayÄ±t (${Math.round(percentage*100)}%)')"><title>${labels[i]}: ${value}</title></path>`;
                    
                    startAngle = endAngle;
                });
                
                // Merkez daire (donut efekti)
                pieHtml += '<circle cx="80" cy="80" r="35" fill="var(--cardBg)"/>';
                pieHtml += `<text x="80" y="85" text-anchor="middle" font-size="14" font-weight="700" fill="var(--tx)">${total}</text>`;
                pieHtml += '</svg>';
                
                // Legend
                pieHtml += '<div style="margin-left:20px;font-size:.75rem">';
                [1,2,3,4,5].forEach((star, i) => {
                    const value = yildizDagilim[star] || 0;
                    if (value === 0) return;
                    pieHtml += `<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px"><div style="width:10px;height:10px;background:${colors[i]};border-radius:2px"></div><span style="color:var(--tx2)">${labels[i]}: ${value}</span></div>`;
                });
                pieHtml += '</div>';
                
                pieChart.innerHTML = pieHtml;
                pieChart.style.display = 'flex';
                pieChart.style.alignItems = 'center';
            } else {
                pieChart.innerHTML = '<div style="color:var(--tx3);font-size:.85rem">Veri yok</div>';
            }
        }
        
        // SÄ±rala (yeniden eskiye)
        const sortedDonemler = Object.entries(donemler).sort((a, b) => b[0].localeCompare(a[0]));
        
        let html = '';
        
        if (sortedDonemler.length === 0) {
            html = '<div style="text-align:center;padding:60px;color:var(--tx3);grid-column:1/-1">Bu yÄ±la ait arÅŸivlenmiÅŸ dÃ¶nem yok</div>';
        } else {
            sortedDonemler.forEach(([period, data]) => {
                const [pYil, ay] = period.split('-');
                const ayAdi = getMonthName(ay);
                const personelSayisi = Object.keys(data.personeller).length;
                const primYokSayisi = Object.values(data.personeller).filter(p => p.toplamPuan <= -5).length;
                const avgPuan = personelSayisi > 0 ? 
                    (Object.values(data.personeller).reduce((a, p) => a + p.toplamPuan, 0) / personelSayisi).toFixed(1) : 0;
                
                const isMoonberry = sube.includes('ÅžiÅŸli') || sube.includes('Merkez');
                const brandColor = isMoonberry ? '#008c95' : '#ff8674';
                
                html += `
                    <div onclick="showArsivDetail('${period}')" style="background:var(--cardBg);border:1px solid var(--cardBorder);border-left:4px solid ${brandColor};border-radius:12px;padding:16px;transition:all .2s;cursor:pointer" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(0,0,0,.08)'" onmouseout="this.style.transform='none';this.style.boxShadow='none'">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                            <div>
                                <div style="font-size:1.05rem;font-weight:700;color:var(--tx)">${ayAdi} ${pYil}</div>
                                <div style="font-size:.75rem;color:var(--tx3)">${personelSayisi} personel Â· ${data.kayitSayisi} kayÄ±t</div>
                            </div>
                            <div style="text-align:right">
                                <div style="font-size:1.3rem;font-weight:800;color:${parseFloat(avgPuan) < 0 ? '#e74c3c' : '#27ae60'}">${avgPuan > 0 ? '+' : ''}${avgPuan}</div>
                                <div style="font-size:.65rem;color:var(--tx3)">Ort. Puan</div>
                            </div>
                        </div>
                        <div style="display:flex;gap:8px">
                            <div style="flex:1;background:rgba(39,174,96,.1);border-radius:8px;padding:8px;text-align:center">
                                <div style="font-size:1rem;font-weight:700;color:#27ae60">${data.pozitif}</div>
                                <div style="font-size:.6rem;color:var(--tx3)">Pozitif</div>
                            </div>
                            <div style="flex:1;background:rgba(231,76,60,.1);border-radius:8px;padding:8px;text-align:center">
                                <div style="font-size:1rem;font-weight:700;color:#e74c3c">${data.negatif}</div>
                                <div style="font-size:.6rem;color:var(--tx3)">Negatif</div>
                            </div>
                            <div style="flex:1;background:rgba(243,156,18,.1);border-radius:8px;padding:8px;text-align:center">
                                <div style="font-size:1rem;font-weight:700;color:#f39c12">${primYokSayisi}</div>
                                <div style="font-size:.6rem;color:var(--tx3)">Prim Yok</div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        container.innerHTML = html;
        
        // Cache'e kaydet
        window.arsivDataCache = donemler;
        
    } catch (error) {
        console.error('ArÅŸiv yÃ¼kleme hatasÄ±:', error);
        container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--red);grid-column:1/-1">YÃ¼kleme hatasÄ±!</div>';
    }
}

// ArÅŸiv Detay GÃ¶sterimi
function showArsivDetail(period) {
    const detailPanel = document.getElementById('arsivDetailPanel');
    const donemler = window.arsivDataCache || {};
    const data = donemler[period];
    
    if (!data || !detailPanel) return;
    
    const [yil, ay] = period.split('-');
    const ayAdi = getMonthName(ay);
    
    // Personel listesi (puana gÃ¶re sÄ±rala)
    const personelList = Object.entries(data.personeller)
        .map(([id, p]) => ({ id, ...p }))
        .sort((a, b) => b.toplamPuan - a.toplamPuan);
    
    let html = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
            <div>
                <div style="font-size:1.2rem;font-weight:700;color:var(--tx)">${ayAdi} ${yil} DetayÄ±</div>
                <div style="font-size:.85rem;color:var(--tx2)">${personelList.length} personel Â· ${data.kayitSayisi} kayÄ±t</div>
            </div>
            <button onclick="document.getElementById('arsivDetailPanel').style.display='none'" style="padding:8px 16px;background:var(--bg3);border:none;border-radius:8px;color:var(--tx);cursor:pointer;font-weight:500">Kapat</button>
        </div>
        
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px">
    `;
    
    personelList.forEach(p => {
        const puanColor = p.toplamPuan < 0 ? '#e74c3c' : (p.toplamPuan > 0 ? '#27ae60' : 'var(--tx)');
        const isDanger = p.toplamPuan <= -5;
        
        html += `
            <div style="background:${isDanger ? 'rgba(231,76,60,.05)' : 'var(--bg3)'};border:1px solid ${isDanger ? 'rgba(231,76,60,.2)' : 'var(--cardBorder)'};border-radius:10px;padding:12px">
                <div style="font-weight:600;color:var(--tx);margin-bottom:4px;font-size:.9rem">${p.name || 'Bilinmeyen'}</div>
                <div style="display:flex;align-items:center;justify-content:space-between">
                    <span style="font-size:1.4rem;font-weight:800;color:${puanColor}">${p.toplamPuan > 0 ? '+' : ''}${p.toplamPuan}</span>
                    ${isDanger ? '<span style="font-size:.65rem;background:#e74c3c;color:#fff;padding:2px 6px;border-radius:4px">PRÄ°M YOK</span>' : ''}
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    // Son kayÄ±tlar
    html += `
        <div style="margin-top:20px">
            <div style="font-weight:600;color:var(--tx);margin-bottom:12px">Son KayÄ±tlar</div>
            <div style="max-height:200px;overflow-y:auto">
    `;
    
    const sonKayitlar = data.kayitlar.slice(-10).reverse();
    sonKayitlar.forEach(k => {
        const puanColor = k.puan < 0 ? '#e74c3c' : '#27ae60';
        html += `
            <div style="display:flex;align-items:center;gap:12px;padding:10px;background:var(--bg3);border-radius:8px;margin-bottom:6px">
                <div style="width:36px;height:36px;background:${k.puan < 0 ? 'rgba(231,76,60,.1)' : 'rgba(39,174,96,.1)'};border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:${puanColor}">${k.puan > 0 ? '+' : ''}${k.puan}</div>
                <div style="flex:1">
                    <div style="font-size:.85rem;color:var(--tx);font-weight:500">${k.note || 'AÃ§Ä±klama yok'}</div>
                    <div style="font-size:.7rem;color:var(--tx3)">${k.eventDate || k.createdAt?.toDate?.()?.toLocaleDateString('tr-TR') || '-'}</div>
                </div>
            </div>
        `;
    });
    
    html += '</div></div>';
    
    detailPanel.innerHTML = html;
    detailPanel.style.display = 'block';
    detailPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function getMonthName(ay) {
    const aylar = ['', 'Ocak', 'Åžubat', 'Mart', 'Nisan', 'MayÄ±s', 'Haziran', 'Temmuz', 'AÄŸustos', 'EylÃ¼l', 'Ekim', 'KasÄ±m', 'AralÄ±k'];
    return aylar[parseInt(ay)] || ay;
}

async function deletePuantajEntry(docId) {
    if (!confirm('Bu kaydÄ± silmek istediÄŸinize emin misiniz?')) {
        return;
    }
    
    try {
        await db.collection('puantaj').doc(docId).delete();
        toast('KayÄ±t silindi', 'success');
        loadPuantaj();
    } catch (error) {
        console.error('Silme hatasÄ±:', error);
        toast('Silme hatasÄ±: ' + error.message, 'error');
    }
}

function showPuantajRules() {
    db.collection('puantajRules').get().then(snapshot => {
        let html = '<div style="max-height:400px;overflow-y:auto">';
        snapshot.forEach(doc => {
            const r = doc.data();
            html += `
                <div style="padding:12px;background:var(--surface2);border-radius:var(--radiusSm);margin-bottom:8px">
                    <strong>${r.title}</strong>
                    <span style="float:right;background:${r.effect === 'prim_yok' ? 'var(--red)' : 'var(--yellow)'};color:#fff;padding:2px 8px;border-radius:4px;font-size:.75rem">${r.effect}</span>
                    <p style="font-size:.85rem;color:var(--txdark2);margin-top:4px">${r.desc}</p>
                </div>
            `;
        });
        html += '</div>';
        showModal('â­ Puantaj KurallarÄ±', html, '<button class="btn btn-ghost" onclick="closeModal()">Kapat</button>');
    });
}

// ==================== KULLANICI YÃ–NETÄ°MÄ° ====================
async function loadUserList() {
    const container = document.getElementById('userList');
    if (!container) return;
    
    container.innerHTML = '<p style="color:var(--tx2);text-align:center;padding:20px">YÃ¼kleniyor...</p>';
    
    try {
        // Users collection'Ä±nÄ± al
        const usersSnapshot = await db.collection('users').get();
        
        // Personel listesini al (isim eÅŸleÅŸtirmesi iÃ§in)
        const personnelDoc = await db.collection('config').doc('personnel').get();
        const personnelList = personnelDoc.exists ? (personnelDoc.data().list || []) : [];
        const personnelMap = {};
        personnelList.forEach(p => {
            if (p.email) {
                const username = p.email.split('@')[0];
                personnelMap[username] = p;
            }
        });
        
        // Rol etiketleri
        const roleLabels = {
            'yonetici': 'ðŸ‘‘ YÃ¶netici',
            'bolge_muduru': 'ðŸ¢ BÃ¶lge MÃ¼dÃ¼rÃ¼',
            'magaza_muduru': 'ðŸª MaÄŸaza MÃ¼dÃ¼rÃ¼',
            'magaza_mudur_yardimcisi': 'ðŸª MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±',
            'mudur_yardimcisi': 'ðŸª MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±',
            'barista': 'â˜• Barista'
        };
        
        if (usersSnapshot.empty) {
            container.innerHTML = '<p style="color:var(--tx2);text-align:center;padding:20px">HenÃ¼z kullanÄ±cÄ± yok.</p>';
            return;
        }
        
        let html = '<div style="font-size:.75rem;font-weight:600;color:var(--tx2);margin-bottom:12px;text-transform:uppercase;display:flex;align-items:center;gap:6px"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg> Sisteme GiriÅŸ Yapabilen KullanÄ±cÄ±lar</div>';
        
        usersSnapshot.forEach(doc => {
            const u = doc.data();
            const userId = doc.id;
            
            // Personel listesinden bilgi al (varsa)
            const personnel = personnelMap[userId];
            const displayName = u.name || personnel?.name || userId;
            const displayRole = u.role || personnel?.role || 'barista';
            const displayBranch = u.branch || personnel?.branch || '';
            
            const roleLabel = roleLabels[displayRole] || `ðŸ“‹ ${displayRole}`;
            const branchText = displayBranch && displayBranch !== 'all' ? displayBranch : 'TÃ¼m Åžubeler';
            const isAdmin = userId === 'admin';
            
            html += `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg3);border-radius:var(--radiusSm);margin-bottom:8px;border-left:3px solid ${isAdmin ? '#9b59b6' : '#27ae60'}">
                    <div>
                        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                            <strong style="color:var(--tx)">${displayName}</strong>
                            <span style="font-size:.75rem;background:var(--accentLight);color:var(--accent);padding:2px 8px;border-radius:4px">${roleLabel}</span>
                            ${personnel ? '' : '<span style="font-size:.65rem;background:rgba(243,156,18,.15);color:#f39c12;padding:2px 6px;border-radius:4px">Personel listesinde yok</span>'}
                        </div>
                        <div style="font-size:.8rem;color:var(--tx2)">@${userId} â€¢ ${branchText}</div>
                    </div>
                    <div style="display:flex;gap:8px">
                        ${!isAdmin ? `
                            <button class="btn btn-sm btn-ghost" onclick="editUserDirect('${userId}')" title="DÃ¼zenle">âœï¸</button>
                            <button class="btn btn-sm" style="background:var(--red);color:#fff" onclick="removeUserLogin('${userId}')" title="Sil">ðŸ—‘ï¸</button>
                        ` : '<span style="font-size:.75rem;color:var(--tx3)">Sistem</span>'}
                    </div>
                </div>
            `;
        });
        
        // Personel listesinde olup users'da olmayan kiÅŸiler
        let pendingHtml = '';
        let hasPending = false;
        
        for (const p of personnelList) {
            const username = p.email ? p.email.split('@')[0] : null;
            if (!username) continue;
            
            let found = false;
            usersSnapshot.forEach(doc => {
                if (doc.id === username) found = true;
            });
            
            if (!found) {
                hasPending = true;
                const roleLabel = roleLabels[p.role] || `ðŸ“‹ ${p.role || 'Bilinmiyor'}`;
                const branchText = p.branch && p.branch !== 'all' ? p.branch : 'TÃ¼m Åžubeler';
                
                pendingHtml += `
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg3);border-radius:var(--radiusSm);margin-bottom:8px;opacity:.7">
                        <div>
                            <div style="display:flex;align-items:center;gap:8px">
                                <strong style="color:var(--tx)">${p.name}</strong>
                                <span style="font-size:.75rem;background:var(--accentLight);color:var(--accent);padding:2px 8px;border-radius:4px">${roleLabel}</span>
                            </div>
                            <div style="font-size:.8rem;color:var(--tx2)">${p.email} â€¢ ${branchText}</div>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-primary" onclick="showLoginModal('${username}', '${p.name}', '${p.email}', '${p.role}', '${p.branch}')" title="Login TanÄ±mla">ðŸ”‘ Login Ekle</button>
                        </div>
                    </div>
                `;
            }
        }
        
        if (hasPending) {
            html += '<div style="font-size:.75rem;font-weight:600;color:var(--tx2);margin:20px 0 12px;text-transform:uppercase">ðŸ”’ GiriÅŸ TanÄ±mlÄ± DeÄŸil (Personel Listesinden)</div>';
            html += pendingHtml;
        }
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('KullanÄ±cÄ± yÃ¼kleme hatasÄ±:', error);
        container.innerHTML = '<p style="color:var(--red);text-align:center;padding:20px">YÃ¼kleme hatasÄ±!</p>';
    }
}

// KullanÄ±cÄ± dÃ¼zenleme (direkt users collection)
async function editUserDirect(userId) {
    try {
        const doc = await db.collection('users').doc(userId).get();
        if (!doc.exists) {
            toast('KullanÄ±cÄ± bulunamadÄ±', 'error');
            return;
        }
        
        const u = doc.data();
        showLoginModal(userId, u.name || userId, userId + '@moonberrycoffee.com', u.role || 'barista', u.branch || '');
    } catch (e) {
        console.error('KullanÄ±cÄ± yÃ¼kleme hatasÄ±:', e);
        toast('YÃ¼kleme hatasÄ±', 'error');
    }
}

// Login tanÄ±mlama modal'Ä±
function showLoginModal(username, name, email, role, branch) {
    const isEdit = username && username !== 'null' && username !== '';
    const title = isEdit ? 'ðŸ”‘ Login DÃ¼zenle' : 'ðŸ”‘ Login TanÄ±mla';
    
    const body = `
        <div style="padding:8px 0">
            <div style="background:var(--bg3);border-radius:12px;padding:16px;margin-bottom:20px">
                <div style="font-weight:600;color:var(--tx);margin-bottom:4px">${name}</div>
                <div style="font-size:.85rem;color:var(--tx2)">${email || 'E-posta tanÄ±mlÄ± deÄŸil'}</div>
            </div>
            
            <input type="hidden" id="loginPersonelName" value="${name}">
            <input type="hidden" id="loginPersonelRole" value="${role}">
            <input type="hidden" id="loginPersonelBranch" value="${branch}">
            
            <div class="form-group">
                <label class="form-label">KullanÄ±cÄ± AdÄ± (E-posta'nÄ±n @ Ã¶ncesi)</label>
                <input type="text" id="loginUsername" class="form-input" value="${username || ''}" ${isEdit ? 'readonly style="background:var(--bg3)"' : ''} placeholder="ornek">
                <div style="font-size:.75rem;color:var(--tx3);margin-top:4px">GiriÅŸ yaparken kullanÄ±lacak: kullanici@moonberrycoffee.com</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Åžifre ${isEdit ? '(boÅŸ bÄ±rakÄ±lÄ±rsa deÄŸiÅŸmez)' : ''}</label>
                <input type="password" id="loginPassword" class="form-input" minlength="6" placeholder="En az 6 karakter">
            </div>
        </div>
    `;
    
    const footer = `
        <button class="btn btn-ghost" onclick="closeModal()">Ä°ptal</button>
        <button class="btn btn-primary" onclick="saveUserLogin(${isEdit})">ðŸ’¾ Kaydet</button>
    `;
    
    showModal(title, body, footer);
}

// Login kaydet
async function saveUserLogin(isEdit) {
    const username = document.getElementById('loginUsername')?.value?.trim();
    const password = document.getElementById('loginPassword')?.value;
    const name = document.getElementById('loginPersonelName')?.value;
    const role = document.getElementById('loginPersonelRole')?.value;
    const branch = document.getElementById('loginPersonelBranch')?.value;
    
    if (!username) {
        toast('KullanÄ±cÄ± adÄ± gerekli', 'error');
        return;
    }
    
    if (!isEdit && !password) {
        toast('Åžifre gerekli', 'error');
        return;
    }
    
    if (password && password.length < 6) {
        toast('Åžifre en az 6 karakter olmalÄ±', 'error');
        return;
    }
    
    try {
        const userData = {
            name: name,
            role: role || 'barista',
            branch: branch || STATE.branches?.[0] || 'Tuzla TRC',
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (password) {
            userData.password = password; // GerÃ§ek uygulamada hash'lenmeli
        }
        
        if (!isEdit) {
            userData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
        }
        
        await db.collection('users').doc(username).set(userData, { merge: true });
        
        toast(isEdit ? 'Login gÃ¼ncellendi' : 'Login oluÅŸturuldu', 'success');
        closeModal();
        loadUserList();
        
    } catch (error) {
        console.error('KayÄ±t hatasÄ±:', error);
        toast('KayÄ±t hatasÄ±!', 'error');
    }
}

// Login'i kaldÄ±r
async function removeUserLogin(username) {
    if (!confirm('Bu kullanÄ±cÄ±nÄ±n giriÅŸ yetkisi kaldÄ±rÄ±lacak. Devam etmek istiyor musunuz?')) {
        return;
    }
    
    try {
        await db.collection('users').doc(username).delete();
        toast('Login kaldÄ±rÄ±ldÄ±', 'success');
        loadUserList();
    } catch (error) {
        console.error('Silme hatasÄ±:', error);
        toast('Silme hatasÄ±!', 'error');
    }
}

// Yeni kullanÄ±cÄ± ekleme modal'Ä±
function showNewUserModal() {
    const roleOptions = `
        <option value="barista">â˜• Barista</option>
        <option value="magaza_mudur_yardimcisi">ðŸª MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±</option>
        <option value="magaza_muduru">ðŸª MaÄŸaza MÃ¼dÃ¼rÃ¼</option>
        <option value="bolge_muduru">ðŸ¢ BÃ¶lge MÃ¼dÃ¼rÃ¼</option>
        <option value="yonetici">ðŸ‘‘ YÃ¶netici</option>
    `;
    
    const branchOptions = (STATE.branches || [])
        .map(b => `<option value="${b}">${b}</option>`).join('');
    
    const body = `
        <div style="padding:8px 0">
            <div class="form-group">
                <label class="form-label">KullanÄ±cÄ± AdÄ± *</label>
                <input type="text" id="newUserUsername" class="form-input" placeholder="ornek">
                <div style="font-size:.75rem;color:var(--tx3);margin-top:4px">GiriÅŸ: kullanici@moonberrycoffee.com</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">GÃ¶rÃ¼nen Ad *</label>
                <input type="text" id="newUserName" class="form-input" placeholder="Ad Soyad">
            </div>
            
            <div class="form-group">
                <label class="form-label">Åžifre *</label>
                <input type="password" id="newUserPassword" class="form-input" placeholder="En az 6 karakter" minlength="6">
            </div>
            
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                <div class="form-group">
                    <label class="form-label">Rol</label>
                    <select id="newUserRole" class="form-select">${roleOptions}</select>
                </div>
                <div class="form-group">
                    <label class="form-label">Åžube</label>
                    <select id="newUserBranch" class="form-select">
                        <option value="all">TÃ¼m Åžubeler</option>
                        ${branchOptions}
                    </select>
                </div>
            </div>
        </div>
    `;
    
    const footer = `
        <button class="btn btn-ghost" onclick="closeModal()">Ä°ptal</button>
        <button class="btn btn-primary" onclick="createNewUser()">ðŸ’¾ OluÅŸtur</button>
    `;
    
    showModal('âž• Yeni KullanÄ±cÄ±', body, footer);
}

// Yeni kullanÄ±cÄ± oluÅŸtur
async function createNewUser() {
    const username = document.getElementById('newUserUsername')?.value?.trim().toLowerCase();
    const name = document.getElementById('newUserName')?.value?.trim();
    const password = document.getElementById('newUserPassword')?.value;
    const role = document.getElementById('newUserRole')?.value || 'barista';
    const branch = document.getElementById('newUserBranch')?.value || STATE.branches?.[0] || 'Tuzla TRC';
    
    if (!username) { toast('KullanÄ±cÄ± adÄ± gerekli', 'error'); return; }
    if (!name) { toast('GÃ¶rÃ¼nen ad gerekli', 'error'); return; }
    if (!password || password.length < 6) { toast('Åžifre en az 6 karakter olmalÄ±', 'error'); return; }
    
    // GeÃ§ersiz karakterler kontrolÃ¼
    if (!/^[a-z0-9._]+$/.test(username)) {
        toast('KullanÄ±cÄ± adÄ± sadece kÃ¼Ã§Ã¼k harf, rakam, nokta ve alt Ã§izgi iÃ§erebilir', 'error');
        return;
    }
    
    try {
        // KullanÄ±cÄ± zaten var mÄ± kontrol et
        const existingDoc = await db.collection('users').doc(username).get();
        if (existingDoc.exists) {
            toast('Bu kullanÄ±cÄ± adÄ± zaten mevcut', 'error');
            return;
        }
        
        await db.collection('users').doc(username).set({
            name: name,
            role: role,
            branch: branch,
            password: password, // GerÃ§ek uygulamada hash'lenmeli
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdBy: currentUser?.id || 'admin'
        });
        
        toast('KullanÄ±cÄ± oluÅŸturuldu', 'success');
        closeModal();
        loadUserList();
        
    } catch (error) {
        console.error('KullanÄ±cÄ± oluÅŸturma hatasÄ±:', error);
        toast('OluÅŸturma hatasÄ±!', 'error');
    }
}

// Personel listesindeki rolleri users collection'Ä±na senkronize et
async function syncRolesFromPersonnel() {
    if (!confirm('Personel listesindeki roller, mevcut kullanÄ±cÄ±lara uygulanacak. Devam etmek istiyor musunuz?')) {
        return;
    }
    
    try {
        toast('Roller senkronize ediliyor...', 'info');
        
        // Personel listesini al
        const personnelDoc = await db.collection('config').doc('personnel').get();
        if (!personnelDoc.exists) {
            toast('Personel listesi bulunamadÄ±', 'error');
            return;
        }
        
        const personnelList = personnelDoc.data().list || [];
        
        // Email'e gÃ¶re rol eÅŸleÅŸtirmesi oluÅŸtur
        const roleMap = {};
        personnelList.forEach(p => {
            if (p.email && p.role) {
                // Email'in @ Ã¶ncesini kullanÄ±cÄ± adÄ± olarak kullan
                const username = p.email.split('@')[0];
                roleMap[username] = { role: p.role, branch: p.branch, name: p.name };
            }
        });
        
        // Users collection'Ä±nÄ± gÃ¼ncelle
        const usersSnapshot = await db.collection('users').get();
        let updated = 0;
        
        for (const doc of usersSnapshot.docs) {
            const userId = doc.id;
            const userData = doc.data();
            
            // Email veya kullanÄ±cÄ± adÄ± ile eÅŸleÅŸtir
            let match = roleMap[userId];
            
            // EÄŸer direkt eÅŸleÅŸme yoksa, email'den dene
            if (!match && userData.email) {
                const emailUsername = userData.email.split('@')[0];
                match = roleMap[emailUsername];
            }
            
            if (match && match.role) {
                // Sadece rol farklÄ±ysa gÃ¼ncelle
                if (userData.role !== match.role) {
                    await db.collection('users').doc(userId).update({
                        role: match.role,
                        branch: match.branch || userData.branch
                    });
                    updated++;
                    console.log(`${userId}: ${userData.role} â†’ ${match.role}`);
                }
            }
        }
        
        toast(`${updated} kullanÄ±cÄ± gÃ¼ncellendi`, 'success');
        loadUserList();
        
    } catch (error) {
        console.error('Senkronizasyon hatasÄ±:', error);
        toast('Senkronizasyon hatasÄ±!', 'error');
    }
}

function showAddUserModal(editId = null) {
    const isEdit = !!editId;
    const title = isEdit ? 'KullanÄ±cÄ± DÃ¼zenle' : 'Yeni KullanÄ±cÄ±';
    
    const body = `
        <input type="hidden" id="userEditId" value="${editId || ''}">
        <div class="form-grid">
            <div class="form-group"><label class="form-label">KullanÄ±cÄ± AdÄ± *</label><input type="text" id="modalUserName" class="form-input" ${isEdit ? 'readonly' : ''} placeholder="ornek.kullanici"></div>
            <div class="form-group"><label class="form-label">GÃ¶rÃ¼nen Ad</label><input type="text" id="modalUserDisplayName" class="form-input" placeholder="Ahmet YÄ±lmaz"></div>
            <div class="form-group"><label class="form-label">Åžifre ${isEdit ? '(boÅŸ bÄ±rakÄ±lÄ±rsa deÄŸiÅŸmez)' : '*'}</label><input type="password" id="modalUserPassword" class="form-input" minlength="6"></div>
            <div class="form-group">
                <label class="form-label">Rol *</label>
                <select id="modalUserRoleSelect" class="form-select">
                    <option value="barista">â˜• Barista</option>
                    <option value="magaza_mudur_yardimcisi">ðŸª MaÄŸaza MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±</option>
                    <option value="magaza_muduru">ðŸª MaÄŸaza MÃ¼dÃ¼rÃ¼</option>
                    <option value="bolge_muduru">ðŸ¢ BÃ¶lge MÃ¼dÃ¼rÃ¼</option>
                    <option value="yonetici">ðŸ‘‘ YÃ¶netici</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Åžube EriÅŸimi</label>
                <select id="modalUserBranch" class="form-select">
                    <option value="all">TÃ¼m Åžubeler</option>
                    ${STATE.branches.map(b => `<option value="${b}">${b}</option>`).join('')}
                </select>
            </div>
        </div>
    `;
    
    const footer = `
        <button class="btn btn-ghost" onclick="closeModal()">Ä°ptal</button>
        <button class="btn btn-primary" onclick="saveUser()">ðŸ’¾ Kaydet</button>
    `;
    
    showModal(title, body, footer);
    
    if (isEdit) {
        loadUserForEdit(editId);
    }
}

async function loadUserForEdit(id) {
    try {
        const doc = await db.collection('users').doc(id).get();
        if (doc.exists) {
            const u = doc.data();
            document.getElementById('modalUserName').value = id;
            document.getElementById('modalUserDisplayName').value = u.name || '';
            
            // Rol select'ini ayarla - Ã¶nce select elementini al
            const roleSelect = document.getElementById('modalUserRoleSelect');
            if (roleSelect && u.role) {
                // EÄŸer rol seÃ§eneklerde yoksa, option olarak ekle
                const existingOption = roleSelect.querySelector(`option[value="${u.role}"]`);
                if (!existingOption) {
                    const newOption = document.createElement('option');
                    newOption.value = u.role;
                    newOption.textContent = getRoleName(u.role);
                    roleSelect.appendChild(newOption);
                }
                roleSelect.value = u.role;
            }
            
            document.getElementById('modalUserBranch').value = u.branch || 'all';
        }
    } catch (error) {
        console.error('KullanÄ±cÄ± yÃ¼kleme hatasÄ±:', error);
    }
}

async function saveUser() {
    const editId = document.getElementById('userEditId').value;
    const username = document.getElementById('modalUserName').value.trim().toLowerCase();
    const password = document.getElementById('modalUserPassword').value;
    const displayName = document.getElementById('modalUserDisplayName').value.trim();
    const role = document.getElementById('modalUserRoleSelect').value;
    const branch = document.getElementById('modalUserBranch').value;
    
    if (!username) {
        toast('KullanÄ±cÄ± adÄ± zorunludur', 'error');
        return;
    }
    
    if (!editId && !password) {
        toast('Åžifre zorunludur', 'error');
        return;
    }
    
    if (password && password.length < 6) {
        toast('Åžifre en az 6 karakter olmalÄ±', 'error');
        return;
    }
    
    const data = {
        name: displayName || username,
        role,
        branch,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    if (password) {
        data.password = password;
    }
    
    try {
        if (editId) {
            await db.collection('users').doc(editId).update(data);
            toast('KullanÄ±cÄ± gÃ¼ncellendi', 'success');
        } else {
            // KullanÄ±cÄ± adÄ± zaten var mÄ± kontrol et
            const existing = await db.collection('users').doc(username).get();
            if (existing.exists) {
                toast('Bu kullanÄ±cÄ± adÄ± zaten kullanÄ±lÄ±yor', 'error');
                return;
            }
            data.username = username;
            data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            await db.collection('users').doc(username).set(data);
            toast('KullanÄ±cÄ± oluÅŸturuldu', 'success');
        }
        closeModal();
        loadUserList();
    } catch (error) {
        console.error('KayÄ±t hatasÄ±:', error);
        toast('KayÄ±t hatasÄ±!', 'error');
    }
}

function editUser(id) {
    showAddUserModal(id);
}

async function deleteUser(id) {
    if (id === 'admin') {
        toast('Admin hesabÄ± silinemez', 'error');
        return;
    }
    
    confirmModal('KullanÄ±cÄ± Sil', 'Bu kullanÄ±cÄ±yÄ± silmek istediÄŸinize emin misiniz?', async () => {
        try {
            await db.collection('users').doc(id).delete();
            toast('KullanÄ±cÄ± silindi', 'success');
            loadUserList();
        } catch (error) {
            console.error('Silme hatasÄ±:', error);
            toast('Silme hatasÄ±!', 'error');
        }
    });
}

// ==================== GELÄ°ÅžMÄ°Åž Ä°ZÄ°N YÃ–NETÄ°MÄ° ====================
const PERMISSION_STRUCTURE = {
    pages: [
        { id: 'dashboard', label: 'Dashboard' },
        { id: 'personel', label: 'Personel' },
        { id: 'puantaj', label: 'Performans' },
        { id: 'primSistemi', label: 'Prim Sistemi' },
        { id: 'shift', label: 'Shift PlanÄ±' },
        { id: 'checklist', label: 'Checklist' },
        { id: 'katalog', label: 'Ä°hlal KataloÄŸu' }
    ],
    documents: [
        { id: 'sozlesme', label: 'Ä°ÅŸ SÃ¶zleÅŸmesi' },
        { id: 'tutanak', label: 'Tutanak' },
        { id: 'savunma', label: 'Savunma Ä°steme' },
        { id: 'fesih', label: 'Fesih' },
        { id: 'istifa', label: 'Ä°stifa' },
        { id: 'ibraname', label: 'Ä°braname' }
    ],
    forms: [
        { id: 'borc', label: 'BorÃ§ Ä°krar' },
        { id: 'avans', label: 'Avans Talebi' },
        { id: 'zimmet', label: 'Zimmet Formu' }
    ],
    admin: [
        { id: 'admin_genel', label: 'Genel Ayarlar' },
        { id: 'admin_kullanicilar', label: 'Pozisyon Yetkileri' },
        { id: 'admin_puantaj', label: 'Puantaj KurallarÄ±' },
        { id: 'admin_subeler', label: 'Åžube YÃ¶netimi' },
        { id: 'admin_pozisyonlar', label: 'Pozisyonlar' },
        { id: 'admin_ihlaller', label: 'Ä°hlal DÃ¼zenleme' },
        { id: 'admin_sablonlar', label: 'Åžablonlar' },
        { id: 'admin_oturumlar', label: 'Oturum AyarlarÄ±' },
        { id: 'admin_yedekler', label: 'Yedekler' }
    ],
    special: [
        { id: 'print_shift', label: 'Shift planÄ±nÄ± yazdÄ±rabilir' },
        { id: 'create_shift_week', label: 'Yeni shift haftasÄ± oluÅŸturabilir' },
        { id: 'view_checklist_history', label: 'GeÃ§miÅŸ checklisti gÃ¶rebilir' },
        { id: 'fill_others_checklist', label: 'BaÅŸkasÄ±nÄ±n checklistini doldurabilir' },
        { id: 'view_salary', label: 'MaaÅŸ bilgilerini gÃ¶rebilir' },
        { id: 'export_data', label: 'Veri dÄ±ÅŸa aktarabilir' },
        { id: 'delete_records', label: 'KayÄ±t silebilir' },
        { id: 'assign_password', label: 'Åžifre atayabilir' },
        { id: 'view_password', label: 'Personel ÅŸifrelerini gÃ¶rebilir' },
        { id: 'change_others_password', label: 'BaÅŸkasÄ±nÄ±n ÅŸifresini deÄŸiÅŸtirebilir' },
        { id: 'add_announcement', label: 'Duyuru ekleyebilir' },
        { id: 'manage_branches', label: 'Åžube ekleyebilir/silebilir' },
        { id: 'run_autopuan', label: 'Otomatik puanlama Ã§alÄ±ÅŸtÄ±rabilir' }
    ],
    limits: [
        { id: 'shift_history_weeks', label: 'Shift geÃ§miÅŸ limiti (hafta)', type: 'number', options: [1, 2, 3, 4, 5, 12, 999] }
    ]
};

const DEFAULT_ROLE_PERMISSIONS = {
    barista: {
        pages: { dashboard: { view: true, edit: false }, personel: { view: false, edit: false }, puantaj: { view: true, edit: false }, primSistemi: { view: true, edit: false }, shift: { view: true, edit: false }, checklist: { view: true, edit: true }, katalog: { view: false, edit: false } },
        documents: { sozlesme: { view: false, edit: false }, tutanak: { view: false, edit: false }, savunma: { view: false, edit: false }, fesih: { view: false, edit: false }, istifa: { view: false, edit: false }, ibraname: { view: false, edit: false } },
        forms: { borc: { view: false, edit: false }, avans: { view: false, edit: false }, zimmet: { view: false, edit: false } },
        admin: { admin_genel: false, admin_kullanicilar: false, admin_puantaj: false, admin_subeler: false, admin_pozisyonlar: false, admin_ihlaller: false, admin_sablonlar: false, admin_oturumlar: false, admin_yedekler: false },
        special: { print_shift: true, create_shift_week: false, view_checklist_history: false, fill_others_checklist: false, view_salary: false, export_data: false, delete_records: false, assign_password: false, view_password: false, change_others_password: false, add_announcement: false, manage_branches: false, run_autopuan: true },
        limits: { shift_history_weeks: 1 }
    },
    magaza_mudur_yardimcisi: {
        pages: { dashboard: { view: true, edit: true }, personel: { view: true, edit: true }, puantaj: { view: true, edit: true }, primSistemi: { view: true, edit: false }, shift: { view: true, edit: true }, checklist: { view: true, edit: true }, katalog: { view: true, edit: true } },
        documents: { sozlesme: { view: true, edit: true }, tutanak: { view: true, edit: true }, savunma: { view: true, edit: true }, fesih: { view: true, edit: false }, istifa: { view: true, edit: true }, ibraname: { view: true, edit: true } },
        forms: { borc: { view: true, edit: true }, avans: { view: true, edit: true }, zimmet: { view: true, edit: true } },
        admin: { admin_genel: false, admin_kullanicilar: false, admin_puantaj: false, admin_subeler: false, admin_pozisyonlar: false, admin_ihlaller: true, admin_sablonlar: false, admin_oturumlar: false, admin_yedekler: false },
        special: { print_shift: true, create_shift_week: true, view_checklist_history: true, fill_others_checklist: true, view_salary: false, export_data: true, delete_records: false, assign_password: false, view_password: false, change_others_password: false, add_announcement: false, manage_branches: false, run_autopuan: true },
        limits: { shift_history_weeks: 5 }
    },
    magaza_muduru: {
        pages: { dashboard: { view: true, edit: true }, personel: { view: true, edit: true }, puantaj: { view: true, edit: true }, primSistemi: { view: true, edit: false }, shift: { view: true, edit: true }, checklist: { view: true, edit: true }, katalog: { view: true, edit: true } },
        documents: { sozlesme: { view: true, edit: true }, tutanak: { view: true, edit: true }, savunma: { view: true, edit: true }, fesih: { view: true, edit: false }, istifa: { view: true, edit: true }, ibraname: { view: true, edit: true } },
        forms: { borc: { view: true, edit: true }, avans: { view: true, edit: true }, zimmet: { view: true, edit: true } },
        admin: { admin_genel: false, admin_kullanicilar: false, admin_puantaj: false, admin_subeler: false, admin_pozisyonlar: false, admin_ihlaller: true, admin_sablonlar: false, admin_oturumlar: false, admin_yedekler: false },
        special: { print_shift: true, create_shift_week: true, view_checklist_history: true, fill_others_checklist: true, view_salary: false, export_data: true, delete_records: false, assign_password: false, view_password: false, change_others_password: false, add_announcement: false, manage_branches: false, run_autopuan: true },
        limits: { shift_history_weeks: 5 }
    },
    bolge_muduru: {
        pages: { dashboard: { view: true, edit: true }, personel: { view: true, edit: true }, puantaj: { view: true, edit: true }, primSistemi: { view: true, edit: true }, shift: { view: true, edit: true }, checklist: { view: true, edit: true }, katalog: { view: true, edit: true } },
        documents: { sozlesme: { view: true, edit: true }, tutanak: { view: true, edit: true }, savunma: { view: true, edit: true }, fesih: { view: true, edit: true }, istifa: { view: true, edit: true }, ibraname: { view: true, edit: true } },
        forms: { borc: { view: true, edit: true }, avans: { view: true, edit: true }, zimmet: { view: true, edit: true } },
        admin: { admin_genel: true, admin_kullanicilar: false, admin_puantaj: true, admin_subeler: true, admin_pozisyonlar: true, admin_ihlaller: true, admin_sablonlar: true, admin_oturumlar: true, admin_yedekler: false },
        special: { print_shift: true, create_shift_week: true, view_checklist_history: true, fill_others_checklist: true, view_salary: true, export_data: true, delete_records: true, assign_password: true, view_password: true, change_others_password: true, add_announcement: true, manage_branches: false, run_autopuan: true },
        limits: { shift_history_weeks: 999 }
    },
    yonetici: {
        pages: { dashboard: { view: true, edit: true }, personel: { view: true, edit: true }, puantaj: { view: true, edit: true }, shift: { view: true, edit: true }, checklist: { view: true, edit: true }, katalog: { view: true, edit: true } },
        documents: { sozlesme: { view: true, edit: true }, tutanak: { view: true, edit: true }, savunma: { view: true, edit: true }, fesih: { view: true, edit: true }, istifa: { view: true, edit: true }, ibraname: { view: true, edit: true } },
        forms: { borc: { view: true, edit: true }, avans: { view: true, edit: true }, zimmet: { view: true, edit: true } },
        admin: { admin_genel: true, admin_kullanicilar: true, admin_puantaj: true, admin_subeler: true, admin_pozisyonlar: true, admin_ihlaller: true, admin_sablonlar: true, admin_oturumlar: true, admin_yedekler: true },
        special: { print_shift: true, create_shift_week: true, view_checklist_history: true, fill_others_checklist: true, view_salary: true, export_data: true, delete_records: true, assign_password: true, view_password: true, change_others_password: true, add_announcement: true, manage_branches: true, run_autopuan: true },
        limits: { shift_history_weeks: 999 }
    }
};

// ==================== PERMISSION MATRIX FONKSIYONLARI ====================

// Matrix iÃ§in cache (deÄŸiÅŸiklikleri takip etmek iÃ§in)
let matrixPermissionsCache = {};
let matrixHasUnsavedChanges = false;

// Sayfa kapatma uyarÄ±sÄ±
window.addEventListener('beforeunload', function(e) {
    if (matrixHasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = 'KaydedilmemiÅŸ deÄŸiÅŸiklikler var. Ã‡Ä±kmak istediÄŸinize emin misiniz?';
        return e.returnValue;
    }
});

// Unsaved changes modal gÃ¶ster
function showUnsavedChangesModal(callback) {
    const modalHtml = `
        <div id="unsavedChangesModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:10000">
            <div style="background:var(--bg2);border-radius:16px;padding:24px;max-width:400px;width:90%;box-shadow:var(--shadow)">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
                    <div style="width:48px;height:48px;background:rgba(255,134,116,.15);border-radius:12px;display:flex;align-items:center;justify-content:center">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ff8674" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                    </div>
                    <div>
                        <div style="font-weight:600;color:var(--tx);font-size:1.1rem">KaydedilmemiÅŸ DeÄŸiÅŸiklikler</div>
                        <div style="font-size:.85rem;color:var(--tx2)">DeÄŸiÅŸiklikleriniz kaybolacak</div>
                    </div>
                </div>
                <p style="color:var(--tx2);font-size:.9rem;margin-bottom:20px">Sayfadan ayrÄ±lmadan Ã¶nce deÄŸiÅŸiklikleri kaydetmek ister misiniz?</p>
                <div style="display:flex;gap:12px;justify-content:flex-end">
                    <button onclick="document.getElementById('unsavedChangesModal').remove()" class="btn btn-ghost">Ä°ptal</button>
                    <button onclick="discardMatrixChanges()" class="btn" style="background:var(--red);color:white">Kaydetme</button>
                    <button onclick="saveAndContinue()" class="btn btn-primary">Kaydet</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    window._unsavedChangesCallback = callback;
}

// DeÄŸiÅŸiklikleri kaydetmeden devam
function discardMatrixChanges() {
    matrixHasUnsavedChanges = false;
    document.getElementById('unsavedChangesModal')?.remove();
    if (window._unsavedChangesCallback) {
        window._unsavedChangesCallback();
        window._unsavedChangesCallback = null;
    }
}

// Kaydet ve devam
async function saveAndContinue() {
    await saveMatrixPermissions();
    document.getElementById('unsavedChangesModal')?.remove();
    if (window._unsavedChangesCallback) {
        window._unsavedChangesCallback();
        window._unsavedChangesCallback = null;
    }
}

// Kategori baÅŸlÄ±klarÄ± ve ikonlarÄ±
const PERMISSION_CATEGORIES = {
    pages: { label: 'ðŸ“„ Sayfalar', hasDual: true },
    documents: { label: 'ðŸ“ Belgeler', hasDual: true },
    forms: { label: 'ðŸ“‹ Formlar', hasDual: true },
    admin: { label: 'âš™ï¸ YÃ¶netim Sekmeleri', hasDual: false },
    special: { label: 'ðŸ”’ Ã–zel Yetkiler', hasDual: false },
    limits: { label: 'ðŸ“Š Limitler', hasDual: false, isLimit: true }
};

// Permission Matrix'i render et
async function renderPermissionMatrix() {
    const table = document.getElementById('permissionMatrix');
    if (!table) return;
    
    // PozisyonlarÄ± al (yÃ¶netici ve ik_mudur hariÃ§)
    const positions = (STATE.positions || []).filter(p => p.role !== 'yonetici' && p.id !== 'ik_mudur');
    
    if (positions.length === 0) {
        table.innerHTML = '<tr><td style="padding:40px;text-align:center;color:var(--tx2)">HenÃ¼z pozisyon tanÄ±mlanmamÄ±ÅŸ</td></tr>';
        return;
    }
    
    // Her pozisyon iÃ§in izinleri yÃ¼kle
    matrixPermissionsCache = {};
    for (const pos of positions) {
        matrixPermissionsCache[pos.id] = await getPositionPermissions(pos.id, pos.role);
    }
    
    let html = '';
    
    // === HEADER ROW 1: Pozisyon isimleri ===
    html += '<thead><tr>';
    html += '<th class="perm-item-name" rowspan="2" style="text-align:left;min-width:200px">Yetki</th>';
    
    positions.forEach(pos => {
        // Sayfalar, Belgeler, Formlar iÃ§in G/D Ã§ift sÃ¼tun
        const dualCategories = Object.keys(PERMISSION_CATEGORIES).filter(k => PERMISSION_CATEGORIES[k].hasDual);
        const singleCategories = Object.keys(PERMISSION_CATEGORIES).filter(k => !PERMISSION_CATEGORIES[k].hasDual);
        
        // Her pozisyon iÃ§in colspan hesapla
        html += `<th colspan="2" class="role-header" style="background:var(--accentLight);color:var(--tx)">${getPositionIconHtml(pos.icon, 18)} ${pos.name}</th>`;
    });
    html += '</tr>';
    
    // === HEADER ROW 2: G/D baÅŸlÄ±klarÄ± ===
    html += '<tr>';
    positions.forEach(() => {
        html += '<th class="sub-header" style="width:40px">G</th>';
        html += '<th class="sub-header" style="width:40px">D</th>';
    });
    html += '</tr></thead>';
    
    // === BODY ===
    html += '<tbody>';
    
    // Her kategori iÃ§in
    for (const [catKey, catInfo] of Object.entries(PERMISSION_CATEGORIES)) {
        const items = PERMISSION_STRUCTURE[catKey] || [];
        if (items.length === 0) continue;
        
        // Kategori baÅŸlÄ±k satÄ±rÄ±
        html += `<tr class="perm-category-row"><td class="perm-category" colspan="${1 + positions.length * 2}">${catInfo.label}</td></tr>`;
        
        // Her madde iÃ§in satÄ±r
        items.forEach(item => {
            html += '<tr>';
            html += `<td class="perm-item perm-item-name">${item.label}</td>`;
            
            positions.forEach(pos => {
                const perms = matrixPermissionsCache[pos.id] || {};
                
                if (catInfo.isLimit) {
                    // Limit - Select dropdown
                    const limitValue = perms.limits?.[item.id] || item.options?.[0] || 1;
                    html += `<td colspan="2">`;
                    html += `<select data-pos="${pos.id}" data-cat="limits" data-id="${item.id}" onchange="handleMatrixChange(this)">`;
                    (item.options || [1, 5, 52, 999]).forEach(opt => {
                        const selected = limitValue == opt ? 'selected' : '';
                        const label = opt === 999 ? 'SÄ±nÄ±rsÄ±z' : opt;
                        html += `<option value="${opt}" ${selected}>${label}</option>`;
                    });
                    html += '</select></td>';
                } else if (catInfo.hasDual) {
                    // View/Edit Ã§ift checkbox
                    const viewChecked = perms[catKey]?.[item.id]?.view ? 'checked' : '';
                    const editChecked = perms[catKey]?.[item.id]?.edit ? 'checked' : '';
                    html += `<td><input type="checkbox" data-pos="${pos.id}" data-cat="${catKey}" data-id="${item.id}" data-type="view" ${viewChecked} onchange="handleMatrixChange(this)"></td>`;
                    html += `<td><input type="checkbox" data-pos="${pos.id}" data-cat="${catKey}" data-id="${item.id}" data-type="edit" ${editChecked} onchange="handleMatrixChange(this)"></td>`;
                } else {
                    // Tek checkbox (admin, special)
                    const checked = perms[catKey]?.[item.id] ? 'checked' : '';
                    html += `<td colspan="2"><input type="checkbox" data-pos="${pos.id}" data-cat="${catKey}" data-id="${item.id}" data-type="enabled" ${checked} onchange="handleMatrixChange(this)"></td>`;
                }
            });
            
            html += '</tr>';
        });
    }
    
    html += '</tbody>';
    table.innerHTML = html;
    
    console.log('[Matrix] Rendered with', positions.length, 'positions');
}

// Pozisyon izinlerini al (Firebase veya varsayÄ±lan)
async function getPositionPermissions(positionId, baseRole) {
    try {
        // Ã–nce Firebase'den kontrol et
        const doc = await db.collection('advancedPermissions').doc(positionId).get();
        if (doc.exists) {
            return doc.data();
        }
    } catch (e) {
        console.warn('[Matrix] Firebase error:', e);
    }
    
    // VarsayÄ±lan izinleri dÃ¶ndÃ¼r
    return DEFAULT_ROLE_PERMISSIONS[baseRole] || DEFAULT_ROLE_PERMISSIONS.barista || {};
}

// Matrix deÄŸiÅŸiklik handler
function handleMatrixChange(element) {
    const posId = element.dataset.pos;
    const cat = element.dataset.cat;
    const id = element.dataset.id;
    const type = element.dataset.type;
    
    if (!matrixPermissionsCache[posId]) {
        matrixPermissionsCache[posId] = {};
    }
    
    if (!matrixPermissionsCache[posId][cat]) {
        matrixPermissionsCache[posId][cat] = {};
    }
    
    if (cat === 'limits') {
        matrixPermissionsCache[posId][cat][id] = parseInt(element.value);
    } else if (type === 'view' || type === 'edit') {
        if (!matrixPermissionsCache[posId][cat][id]) {
            matrixPermissionsCache[posId][cat][id] = { view: false, edit: false };
        }
        matrixPermissionsCache[posId][cat][id][type] = element.checked;
    } else {
        matrixPermissionsCache[posId][cat][id] = element.checked;
    }
    
    // KaydedilmemiÅŸ deÄŸiÅŸiklik flag
    matrixHasUnsavedChanges = true;
    
    // DeÄŸiÅŸiklik gÃ¶stergesi
    document.getElementById('matrixSaveStatus').innerHTML = '<span style="color:var(--yellow)">â— KaydedilmemiÅŸ deÄŸiÅŸiklikler var</span>';
}

// TÃ¼m matrix izinlerini kaydet
async function saveMatrixPermissions() {
    const statusEl = document.getElementById('matrixSaveStatus');
    statusEl.innerHTML = '<span style="color:var(--blue)">â³ Kaydediliyor...</span>';
    
    try {
        const batch = db.batch();
        let count = 0;
        
        for (const [posId, perms] of Object.entries(matrixPermissionsCache)) {
            const ref = db.collection('advancedPermissions').doc(posId);
            batch.set(ref, {
                ...perms,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedBy: currentUser?.email || 'unknown'
            }, { merge: true });
            count++;
        }
        
        await batch.commit();
        
        // Kaydedildi - flag'i temizle
        matrixHasUnsavedChanges = false;
        
        statusEl.innerHTML = `<span style="color:var(--green)">âœ“ ${count} pozisyon kaydedildi</span>`;
        toast('Yetkiler kaydedildi', 'success');
        
        // 3 saniye sonra mesajÄ± temizle
        setTimeout(() => {
            statusEl.innerHTML = '';
        }, 3000);
        
    } catch (error) {
        console.error('[Matrix] Save error:', error);
        statusEl.innerHTML = '<span style="color:var(--red)">âœ— Kaydetme hatasÄ±</span>';
        toast('Kaydetme hatasÄ±: ' + error.message, 'error');
    }
}

// Pozisyon seÃ§imi iÃ§in yeni fonksiyonlar
let selectedRoleForPerm = null;

function selectRoleForPermissions(positionId) {
    selectedRoleForPerm = positionId;
    
    // Pozisyonu STATE.positions'dan bul
    const position = STATE.positions.find(p => p.id === positionId);
    
    if (!position) {
        toast('Bilinmeyen pozisyon: ' + positionId, 'error');
        return;
    }
    
    document.getElementById('selectedRoleIcon').textContent = position.icon || 'ðŸ‘¤';
    document.getElementById('selectedRoleName').textContent = position.name;
    document.getElementById('selectedRoleDesc').textContent = position.type + ' yetkileri';
    
    document.getElementById('selectedRolePermissions').style.display = 'block';
    document.getElementById('permissionsInfo').style.display = 'none';
    
    // Ä°zinleri yÃ¼kle - pozisyon rolÃ¼ne gÃ¶re
    loadRolePermissions(positionId, position.role);
}

function hideRolePermissions() {
    document.getElementById('selectedRolePermissions').style.display = 'none';
    document.getElementById('permissionsInfo').style.display = 'block';
    selectedRoleForPerm = null;
}

async function loadRolePermissions(positionId, baseRole) {
    // Ã–nce pozisyona Ã¶zel izinleri kontrol et, yoksa rol varsayÄ±lanlarÄ±nÄ± kullan
    let perms = getDefaultPermissions(baseRole || positionId);
    
    try {
        // Ã–nce pozisyona Ã¶zel izinleri dene
        const posDoc = await db.collection('advancedPermissions').doc(positionId).get();
        if (posDoc.exists) {
            perms = { ...perms, ...posDoc.data() };
        } else if (baseRole && DEFAULT_ROLE_PERMISSIONS[baseRole]) {
            // Pozisyona Ã¶zel yoksa rol varsayÄ±lanlarÄ±nÄ± kullan
            perms = { ...perms, ...DEFAULT_ROLE_PERMISSIONS[baseRole] };
        }
    } catch (error) {
        console.error('Ä°zin yÃ¼kleme hatasÄ±:', error);
    }
    
    // Sayfalar
    renderPagePermissions(perms.pages || {});
    
    // Belgeler
    renderDocPermissions(perms.documents || {});
    
    // Formlar
    renderFormPermissions(perms.forms || {});
    
    // Admin
    renderAdminPermissions(perms.admin || {});
    
    // Ã–zel izinler
    renderSpecialPermissions(perms.special || {});
    
    // Limitler
    renderLimitsPermissions(perms.limits || {});
}

async function loadAdvancedPermissions() {
    const role = document.getElementById('advRoleSelect')?.value;
    const panel = document.getElementById('advPermissionsPanel');
    const empty = document.getElementById('advPermissionsEmpty');
    
    if (!role) {
        if (panel) panel.style.display = 'none';
        if (empty) empty.style.display = 'block';
        return;
    }
    
    if (panel) panel.style.display = 'block';
    if (empty) empty.style.display = 'none';
    
    // Firebase'den izinleri al veya varsayÄ±lanÄ± kullan
    let perms = DEFAULT_ROLE_PERMISSIONS[role];
    try {
        const doc = await db.collection('advancedPermissions').doc(role).get();
        if (doc.exists) {
            perms = { ...perms, ...doc.data() };
        }
    } catch (error) {
        console.error('Ä°zin yÃ¼kleme hatasÄ±:', error);
    }
    
    // Sayfalar
    renderPagePermissions(perms.pages || {});
    
    // Belgeler
    renderDocPermissions(perms.documents || {});
    
    // Formlar
    renderFormPermissions(perms.forms || {});
    
    // Admin
    renderAdminPermissions(perms.admin || {});
    
    // Ã–zel izinler
    renderSpecialPermissions(perms.special || {});
    
    // Limitler
    renderLimitsPermissions(perms.limits || {});
}

function renderPagePermissions(perms) {
    const container = document.getElementById('pagePermissions');
    if (!container) return;
    let html = '';
    
    PERMISSION_STRUCTURE.pages.forEach(p => {
        const perm = perms[p.id] || { view: false, edit: false };
        html += `
            <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--bg2);border-radius:8px;border:1px solid var(--cardBorder)">
                <span style="font-weight:500;color:var(--tx);font-size:.85rem">${p.label}</span>
                <div style="display:flex;gap:12px">
                    <label style="display:flex;align-items:center;gap:4px;cursor:pointer">
                        <input type="checkbox" class="perm-cb" data-cat="pages" data-id="${p.id}" data-type="view" ${perm.view ? 'checked' : ''} style="width:16px;height:16px;accent-color:#27ae60">
                        <span style="font-size:.75rem;color:var(--tx2)">GÃ¶r</span>
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;cursor:pointer">
                        <input type="checkbox" class="perm-cb" data-cat="pages" data-id="${p.id}" data-type="edit" ${perm.edit ? 'checked' : ''} style="width:16px;height:16px;accent-color:#3498db">
                        <span style="font-size:.75rem;color:var(--tx2)">DÃ¼zenle</span>
                    </label>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function renderDocPermissions(perms) {
    const container = document.getElementById('docPermissions');
    if (!container) return;
    let html = '';
    
    PERMISSION_STRUCTURE.documents.forEach(d => {
        const perm = perms[d.id] || { view: false, edit: false };
        html += `
            <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--bg2);border-radius:8px;border:1px solid var(--cardBorder)">
                <span style="font-weight:500;color:var(--tx);font-size:.85rem">${d.label}</span>
                <div style="display:flex;gap:12px">
                    <label style="display:flex;align-items:center;gap:4px;cursor:pointer">
                        <input type="checkbox" class="perm-cb" data-cat="documents" data-id="${d.id}" data-type="view" ${perm.view ? 'checked' : ''} style="width:16px;height:16px;accent-color:#27ae60">
                        <span style="font-size:.75rem;color:var(--tx2)">GÃ¶r</span>
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;cursor:pointer">
                        <input type="checkbox" class="perm-cb" data-cat="documents" data-id="${d.id}" data-type="edit" ${perm.edit ? 'checked' : ''} style="width:16px;height:16px;accent-color:#3498db">
                        <span style="font-size:.75rem;color:var(--tx2)">DÃ¼zenle</span>
                    </label>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function renderFormPermissions(perms) {
    const container = document.getElementById('formPermissions');
    if (!container) return;
    let html = '';
    
    PERMISSION_STRUCTURE.forms.forEach(f => {
        const perm = perms[f.id] || { view: false, edit: false };
        html += `
            <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--bg2);border-radius:8px;border:1px solid var(--cardBorder)">
                <span style="font-weight:500;color:var(--tx);font-size:.85rem">${f.label}</span>
                <div style="display:flex;gap:12px">
                    <label style="display:flex;align-items:center;gap:4px;cursor:pointer">
                        <input type="checkbox" class="perm-cb" data-cat="forms" data-id="${f.id}" data-type="view" ${perm.view ? 'checked' : ''} style="width:16px;height:16px;accent-color:#27ae60">
                        <span style="font-size:.75rem;color:var(--tx2)">GÃ¶r</span>
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;cursor:pointer">
                        <input type="checkbox" class="perm-cb" data-cat="forms" data-id="${f.id}" data-type="edit" ${perm.edit ? 'checked' : ''} style="width:16px;height:16px;accent-color:#3498db">
                        <span style="font-size:.75rem;color:var(--tx2)">DÃ¼zenle</span>
                    </label>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function renderAdminPermissions(perms) {
    const container = document.getElementById('adminPermissions');
    let html = '';
    
    PERMISSION_STRUCTURE.admin.forEach(a => {
        const hasAccess = perms[a.id] || false;
        html += `
            <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--bg2);border-radius:8px;border:1px solid var(--cardBorder)">
                <span style="font-weight:500;color:var(--tx);font-size:.85rem">${a.label}</span>
                <label style="display:flex;align-items:center;gap:4px;cursor:pointer">
                    <input type="checkbox" class="perm-cb" data-cat="admin" data-id="${a.id}" data-type="access" ${hasAccess ? 'checked' : ''} style="width:16px;height:16px;accent-color:#ff8674">
                    <span style="font-size:.75rem;color:var(--tx2)">EriÅŸim</span>
                </label>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function renderSpecialPermissions(perms) {
    const container = document.getElementById('specialPermissions');
    if (!container) return;
    let html = '';
    
    PERMISSION_STRUCTURE.special.forEach(s => {
        const hasPermission = perms[s.id] || false;
        html += `
            <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--bg2);border-radius:8px;border:1px solid var(--cardBorder)">
                <span style="font-weight:500;color:var(--tx);font-size:.85rem">${s.label}</span>
                <label style="display:flex;align-items:center;gap:4px;cursor:pointer">
                    <input type="checkbox" class="perm-cb" data-cat="special" data-id="${s.id}" data-type="enabled" ${hasPermission ? 'checked' : ''} style="width:16px;height:16px;accent-color:#ff8674">
                    <span style="font-size:.75rem;color:var(--tx2)">Ä°zin</span>
                </label>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function renderLimitsPermissions(perms) {
    const container = document.getElementById('limitsPermissions');
    if (!container) return;
    let html = '';
    
    const limitLabels = {
        'shift_history_weeks': { label: 'Shift GeÃ§miÅŸ GÃ¶rÃ¼ntÃ¼leme', unit: 'hafta', options: [1, 2, 3, 4, 5, 12, 999] }
    };
    
    if (PERMISSION_STRUCTURE.limits) {
        PERMISSION_STRUCTURE.limits.forEach(l => {
            const value = perms[l.id] || 1;
            const info = limitLabels[l.id] || { label: l.label, unit: '', options: [1, 5, 12, 999] };
            
            html += `
                <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--bg2);border-radius:8px;border:1px solid var(--cardBorder)">
                    <span style="font-weight:500;color:var(--tx);font-size:.85rem">${info.label}</span>
                    <div style="display:flex;align-items:center;gap:8px">
                        <select class="perm-limit" data-id="${l.id}" style="padding:6px 10px;border-radius:6px;border:1px solid var(--cardBorder);background:var(--bg);color:var(--tx);font-size:.8rem">
                            ${info.options.map(opt => `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt === 999 ? 'SÄ±nÄ±rsÄ±z' : opt + ' ' + info.unit}</option>`).join('')}
                        </select>
                    </div>
                </div>
            `;
        });
    }
    
    container.innerHTML = html || '<p style="color:var(--tx2);font-size:.8rem;text-align:center">Limit ayarÄ± yok</p>';
}

async function saveAdvancedPermissions() {
    const role = selectedRoleForPerm || document.getElementById('advRoleSelect')?.value;
    if (!role) {
        toast('LÃ¼tfen bir pozisyon seÃ§in', 'error');
        return;
    }
    
    const permissions = {
        pages: {},
        documents: {},
        forms: {},
        admin: {},
        special: {},
        limits: {}
    };
    
    // TÃ¼m checkbox'larÄ± topla
    document.querySelectorAll('.perm-cb').forEach(cb => {
        const cat = cb.dataset.cat;
        const id = cb.dataset.id;
        const type = cb.dataset.type;
        
        if (cat === 'pages' || cat === 'documents' || cat === 'forms') {
            if (!permissions[cat][id]) permissions[cat][id] = { view: false, edit: false };
            permissions[cat][id][type] = cb.checked;
        } else if (cat === 'admin') {
            permissions.admin[id] = cb.checked;
        } else if (cat === 'special') {
            permissions.special[id] = cb.checked;
        }
    });
    
    // Limits deÄŸerlerini topla
    document.querySelectorAll('.perm-limit').forEach(input => {
        const id = input.dataset.id;
        permissions.limits[id] = parseInt(input.value) || 1;
    });
    
    try {
        await db.collection('advancedPermissions').doc(role).set(permissions);
        toast('Yetkiler baÅŸarÄ±yla kaydedildi! âœ“', 'success');
        hideRolePermissions();
    } catch (error) {
        console.error('Yetki kayÄ±t hatasÄ±:', error);
        toast('KayÄ±t hatasÄ±: ' + error.message, 'error');
    }
}

function resetAdvancedPermissions() {
    const role = document.getElementById('advRoleSelect').value;
    if (!role) {
        toast('LÃ¼tfen bir rol seÃ§in', 'error');
        return;
    }
    
    if (!confirm(`"${role}" rolÃ¼nÃ¼n izinleri varsayÄ±lana dÃ¶ndÃ¼rÃ¼lecek. Emin misiniz?`)) return;
    
    // VarsayÄ±lan izinleri yÃ¼kle
    const perms = DEFAULT_ROLE_PERMISSIONS[role];
    
    renderPagePermissions(perms.pages || {});
    renderDocPermissions(perms.documents || {});
    renderAdminPermissions(perms.admin || {});
    renderSpecialPermissions(perms.special || {});
    
    toast('VarsayÄ±lan izinler yÃ¼klendi. Kaydetmeyi unutmayÄ±n!', 'success');
}

// Ä°zin kontrol fonksiyonu
function checkPermission(category, id, type = 'view') {
    if (!currentUser) return false;
    if (currentUser.role === 'yonetici') return true;
    
    const perms = window.userAdvancedPermissions;
    if (!perms) return false;
    
    if (category === 'pages' || category === 'documents') {
        return perms[category]?.[id]?.[type] || false;
    } else if (category === 'admin') {
        return perms.admin?.[id] || false;
    } else if (category === 'special') {
        return perms.special?.[id] || false;
    }
    
    return false;
}

// KullanÄ±cÄ± avatarÄ±nÄ± yÃ¼kle
async function loadUserAvatar() {
    const userAvatarEl = document.getElementById('userAvatar');
    if (!userAvatarEl || !currentUser?.email) {
        if (userAvatarEl && currentUser?.name) {
            userAvatarEl.textContent = currentUser.name.charAt(0).toUpperCase();
        }
        return;
    }
    
    try {
        const personelSnap = await db.collection('personel').where('email', '==', currentUser.email).limit(1).get();
        
        if (!personelSnap.empty) {
            const data = personelSnap.docs[0].data();
            if (data.photoUrl) {
                userAvatarEl.innerHTML = `<img src="${data.photoUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
                return;
            }
        }
        
        // FotoÄŸraf yoksa baÅŸ harf gÃ¶ster
        if (currentUser.name) {
            userAvatarEl.textContent = currentUser.name.charAt(0).toUpperCase();
        }
    } catch (error) {
        console.error('Avatar yÃ¼kleme hatasÄ±:', error);
        if (currentUser?.name) {
            userAvatarEl.textContent = currentUser.name.charAt(0).toUpperCase();
        }
    }
}

// KullanÄ±cÄ± giriÅŸinde izinleri yÃ¼kle
async function loadUserAdvancedPermissions() {
    if (!currentUser) return;
    
    // YÃ¶netici iÃ§in de applyAdvancedPermissions Ã§aÄŸrÄ±lmalÄ± (tab'larÄ± aÃ§mak iÃ§in)
    if (currentUser.role === 'yonetici') {
        window.userAdvancedPermissions = null;
        applyAdvancedPermissions();
        return;
    }
    
    try {
        const doc = await db.collection('advancedPermissions').doc(currentUser.role).get();
        if (doc.exists) {
            window.userAdvancedPermissions = doc.data();
        } else {
            window.userAdvancedPermissions = DEFAULT_ROLE_PERMISSIONS[currentUser.role] || null;
        }
        
        // Ä°zinleri uygula
        applyAdvancedPermissions();
    } catch (error) {
        console.error('KullanÄ±cÄ± izin yÃ¼kleme hatasÄ±:', error);
    }
}

// Ä°zinleri UI'a uygula
function applyAdvancedPermissions() {
    // YÃ¶netici her ÅŸeyi gÃ¶rÃ¼r - early return
    if (currentUser?.role === 'yonetici') {
        console.log('[Yetkiler] YÃ¶netici - tÃ¼m yetkiler aÃ§Ä±k');
        // TÃ¼m admin sekmelerini gÃ¶rÃ¼nÃ¼r yap (tab-hidden class'Ä±nÄ± kaldÄ±r)
        const allAdminTabs = ['tab-kullanicilar', 'tab-oturumlar', 'tab-subeler', 'tab-ihlaller', 'tab-sablonlar', 'tab-belgeler', 'tab-yedekler', 'tab-magazaSaatleri', 'tab-checkKurallari', 'tab-checklistTurleri'];
        allAdminTabs.forEach(tabId => {
            const tab = document.getElementById(tabId);
            if (tab) tab.classList.remove('tab-hidden');
        });
        return;
    }
    
    if (!window.userAdvancedPermissions) return;
    
    const perms = window.userAdvancedPermissions;
    
    // ===== DÄ°NAMÄ°K SIDEBAR GÃœNCELLEMESÄ° =====
    // TÃ¼m sidebar kontrolÃ¼ bu fonksiyonda yapÄ±lÄ±yor (hardcoded deÄŸil)
    updateSidebarByPermissions(perms);
    
    // Dashboard kartlarÄ±nÄ± kÄ±sÄ±tla
    document.querySelectorAll('.dashboard-card').forEach(card => {
        const onclick = card.getAttribute('onclick') || '';
        
        // Sayfa kartlarÄ±
        PERMISSION_STRUCTURE.pages.forEach(p => {
            if (onclick.includes(`'${p.id}'`)) {
                const perm = perms.pages?.[p.id];
                if (perm && !perm.view) {
                    card.style.display = 'none';
                }
            }
        });
        
        // Belge kartlarÄ±
        PERMISSION_STRUCTURE.documents.forEach(d => {
            if (onclick.includes(`'${d.id}'`)) {
                const perm = perms.documents?.[d.id];
                if (perm && !perm.view) {
                    card.style.display = 'none';
                }
            }
        });
        
        // Form kartlarÄ±
        if (PERMISSION_STRUCTURE.forms) {
            PERMISSION_STRUCTURE.forms.forEach(f => {
                if (onclick.includes(`'${f.id}'`)) {
                    const perm = perms.forms?.[f.id];
                    if (perm && !perm.view) {
                        card.style.display = 'none';
                    }
                }
            });
        }
    });
    
    // Belgeler bÃ¶lÃ¼mÃ¼nÃ¼ kontrol et
    const hasAnyDocAccess = Object.values(perms.documents || {}).some(d => d.view);
    if (!hasAnyDocAccess) {
        // Sidebar'daki Belgeler menÃ¼sÃ¼nÃ¼ gizle
        const navBelgeler = document.getElementById('nav-belgeler');
        if (navBelgeler) navBelgeler.style.display = 'none';
        
        // Dashboard'daki Belgeler section'Ä±nÄ± gizle
        document.querySelectorAll('.dashboard-section').forEach(section => {
            const header = section.querySelector('div');
            if (header && header.textContent.includes('Belgeler')) {
                section.style.display = 'none';
            }
        });
    }
    
    // Formlar menÃ¼sÃ¼nÃ¼ kontrol et
    const hasAnyFormAccess = Object.values(perms.forms || {}).some(f => f.view);
    if (!hasAnyFormAccess) {
        const navFormlar = document.getElementById('nav-formlar');
        if (navFormlar) navFormlar.style.display = 'none';
        
        // Dashboard'daki Formlar section'Ä±nÄ± gizle
        document.querySelectorAll('.dashboard-section, div').forEach(el => {
            if (el.textContent && el.textContent.includes('FORMLAR')) {
                const section = el.closest('.dashboard-section') || el.parentElement;
                if (section && section.classList?.contains('dashboard-section')) {
                    section.style.display = 'none';
                }
            }
        });
    }
    
    // Admin paneli eriÅŸimini kontrol et
    const hasAnyAdminAccess = Object.values(perms.admin || {}).some(a => a);
    if (!hasAnyAdminAccess) {
        // Ayarlar menÃ¼sÃ¼nÃ¼ gizle
        const navAdmin = document.querySelector('.nav-item[data-page="admin"]');
        if (navAdmin) navAdmin.style.display = 'none';
        
        document.querySelectorAll('.dashboard-section').forEach(section => {
            const header = section.querySelector('div');
            if (header && header.textContent.includes('Sistem')) {
                section.style.display = 'none';
            }
        });
    }
    
    // Ã–zel izinleri uygula
    if (!perms.special?.print_shift) {
        // Print butonlarÄ±nÄ± gizle
        document.querySelectorAll('[onclick*="print"]').forEach(btn => {
            if (btn.closest('#page-shift')) {
                btn.style.display = 'none';
            }
        });
    }
    
    // Yeni Hafta OluÅŸturma yetkisi
    if (!perms.special?.create_shift_week) {
        const btnCreateWeek = document.getElementById('btnCreateShiftWeek');
        if (btnCreateWeek) btnCreateWeek.style.display = 'none';
    }
    
    // Shift silme yetkisi
    if (!perms.special?.delete_records) {
        const btnDeleteShift = document.getElementById('deleteShiftBtn');
        if (btnDeleteShift) btnDeleteShift.style.display = 'none';
    }
    
    // Shift geÃ§miÅŸ limiti - global deÄŸiÅŸkene ata
    window.userShiftHistoryWeeks = perms.limits?.shift_history_weeks || 1;
    
    // Checklist baÅŸkasÄ±nÄ±n doldurma yetkisi
    window.userCanFillOthersChecklist = perms.special?.fill_others_checklist || false;
    
    // Sidebar'Ä± yetkilere gÃ¶re gÃ¼ncelle
    updateSidebarByPermissions(perms);
    
    // "Yeni Personel" butonu yetkisi - personel.add yetkisi olmayan gÃ¶remez
    const btnNewPersonel = document.getElementById('btnNewPersonel');
    if (btnNewPersonel) {
        const canAddPersonel = perms.pages?.personel?.add === true;
        btnNewPersonel.style.display = canAddPersonel ? '' : 'none';
        console.log('[Permission] Yeni Personel butonu:', canAddPersonel ? 'gÃ¶rÃ¼nÃ¼r' : 'gizli');
    }
    
    // "Åžube Ekle" butonu yetkisi - manage_branches yetkisi olmayan gÃ¶remez
    const btnAddBranch = document.getElementById('btnAddBranch');
    if (btnAddBranch) {
        const canManageBranches = perms.special?.manage_branches === true;
        btnAddBranch.style.display = canManageBranches ? '' : 'none';
    }
    
    // ==================== YÃ–NETÄ°M SEKMELERÄ° YETKÄ° KONTROLÃœ ====================
    // Her sekme iÃ§in ilgili yetki kontrolÃ¼
    const adminTabPermissions = {
        'tab-subeler': perms.admin?.admin_subeler,
        'tab-ihlaller': perms.admin?.admin_ihlaller,
        'tab-sablonlar': perms.admin?.admin_sablonlar,
        'tab-belgeler': perms.admin?.admin_sablonlar, // Belgeler de ÅŸablonlar yetkisine baÄŸlÄ±
        'tab-yedekler': perms.admin?.admin_yedekler,
        'tab-magazaSaatleri': perms.admin?.admin_puantaj || perms.admin?.admin_subeler,
        'tab-checkKurallari': perms.admin?.admin_puantaj,
        'tab-checklistTurleri': perms.admin?.admin_puantaj,
        'tab-kullanicilar': perms.admin?.admin_kullanicilar,
        'tab-oturumlar': perms.admin?.admin_oturumlar
    };
    
    // Her sekme iÃ§in gÃ¶rÃ¼nÃ¼rlÃ¼k uygula (CLASS TABANLI)
    Object.entries(adminTabPermissions).forEach(([tabId, hasPermission]) => {
        const tab = document.getElementById(tabId);
        if (tab) {
            if (hasPermission) {
                tab.classList.remove('tab-hidden');
            } else {
                tab.classList.add('tab-hidden');
            }
        }
    });
    
    console.log('[Yetkiler] Admin sekmeleri gÃ¼ncellendi:', adminTabPermissions);
    
    console.log('âœ… GeliÅŸmiÅŸ izinler uygulandÄ±', { 
        createWeek: perms.special?.create_shift_week,
        historyWeeks: window.userShiftHistoryWeeks,
        fillOthers: window.userCanFillOthersChecklist
    });
}

// Sidebar gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼nÃ¼ yetkilere gÃ¶re gÃ¼ncelle
function updateSidebarByPermissions(perms) {
    if (!perms) {
        perms = window.userAdvancedPermissions || {};
    }
    
    // YÃ¶netici her ÅŸeyi gÃ¶rÃ¼r
    if (currentUser?.role === 'yonetici') {
        console.log('[Sidebar] YÃ¶netici - tÃ¼m menÃ¼ler gÃ¶rÃ¼nÃ¼r');
        return;
    }
    
    console.log('[Sidebar] Yetkiye gÃ¶re gÃ¼ncelleniyor...', perms);
    
    // Dinamik olarak PERMISSION_STRUCTURE'dan al (hardcoded deÄŸil)
    const documentPages = (PERMISSION_STRUCTURE.documents || []).map(d => d.id);
    const formPages = (PERMISSION_STRUCTURE.forms || []).map(f => f.id);
    
    // 1. Sayfalar (pages) - Her birini kontrol et
    const pageItems = document.querySelectorAll('.nav-item[data-page]');
    pageItems.forEach(item => {
        const page = item.dataset.page;
        
        // Admin sayfasÄ± ayrÄ± kontrol edilecek
        if (page === 'admin') return;
        
        // Belgeler ve formlar kendi gruplarÄ±nda kontrol edilecek
        if (documentPages.includes(page) || formPages.includes(page)) return;
        
        // Notlar sayfasÄ± ayrÄ± kontrol
        if (page === 'notlar') {
            // Notlar ÅŸimdilik yÃ¶netici dÄ±ÅŸÄ±nda gizli
            item.style.display = 'none';
            return;
        }
        
        // Pages kategorisindeki yetkiyi kontrol et
        const hasAccess = perms.pages?.[page]?.view === true;
        item.style.display = hasAccess ? '' : 'none';
        console.log(`[Sidebar] ${page}: ${hasAccess ? 'GÃ–RÃœNÃœR' : 'GÄ°ZLÄ°'}`);
    });
    
    // 2. Belgeler grubu - en az biri gÃ¶rÃ¼nÃ¼rse grup gÃ¶rÃ¼nsÃ¼n
    const navBelgeler = document.getElementById('nav-belgeler');
    if (navBelgeler) {
        const anyDocVisible = Object.values(perms.documents || {}).some(d => d.view === true);
        navBelgeler.style.display = anyDocVisible ? '' : 'none';
        console.log(`[Sidebar] Belgeler grubu: ${anyDocVisible ? 'GÃ–RÃœNÃœR' : 'GÄ°ZLÄ°'}`);
        
        // Belge alt menÃ¼lerini de kontrol et
        const docItems = navBelgeler.querySelectorAll('.nav-item[data-page]');
        docItems.forEach(item => {
            const docType = item.dataset.page;
            const hasAccess = perms.documents?.[docType]?.view === true;
            item.style.display = hasAccess ? '' : 'none';
        });
    }
    
    // 3. Formlar grubu - en az biri gÃ¶rÃ¼nÃ¼rse grup gÃ¶rÃ¼nsÃ¼n
    const navFormlar = document.getElementById('nav-formlar');
    if (navFormlar) {
        const anyFormVisible = Object.values(perms.forms || {}).some(f => f.view === true);
        navFormlar.style.display = anyFormVisible ? '' : 'none';
        console.log(`[Sidebar] Formlar grubu: ${anyFormVisible ? 'GÃ–RÃœNÃœR' : 'GÄ°ZLÄ°'}`);
        
        // Form alt menÃ¼lerini de kontrol et
        const formItems = navFormlar.querySelectorAll('.nav-item[data-page]');
        formItems.forEach(item => {
            const formType = item.dataset.page;
            const hasAccess = perms.forms?.[formType]?.view === true;
            item.style.display = hasAccess ? '' : 'none';
        });
    }
    
    // 4. Admin/Ayarlar - en az bir admin yetkisi varsa gÃ¶rÃ¼nsÃ¼n
    const navAdmin = document.querySelector('.nav-item[data-page="admin"]');
    if (navAdmin) {
        const anyAdminAccess = Object.values(perms.admin || {}).some(a => a === true);
        navAdmin.style.display = anyAdminAccess ? '' : 'none';
        console.log(`[Sidebar] Admin: ${anyAdminAccess ? 'GÃ–RÃœNÃœR' : 'GÄ°ZLÄ°'}`);
    }
    
    // 5. Dashboard formlar section (kendi dashboard'unda form gÃ¶sterme)
    const dashboardFormlar = document.getElementById('dashboard-formlar-section');
    if (dashboardFormlar) {
        const anyFormVisible = Object.values(perms.forms || {}).some(f => f.view === true);
        dashboardFormlar.style.display = anyFormVisible ? '' : 'none';
    }
    
    // 6. Nav divider'larÄ± (belgeler/formlar yoksa divider da gizle)
    const dividers = document.querySelectorAll('.nav-divider');
    dividers.forEach(div => {
        // Ã–nceki ve sonraki elementi kontrol et
        const prev = div.previousElementSibling;
        const next = div.nextElementSibling;
        const prevVisible = prev && getComputedStyle(prev).display !== 'none';
        const nextVisible = next && getComputedStyle(next).display !== 'none';
        div.style.display = (prevVisible && nextVisible) ? '' : 'none';
    });
    
    console.log('[Sidebar] Yetki gÃ¼ncellemesi tamamlandÄ±');
}


// ==================== OTURUM YÃ–NETÄ°MÄ° ====================
let sessionTimeoutId = null;
let sessionWarningId = null;
let lastActivityTime = Date.now();
const SESSION_EVENTS = ['mousedown', 'mousemove', 'keydown', 'scroll', 'touchstart', 'click'];

// Oturum ayarlarÄ±nÄ± yÃ¼kle
async function loadSessionSettings() {
    try {
        const doc = await db.collection('settings').doc('session').get();
        if (doc.exists) {
            const settings = doc.data();
            document.getElementById('sessionTimeout').value = settings.timeout || '30';
            document.getElementById('sessionWarning').value = settings.warning || '60';
            document.getElementById('sessionLogoutOnClose').checked = settings.logoutOnClose || false;
            document.getElementById('sessionSingleDevice').checked = settings.singleDevice || false;
            
            // Timeout'u baÅŸlat
            initSessionTimeout(settings.timeout || 30, settings.warning || 60);
        }
    } catch (error) {
        console.error('Oturum ayarlarÄ± yÃ¼kleme hatasÄ±:', error);
    }
}

// Oturum ayarlarÄ±nÄ± kaydet
async function saveSessionSettings() {
    const timeout = document.getElementById('sessionTimeout').value;
    const warning = document.getElementById('sessionWarning').value;
    const logoutOnClose = document.getElementById('sessionLogoutOnClose').checked;
    const singleDevice = document.getElementById('sessionSingleDevice').checked;
    
    try {
        await db.collection('settings').doc('session').set({
            timeout: parseInt(timeout),
            warning: parseInt(warning),
            logoutOnClose,
            singleDevice,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Timeout'u gÃ¼ncelle
        initSessionTimeout(parseInt(timeout), parseInt(warning));
        
        toast('Oturum ayarlarÄ± kaydedildi', 'success');
    } catch (error) {
        console.error('Oturum ayarlarÄ± kayÄ±t hatasÄ±:', error);
        toast('KayÄ±t hatasÄ±!', 'error');
    }
}

// Session timeout baÅŸlat
function initSessionTimeout(timeoutMinutes, warningSeconds) {
    // Eski timeout'larÄ± temizle
    if (sessionTimeoutId) clearTimeout(sessionTimeoutId);
    if (sessionWarningId) clearTimeout(sessionWarningId);
    
    // Devre dÄ±ÅŸÄ±ysa Ã§Ä±k
    if (timeoutMinutes === 0) return;
    
    const timeoutMs = timeoutMinutes * 60 * 1000;
    const warningMs = timeoutMs - (warningSeconds * 1000);
    
    // Aktivite dinleyicilerini ekle
    SESSION_EVENTS.forEach(event => {
        document.addEventListener(event, resetSessionTimer, { passive: true });
    });
    
    // ZamanlayÄ±cÄ±larÄ± baÅŸlat
    startSessionTimers(timeoutMs, warningMs);
}

function startSessionTimers(timeoutMs, warningMs) {
    // Eski timeout'larÄ± temizle
    if (sessionTimeoutId) clearTimeout(sessionTimeoutId);
    if (sessionWarningId) clearTimeout(sessionWarningId);
    
    // UyarÄ± timer'Ä±
    if (warningMs > 0) {
        sessionWarningId = setTimeout(() => {
            showSessionWarning();
        }, warningMs);
    }
    
    // Ã‡Ä±kÄ±ÅŸ timer'Ä±
    sessionTimeoutId = setTimeout(() => {
        sessionAutoLogout();
    }, timeoutMs);
}

function resetSessionTimer() {
    lastActivityTime = Date.now();
    
    // AyarlarÄ± al ve timer'larÄ± yeniden baÅŸlat
    const timeoutEl = document.getElementById('sessionTimeout');
    const warningEl = document.getElementById('sessionWarning');
    
    if (timeoutEl && warningEl) {
        const timeoutMinutes = parseInt(timeoutEl.value) || 30;
        const warningSeconds = parseInt(warningEl.value) || 60;
        
        if (timeoutMinutes > 0) {
            const timeoutMs = timeoutMinutes * 60 * 1000;
            const warningMs = timeoutMs - (warningSeconds * 1000);
            startSessionTimers(timeoutMs, warningMs);
        }
    }
}

function showSessionWarning() {
    const warningEl = document.getElementById('sessionWarning');
    const seconds = warningEl ? parseInt(warningEl.value) : 60;
    
    const body = `
        <div style="text-align:center;padding:20px">
            <div style="font-size:4rem;margin-bottom:16px">â°</div>
            <div style="font-size:1.2rem;font-weight:600;color:var(--tx);margin-bottom:12px">Oturum SÃ¼resi Doluyor!</div>
            <div style="color:var(--tx2);margin-bottom:20px">
                <span id="sessionCountdown">${seconds}</span> saniye iÃ§inde otomatik Ã§Ä±kÄ±ÅŸ yapÄ±lacak.
            </div>
            <div style="font-size:.85rem;color:var(--tx3)">Devam etmek iÃ§in herhangi bir yere tÄ±klayÄ±n.</div>
        </div>
    `;
    
    showModal('â° Oturum UyarÄ±sÄ±', body, `
        <button class="btn btn-ghost" onclick="sessionAutoLogout()">Ã‡Ä±kÄ±ÅŸ Yap</button>
        <button class="btn btn-primary" onclick="extendSession()">Devam Et</button>
    `);
    
    // Geri sayÄ±m
    let countdown = seconds;
    const countdownInterval = setInterval(() => {
        countdown--;
        const el = document.getElementById('sessionCountdown');
        if (el) el.textContent = countdown;
        
        if (countdown <= 0) {
            clearInterval(countdownInterval);
        }
    }, 1000);
    
    window.sessionCountdownInterval = countdownInterval;
}

function extendSession() {
    if (window.sessionCountdownInterval) {
        clearInterval(window.sessionCountdownInterval);
    }
    closeModal();
    resetSessionTimer();
    toast('Oturum uzatÄ±ldÄ±', 'success');
}

async function sessionAutoLogout() {
    if (window.sessionCountdownInterval) {
        clearInterval(window.sessionCountdownInterval);
    }
    closeModal();
    
    // Oturum kaydÄ±nÄ± gÃ¼ncelle
    if (currentUser) {
        try {
            await db.collection('sessions').doc(currentUser.sessionId).update({
                status: 'timeout',
                endedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        } catch (e) {}
    }
    
    toast('Oturum sÃ¼resi doldu', 'error');
    setTimeout(() => {
        logout();
    }, 1000);
}

// Aktif oturumlarÄ± yÃ¼kle
async function loadActiveSessions() {
    const container = document.getElementById('activeSessionsList');
    if (!container) return;
    
    container.innerHTML = `
        <div style="text-align:center;padding:40px;color:var(--tx2)">
            <div style="font-size:2rem;margin-bottom:12px">ðŸ”„</div>
            <div>YÃ¼kleniyor...</div>
        </div>
    `;
    
    try {
        const snapshot = await db.collection('sessions')
            .where('status', '==', 'active')
            .orderBy('startedAt', 'desc')
            .limit(50)
            .get();
        
        if (snapshot.empty) {
            container.innerHTML = `
                <div style="text-align:center;padding:40px;color:var(--tx2)">
                    <div style="font-size:2rem;margin-bottom:12px">âœ¨</div>
                    <div>Aktif oturum bulunamadÄ±</div>
                </div>
            `;
            return;
        }
        
        let html = `
            <div style="overflow-x:auto">
                <table style="width:100%;border-collapse:collapse;font-size:.85rem">
                    <thead>
                        <tr style="background:var(--bg3)">
                            <th style="padding:12px;text-align:left;color:var(--tx);font-weight:600;border-bottom:1px solid var(--bg4)">KullanÄ±cÄ±</th>
                            <th style="padding:12px;text-align:left;color:var(--tx);font-weight:600;border-bottom:1px solid var(--bg4)">Cihaz</th>
                            <th style="padding:12px;text-align:left;color:var(--tx);font-weight:600;border-bottom:1px solid var(--bg4)">IP Adresi</th>
                            <th style="padding:12px;text-align:left;color:var(--tx);font-weight:600;border-bottom:1px solid var(--bg4)">GiriÅŸ ZamanÄ±</th>
                            <th style="padding:12px;text-align:left;color:var(--tx);font-weight:600;border-bottom:1px solid var(--bg4)">Son Aktivite</th>
                            <th style="padding:12px;text-align:center;color:var(--tx);font-weight:600;border-bottom:1px solid var(--bg4)">Ä°ÅŸlem</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        snapshot.forEach(doc => {
            const s = doc.data();
            const startedAt = s.startedAt?.toDate?.() ? s.startedAt.toDate().toLocaleString('tr-TR') : '-';
            const lastActivity = s.lastActivity?.toDate?.() ? formatTimeAgo(s.lastActivity.toDate()) : '-';
            const isCurrentSession = currentUser?.sessionId === doc.id;
            
            html += `
                <tr style="border-bottom:1px solid var(--bg4);transition:background .2s" onmouseover="this.style.background='var(--bg3)'" onmouseout="this.style.background='transparent'">
                    <td style="padding:12px">
                        <div style="display:flex;align-items:center;gap:10px">
                            <div style="width:32px;height:32px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:.8rem">
                                ${(s.userName || 'U').charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div style="color:var(--tx);font-weight:500">${s.userName || s.userEmail || '-'}</div>
                                <div style="font-size:.75rem;color:var(--tx3)">${s.userRole || '-'}</div>
                            </div>
                        </div>
                    </td>
                    <td style="padding:12px">
                        <div style="display:flex;align-items:center;gap:6px">
                            <span>${getDeviceIcon(s.device)}</span>
                            <span style="color:var(--tx2)">${s.device || 'Bilinmiyor'}</span>
                        </div>
                    </td>
                    <td style="padding:12px;color:var(--tx2);font-family:var(--mono);font-size:.8rem">${s.ip || '-'}</td>
                    <td style="padding:12px;color:var(--tx2)">${startedAt}</td>
                    <td style="padding:12px">
                        <span style="display:inline-flex;align-items:center;gap:4px;padding:4px 10px;background:rgba(39,174,96,.15);color:#27ae60;border-radius:20px;font-size:.75rem">
                            <span style="width:6px;height:6px;background:#27ae60;border-radius:50%;animation:pulse 2s infinite"></span>
                            ${lastActivity}
                        </span>
                    </td>
                    <td style="padding:12px;text-align:center">
                        ${isCurrentSession ? 
                            `<button onclick="terminateSession('${doc.id}')" style="background:rgba(243,156,18,.1);border:1px solid rgba(243,156,18,.3);color:#f39c12;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:.8rem;transition:all .2s" onmouseover="this.style.background='rgba(243,156,18,.2)'" onmouseout="this.style.background='rgba(243,156,18,.1)'">âš ï¸ Ã‡Ä±kÄ±ÅŸ Yap</button>` :
                            `<button onclick="terminateSession('${doc.id}')" style="background:rgba(231,76,60,.1);border:none;color:#e74c3c;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:.8rem;transition:all .2s" onmouseover="this.style.background='rgba(231,76,60,.2)'" onmouseout="this.style.background='rgba(231,76,60,.1)'">ðŸš« SonlandÄ±r</button>`
                        }
                    </td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Oturum yÃ¼kleme hatasÄ±:', error);
        container.innerHTML = `
            <div style="text-align:center;padding:40px;color:var(--red)">
                <div style="font-size:2rem;margin-bottom:12px">âš ï¸</div>
                <div>YÃ¼kleme hatasÄ±: ${error.message}</div>
            </div>
        `;
    }
}

// Oturum geÃ§miÅŸini yÃ¼kle
async function loadSessionHistory() {
    const container = document.getElementById('sessionHistoryList');
    if (!container) return;
    
    try {
        const snapshot = await db.collection('sessions')
            .orderBy('startedAt', 'desc')
            .limit(20)
            .get();
        
        if (snapshot.empty) {
            container.innerHTML = `
                <div style="text-align:center;padding:40px;color:var(--tx2)">
                    <div style="font-size:2rem;margin-bottom:12px">ðŸ“Š</div>
                    <div>HenÃ¼z oturum geÃ§miÅŸi yok</div>
                </div>
            `;
            return;
        }
        
        let html = '<div style="display:flex;flex-direction:column;gap:8px">';
        
        snapshot.forEach(doc => {
            const s = doc.data();
            const startedAt = s.startedAt?.toDate?.() ? s.startedAt.toDate().toLocaleString('tr-TR') : '-';
            const statusColor = s.status === 'active' ? '#27ae60' : (s.status === 'timeout' ? '#f39c12' : '#95a5a6');
            const statusText = s.status === 'active' ? 'Aktif' : (s.status === 'timeout' ? 'Zaman AÅŸÄ±mÄ±' : 'SonlandÄ±');
            const statusIcon = s.status === 'active' ? 'ðŸŸ¢' : (s.status === 'timeout' ? 'ðŸŸ¡' : 'âšª');
            
            html += `
                <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--bg3);border-radius:10px">
                    <div style="display:flex;align-items:center;gap:12px">
                        <span>${statusIcon}</span>
                        <div>
                            <div style="font-weight:500;color:var(--tx)">${s.userName || s.userEmail || '-'}</div>
                            <div style="font-size:.75rem;color:var(--tx3)">${s.device || 'Bilinmiyor'} â€¢ ${s.ip || '-'}</div>
                        </div>
                    </div>
                    <div style="text-align:right">
                        <div style="font-size:.8rem;color:var(--tx2)">${startedAt}</div>
                        <div style="font-size:.75rem;color:${statusColor}">${statusText}</div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Oturum geÃ§miÅŸi yÃ¼kleme hatasÄ±:', error);
    }
}

// Oturum sonlandÄ±r
async function terminateSession(sessionId) {
    // Kendi oturumunu mu sonlandÄ±rÄ±yor?
    const isOwnSession = sessionId === currentUser?.sessionId;
    
    if (isOwnSession) {
        if (!confirm('KENDÄ° OTURUMUNUZU sonlandÄ±rmak Ã¼zeresiniz. Ã‡Ä±kÄ±ÅŸ yapÄ±lacak. Devam etmek istiyor musunuz?')) return;
    } else {
        if (!confirm('Bu oturumu sonlandÄ±rmak istediÄŸinize emin misiniz?')) return;
    }
    
    try {
        await db.collection('sessions').doc(sessionId).update({
            status: 'terminated',
            endedAt: firebase.firestore.FieldValue.serverTimestamp(),
            terminatedBy: currentUser?.id || 'admin'
        });
        
        if (isOwnSession) {
            // Kendi oturumunu sonlandÄ±rdÄ± - logout yap
            toast('Oturumunuz sonlandÄ±rÄ±ldÄ±, Ã§Ä±kÄ±ÅŸ yapÄ±lÄ±yor...', 'warning');
            setTimeout(() => logout(), 1000);
        } else {
            toast('Oturum sonlandÄ±rÄ±ldÄ±', 'success');
            loadActiveSessions();
            loadSessionHistory();
        }
    } catch (error) {
        console.error('Oturum sonlandÄ±rma hatasÄ±:', error);
        toast('SonlandÄ±rma hatasÄ±!', 'error');
    }
}

// TÃ¼m oturumlarÄ± sonlandÄ±r (ÅŸifre deÄŸiÅŸikliÄŸinde)
async function terminateAllSessions(userId, exceptCurrentSession = true) {
    try {
        const snapshot = await db.collection('sessions')
            .where('userId', '==', userId)
            .where('status', '==', 'active')
            .get();
        
        const batch = db.batch();
        snapshot.forEach(doc => {
            if (exceptCurrentSession && doc.id === currentUser?.sessionId) return;
            batch.update(doc.ref, {
                status: 'terminated',
                endedAt: firebase.firestore.FieldValue.serverTimestamp(),
                terminatedBy: 'password_change'
            });
        });
        
        await batch.commit();
        return true;
    } catch (error) {
        console.error('Toplu oturum sonlandÄ±rma hatasÄ±:', error);
        return false;
    }
}

// Session geÃ§erliliÄŸini kontrol et
async function checkSessionValidity() {
    if (!currentUser) return false;
    
    try {
        // LocalStorage'dan session ID'yi al
        const storedSessionId = localStorage.getItem('mb_session_id');
        
        if (!storedSessionId) {
            // Session ID yok - yeni session oluÅŸtur
            const newSessionId = await createSession();
            if (newSessionId) {
                localStorage.setItem('mb_session_id', newSessionId);
                return true;
            }
            return false;
        }
        
        // Session durumunu kontrol et
        const sessionDoc = await db.collection('sessions').doc(storedSessionId).get();
        
        if (!sessionDoc.exists) {
            // Session bulunamadÄ± - yeni oluÅŸtur
            localStorage.removeItem('mb_session_id');
            const newSessionId = await createSession();
            if (newSessionId) {
                localStorage.setItem('mb_session_id', newSessionId);
                return true;
            }
            return false;
        }
        
        const sessionData = sessionDoc.data();
        
        // Session sonlandÄ±rÄ±lmÄ±ÅŸ mÄ±?
        if (sessionData.status === 'terminated' || sessionData.status === 'forced_logout' || sessionData.status === 'ended') {
            console.log('Session was terminated:', sessionData.status);
            localStorage.removeItem('mb_session_id');
            return false;
        }
        
        // Session bu kullanÄ±cÄ±ya mÄ± ait?
        if (sessionData.userId !== currentUser.id) {
            console.log('Session belongs to different user');
            localStorage.removeItem('mb_session_id');
            return false;
        }
        
        // Session geÃ§erli
        currentUser.sessionId = storedSessionId;
        return true;
        
    } catch (error) {
        console.error('Session validity check error:', error);
        return true; // Hata durumunda devam et
    }
}

// Yeni oturum baÅŸlat
async function createSession() {
    if (!currentUser) return null;
    
    const sessionId = 'S' + Date.now() + Math.random().toString(36).substr(2, 9);
    const deviceInfo = getDeviceInfo();
    
    try {
        // Tek cihaz politikasÄ± kontrolÃ¼
        const settingsDoc = await db.collection('settings').doc('session').get();
        if (settingsDoc.exists && settingsDoc.data().singleDevice) {
            // Bu kullanÄ±cÄ±nÄ±n diÄŸer aktif oturumlarÄ±nÄ± sonlandÄ±r
            const existingSessions = await db.collection('sessions')
                .where('userId', '==', currentUser.id)
                .where('status', '==', 'active')
                .get();
            
            const batch = db.batch();
            existingSessions.forEach(doc => {
                batch.update(doc.ref, {
                    status: 'forced_logout',
                    endedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    terminatedBy: 'single_device_policy'
                });
            });
            await batch.commit();
        }
        
        await db.collection('sessions').doc(sessionId).set({
            userId: currentUser.id,
            userEmail: currentUser.email,
            userName: currentUser.name,
            userRole: currentUser.role,
            device: deviceInfo.device,
            browser: deviceInfo.browser,
            ip: await getClientIP(),
            status: 'active',
            startedAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastActivity: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        currentUser.sessionId = sessionId;
        localStorage.setItem('mb_session_id', sessionId);
        return sessionId;
    } catch (error) {
        console.error('Oturum oluÅŸturma hatasÄ±:', error);
        return null;
    }
}

// Oturum aktivitesini gÃ¼ncelle
async function updateSessionActivity() {
    if (!currentUser?.sessionId) return;
    
    try {
        await db.collection('sessions').doc(currentUser.sessionId).update({
            lastActivity: firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch (error) {
        console.error('Aktivite gÃ¼ncelleme hatasÄ±:', error);
    }
}

// Periyodik aktivite gÃ¼ncellemesi (5 dakikada bir)
setInterval(() => {
    if (currentUser?.sessionId) {
        updateSessionActivity();
    }
}, 5 * 60 * 1000);

// Cihaz bilgisi al
function getDeviceInfo() {
    const ua = navigator.userAgent;
    let device = 'Bilinmiyor';
    let browser = 'Bilinmiyor';
    
    // Cihaz
    if (/iPhone/i.test(ua)) device = 'iPhone';
    else if (/iPad/i.test(ua)) device = 'iPad';
    else if (/Android/i.test(ua)) device = 'Android';
    else if (/Windows/i.test(ua)) device = 'Windows PC';
    else if (/Mac/i.test(ua)) device = 'Mac';
    else if (/Linux/i.test(ua)) device = 'Linux';
    
    // TarayÄ±cÄ±
    if (/Chrome/i.test(ua)) browser = 'Chrome';
    else if (/Firefox/i.test(ua)) browser = 'Firefox';
    else if (/Safari/i.test(ua)) browser = 'Safari';
    else if (/Edge/i.test(ua)) browser = 'Edge';
    
    return { device: device + ' / ' + browser, browser };
}

function getDeviceIcon(device) {
    if (!device) return 'ðŸ’»';
    const d = device.toLowerCase();
    if (d.includes('iphone') || d.includes('android')) return 'ðŸ“±';
    if (d.includes('ipad') || d.includes('tablet')) return 'ðŸ“±';
    if (d.includes('mac')) return 'ðŸ–¥ï¸';
    if (d.includes('windows')) return 'ðŸ’»';
    if (d.includes('linux')) return 'ðŸ§';
    return 'ðŸ’»';
}

// IP adresi al (basit yaklaÅŸÄ±m)
async function getClientIP() {
    try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
    } catch {
        return 'Bilinmiyor';
    }
}

// Zaman formatlama
function formatTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    
    if (diffMins < 1) return 'Az Ã¶nce';
    if (diffMins < 60) return `${diffMins} dk Ã¶nce`;
    if (diffHours < 24) return `${diffHours} saat Ã¶nce`;
    return date.toLocaleDateString('tr-TR');
}

// ==================== PUANTAJ KURALLARI (ADMIN) ====================
async function loadPuantajRulesAdmin() {
    const container = document.getElementById('puantajRulesList');
    if (!container) return;
    
    try {
        // starPoints config'i yÃ¼kle
        await loadStarPointsConfig();
        
        const config = starPointsConfig || {};
        
        // Premium renk paleti (koyu kÄ±rmÄ±zÄ± â†’ altÄ±n)
        const defaultColors = {
            1: '#8B0000', // Koyu kÄ±rmÄ±zÄ±
            2: '#C0392B', // KÄ±rmÄ±zÄ±
            3: '#D35400', // Turuncu
            4: '#DAA520', // AltÄ±n
            5: '#FFD700'  // Parlak altÄ±n
        };
        
        let html = `
            <div style="margin-bottom:20px">
                <div style="font-size:.95rem;font-weight:600;color:var(--tx);margin-bottom:20px;display:flex;align-items:center;gap:10px">
                    <svg width="20" height="20" fill="none" stroke="#DAA520" stroke-width="2" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                    Manuel DeÄŸerlendirme PuanlarÄ±
                </div>
                <div style="background:linear-gradient(135deg, var(--bg2) 0%, var(--bg) 100%);border-radius:16px;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,.08)">
        `;
        
        // 5'ten 1'e yÄ±ldÄ±zlarÄ± gÃ¶ster (mÃ¼kemmel â†’ ciddi ihlal)
        for (let star = 5; star >= 1; star--) {
            const cfg = config[star] || { label: '', points: star - 3, color: defaultColors[star] };
            const displayColor = cfg.color || defaultColors[star];
            const starStr = 'â˜…'.repeat(star) + 'â˜†'.repeat(5 - star);
            const bgGradient = star >= 4 
                ? 'linear-gradient(90deg, rgba(218,165,32,.08) 0%, transparent 100%)' 
                : (star === 3 
                    ? 'linear-gradient(90deg, rgba(211,84,0,.06) 0%, transparent 100%)'
                    : 'linear-gradient(90deg, rgba(192,57,43,.06) 0%, transparent 100%)');
            
            html += `
                <div style="display:flex;align-items:center;gap:16px;padding:16px 20px;border-bottom:1px solid var(--bg3);background:${bgGradient};${star === 1 ? 'border-bottom:none;' : ''}" id="starRow${star}">
                    <div style="font-size:1.2rem;color:${displayColor};letter-spacing:2px;min-width:100px;text-shadow:0 1px 2px rgba(0,0,0,.1)">${starStr}</div>
                    <div style="flex:1">
                        <input type="text" value="${cfg.label}" 
                            onchange="updateStarLabel(${star}, this.value)"
                            style="width:100%;padding:10px 14px;border:1px solid var(--bg4);border-radius:8px;background:var(--bg);color:var(--tx);font-size:.85rem;transition:border-color .2s"
                            onfocus="this.style.borderColor='#008c95'" onblur="this.style.borderColor='var(--bg4)'"
                            placeholder="${star >= 4 ? 'Ã–rn: Ä°yi Performans' : (star === 3 ? 'Ã–rn: Hafif UyarÄ±' : 'Ã–rn: Ä°hlal TÃ¼rÃ¼')}">
                    </div>
                    <div style="display:flex;align-items:center;gap:10px;min-width:130px">
                        <input type="number" value="${cfg.points}" 
                            onchange="updateStarPoints(${star}, this.value)"
                            style="width:70px;padding:10px;border:1px solid var(--bg4);border-radius:8px;background:var(--bg);color:${cfg.points >= 0 ? '#27ae60' : '#e74c3c'};font-size:.9rem;text-align:center;font-weight:700"
                            min="-10" max="10">
                        <span style="font-size:.8rem;color:var(--tx3);font-weight:500">puan</span>
                    </div>
                    <div style="min-width:44px">
                        <input type="color" value="${displayColor}" 
                            onchange="updateStarColor(${star}, this.value)"
                            style="width:36px;height:36px;border:2px solid var(--bg4);border-radius:8px;cursor:pointer;padding:0">
                    </div>
                </div>
            `;
        }
        
        html += `
                </div>
                <div style="margin-top:16px;display:flex;justify-content:flex-end">
                    <button onclick="saveStarPointsConfig()" class="btn btn-primary" style="padding:12px 24px;font-weight:600;display:flex;align-items:center;gap:8px">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                        DeÄŸiÅŸiklikleri Kaydet
                    </button>
                </div>
            </div>
            
            <div style="background:linear-gradient(135deg, rgba(218,165,32,.06) 0%, rgba(0,140,149,.04) 100%);border:1px solid rgba(218,165,32,.2);border-radius:12px;padding:16px 20px;margin-top:20px">
                <div style="font-size:.82rem;color:var(--tx2);line-height:1.7">
                    <div style="font-weight:600;color:var(--tx);margin-bottom:8px;display:flex;align-items:center;gap:6px">
                        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                        NasÄ±l Ã‡alÄ±ÅŸÄ±r
                    </div>
                    â€¢ YÃ¶neticiler personel deÄŸerlendirirken 1-5 yÄ±ldÄ±z seÃ§er<br>
                    â€¢ Her yÄ±ldÄ±z karÅŸÄ±lÄ±ÄŸÄ± yukarÄ±daki puan otomatik eklenir/Ã§Ä±karÄ±lÄ±r<br>
                    â€¢ Toplam puanlar prim hesaplamasÄ±nÄ± ve performans sÄ±ralamasÄ±nÄ± etkiler
                </div>
            </div>
        `;
        
        container.innerHTML = html;
    } catch (error) {
        console.error('Kural yÃ¼kleme hatasÄ±:', error);
        container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--red)">YÃ¼kleme hatasÄ±</div>';
    }
}

// YÄ±ldÄ±z etiketini gÃ¼ncelle (geÃ§ici - kaydet'e basÄ±nca kalÄ±cÄ±)
function updateStarLabel(star, value) {
    if (!starPointsConfig) starPointsConfig = {};
    if (!starPointsConfig[star]) starPointsConfig[star] = { label: '', points: star - 3, color: '#888' };
    starPointsConfig[star].label = value;
}

// YÄ±ldÄ±z puanÄ±nÄ± gÃ¼ncelle (geÃ§ici - kaydet'e basÄ±nca kalÄ±cÄ±)
function updateStarPoints(star, value) {
    if (!starPointsConfig) starPointsConfig = {};
    if (!starPointsConfig[star]) starPointsConfig[star] = { label: '', points: star - 3, color: '#888' };
    starPointsConfig[star].points = parseInt(value) || 0;
}

// YÄ±ldÄ±z rengini gÃ¼ncelle (geÃ§ici - kaydet'e basÄ±nca kalÄ±cÄ±)
function updateStarColor(star, value) {
    if (!starPointsConfig) starPointsConfig = {};
    if (!starPointsConfig[star]) starPointsConfig[star] = { label: '', points: star - 3, color: '#888' };
    starPointsConfig[star].color = value;
}

// starPoints config'i kaydet
async function saveStarPointsConfig() {
    try {
        const configToSave = { ...starPointsConfig };
        configToSave.updatedAt = new Date();
        configToSave.updatedBy = currentUser?.email || 'unknown';
        
        await db.collection('config').doc('starPoints').set(configToSave);
        toast('Puantaj kurallarÄ± kaydedildi', 'success');
    } catch (e) {
        console.error('Kaydetme hatasÄ±:', e);
        toast('Kaydetme baÅŸarÄ±sÄ±z', 'error');
    }
}

function showAddPuantajRuleModal(editId = null) {
    const isEdit = !!editId;
    const title = isEdit ? 'Kural DÃ¼zenle' : 'Yeni Puantaj KuralÄ±';
    
    const body = `
        <input type="hidden" id="ruleEditId" value="${editId || ''}">
        <div class="form-grid">
            <div class="form-group full">
                <label class="form-label">Kural BaÅŸlÄ±ÄŸÄ± *</label>
                <input type="text" id="ruleTitle" class="form-input" placeholder="Ã–rn: Check listi yanlÄ±ÅŸ iÅŸaretleme, GeÃ§ kalma vb.">
            </div>
            <div class="form-group">
                <label class="form-label">Kategori *</label>
                <select id="ruleCategory" class="form-select">
                    <option value="ihlal">âš ï¸ Ä°hlal (Negatif)</option>
                    <option value="basari">ðŸ† BaÅŸarÄ± (Pozitif)</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Puan Etkisi *</label>
                <select id="ruleEffect" class="form-select">
                    <optgroup label="â”€â”€ Negatif (Ä°hlaller) â”€â”€">
                        <option value="-3">â­ Ciddi Ä°hlal (-3 Puan)</option>
                        <option value="-2">â­â­ Orta Ä°hlal (-2 Puan)</option>
                        <option value="-1">â­â­â­ Hafif UyarÄ± (-1 Puan)</option>
                    </optgroup>
                    <optgroup label="â”€â”€ Pozitif (BaÅŸarÄ±lar) â”€â”€">
                        <option value="+1">â­â­â­â­ Ä°yi Performans (+1 Puan)</option>
                        <option value="+2">â­â­â­â­â­ MÃ¼kemmel (+2 Puan)</option>
                    </optgroup>
                </select>
            </div>
            <div class="form-group full">
                <label class="form-label">AÃ§Ä±klama</label>
                <textarea id="ruleDesc" class="form-textarea" rows="3" placeholder="KuralÄ±n detaylÄ± aÃ§Ä±klamasÄ±..." style="resize:vertical"></textarea>
            </div>
        </div>
        <div style="background:var(--bg3);border-radius:10px;padding:12px;margin-top:16px">
            <div style="font-size:.8rem;color:var(--tx2);display:flex;align-items:center;gap:8px">
                <span style="font-size:1.1rem">ðŸ’¡</span>
                <span>Bu kural, Ä°hlal/BaÅŸarÄ± kaydederken seÃ§ilebilir olacak ve otomatik puan hesaplamasÄ±nÄ± etkileyecek.</span>
            </div>
        </div>
    `;
    
    const footer = `
        <button class="btn btn-ghost" onclick="closeModal()">Ä°ptal</button>
        <button class="btn btn-primary" onclick="savePuantajRule()">ðŸ’¾ Kaydet</button>
    `;
    
    showModal(title, body, footer);
    
    if (isEdit) {
        loadPuantajRuleForEdit(editId);
    }
}

async function loadPuantajRuleForEdit(id) {
    try {
        const doc = await db.collection('puantajRules').doc(id).get();
        if (doc.exists) {
            const r = doc.data();
            document.getElementById('ruleTitle').value = r.title || '';
            document.getElementById('ruleCategory').value = r.category || 'ihlal';
            document.getElementById('ruleEffect').value = r.effect || '-1';
            document.getElementById('ruleDesc').value = r.desc || '';
        }
    } catch (error) {
        console.error('Kural yÃ¼kleme hatasÄ±:', error);
    }
}

async function savePuantajRule() {
    const editId = document.getElementById('ruleEditId').value;
    const title = document.getElementById('ruleTitle').value.trim();
    const category = document.getElementById('ruleCategory').value;
    const effect = document.getElementById('ruleEffect').value;
    const desc = document.getElementById('ruleDesc').value.trim();
    
    if (!title) {
        toast('BaÅŸlÄ±k zorunludur', 'error');
        return;
    }
    
    // YÄ±ldÄ±z sayÄ±sÄ±nÄ± etkiden hesapla
    let star = 3;
    if (effect === '-3') star = 1;
    else if (effect === '-2') star = 2;
    else if (effect === '-1') star = 3;
    else if (effect === '+1') star = 4;
    else if (effect === '+2') star = 5;
    
    const data = { title, category, star, effect, desc, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
    
    try {
        if (editId) {
            await db.collection('puantajRules').doc(editId).update(data);
            toast('Kural gÃ¼ncellendi', 'success');
        } else {
            const newId = 'R' + Date.now();
            await db.collection('puantajRules').doc(newId).set(data);
            toast('Kural eklendi', 'success');
        }
        closeModal();
        loadPuantajRules();
    } catch (error) {
        console.error('KayÄ±t hatasÄ±:', error);
        toast('KayÄ±t hatasÄ±!', 'error');
    }
}

function editPuantajRule(id) {
    showAddPuantajRuleModal(id);
}

async function deletePuantajRule(id) {
    confirmModal('Kural Sil', 'Bu kuralÄ± silmek istediÄŸinize emin misiniz?', async () => {
        try {
            await db.collection('puantajRules').doc(id).delete();
            toast('Kural silindi', 'success');
            loadPuantajRules();
        } catch (error) {
            console.error('Silme hatasÄ±:', error);
            toast('Silme hatasÄ±!', 'error');
        }
    });
}

// ==================== PLATFORM CHECK SAATLERÄ° ====================
async function savePlatformCheckTimes() {
    const inputs = document.querySelectorAll('.platform-time');
    const times = [];
    inputs.forEach(input => {
        if (input.value) times.push(input.value);
    });
    
    if (times.length === 0) {
        toast('En az bir saat belirleyin', 'error');
        return;
    }
    
    try {
        await db.collection('systemConfig').doc('checkRules').set({
            platformCheckTimes: times,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        
        // Yerel deÄŸiÅŸkeni gÃ¼ncelle
        PLATFORM_CHECK_TIMES.length = 0;
        PLATFORM_CHECK_TIMES.push(...times);
        CHECK_RULES.platform.timeSlots = times;
        
        toast('Platform check saatleri kaydedildi', 'success');
    } catch (error) {
        console.error('KayÄ±t hatasÄ±:', error);
        toast('KayÄ±t hatasÄ±!', 'error');
    }
}

// Platform saat ekleme/Ã§Ä±karma
function addPlatformCheckTime() {
    const container = document.getElementById('platformCheckTimesContainer');
    const input = document.createElement('input');
    input.type = 'time';
    input.className = 'form-input platform-time';
    input.value = '14:00';
    input.style.width = '100px';
    container.appendChild(input);
}

function removePlatformCheckTime() {
    const container = document.getElementById('platformCheckTimesContainer');
    const inputs = container.querySelectorAll('.platform-time');
    if (inputs.length > 1) {
        inputs[inputs.length - 1].remove();
    } else {
        toast('En az bir saat olmalÄ±', 'warning');
    }
}

// Check sistem ayarlarÄ±nÄ± kaydet
async function saveCheckSystemSettings() {
    const settings = {
        // SÃ¼re AyarlarÄ±
        tolerance: parseInt(document.getElementById('checkTolerance')?.value || 30),
        screenTime: parseInt(document.getElementById('checkScreenTime')?.value || 5),
        latePenaltyMinutes: parseInt(document.getElementById('checkLatePenalty')?.value || 15),
        
        // Puanlama
        points: {
            platform: parseInt(document.getElementById('checkPointPlatform')?.value || 10),
            cleaning: parseInt(document.getElementById('checkPointCleaning')?.value || 5),
            shift: parseInt(document.getElementById('checkPointShift')?.value || 15)
        },
        lateDeductionPercent: parseInt(document.getElementById('checkLateDeduction')?.value || 50),
        
        // Genel Ayarlar
        maxDaily: parseInt(document.getElementById('checkMaxDaily')?.value || 20),
        photoRequired: document.getElementById('checkPhotoRequired')?.value || 'platform',
        locationRequired: document.getElementById('checkLocationRequired')?.value === 'yes',
        notifyManager: document.getElementById('checkNotifyManager')?.checked ?? true,
        
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    try {
        await db.collection('systemConfig').doc('checkRules').set({
            checkSystemSettings: settings
        }, { merge: true });
        
        // Global deÄŸiÅŸkeni gÃ¼ncelle
        window.CHECK_SYSTEM_SETTINGS = settings;
        
        toast('Check sistem ayarlarÄ± kaydedildi âœ“', 'success');
    } catch (error) {
        console.error('Check ayarlarÄ± kayÄ±t hatasÄ±:', error);
        toast('KayÄ±t hatasÄ±!', 'error');
    }
}

// Check sistem ayarlarÄ±nÄ± yÃ¼kle
async function loadCheckSystemSettings() {
    try {
        const doc = await db.collection('systemConfig').doc('checkRules').get();
        if (doc.exists) {
            const data = doc.data();
            const settings = data.checkSystemSettings || {};
            
            // Form alanlarÄ±nÄ± doldur
            if (document.getElementById('checkTolerance')) {
                document.getElementById('checkTolerance').value = settings.tolerance || 30;
            }
            if (document.getElementById('checkScreenTime')) {
                document.getElementById('checkScreenTime').value = settings.screenTime || 5;
            }
            if (document.getElementById('checkLatePenalty')) {
                document.getElementById('checkLatePenalty').value = settings.latePenaltyMinutes || 15;
            }
            if (document.getElementById('checkPointPlatform')) {
                document.getElementById('checkPointPlatform').value = settings.points?.platform || 10;
            }
            if (document.getElementById('checkPointCleaning')) {
                document.getElementById('checkPointCleaning').value = settings.points?.cleaning || 5;
            }
            if (document.getElementById('checkPointShift')) {
                document.getElementById('checkPointShift').value = settings.points?.shift || 15;
            }
            if (document.getElementById('checkLateDeduction')) {
                document.getElementById('checkLateDeduction').value = settings.lateDeductionPercent || 50;
            }
            if (document.getElementById('checkMaxDaily')) {
                document.getElementById('checkMaxDaily').value = settings.maxDaily || 20;
            }
            if (document.getElementById('checkPhotoRequired')) {
                document.getElementById('checkPhotoRequired').value = settings.photoRequired || 'platform';
            }
            if (document.getElementById('checkLocationRequired')) {
                document.getElementById('checkLocationRequired').value = settings.locationRequired ? 'yes' : 'no';
            }
            if (document.getElementById('checkNotifyManager')) {
                document.getElementById('checkNotifyManager').checked = settings.notifyManager ?? true;
            }
            
            // Global deÄŸiÅŸkene kaydet
            window.CHECK_SYSTEM_SETTINGS = settings;
        }
    } catch (error) {
        console.error('Check ayarlarÄ± yÃ¼kleme hatasÄ±:', error);
    }
}

// ==================== TEMÄ°ZLÄ°K Ã‡Ä°ZELGESÄ° AYARLARI ====================
async function saveTemizlikShiftRules() {
    const rules = {
        acilisci: {
            shiftStartMin: document.getElementById('acilisci_start').value || '10:00',
            shiftStartMax: document.getElementById('acilisci_end').value || '11:00',
            deadline: document.getElementById('acilisci_deadline').value || '15:00'
        },
        araci: {
            shiftStartMin: document.getElementById('araci_start').value || '11:00',
            shiftStartMax: document.getElementById('araci_end').value || '16:00',
            deadline: document.getElementById('araci_deadline').value || '19:00'
        },
        kapanisci: {
            shiftStartMin: document.getElementById('kapanisci_start').value || '16:00',
            shiftStartMax: document.getElementById('kapanisci_end').value || '23:59',
            deadline: document.getElementById('kapanisci_deadline').value || '02:00'
        }
    };
    
    try {
        await db.collection('systemConfig').doc('checkRules').set({
            temizlikShiftRules: rules,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        
        // Yerel deÄŸiÅŸkeni gÃ¼ncelle
        TEMIZLIK_SHIFT_RULES.acilisci = { ...TEMIZLIK_SHIFT_RULES.acilisci, ...rules.acilisci };
        TEMIZLIK_SHIFT_RULES.araci = { ...TEMIZLIK_SHIFT_RULES.araci, ...rules.araci };
        TEMIZLIK_SHIFT_RULES.kapanisci = { ...TEMIZLIK_SHIFT_RULES.kapanisci, ...rules.kapanisci };
        
        toast('Temizlik Ã§izelgesi ayarlarÄ± kaydedildi', 'success');
    } catch (error) {
        console.error('KayÄ±t hatasÄ±:', error);
        toast('KayÄ±t hatasÄ±!', 'error');
    }
}

// ==================== AYARLARI YÃœKLE ====================
async function loadCheckRulesSettings() {
    try {
        const doc = await db.collection('systemConfig').doc('checkRules').get();
        if (doc.exists) {
            const data = doc.data();
            
            // Platform check saatlerini yÃ¼kle
            if (data.platformCheckTimes && data.platformCheckTimes.length > 0) {
                const container = document.getElementById('platformCheckTimesContainer');
                if (container) {
                    container.innerHTML = '';
                    data.platformCheckTimes.forEach(time => {
                        const input = document.createElement('input');
                        input.type = 'time';
                        input.className = 'form-input platform-time';
                        input.value = time;
                        input.style.width = '100px';
                        container.appendChild(input);
                    });
                }
                // Global deÄŸiÅŸkeni gÃ¼ncelle
                PLATFORM_CHECK_TIMES.length = 0;
                PLATFORM_CHECK_TIMES.push(...data.platformCheckTimes);
                CHECK_RULES.platform.timeSlots = data.platformCheckTimes;
            }
            
            // Temizlik shift kurallarÄ±nÄ± yÃ¼kle
            if (data.temizlikShiftRules) {
                const rules = data.temizlikShiftRules;
                if (rules.acilisci) {
                    document.getElementById('acilisci_start')?.setAttribute('value', rules.acilisci.shiftStartMin || '10:00');
                    document.getElementById('acilisci_end')?.setAttribute('value', rules.acilisci.shiftStartMax || '11:00');
                    document.getElementById('acilisci_deadline')?.setAttribute('value', rules.acilisci.deadline || '15:00');
                }
                if (rules.araci) {
                    document.getElementById('araci_start')?.setAttribute('value', rules.araci.shiftStartMin || '11:00');
                    document.getElementById('araci_end')?.setAttribute('value', rules.araci.shiftStartMax || '16:00');
                    document.getElementById('araci_deadline')?.setAttribute('value', rules.araci.deadline || '19:00');
                }
                if (rules.kapanisci) {
                    document.getElementById('kapanisci_start')?.setAttribute('value', rules.kapanisci.shiftStartMin || '16:00');
                    document.getElementById('kapanisci_end')?.setAttribute('value', rules.kapanisci.shiftStartMax || '23:59');
                    document.getElementById('kapanisci_deadline')?.setAttribute('value', rules.kapanisci.deadline || '02:00');
                }
            }
            
            // Check sistem ayarlarÄ±nÄ± yÃ¼kle
            if (data.checkSystemSettings) {
                const settings = data.checkSystemSettings;
                document.getElementById('checkTolerance')?.setAttribute('value', settings.tolerance || 30);
                document.getElementById('checkScreenTime')?.setAttribute('value', settings.screenTime || 5);
                document.getElementById('checkLatePenalty')?.setAttribute('value', settings.latePenaltyMinutes || 15);
                document.getElementById('checkPointPlatform')?.setAttribute('value', settings.points?.platform || 10);
                document.getElementById('checkPointCleaning')?.setAttribute('value', settings.points?.cleaning || 5);
                document.getElementById('checkPointShift')?.setAttribute('value', settings.points?.shift || 15);
                document.getElementById('checkLateDeduction')?.setAttribute('value', settings.lateDeductionPercent || 50);
                document.getElementById('checkMaxDaily')?.setAttribute('value', settings.maxDaily || 20);
                if (document.getElementById('checkPhotoRequired')) {
                    document.getElementById('checkPhotoRequired').value = settings.photoRequired || 'platform';
                }
                if (document.getElementById('checkLocationRequired')) {
                    document.getElementById('checkLocationRequired').value = settings.locationRequired ? 'yes' : 'no';
                }
                if (document.getElementById('checkNotifyManager')) {
                    document.getElementById('checkNotifyManager').checked = settings.notifyManager ?? true;
                }
                window.CHECK_SYSTEM_SETTINGS = settings;
            }
        }
    } catch (error) {
        console.error('Ayar yÃ¼kleme hatasÄ±:', error);
    }
}

// ==================== ADMIN RENDER OVERRIDE ====================
const originalRenderAdminLists = renderAdminLists;
renderAdminLists = function() {
    originalRenderAdminLists();
    loadUserList();
    loadPuantajRulesAdmin();
    
    // YÃ¶netici deÄŸilse ÅŸirket bilgilerini ve ÅŸifre deÄŸiÅŸtirmeyi gizle
    if (currentUser && currentUser.role !== 'yonetici') {
        const companyCard = document.getElementById('companySettingsCard');
        if (companyCard) companyCard.style.display = 'none';
        const passwordCard = document.getElementById('adminPasswordCard');
        if (passwordCard) passwordCard.style.display = 'none';
    } else {
        const passwordCard = document.getElementById('adminPasswordCard');
        if (passwordCard) passwordCard.style.display = 'block';
    }
};

// ==================== G15: MANUEL YEDEKLEME SÄ°STEMÄ° ====================
const BACKUP_CONFIG = {
    collections: [
        'personel', 'shifts', 'checklists', 'checklistSubmissions',
        'puantajNotes', 'managerNotes', 'weeklyTaskAssignments',
        'dailyTaskAssignments', 'users', 'config', 'systemConfig', 
        'permissions', 'positions', 'branches', 'credentials'
    ],
    maxPartSizeBytes: 900000,
    retentionDays: 30
};

// Manuel yedek al butonu iÃ§in
async function takeManualBackup() {
    const now = new Date();
    const dateStr = formatDateLocal(now);
    const timeStr = String(now.getHours()).padStart(2,'0') + String(now.getMinutes()).padStart(2,'0');
    const backupId = `backup_${dateStr.replace(/-/g, '')}_${timeStr}`;
    
    toast('Yedek alÄ±nÄ±yor...', 'info');
    
    try {
        const backupData = {
            date: dateStr,
            time: timeStr,
            createdAt: now.toISOString(),
            createdBy: currentUser?.name || 'Sistem',
            collections: {}
        };
        
        for (const col of BACKUP_CONFIG.collections) {
            try {
                const snap = await db.collection(col).get();
                const docs = [];
                snap.forEach(doc => docs.push({ id: doc.id, ...doc.data() }));
                backupData.collections[col] = docs;
            } catch (e) {
                backupData.collections[col] = [];
            }
        }
        
        const jsonString = JSON.stringify(backupData);
        const sizeBytes = new Blob([jsonString]).size;
        
        await db.collection('backups').doc(backupId).set({
            date: dateStr,
            time: timeStr,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdBy: currentUser?.name || 'Sistem',
            data: jsonString,
            totalSize: sizeBytes
        });
        
        toast(`âœ… Yedek alÄ±ndÄ±! (${(sizeBytes/1024).toFixed(0)} KB)`, 'success');
        loadBackupsList();
    } catch (e) {
        console.error('[Backup] Hata:', e);
        toast('Yedekleme hatasÄ±: ' + e.message, 'error');
    }
}

// Eski fonksiyonlar - boÅŸ bÄ±rak (hata vermemesi iÃ§in)
async function checkAndRunBackupWithCatchup() { }
async function checkAndRunDailyBackup() { }
async function catchupMissingBackups() { }
async function runAutoBackup() { }

// Yedek indirme - parÃ§alarÄ± birleÅŸtirir
async function downloadBackup(date) {
    const backupId = `backup_${date.replace(/-/g, '')}`;
    
    try {
        const mainDoc = await db.collection('backups').doc(backupId).get();
        if (!mainDoc.exists) {
            toast('Yedek bulunamadÄ±', 'error');
            return;
        }
        
        const meta = mainDoc.data();
        let jsonString = '';
        
        if (meta.isMultiPart) {
            // ParÃ§alarÄ± birleÅŸtir
            toast('ParÃ§alar birleÅŸtiriliyor...', 'info');
            for (let i = 1; i <= meta.totalParts; i++) {
                const partDoc = await db.collection('backups').doc(`${backupId}_part${i}`).get();
                if (partDoc.exists) {
                    jsonString += partDoc.data().data;
                }
            }
        } else {
            jsonString = meta.data;
        }
        
        // Ä°ndir
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `moonberry_backup_${date}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        toast('Yedek indirildi!', 'success');
    } catch (e) {
        console.error('[Backup] Ä°ndirme hatasÄ±:', e);
        toast('Ä°ndirme hatasÄ±: ' + e.message, 'error');
    }
}

// TÃ¼m yedekleri tek JSON olarak indir - BASÄ°T VERSÄ°YON
async function downloadAllBackups() {
    toast('Bu Ã¶zellik devre dÄ±ÅŸÄ±. Yedekleri tek tek indirin.', 'info');
}

async function cleanOldBackups() {
    // Eski yedek temizleme devre dÄ±ÅŸÄ± - manuel silinebilir
}

async function loadBackupsList() {
    const container = document.getElementById('backupsListContainer');
    if (!container) return;
    
    container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--tx3)">YÃ¼kleniyor...</div>';
    
    try {
        // Sadece son 10 yedek (limit ile - index gerektirmez)
        const snapshot = await db.collection('backups').limit(15).get();
        
        if (snapshot.empty) {
            container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--tx3)">HenÃ¼z yedek yok.</div>';
            return;
        }
        
        // Part olmayanlarÄ± filtrele ve sÄ±rala
        const backups = [];
        snapshot.forEach(doc => {
            if (doc.id.includes('_part')) return;
            backups.push({ id: doc.id, ...doc.data() });
        });
        
        // Tarihe gÃ¶re sÄ±rala (yeniden eskiye)
        backups.sort((a, b) => (b.date || '').localeCompare(a.date || '') || (b.time || '').localeCompare(a.time || ''));
        
        // Max 10 gÃ¶ster
        const displayList = backups.slice(0, 10);
        
        let html = '<div style="display:flex;flex-direction:column;gap:8px">';
        const canDownload = currentUser?.role === 'yonetici';
        
        displayList.forEach(d => {
            const datetime = d.date + (d.time ? ' ' + d.time : '');
            const sizeKB = d.totalSize ? (d.totalSize / 1024).toFixed(0) + ' KB' : '-';
            
            html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--bg2);border-radius:10px;border:1px solid var(--bg4)">
                <div>
                    <div style="font-weight:600;color:var(--tx)">${datetime}</div>
                    <div style="font-size:.75rem;color:var(--tx3)">${sizeKB} â€¢ ${d.createdBy || 'Sistem'}</div>
                </div>
                ${canDownload ? `<button class="btn btn-sm" style="background:#008c95;color:#fff" onclick="downloadBackupFile('${d.id}')">Ä°ndir</button>` : ''}
            </div>`;
        });
        
        html += '</div>';
        container.innerHTML = html;
        console.log('[Backup] Liste yÃ¼klendi:', displayList.length, 'yedek');
    } catch (e) {
        console.error('[Backup] Liste hatasÄ±:', e);
        container.innerHTML = '<div style="color:#e74c3c;padding:20px">Hata: ' + e.message + '</div>';
    }
}

async function downloadBackupFile(backupId) {
    if (currentUser?.role !== 'yonetici') {
        toast('Yedek indirme yetkisi sadece yÃ¶neticiye ait', 'error');
        return;
    }
    
    try {
        toast('Yedek hazÄ±rlanÄ±yor...', 'info');
        const mainDoc = await db.collection('backups').doc(backupId).get();
        if (!mainDoc.exists) {
            toast('Yedek bulunamadÄ±', 'error');
            return;
        }
        
        const meta = mainDoc.data();
        let jsonString = '';
        
        if (meta.isMultiPart) {
            // ParÃ§alarÄ± birleÅŸtir
            for (let i = 1; i <= meta.totalParts; i++) {
                const partDoc = await db.collection('backups').doc(`${backupId}_part${i}`).get();
                if (partDoc.exists) {
                    jsonString += partDoc.data().data;
                }
            }
        } else if (meta.data) {
            jsonString = meta.data;
        } else {
            // Eski format - doÄŸrudan data iÃ§eriyor
            jsonString = JSON.stringify(meta, null, 2);
        }
        
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = 'moonberry_backup_' + meta.date + '.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        toast('Ä°ndirildi âœ“', 'success');
    } catch (e) {
        toast('Hata: ' + e.message, 'error');
    }
}

// ==================== DARK MODE ====================
function toggleDarkMode() {
    const html = document.documentElement;
    const isDark = html.getAttribute('data-theme') === 'dark';
    const newTheme = isDark ? 'light' : 'dark';
    html.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateDarkModeIcon(newTheme);
}

function updateDarkModeIcon(theme) {
    const icon = document.getElementById('darkModeIcon');
    const btn = document.getElementById('darkModeBtn');
    if (!icon) return;
    if (theme === 'dark') {
        icon.innerHTML = '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
        if (btn) { btn.style.background = 'var(--bg3)'; btn.style.borderColor = 'var(--bg4)'; }
    } else {
        icon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';
        if (btn) { btn.style.background = 'var(--surface2)'; btn.style.borderColor = 'var(--surface3)'; }
    }
    // Logo gÃ¼ncelle (Dark: beyaz logo, Light: renkli logo)
    updateLogos(theme);
}

function updateLogos(theme) {
    const darkLogo = 'https://static.wixstatic.com/media/760af2_cb121a61291f4f07adb48cfb70f3e2d9~mv2.png/v1/fill/w_94,h_82,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/beyazwhitelogo-min1.png';
    const lightLogo = 'https://static.wixstatic.com/media/760af2_755f54f13b654f1bb318c97f16a029a3~mv2.png/v1/fill/w_104,h_92,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/Moonberry%20Coffee%20Logo.png';
    
    // Login logo (tema ile deÄŸiÅŸir)
    const loginLogo = document.getElementById('loginLogo');
    if (loginLogo) {
        loginLogo.src = theme === 'dark' ? darkLogo : lightLogo;
    }
    
    // Breadcrumb logo (tema ile deÄŸiÅŸir - ana iÃ§erik alanÄ±nda)
    const breadcrumbLogo = document.getElementById('breadcrumbLogo');
    if (breadcrumbLogo) {
        breadcrumbLogo.src = theme === 'dark' ? darkLogo : lightLogo;
    }
    
    // Sidebar logo her zaman beyaz kalÄ±r (koyu arka plan)
}

// Dark mode init
(function() {
    const saved = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', saved);
    setTimeout(() => updateDarkModeIcon(saved), 100);
})();

// ==================== ADMIN ÅžÄ°FRE DEÄžÄ°ÅžTÄ°RME ====================
async function updateAdminCredentials() {
    const newUsername = document.getElementById('admin_new_username').value.trim();
    const newPassword = document.getElementById('admin_new_password').value;
    const confirmPassword = document.getElementById('admin_confirm_password').value;
    
    if (!newUsername && !newPassword) { toast('En az bir alan doldurun', 'error'); return; }
    if (newPassword && newPassword !== confirmPassword) { toast('Åžifreler eÅŸleÅŸmiyor', 'error'); return; }
    if (newPassword && newPassword.length < 6) { toast('Åžifre en az 6 karakter olmalÄ±', 'error'); return; }
    
    try {
        const user = firebase.auth().currentUser;
        if (!user) { toast('Oturum bulunamadÄ±, tekrar giriÅŸ yapÄ±n', 'error'); return; }
        
        // Firebase Auth ÅŸifresini gÃ¼ncelle
        if (newPassword) {
            await user.updatePassword(newPassword);
            console.log('Firebase Auth ÅŸifresi gÃ¼ncellendi');
        }
        
        // Firestore'daki kullanÄ±cÄ± bilgilerini gÃ¼ncelle
        const updateData = { updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
        if (newUsername) updateData.name = newUsername;
        
        // users koleksiyonunda gÃ¼ncelle (email ile bul)
        const userDoc = await db.collection('users').where('email', '==', user.email).get();
        if (!userDoc.empty) {
            await db.collection('users').doc(userDoc.docs[0].id).update(updateData);
        }
        
        // personel koleksiyonunda da gÃ¼ncelle
        const personelDoc = await db.collection('personel').where('email', '==', user.email).get();
        if (!personelDoc.empty && newPassword) {
            await db.collection('personel').doc(personelDoc.docs[0].id).update({ password: newPassword });
        }
        
        toast('GiriÅŸ bilgileri gÃ¼ncellendi', 'success');
        document.getElementById('admin_new_username').value = '';
        document.getElementById('admin_new_password').value = '';
        document.getElementById('admin_confirm_password').value = '';
    } catch (e) { 
        console.error('Åžifre gÃ¼ncelleme hatasÄ±:', e); 
        if (e.code === 'auth/requires-recent-login') {
            toast('GÃ¼venlik iÃ§in tekrar giriÅŸ yapmanÄ±z gerekiyor', 'error');
        } else {
            toast('GÃ¼ncelleme hatasÄ±: ' + e.message, 'error'); 
        }
    }
}

// ==================== ADMIN EMAIL YÃ–NETÄ°MÄ° ====================
// Admin email listesini UI'a yÃ¼kle
async function loadAdminEmailsToUI() {
    try {
        await loadAdminEmails(); // Firebase'den Ã§ek
        const textarea = document.getElementById('adminEmailsList');
        if (textarea) {
            textarea.value = _adminEmails.join('\n');
        }
    } catch (e) {
        console.error('Admin emails yÃ¼klenemedi:', e);
        toast('YÃ¼kleme hatasÄ±', 'error');
    }
}

// UI'dan admin email listesini kaydet
async function saveAdminEmailsFromUI() {
    const textarea = document.getElementById('adminEmailsList');
    if (!textarea) return;
    
    const emails = textarea.value
        .split('\n')
        .map(e => e.trim().toLowerCase())
        .filter(e => e && e.includes('@'));
    
    if (emails.length === 0) {
        toast('En az bir admin email gerekli', 'error');
        return;
    }
    
    await saveAdminEmails(emails);
}

// ==================== SHIFT SÄ°STEMÄ° ====================
// Shift tipleri ve saat aralÄ±klarÄ±
const SHIFT_TYPES = ['AÃ‡ILIÅž', 'ARA', 'KAPANIÅž', 'OFF', 'Y.Ä°', 'BÃ–LGE MÃœDÃœRÃœ'];
const COMMON_TIMES = [
    '10:00/19:00', '11:00/20:00', '12:00/21:00', '13:00/22:00', 
    '14:00/23:00', '15:00/00:00'
];

// Hafta label'Ä±na yÄ±l ekle
function formatWeekWithYear(weekLabel, weekStart) {
    if (!weekStart) return weekLabel || 'Tarih Yok';
    const year = weekStart.split('-')[0];
    const label = weekLabel || weekStart;
    // EÄŸer label zaten yÄ±lÄ± iÃ§eriyorsa ekleme
    if (label.includes(year) || label.includes('2024') || label.includes('2025') || label.includes('2026')) {
        return label;
    }
    return `${label} (${year})`;
}
// Part-time saat seÃ§enekleri (10:00 - 00:00 arasÄ± tÃ¼m saatler)
const PARTTIME_START = ['10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00', '21:00', '22:00', '23:00'];
const PARTTIME_END = ['11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00', '21:00', '22:00', '23:00', '00:00'];

// Excel renkleri (gerÃ§ek Excel'den alÄ±ndÄ±)
const SHIFT_COLORS = {
    'AÃ‡ILIÅž':  { bg: '#99CCFF', border: '#6699CC', text: '#003366' },  // Mavi
    'ARA':     { bg: '#FFFF99', border: '#CCCC00', text: '#666600' },  // SarÄ±
    'KAPANIÅž': { bg: '#FFC000', border: '#CC9900', text: '#663300' },  // Turuncu
    'OFF':     { bg: '#FF6666', border: '#CC0000', text: '#FFFFFF' },  // KÄ±rmÄ±zÄ±
    'Y.Ä°':     { bg: '#D9EAD3', border: '#6AA84F', text: '#274E13' },  // YeÅŸil
    'BÃ–LGE MÃœDÃœRÃœ': { bg: '#E1BEE7', border: '#9C27B0', text: '#6A1B9A' },  // Mor
    'TUZLA':   { bg: '#E6B8AF', border: '#CC4125', text: '#660000' },  // KÄ±rmÄ±zÄ±msÄ±
    'BÃ–LGE':   { bg: '#B4A7D6', border: '#8E7CC3', text: '#351C75' },  // Mor (eski)
    'RAPOR':   { bg: '#F4CCCC', border: '#E06666', text: '#990000' },  // AÃ§Ä±k kÄ±rmÄ±zÄ±
    'default': { bg: '#F3F3F3', border: '#CCCCCC', text: '#333333' }   // VarsayÄ±lan
};

// Shift duyurularÄ± (Excel'den)
const SHIFT_ANNOUNCEMENTS = [
    { text: 'AÃ‡ILIÅž PERSONELÄ° Ä°ÅžE GEÃ‡ KALMAMALIDIR!', color: '#2E7D32', bg: '#C6EFCE' },
    { text: 'Ä°ZÄ°N GÃœNÃœ YOKSA; YEMEK VE MOLA SÃœRESÄ° SEÃ‡Ä°MÄ° PERSONELÄ°N KENDÄ° SEÃ‡Ä°MÄ°NDEDÄ°R.', color: '#2E7D32', bg: '#C6EFCE' },
    { text: "SHIFT'E YILDIZ (*) SEMBOLÃœ OLAN GÃœNLER Ã–ZEL Ä°STEK GÃœNLERÄ°DÄ°R.", color: '#9C5700', bg: '#FFEB9C' },
    { text: 'KAPANIÅžTAN AÃ‡ILIÅž GELECEK PERSONEL YÃ–NETÄ°CÄ°LERÄ°NÄ° UYARACAK!', color: '#C00000', bg: '#FFC7CE' }
];

async function loadShiftList() {
    const subeSelect = document.getElementById('shiftSube');
    const haftaSelect = document.getElementById('shiftHafta');
    const historyContainer = document.getElementById('shiftHistoryContainer');
    
    if (!subeSelect || !haftaSelect) return;
    
    const selectedSube = subeSelect.value;
    if (!selectedSube) {
        haftaSelect.innerHTML = '<option value="">-- Ã–nce MaÄŸaza SeÃ§in --</option>';
        if (historyContainer) historyContainer.innerHTML = '<p style="color:var(--tx2);text-align:center;padding:20px">MaÄŸaza seÃ§erek geÃ§miÅŸ shiftleri gÃ¶rÃ¼ntÃ¼leyin.</p>';
        return;
    }
    
    haftaSelect.innerHTML = '<option value="">â³ YÃ¼kleniyor...</option>';
    if (historyContainer) historyContainer.innerHTML = '<p style="color:var(--tx2);text-align:center;padding:20px">â³ YÃ¼kleniyor...</p>';
    
    try {
        const snapshot = await db.collection('shifts').get();
        let weeks = [];
        
        snapshot.forEach(doc => {
            const d = doc.data();
            if (d.branch === selectedSube) {
                weeks.push({ id: doc.id, ...d });
            }
        });
        
        // Tarihe gÃ¶re sÄ±rala (en yeni Ã¶nce)
        weeks.sort((a, b) => (b.weekStart || '').localeCompare(a.weekStart || ''));
        
        // HAFTA LÄ°MÄ°TÄ° - KullanÄ±cÄ± yetkisine gÃ¶re
        // GÃœNCELLEME: Gelecek hafta da her zaman gÃ¶rÃ¼nsÃ¼n (Cumartesi/Pazar girilen shift)
        const maxWeeks = window.userShiftHistoryWeeks || 999;
        const isYonetici = ['yonetici', 'bolge_muduru'].includes(currentUser?.role);
        
        // BugÃ¼nÃ¼n ve gelecek haftanÄ±n baÅŸlangÄ±cÄ±nÄ± bul
        const today = new Date();
        const todayWeekStart = getWeekStart(today);
        const todayWeekKey = formatDateLocal(todayWeekStart);
        const nextWeekStart = new Date(todayWeekStart);
        nextWeekStart.setDate(nextWeekStart.getDate() + 7);
        const nextWeekKey = formatDateLocal(nextWeekStart);
        
        if (!isYonetici && maxWeeks < 999) {
            // Limit uygula AMA gelecek hafta her zaman gÃ¶rÃ¼nsÃ¼n
            weeks = weeks.filter(w => {
                if (!w.weekStart) return false;
                
                // Gelecek hafta her zaman gÃ¶rÃ¼nsÃ¼n (Cumartesi/Pazar girildiyse)
                if (w.weekStart === nextWeekKey) return true;
                
                const weekDate = new Date(w.weekStart);
                const diffWeeks = Math.floor((todayWeekStart - weekDate) / (7 * 24 * 60 * 60 * 1000));
                return diffWeeks <= maxWeeks;
            });
        }
        
        // Hafta dropdown'Ä±nÄ± doldur
        if (weeks.length === 0) {
            haftaSelect.innerHTML = '<option value="">-- KayÄ±tlÄ± shift yok --</option>';
        } else {
            haftaSelect.innerHTML = '<option value="">-- Hafta SeÃ§in (' + weeks.length + ' kayÄ±t) --</option>';
            
            // Hangi haftayÄ± otomatik seÃ§eceÄŸimizi bul
            let autoSelectId = null;
            let autoSelectType = null;
            
            weeks.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w.id;
                const cnt = Object.keys(w.personelShifts || {}).length;
                
                // Etiket oluÅŸtur
                let label = formatWeekWithYear(w.weekLabel, w.weekStart) + ' (' + cnt + ' kiÅŸi)';
                let badge = '';
                
                if (w.weekStart === todayWeekKey) {
                    badge = ' ðŸ“ BU HAFTA';
                    if (!autoSelectId) { autoSelectId = w.id; autoSelectType = 'current'; }
                } else if (w.weekStart === nextWeekKey) {
                    badge = ' ðŸ”œ GELECEKhafta';
                    // Gelecek hafta varsa ve bu hafta yoksa, gelecek haftayÄ± seÃ§
                    if (!autoSelectId) { autoSelectId = w.id; autoSelectType = 'next'; }
                }
                
                opt.textContent = label + badge;
                haftaSelect.appendChild(opt);
            });
            
            // OTOMATÄ°K HAFTA SEÃ‡Ä°MÄ°
            if (autoSelectId) {
                haftaSelect.value = autoSelectId;
                // SeÃ§ili shift'i yÃ¼kle
                setTimeout(() => selectShift(autoSelectId), 100);
                console.log(`âœ… Otomatik shift seÃ§ildi: ${autoSelectType === 'current' ? 'Bu hafta' : 'Gelecek hafta'}`);
            }
        }
        
        // GeÃ§miÅŸ shiftleri gÃ¶ster
        renderShiftHistory(weeks, selectedSube);
        
    } catch (e) { 
        console.error('Shift yÃ¼kleme hatasÄ±:', e); 
        haftaSelect.innerHTML = '<option value="">-- YÃ¼kleme hatasÄ± --</option>';
        if (historyContainer) historyContainer.innerHTML = '<p style="color:var(--red);text-align:center;padding:20px">âŒ YÃ¼kleme hatasÄ±: ' + e.message + '</p>';
        toast('Shift listesi yÃ¼klenemedi: ' + e.message, 'error');
    }
}

function renderShiftHistory(weeks, branch, showAll = false) {
    const container = document.getElementById('shiftHistoryContainer');
    if (!container) return;
    
    if (!weeks || weeks.length === 0) {
        container.innerHTML = `
            <div style="text-align:center;padding:40px;background:var(--bg2);border-radius:12px">
                <div style="font-size:3rem;margin-bottom:12px">ðŸ“‹</div>
                <div style="color:var(--tx2);margin-bottom:8px">Bu maÄŸazada henÃ¼z shift kaydÄ± yok.</div>
                <button class="btn btn-primary btn-sm" onclick="showNewShiftModal()" style="margin-top:12px">+ Ä°lk Shift'i OluÅŸtur</button>
            </div>`;
        return;
    }
    
    // GÃ¶sterilecek hafta sayÄ±sÄ±
    const displayWeeks = showAll ? weeks : weeks.slice(0, 3);
    const hasMore = weeks.length > 3 && !showAll;
    
    // Global'e kaydet (Daha Fazla iÃ§in)
    window._allShiftWeeks = weeks;
    window._shiftBranch = branch;
    
    let html = `
        <div style="margin-bottom:12px;display:flex;justify-content:space-between;align-items:center">
            <span style="font-size:.85rem;color:var(--tx2)">${branch}</span>
            <span style="font-size:.75rem;color:var(--tx2)">${showAll ? weeks.length : Math.min(3, weeks.length)}/${weeks.length} kayÄ±t</span>
        </div>
        <div style="display:grid;gap:8px">`;
    
    displayWeeks.forEach((w, idx) => {
        const cnt = Object.keys(w.personelShifts || {}).length;
        const isFirst = idx === 0;
        const borderColor = isFirst ? 'var(--accent)' : 'var(--bg4)';
        const badge = isFirst ? '<span style="font-size:.6rem;background:var(--accent);color:#fff;padding:2px 6px;border-radius:4px;margin-left:6px">EN YENÄ°</span>' : '';
        
        html += `
            <div onclick="selectShift('${w.id}')" 
                 style="display:flex;justify-content:space-between;align-items:center;padding:12px 14px;background:var(--bg3);border:2px solid ${borderColor};border-radius:10px;cursor:pointer;transition:all .2s" 
                 onmouseover="this.style.borderColor='var(--accent)';this.style.transform='translateX(4px)'" 
                 onmouseout="this.style.borderColor='${borderColor}';this.style.transform='none'">
                <div>
                    <div style="font-weight:600;color:var(--tx);font-size:.85rem;display:flex;align-items:center">
                        ${formatWeekWithYear(w.weekLabel, w.weekStart)}${badge}
                    </div>
                    <div style="font-size:.7rem;color:var(--tx2);margin-top:3px">ðŸ‘¥ ${cnt} personel</div>
                </div>
                <div style="color:var(--accent);font-size:1.2rem;font-weight:bold">â€º</div>
            </div>`;
    });
    
    html += '</div>';
    
    // Daha Fazla butonu
    if (hasMore) {
        html += `
            <button onclick="renderShiftHistory(window._allShiftWeeks, window._shiftBranch, true)" 
                    class="btn btn-ghost" style="width:100%;margin-top:12px;font-size:.8rem">
                ðŸ“‚ Daha Fazla YÃ¼kle (${weeks.length - 3} daha)
            </button>`;
    } else if (showAll && weeks.length > 3) {
        html += `
            <button onclick="renderShiftHistory(window._allShiftWeeks, window._shiftBranch, false)" 
                    class="btn btn-ghost" style="width:100%;margin-top:12px;font-size:.8rem">
                ðŸ”¼ Daha Az GÃ¶ster
            </button>`;
    }
    
    container.innerHTML = html;
}

function selectShift(shiftId) {
    document.getElementById('shiftHafta').value = shiftId;
    loadShiftWeek();
}

async function loadShiftWeek() {
    const container = document.getElementById('shiftTableContainer');
    const haftaId = document.getElementById('shiftHafta').value;
    
    // Barista iÃ§in silme butonunu gizle
    const deleteBtn = document.getElementById('deleteShiftBtn');
    if (deleteBtn) {
        deleteBtn.style.display = currentUser?.role === 'barista' ? 'none' : 'flex';
    }
    
    if (!haftaId) { 
        container.innerHTML = '<p style="color:var(--tx2);text-align:center;padding:40px">â¬†ï¸ YukarÄ±dan hafta seÃ§in veya yeni hafta oluÅŸturun.</p>'; 
        return; 
    }
    
    container.innerHTML = '<p style="color:var(--tx2);text-align:center;padding:40px">â³ YÃ¼kleniyor...</p>';
    
    try {
        const doc = await db.collection('shifts').doc(haftaId).get();
        if (!doc.exists) { 
            container.innerHTML = '<p style="color:var(--red);text-align:center;padding:40px">âŒ Shift bulunamadÄ±.</p>'; 
            return; 
        }
        renderShiftTable(doc.data(), haftaId);
    } catch (e) { 
        console.error('Shift yÃ¼kleme hatasÄ±:', e); 
        container.innerHTML = `<p style="color:var(--red);text-align:center;padding:40px">âŒ YÃ¼kleme hatasÄ±: ${e.message}</p>`; 
    }
}

function renderShiftTable(shift, docId) {
    const container = document.getElementById('shiftTableContainer');
    const days = ['Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi', 'Pazar'];
    const daysShort = ['Pzt', 'Sal', 'Ã‡ar', 'Per', 'Cum', 'Cmt', 'Paz'];
    const personelShifts = shift.personelShifts || {};
    
    // Barista kontrolÃ¼ - salt okunur mod
    const isBarista = currentUser?.role === 'barista';
    
    // Åžube bazlÄ± saat kurallarÄ±
    const isTuzla = (shift.branch || '').toLowerCase().includes('tuzla');
    const saatKurali = isTuzla 
        ? 'AÃ‡ILIÅž: 09:50-18:50 | Pzt-Per-Paz KAPANIÅž: 16:00-01:00 | Cum-Cmt KAPANIÅž: 16:30-01:30'
        : 'AÃ‡ILIÅž: 09:50-18:50 | KAPANIÅž: 16:30-01:30';
    
    // SÄ±ralama: personelOrder varsa kullan, yoksa Object.keys
    let personelNames = shift.personelOrder || Object.keys(personelShifts);
    // personelOrder'da olmayan ama personelShifts'te olan isimleri de ekle
    Object.keys(personelShifts).forEach(name => {
        if (!personelNames.includes(name)) personelNames.push(name);
    });
    // personelShifts'te olmayan isimleri Ã§Ä±kar
    personelNames = personelNames.filter(name => personelShifts[name]);
    
    const specialRequests = shift.specialRequests || [];
    
    if (personelNames.length === 0) {
        container.innerHTML = `
            <div style="text-align:center;padding:40px">
                <div style="font-size:3rem;margin-bottom:16px">ðŸ“‹</div>
                <div style="color:var(--tx2);margin-bottom:16px">Bu haftaya henÃ¼z personel eklenmemiÅŸ.</div>
                <button class="btn btn-primary" onclick="addPersonelToShift('${docId}')">+ Personel Ekle</button>
            </div>`;
        return;
    }
    
    // PDF iÃ§in wrapper
    const weekLabelWithYear = formatWeekWithYear(shift.weekLabel, shift.weekStart);
    let html = `<div id="shiftTablePrint">
        <!-- PDF Header (print only) -->
        <div id="shiftPdfHeader" style="display:none;text-align:center;margin-bottom:20px;padding-bottom:16px;border-bottom:2px solid #ff8674">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
                <img src="https://static.wixstatic.com/media/760af2_cb121a61291f4f07adb48cfb70f3e2d9~mv2.png" style="width:45px;height:40px;object-fit:contain" onerror="this.style.display='none'">
                <h2 style="color:#ff8674;margin:0;font-size:1.4rem">Moonberry Coffee - ${shift.branch}</h2>
            </div>
            <p style="color:#666;margin:0;font-size:1rem">Shift PlanÄ±: ${weekLabelWithYear}</p>
        </div>
        
        <!-- Shift Tablosu -->
        <div style="overflow-x:auto">
            <table id="shiftMainTable" style="width:100%;border-collapse:collapse;font-size:.85rem;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.1)">
                <thead>
                    <tr style="background:linear-gradient(135deg,#00B050,#008040)">
                        <th style="padding:14px 12px;text-align:left;color:#fff;font-weight:600;font-size:.9rem;border-right:1px solid rgba(255,255,255,.2);background:#00B050">
                            <div style="font-size:.75rem;opacity:.8">SHIFT</div>
                            <div>${weekLabelWithYear}</div>
                        </th>
                        ${days.map((d, i) => `<th style="padding:14px 8px;text-align:center;color:#000;font-weight:600;font-size:.8rem;background:#FFFF00;border:1px solid #ccc">${daysShort[i]}<br><span style="font-size:.65rem;font-weight:400">${d}</span></th>`).join('')}
                    </tr>
                </thead>
                <tbody>`;
    
    personelNames.forEach((uniqueIdOrName, idx) => {
        const p = personelShifts[uniqueIdOrName];
        const rowBg = idx % 2 === 0 ? '#fff' : '#f9f9f9';
        
        // GÃ¶rÃ¼ntÃ¼ adÄ±: 1. personelNames map, 2. global cache lookup, 3. key kendisi
        let displayName = shift.personelNames?.[uniqueIdOrName];
        if (!displayName || displayName === uniqueIdOrName) {
            // Cache'ten doÄŸru displayName'i al (codeName varsa onu kullanÄ±r)
            displayName = lookupPersonelDisplay(uniqueIdOrName, shift.branch);
        }
        
        // SÃ¼rÃ¼kle-bÄ±rak iÃ§in TR Ã¶zellikleri (Barista iÃ§in devre dÄ±ÅŸÄ±)
        const dragAttrs = isBarista ? '' : `draggable="true" 
            ondragstart="handleShiftDragStart(event, '${docId}', ${idx})" 
            ondragover="handleShiftDragOver(event)" 
            ondrop="handleShiftDrop(event, '${docId}', ${idx})"
            ondragend="handleShiftDragEnd(event)"
            style="cursor:grab"`;
        
        html += `<tr ${dragAttrs} data-idx="${idx}" data-key="${uniqueIdOrName}" style="background:${rowBg}">
            <td style="padding:12px;font-weight:600;color:#333;border:1px solid #ddd;background:#FFFF00;min-width:100px;${isBarista ? '' : 'cursor:grab'}">
                ${isBarista ? '' : '<span style="opacity:0.4;margin-right:4px">â˜°</span>'}${displayName}
            </td>`;
        
        days.forEach((_, dayIdx) => {
            let val = p[dayIdx] || '';
            // YÄ±ldÄ±z kontrolÃ¼
            const hasStar = val.includes('*') && !/^\*+$/.test(val);
            const cleanVal = val.replace(/\*/g, '').trim();
            // **** gibi deÄŸerler veya boÅŸ = boÅŸ gÃ¶ster
            const isEmpty = !val || /^\*+$/.test(val.trim());
            const displayVal = isEmpty ? '' : cleanVal;
            const colors = isEmpty ? {bg:'#fff',border:'#ddd',text:'#999'} : getShiftColorExcel(cleanVal);
            
            // OFF gÃ¼nlerde de yÄ±ldÄ±z gÃ¶ster
            const isOff = cleanVal.toUpperCase() === 'OFF' || cleanVal.toUpperCase().includes('Ä°ZÄ°N');
            const showStar = hasStar || isOff;
            
            // YÄ±ldÄ±zlÄ± veya OFF deÄŸer iÃ§in border
            const borderStyle = showStar ? `3px solid #ff8674` : `2px solid ${colors.border}`;
            const starIndicator = showStar ? 'â­' : '';
            
            html += `<td style="padding:4px;text-align:center;border:1px solid #ddd;min-width:90px">
                <select ${isBarista ? 'disabled' : ''} onchange="updateShiftCell('${docId}','${uniqueIdOrName}',${dayIdx},this.value)" 
                    style="width:100%;padding:8px 2px;border:${borderStyle};background:${colors.bg};color:${colors.text};border-radius:6px;font-size:.75rem;font-weight:600;cursor:${isBarista ? 'not-allowed' : 'pointer'};text-align:center;${isBarista ? 'opacity:.8;' : ''}">
                    <option value="" ${isEmpty ? 'selected' : ''} style="background:#fff;color:#999"></option>
                    <optgroup label="â”€â”€ Shift TÃ¼rleri â”€â”€" style="background:#f5f5f5">
                        <option value="AÃ‡ILIÅž" ${displayVal === 'AÃ‡ILIÅž' && !hasStar ? 'selected' : ''} style="background:#99CCFF;color:#003366;font-weight:bold">AÃ‡ILIÅž</option>
                        <option value="ARA" ${displayVal === 'ARA' && !hasStar ? 'selected' : ''} style="background:#FFFF99;color:#666600;font-weight:bold">ARA</option>
                        <option value="KAPANIÅž" ${displayVal === 'KAPANIÅž' && !hasStar ? 'selected' : ''} style="background:#FFC000;color:#663300;font-weight:bold">KAPANIÅž</option>
                        <option value="OFF" ${displayVal === 'OFF' && !hasStar ? 'selected' : ''} style="background:#FF6666;color:#fff;font-weight:bold">OFF</option>
                        <option value="Y.Ä°" ${displayVal === 'Y.Ä°' && !hasStar ? 'selected' : ''} style="background:#D9EAD3;color:#274E13;font-weight:bold">Y.Ä°</option>
                        <option value="RAPOR" ${displayVal === 'RAPOR' && !hasStar ? 'selected' : ''} style="background:#F4CCCC;color:#990000;font-weight:bold">RAPOR</option>
                        <option value="BÃ–LGE MÃœDÃœRÃœ" ${displayVal === 'BÃ–LGE MÃœDÃœRÃœ' && !hasStar ? 'selected' : ''} style="background:#E1BEE7;color:#6A1B9A;font-weight:bold">BÃ–LGE MÃœDÃœRÃœ</option>
                        <option value="BÃ–LGE MÃœD" ${displayVal === 'BÃ–LGE MÃœD' && !hasStar ? 'selected' : ''} style="background:#E1BEE7;color:#6A1B9A;font-weight:bold">BÃ–LGE MÃœD</option>
                        <option value="BÃ–LGE M" ${displayVal === 'BÃ–LGE M' && !hasStar ? 'selected' : ''} style="background:#E1BEE7;color:#6A1B9A;font-weight:bold">BÃ–LGE M</option>
                        <option value="TUZLA" ${displayVal === 'TUZLA' && !hasStar ? 'selected' : ''} style="background:#E6B8AF;color:#660000;font-weight:bold">TUZLA</option>
                    </optgroup>
                    <optgroup label="â”€â”€ â­ Ã–zel Ä°stek â”€â”€" style="background:#fff3e0">
                        <option value="*AÃ‡ILIÅž" ${displayVal === 'AÃ‡ILIÅž' && hasStar ? 'selected' : ''} style="background:#99CCFF;color:#003366">â­ AÃ‡ILIÅž</option>
                        <option value="*ARA" ${displayVal === 'ARA' && hasStar ? 'selected' : ''} style="background:#FFFF99;color:#666600">â­ ARA</option>
                        <option value="*KAPANIÅž" ${displayVal === 'KAPANIÅž' && hasStar ? 'selected' : ''} style="background:#FFC000;color:#663300">â­ KAPANIÅž</option>
                        <option value="*OFF" ${displayVal === 'OFF' && hasStar ? 'selected' : ''} style="background:#FF6666;color:#fff">â­ OFF</option>
                        <option value="*Y.Ä°" ${displayVal === 'Y.Ä°' && hasStar ? 'selected' : ''} style="background:#D9EAD3;color:#274E13">â­ Y.Ä°</option>
                        <option value="*RAPOR" ${displayVal === 'RAPOR' && hasStar ? 'selected' : ''} style="background:#F4CCCC;color:#990000">â­ RAPOR</option>
                        <option value="*BÃ–LGE MÃœDÃœRÃœ" ${displayVal === 'BÃ–LGE MÃœDÃœRÃœ' && hasStar ? 'selected' : ''} style="background:#E1BEE7;color:#6A1B9A">â­ BÃ–LGE MÃœDÃœRÃœ</option>
                        <option value="*BÃ–LGE M" ${displayVal === 'BÃ–LGE M' && hasStar ? 'selected' : ''} style="background:#E1BEE7;color:#6A1B9A">â­ BÃ–LGE M</option>
                        <option value="*TUZLA" ${displayVal === 'TUZLA' && hasStar ? 'selected' : ''} style="background:#E6B8AF;color:#660000">â­ TUZLA</option>
                    </optgroup>
                    <optgroup label="â”€â”€ Saatler â”€â”€" style="background:#e3f2fd">
                        ${COMMON_TIMES.map(t => `<option value="${t}" ${cleanVal === t && !hasStar ? 'selected' : ''} style="background:#E8F4FD;color:#1E5B94">${t}</option>`).join('')}
                    </optgroup>
                    <optgroup label="â”€â”€ â­ Ã–zel Saat â”€â”€" style="background:#fff8e1">
                        ${COMMON_TIMES.map(t => `<option value="*${t}" ${cleanVal === t && hasStar ? 'selected' : ''} style="background:#FFF3E0;color:#E65100">â­ ${t}</option>`).join('')}
                    </optgroup>
                    ${cleanVal && !['AÃ‡ILIÅž','ARA','KAPANIÅž','OFF','Y.Ä°','RAPOR','BÃ–LGE MÃœDÃœRÃœ','BÃ–LGE MÃœD','BÃ–LGE M','TUZLA'].includes(displayVal) && !COMMON_TIMES.includes(cleanVal) ? `<option value="${val}" selected style="background:${colors.bg};color:${colors.text};font-weight:700">${starIndicator}${displayVal}</option>` : ''}
                    <optgroup label="â”€â”€ DiÄŸer â”€â”€" style="background:#eceff1">
                        <option value="parttime" style="color:#546e7a">Ã–zel Saat Gir...</option>
                    </optgroup>
                </select>
            </td>`;
        });
        html += '</tr>';
    });
    
    html += `</tbody></table></div>`;
    
    // Personel Ekle/Ã‡Ä±kar butonlarÄ± (shift tablosunun hemen altÄ±nda) - Barista iÃ§in gizle
    if (!isBarista) {
        html += `<div style="display:flex;gap:10px;margin:16px 0;justify-content:center">
            <button class="btn btn-primary btn-sm" onclick="addPersonelToShift('${docId}')" style="padding:8px 16px;font-size:.8rem">âž• Personel Ekle</button>
            <button class="btn btn-ghost btn-sm" onclick="removePersonelFromShiftModal('${docId}')" style="padding:8px 16px;font-size:.8rem">âž– Personel Ã‡Ä±kar</button>
        </div>`;
    }
    
    // Shift KurallarÄ± bÃ¶lÃ¼mÃ¼ (dÃ¼zenlenebilir)
    html += `<div id="shiftAnnouncements" style="margin-top:20px;padding:16px;background:var(--bg2);border-radius:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <div style="font-weight:600;color:var(--tx);font-size:.9rem">ðŸ“¢ Shift KurallarÄ±</div>
            ${!isBarista ? `<button class="btn btn-ghost btn-sm" onclick="editShiftRules('${docId}')" style="padding:4px 10px;font-size:.75rem">âœï¸ DÃ¼zenle</button>` : ''}
        </div>
        <div id="shiftRulesContent" style="display:flex;flex-direction:column;gap:8px">
            ${(shift.customRules || SHIFT_ANNOUNCEMENTS).map((a, i) => `
                <div style="padding:10px 14px;background:${a.bg};color:${a.color};border-radius:8px;font-size:.8rem;font-weight:500">
                    ${a.text}
                </div>
            `).join('')}
        </div>
        <div style="margin-top:12px;padding:10px 14px;background:#E3F2FD;color:#1565C0;border-radius:8px;font-size:.8rem">
            <strong>Saat Bilgisi:</strong> ${saatKurali} | *YEMEK: 45DK, MOLA: 1x15DK
        </div>
    </div>`;
    
    // Ã–zel istekleri grupla (aynÄ± personel + aynÄ± neden = tek satÄ±r)
    const groupedRequests = {};
    specialRequests.forEach((r, i) => {
        const key = `${r.personel}|||${r.reason}`;
        if (!groupedRequests[key]) {
            groupedRequests[key] = { personel: r.personel, reason: r.reason, days: [], indices: [] };
        }
        if (r.day !== null && r.day !== undefined) {
            groupedRequests[key].days.push(days[r.day]);
        }
        groupedRequests[key].indices.push(i);
    });
    const groupedList = Object.values(groupedRequests);
    
    // Ã–zel Ä°stek GÃ¼nleri bÃ¶lÃ¼mÃ¼
    html += `<div id="shiftSpecialRequests" style="margin-top:16px;padding:16px;background:#FFF8E1;border:2px solid #FFB300;border-radius:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <div style="font-weight:600;color:#E65100;font-size:.9rem">â­ Ã–zel Ä°stek GÃ¼nleri</div>
            ${!isBarista ? `<button class="btn btn-primary btn-sm" onclick="addSpecialRequest('${docId}')" style="padding:4px 10px;font-size:.75rem;background:#FF9800">+ Ã–zel Ä°stek Ekle</button>` : ''}
        </div>
        <div style="font-size:.75rem;color:#795548;margin-bottom:10px;padding:6px 10px;background:rgba(0,0,0,.05);border-radius:6px">
            SHIFT'E YILDIZ (*) SEMBOLÃœ OLAN GÃœNLER Ã–ZEL Ä°STEK GÃœNLERÄ°DÄ°R.
        </div>
        <div id="specialRequestsList" style="display:flex;flex-direction:column;gap:8px">
            ${groupedList.length > 0 ? groupedList.map((r, gi) => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:#fff;border-radius:8px;border:1px solid #FFB300">
                    <div>
                        <span style="font-weight:600;color:#E65100">${r.personel}</span>
                        <span style="color:#888;margin:0 6px;font-size:.8rem">${r.days.length > 0 ? r.days.join(', ') : 'TÃ¼m Hafta'}</span>
                        <span style="color:#666;margin:0 4px">â†’</span>
                        <span style="color:#333;font-weight:500">${r.reason}</span>
                    </div>
                    ${!isBarista ? `<button onclick="removeSpecialRequestGroup('${docId}', '${r.personel}', '${r.reason}')" style="background:none;border:none;color:#E53935;cursor:pointer;font-size:1rem" title="Bu isteÄŸi sil">Ã—</button>` : ''}
                </div>
            `).join('') : `
                <div style="text-align:center;padding:16px;color:#795548;font-size:.85rem">
                    HenÃ¼z Ã¶zel istek eklenmemiÅŸ.
                </div>
            `}
        </div>
    </div>`;
    
    html += `</div>`; // shiftTablePrint close
    
    container.innerHTML = html;
}

// ==================== SÃœRÃœKLE-BIRAK FONKSÄ°YONLARI ====================
let draggedShiftRowIdx = null;
let draggedShiftDocId = null;

function handleShiftDragStart(e, docId, idx) {
    draggedShiftRowIdx = idx;
    draggedShiftDocId = docId;
    e.target.style.opacity = '0.5';
    e.target.style.background = '#e3f2fd';
    e.dataTransfer.effectAllowed = 'move';
}

function handleShiftDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    const tr = e.target.closest('tr');
    if (tr && tr.dataset.idx !== undefined) {
        tr.style.borderTop = '3px solid #008c95';
    }
}

function handleShiftDrop(e, docId, targetIdx) {
    e.preventDefault();
    const tr = e.target.closest('tr');
    if (tr) tr.style.borderTop = '';
    
    if (draggedShiftDocId !== docId) return;
    if (draggedShiftRowIdx === null || draggedShiftRowIdx === targetIdx) return;
    
    // SÄ±ralamayÄ± gÃ¼ncelle
    reorderShiftPersonel(docId, draggedShiftRowIdx, targetIdx);
}

function handleShiftDragEnd(e) {
    e.target.style.opacity = '1';
    e.target.style.background = '';
    draggedShiftRowIdx = null;
    draggedShiftDocId = null;
    
    // TÃ¼m border'larÄ± temizle
    document.querySelectorAll('#shiftTableContainer tr').forEach(tr => {
        tr.style.borderTop = '';
    });
}

async function reorderShiftPersonel(docId, fromIdx, toIdx) {
    try {
        const doc = await db.collection('shifts').doc(docId).get();
        if (!doc.exists) return;
        
        const shift = doc.data();
        const personelShifts = shift.personelShifts || {};
        let order = shift.personelOrder || Object.keys(personelShifts);
        
        // HTML'deki gibi filter et - personelShifts'te olmayan kiÅŸileri Ã§Ä±kar
        const filteredOrder = order.filter(name => personelShifts[name]);
        
        // TaÅŸÄ±nacak kiÅŸiyi filteredOrder'dan al
        const movedPerson = filteredOrder[fromIdx];
        if (!movedPerson) {
            console.error('[SÄ±ralama] GeÃ§ersiz fromIdx:', fromIdx);
            return;
        }
        
        // Hedef kiÅŸiyi bul
        const targetPerson = filteredOrder[toIdx];
        
        // Ana order dizisinde gerÃ§ek pozisyonlarÄ± bul
        const realFromIdx = order.indexOf(movedPerson);
        const realToIdx = order.indexOf(targetPerson);
        
        if (realFromIdx === -1 || realToIdx === -1) {
            console.error('[SÄ±ralama] Pozisyon bulunamadÄ±:', movedPerson, targetPerson);
            return;
        }
        
        // TaÅŸÄ±
        const [moved] = order.splice(realFromIdx, 1);
        // realToIdx'in yeni pozisyonunu hesapla (splice sonrasÄ± kayma)
        const adjustedToIdx = realFromIdx < realToIdx ? realToIdx : realToIdx;
        order.splice(adjustedToIdx, 0, moved);
        
        // Kaydet
        await db.collection('shifts').doc(docId).update({
            personelOrder: order
        });
        
        console.log(`[SÄ±ralama] ${moved} taÅŸÄ±ndÄ±: ${fromIdx} â†’ ${toIdx} (gerÃ§ek: ${realFromIdx} â†’ ${adjustedToIdx})`);
        toast('SÄ±ralama gÃ¼ncellendi âœ“', 'success');
        
        // Tabloyu yenile
        loadShiftWeek();
    } catch (e) {
        console.error('SÄ±ralama hatasÄ±:', e);
        toast('SÄ±ralama hatasÄ±!', 'error');
    }
}

// Excel renk sistemi
function getShiftColorExcel(val) {
    if (!val) return SHIFT_COLORS.default;
    
    // **** gibi deÄŸerler OFF olarak kabul edilsin
    if (/^\*+$/.test(val.trim())) return SHIFT_COLORS.OFF;
    
    const upperVal = val.toUpperCase().trim();
    
    // Tam eÅŸleÅŸme
    if (SHIFT_COLORS[upperVal]) return SHIFT_COLORS[upperVal];
    
    // KÄ±smi eÅŸleÅŸme
    if (upperVal.includes('AÃ‡ILIÅž') || upperVal.includes('ACILIS')) return SHIFT_COLORS.AÃ‡ILIÅž;
    if (upperVal.includes('KAPANIÅž') || (upperVal.includes('KAPANIÅž') || upperVal.includes('KAPANIS'))) return SHIFT_COLORS.KAPANIÅž;
    if (upperVal.includes('OFF') || upperVal.includes('Ä°ZÄ°N') || upperVal.includes('IZIN')) return SHIFT_COLORS.OFF;
    if (upperVal.includes('ARA') || upperVal.includes('ARACI')) return SHIFT_COLORS.ARA;
    if (upperVal.includes('TUZLA')) return SHIFT_COLORS.TUZLA;
    if (upperVal.includes('BÃ–LGE MÃœDÃœRÃœ') || upperVal.includes('BOLGE MUDURU')) return SHIFT_COLORS['BÃ–LGE MÃœDÃœRÃœ'];
    if (upperVal.includes('BÃ–LGE') || upperVal.includes('BOLGE')) return SHIFT_COLORS.BÃ–LGE;
    if (upperVal.includes('RAPOR')) return SHIFT_COLORS.RAPOR;
    if (upperVal.includes('Y.Ä°') || upperVal.includes('YILLIK')) return SHIFT_COLORS['Y.Ä°'];
    
    // Saat formatÄ± (Ã¶rn: 10:00 - 19:00)
    if (/\d{1,2}:\d{2}/.test(val)) {
        return { bg: '#E8F4FD', border: '#4A90D9', text: '#1E5B94' }; // Mavi tonu
    }
    
    return SHIFT_COLORS.default;
}

// Shift deÄŸerini gÃ¶rÃ¼ntÃ¼leme formatÄ±na Ã§evir (**** -> OFF)
function formatShiftValue(val) {
    if (!val) return '';
    if (/^\*+$/.test(val.trim())) return 'OFF';
    return val;
}

async function updateShiftCell(docId, name, dayIdx, value, keepStar = false) {
    if (value === 'parttime') { 
        // Part-time saat seÃ§ici modal
        const startOpts = PARTTIME_START.map(t => `<option value="${t}">${t}</option>`).join('');
        const endOpts = PARTTIME_END.map(t => `<option value="${t}">${t}</option>`).join('');
        
        showModal('Ã–zel Saat Gir', `
            <div style="padding:8px 0">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                    <div class="form-group">
                        <label class="form-label">BaÅŸlangÄ±Ã§</label>
                        <select id="parttimeStart" class="form-select" style="font-size:1rem">${startOpts}</select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">BitiÅŸ</label>
                        <select id="parttimeEnd" class="form-select" style="font-size:1rem">${endOpts}</select>
                    </div>
                </div>
                <div style="margin-top:12px">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                        <input type="checkbox" id="parttimeStar" ${keepStar ? 'checked' : ''} style="width:18px;height:18px">
                        <span>â­ Ã–zel istek olarak iÅŸaretle</span>
                    </label>
                </div>
            </div>
        `, `<button class="btn btn-ghost" onclick="closeModal();loadShiftWeek()">Ä°ptal</button>
            <button class="btn btn-primary" onclick="confirmParttime('${docId}','${name}',${dayIdx})">Kaydet</button>`);
        return;
    }
    try {
        const doc = await db.collection('shifts').doc(docId).get();
        const data = doc.data();
        if (!data.personelShifts) data.personelShifts = {};
        if (!data.personelShifts[name]) data.personelShifts[name] = {};
        // YÄ±ldÄ±z koruma
        const finalValue = keepStar && value ? '*' + value : value;
        data.personelShifts[name][dayIdx] = finalValue;
        await db.collection('shifts').doc(docId).update({ personelShifts: data.personelShifts });
        
        // GÃ¶rev atamalarÄ±nÄ± temizle (yeni shift'e gÃ¶re yeniden oluÅŸturulacak)
        const branch = data.branch || docId.split('_').slice(0, -1).join(' ');
        const weekStart = data.weekStart || '';
        if (weekStart) {
            clearTaskAssignmentsForBranch(branch, weekStart).catch(() => {});
        }
        
        toast('âœ“ Kaydedildi', 'success');
        loadShiftWeek();
    } catch (e) { 
        console.error(e); 
        toast('GÃ¼ncelleme hatasÄ±!', 'error'); 
        loadShiftWeek();
    }
}

// YÄ±ldÄ±z toggle fonksiyonu
async function toggleStar(docId, name, dayIdx, isChecked) {
    try {
        const doc = await db.collection('shifts').doc(docId).get();
        const data = doc.data();
        if (!data.personelShifts || !data.personelShifts[name]) return;
        
        let val = data.personelShifts[name][dayIdx] || '';
        const cleanVal = val.replace(/\*/g, '').trim();
        
        if (!cleanVal) {
            toast('Ã–nce shift seÃ§in', 'error');
            loadShiftWeek();
            return;
        }
        
        const finalValue = isChecked ? '*' + cleanVal : cleanVal;
        data.personelShifts[name][dayIdx] = finalValue;
        
        await db.collection('shifts').doc(docId).update({ personelShifts: data.personelShifts });
        toast(isChecked ? 'â­ Ã–zel istek eklendi' : 'Ã–zel istek kaldÄ±rÄ±ldÄ±', 'success');
        loadShiftWeek();
    } catch (e) { 
        console.error(e); 
        toast('Hata!', 'error'); 
        loadShiftWeek();
    }
}

async function confirmParttime(docId, name, dayIdx) {
    const start = document.getElementById('parttimeStart').value;
    const end = document.getElementById('parttimeEnd').value;
    const hasStar = document.getElementById('parttimeStar')?.checked;
    if (!start || !end) { toast('Saat seÃ§in', 'error'); return; }
    let value = `${start}/${end}`;
    if (hasStar) value = '*' + value;
    closeModal();
    try {
        const doc = await db.collection('shifts').doc(docId).get();
        const data = doc.data();
        if (!data.personelShifts) data.personelShifts = {};
        if (!data.personelShifts[name]) data.personelShifts[name] = {};
        data.personelShifts[name][dayIdx] = value;
        await db.collection('shifts').doc(docId).update({ personelShifts: data.personelShifts });
        toast('âœ“ Part-time saat kaydedildi', 'success');
        loadShiftWeek();
    } catch (e) { 
        console.error(e); 
        toast('GÃ¼ncelleme hatasÄ±!', 'error'); 
    }
}

// Shift kurallarÄ±nÄ± dÃ¼zenleme
function editShiftRules(docId) {
    showModal('Shift KurallarÄ±nÄ± DÃ¼zenle', `
        <div style="padding:8px 0">
            <div class="form-group" style="margin-bottom:12px">
                <label class="form-label">Kural 1 (YeÅŸil)</label>
                <input type="text" id="rule1" class="form-input" value="AÃ‡ILIÅž PERSONELÄ° Ä°ÅžE GEÃ‡ KALMAMALIDIR!">
            </div>
            <div class="form-group" style="margin-bottom:12px">
                <label class="form-label">Kural 2 (YeÅŸil)</label>
                <input type="text" id="rule2" class="form-input" value="Ä°ZÄ°N GÃœNÃœ YOKSA; YEMEK VE MOLA SÃœRESÄ° SEÃ‡Ä°MÄ° PERSONELÄ°N KENDÄ° SEÃ‡Ä°MÄ°NDEDÄ°R.">
            </div>
            <div class="form-group" style="margin-bottom:12px">
                <label class="form-label">Kural 3 (SarÄ±)</label>
                <input type="text" id="rule3" class="form-input" value="SHIFT'E YILDIZ (*) SEMBOLÃœ OLAN GÃœNLER Ã–ZEL Ä°STEK GÃœNLERÄ°DÄ°R.">
            </div>
            <div class="form-group">
                <label class="form-label">Kural 4 (KÄ±rmÄ±zÄ±)</label>
                <input type="text" id="rule4" class="form-input" value="SHIFT YÃ–NETÄ°CÄ°LERÄ°NÄ°ZE BÄ°LGÄ° VERÄ°LMEDEN HABERSÄ°Z DEÄžÄ°ÅžTÄ°RÄ°LEMEZ!">
            </div>
        </div>
    `, `<button class="btn btn-ghost" onclick="closeModal()">Ä°ptal</button>
        <button class="btn btn-primary" onclick="saveShiftRules('${docId}')">Kaydet</button>`);
}

async function saveShiftRules(docId) {
    const rules = [
        { text: document.getElementById('rule1').value, color: '#2E7D32', bg: '#C6EFCE' },
        { text: document.getElementById('rule2').value, color: '#2E7D32', bg: '#C6EFCE' },
        { text: document.getElementById('rule3').value, color: '#9C5700', bg: '#FFEB9C' },
        { text: document.getElementById('rule4').value, color: '#C00000', bg: '#FFC7CE' }
    ];
    closeModal();
    try {
        await db.collection('shifts').doc(docId).update({ customRules: rules });
        toast('Kurallar gÃ¼ncellendi', 'success');
        loadShiftWeek();
    } catch (e) { console.error(e); toast('Hata!', 'error'); }
}

// Ã–zel istek ekleme
async function addSpecialRequest(docId) {
    const days = ['Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi', 'Pazar'];
    
    // Shift'teki personelleri al
    let personelOpts = '<option value="">-- Personel SeÃ§in --</option>';
    try {
        const doc = await db.collection('shifts').doc(docId).get();
        const data = doc.data();
        const names = data.personelOrder || Object.keys(data.personelShifts || {});
        personelOpts += names.map(n => `<option value="${n}">${n}</option>`).join('');
    } catch (e) { console.error(e); }
    
    // Ã‡oklu gÃ¼n seÃ§imi iÃ§in checkbox'lar
    const dayCheckboxes = days.map((d, i) => `
        <label style="display:inline-flex;align-items:center;gap:4px;padding:6px 10px;background:var(--bg3);border-radius:6px;cursor:pointer;font-size:.85rem">
            <input type="checkbox" class="reqDayCheck" value="${i}" style="width:16px;height:16px;cursor:pointer">
            ${d}
        </label>
    `).join('');
    
    showModal('Ã–zel Ä°stek Ekle', `
        <div style="padding:8px 0">
            <div class="form-group" style="margin-bottom:12px">
                <label class="form-label">Personel</label>
                <select id="reqPersonel" class="form-select">${personelOpts}</select>
            </div>
            <div class="form-group" style="margin-bottom:12px">
                <label class="form-label">GÃ¼nler (Ã§oklu seÃ§im yapabilirsiniz)</label>
                <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:6px">
                    ${dayCheckboxes}
                </div>
                <div style="margin-top:6px;font-size:.75rem;color:var(--tx3)">HiÃ§biri seÃ§ilmezse tÃ¼m hafta iÃ§in geÃ§erli olur.</div>
            </div>
            <div class="form-group">
                <label class="form-label">Ä°stek Nedeni</label>
                <input type="text" id="reqReason" class="form-input" placeholder="Ã–rn: OKUL, HASTANE, AÄ°LE vb.">
            </div>
        </div>
    `, `<button class="btn btn-ghost" onclick="closeModal()">Ä°ptal</button>
        <button class="btn btn-primary" onclick="saveSpecialRequest('${docId}')">Ekle</button>`);
}

async function saveSpecialRequest(docId) {
    const personel = document.getElementById('reqPersonel').value.trim();
    const reason = document.getElementById('reqReason').value.trim();
    
    // SeÃ§ili gÃ¼nleri al
    const checkedDays = [];
    document.querySelectorAll('.reqDayCheck:checked').forEach(cb => {
        checkedDays.push(parseInt(cb.value));
    });
    
    if (!personel || !reason) { toast('Personel ve neden gerekli', 'error'); return; }
    
    closeModal();
    try {
        const doc = await db.collection('shifts').doc(docId).get();
        const data = doc.data();
        const requests = data.specialRequests || [];
        
        // Her seÃ§ili gÃ¼n iÃ§in ayrÄ± kayÄ±t ekle (veya hiÃ§ seÃ§ilmediyse null ile tek kayÄ±t)
        if (checkedDays.length === 0) {
            requests.push({ personel, day: null, reason });
        } else {
            checkedDays.forEach(day => {
                requests.push({ personel, day, reason });
            });
        }
        
        await db.collection('shifts').doc(docId).update({ specialRequests: requests });
        toast('Ã–zel istek eklendi', 'success');
        loadShiftWeek();
    } catch (e) { console.error(e); toast('Hata!', 'error'); }
}

async function removeSpecialRequest(docId, idx) {
    if (!confirm('Bu Ã¶zel isteÄŸi silmek istediÄŸinize emin misiniz?')) return;
    try {
        const doc = await db.collection('shifts').doc(docId).get();
        const data = doc.data();
        const requests = data.specialRequests || [];
        requests.splice(idx, 1);
        await db.collection('shifts').doc(docId).update({ specialRequests: requests });
        toast('Ã–zel istek silindi', 'success');
        loadShiftWeek();
    } catch (e) { console.error(e); toast('Hata!', 'error'); }
}

// Gruplu Ã¶zel isteÄŸi sil (aynÄ± personel + reason olan tÃ¼m kayÄ±tlar)
async function removeSpecialRequestGroup(docId, personel, reason) {
    if (!confirm(`${personel} iÃ§in "${reason}" isteÄŸini silmek istediÄŸinize emin misiniz?`)) return;
    try {
        const doc = await db.collection('shifts').doc(docId).get();
        const data = doc.data();
        const requests = data.specialRequests || [];
        // EÅŸleÅŸenleri filtrele
        const filteredRequests = requests.filter(r => !(r.personel === personel && r.reason === reason));
        await db.collection('shifts').doc(docId).update({ specialRequests: filteredRequests });
        toast('Ã–zel istek silindi', 'success');
        loadShiftWeek();
    } catch (e) { console.error(e); toast('Hata!', 'error'); }
}

async function addPersonelToShift(docId) {
    // MaÄŸazadaki personel listesini getir (ÅŸube bazlÄ±)
    const sube = document.getElementById('shiftSube').value;
    try {
        const pSnap = await db.collection('personel').get();
        const personelList = [];
        pSnap.forEach(d => {
            const p = d.data();
            if (p.branch === sube) {
                // getPersonelDisplayName: codeName varsa onu, yoksa "Ad S." formatÄ±
                const displayName = getPersonelDisplayName(p);
                // uniqueId yoksa oluÅŸtur
                const uniqueId = p.uniqueId || normalizePersonelId(p.name);
                personelList.push({ 
                    name: p.name,
                    codeName: p.codeName,
                    displayName, 
                    uniqueId,
                    role: p.role,
                    docId: d.id
                });
            }
        });
        
        // SADECE RÃœTBEYE GÃ–RE sÄ±rala
        const roleOrder = ['bolge_muduru', 'magaza_muduru', 'magaza_muduru_yardimcisi', 'kidemli_barista', 'barista', 'part_time'];
        personelList.sort((a, b) => {
            const aRoleIdx = roleOrder.indexOf(a.role);
            const bRoleIdx = roleOrder.indexOf(b.role);
            // undefined role (-1) en sona gitsin
            const aIdx = aRoleIdx === -1 ? 100 : aRoleIdx;
            const bIdx = bRoleIdx === -1 ? 100 : bRoleIdx;
            return aIdx - bIdx;
        });
        
        // Global'e kaydet (confirmAddPersonel'de kullanÄ±lacak)
        window._shiftPersonelList = personelList;
        
        if (personelList.length === 0) {
            const name = prompt('Personel adÄ± girin:');
            if (name) await doAddPersonel(docId, name, name, normalizePersonelId(name));
            return;
        }
        
        // Modal ile seÃ§im - uniqueId'yi value olarak kullan
        const opts = personelList.map(p => `<option value="${p.uniqueId}" data-display="${p.displayName}" data-fullname="${p.name}">${p.displayName} (${p.name})</option>`).join('');
        showModal('Personel Ekle', `
            <div style="padding:8px 0">
                <div class="form-group" style="margin-bottom:16px">
                    <label class="form-label">${sube} Personeli</label>
                    <select id="addPersonelSelect" class="form-select">${opts}</select>
                </div>
                <div style="text-align:center;color:var(--tx2);margin:12px 0">- veya -</div>
                <div class="form-group">
                    <label class="form-label">GeÃ§ici Personel (Manuel)</label>
                    <input type="text" id="addPersonelManual" class="form-input" placeholder="Kod adÄ± girin">
                </div>
            </div>
        `, `<button class="btn btn-ghost" onclick="closeModal()">Ä°ptal</button>
            <button class="btn btn-primary" onclick="confirmAddPersonel('${docId}')">Ekle</button>`);
    } catch (e) {
        const name = prompt('Personel adÄ± girin:');
        if (name) await doAddPersonel(docId, name, name, normalizePersonelId(name));
    }
}

async function confirmAddPersonel(docId) {
    const select = document.getElementById('addPersonelSelect');
    const manual = document.getElementById('addPersonelManual');
    
    if (manual.value.trim()) {
        // Manuel giriÅŸ - ad olarak kullan
        const manualName = manual.value.trim();
        closeModal();
        await doAddPersonel(docId, manualName, manualName, normalizePersonelId(manualName));
    } else if (select.value) {
        // SeÃ§ili personel
        const uniqueId = select.value;
        const displayName = select.selectedOptions[0]?.dataset?.display || uniqueId;
        const fullName = select.selectedOptions[0]?.dataset?.fullname || displayName;
        closeModal();
        await doAddPersonel(docId, displayName, fullName, uniqueId);
    } else {
        toast('Personel seÃ§in veya girin', 'error');
    }
}

async function doAddPersonel(docId, displayName, fullName, uniqueId) {
    try {
        const doc = await db.collection('shifts').doc(docId).get();
        const data = doc.data();
        if (!data.personelShifts) data.personelShifts = {};
        if (!data.personelNames) data.personelNames = {};
        if (!data.personelFullNames) data.personelFullNames = {};
        
        // uniqueId ile kontrol
        if (data.personelShifts[uniqueId]) {
            toast('Bu personel zaten mevcut', 'error');
            return;
        }
        
        // uniqueId key olarak kullan
        data.personelShifts[uniqueId] = {};
        data.personelNames[uniqueId] = displayName;
        data.personelFullNames[uniqueId] = fullName;
        
        await db.collection('shifts').doc(docId).update({ 
            personelShifts: data.personelShifts,
            personelNames: data.personelNames,
            personelFullNames: data.personelFullNames
        });
        toast('Personel eklendi', 'success');
        loadShiftWeek();
    } catch (e) { console.error(e); toast('Ekleme hatasÄ±!', 'error'); }
}

// Alias fonksiyon
const removePersonelFromShiftModal = removePersonelFromShift;

async function removePersonelFromShift(docId) {
    try {
        const doc = await db.collection('shifts').doc(docId).get();
        const data = doc.data();
        const uniqueIds = Object.keys(data.personelShifts || {});
        if (uniqueIds.length === 0) { toast('Silinecek personel yok', 'error'); return; }
        
        // uniqueId -> gÃ¶rÃ¼ntÃ¼ adÄ± eÅŸlemesi
        const personelNames = data.personelNames || {};
        const personelFullNames = data.personelFullNames || {};
        
        const opts = uniqueIds.map(uid => {
            // Ã–nce personelNames (codeName), sonra fullName, en son uniqueId
            const displayName = personelNames[uid] || formatDisplayName(personelFullNames[uid] || uid.replace(/_/g, ' '));
            return `<option value="${uid}">${displayName}</option>`;
        }).join('');
        
        showModal('Personel Ã‡Ä±kar', `
            <div style="padding:8px 0">
                <div class="form-group">
                    <label class="form-label">Ã‡Ä±karÄ±lacak Personel</label>
                    <select id="removePersonelSelect" class="form-select">${opts}</select>
                </div>
                <div style="margin-top:12px;padding:12px;background:rgba(231,76,60,.1);border-radius:8px;color:var(--red);font-size:.85rem">
                    âš ï¸ Bu iÅŸlem geri alÄ±namaz. Personelin tÃ¼m shift verileri silinecek.
                </div>
            </div>
        `, `<button class="btn btn-ghost" onclick="closeModal()">Ä°ptal</button>
            <button class="btn btn-primary" style="background:var(--red)" onclick="confirmRemovePersonel('${docId}')">Ã‡Ä±kar</button>`);
    } catch (e) { console.error(e); }
}

async function confirmRemovePersonel(docId) {
    const uniqueIdOrName = document.getElementById('removePersonelSelect').value;
    if (!uniqueIdOrName) return;
    closeModal();
    try {
        const doc = await db.collection('shifts').doc(docId).get();
        const data = doc.data();
        
        // personelShifts'ten sil
        delete data.personelShifts[uniqueIdOrName];
        
        // personelNames ve personelFullNames'ten de sil (varsa)
        if (data.personelNames) delete data.personelNames[uniqueIdOrName];
        if (data.personelFullNames) delete data.personelFullNames[uniqueIdOrName];
        
        await db.collection('shifts').doc(docId).update({ 
            personelShifts: data.personelShifts,
            personelNames: data.personelNames || {},
            personelFullNames: data.personelFullNames || {}
        });
        toast('Personel Ã§Ä±karÄ±ldÄ±', 'success');
        loadShiftWeek();
    } catch (e) { console.error(e); toast('Silme hatasÄ±!', 'error'); }
}

function showNewShiftModal() {
    const userBranch = currentUser?.branch;
    const isAdmin = currentUser?.role === 'yonetici' || currentUser?.role === 'bolge_muduru';
    let branches = STATE.branches || [];
    if (!isAdmin && userBranch) branches = branches.filter(b => b === userBranch);
    
    const selectedSube = document.getElementById('shiftSube').value || branches[0] || '';
    const opts = branches.map(s => `<option value="${s}" ${s === selectedSube ? 'selected' : ''}>${s}</option>`).join('');
    
    // Hafta seÃ§enekleri (sadece bu hafta + gelecek 8 hafta)
    const weekOpts = [];
    const today = new Date();
    for (let i = 0; i <= 8; i++) {
        const monday = new Date(today);
        // Pazartesi'yi bul (getDay: 0=Pazar, 1=Pazartesi...)
        const dayOfWeek = monday.getDay();
        const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
        monday.setDate(monday.getDate() + diff + (i * 7));
        
        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);
        
        const label = `${monday.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long' })} - ${sunday.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long' })}`;
        const monStr = formatDateLocal(monday);  // Timezone-safe
        const sunStr = formatDateLocal(sunday);  // Timezone-safe
        const isCurrent = i === 0;
        const isNext = i === 1;
        
        weekOpts.push(`<option value="${monStr}|${sunStr}" ${isNext ? 'selected' : ''}>${label}${isCurrent ? ' (Bu Hafta)' : ''}${isNext ? ' âœ“ Gelecek Hafta' : ''}</option>`);
    }
    
    showModal('Yeni Shift HaftasÄ±', `
        <div style="padding:8px 0">
            <div class="form-group" style="margin-bottom:16px">
                <label class="form-label">MaÄŸaza</label>
                <select id="newShiftSube" class="form-select">${opts}</select>
            </div>
            <div class="form-group" style="margin-bottom:16px">
                <label class="form-label">Hafta (Pazartesi - Pazar)</label>
                <select id="newShiftWeekSelect" class="form-select">${weekOpts.join('')}</select>
            </div>
            <div class="form-group">
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                    <input type="checkbox" id="newShiftCopy" checked>
                    <span>Ã–nceki haftadan personel listesini kopyala</span>
                </label>
            </div>
        </div>
    `, `<button class="btn btn-ghost" onclick="closeModal()">Ä°ptal</button>
        <button class="btn btn-primary" onclick="createNewShift()">OluÅŸtur</button>`);
}

async function createNewShift() {
    const sube = document.getElementById('newShiftSube').value;
    const weekVal = document.getElementById('newShiftWeekSelect').value;
    const copy = document.getElementById('newShiftCopy').checked;
    
    if (!sube || !weekVal) { toast('TÃ¼m alanlarÄ± doldurun', 'error'); return; }
    
    const [start, end] = weekVal.split('|');
    
    try {
        // AynÄ± hafta var mÄ± kontrol
        const existingSnap = await db.collection('shifts').get();
        let exists = false;
        existingSnap.forEach(doc => {
            const d = doc.data();
            if (d.branch === sube && d.weekStart === start) exists = true;
        });
        
        if (exists) {
            toast('Bu hafta zaten mevcut!', 'error');
            return;
        }
        
        let ps = {};
        let personelOrder = [];
        let personelNames = {};
        let personelFullNames = {};
        
        // Ã–nceki haftadan kopyala (TÃœM shift verileri dahil)
        if (copy) {
            const allShifts = [];
            existingSnap.forEach(doc => {
                const d = doc.data();
                if (d.branch === sube) allShifts.push(d);
            });
            allShifts.sort((a, b) => (b.weekStart || '').localeCompare(a.weekStart || ''));
            
            if (allShifts.length > 0) {
                const prevShift = allShifts[0];
                // personelOrder'Ä± kopyala
                personelOrder = prevShift.personelOrder || Object.keys(prevShift.personelShifts || {});
                // TÃœM shift verilerini kopyala (gÃ¼nler dahil)
                ps = JSON.parse(JSON.stringify(prevShift.personelShifts || {}));
                // personelNames ve personelFullNames kopyala
                personelNames = JSON.parse(JSON.stringify(prevShift.personelNames || {}));
                personelFullNames = JSON.parse(JSON.stringify(prevShift.personelFullNames || {}));
            }
        }
        
        // Personel yoksa maÄŸazadaki personelden al (rÃ¼tbeye gÃ¶re sÄ±rala)
        if (Object.keys(ps).length === 0) {
            const pSnap = await db.collection('personel').get();
            const personelList = [];
            const bolgeMudurleri = [];
            
            pSnap.forEach(d => {
                const p = d.data();
                // BÃ¶lge mÃ¼dÃ¼rlerini ayrÄ± tut - TÃœM ÅŸubelere eklenecek
                if (p.role === 'bolge_muduru') {
                    bolgeMudurleri.push(p);
                }
                // Bu ÅŸubenin personelini ekle
                if (p.branch === sube) {
                    personelList.push(p);
                }
            });
            
            // BÃ¶lge mÃ¼dÃ¼rlerini listeye ekle (zaten yoksa)
            bolgeMudurleri.forEach(bm => {
                if (!personelList.find(p => p.name === bm.name)) {
                    personelList.push(bm);
                }
            });
            
            // RÃœTBEYE GÃ–RE sÄ±rala
            const roleOrder = ['bolge_muduru', 'magaza_muduru', 'magaza_muduru_yardimcisi', 'kidemli_barista', 'barista', 'part_time'];
            personelList.sort((a, b) => {
                const aRoleIdx = roleOrder.indexOf(a.role);
                const bRoleIdx = roleOrder.indexOf(b.role);
                const aIdx = aRoleIdx === -1 ? 100 : aRoleIdx;
                const bIdx = bRoleIdx === -1 ? 100 : bRoleIdx;
                return aIdx - bIdx;
            });
            
            personelList.forEach(p => {
                const codeName = p.codeName || formatDisplayName(p.name);
                const uniqueId = p.uniqueId || normalizePersonelId(p.name);
                // KEY OLARAK uniqueId KULLAN (tutarlÄ±lÄ±k iÃ§in)
                ps[uniqueId] = {};
                personelOrder.push(uniqueId);
                personelNames[uniqueId] = codeName;  // GÃ¶rÃ¼ntÃ¼ adÄ±
                personelFullNames[uniqueId] = p.name; // Tam isim
            });
        }
        
        const label = `${new Date(start).toLocaleDateString('tr-TR', {day:'numeric', month:'long'})} - ${new Date(end).toLocaleDateString('tr-TR', {day:'numeric', month:'long'})}`;
        
        const newDoc = await db.collection('shifts').add({ 
            branch: sube, 
            weekStart: start, 
            weekEnd: end, 
            weekLabel: label, 
            personelOrder: personelOrder,
            personelShifts: ps,
            personelNames: personelNames,
            personelFullNames: personelFullNames,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(), 
            createdBy: currentUser?.username || 'admin' 
        });
        
        toast('Yeni hafta oluÅŸturuldu!', 'success');
        closeModal();
        
        // MaÄŸazayÄ± seÃ§ ve listeyi yenile
        document.getElementById('shiftSube').value = sube;
        await loadShiftList();
        
        // Yeni haftayÄ± seÃ§ ve tabloyu yÃ¼kle
        setTimeout(() => {
            const haftaSelect = document.getElementById('shiftHafta');
            haftaSelect.value = newDoc.id;
            // Dropdown'da yeni eklenen seÃ§enek gÃ¶rÃ¼nsÃ¼n
            if (!haftaSelect.querySelector(`option[value="${newDoc.id}"]`)) {
                const opt = document.createElement('option');
                opt.value = newDoc.id;
                opt.textContent = label + ' (Yeni)';
                opt.selected = true;
                haftaSelect.insertBefore(opt, haftaSelect.options[1]);
            }
            loadShiftWeek();
        }, 500);
        
    } catch (e) { 
        console.error('Shift oluÅŸturma hatasÄ±:', e); 
        toast('OluÅŸturma hatasÄ±: ' + e.message, 'error'); 
    }
}

// PDF Ä°ndir - pdfmake ile renkli tablo
async function downloadShiftPDF() {
    const haftaSelect = document.getElementById('shiftHafta');
    const subeSelect = document.getElementById('shiftSube');
    const docId = haftaSelect?.value;
    
    if (!docId) { 
        toast('Ã–nce bir shift seÃ§in', 'error'); 
        return; 
    }
    
    toast('PDF oluÅŸturuluyor...', 'info');
    
    const branch = subeSelect?.value || '';
    const weekLabel = haftaSelect.selectedOptions[0]?.textContent || '';
    
    // Firebase'den veri al
    let shiftData = null;
    try {
        const doc = await db.collection('shifts').doc(docId).get();
        shiftData = doc.data();
    } catch (e) { 
        console.error(e);
        toast('Shift verisi alÄ±namadÄ±', 'error');
        return;
    }
    
    if (!shiftData) {
        toast('Shift verisi alÄ±namadÄ±', 'error');
        return;
    }
    
    const personelShifts = shiftData.personelShifts || {};
    const personelOrder = shiftData.personelOrder || Object.keys(personelShifts);
    const specialRequests = shiftData.specialRequests || [];
    const customRules = shiftData.customRules || SHIFT_ANNOUNCEMENTS;
    const days = ['Pzt', 'Sal', 'Ã‡ar', 'Per', 'Cum', 'Cmt', 'Paz'];
    const daysLong = ['Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi', 'Pazar'];
    
    // Åžube bazlÄ± saat kurallarÄ±
    const isTuzla = branch.toLowerCase().includes('tuzla');
    const saatKurali = isTuzla 
        ? 'AÃ‡ILIÅž: 09:50-18:50 | Pzt-Per-Paz: 16:00-01:00 | Cum-Cmt: 16:30-01:30'
        : 'AÃ‡ILIÅž: 09:50-18:50 | KAPANIÅž: 16:30-01:30';
    
    // Hex to RGB converter
    function hexToRgb(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? [parseInt(result[1], 16), parseInt(result[2], 16), parseInt(result[3], 16)] : [255, 255, 255];
    }
    
    // Tablo verileri hazÄ±rla
    const tableBody = [];
    
    // Header satÄ±rÄ±
    tableBody.push([
        { text: 'Personel', fillColor: '#00B050', color: '#ffffff', bold: true, alignment: 'center', fontSize: 9 },
        ...days.map(d => ({ text: d, fillColor: '#FFFF00', color: '#000000', bold: true, alignment: 'center', fontSize: 9 }))
    ]);
    
    // Personel satÄ±rlarÄ± - HER HÃœCRE RENK ALACAK
    personelOrder.forEach((name, idx) => {
        if (!personelShifts[name]) return;
        
        // DOÄžRU Ä°SÄ°M: personelNames mapping > lookup > name
        let displayName = shiftData.personelNames?.[name];
        if (!displayName || displayName === name) {
            displayName = lookupPersonelDisplay(name, branch);
        }
        
        const row = [{ text: displayName, fillColor: '#FFFF00', color: '#000000', bold: true, fontSize: 9 }];
        
        for (let dayIdx = 0; dayIdx < 7; dayIdx++) {
            let val = personelShifts[name][dayIdx] || '';
            const hasStar = val.includes('*') && !/^\*+$/.test(val);
            const cleanVal = val.replace(/\*/g, '').trim();
            const isEmpty = !val || /^\*+$/.test(val.trim());
            const isOff = cleanVal.toUpperCase() === 'OFF' || cleanVal.toUpperCase().includes('Ä°ZÄ°N');
            const showStar = hasStar || isOff;
            
            if (isEmpty) {
                row.push({ text: '-', fillColor: '#ffffff', color: '#999999', alignment: 'center', fontSize: 9 });
            } else {
                // Renk al
                const colors = getShiftColorExcel(cleanVal);
                // YÄ±ldÄ±z iÃ§in basit ASCII * kullan (PDF uyumlu)
                const displayText = (showStar ? '* ' : '') + cleanVal;
                
                row.push({ 
                    text: displayText, 
                    fillColor: colors.bg, 
                    color: colors.text, 
                    bold: true,
                    alignment: 'center', 
                    fontSize: 9 
                });
            }
        }
        tableBody.push(row);
    });
    
    // Ã–zel istekleri grupla (aynÄ± personel + aynÄ± neden = tek satÄ±r)
    const groupedRequests = {};
    specialRequests.forEach(r => {
        const key = `${r.personel}|||${r.reason}`;
        if (!groupedRequests[key]) {
            groupedRequests[key] = { personel: r.personel, reason: r.reason, days: [] };
        }
        if (r.day !== null && r.day !== undefined) {
            groupedRequests[key].days.push(daysLong[r.day]);
        }
    });
    
    const ozelIstekler = Object.values(groupedRequests).length > 0 
        ? Object.values(groupedRequests).map(r => {
            const dayStr = r.days.length > 0 ? r.days.join(', ') : 'TÃ¼m Hafta';
            return `â€¢ ${r.personel}: ${dayStr} â†’ ${r.reason}`;
        }).join('\n')
        : 'Bu hafta iÃ§in Ã¶zel istek yok';
    
    // pdfmake dÃ¶kÃ¼man tanÄ±mÄ±
    const docDefinition = {
        pageSize: 'A4',
        pageOrientation: 'landscape',
        pageMargins: [15, 15, 15, 15],
        content: [
            // BaÅŸlÄ±k - Marka renkleri
            { text: 'Moonberry Coffee - ' + branch, fontSize: 16, bold: true, color: '#ff8674' },
            { text: 'Shift PlanÄ±: ' + weekLabel, fontSize: 10, color: '#008c95', margin: [0, 2, 0, 10] },
            
            // Tablo
            {
                table: {
                    headerRows: 1,
                    widths: [80, '*', '*', '*', '*', '*', '*', '*'],
                    body: tableBody
                },
                layout: {
                    hLineWidth: () => 0.5,
                    vLineWidth: () => 0.5,
                    hLineColor: () => '#999999',
                    vLineColor: () => '#999999',
                    paddingLeft: () => 4,
                    paddingRight: () => 4,
                    paddingTop: () => 3,
                    paddingBottom: () => 3
                }
            },
            
            // Kurallar - customRules'tan dinamik
            { text: '', margin: [0, 8, 0, 0] },
            {
                table: {
                    widths: customRules.map(() => 'auto').concat(['auto']),
                    body: [[
                        ...customRules.map(a => ({
                            text: a.text,
                            fillColor: a.bg,
                            color: a.color,
                            fontSize: 7,
                            bold: true,
                            margin: [4, 2, 4, 2]
                        })),
                        { text: saatKurali, fillColor: '#BDE0FE', color: '#1565C0', fontSize: 7, bold: true, margin: [4, 2, 4, 2] }
                    ]]
                },
                layout: 'noBorders'
            },
            
            // Ã–zel Ä°stekler
            { text: '', margin: [0, 8, 0, 0] },
            { text: 'Ã–zel Ä°stek GÃ¼nleri:', fontSize: 9, bold: true, color: '#F57C00' },
            { text: ozelIstekler, fontSize: 8, color: '#E65100', margin: [0, 2, 0, 0] }
        ]
    };
    
    // PDF oluÅŸtur ve indir
    const filename = `Shift_${branch.replace(/\s/g, '_')}_${weekLabel.replace(/\s/g, '_').replace(/[^\w-]/g, '')}.pdf`;
    pdfMake.createPdf(docDefinition).download(filename);
    
    toast('PDF indirildi! âœ“', 'success');
}

// Bu haftayÄ± sil fonksiyonu
async function deleteCurrentShift() {
    const haftaSelect = document.getElementById('shiftHafta');
    const subeSelect = document.getElementById('shiftSube');
    const docId = haftaSelect?.value;
    const branch = subeSelect?.value;
    
    if (!docId) {
        toast('Ã–nce bir shift seÃ§in', 'error');
        return;
    }
    
    // Sadece yÃ¶netici silebilir
    if (currentUser?.role !== 'yonetici') {
        toast('Sadece yÃ¶netici shift silebilir', 'error');
        return;
    }
    
    // Sadece en yeni shift silinebilir - kontrol et
    try {
        const shiftsSnap = await db.collection('shifts')
            .where('branch', '==', branch)
            .orderBy('weekStart', 'desc')
            .limit(1)
            .get();
        
        if (shiftsSnap.empty) {
            toast('Silinecek shift bulunamadÄ±', 'error');
            return;
        }
        
        const newestShiftId = shiftsSnap.docs[0].id;
        
        if (docId !== newestShiftId) {
            toast('Sadece en son oluÅŸturulan hafta silinebilir!', 'error');
            return;
        }
    } catch (e) {
        console.error('Kontrol hatasÄ±:', e);
    }
    
    const weekLabel = haftaSelect.selectedOptions[0]?.textContent || '';
    
    // Onay iste
    if (!confirm(`"${weekLabel}" shift'ini silmek istediÄŸinize emin misiniz?\n\nBu iÅŸlem geri alÄ±namaz!`)) {
        return;
    }
    
    try {
        await db.collection('shifts').doc(docId).delete();
        toast('Shift silindi', 'success');
        haftaSelect.value = '';
        document.getElementById('shiftTableContainer').innerHTML = '<p style="color:var(--tx2);text-align:center;padding:40px">â¬†ï¸ YukarÄ±dan hafta seÃ§in.</p>';
        loadShiftList();
    } catch (e) {
        console.error('Silme hatasÄ±:', e);
        toast('Silme hatasÄ±: ' + e.message, 'error');
    }
}

// YazdÄ±r fonksiyonu
async function printShift() {
    const haftaSelect = document.getElementById('shiftHafta');
    const docId = haftaSelect?.value;
    
    if (!docId) { 
        toast('Ã–nce bir shift seÃ§in', 'error'); 
        return; 
    }
    
    const branch = document.getElementById('shiftSube').value;
    const weekLabel = haftaSelect.selectedOptions[0]?.textContent || '';
    
    // Firebase'den veri al
    let shiftData = null;
    try {
        const doc = await db.collection('shifts').doc(docId).get();
        shiftData = doc.data();
    } catch (e) { 
        console.error(e);
        toast('Shift verisi alÄ±namadÄ±', 'error');
        return;
    }
    
    const personelShifts = shiftData.personelShifts || {};
    const personelOrder = shiftData.personelOrder || Object.keys(personelShifts);
    const specialRequests = shiftData.specialRequests || [];
    const customRules = shiftData.customRules || SHIFT_ANNOUNCEMENTS;
    const days = ['Pzt', 'Sal', 'Ã‡ar', 'Per', 'Cum', 'Cmt', 'Paz'];
    const daysLong = ['Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi', 'Pazar'];
    
    // Åžube bazlÄ± saat kurallarÄ±
    const isTuzla = branch.toLowerCase().includes('tuzla');
    const saatKurali = isTuzla 
        ? 'AÃ‡ILIÅž: 09:50-18:50 | Pzt-Per-Paz KAPANIÅž: 16:00-01:00 | Cum-Cmt KAPANIÅž: 16:30-01:30'
        : 'AÃ‡ILIÅž: 09:50-18:50 | KAPANIÅž: 16:30-01:30';
    
    // Tablo verisi
    const data = [];
    
    personelOrder.forEach(name => {
        if (!personelShifts[name]) return;
        
        // DOÄžRU Ä°SÄ°M: personelNames mapping > lookup > name
        let displayName = shiftData.personelNames?.[name];
        if (!displayName || displayName === name) {
            displayName = lookupPersonelDisplay(name, branch);
        }
        
        const rowData = [];
        rowData.push({ text: displayName, bg: '#FFFF00', color: '#000' });
        
        for (let dayIdx = 0; dayIdx < 7; dayIdx++) {
            let val = personelShifts[name][dayIdx] || '';
            const hasStar = val.includes('*') && !/^\*+$/.test(val);
            const cleanVal = val.replace(/\*/g, '').trim();
            const isEmpty = !val || /^\*+$/.test(val.trim());
            const isOff = cleanVal.toUpperCase() === 'OFF' || cleanVal.toUpperCase().includes('Ä°ZÄ°N');
            const showStar = hasStar || isOff;
            
            if (isEmpty) {
                rowData.push({ text: '-', bg: '#fff', color: '#999', hasStar: false });
            } else {
                const colors = getShiftColorExcel(cleanVal);
                const displayText = showStar ? 'â­' + cleanVal : cleanVal;
                rowData.push({ text: displayText, bg: colors.bg, color: colors.text, hasStar: showStar });
            }
        }
        data.push(rowData);
    });
    
    // Ã–zel istekleri grupla (aynÄ± personel + aynÄ± neden = tek satÄ±r)
    const groupedRequests = {};
    specialRequests.forEach(r => {
        const key = `${r.personel}|||${r.reason}`;
        if (!groupedRequests[key]) {
            groupedRequests[key] = { personel: r.personel, reason: r.reason, days: [] };
        }
        if (r.day !== null && r.day !== undefined) {
            groupedRequests[key].days.push(daysLong[r.day]);
        }
    });
    
    const specialRequestsHtml = Object.values(groupedRequests).length > 0 
        ? Object.values(groupedRequests).map(r => {
            const dayStr = r.days.length > 0 ? r.days.join(', ') : 'TÃ¼m Hafta';
            return `<span class="request-item">${r.personel}: ${dayStr} â†’ ${r.reason}</span>`;
        }).join('') 
        : '<span class="empty-requests">Bu hafta iÃ§in Ã¶zel istek yok</span>';
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Shift - ${branch} - ${weekLabel}</title>
            <style>
                @page { size: A4 landscape; margin: 8mm; }
                @media print {
                    * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; color-adjust: exact !important; }
                    body { margin: 0; padding: 0; }
                }
                body { font-family: Arial, sans-serif; padding: 12px; background: #fff; margin: 0; }
                .header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 3px solid #ff8674; }
                .logo { width: 50px; height: 44px; object-fit: contain; }
                .title { color: #ff8674; font-size: 18px; margin: 0; font-weight: 700; }
                .subtitle { color: #008c95; font-size: 11px; margin: 4px 0 0 0; }
                table { width: 100%; border-collapse: collapse; font-size: 10px; margin-bottom: 12px; table-layout: fixed; }
                th, td { border: 1px solid #bbb; padding: 6px 4px; text-align: center; }
                th { font-weight: 600; }
                th:first-child, td:first-child { width: 14%; text-align: left; }
                th:not(:first-child), td:not(:first-child) { width: 12.28%; }
                .rules-box { margin-top: 10px; }
                .rule { display: inline-block; padding: 5px 8px; margin: 2px; font-size: 8px; border-radius: 3px; font-weight: 500; }
                .rule1 { background: #C6EFCE !important; color: #2E7D32 !important; }
                .rule2 { background: #FFEB9C !important; color: #9C5700 !important; }
                .rule3 { background: #BDE0FE !important; color: #1565C0 !important; }
                .rule4 { background: #E8F4FD !important; color: #1976D2 !important; }
                .requests-box { margin-top: 10px; padding: 10px; background: #FFF8E1 !important; border-radius: 6px; border: 1px solid #FFE082; }
                .requests-title { font-weight: 600; color: #F57C00; font-size: 10px; margin-bottom: 6px; }
                .request-item { background: #FFECB3 !important; color: #E65100 !important; padding: 3px 6px; border-radius: 3px; display: inline-block; margin: 2px; font-size: 9px; }
                .empty-requests { color: #9E9E9E; font-style: italic; font-size: 9px; }
            </style>
        </head>
        <body>
            <div class="header">
                <img src="https://static.wixstatic.com/media/760af2_cb121a61291f4f07adb48cfb70f3e2d9~mv2.png" class="logo" onerror="this.style.display='none'">
                <div>
                    <h1 class="title">Moonberry Coffee - ${branch}</h1>
                    <p class="subtitle">Shift PlanÄ±: ${weekLabel}</p>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th style="background:#00B050 !important; color:#fff !important;">PERSONEL</th>
                        ${days.map(d => `<th style="background:#FFFF00 !important; color:#000 !important;">${d}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
                    ${data.map((row, i) => `
                        <tr style="background:${i % 2 === 0 ? '#fff' : '#f5f5f5'}">
                            ${row.map((cell, idx) => `<td style="background:${cell.bg} !important; color:${cell.color} !important; font-weight:600;${cell.hasStar ? ' border:2px solid #ff8674 !important;' : ''}">${cell.text}</td>`).join('')}
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            
            <div class="rules-box">
                ${customRules.map((a, i) => `<span class="rule" style="background:${a.bg} !important; color:${a.color} !important;">${a.text}</span>`).join('')}
                <span class="rule rule3">${saatKurali}</span>
            </div>
            
            <div class="requests-box">
                <div class="requests-title">ðŸ“Œ Ã–zel Ä°stek GÃ¼nleri</div>
                ${specialRequestsHtml}
            </div>
            
            <script>window.onload = function() { window.print(); }<\/script>
        </body>
        </html>
    `);
    printWindow.document.close();
}

const EXCEL_PERSONEL = {
    'ÅžiÅŸli': ["ESÄ°N", "ESMA", "ECE"],
    'Tuzla': ["BÃœÅžRA", "ESÄ°N", "BALRA", "TUANA", "BARAN", "ELÄ°F"]
};

// Firebase'e yÃ¼kle
async function uploadExcelToFirebase() {
    if (currentUser?.role !== 'yonetici') {
        toast('Sadece yÃ¶netici yapabilir', 'error');
        return;
    }
    
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = 'â³ YÃ¼kleniyor...';
    
    // Branch isim dÃ¶nÃ¼ÅŸÃ¼mÃ¼
    const branchMap = {
        'ÅžiÅŸli': 'ÅžiÅŸli (Merkez)',
        'Tuzla': 'Tuzla TRC'
    };
    
    try {
        // 1. Personel ekle (son 2 hafta kadrosu)
        let pAdded = 0;
        for (const [excelBranch, names] of Object.entries(EXCEL_PERSONEL)) {
            const dbBranch = branchMap[excelBranch] || excelBranch;
            for (const name of names) {
                const existing = await db.collection('personel').where('name', '==', name).where('branch', '==', dbBranch).get();
                if (existing.empty) {
                    await db.collection('personel').add({
                        name: name,
                        branch: dbBranch,
                        position: 'Barista',
                        status: 'aktif',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    pAdded++;
                }
            }
        }
        
        // 2. Shiftleri ekle
        let sAdded = 0, sSkipped = 0;
        for (const shift of EXCEL_SHIFTS) {
            if (!shift.weekStart) { sSkipped++; continue; }
            
            const dbBranch = branchMap[shift.branch] || shift.branch;
            
            const existing = await db.collection('shifts')
                .where('branch', '==', dbBranch)
                .where('weekStart', '==', shift.weekStart)
                .get();
            
            if (existing.empty) {
                await db.collection('shifts').add({
                    branch: dbBranch,
                    weekStart: shift.weekStart,
                    weekEnd: shift.weekEnd,
                    weekLabel: shift.weekLabel,
                    personelShifts: shift.personelShifts,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    source: 'excel'
                });
                sAdded++;
            } else {
                sSkipped++;
            }
        }
        
        toast(`âœ“ ${pAdded} personel, ${sAdded} shift eklendi`, 'success');
        loadShiftList();
        
    } catch (e) {
        console.error(e);
        toast('Hata: ' + e.message, 'error');
    }
    
    btn.disabled = false;
    btn.innerHTML = 'ðŸ“¥ Excel Verilerini YÃ¼kle';
}

// ==================== AKTÄ°VÄ°TE LOGLAMA ====================

// Aktivite logla
async function logActivity(type, details = {}) {
    if (!currentUser || !db) return;
    
    try {
        await db.collection('activityLogs').add({
            userId: currentUser.id,
            userEmail: currentUser.email,
            userName: currentUser.name,
            userRole: currentUser.role,
            type: type,
            details: details,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            sessionId: currentUser.sessionId || null
        });
    } catch (error) {
        // Sessizce devam et - aktivite loglama kritik deÄŸil
        // console.warn('Aktivite loglama:', error.message);
    }
}

// Aktivite loglarÄ±nÄ± yÃ¼kle
async function loadActivityLogs() {
    const container = document.getElementById('activityLogList');
    if (!container) return;
    
    // KullanÄ±cÄ± filtresini doldur
    const userFilter = document.getElementById('activityUserFilter');
    if (userFilter && userFilter.options.length <= 1) {
        try {
            const usersSnap = await db.collection('users').get();
            usersSnap.forEach(doc => {
                const u = doc.data();
                const opt = document.createElement('option');
                opt.value = doc.id;
                opt.textContent = u.name || u.email || doc.id;
                userFilter.appendChild(opt);
            });
        } catch (e) {
            console.error('KullanÄ±cÄ± listesi yÃ¼klenemedi:', e);
        }
    }
    
    try {
        let query = db.collection('activityLogs').orderBy('timestamp', 'desc').limit(100);
        
        // Filtreler
        const selectedUser = document.getElementById('activityUserFilter')?.value;
        const selectedType = document.getElementById('activityTypeFilter')?.value;
        const selectedDate = document.getElementById('activityDateFilter')?.value;
        
        if (selectedUser) {
            query = db.collection('activityLogs')
                .where('userId', '==', selectedUser)
                .orderBy('timestamp', 'desc')
                .limit(100);
        }
        
        const snapshot = await query.get();
        
        if (snapshot.empty) {
            container.innerHTML = `
                <div style="text-align:center;padding:40px;color:var(--tx2)">
                    <div style="font-size:2rem;margin-bottom:12px">ðŸ“Š</div>
                    <div>HenÃ¼z aktivite kaydÄ± yok</div>
                </div>
            `;
            return;
        }
        
        const typeLabels = {
            'login': { icon: 'ðŸ”', label: 'GiriÅŸ YaptÄ±', color: '#27ae60' },
            'logout': { icon: 'ðŸšª', label: 'Ã‡Ä±kÄ±ÅŸ YaptÄ±', color: '#95a5a6' },
            'page_view': { icon: 'ðŸ‘ï¸', label: 'Sayfa GÃ¶rÃ¼ntÃ¼ledi', color: '#3498db' },
            'document_create': { icon: 'ðŸ“„', label: 'Belge OluÅŸturdu', color: '#9b59b6' },
            'data_edit': { icon: 'âœï¸', label: 'Veri DÃ¼zenledi', color: '#f39c12' },
            'data_delete': { icon: 'ðŸ—‘ï¸', label: 'Veri Sildi', color: '#e74c3c' }
        };
        
        let html = '<div style="display:flex;flex-direction:column;gap:6px">';
        
        snapshot.forEach(doc => {
            const log = doc.data();
            const ts = log.timestamp?.toDate?.();
            const time = ts ? ts.toLocaleString('tr-TR') : '-';
            const typeInfo = typeLabels[log.type] || { icon: 'ðŸ“Œ', label: log.type, color: '#95a5a6' };
            
            // Filtreler
            if (selectedType && log.type !== selectedType) return;
            if (selectedDate) {
                const logDate = ts?.toISOString().split('T')[0];
                if (logDate !== selectedDate) return;
            }
            
            const detailsStr = log.details?.page 
                ? `â†’ ${log.details.page}` 
                : (log.details?.action || '');
            
            html += `
                <div style="display:flex;align-items:center;gap:12px;padding:10px 14px;background:var(--bg3);border-radius:8px;border-left:3px solid ${typeInfo.color}">
                    <span style="font-size:1.1rem">${typeInfo.icon}</span>
                    <div style="flex:1;min-width:0">
                        <div style="display:flex;align-items:center;gap:8px">
                            <span style="font-weight:500;color:var(--tx)">${log.userName || log.userEmail || '-'}</span>
                            <span style="font-size:.75rem;color:var(--tx3);background:var(--bg4);padding:2px 6px;border-radius:4px">${log.userRole || '-'}</span>
                        </div>
                        <div style="font-size:.8rem;color:var(--tx2)">${typeInfo.label} ${detailsStr}</div>
                    </div>
                    <div style="font-size:.75rem;color:var(--tx3);white-space:nowrap">${time}</div>
                </div>
            `;
        });
        
        html += '</div>';
        container.innerHTML = html;
        
    } catch (error) {
        // Sessiz hata - aktivite loglarÄ± kritik deÄŸil
        container.innerHTML = `
            <div style="text-align:center;padding:40px;color:var(--tx2)">
                <div style="font-size:2rem;margin-bottom:12px">ðŸ“Š</div>
                <div>Aktivite loglarÄ± yÃ¼klenemedi</div>
                <div style="font-size:.8rem;margin-top:8px;color:var(--tx3)">Firebase ayarlarÄ± kontrol edilebilir</div>
            </div>
        `;
    }
}

// getWeekOptions fonksiyonu (hafta listesi iÃ§in)// getWeekOptions fonksiyonu (hafta listesi iÃ§in)
function getWeekOptions() {
    const options = [];
    const today = new Date();
    for (let i = -12; i <= 2; i++) {
        const monday = new Date(today);
        monday.setDate(today.getDate() - today.getDay() + 1 + (i * 7));
        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);
        const label = `${monday.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' })} - ${sunday.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' })}`;
        const value = formatDateLocal(monday);  // Timezone-safe
        options.push({ value, label, monday, sunday, isCurrent: i === 0 });
    }
    return options;
}

// ==================== CHECKLIST MODULE ====================
// ==================== ADALETLÄ° CHECK ATAMA SÄ°STEMÄ° ====================

/**
 * GÃ¼nlÃ¼k check sayÄ±larÄ±nÄ± hesapla
 * @param {string} branch - Åžube adÄ±
 * @param {string} dateStr - Tarih (YYYY-MM-DD)
 * @returns {Object} - { personelId: count }
 */
async function getDailyCheckCounts(branch, dateStr) {
    const counts = {};
    try {
        const submissions = await db.collection('checklistSubmissions')
            .where('branch', '==', branch)
            .where('date', '==', dateStr)
            .get();
        
        submissions.forEach(doc => {
            const d = doc.data();
            const personId = d.personelId || d.personName;
            if (personId) {
                counts[personId] = (counts[personId] || 0) + 1;
            }
        });
    } catch (e) {
        console.warn('Check sayÄ±larÄ± alÄ±namadÄ±:', e);
    }
    return counts;
}

/**
 * Adaletli daÄŸÄ±lÄ±m - en az check doldurana Ã¶ncelik, eÅŸitlik varsa round-robin
 * @param {Array} personnel - Uygun personel listesi [{id, name, checkCount}]
 * @param {number} rrIndex - Round-robin index (eÅŸitlik durumunda)
 * @returns {Object} - SeÃ§ilen personel {id, name}
 */
function selectFairPerson(personnel, rrIndex = 0) {
    if (!personnel || personnel.length === 0) return null;
    if (personnel.length === 1) return personnel[0];
    
    // En az check dolduranÄ± bul
    const minCount = Math.min(...personnel.map(p => p.checkCount || 0));
    const candidates = personnel.filter(p => (p.checkCount || 0) === minCount);
    
    // Tek aday varsa onu seÃ§
    if (candidates.length === 1) return candidates[0];
    
    // Birden fazla aday varsa round-robin
    return candidates[rrIndex % candidates.length];
}

/**
 * Shift saatini parse et
 * @param {string} shiftStr - Shift string (Ã¶rn: "10:00-19:00", "AÃ‡ILIÅž", "K")
 * @returns {Object} - {startHour, endHour} veya null
 */
function parseShiftTime(shiftStr) {
    if (!shiftStr) return null;
    
    // YÄ±ldÄ±z (*) ve diÄŸer iÅŸaretleri temizle
    const cleanedStr = shiftStr.replace(/\*/g, '').trim();
    
    // Saat formatÄ±nÄ± bul: "10:00-19:00", "10:00/19:00", "10:00 - 19:00"
    const timeMatch = cleanedStr.match(/(\d{1,2}):?(\d{2})?\s*[-â€“\/]\s*(\d{1,2}):?(\d{2})?/);
    if (timeMatch) {
        return {
            startHour: parseInt(timeMatch[1]),
            startMin: parseInt(timeMatch[2] || 0),
            endHour: parseInt(timeMatch[3]),
            endMin: parseInt(timeMatch[4] || 0)
        };
    }
    
    // Standart vardiya tipleri iÃ§in varsayÄ±lan saatler
    const clean = cleanedStr.toUpperCase();
    if (clean === 'A' || clean === 'AÃ‡ILIÅž' || clean.includes('AÃ‡ILI')) {
        return { startHour: 10, startMin: 0, endHour: 19, endMin: 0 };
    }
    if (clean === 'K' || clean === 'KAPANIÅž' || clean.includes('KAPANI')) {
        return { startHour: 16, startMin: 0, endHour: 2, endMin: 0 }; // Gece 02:00
    }
    if (clean === 'ARA' || clean === 'ARACI' || clean.includes('ARA') || clean === 'ORTA') {
        return { startHour: 12, startMin: 0, endHour: 21, endMin: 0 };
    }
    
    return null;
}

/**
 * Belirli bir saat iÃ§in uygun personeli bul
 * @param {Object} shiftData - Shift verisi {personelShifts, personelNames, personelFullNames}
 * @param {number} targetHour - Hedef saat
 * @param {number} dayIndex - GÃ¼n indexi (0=Pzt, 6=Paz)
 * @returns {Array} - Uygun personel listesi
 */
function getPersonnelAtHour(shiftData, targetHour, dayIndex) {
    const result = [];
    const { personelShifts = {}, personelNames = {}, personelFullNames = {} } = shiftData;
    
    for (const [uniqueId, days] of Object.entries(personelShifts)) {
        const todayShift = days[dayIndex] || '';
        const cleanShift = todayShift.replace(/\*/g, '').trim().toUpperCase();
        
        // OFF, Ä°zin, BoÅŸ kontrol
        if (!cleanShift || cleanShift === 'Ä°' || cleanShift === 'OFF' || cleanShift === '-' || cleanShift === 'X') continue;
        // BÃ¶lge mÃ¼dÃ¼rÃ¼ hariÃ§
        if (cleanShift.includes('BÃ–LGE') || cleanShift.includes('MÃœDÃœR')) continue;
        
        const shiftTime = parseShiftTime(todayShift);
        if (shiftTime) {
            // Gece geÃ§iÅŸi kontrolÃ¼ (kapanÄ±ÅŸ 01:00 gibi)
            let isInShift = false;
            if (shiftTime.endHour < shiftTime.startHour) {
                // Gece vardiyasÄ±
                isInShift = targetHour >= shiftTime.startHour || targetHour < shiftTime.endHour;
            } else {
                isInShift = targetHour >= shiftTime.startHour && targetHour < shiftTime.endHour;
            }
            
            if (isInShift) {
                const displayName = personelNames[uniqueId] || formatDisplayName(personelFullNames[uniqueId] || uniqueId.replace(/_/g, ' '));
                result.push({
                    id: uniqueId,
                    name: displayName,
                    shiftStart: shiftTime.startHour,
                    shiftEnd: shiftTime.endHour
                });
            }
        }
    }
    
    return result;
}

/**
 * AÃ§Ä±lÄ±ÅŸÃ§Ä±larÄ± bul
 */
function getOpeningStaff(shiftData, dayIndex) {
    const result = [];
    const { personelShifts = {}, personelNames = {}, personelFullNames = {} } = shiftData;
    
    for (const [uniqueId, days] of Object.entries(personelShifts)) {
        const todayShift = days[dayIndex] || '';
        const cleanShift = todayShift.replace(/\*/g, '').trim().toUpperCase();
        
        if (cleanShift === 'A' || cleanShift === 'AÃ‡ILIÅž' || cleanShift.includes('AÃ‡ILI')) {
            const displayName = personelNames[uniqueId] || formatDisplayName(personelFullNames[uniqueId] || uniqueId.replace(/_/g, ' '));
            result.push({ id: uniqueId, name: displayName, shiftStart: 10 });
        } else {
            const shiftTime = parseShiftTime(todayShift);
            if (shiftTime && shiftTime.startHour >= 9 && shiftTime.startHour <= 11) {
                const displayName = personelNames[uniqueId] || formatDisplayName(personelFullNames[uniqueId] || uniqueId.replace(/_/g, ' '));
                result.push({ id: uniqueId, name: displayName, shiftStart: shiftTime.startHour });
            }
        }
    }
    
    return result;
}

/**
 * KapanÄ±ÅŸÃ§Ä±larÄ± bul
 */
function getClosingStaff(shiftData, dayIndex) {
    const result = [];
    const { personelShifts = {}, personelNames = {}, personelFullNames = {} } = shiftData;
    
    for (const [uniqueId, days] of Object.entries(personelShifts)) {
        const todayShift = days[dayIndex] || '';
        const cleanShift = todayShift.replace(/\*/g, '').trim().toUpperCase();
        
        if (cleanShift === 'K' || cleanShift === 'KAPANIÅž' || cleanShift.includes('KAPANI')) {
            const displayName = personelNames[uniqueId] || formatDisplayName(personelFullNames[uniqueId] || uniqueId.replace(/_/g, ' '));
            result.push({ id: uniqueId, name: displayName, shiftEnd: 1 });
        } else {
            const shiftTime = parseShiftTime(todayShift);
            // 23:00 veya sonrasÄ± bitiÅŸ = kapanÄ±ÅŸÃ§Ä±
            if (shiftTime && (shiftTime.endHour >= 23 || shiftTime.endHour <= 2)) {
                const displayName = personelNames[uniqueId] || formatDisplayName(personelFullNames[uniqueId] || uniqueId.replace(/_/g, ' '));
                result.push({ id: uniqueId, name: displayName, shiftEnd: shiftTime.endHour });
            }
        }
    }
    
    return result;
}

/**
 * Ä°lk shift gireni bul (aÃ§Ä±lÄ±ÅŸtan sonra)
 * @param {Object} shiftData - Shift verisi
 * @param {number} dayIndex - GÃ¼n indexi
 * @param {number} afterHour - Bu saatten sonra giren (default: 10)
 * @returns {Object|null} - Ä°lk giren personel
 */
function getFirstShiftEntry(shiftData, dayIndex, afterHour = 10) {
    const { personelShifts = {}, personelNames = {}, personelFullNames = {} } = shiftData;
    let firstPerson = null;
    let earliestStart = 24;
    
    for (const [uniqueId, days] of Object.entries(personelShifts)) {
        const todayShift = days[dayIndex] || '';
        const cleanShift = todayShift.replace(/\*/g, '').trim().toUpperCase();
        
        if (!cleanShift || cleanShift === 'Ä°' || cleanShift === 'OFF' || cleanShift === '-') continue;
        if (cleanShift.includes('BÃ–LGE') || cleanShift.includes('MÃœDÃœR')) continue;
        
        const shiftTime = parseShiftTime(todayShift);
        if (shiftTime && shiftTime.startHour > afterHour && shiftTime.startHour < earliestStart) {
            earliestStart = shiftTime.startHour;
            const displayName = personelNames[uniqueId] || formatDisplayName(personelFullNames[uniqueId] || uniqueId.replace(/_/g, ' '));
            firstPerson = { id: uniqueId, name: displayName, shiftStart: shiftTime.startHour };
        }
    }
    
    return firstPerson;
}

/**
 * CHECK ATAMA KURALLARI
 */
const CHECK_ASSIGNMENT_RULES = {
    // Platform Check saatleri ve kurallarÄ±
    platform: {
        '10:00': { type: 'acilis', desc: 'AÃ§Ä±lÄ±ÅŸÃ§Ä±ya' },
        '12:00': { type: 'first_entry_or_acilis', desc: 'Shift giriÅŸi varsa giren, yoksa aÃ§Ä±lÄ±ÅŸÃ§Ä±' },
        '15:00': { type: 'fair_all', desc: 'Adaletli daÄŸÄ±lÄ±m (mÃ¼dÃ¼r hariÃ§)' },
        '18:00': { type: 'fair_never_filled', desc: 'HiÃ§ doldurmamÄ±ÅŸa Ã¶ncelik' },
        '21:00': { type: 'fair_never_filled', desc: 'HiÃ§ doldurmamÄ±ÅŸa Ã¶ncelik' },
        '00:00': { type: 'kapanis', desc: 'KapanÄ±ÅŸÃ§Ä±lara' }
    },
    // GÃ¼nlÃ¼k Check saatleri ve kurallarÄ±
    gunluk: {
        '14:00': { type: 'first_after_acilis', desc: 'AÃ§Ä±lÄ±ÅŸtan sonra ilk shift giren', muafRule: 'day' },
        '18:00': { type: 'fair_all', desc: 'Adaletli daÄŸÄ±lÄ±m' },
        '22:00': { type: 'fair_all', desc: 'Adaletli daÄŸÄ±lÄ±m' }
    }
};

// Checklist tÃ¼rleri - ÅŸubeye gÃ¶re
// Checklist tÃ¼rleri - Firebase'den yÃ¼klenecek
let CHECKLIST_TYPES = {};

// === CANONICAL TYPE ID SÄ°STEMÄ° ===
// Legacy id'leri canonical id'ye dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r
const CHECKLIST_TYPE_ALIAS = {
    guncel: "gunluk",          // legacy -> canonical
    gunluk: "gunluk",
    gunluk_genel: "gunluk",
    guncel_genel: "gunluk",
    gunluk_check: "gunluk",
    temizlik: "aylik",         // temizlik -> aylik alias
    aylik: "aylik"
};

function canonicalChecklistTypeId(typeId) {
    const t = (typeId || "").toString().trim().toLowerCase();
    return CHECKLIST_TYPE_ALIAS[t] || t; // Alias yoksa lowercase versiyonu dÃ¶ndÃ¼r
}

function sanitize(str) {
    // TÃ¼rkÃ§e karakterleri koru, sadece boÅŸluklarÄ± _ yap ve parantezleri kaldÄ±r
    return (str || '').replace(/\s+/g, '_').replace(/[()]/g, '');
}

function dailyDocIdCandidates(branch, typeId) {
    const b = sanitize(branch);
    const canon = canonicalChecklistTypeId(typeId);
    // GÃ¼nlÃ¼k iÃ§in legacy doc'lar olabilir: _guncel
    if (canon === "gunluk") return [`${b}_gunluk`, `${b}_guncel`];
    return [`${b}_${canon}`];
}
// === /CANONICAL TYPE ID SÄ°STEMÄ° ===

// === REAL-TIME LISTENERS ===
let _shiftListenerUnsubscribe = null;
let _shiftListenerInitialized = false;
let _lastShiftUpdateTime = 0;

function setupShiftListener(branch) {
    // Ã–nceki listener'Ä± temizle
    if (_shiftListenerUnsubscribe) {
        _shiftListenerUnsubscribe();
        _shiftListenerUnsubscribe = null;
    }
    
    _shiftListenerInitialized = false;
    _lastShiftUpdateTime = Date.now();
    
    // Yeni listener kur
    _shiftListenerUnsubscribe = db.collection('shifts')
        .where('branch', '==', branch)
        .onSnapshot({ includeMetadataChanges: false }, snapshot => {
            const now = Date.now();
            
            // Ä°lk yÃ¼klemeyi atla
            if (!_shiftListenerInitialized) {
                _shiftListenerInitialized = true;
                console.log('[Real-time] Shift listener hazÄ±r:', branch);
                return;
            }
            
            // Ã‡ok sÄ±k tetiklenmeyi Ã¶nle (debounce 2 saniye)
            if (now - _lastShiftUpdateTime < 2000) {
                console.log('[Real-time] Debounce - atlandÄ±');
                return;
            }
            _lastShiftUpdateTime = now;
            
            console.log('[Real-time] âœ… Shift deÄŸiÅŸikliÄŸi algÄ±landÄ±:', branch, 'docs:', snapshot.size);
            
            // Checklist sayfasÄ±ndaysak yeniden yÃ¼kle
            const checklistContainer = document.getElementById('checklistFormContainer');
            if (checklistContainer && checklistContainer.innerHTML.length > 100) {
                const currentBranch = document.getElementById('checklistSube')?.value;
                if (currentBranch === branch) {
                    console.log('[Real-time] Checklist yeniden yÃ¼kleniyor...');
                    loadChecklist();
                }
            }
            
            // Dashboard gÃ¶rÃ¼nÃ¼yorsa yeniden yÃ¼kle
            const dashboardContainer = document.getElementById('todayChecksContainer');
            if (dashboardContainer && dashboardContainer.innerHTML.length > 100) {
                console.log('[Real-time] Dashboard yeniden yÃ¼kleniyor...');
                loadTodayChecks();
            }
        }, error => {
            console.warn('[Real-time] Shift listener hatasÄ±:', error);
        });
    
    console.log('[Real-time] Shift listener kuruldu:', branch);
}

function cleanupShiftListener() {
    if (_shiftListenerUnsubscribe) {
        _shiftListenerUnsubscribe();
        _shiftListenerUnsubscribe = null;
        console.log('[Real-time] Shift listener temizlendi');
    }
}
// === /REAL-TIME LISTENERS ===

// Helper: Checklist tÃ¼rÃ¼ adÄ±nÄ± dinamik olarak al
function getChecklistTypeName(branch, typeId, defaultName) {
    const canonId = canonicalChecklistTypeId(typeId);
    const typeInfo = CHECKLIST_TYPES[branch]?.find(t => canonicalChecklistTypeId(t.id) === canonId);
    if (typeInfo?.name) return typeInfo.name;
    
    // Fallback isimleri
    if (!defaultName) {
        const names = {
            'acilis': 'AÃ§Ä±lÄ±ÅŸ HazÄ±rlÄ±klarÄ±',
            'kapanis': 'KapanÄ±ÅŸ HazÄ±rlÄ±klarÄ±',
            'gunluk': 'GÃ¼nlÃ¼k Genel Check',
            'mudur': 'MÃ¼dÃ¼r Kontrol',
            'platform': 'Platform KontrolÃ¼',
            'aylik': 'Temizlik ve BakÄ±m',
            'haftalik': 'HaftalÄ±k GÃ¶revler',
            'temizlik': 'Temizlik ve BakÄ±m'
        };
        return names[typeId] || typeId;
    }
    return defaultName;
}

let SYSTEM_CONFIG = {};
let BRANCH_HOURS = {};
// BRANCH_HOURS Firebase'den SYSTEM_CONFIG.branchHours olarak yÃ¼klenir
// Åžube Ã§alÄ±ÅŸma saatleri Ayarlar > Åžube Ã‡alÄ±ÅŸma Saatleri'nden ayarlanÄ±r

// TEMÄ°ZLÄ°K Ã‡Ä°ZELGESÄ° SHIFT TANIMLARI
let TEMIZLIK_SHIFT_RULES = {
    acilisci: {
        name: 'AÃ§Ä±lÄ±ÅŸÃ§Ä±',
        shiftStartMin: '10:00',  // 10:00'dan baÅŸlayan
        shiftStartMax: '11:00',  // 11:00'a kadar baÅŸlayan (10:00-10:59)
        description: 'Sabah shifti baÅŸlatan personel (10:00-11:00 arasÄ± baÅŸlayanlar)'
    },
    araci: {
        name: 'AracÄ±',
        shiftStartMin: '11:00',  // 11:00'dan baÅŸlayan
        shiftStartMax: '16:00',  // 16:00'a kadar baÅŸlayan (11:00-15:59)
        description: 'Ara vardiya personeli (11:00-16:00 arasÄ± baÅŸlayanlar)'
    },
    kapanisci: {
        name: 'KapanÄ±ÅŸÃ§Ä±',
        shiftStartMin: '16:00',  // 16:00'dan sonra baÅŸlayan
        shiftStartMax: '23:59',  // Gece yarÄ±sÄ±na kadar
        description: 'AkÅŸam/kapanÄ±ÅŸ vardiyasÄ± personeli (16:00+ baÅŸlayanlar)'
    }
};

// PLATFORM CHECK SAATLERÄ°
let PLATFORM_CHECK_TIMES = ['10:00', '12:00', '15:00', '18:00', '21:00', '00:00'];

let CHECK_RULES = {
    gunluk: {
        name: 'GÃ¼nlÃ¼k Check',
        window: { before: 60, after: 60 },
        lateWindow: 60,
        points: { onTime: 2, late: -2, missed: -2 },
        supervisorPenalty: -0.5 // Personel doldurmadÄ±ÄŸÄ±nda mÃ¼dÃ¼re/yardÄ±mcÄ±ya
    },
    guncel: {  // gunluk alias - dashboard'da guncel kullanÄ±lÄ±yor
        name: 'GÃ¼nlÃ¼k Genel Check',
        window: { before: 60, after: 60 },
        lateWindow: 60,
        points: { onTime: 2, late: -2, missed: -2 },
        supervisorPenalty: -0.5
    },
    platform: {
        name: 'Platform Check',
        timeSlots: PLATFORM_CHECK_TIMES, // 10:00, 12:00, 15:00, 18:00, 21:00, 00:00
        window: { before: 30, after: 30 }, // Her saat iÃ§in Â±30 dakika
        lateWindow: 30,
        points: { onTime: 1, late: -1, missed: -1 },
        supervisorPenalty: -0.3
    },
    acilis: {
        name: 'AÃ§Ä±lÄ±ÅŸ',
        deadline: '11:00',
        window: { before: 0, after: 120 },
        points: { onTime: 5, late: -3, missed: -5 },
        supervisorPenalty: -1
    },
    kapanis: {
        name: 'KapanÄ±ÅŸ',
        deadline: '23:59',
        window: { before: 120, after: 0 },
        points: { onTime: 5, late: -3, missed: -5 },
        supervisorPenalty: -1
    },
    mudur: {
        name: 'MÃ¼dÃ¼r Kontrol',
        deadline: '21:00',
        points: { onTime: 10, late: -5, missed: -10 },
        supervisorPenalty: 0 // MÃ¼dÃ¼r kendi check'i - penalty yok
    },
    aylik: {
        name: 'Temizlik ve BakÄ±m',
        // Her vardiya kendi saatinde yapacak
        shiftRules: TEMIZLIK_SHIFT_RULES,
        shifts: {
            acilisci: { deadline: '15:00', window: { start: '10:00', end: '15:00' } },
            araci: { deadline: '19:00', window: { start: '11:00', end: '19:00' } },
            kapanisci: { deadline: '02:00', window: { start: '16:00', end: '02:00' } }
        },
        points: { onTime: 1, late: -1, missed: -1 },
        supervisorPenalty: -0.5,
        note: 'Her personel kendi shift tÃ¼rÃ¼ne gÃ¶re 1 kere yapmalÄ±'
    },
    haftalik: {
        name: 'HaftalÄ±k GÃ¶revler',
        points: { done: 3, missed: -3 },
        supervisorPenalty: -0.5
    }
};
let SHIFT_DURATION = 9; // saat

// Platform listesi - Firebase'den yÃ¼klenecek
let PLATFORMS = ['Trendyol', 'Yemek Sepeti', 'Getir Yemek', 'Migros'];

// WhatsApp Grup Linkleri - Firebase'den yÃ¼klenecek
let WHATSAPP_GROUPS = {};

// Modern SVG Ä°konlar
const ICONS = {
    sunrise: '<svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 18a5 5 0 00-10 0"/><line x1="12" y1="2" x2="12" y2="9"/><line x1="4.22" y1="10.22" x2="5.64" y2="11.64"/><line x1="1" y1="18" x2="3" y2="18"/><line x1="21" y1="18" x2="23" y2="18"/><line x1="18.36" y1="11.64" x2="19.78" y2="10.22"/><line x1="23" y1="22" x2="1" y2="22"/><polyline points="8 6 12 2 16 6"/></svg>',
    sunset: '<svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 18a5 5 0 00-10 0"/><line x1="12" y1="9" x2="12" y2="2"/><line x1="4.22" y1="10.22" x2="5.64" y2="11.64"/><line x1="1" y1="18" x2="3" y2="18"/><line x1="21" y1="18" x2="23" y2="18"/><line x1="18.36" y1="11.64" x2="19.78" y2="10.22"/><line x1="23" y1="22" x2="1" y2="22"/><polyline points="16 6 12 10 8 6"/></svg>',
    'clipboard-check': '<svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/><path d="M9 14l2 2 4-4"/></svg>',
    smartphone: '<svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>',
    'calendar-week': '<svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><line x1="8" y1="14" x2="8" y2="14"/><line x1="12" y1="14" x2="12" y2="14"/><line x1="16" y1="14" x2="16" y2="14"/></svg>',
    calendar: '<svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
    'user-check': '<svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></svg>',
    check: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>',
    x: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
    trash: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>'
};

// Ä°kon getir
function getIcon(name) {
    return ICONS[name] || ICONS['clipboard-check'];
}

// Rol adÄ±nÄ± TÃ¼rkÃ§e dÃ¶ndÃ¼r
function getRoleName(role) {
    const names = {
        'yonetici': 'YÃ¶netici',
        'bolge_muduru': 'BÃ¶lge MÃ¼dÃ¼rÃ¼',
        'magaza_muduru': 'MaÄŸaza MÃ¼dÃ¼rÃ¼',
        'magaza_mudur_yardimcisi': 'MaÄŸaza MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±',
        'mudur_yardimcisi': 'MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±',
        'barista': 'Barista'
    };
    return names[role] || role;
}

// ==================== SHIFT-CHECK ENTEGRASYONU ====================

// MaÄŸaza kapanÄ±ÅŸ saatini al (gÃ¼ne gÃ¶re)
function getBranchClosingTime(branch, date = new Date()) {
    const hours = BRANCH_HOURS[branch];
    if (!hours) return '01:00';
    
    const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
    const dayName = dayNames[date.getDay()];
    
    if (hours.closing[dayName]) {
        return hours.closing[dayName];
    }
    return hours.closing.default || '01:00';
}

// MaÄŸaza aÃ§Ä±lÄ±ÅŸ saatini al
function getBranchOpeningTime(branch) {
    const hours = BRANCH_HOURS[branch];
    return hours?.opening || '10:00';
}

// Saat string'ini dakikaya Ã§evir (00:00 = 1440 olarak hesapla gece iÃ§in)
function timeToMinutes(timeStr, forNight = false) {
    const [h, m] = timeStr.split(':').map(Number);
    let minutes = h * 60 + m;
    if (forNight && h < 6) minutes += 1440; // Gece saatleri iÃ§in ertesi gÃ¼ne ekle
    return minutes;
}

// DakikayÄ± saat string'ine Ã§evir
function minutesToTime(minutes) {
    const h = Math.floor((minutes % 1440) / 60);
    const m = minutes % 60;
    return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
}

// Ä°ÅŸ gÃ¼nÃ¼ bitiÅŸ saatini hesapla (tÃ¼m ÅŸubelerin en geÃ§ kapanÄ±ÅŸÄ±)
function getBusinessDayEndHour() {
    let maxClosingHour = 2; // varsayÄ±lan
    const allBranches = STATE.branches || ['Tuzla Port'];
    for (const br of allBranches) {
        const closingTime = getBranchClosingTime(br);
        if (closingTime) {
            const [h] = closingTime.split(':').map(Number);
            // Gece saati ise (00:00-06:00 arasÄ±)
            if (h >= 0 && h <= 6 && h > maxClosingHour) {
                maxClosingHour = h;
            }
        }
    }
    return maxClosingHour;
}

// KapanÄ±ÅŸ shift baÅŸlangÄ±Ã§ saatini hesapla
function getClosingShiftStart(branch, date = new Date()) {
    const closingTime = getBranchClosingTime(branch, date);
    const closingMinutes = timeToMinutes(closingTime, true);
    const shiftStartMinutes = closingMinutes - (SHIFT_DURATION * 60);
    return minutesToTime(shiftStartMinutes);
}

// Personelin bugÃ¼nkÃ¼ shift'ini tespit et
async function getCurrentShiftForPerson(personId, branch, date = new Date()) {
    const dateStr = formatDateLocal(date);  // Timezone-safe
    
    try {
        // HaftalÄ±k shift planÄ±ndan kontrol et
        const weekStart = getWeekStart(date);
        const weekKey = formatDateLocal(weekStart);  // Timezone-safe
        
        const shiftDoc = await db.collection('shiftPlans').doc(`${branch}_${weekKey}`).get();
        if (shiftDoc.exists) {
            const plan = shiftDoc.data();
            const dayPlan = plan[dateStr];
            
            if (dayPlan) {
                for (const [shiftType, personnel] of Object.entries(dayPlan)) {
                    if (personnel && personnel.includes(personId)) {
                        return shiftType; // 'acilis', 'kapanis', 'ara'
                    }
                }
            }
        }
    } catch (e) {
        console.warn('Shift planÄ± okunamadÄ±:', e);
    }
    
    return null;
}

// Hafta baÅŸlangÄ±cÄ±nÄ± al (Pazartesi)
// Tarihi YYYY-MM-DD formatÄ±nda dÃ¶ndÃ¼r (LOCAL timezone)
function formatDateLocal(date) {
    const d = date instanceof Date ? date : new Date(date);
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function getWeekStart(date = new Date()) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1);
    d.setDate(diff);
    d.setHours(0, 0, 0, 0);
    return d;
}

// HaftanÄ±n baÅŸlangÄ±Ã§ tarihini YYYY-MM-DD formatÄ±nda dÃ¶ndÃ¼r
function getWeekKey(date = new Date()) {
    const weekStart = getWeekStart(date);
    return formatDateLocal(weekStart);
}

// Check iÃ§in zaman penceresi hesapla
function getCheckTimeWindow(checkType, targetTime, branch, date = new Date()) {
    const rules = CHECK_RULES[checkType];
    if (!rules) return null;
    
    const targetMinutes = timeToMinutes(targetTime);
    const now = new Date();
    const currentMinutes = now.getHours() * 60 + now.getMinutes();
    
    let windowStart, windowEnd, lateEnd;
    
    if (rules.window) {
        windowStart = targetMinutes - rules.window.before;
        windowEnd = targetMinutes + rules.window.after;
        lateEnd = rules.lateWindow > 0 ? windowEnd + rules.lateWindow : windowEnd;
    } else if (rules.deadline) {
        windowStart = timeToMinutes(getBranchOpeningTime(branch));
        windowEnd = timeToMinutes(rules.deadline);
        lateEnd = windowEnd;
    } else {
        return null;
    }
    
    return {
        start: minutesToTime(windowStart),
        end: minutesToTime(windowEnd),
        lateEnd: minutesToTime(lateEnd),
        startMinutes: windowStart,
        endMinutes: windowEnd,
        lateEndMinutes: lateEnd,
        currentMinutes,
        isBeforeWindow: currentMinutes < windowStart,
        isInWindow: currentMinutes >= windowStart && currentMinutes <= windowEnd,
        isLate: currentMinutes > windowEnd && currentMinutes <= lateEnd,
        isMissed: currentMinutes > lateEnd
    };
}

// Check durumunu belirle
function getCheckStatus(checkType, targetTime, branch, isCompleted, completedAt = null) {
    const window = getCheckTimeWindow(checkType, targetTime, branch);
    if (!window) return { status: 'unknown', points: 0 };
    
    const rules = CHECK_RULES[checkType];
    
    if (isCompleted) {
        if (completedAt) {
            const completedMinutes = completedAt.getHours() * 60 + completedAt.getMinutes();
            if (completedMinutes <= window.endMinutes) {
                return { status: 'onTime', points: rules.points.onTime, label: 'Vaktinde', color: '#27ae60' };
            } else {
                return { status: 'late', points: rules.points.late, label: 'GeÃ§', color: '#f39c12' };
            }
        }
        return { status: 'completed', points: 0, label: 'TamamlandÄ±', color: '#27ae60' };
    }
    
    if (window.isMissed) {
        return { status: 'missed', points: rules.points.missed, label: 'YapÄ±lmadÄ±', color: '#e74c3c' };
    }
    
    if (window.isLate) {
        return { status: 'lateWindow', points: 0, label: 'GeÃ§ Penceresi', color: '#f39c12' };
    }
    
    if (window.isInWindow) {
        return { status: 'active', points: 0, label: 'Aktif', color: '#3498db' };
    }
    
    return { status: 'waiting', points: 0, label: 'Bekliyor', color: '#95a5a6' };
}

// Kalan sÃ¼reyi hesapla
function getRemainingTime(checkType, targetTime, branch) {
    const window = getCheckTimeWindow(checkType, targetTime, branch);
    if (!window) return null;
    
    const rules = CHECK_RULES[checkType];
    let deadline = window.endMinutes;
    
    // GeÃ§ penceresi varsa onu kullan
    if (rules.lateWindow > 0) {
        deadline = window.lateEndMinutes;
    }
    
    const remaining = deadline - window.currentMinutes;
    
    if (remaining <= 0) return { minutes: 0, text: 'SÃ¼re doldu', isExpired: true };
    
    const hours = Math.floor(remaining / 60);
    const mins = remaining % 60;
    
    let text = '';
    if (hours > 0) {
        text = `${hours} saat ${mins} dk`;
    } else {
        text = `${mins} dakika`;
    }
    
    return { 
        minutes: remaining, 
        text, 
        isExpired: false,
        isUrgent: remaining <= 30,
        isWarning: remaining <= 60 && remaining > 30
    };
}

// Otomatik puantaj notu oluÅŸtur - TAM Ä°SÄ°M LOOKUP SÄ°STEMÄ°
// Personel cache (performans iÃ§in)
let _personelCache = null;
let _personelCacheTime = 0;
const PERSONEL_CACHE_TTL = 60000; // 1 dakika

async function getPersonelCache() {
    const now = Date.now();
    if (_personelCache && (now - _personelCacheTime) < PERSONEL_CACHE_TTL) {
        return _personelCache;
    }
    
    try {
        const snapshot = await db.collection('personel').get();
        _personelCache = [];
        snapshot.forEach(doc => {
            const data = doc.data();
            _personelCache.push({
                docId: doc.id,
                name: data.name,
                codeName: data.codeName,
                uniqueId: data.uniqueId || normalizePersonelId(data.name),
                branch: data.branch
            });
        });
        _personelCacheTime = now;
        return _personelCache;
    } catch (e) {
        console.error('Personel cache hatasÄ±:', e);
        return [];
    }
}

// KÄ±sa isimden tam personel bilgisi bul - GÃœÃ‡LENDÄ°RÄ°LMÄ°Åž
async function findPersonelByDisplayName(displayName, branch) {
    if (!displayName) return null;
    
    const personelList = await getPersonelCache();
    const searchName = displayName.trim();
    const searchLower = searchName.toLowerCase();
    const searchNormalized = normalizePersonelId(searchName);
    
    // Helper: TÃ¼rkÃ§e karakterleri normalize et (karÅŸÄ±laÅŸtÄ±rma iÃ§in)
    // Ã–NEMLÄ°: Ã–nce bÃ¼yÃ¼k TÃ¼rkÃ§e harfleri replace et, sonra toLowerCase!
    const normalizeTurkish = (str) => {
        if (!str) return '';
        return str
            // Ã–nce bÃ¼yÃ¼k TÃ¼rkÃ§e harfleri kÃ¼Ã§Ã¼lt (toLowerCase'dan Ã¶nce!)
            .replace(/Ä°/g, 'i').replace(/I/g, 'i')
            .replace(/Äž/g, 'g').replace(/Ãœ/g, 'u').replace(/Åž/g, 's')
            .replace(/Ã–/g, 'o').replace(/Ã‡/g, 'c')
            // Sonra toLowerCase
            .toLowerCase()
            // Sonra kÃ¼Ã§Ã¼k TÃ¼rkÃ§e harfleri normalize et
            .replace(/ÄŸ/g, 'g').replace(/Ã¼/g, 'u').replace(/ÅŸ/g, 's')
            .replace(/Ä±/g, 'i').replace(/Ã¶/g, 'o').replace(/Ã§/g, 'c')
            .replace(/iÌ‡/g, 'i'); // combining dot varsa temizle
    };
    
    const searchTurkishNorm = normalizeTurkish(searchName);
    
    // 1. Tam isim eÅŸleÅŸmesi (case-insensitive)
    let found = personelList.find(p => 
        p.name?.toLowerCase() === searchLower ||
        normalizeTurkish(p.name) === searchTurkishNorm
    );
    if (found) return found;
    
    // 2. codeName eÅŸleÅŸmesi (case-insensitive + TÃ¼rkÃ§e normalize)
    found = personelList.find(p => 
        p.codeName?.toLowerCase() === searchLower ||
        normalizeTurkish(p.codeName) === searchTurkishNorm
    );
    if (found) return found;
    
    // 3. uniqueId eÅŸleÅŸmesi
    found = personelList.find(p => 
        p.uniqueId === searchNormalized ||
        normalizePersonelId(p.name) === searchNormalized
    );
    if (found) return found;
    
    // 4. Ä°lk isim eÅŸleÅŸmesi (branch ile filtrele)
    const firstName = searchName.split(' ')[0];
    const firstNameLower = firstName.toLowerCase();
    const firstNameNorm = normalizeTurkish(firstName);
    
    let candidates = personelList.filter(p => {
        const pFirstName = p.name?.split(' ')[0];
        const pFirstLower = pFirstName?.toLowerCase();
        const pFirstNorm = normalizeTurkish(pFirstName);
        
        return (pFirstLower === firstNameLower || pFirstNorm === firstNameNorm) &&
               (!branch || p.branch === branch);
    });
    
    // Tek aday varsa dÃ¶ndÃ¼r
    if (candidates.length === 1) return candidates[0];
    
    // 5. "Ä°sim S." formatÄ± eÅŸleÅŸtirmesi
    const match = searchName.match(/^(.+?)\s+([A-ZÃ‡ÄžÄ°Ã–ÅžÃœa-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼])\.?$/);
    if (match) {
        const [, fName, lastInitial] = match;
        const fNameNorm = normalizeTurkish(fName);
        const lastInitialNorm = normalizeTurkish(lastInitial);
        
        found = personelList.find(p => {
            const pParts = p.name?.split(' ') || [];
            const pFirstName = pParts[0];
            const pLastName = pParts.slice(1).join(' ');
            const pFirstNorm = normalizeTurkish(pFirstName);
            const pLastInitialNorm = normalizeTurkish(pLastName?.charAt(0));
            
            return pFirstNorm === fNameNorm &&
                   pLastInitialNorm === lastInitialNorm &&
                   (!branch || p.branch === branch);
        });
        if (found) return found;
    }
    
    // 6. KÄ±smi eÅŸleÅŸme - codeName iÃ§inde ara (BALRA â†’ Balra)
    found = personelList.find(p => {
        const codeNorm = normalizeTurkish(p.codeName);
        return codeNorm && codeNorm.includes(searchTurkishNorm) &&
               (!branch || p.branch === branch);
    });
    if (found) return found;
    
    // 7. codeName'in ilk kÄ±smÄ± ile eÅŸleÅŸtir (ESÄ°N â†’ "Esin Ä°." â†’ esin)
    found = personelList.find(p => {
        const codeFirstPart = p.codeName?.split(' ')[0];
        const codeFirstNorm = normalizeTurkish(codeFirstPart);
        return codeFirstNorm === searchTurkishNorm &&
               (!branch || p.branch === branch);
    });
    if (found) return found;
    
    // 8. Ä°smin herhangi bir parÃ§asÄ±yla eÅŸleÅŸ
    found = personelList.find(p => {
        const nameParts = p.name?.split(' ') || [];
        return nameParts.some(part => 
            normalizeTurkish(part) === searchTurkishNorm
        ) && (!branch || p.branch === branch);
    });
    if (found) return found;
    
    // BulunamadÄ±
    return null;
}

async function createAutoPuantajNote(personelId, personelName, checkType, checkTime, status, points, branch, date) {
    // === CF AKTÄ°F KONTROLÃœ ===
    // frontendAutoPuanEnabled false ise yazma yapma (CF hallediyor)
    try {
        const cfConfigDoc = await db.collection('config').doc('system').get();
        if (cfConfigDoc.exists && cfConfigDoc.data()?.frontendAutoPuanEnabled === false) {
            console.log('[AutoPuan] â¸ï¸ Frontend yazmasÄ± devre dÄ±ÅŸÄ± (CF aktif). AtlanÄ±yor:', checkType, checkTime);
            return;
        }
    } catch (e) {
        console.warn('[AutoPuan] Config kontrolÃ¼ baÅŸarÄ±sÄ±z:', e.message);
    }
    
    const rules = CHECK_RULES[checkType];
    const checkName = rules?.name || checkType;
    
    // === TAM Ä°SÄ°M LOOKUP ===
    // personelName kÄ±sa isim olabilir ("BÃ¼ÅŸra S."), tam personeli bul
    const personelInfo = await findPersonelByDisplayName(personelName, branch);
    
    let finalPersonelId, finalPersonelName;
    
    if (personelInfo) {
        // Tam isim bulundu
        finalPersonelId = personelInfo.uniqueId;
        finalPersonelName = personelInfo.name;
        console.log(`[PuantajNote] ${personelName} â†’ ${finalPersonelName} (${finalPersonelId})`);
    } else {
        // BulunamadÄ±, gelen deÄŸerleri kullan
        finalPersonelId = personelId;
        finalPersonelName = personelName;
        console.warn(`[PuantajNote] ${personelName} iÃ§in tam isim bulunamadÄ±, gelen deÄŸer kullanÄ±lÄ±yor`);
    }
    
    let note = '';
    if (status === 'onTime') {
        note = `${checkTime} ${checkName} vaktinde dolduruldu`;
    } else if (status === 'late') {
        note = `${checkTime} ${checkName} geÃ§ dolduruldu`;
    } else if (status === 'missed') {
        note = `${checkTime} ${checkName} doldurulmadÄ±`;
    }
    
    const noteId = `auto_${finalPersonelId}_${date}_${checkType}_${checkTime.replace(':', '')}`;
    
    try {
        // Ã–nce var mÄ± kontrol et
        const existing = await db.collection('puantajNotes').doc(noteId).get();
        if (existing.exists) {
            console.log('Puantaj notu zaten var:', noteId);
            return;
        }
        
        await db.collection('puantajNotes').doc(noteId).set({
            personelId: finalPersonelId,
            personelName: finalPersonelName,
            branch,
            date,
            type: checkType,
            checkType,
            checkTime,
            status,
            points,
            note,
            autoGenerated: true,
            createdBy: 'Sistem',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('âœ… Puantaj notu oluÅŸturuldu:', noteId, points);
        
        // === SUPERVISOR PENALTY TETÄ°KLEYÄ°CÄ° ===
        // Personel check kaÃ§Ä±rdÄ±ysa (missed) mÃ¼dÃ¼r/yardÄ±mcÄ±ya eksi yaz
        if (status === 'missed') {
            try {
                await writeSupervisorPenalty({
                    personelId: finalPersonelId,
                    personelName: finalPersonelName,
                    checkType: checkType,
                    checkTime: checkTime,
                    date: date,
                    branch: branch
                });
            } catch (penaltyErr) {
                console.warn('[SupervisorPenalty] YazÄ±lamadÄ±:', penaltyErr.message);
            }
        }
    } catch (e) {
        console.error('âŒ Puantaj notu oluÅŸturulamadÄ±:', e.message);
    }
}

// YapÄ±lmayan checkler iÃ§in otomatik puan iÅŸle
// ==================== OTOMATÄ°K KAÃ‡IRILAN CHECK KONTROLÃœ ====================
// Dashboard/checklist yÃ¼klendiÄŸinde geÃ§miÅŸ check'leri kontrol eder ve kaÃ§Ä±rÄ±lanlar iÃ§in puan keser
async function checkAndProcessMissedChecks() {
    if (!currentUser) return;
    
    // === CF AKTÄ°F KONTROLÃœ - EN BAÅžTA ===
    // CF aktifse bu fonksiyon hiÃ§ Ã§alÄ±ÅŸmasÄ±n (gereksiz iÅŸlem Ã¶nleme)
    try {
        const cfCheck = await db.collection('config').doc('system').get();
        if (cfCheck.exists && cfCheck.data()?.frontendAutoPuanEnabled === false) {
            // Sessizce Ã§Ä±k - console log bile basma
            return;
        }
    } catch (e) { /* Config okunamazsa devam et */ }
    
    // YÃ¶netici her zaman Ã§alÄ±ÅŸtÄ±rabilir
    if (currentUser.role !== 'yonetici') {
        // Firebase'den run_autopuan yetkisini kontrol et
        try {
            const permDoc = await db.collection('advancedPermissions').doc(currentUser.role).get();
            const perms = permDoc.exists ? permDoc.data() : DEFAULT_ROLE_PERMISSIONS[currentUser.role];
            
            if (!perms?.special?.run_autopuan) {
                console.log('[AutoPuan] Bu rol iÃ§in yetki yok:', currentUser.role);
                return;
            }
        } catch (e) {
            console.warn('[AutoPuan] Yetki kontrolÃ¼ baÅŸarÄ±sÄ±z, varsayÄ±lan kullanÄ±lÄ±yor');
            // VarsayÄ±lana gÃ¶re kontrol et
            const defaultPerms = DEFAULT_ROLE_PERMISSIONS[currentUser.role];
            if (!defaultPerms?.special?.run_autopuan) {
                return;
            }
        }
    }
    
    console.log('[AutoPuan] KaÃ§Ä±rÄ±lan check kontrolÃ¼ baÅŸlÄ±yor...');
    
    const now = new Date();
    const today = formatDateLocal(now);
    
    // DÃ¼n de kontrol et (gece vardiyasÄ± iÃ§in)
    const yesterday = new Date(now);
    yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayStr = formatDateLocal(yesterday);
    
    // Kontrol edilecek tarihler
    const datesToCheck = [yesterdayStr, today];
    
    // Åžubeler
    const branches = STATE.branches || [];
    const userBranch = currentUser?.branch;
    const branchesToCheck = (userBranch && userBranch !== 'all') ? [userBranch] : branches;
    
    // Åžube oluÅŸturma tarihlerini al
    let branchCreatedAt = {};
    try {
        const configDoc = await db.collection('systemConfig').doc('checkRules').get();
        if (configDoc.exists) {
            branchCreatedAt = configDoc.data().branchCreatedAt || {};
        }
    } catch (e) {
        console.warn('[AutoPuan] branchCreatedAt alÄ±namadÄ±:', e);
    }
    
    for (const branch of branchesToCheck) {
        // Åžubenin oluÅŸturulma tarihi
        const branchCreatedDate = branchCreatedAt[branch];
        
        for (const date of datesToCheck) {
            // EÄŸer kontrol edilen tarih ÅŸubenin oluÅŸturulma tarihinden Ã–NCE ise atla
            if (branchCreatedDate && date < branchCreatedDate) {
                console.log(`[AutoPuan] ${branch} - ${date} atlandÄ± (ÅŸube ${branchCreatedDate} tarihinde oluÅŸturuldu)`);
                continue;
            }
            
            // Shift personelini al
            let shiftPersonnel = [];
            try {
                const weekKey = getWeekKey(new Date(date));
                
                // DÃœZELTME: ID ile deÄŸil, query ile shift bul
                const shiftSnap = await db.collection('shifts')
                    .where('branch', '==', branch)
                    .where('weekStart', '==', weekKey)
                    .limit(1)
                    .get();
                
                if (!shiftSnap.empty) {
                    const shiftData = shiftSnap.docs[0].data();
                    // GÃœN Ä°NDEKSÄ°: Excel formatÄ± - 0=Pazartesi, 6=Pazar
                    let dayIndex = new Date(date).getDay() - 1;
                    if (dayIndex < 0) dayIndex = 6; // Pazar iÃ§in
                    const dayIndexStr = String(dayIndex);
                    
                    // DÃœZELTME: personnel yerine personelShifts + personelOrder kullan
                    const personelShifts = shiftData.personelShifts || {};
                    const personelOrder = shiftData.personelOrder || Object.keys(personelShifts);
                    const personelFullNames = shiftData.personelFullNames || {};
                    
                    for (const personId of personelOrder) {
                        const shifts = personelShifts[personId] || {};
                        const dayShift = shifts[dayIndexStr];
                        
                        // OFF, boÅŸ veya '-' deÄŸilse Ã§alÄ±ÅŸÄ±yor demek
                        if (dayShift && 
                            dayShift.toUpperCase() !== 'OFF' && 
                            !dayShift.includes('OFF') &&
                            dayShift !== '-' && 
                            dayShift.trim() !== '') {
                            // Tam ismini al
                            const fullName = personelFullNames[personId] || personId;
                            shiftPersonnel.push(fullName);
                        }
                    }
                }
            } catch(e) {
                console.error('[AutoPuan] Shift okuma hatasÄ±:', branch, date, e.message);
            }
            
            if (shiftPersonnel.length === 0) continue;
            
            // Her check tÃ¼rÃ¼ iÃ§in kontrol et
            const checkTypes = ['gunluk', 'acilis', 'kapanis'];
            
            for (const checkType of checkTypes) {
                const rules = CHECK_RULES[checkType];
                if (!rules || !rules.points?.missed) continue;
                
                // timeSlots varsa her biri iÃ§in kontrol et
                // Array kontrolÃ¼ - object veya undefined olabilir
                let timeSlots = rules.timeSlots;
                if (!Array.isArray(timeSlots)) {
                    timeSlots = [];
                }
                
                if (timeSlots.length > 0) {
                    for (const timeSlot of timeSlots) {
                        await checkSingleTimeSlot(branch, checkType, timeSlot, date, shiftPersonnel, rules);
                    }
                } else if (rules.deadline) {
                    // Deadline bazlÄ± check (acilis, kapanis)
                    await checkDeadlineBasedCheck(branch, checkType, date, shiftPersonnel, rules);
                }
            }
        }
    }
    
    console.log('[AutoPuan] KaÃ§Ä±rÄ±lan check kontrolÃ¼ tamamlandÄ±');
}

// Tek bir timeSlot iÃ§in check kontrolÃ¼
async function checkSingleTimeSlot(branch, checkType, timeSlot, date, shiftPersonnel, rules) {
    const now = new Date();
    
    // timeSlot string veya object olabilir - normalize et
    let timeStr = timeSlot;
    if (typeof timeSlot === 'object' && timeSlot !== null) {
        // Object formatÄ±: {start: '14:00', end: '15:00'} veya {time: '14:00'}
        timeStr = timeSlot.start || timeSlot.time || timeSlot.slot || timeSlot.value || null;
    }
    if (typeof timeStr !== 'string' || !timeStr.includes(':')) {
        console.warn('[AutoPuan] GeÃ§ersiz timeSlot formatÄ±:', timeSlot);
        return;
    }
    
    const [slotHour, slotMinute] = timeStr.split(':').map(Number);
    
    // Check zamanÄ± geÃ§miÅŸ mi?
    const checkTime = new Date(date);
    checkTime.setHours(slotHour, slotMinute, 0, 0);
    
    // GeÃ§ doldurum penceresi
    const lateWindow = rules.lateWindow || 30;
    const deadline = new Date(checkTime.getTime() + (rules.window?.after || 30) * 60000 + lateWindow * 60000);
    
    // HenÃ¼z sÃ¼resi dolmamÄ±ÅŸ
    if (now < deadline) return;
    
    // Bu check doldurulmuÅŸ mu?
    const submissionId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_${checkType}_${date}_${timeStr.replace(':', '')}`;
    
    try {
        const existing = await db.collection('checklistSubmissions').doc(submissionId).get();
        
        // Doc varsa ve status=missed deÄŸilse, doldurulmuÅŸ sayÄ±lÄ±r
        if (existing.exists) {
            const data = existing.data();
            // Status=missed ise (manuel kaÃ§Ä±rÄ±ldÄ± iÅŸaretlenmiÅŸse) puan verilmeli
            if (data.status !== 'missed' && data.pointStatus !== 'missed') {
                return; // DoldurulmuÅŸ
            }
        }
        
        // DoldurulmamÄ±ÅŸ veya missed - puan notu var mÄ± kontrol et
        for (const personName of shiftPersonnel) {
            const personId = normalizePersonelId(personName);
            const noteId = `auto_${personId}_${date}_${checkType}_${timeStr.replace(':', '')}`;
            
            const noteExists = await db.collection('puantajNotes').doc(noteId).get();
            if (!noteExists.exists) {
                // Puan notu oluÅŸtur
                console.log(`[AutoPuan] KaÃ§Ä±rÄ±lan: ${personName} - ${checkType} ${timeStr} (${date})`);
                await createAutoPuantajNote(
                    personId,
                    personName,
                    checkType,
                    timeStr,
                    'missed',
                    rules.points.missed,
                    branch,
                    date
                );
            }
        }
    } catch(e) {
        console.warn('[AutoPuan] Hata:', e);
    }
}

// Deadline bazlÄ± check kontrolÃ¼ (aÃ§Ä±lÄ±ÅŸ, kapanÄ±ÅŸ)
async function checkDeadlineBasedCheck(branch, checkType, date, shiftPersonnel, rules) {
    const now = new Date();
    const [deadlineHour, deadlineMinute] = (rules.deadline || '23:59').split(':').map(Number);
    
    const deadline = new Date(date);
    deadline.setHours(deadlineHour, deadlineMinute, 0, 0);
    
    // KapanÄ±ÅŸ iÃ§in ertesi gÃ¼n
    if (checkType === 'kapanis' && deadlineHour < 12) {
        deadline.setDate(deadline.getDate() + 1);
    }
    
    // HenÃ¼z sÃ¼resi dolmamÄ±ÅŸ
    if (now < deadline) return;
    
    // Bu check doldurulmuÅŸ mu?
    const submissionId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_${checkType}_${date}`;
    
    try {
        const existing = await db.collection('checklistSubmissions').doc(submissionId).get();
        
        // Doc varsa ve status=missed deÄŸilse, doldurulmuÅŸ sayÄ±lÄ±r
        if (existing.exists) {
            const data = existing.data();
            if (data.status !== 'missed' && data.pointStatus !== 'missed') {
                return; // DoldurulmuÅŸ
            }
        }
        
        // DoldurulmamÄ±ÅŸ veya missed - puan notu oluÅŸtur
        for (const personName of shiftPersonnel) {
            const personId = normalizePersonelId(personName);
            const noteId = `auto_${personId}_${date}_${checkType}`;
            
            const noteExists = await db.collection('puantajNotes').doc(noteId).get();
            if (!noteExists.exists) {
                console.log(`[AutoPuan] KaÃ§Ä±rÄ±lan: ${personName} - ${checkType} (${date})`);
                await createAutoPuantajNote(
                    personId,
                    personName,
                    checkType,
                    rules.deadline || '23:59',
                    'missed',
                    rules.points.missed,
                    branch,
                    date
                );
            }
        }
    } catch(e) {
        console.warn('[AutoPuan] Hata:', e);
    }
}

async function processMissedChecks(branch, checkType, timeSlot, date, shiftPersonnel) {
    // Sadece yÃ¶netici/mÃ¼dÃ¼r gÃ¶rÃ¼nÃ¼mÃ¼nde iÅŸle (tekrarlÄ± iÅŸlemi Ã¶nlemek iÃ§in)
    if (!['yonetici', 'bolge_muduru', 'magaza_muduru'].includes(currentUser?.role)) {
        return;
    }
    
    const rules = CHECK_RULES[checkType];
    if (!rules || !rules.points?.missed) return;
    
    const missedPoints = rules.points.missed;
    
    // Her sorumlu personel iÃ§in puan notu oluÅŸtur
    for (const personName of shiftPersonnel) {
        // TAM Ä°SÄ°M'den normalize edilmiÅŸ ID oluÅŸtur
        const personId = normalizePersonelId(personName);
        
        console.log(`[puantajNote] KayÄ±t: personName="${personName}" â†’ personId="${personId}"`);
        
        await createAutoPuantajNote(
            personId,
            personName,
            checkType,
            timeSlot,
            'missed',
            missedPoints,
            branch,
            date
        );
    }
}

// ==================== DASHBOARD CHECK KARTLARI ====================
async function updateDashboardCheckCards() {
    // Bu fonksiyon artÄ±k kullanÄ±lmÄ±yor - yeni premium kartlar loadTodayChecks'te render ediliyor
    // Eski HTML elementleri kaldÄ±rÄ±ldÄ±ÄŸÄ± iÃ§in bu fonksiyon devre dÄ±ÅŸÄ±
    return;
}

// Dashboard - BugÃ¼nkÃ¼ Checkler (Yeniden YazÄ±ldÄ± - Premium Format)
async function loadTodayChecks() {
    const section = document.getElementById('todayChecksSection');
    const container = document.getElementById('todayChecksContainer');
    const welcomeCard = document.getElementById('welcomeCard');
    const monthlyCard = document.getElementById('monthlyPointsCard');
    
    if (!section || !container) return;
    
    // Dashboard iÃ§in shift listener kur (ilk ÅŸube)
    const userBranch = currentUser?.branch || STATE.branches?.[0] || 'Tuzla TRC';
    if (userBranch && userBranch !== 'all') {
        setupShiftListener(userBranch);
    } else {
        // Admin iÃ§in ilk ÅŸubeyi dinle
        const firstBranch = STATE.branches?.[0] || 'Tuzla TRC';
        setupShiftListener(firstBranch);
    }
    
    // CHECKLIST_TYPES yÃ¼klÃ¼ deÄŸilse yÃ¼kle (dinamik isimler iÃ§in gerekli)
    if (Object.keys(CHECKLIST_TYPES).length === 0) {
        await loadSystemConfig();
    }
    
    // HIZLI LOADING - Ã¶nce UI gÃ¶ster
    container.innerHTML = '<div style="text-align:center;padding:30px;color:var(--tx3)"><div style="width:24px;height:24px;border:3px solid var(--bg4);border-top-color:#008c95;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 12px"></div>GÃ¶revler yÃ¼kleniyor...</div>';
    
    // GÃœN SONU SAATÄ°: 02:00 - Bu saatten Ã¶nce Ã¶nceki gÃ¼n sayÄ±lÄ±r
    // Ä°ÅŸ gÃ¼nÃ¼ bitiÅŸ saati = MaÄŸaza kapanÄ±ÅŸ saati (dinamik)
    const DAY_END_HOUR = getBusinessDayEndHour();
    
    const now = new Date();
    let today = new Date(now);
    if (now.getHours() < DAY_END_HOUR) {
        today.setDate(today.getDate() - 1);
    }
    
    const todayStr = formatDateLocal(today);
    const isFullAdmin = ['yonetici', 'bolge_muduru'].includes(currentUser?.role);
    const isStoreManager = currentUser?.role === 'magaza_muduru';
    const userName = currentUser?.name || 'Personel';
    const currentHour = now.getHours();
    const currentMinutes = now.getMinutes();
    
    // YÃ¶netici/bÃ¶lge mÃ¼dÃ¼rÃ¼ iÃ§in tÃ¼m ÅŸubeler, maÄŸaza mÃ¼dÃ¼rÃ¼ ve diÄŸerleri iÃ§in kendi ÅŸubesi
    let branches = [];
    if (isFullAdmin || currentUser?.branch === 'all') {
        branches = STATE.branches || [];
    } else {
        branches = [currentUser?.branch || STATE.branches?.[0] || 'Tuzla TRC'];
    }
    
    const primaryBranch = branches[0];
    
    // GÃœNLÃœK CHECK SAYILARINI Ã‡EK (Adaletli daÄŸÄ±lÄ±m iÃ§in)
    const dailyCheckCounts = {};
    const who14Filled = {}; // 14:00 dolduran kiÅŸiler (gÃ¼n boyunca muaf)
    try {
        for (const branch of branches) {
            dailyCheckCounts[branch] = {};
            who14Filled[branch] = null;
            
            // BugÃ¼nkÃ¼ tÃ¼m submission'larÄ± Ã§ek
            const submissions = await db.collection('checklistSubmissions')
                .where('branch', '==', branch)
                .where('date', '==', todayStr)
                .get();
            
            submissions.forEach(doc => {
                const d = doc.data();
                const personName = d.personName || d.personelId || '';
                if (personName) {
                    dailyCheckCounts[branch][personName] = (dailyCheckCounts[branch][personName] || 0) + 1;
                }
                // 14:00 gÃ¼nlÃ¼k check'i dolduran
                if (doc.id.includes('_guncel_') && doc.id.includes('_1400')) {
                    who14Filled[branch] = personName;
                }
            });
        }
    } catch (e) {
        console.warn('Check sayÄ±larÄ± alÄ±namadÄ±:', e);
    }
    
    // Åžube mÃ¼dÃ¼rlerini Ã§ek
    const branchManagers = {};
    try {
        const managersSnap = await db.collection('personel')
            .where('role', 'in', ['magaza_muduru', 'magaza_mudur_yardimcisi'])
            .get();
        managersSnap.forEach(doc => {
            const d = doc.data();
            const displayName = d.codeName || formatDisplayName(d.name);
            if (d.branch && !branchManagers[d.branch]) {
                branchManagers[d.branch] = displayName;
            }
        });
    } catch (e) {
        console.warn('MÃ¼dÃ¼r bilgisi alÄ±namadÄ±:', e);
    }
    
    // KarÅŸÄ±lama kartÄ±nÄ± doldur
    if (welcomeCard) {
        const dateOptions = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
        const dateStr = today.toLocaleDateString('tr-TR', dateOptions);
        let greeting = 'GÃ¼naydÄ±n';
        if (currentHour >= 12 && currentHour < 18) greeting = 'Ä°yi gÃ¼nler';
        else if (currentHour >= 18 || currentHour < DAY_END_HOUR) greeting = 'Ä°yi akÅŸamlar';
        
        // Ä°sim: codeName varsa ilk kelimesi, yoksa name'in ilk kelimesi
        const displayName = currentUser?.codeName 
            ? currentUser.codeName.split(' ')[0] 
            : (userName || 'Personel').split(' ')[0];
        
        // TÃ¼rkiye saati
        const turkeyTime = now.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit', timeZone: 'Europe/Istanbul' });
        
        // SVG ikonlar (Lucide tarzÄ±)
        const locationIcon = '<svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>';
        const clockIcon = '<svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>';
        
        document.getElementById('welcomeDate').textContent = dateStr;
        document.getElementById('welcomeMessage').textContent = `${greeting}, ${displayName}! ðŸ‘‹`;
        document.getElementById('welcomeBranch').innerHTML = `<span style="display:flex;align-items:center">${locationIcon}</span> <span>${isFullAdmin ? 'TÃ¼m Åžubeler' : primaryBranch}</span>`;
        
        // Saat bilgisi (anlÄ±k TÃ¼rkiye saati)
        welcomeCard.style.display = 'block';
        document.getElementById('welcomeShift').innerHTML = `<span style="display:flex;align-items:center">${clockIcon}</span> <span>${turkeyTime}</span>`;
    }
    
    // DuyurularÄ± yÃ¼kle
    loadAnnouncements();
    
    // AylÄ±k puan kartÄ± (sadece personel iÃ§in)
    if (monthlyCard && !isFullAdmin) {
        monthlyCard.style.display = 'block';
        loadMonthlyPoints(); // Puan verilerini yÃ¼kle
    } else if (monthlyCard) {
        monthlyCard.style.display = 'none';
    }
    
    // Leaderboard ve KPI Dashboard (sadece yÃ¶neticiler iÃ§in)
    if (isFullAdmin) {
        loadLeaderboard();
        loadKPIDashboard();
    }
    
    // Otomatik kaÃ§Ä±rÄ±lan check kontrolÃ¼ (tÃ¼m kullanÄ±cÄ±lar iÃ§in Ã§alÄ±ÅŸÄ±r - gÃ¼venlik aÃ§Ä±ÄŸÄ± yok)
    setTimeout(() => checkAndProcessMissedChecks(), 5000);
    
    // ========== PERSONEL ROL BÄ°LGÄ°LERÄ°NÄ° YÃœKLE ==========
    const personelRoleMap = {}; // uniqueId/displayName â†’ role
    try {
        const personelSnap = await db.collection('personel').get();
        personelSnap.forEach(doc => {
            const p = doc.data();
            const role = p.role || 'barista';
            // TÃ¼m olasÄ± key formatlarÄ± iÃ§in kaydet
            if (p.uniqueId) personelRoleMap[p.uniqueId] = role;
            if (p.codeName) personelRoleMap[p.codeName] = role;
            if (p.name) {
                personelRoleMap[p.name] = role;
                personelRoleMap[normalizePersonelId(p.name)] = role;
                const firstName = p.name.split(' ')[0];
                const lastName = p.name.split(' ').slice(1).join(' ');
                const lastInitial = lastName?.charAt(0) || '';
                personelRoleMap[`${firstName} ${lastInitial}.`] = role;
            }
        });
    } catch (e) {
        console.warn('Personel rol bilgisi yÃ¼klenemedi:', e);
    }
    
    // Shift verilerini yÃ¼kle
    const shiftData = {};
    const rawShiftData = {}; // Ham shift verisi (adaletli atama iÃ§in)
    try {
        const weekStart = getWeekStart(today);
        const weekKey = formatDateLocal(weekStart);
        let dayIndex = today.getDay() - 1;
        if (dayIndex < 0) dayIndex = 6;
        
        // PARALEL SORGULAR - tÃ¼m ÅŸubeleri aynÄ± anda Ã§ek
        const shiftPromises = branches.map(async (branch) => {
            try {
                const shiftsSnapshot = await db.collection('shifts').where('branch', '==', branch).get();
                const allShifts = [];
                shiftsSnapshot.forEach(doc => allShifts.push(doc.data()));
                allShifts.sort((a, b) => (b.weekStart || '').localeCompare(a.weekStart || ''));
                
                const targetShift = allShifts.find(s => s.weekStart === weekKey);
                if (targetShift) {
                    const personelShifts = targetShift.personelShifts || {};
                    const personelNames = targetShift.personelNames || {};       // codeName (gÃ¶rÃ¼ntÃ¼ adÄ±)
                    const personelFullNames = targetShift.personelFullNames || {}; // tam isim
                    const acilisPersonel = [], kapanisPersonel = [], araPersonel = [];
                    const allActive = []; // TÃ¼m aktif personel (adaletli atama iÃ§in)
                    
                    for (const [uniqueIdOrName, days] of Object.entries(personelShifts)) {
                        const todayShift = days[dayIndex] || '';
                        const cleanShift = todayShift.replace(/\*/g, '').trim().toUpperCase();
                        
                        // OFF, Ä°ZÄ°N durumlarÄ±nÄ± atla
                        if (cleanShift === 'OFF' || cleanShift === 'Ä°' || cleanShift === '-' || cleanShift === 'X' || cleanShift === 'Y.Ä°') continue;
                        
                        // personelNames (codeName) KULLAN - en doÄŸru format
                        const displayName = personelNames[uniqueIdOrName] || formatDisplayName(personelFullNames[uniqueIdOrName] || uniqueIdOrName.replace(/_/g, ' '));
                        
                        // ROL BÄ°LGÄ°SÄ° AL
                        const role = personelRoleMap[uniqueIdOrName] || personelRoleMap[displayName] || 'barista';
                        
                        // Shift saatini parse et
                        const shiftTime = parseShiftTime(todayShift);
                        const personInfo = { 
                            id: uniqueIdOrName, 
                            name: displayName, 
                            shift: todayShift,
                            role: role, // ROL EKLENDÄ°
                            shiftStart: shiftTime?.startHour ?? 10,
                            shiftEnd: shiftTime?.endHour ?? 19
                        };
                        
                        if (cleanShift === 'A' || cleanShift.includes('AÃ‡ILI')) {
                            acilisPersonel.push(displayName);
                            allActive.push({ ...personInfo, type: 'acilis' });
                        } else if (cleanShift === 'K' || cleanShift.includes('KAPANI')) {
                            kapanisPersonel.push(displayName);
                            allActive.push({ ...personInfo, type: 'kapanis' });
                        } else if (cleanShift && cleanShift !== 'Ä°' && cleanShift !== 'OFF' && cleanShift !== '-') {
                            araPersonel.push(displayName);
                            allActive.push({ ...personInfo, type: 'ara' });
                        }
                    }
                    return { 
                        branch, 
                        data: { acilis: acilisPersonel, kapanis: kapanisPersonel, ara: araPersonel },
                        raw: { personelShifts, personelNames, personelFullNames, allActive, dayIndex }
                    };
                }
                return { branch, data: { acilis: [], kapanis: [], ara: [] }, raw: null };
            } catch (e) {
                return { branch, data: { acilis: [], kapanis: [], ara: [] }, raw: null };
            }
        });
        
        const shiftResults = await Promise.all(shiftPromises);
        shiftResults.forEach(r => { 
            shiftData[r.branch] = r.data; 
            rawShiftData[r.branch] = r.raw;
        });
    } catch (e) {
        console.warn('Shift yÃ¼kleme hatasÄ±:', e);
    }
    
    function getShiftPersonnel(branch, shiftType) {
        return shiftData[branch]?.[shiftType] || [];
    }
    
    // ========== ROL BAZLI FÄ°LTRELEME FONKSÄ°YONU ==========
    // checkType: 'mudur' â†’ sadece mÃ¼dÃ¼r/yardÄ±mcÄ±
    // checkType: diÄŸerleri â†’ barista varsa sadece baristalar, yoksa mÃ¼dÃ¼r
    // + ÅžU ANKÄ° SAATTE SHIFT'Ä° DEVAM EDENLER
    function filterPersonnelForCheck(allActiveList, checkType) {
        if (!allActiveList || allActiveList.length === 0) return [];
        
        // ÅžU ANKÄ° SAATTE AKTÄ°F OLANLARI FÄ°LTRELE
        const nowHour = new Date().getHours();
        const nowMinute = new Date().getMinutes();
        const nowTotalMinutes = nowHour * 60 + nowMinute;
        
        const currentlyWorking = allActiveList.filter(p => {
            const startHour = p.shiftStart ?? 10;
            const endHour = p.shiftEnd ?? 19;
            const startMinutes = startHour * 60;
            let endMinutes = endHour * 60;
            
            // Gece geÃ§iÅŸi kontrolÃ¼ (Ã¶rn: 16:00-01:00)
            if (endHour < startHour) {
                endMinutes += 24 * 60; // +24 saat
                let adjustedNow = nowTotalMinutes;
                if (nowHour < endHour) adjustedNow += 24 * 60;
                return adjustedNow >= startMinutes && adjustedNow <= endMinutes;
            }
            
            return nowTotalMinutes >= startMinutes && nowTotalMinutes <= endMinutes;
        });
        
        // Åžu an Ã§alÄ±ÅŸan yoksa boÅŸ dÃ¶ndÃ¼r
        if (currentlyWorking.length === 0) return [];
        
        // MÃ¼dÃ¼r Kontrol: sadece maÄŸaza mÃ¼dÃ¼rÃ¼ veya yardÄ±mcÄ±
        if (checkType === 'mudur') {
            const mudur = currentlyWorking.find(p => p.role === 'magaza_muduru');
            if (mudur) return [mudur.name];
            const yardimci = currentlyWorking.find(p => p.role === 'mudur_yardimcisi' || p.role === 'magaza_mudur_yardimcisi');
            if (yardimci) return [yardimci.name];
            const bolge = currentlyWorking.find(p => p.role === 'bolge_muduru');
            if (bolge) return [bolge.name];
            return [];
        }
        
        // DiÄŸer checkler: Ã–nce baristalar (mÃ¼dÃ¼r HARÄ°Ã‡)
        const baristalar = currentlyWorking.filter(p => 
            p.role !== 'magaza_muduru' && 
            p.role !== 'mudur_yardimcisi' && 
            p.role !== 'magaza_mudur_yardimcisi' &&
            p.role !== 'bolge_muduru'
        );
        
        // MÃ¼dÃ¼r yardÄ±mcÄ±sÄ±nÄ± da ekle (barista gibi Ã§alÄ±ÅŸÄ±r)
        const yardimcilar = currentlyWorking.filter(p => 
            p.role === 'mudur_yardimcisi' || p.role === 'magaza_mudur_yardimcisi'
        );
        
        // Barista varsa: baristalar + mÃ¼dÃ¼r yardÄ±mcÄ±larÄ±
        if (baristalar.length > 0) {
            return [...baristalar, ...yardimcilar].map(p => p.name);
        }
        
        // Barista yok ama yardÄ±mcÄ± var: yardÄ±mcÄ±
        if (yardimcilar.length > 0) {
            return yardimcilar.map(p => p.name);
        }
        
        // Barista ve yardÄ±mcÄ± yok: maÄŸaza mÃ¼dÃ¼rÃ¼ (TEK BAÅžINA)
        const mudur = currentlyWorking.find(p => p.role === 'magaza_muduru');
        if (mudur) return [mudur.name];
        
        // En son bÃ¶lge mÃ¼dÃ¼rÃ¼ (gÃ¶sterilir ama puan almaz)
        const bolge = currentlyWorking.find(p => p.role === 'bolge_muduru');
        if (bolge) return [bolge.name];
        
        return [];
    }
    
    // Dashboard ayarlarÄ±nÄ± al (Ã¶zelleÅŸtirilebilir mesajlar)
    const dashboardConfig = JSON.parse(localStorage.getItem('dashboardConfig') || '{}');
    const motivationMessages = dashboardConfig.motivationMessages || [
        'Harika gidiyorsun! ðŸ’ª',
        'BaÅŸarÄ±ya bir adÄ±m daha! â­',
        'MÃ¼thiÅŸ tempo! ðŸš€',
        'Tebrikler, devam et! ðŸŽ¯'
    ];
    
    // Åžube sÄ±ralamasÄ± - STATE.branches'dan (Firebase'den yÃ¼klenen dinamik deÄŸer)
    const branchOrder = STATE.branches || [];
    const sortedBranches = [...branches].sort((a, b) => {
        const aIndex = branchOrder.findIndex(o => a.includes(o) || o.includes(a));
        const bIndex = branchOrder.findIndex(o => b.includes(o) || o.includes(b));
        return (aIndex === -1 ? 999 : aIndex) - (bIndex === -1 ? 999 : bIndex);
    });
    
    let html = '';
    let totalChecks = 0;
    let completedChecks = 0;
    
    // Her ÅŸube iÃ§in check'leri topla ve render et
    for (const branch of sortedBranches) {
        const isMoonberry = true; // TÃ¼m ÅŸubeler Moonberry teal rengi
        const brandColor = '#008c95'; // Moonberry teal
        // Åžube adÄ±nÄ± olduÄŸu gibi gÃ¶ster (dinamik - Firebase'den)
        const branchShortName = branch; // Tam isim
        const branchClass = 'moonberry'; // Tek CSS class
        
        // Åžube check'lerini topla
        const branchChecks = [];
        
        // 1. Platform Check
        // Platform Check - CHECK_RULES'tan deÄŸerleri al
        const platformRules = CHECK_RULES.platform || DEFAULT_CHECK_RULES.platform || {};
        const platformLateWindow = platformRules.lateWindow || 30; // dakika
        
        // TimeSlots'u CHECK_RULES'tan al - {start, end} formatÄ±nÄ± destekle
        let platformSlots = []; // [{start: "10:00", end: "11:00"}, ...]
        if (platformRules.timeSlots && Array.isArray(platformRules.timeSlots)) {
            platformSlots = platformRules.timeSlots.map(slot => {
                if (typeof slot === 'string') {
                    return { start: slot, end: slot };
                }
                if (slot && slot.start) {
                    return { start: slot.start, end: slot.end || slot.start };
                }
                return null;
            }).filter(Boolean);
        }
        if (platformSlots.length === 0) {
            const defaultTimes = PLATFORM_CHECK_TIMES || ['10:00', '12:00', '15:00', '18:00', '21:00', '00:00'];
            platformSlots = defaultTimes.map(t => ({ start: t, end: t }));
        }
        
        // Eski format uyumluluÄŸu
        const platformTimes = platformSlots.map(s => s.start);
        
        let activePlatformSlot = null;
        let nextPlatformSlot = null;
        let platformRemainingMinutes = 0;
        let isPlatformLate = false;
        let isPlatformMissed = false;
        
        // Gece saatlerinde Ã¶zel mantÄ±k (maÄŸaza kapanÄ±ÅŸÄ±na kadar)
        const dayEndHourPlatform = getBusinessDayEndHour();
        const isLateNightPlatform = currentHour >= 0 && currentHour < dayEndHourPlatform;
        const nowMinutesPlatform = currentHour * 60 + currentMinutes;
        
        // 00:00 slotunu bul (gece iÃ§in)
        const midnightSlot = platformSlots.find(s => s.start === '00:00');
        
        // Gece saatlerinde ve 00:00 slotu varsa Ã¶zel kontrol
        if (isLateNightPlatform && midnightSlot) {
            // 00:00 slotunun late window kontrolÃ¼
            const [endH, endM] = midnightSlot.end.split(':').map(Number);
            const slotEndMinutes = endH * 60 + endM;
            const deadlineMinutes = slotEndMinutes + platformLateWindow;
            
            if (nowMinutesPlatform <= slotEndMinutes) {
                // Slot iÃ§inde
                activePlatformSlot = midnightSlot;
                platformRemainingMinutes = slotEndMinutes - nowMinutesPlatform + platformLateWindow;
            } else if (nowMinutesPlatform <= deadlineMinutes) {
                // Late window iÃ§inde
                activePlatformSlot = midnightSlot;
                platformRemainingMinutes = deadlineMinutes - nowMinutesPlatform;
                isPlatformLate = true;
            } else {
                // Late window geÃ§ti - MISSED
                activePlatformSlot = midnightSlot;
                isPlatformMissed = true;
                platformRemainingMinutes = 0;
            }
        } else {
            // GÃ¼ndÃ¼z veya gece ama 00:00 slotu yok - tÃ¼m slotlarÄ± kontrol et
            for (const slot of platformSlots) {
                if (slot.start === '00:00' && !isLateNightPlatform) continue; // 00:00 gece iÃ§in ayrÄ±
                
                const [startH, startM] = slot.start.split(':').map(Number);
                const [endH, endM] = slot.end.split(':').map(Number);
                const slotStartMinutes = startH * 60 + startM;
                const slotEndMinutes = endH * 60 + endM;
                const deadlineMinutes = slotEndMinutes + platformLateWindow;
                const nowMinutes = currentHour * 60 + currentMinutes;
                
                // Slot baÅŸlangÄ±cÄ±ndan deadline'a kadar aktif
                if (nowMinutes >= slotStartMinutes && nowMinutes <= slotEndMinutes) {
                    // Slot iÃ§inde - aktif, vaktinde
                    activePlatformSlot = slot;
                    platformRemainingMinutes = slotEndMinutes - nowMinutes + platformLateWindow;
                    break;
                } else if (nowMinutes > slotEndMinutes && nowMinutes <= deadlineMinutes) {
                    // Late window iÃ§inde
                    activePlatformSlot = slot;
                    platformRemainingMinutes = deadlineMinutes - nowMinutes;
                    isPlatformLate = true;
                    break;
                } else if (nowMinutes > deadlineMinutes && nowMinutes < slotStartMinutes + 120) {
                    // Slot geÃ§ti - missed
                    isPlatformMissed = true;
                    activePlatformSlot = slot;
                    break;
                }
                
                // Gelecek en yakÄ±n slot
                if (nowMinutes < slotStartMinutes && !nextPlatformSlot) {
                    nextPlatformSlot = slot;
                }
            }
        }
        
        // Display iÃ§in slot seÃ§ - her zaman bir slot gÃ¶ster
        let displayPlatformSlot = activePlatformSlot || nextPlatformSlot;
        
        // HiÃ§ slot bulunamadÄ±ysa (gece tÃ¼m slotlar geÃ§miÅŸse), ilk slotu gÃ¶ster (pasif)
        if (!displayPlatformSlot && platformSlots.length > 0) {
            displayPlatformSlot = platformSlots[0];
            // Gece saatlerinde ve slot yoksa - bugÃ¼nÃ¼n slotlarÄ± bitti
            if (isLateNightPlatform) {
                isPlatformMissed = false; // KaÃ§Ä±rÄ±lmadÄ±, sadece bugÃ¼n bitti
            }
        }
        
        const activePlatformTime = displayPlatformSlot?.start || null;
        const nextPlatformTime = nextPlatformSlot?.start || null;
        
        // Platform kartÄ± HER ZAMAN gÃ¶rÃ¼nÃ¼r
        {
            const platformSubmissionId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_platform_${todayStr}_${(activePlatformTime || '').replace(':', '')}`;
            let platformCompleted = false;
            try {
                if (activePlatformTime) {
                    const doc = await db.collection('checklistSubmissions').doc(platformSubmissionId).get();
                    platformCompleted = doc.exists;
                }
            } catch (e) {}
            
            // SAAT BAZLI PLATFORM CHECK ATAMA
            const platformHour = parseInt((activePlatformTime || nextPlatformTime || '10:00').split(':')[0]);
            let platformPersonnel = [];
            let platformSubLabel = '';
            const rawData = rawShiftData[branch];
            const branchCheckCounts = dailyCheckCounts[branch] || {};
            
            // Adaletli daÄŸÄ±lÄ±m helper - en az check doldurana Ã¶ncelik
            function selectFairFromCandidates(candidates) {
                if (candidates.length === 0) return [];
                // Check sayÄ±larÄ±na gÃ¶re sÄ±rala
                candidates.sort((a, b) => {
                    const countA = branchCheckCounts[a.name] || 0;
                    const countB = branchCheckCounts[b.name] || 0;
                    return countA - countB;
                });
                // En az check dolduran(lar)Ä± dÃ¶ndÃ¼r
                const minCount = branchCheckCounts[candidates[0].name] || 0;
                return candidates.filter(p => (branchCheckCounts[p.name] || 0) === minCount).map(p => p.name);
            }
            
            if (rawData?.allActive) {
                // Ã–NCELÄ°KLE ROL FÄ°LTRELEMESÄ° UYGULA
                // Barista varsa mÃ¼dÃ¼r gÃ¶rÃ¼nmez
                const filteredActive = filterPersonnelForCheck(rawData.allActive, 'platform')
                    .map(name => rawData.allActive.find(p => p.name === name))
                    .filter(Boolean);
                
                // filteredActive boÅŸsa tÃ¼m aktif personeli kullan (fallback)
                const workingActive = filteredActive.length > 0 ? filteredActive : rawData.allActive;
                
                switch (platformHour) {
                    case 10:
                        // 10:00 â†’ AÃ§Ä±lÄ±ÅŸÃ§Ä±ya
                        platformPersonnel = workingActive.filter(p => p.type === 'acilis').map(p => p.name);
                        platformSubLabel = 'AÃ§Ä±lÄ±ÅŸÃ§Ä±';
                        break;
                    case 12:
                        // 12:00 â†’ Shift giriÅŸi varsa giren, yoksa aÃ§Ä±lÄ±ÅŸÃ§Ä±
                        const entryAt12 = workingActive.find(p => p.shiftStart >= 11 && p.shiftStart <= 12);
                        if (entryAt12) {
                            platformPersonnel = [entryAt12.name];
                            platformSubLabel = 'Shift giren';
                        } else {
                            platformPersonnel = workingActive.filter(p => p.type === 'acilis').map(p => p.name);
                            platformSubLabel = 'AÃ§Ä±lÄ±ÅŸÃ§Ä±';
                        }
                        break;
                    case 15:
                        // 15:00 â†’ Adaletli daÄŸÄ±lÄ±m (en az check doldurana Ã¶ncelik)
                        {
                            const candidates15 = workingActive.filter(p => p.shiftStart <= 15 && (p.shiftEnd > 15 || p.shiftEnd <= 2));
                            platformPersonnel = selectFairFromCandidates(candidates15);
                        }
                        platformSubLabel = 'EÅŸit daÄŸÄ±lÄ±m';
                        break;
                    case 18:
                        // 18:00 â†’ HiÃ§ doldurmamÄ±ÅŸa Ã¶ncelik (en az check doldurana)
                        {
                            const candidates18 = workingActive.filter(p => p.shiftStart <= 18 && (p.shiftEnd > 18 || p.shiftEnd <= 2));
                            platformPersonnel = selectFairFromCandidates(candidates18);
                        }
                        platformSubLabel = 'EÅŸit daÄŸÄ±lÄ±m';
                        break;
                    case 21:
                        // 21:00 â†’ HiÃ§ doldurmamÄ±ÅŸa Ã¶ncelik
                        {
                            const candidates21 = workingActive.filter(p => p.shiftStart <= 21 && (p.shiftEnd > 21 || p.shiftEnd <= 2));
                            platformPersonnel = selectFairFromCandidates(candidates21);
                        }
                        platformSubLabel = 'EÅŸit daÄŸÄ±lÄ±m';
                        break;
                    case 0:
                    case 24:
                        // 00:00 â†’ KapanÄ±ÅŸÃ§Ä±lara
                        platformPersonnel = workingActive.filter(p => p.type === 'kapanis').map(p => p.name);
                        platformSubLabel = 'KapanÄ±ÅŸÃ§Ä±';
                        break;
                    default:
                        platformPersonnel = workingActive.map(p => p.name);
                }
            }
            
            // Fallback
            if (platformPersonnel.length === 0) {
                if (platformHour === 10) {
                    platformPersonnel = getShiftPersonnel(branch, 'acilis');
                } else if (platformHour >= 21 || platformHour === 0) {
                    platformPersonnel = [...getShiftPersonnel(branch, 'ara'), ...getShiftPersonnel(branch, 'kapanis')];
                } else {
                    platformPersonnel = [...getShiftPersonnel(branch, 'acilis'), ...getShiftPersonnel(branch, 'ara'), ...getShiftPersonnel(branch, 'kapanis')];
                }
            }
            platformPersonnel = platformPersonnel.filter((v, i, a) => a.indexOf(v) === i);
            
            branchChecks.push({
                id: 'platform',
                name: getChecklistTypeName(branch, 'platform', 'Platform KontrolÃ¼'),
                icon: 'smartphone',
                activeFrom: displayPlatformSlot?.start || '10:00',
                deadline: displayPlatformSlot?.end || displayPlatformSlot?.start || '10:00',
                lateWindow: platformLateWindow,
                subLabel: platformSubLabel + (isPlatformMissed ? ' (KaÃ§Ä±rÄ±ldÄ±)' : isPlatformLate ? ' (GeÃ§!)' : ''),
                isCompleted: platformCompleted,
                isActive: !!activePlatformSlot && !platformCompleted && !isPlatformMissed,
                isMissed: isPlatformMissed && !platformCompleted,
                canStillFill: !isPlatformMissed,
                remainingMinutes: activePlatformSlot && !platformCompleted && !isPlatformMissed ? platformRemainingMinutes : null,
                remainingText: activePlatformSlot && !platformCompleted && !isPlatformMissed ? `${platformRemainingMinutes}dk` : '',
                personnel: platformPersonnel,
                points: (CHECK_RULES.platform || DEFAULT_CHECK_RULES.platform || {}).points || { onTime: 0, late: 0, missed: -1 },
                priority: platformCompleted ? 90 : (isPlatformMissed ? 99 : (activePlatformSlot ? 10 : 50)),
                onClick: isPlatformMissed ? '' : `goToChecklist('${branch}', 'platform', '${displayPlatformSlot?.start || '10:00'}')`
            });
            totalChecks++;
            if (platformCompleted) completedChecks++;
        }
        
        // 2. Temizlik Check
        {
            // CHECK_RULES'dan ayarlarÄ± al
            const temizlikRules = CHECK_RULES.aylik || CHECK_RULES.temizlik || {};
            const temizlikShifts = temizlikRules.shifts || {
                acilisci: { deadline: '15:00', window: { start: '10:00', end: '15:00' } },
                araci: { deadline: '19:00', window: { start: '11:00', end: '19:00' } },
                kapanisci: { deadline: '02:00', window: { start: '16:00', end: '02:00' } }
            };
            
            // Personelin vardiya tipini belirle (aÃ§Ä±lÄ±ÅŸÃ§Ä±, aracÄ±, kapanÄ±ÅŸÃ§Ä±)
            // Åžu anki saate gÃ¶re hangi vardiya aktif?
            let currentShiftType = 'araci'; // varsayÄ±lan
            if (currentHour >= 6 && currentHour < 12) {
                currentShiftType = 'acilisci';
            } else if (currentHour >= 12 && currentHour < 18) {
                currentShiftType = 'araci';
            } else {
                currentShiftType = 'kapanisci';
            }
            
            // Åžu anki kullanÄ±cÄ±nÄ±n shift'ine gÃ¶re tip belirle
            if (currentUser?.shiftStartTime) {
                const [sh, sm] = currentUser.shiftStartTime.split(':').map(Number);
                const shiftStartMinutes = sh * 60 + sm;
                
                if (shiftStartMinutes >= 6*60 && shiftStartMinutes < 11*60) {
                    currentShiftType = 'acilisci';
                } else if (shiftStartMinutes >= 11*60 && shiftStartMinutes < 16*60) {
                    currentShiftType = 'araci';
                } else {
                    currentShiftType = 'kapanisci';
                }
            }
            
            // Ä°lgili shift ayarlarÄ±nÄ± al
            const shiftConfig = temizlikShifts[currentShiftType] || temizlikShifts.araci;
            let temizlikActiveFrom = shiftConfig.window?.start || '10:00';
            let temizlikDeadline = shiftConfig.window?.end || shiftConfig.deadline || '18:00';
            let temizlikLateWindow = temizlikRules.lateWindow || 30;
            
            // NOT: Saatler Check & Puantaj KurallarÄ±'ndan (shifts) geliyor
            // periods eski yapÄ± - artÄ±k kullanÄ±lmÄ±yor, shifts Ã¶ncelikli
            
            const temizlikSubmissionId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_aylik_${todayStr}_${currentShiftType}`;
            let temizlikCompleted = false;
            
            try {
                const doc = await db.collection('checklistSubmissions').doc(temizlikSubmissionId).get();
                temizlikCompleted = doc.exists;
            } catch (e) {}
            
            // Aktiflik ve kaÃ§Ä±rÄ±lma kontrolÃ¼
            const [tafH, tafM] = temizlikActiveFrom.split(':').map(Number);
            const [tdH, tdM] = temizlikDeadline.split(':').map(Number);
            const nowMin = currentHour * 60 + currentMinutes;
            let activeFromMin = tafH * 60 + tafM;
            let deadlineMin = tdH * 60 + tdM;
            let lateEndMin = deadlineMin + temizlikLateWindow;
            
            // Gece geÃ§iÅŸi kontrolÃ¼
            if (tdH < tafH) {
                deadlineMin += 24 * 60;
                lateEndMin += 24 * 60;
            }
            let adjustedNow = nowMin;
            const dayEndHourTemizlik = getBusinessDayEndHour();
            if (currentHour < dayEndHourTemizlik && tafH > 12) {
                adjustedNow += 24 * 60;
            }
            
            const isTemizlikActive = adjustedNow >= activeFromMin && adjustedNow <= deadlineMin && !temizlikCompleted;
            const isTemizlikLate = adjustedNow > deadlineMin && adjustedNow <= lateEndMin && !temizlikCompleted;
            const isTemizlikMissed = adjustedNow > lateEndMin && !temizlikCompleted;
            
            // Kalan sÃ¼re hesapla
            let temizlikRemainingMinutes = null;
            if (isTemizlikActive) {
                temizlikRemainingMinutes = deadlineMin - adjustedNow;
            } else if (isTemizlikLate) {
                temizlikRemainingMinutes = lateEndMin - adjustedNow;
            } else if (isTemizlikMissed) {
                temizlikRemainingMinutes = 0;
            }
            
            // SubLabel belirleme
            const shiftTypeLabels = {
                acilisci: 'AÃ§Ä±lÄ±ÅŸ',
                araci: 'Ara Vardiya',
                kapanisci: 'KapanÄ±ÅŸ'
            };
            let temizlikSubLabel = shiftTypeLabels[currentShiftType] || 'Vardiya';
            if (!isTemizlikActive && !isTemizlikLate && !isTemizlikMissed && !temizlikCompleted) {
                temizlikSubLabel = `${temizlikActiveFrom}'de aktif`;
            } else if (isTemizlikLate) {
                temizlikSubLabel = 'GeÃ§ kalÄ±ndÄ±!';
            } else if (isTemizlikMissed) {
                temizlikSubLabel = 'KaÃ§Ä±rÄ±ldÄ±';
            }
            
            // Personel listesi - vardiya tipine gÃ¶re + ROL FÄ°LTRELEMESÄ°
            const shiftToPersonnelType = {
                acilisci: 'acilis',
                araci: 'all', // AracÄ±lar iÃ§in tÃ¼m personel
                kapanisci: 'kapanis'
            };
            const temizlikPersonnelRaw = getShiftPersonnel(branch, shiftToPersonnelType[currentShiftType] || 'all');
            // ROL FÄ°LTRELEMESÄ°: Barista varsa mÃ¼dÃ¼r gÃ¶rÃ¼nmez
            const temizlikPersonnel = filterPersonnelForCheck(rawShiftData[branch]?.allActive || [], 'temizlik');
            
            branchChecks.push({
                id: 'temizlik',
                name: getChecklistTypeName(branch, 'aylik', 'Temizlik ve BakÄ±m'),
                icon: 'sparkle',
                activeFrom: temizlikActiveFrom,
                deadline: temizlikDeadline,
                lateWindow: temizlikLateWindow,
                subLabel: temizlikSubLabel,
                isCompleted: temizlikCompleted,
                isActive: isTemizlikActive || isTemizlikLate,
                isMissed: isTemizlikMissed,
                canStillFill: !isTemizlikMissed,
                remainingMinutes: temizlikRemainingMinutes,
                remainingText: '',
                personnel: temizlikPersonnel,
                points: CHECK_RULES.aylik?.points || CHECK_RULES.temizlik?.points || { onTime: 1, late: 0, missed: -1 },
                priority: temizlikCompleted ? 90 : (isTemizlikMissed ? 99 : (isTemizlikActive ? 15 : 70)),
                onClick: isTemizlikMissed ? '' : `goToChecklist('${branch}', 'aylik', '${currentShiftType}')`
            });
            totalChecks++;
            if (temizlikCompleted) completedChecks++;
        }
        
        // 3. AÃ§Ä±lÄ±ÅŸ HazÄ±rlÄ±klarÄ±
        {
            const acilisRules = CHECK_RULES.acilis || {};
            const acilisActiveFrom = acilisRules.activeFrom || '09:00';
            const acilisDeadline = acilisRules.deadline || '11:00';
            const acilisLateWindow = acilisRules.lateWindow || 30;
            
            const acilisSubmissionId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_acilis_${todayStr}`;
            let acilisCompleted = false;
            try {
                const doc = await db.collection('checklistSubmissions').doc(acilisSubmissionId).get();
                acilisCompleted = doc.exists;
            } catch (e) {}
            
            // Aktiflik ve kaÃ§Ä±rÄ±lma kontrolÃ¼
            const [aafH, aafM] = acilisActiveFrom.split(':').map(Number);
            const [adH, adM] = acilisDeadline.split(':').map(Number);
            const nowMin = currentHour * 60 + currentMinutes;
            const acilisActiveFromMin = aafH * 60 + aafM;
            const acilisDeadlineMin = adH * 60 + adM;
            const acilisLateEndMin = acilisDeadlineMin + acilisLateWindow;
            
            // Gece yarÄ±sÄ±nÄ± geÃ§en zaman aralÄ±ÄŸÄ± kontrolÃ¼
            let isAcilisActive, isAcilisLate, isAcilisMissed;
            
            if (acilisDeadlineMin < acilisActiveFromMin) {
                // Gece yarÄ±sÄ±nÄ± geÃ§iyor (Ã¶rn: 09:30 - 02:00)
                const isInActiveRange = nowMin >= acilisActiveFromMin || nowMin <= acilisDeadlineMin;
                const isInLateRange = nowMin > acilisDeadlineMin && nowMin <= acilisLateEndMin;
                const isPastLate = nowMin > acilisLateEndMin && nowMin < acilisActiveFromMin;
                
                isAcilisActive = isInActiveRange && !acilisCompleted;
                isAcilisLate = isInLateRange && !acilisCompleted;
                isAcilisMissed = isPastLate && !acilisCompleted;
            } else {
                // Normal aralÄ±k (aynÄ± gÃ¼n iÃ§inde)
                isAcilisActive = nowMin >= acilisActiveFromMin && nowMin <= acilisDeadlineMin && !acilisCompleted;
                isAcilisLate = nowMin > acilisDeadlineMin && nowMin <= acilisLateEndMin && !acilisCompleted;
                isAcilisMissed = nowMin > acilisLateEndMin && !acilisCompleted;
            }
            
            // Kalan sÃ¼re
            let acilisRemainingMinutes = null;
            if (isAcilisActive) {
                acilisRemainingMinutes = acilisDeadlineMin - nowMin;
            } else if (isAcilisLate) {
                acilisRemainingMinutes = acilisLateEndMin - nowMin;
            } else if (isAcilisMissed) {
                acilisRemainingMinutes = 0;
            }
            
            // SubLabel
            let acilisSubLabel = '';
            if (nowMin < acilisActiveFromMin && !acilisCompleted) {
                acilisSubLabel = `${acilisActiveFrom}'de aktif`;
            } else if (isAcilisLate) {
                acilisSubLabel = 'GeÃ§ kalÄ±ndÄ±!';
            } else if (isAcilisMissed) {
                acilisSubLabel = 'KaÃ§Ä±rÄ±ldÄ±';
            }
            
            const acilisPersonnelRaw = getShiftPersonnel(branch, 'acilis');
            // ROL + SHIFT SAATÄ° FÄ°LTRELEMESÄ°: Åžu an aktif ve barista Ã¶ncelikli
            const acilisPersonnel = filterPersonnelForCheck(rawShiftData[branch]?.allActive || [], 'acilis');
            
            branchChecks.push({
                id: 'acilis',
                name: getChecklistTypeName(branch, 'acilis', 'AÃ§Ä±lÄ±ÅŸ HazÄ±rlÄ±klarÄ±'),
                icon: 'sunrise',
                activeFrom: acilisActiveFrom,
                deadline: acilisDeadline,
                lateWindow: acilisLateWindow,
                subLabel: acilisSubLabel,
                isCompleted: acilisCompleted,
                isActive: isAcilisActive || isAcilisLate,
                isMissed: isAcilisMissed,
                canStillFill: !isAcilisMissed,
                remainingMinutes: acilisRemainingMinutes,
                remainingText: '',
                personnel: acilisPersonnel,
                points: acilisRules.points || { onTime: 3, late: 0, missed: -2 },
                priority: acilisCompleted ? 95 : (isAcilisMissed ? 99 : (isAcilisActive ? 5 : 70)),
                onClick: isAcilisMissed ? '' : `goToChecklist('${branch}', 'acilis', null)`
            });
            totalChecks++;
            if (acilisCompleted) completedChecks++;
        }
        
        // 4. KapanÄ±ÅŸ HazÄ±rlÄ±klarÄ±
        {
            const kapanisRules = CHECK_RULES.kapanis || {};
            // Saatler Check & Puantaj KurallarÄ±'ndan geliyor
            const kapanisActiveFrom = kapanisRules.activeFrom || '22:00';
            const kapanisDeadline = kapanisRules.deadline || '02:00';
            const kapanisLateWindow = kapanisRules.lateWindow || 30;
            
            const kapanisSubmissionId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_kapanis_${todayStr}`;
            let kapanisCompleted = false;
            try {
                const doc = await db.collection('checklistSubmissions').doc(kapanisSubmissionId).get();
                kapanisCompleted = doc.exists;
            } catch (e) {}
            
            // Aktiflik ve kaÃ§Ä±rÄ±lma kontrolÃ¼ (gece geÃ§iÅŸi var)
            const [kafH, kafM] = kapanisActiveFrom.split(':').map(Number);
            const [kdH, kdM] = kapanisDeadline.split(':').map(Number);
            const nowMin = currentHour * 60 + currentMinutes;
            let kapanisActiveFromMin = kafH * 60 + kafM;
            let kapanisDeadlineMin = kdH * 60 + kdM;
            
            // Gece geÃ§iÅŸi kontrolÃ¼ (deadline gece yarÄ±sÄ±ndan sonra ise)
            if (kdH < kafH) {
                kapanisDeadlineMin += 24 * 60;
            }
            let kapanisLateEndMin = kapanisDeadlineMin + kapanisLateWindow;
            
            let adjustedNow = nowMin;
            const dayEndHourKapanis = getBusinessDayEndHour();
            if (currentHour < dayEndHourKapanis) {
                adjustedNow += 24 * 60;
            }
            
            const isKapanisActive = adjustedNow >= kapanisActiveFromMin && adjustedNow <= kapanisDeadlineMin && !kapanisCompleted;
            const isKapanisLate = adjustedNow > kapanisDeadlineMin && adjustedNow <= kapanisLateEndMin && !kapanisCompleted;
            const isKapanisMissed = adjustedNow > kapanisLateEndMin && !kapanisCompleted && currentHour < 12;
            
            // Kalan sÃ¼re
            let kapanisRemainingMinutes = null;
            if (isKapanisActive) {
                kapanisRemainingMinutes = kapanisDeadlineMin - adjustedNow;
            } else if (isKapanisLate) {
                kapanisRemainingMinutes = kapanisLateEndMin - adjustedNow;
            } else if (isKapanisMissed) {
                kapanisRemainingMinutes = 0;
            }
            
            // SubLabel
            let kapanisSubLabel = '';
            const isBeforeKapanisTime = (currentHour >= 6 && currentHour < kafH);
            if (isBeforeKapanisTime && !kapanisCompleted) {
                kapanisSubLabel = `${kapanisActiveFrom}'de aktif`;
            } else if (isKapanisLate) {
                kapanisSubLabel = 'GeÃ§ kalÄ±ndÄ±!';
            } else if (isKapanisMissed) {
                kapanisSubLabel = 'KaÃ§Ä±rÄ±ldÄ±';
            }
            
            const kapanisPersonnelRaw = getShiftPersonnel(branch, 'kapanis');
            // ROL + SHIFT SAATÄ° FÄ°LTRELEMESÄ°: Åžu an aktif ve barista Ã¶ncelikli
            const kapanisPersonnel = filterPersonnelForCheck(rawShiftData[branch]?.allActive || [], 'kapanis');
            
            branchChecks.push({
                id: 'kapanis',
                name: getChecklistTypeName(branch, 'kapanis', 'KapanÄ±ÅŸ HazÄ±rlÄ±klarÄ±'),
                icon: 'sunset',
                activeFrom: kapanisActiveFrom,
                deadline: kapanisDeadline,
                lateWindow: kapanisLateWindow,
                subLabel: kapanisSubLabel,
                isCompleted: kapanisCompleted,
                isActive: isKapanisActive || isKapanisLate,
                isMissed: isKapanisMissed,
                canStillFill: !isKapanisMissed,
                remainingMinutes: kapanisRemainingMinutes,
                remainingText: '',
                personnel: kapanisPersonnel,
                points: kapanisRules.points || { onTime: 4, late: 0, missed: -2 },
                priority: kapanisCompleted ? 95 : (isKapanisMissed ? 99 : (isKapanisActive ? 5 : 70)),
                onClick: isKapanisMissed ? '' : `goToChecklist('${branch}', 'kapanis', null)`
            });
            totalChecks++;
            if (kapanisCompleted) completedChecks++;
        }
        
        // 5. GÃ¼nlÃ¼k Genel Check (14:00, 18:00, 22:00 - her zaman gÃ¶ster)
        // GÃ¼nlÃ¼k Check - CHECK_RULES'tan saat ve lateWindow deÄŸerlerini al
        const gunlukRules = CHECK_RULES.gunluk || DEFAULT_CHECK_RULES.gunluk || {};
        const gunlukLateWindow = gunlukRules.lateWindow || 30; // dakika
        
        // TimeSlots'u CHECK_RULES'tan al - {start, end} formatÄ±nÄ± destekle
        let gunlukSlots = []; // [{start: "14:00", end: "16:00"}, ...]
        if (gunlukRules.timeSlots && Array.isArray(gunlukRules.timeSlots)) {
            gunlukSlots = gunlukRules.timeSlots.map(slot => {
                if (typeof slot === 'string') {
                    // Eski format: sadece saat string'i
                    return { start: slot, end: slot };
                }
                if (slot && slot.start) {
                    // Yeni format: {start, end}
                    return { start: slot.start, end: slot.end || slot.start };
                }
                return null;
            }).filter(Boolean);
        }
        if (gunlukSlots.length === 0) {
            gunlukSlots = [
                { start: '14:00', end: '14:00' },
                { start: '18:00', end: '18:00' },
                { start: '22:00', end: '22:00' }
            ];
        }
        
        // Eski format iÃ§in uyumluluk - string array
        const gunlukTimes = gunlukSlots.map(s => s.start);
        
        let activeGunlukSlot = null;
        let nextGunlukSlot = null; // null ile baÅŸla, dÃ¶ngÃ¼de ilk gelecek slot atanacak
        let gunlukRemainingMinutes = 0;
        let isGunlukActive = false;
        let isGunlukLate = false;
        let isGunlukMissed = false;
        
        // Gece saatlerinde (maÄŸaza kapanÄ±ÅŸÄ±na kadar) - SON slot'un gece geÃ§iÅŸini kontrol et
        const dayEndHourGunluk = getBusinessDayEndHour();
        const isLateNight = currentHour >= 0 && currentHour < dayEndHourGunluk;
        const nowMinutesTotal = currentHour * 60 + currentMinutes;
        
        if (isLateNight) {
            // Gece saatlerinde son slot'u kontrol et
            const lastSlot = gunlukSlots[gunlukSlots.length - 1];
            const [lastStartH, lastStartM] = lastSlot.start.split(':').map(Number);
            const [lastEndH, lastEndM] = lastSlot.end.split(':').map(Number);
            
            let lastSlotEndMinutes = lastEndH * 60 + lastEndM;
            let lastSlotStartMinutes = lastStartH * 60 + lastStartM;
            
            // Gece geÃ§iÅŸi kontrolÃ¼ (end < start ise ertesi gÃ¼ne taÅŸÄ±)
            if (lastEndH < lastStartH) {
                lastSlotEndMinutes += 24 * 60; // 02:00 â†’ 26:00 (1560 dk)
            }
            
            const lastDeadlineMinutes = lastSlotEndMinutes + gunlukLateWindow;
            
            // Åžu anki zamanÄ± da ertesi gÃ¼ne taÅŸÄ±
            const adjustedNow = nowMinutesTotal + 24 * 60; // 00:31 â†’ 24:31 (1471 dk)
            
            if (adjustedNow >= lastSlotStartMinutes && adjustedNow <= lastSlotEndMinutes) {
                // Slot iÃ§inde - aktif, vaktinde
                activeGunlukSlot = lastSlot;
                isGunlukActive = true;
                gunlukRemainingMinutes = lastSlotEndMinutes - adjustedNow;
            } else if (adjustedNow > lastSlotEndMinutes && adjustedNow <= lastDeadlineMinutes) {
                // Late window iÃ§inde
                activeGunlukSlot = lastSlot;
                isGunlukActive = true;
                isGunlukLate = true;
                gunlukRemainingMinutes = lastDeadlineMinutes - adjustedNow;
            } else if (adjustedNow > lastDeadlineMinutes) {
                // GeÃ§miÅŸ - kaÃ§Ä±rÄ±ldÄ±
                activeGunlukSlot = lastSlot;
                isGunlukMissed = true;
                isGunlukActive = false;
                gunlukRemainingMinutes = 0;
            }
        } else {
            for (const slot of gunlukSlots) {
                const [startH, startM] = slot.start.split(':').map(Number);
                const [endH, endM] = slot.end.split(':').map(Number);
                const slotStartMinutes = startH * 60 + startM;
                const slotEndMinutes = endH * 60 + endM;
                const deadlineMinutes = slotEndMinutes + gunlukLateWindow;
                const nowMinutes = currentHour * 60 + currentMinutes;
                
                // Slot baÅŸlangÄ±cÄ±ndan deadline'a kadar aktif pencere
                const windowStart = slotStartMinutes;
                
                if (nowMinutes >= windowStart && nowMinutes <= slotEndMinutes) {
                    // Slot iÃ§inde - aktif, vaktinde
                    activeGunlukSlot = slot;
                    gunlukRemainingMinutes = slotEndMinutes - nowMinutes + gunlukLateWindow;
                    isGunlukActive = true;
                    break;
                } else if (nowMinutes > slotEndMinutes && nowMinutes <= deadlineMinutes) {
                    // Late window iÃ§inde
                    activeGunlukSlot = slot;
                    gunlukRemainingMinutes = deadlineMinutes - nowMinutes;
                    isGunlukActive = true;
                    isGunlukLate = true;
                    break;
                } else if (nowMinutes > deadlineMinutes && nowMinutes < slotStartMinutes + 180) {
                    // Slot geÃ§ti ama Ã§ok uzak deÄŸil - missed
                    activeGunlukSlot = slot;
                    isGunlukMissed = true;
                    break;
                }
                
                // Gelecek en yakÄ±n slot
                if (nowMinutes < windowStart && !nextGunlukSlot) {
                    nextGunlukSlot = slot;
                    break; // Ä°lk gelecek slottan sonra dur
                }
            }
        }
        
        // Aktif veya bir sonraki slot'u kullan
        const displayGunlukSlot = activeGunlukSlot || nextGunlukSlot;
        const displayGunlukTime = displayGunlukSlot?.start || '14:00';
        const displayGunlukEnd = displayGunlukSlot?.end || displayGunlukTime;
        
        {
            const gunlukSubmissionId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_guncel_${todayStr}_${displayGunlukTime.replace(':', '')}`;
            let gunlukCompleted = false;
            try {
                const doc = await db.collection('checklistSubmissions').doc(gunlukSubmissionId).get();
                gunlukCompleted = doc.exists;
            } catch (e) {}
            
            // GÃ¼nlÃ¼k check iÃ§in SAAT BAZLI ADALETLÄ° ATAMA
            let gunlukPersonnel = [];
            let gunlukSubLabel = '';
            const rawData = rawShiftData[branch];
            const gunlukHour = parseInt(displayGunlukTime.split(':')[0]);
            const branchCheckCounts = dailyCheckCounts[branch] || {};
            const filled14 = who14Filled[branch]; // 14:00 dolduran kiÅŸi (gÃ¼n boyunca muaf)
            
            // Gece saatlerinde (00:00-02:00) kapanÄ±ÅŸÃ§Ä±lara ata
            if (isLateNight) {
                gunlukPersonnel = filterPersonnelForCheck(rawShiftData[branch]?.allActive || [], 'gunluk');
                gunlukSubLabel = 'KapanÄ±ÅŸÃ§Ä±';
                console.log('[GÃ¼nlÃ¼k] Gece saati - aktif personele atandÄ±:', gunlukPersonnel);
            } else if (rawData?.allActive) {
                // ROL + SHIFT SAATÄ° FÄ°LTRELEMESÄ°: Barista varsa mÃ¼dÃ¼r gÃ¶rÃ¼nmez
                const filteredActive = filterPersonnelForCheck(rawData.allActive, 'gunluk')
                    .map(name => rawData.allActive.find(p => p.name === name))
                    .filter(Boolean);
                const workingActive = filteredActive.length > 0 ? filteredActive : rawData.allActive;
                
                if (gunlukHour === 14) {
                    // 14:00 â†’ AÃ§Ä±lÄ±ÅŸtan sonra ilk shift giren (11:00-13:00 arasÄ± baÅŸlayan)
                    const firstEntry = workingActive
                        .filter(p => p.shiftStart >= 11 && p.shiftStart <= 13)
                        .sort((a, b) => a.shiftStart - b.shiftStart)[0];
                    if (firstEntry) {
                        gunlukPersonnel = [firstEntry.name];
                        gunlukSubLabel = 'Ä°lk giren';
                    } else {
                        // Ä°lk giren yoksa aÃ§Ä±lÄ±ÅŸÃ§Ä±
                        gunlukPersonnel = workingActive
                            .filter(p => p.type === 'acilis')
                            .map(p => p.name);
                        gunlukSubLabel = 'AÃ§Ä±lÄ±ÅŸÃ§Ä±';
                    }
                } else {
                    // 18:00, 22:00 â†’ Adaletli daÄŸÄ±lÄ±m (14:00 dolduran muaf, en az check doldurana Ã¶ncelik)
                    let candidates = workingActive.filter(p => {
                        // Gece geÃ§iÅŸi kontrolÃ¼
                        if (p.shiftEnd < p.shiftStart) {
                            return gunlukHour >= p.shiftStart || gunlukHour < p.shiftEnd;
                        }
                        return gunlukHour >= p.shiftStart && gunlukHour < p.shiftEnd;
                    });
                    
                    // 14:00 dolduranÄ± muaf tut (eÄŸer birden fazla kiÅŸi varsa)
                    if (filled14 && candidates.length > 1) {
                        candidates = candidates.filter(p => p.name !== filled14);
                    }
                    
                    // Check sayÄ±larÄ±na gÃ¶re sÄ±rala (en az dolduran Ã¶nce)
                    candidates.sort((a, b) => {
                        const countA = branchCheckCounts[a.name] || 0;
                        const countB = branchCheckCounts[b.name] || 0;
                        return countA - countB;
                    });
                    
                    // En az check dolduran(lar)Ä± gÃ¶ster
                    if (candidates.length > 0) {
                        const minCount = branchCheckCounts[candidates[0].name] || 0;
                        gunlukPersonnel = candidates
                            .filter(p => (branchCheckCounts[p.name] || 0) === minCount)
                            .map(p => p.name);
                    }
                    
                    gunlukSubLabel = 'EÅŸit daÄŸÄ±lÄ±m';
                }
            }
            
            // Fallback
            if (gunlukPersonnel.length === 0) {
                gunlukPersonnel = [...getShiftPersonnel(branch, 'acilis'), ...getShiftPersonnel(branch, 'ara'), ...getShiftPersonnel(branch, 'kapanis')].filter((v, i, a) => a.indexOf(v) === i);
                gunlukSubLabel = '';
            }
            
            branchChecks.push({
                id: 'gunluk',
                name: getChecklistTypeName(branch, 'gunluk', 'GÃ¼nlÃ¼k Genel Check'),
                icon: 'clipboard',
                activeFrom: displayGunlukTime,
                deadline: displayGunlukEnd,
                lateWindow: gunlukLateWindow,
                subLabel: gunlukSubLabel + (isGunlukMissed ? ' (KaÃ§Ä±rÄ±ldÄ±)' : isGunlukLate ? ' (GeÃ§!)' : isGunlukActive ? '' : ' (Bekliyor)'),
                isCompleted: gunlukCompleted,
                isActive: isGunlukActive && !gunlukCompleted,
                isMissed: isGunlukMissed && !gunlukCompleted,
                canStillFill: !isGunlukMissed,
                remainingMinutes: isGunlukActive && !gunlukCompleted ? gunlukRemainingMinutes : null,
                remainingText: isGunlukActive && !gunlukCompleted ? `${gunlukRemainingMinutes}dk` : '',
                personnel: gunlukPersonnel,
                points: (CHECK_RULES.gunluk || DEFAULT_CHECK_RULES.gunluk || {}).points || { onTime: 1, late: 0, missed: -2 },
                priority: gunlukCompleted ? 92 : (isGunlukActive ? 15 : 70),
                onClick: `goToChecklist('${branch}', 'gunluk', '${displayGunlukTime}')`
            });
            totalChecks++;
            if (gunlukCompleted) completedChecks++;
        }
        
        // 6. MÃ¼dÃ¼r Kontrol (sadece mÃ¼dÃ¼rler iÃ§in)
        if (isFullAdmin || isStoreManager) {
            const mudurSubmissionId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_mudur_${todayStr}`;
            let mudurCompleted = false;
            try {
                const doc = await db.collection('checklistSubmissions').doc(mudurSubmissionId).get();
                mudurCompleted = doc.exists;
            } catch (e) {}
            
            // CHECK_RULES'dan aktiflik saatlerini al
            const mudurRules = CHECK_RULES.mudur || {};
            const mudurActiveFrom = mudurRules.activeFrom || '18:00';
            // Saatler Check & Puantaj KurallarÄ±'ndan geliyor
            const mudurDeadlineRule = mudurRules.deadline || '23:00';
            const [activeH, activeM] = mudurActiveFrom.split(':').map(Number);
            const [deadlineRuleH, deadlineRuleM] = mudurDeadlineRule.split(':').map(Number);
            
            // Åžu anki saat aktif zaman diliminde mi? (ilk tahmin, sonra shift'e gÃ¶re gÃ¼ncellenecek)
            const nowMinutesOfDay = currentHour * 60 + currentMinutes;
            let tempActiveFromMinutes = activeH * 60 + activeM;
            let tempDeadlineRuleMinutes = deadlineRuleH * 60 + deadlineRuleM;
            
            // Gece geÃ§iÅŸi kontrolÃ¼ (deadline gece yarÄ±sÄ±ndan sonra ise)
            if (deadlineRuleH < activeH) {
                tempDeadlineRuleMinutes += 24 * 60;
            }
            let tempAdjustedNowMinutes = nowMinutesOfDay;
            const dayEndHourMudur = getBusinessDayEndHour();
            if (currentHour < activeH && currentHour < dayEndHourMudur) {
                tempAdjustedNowMinutes += 24 * 60;
            }
            
            // isMudurTimeActive aÅŸaÄŸÄ±da gerÃ§ek deadline'a gÃ¶re yeniden hesaplanacak
            let isMudurTimeActive = false;
            
            // MÃ¼dÃ¼r OFF kontrolÃ¼ - shift verisinden kontrol et
            let mudurPersonnel = null;
            let mudurSubLabel = '';
            let canFillMudurCheck = true;
            let isMudurCheckMissed = false;
            
            // Deadline CHECK_RULES'tan gelir (shift bitiÅŸine gÃ¶re DEÄžÄ°L)
            const mudurLateWindow = mudurRules.lateWindow || 30;
            const mudurDeadline = mudurDeadlineRule; // CHECK_RULES'tan gelen deadline
            
            // Firebase'den mÃ¼dÃ¼r, yardÄ±mcÄ± ve bÃ¶lge mÃ¼dÃ¼rÃ¼ bilgisi al
            try {
                const managersSnap = await db.collection('personel')
                    .where('branch', 'in', [branch, 'all'])
                    .get();
                
                let mudur = null, yardimci = null, bolgeMuduru = null;
                managersSnap.forEach(doc => {
                    const d = doc.data();
                    if (d.role === 'magaza_muduru' && d.branch === branch) mudur = { ...d, id: doc.id };
                    // MÃ¼dÃ¼r yardÄ±mcÄ±sÄ±: her iki format da destekleniyor
                    if ((d.role === 'magaza_mudur_yardimcisi' || d.role === 'mudur_yardimcisi') && d.branch === branch) yardimci = { ...d, id: doc.id };
                    if (d.role === 'bolge_muduru') bolgeMuduru = { ...d, id: doc.id };
                });
                
                // Shift verisinden OFF durumlarÄ±nÄ± kontrol et
                const rawData = rawShiftData[branch];
                
                // Helper: personelin bugÃ¼n OFF olup olmadÄ±ÄŸÄ±nÄ± kontrol et
                const isPersonOff = (person) => {
                    if (!person || !rawData) return false;
                    const personId = person.uniqueId || normalizePersonelId(person.name);
                    const possibleKeys = [personId, person.codeName, person.name?.toLowerCase().replace(/\s+/g, '_')];
                    let shift = null;
                    for (const key of possibleKeys) {
                        if (rawData.personelShifts?.[key]) {
                            shift = rawData.personelShifts[key];
                            break;
                        }
                    }
                    if (!shift) return false;
                    const todayShift = shift[rawData.dayIndex] || '';
                    const cleanShift = todayShift.replace(/\*/g, '').trim().toUpperCase();
                    return cleanShift === 'OFF' || cleanShift === 'Ä°' || cleanShift === 'Y.Ä°' || cleanShift === '-' || cleanShift === 'X';
                };
                
                // SÄ±rayla kontrol et: MÃ¼dÃ¼r â†’ YardÄ±mcÄ± â†’ BÃ¶lge MÃ¼dÃ¼rÃ¼
                const mudurOff = isPersonOff(mudur);
                const yardimciOff = isPersonOff(yardimci);
                
                if (mudur && !mudurOff) {
                    mudurPersonnel = mudur.codeName || formatDisplayName(mudur.name);
                } else if (yardimci && !yardimciOff) {
                    mudurPersonnel = yardimci.codeName || formatDisplayName(yardimci.name);
                    mudurSubLabel = 'MÃ¼dÃ¼r izinli';
                } else if (bolgeMuduru) {
                    mudurPersonnel = bolgeMuduru.codeName || formatDisplayName(bolgeMuduru.name);
                    mudurSubLabel = 'BÃ¶lge mÃ¼dÃ¼rÃ¼ne devredildi';
                } else {
                    canFillMudurCheck = false;
                    mudurPersonnel = 'Doldurulamaz';
                    mudurSubLabel = 'MÃ¼dÃ¼r/yardÄ±mcÄ± izinli';
                }
                
                // Åžu anki saat deadline'Ä± geÃ§ti mi kontrol et
                const nowMinutes = currentHour * 60 + currentMinutes;
                const [dh, dm] = mudurDeadline.split(':').map(Number);
                let deadlineMinutes = dh * 60 + dm;
                // Gece geÃ§iÅŸi kontrolÃ¼
                if (dh < activeH) deadlineMinutes += 24 * 60;
                let adjustedNowForMissed = nowMinutes;
                if (currentHour < activeH && currentHour < dayEndHourMudur) adjustedNowForMissed += 24 * 60;
                
                // Late window dahil deadline kontrolÃ¼
                const deadlineWithLate = deadlineMinutes + mudurLateWindow;
                if (adjustedNowForMissed > deadlineWithLate && !mudurCompleted) {
                    isMudurCheckMissed = true;
                    canFillMudurCheck = false;
                    // Dinamik puan deÄŸeri
                    const mudurMissedPoints = CHECK_RULES.mudur?.points?.missed || -10;
                    mudurSubLabel = `SÃ¼re doldu (${mudurMissedPoints} puan)`;
                }
                
            } catch (e) {
                console.warn('MÃ¼dÃ¼r OFF kontrolÃ¼ hatasÄ±:', e);
                mudurPersonnel = branchManagers[branch] || 'MaÄŸaza MÃ¼dÃ¼rÃ¼';
            }
            
            // isMudurTimeActive'i gerÃ§ek deadline'a gÃ¶re yeniden hesapla
            const realActiveFromMinutes = activeH * 60 + activeM;
            const [realDH, realDM] = mudurDeadline.split(':').map(Number);
            let realDeadlineMinutes = realDH * 60 + realDM;
            if (realDH < activeH) realDeadlineMinutes += 24 * 60; // Gece geÃ§iÅŸi
            
            let adjustedNowForActive = currentHour * 60 + currentMinutes;
            if (currentHour < activeH && currentHour < dayEndHourMudur) adjustedNowForActive += 24 * 60;
            
            isMudurTimeActive = adjustedNowForActive >= realActiveFromMinutes && adjustedNowForActive <= realDeadlineMinutes;
            
            // MÃ¼dÃ¼r iÃ§in kalan sÃ¼re hesapla
            let mudurRemainingMinutes = null;
            if (!mudurCompleted && canFillMudurCheck) {
                const nowMin = currentHour * 60 + currentMinutes;
                const [dh, dm] = mudurDeadline.split(':').map(Number);
                let deadlineMin = dh * 60 + dm;
                // Gece geÃ§iÅŸi
                if (dh < dayEndHourMudur) deadlineMin += 24 * 60;
                let adjustedNow = nowMin;
                if (currentHour < dayEndHourMudur) adjustedNow += 24 * 60;
                mudurRemainingMinutes = Math.max(0, deadlineMin - adjustedNow);
            } else if (isMudurCheckMissed) {
                mudurRemainingMinutes = 0;
            }
            
            // Aktif deÄŸilse subLabel'i gÃ¼ncelle
            if (!isMudurTimeActive && !mudurCompleted && !isMudurCheckMissed) {
                mudurSubLabel = `${mudurActiveFrom}'de aktif`;
                mudurRemainingMinutes = null; // Aktif deÄŸilse kalan sÃ¼re gÃ¶sterme
            }
            
            branchChecks.push({
                id: 'mudur',
                name: getChecklistTypeName(branch, 'mudur', 'MÃ¼dÃ¼r Kontrol'),
                icon: 'usercheck',
                activeFrom: mudurActiveFrom,
                deadline: mudurDeadline,
                lateWindow: mudurLateWindow,
                subLabel: mudurSubLabel,
                isCompleted: mudurCompleted,
                isActive: isMudurTimeActive && canFillMudurCheck && !mudurCompleted,
                isMissed: isMudurCheckMissed,
                canStillFill: canFillMudurCheck && !isMudurCheckMissed,
                remainingMinutes: mudurRemainingMinutes,
                remainingText: isMudurCheckMissed ? 'âš ï¸ GEÃ‡TÄ°' : '',
                personnel: [mudurPersonnel],
                points: CHECK_RULES.mudur?.points || { onTime: 10, late: 0, missed: -10 },
                priority: mudurCompleted ? 93 : (isMudurCheckMissed ? 99 : (isMudurTimeActive ? 25 : 70)),
                onClick: (!mudurCompleted && !isMudurCheckMissed) ? `goToChecklist('${branch}', 'mudur', null)` : ''
            });
            totalChecks++;
            if (mudurCompleted) completedChecks++;
        }
        
        // 7. HaftalÄ±k GÃ¶revler (Round-Robin - Personel BazlÄ±)
        {
            const haftalikRules = CHECK_RULES.haftalik || DEFAULT_CHECK_RULES.haftalik || {};
            const haftalikActiveFrom = haftalikRules.activeFrom || '09:00';
            const haftalikDeadline = haftalikRules.deadline || '23:00';
            const haftalikLateWindow = haftalikRules.lateWindow || 30;
            
            // Personel ID'sini belirle
            let personnelId = currentUser?.personelId || currentUser?.uniqueId || currentUser?.id;
            const isManager = ['yonetici', 'bolge_muduru'].includes(currentUser?.role);
            
            // HaftalÄ±k Ã¶zet bilgisi al
            let weeklySummary = null;
            let subLabel = 'Bu hafta';
            let personnelTags = [];
            let isActive = false;
            let isAllDone = false;
            let remainingText = '';
            let statusIcon = ''; // Durum ikonu
            
            try {
                if (personnelId && !isManager) {
                    // Normal personel - kendi gÃ¶revlerini gÃ¶r
                    weeklySummary = await getWeeklyDashboardSummary(branch, personnelId);
                    
                    if (weeklySummary && weeklySummary.total > 0) {
                        const todoCount = weeklySummary.todoCount; // pending + overdue + active
                        const cooldownCount = weeklySummary.cooldown;
                        const overdueCount = weeklySummary.overdue;
                        const pendingCount = weeklySummary.pending;
                        
                        if (todoCount > 0) {
                            // YapÄ±lacak gÃ¶rev var
                            if (overdueCount > 0) {
                                subLabel = `âš ï¸ ${overdueCount} gÃ¶rev sÃ¼resi doldu!`;
                                statusIcon = 'overdue';
                            } else if (pendingCount > 0 && weeklySummary.nearestDeadline) {
                                subLabel = `${pendingCount} gÃ¶rev Â· ${weeklySummary.nearestDeadline.message}`;
                                statusIcon = 'pending';
                            } else {
                                subLabel = `${todoCount} gÃ¶rev bekliyor`;
                                statusIcon = 'pending';
                            }
                            isActive = true;
                        } else if (cooldownCount > 0) {
                            // TÃ¼m gÃ¶revler cooldown'da - BAÅžARILI
                            isAllDone = true;
                            statusIcon = 'success';
                            if (weeklySummary.nearestCooldown) {
                                subLabel = `âœ… TamamlandÄ± Â· ${weeklySummary.nearestCooldown.message}`;
                            } else {
                                subLabel = `âœ… ${cooldownCount} gÃ¶rev tamamlandÄ±`;
                            }
                        } else {
                            subLabel = `${weeklySummary.completed}/${weeklySummary.total} tamamlandÄ±`;
                        }
                    }
                } else {
                    // YÃ¶netici - tÃ¼m atamalarÄ± Ã¶zet olarak gÃ¶r
                    const assignments = await getOrCreateWeeklyAssignments(branch);
                    if (assignments) {
                        const allAssignments = assignments.assignments || [];
                        const pendingCount = allAssignments.filter(a => a.status === 'pending').length;
                        const completedCount = allAssignments.filter(a => a.status === 'completed').length;
                        
                        subLabel = `${completedCount}/${allAssignments.length} tamamlandÄ±`;
                        
                        // Atanan personelleri gÃ¶ster - TÃœM Ä°SÄ°MLER
                        const uniquePersonnel = [...new Set(allAssignments.map(a => a.personnelName))];
                        personnelTags = uniquePersonnel;
                        
                        isActive = pendingCount > 0;
                    }
                }
            } catch (e) {
                console.warn('[HaftalÄ±k] Dashboard Ã¶zet alÄ±namadÄ±:', e.message);
            }
            
            // Zaman penceresi kontrolÃ¼ - GECE YARISI GEÃ‡Ä°ÅžÄ° DESTEÄžÄ°
            const [activeH, activeM] = haftalikActiveFrom.split(':').map(Number);
            const [deadlineH, deadlineM] = haftalikDeadline.split(':').map(Number);
            const activeFromMinutes = activeH * 60 + activeM;
            let deadlineMinutes = deadlineH * 60 + deadlineM;
            let nowMinutes = currentHour * 60 + currentMinutes;
            
            // Gece yarÄ±sÄ±nÄ± geÃ§en deadline (Ã¶rn: 00:30, 01:00, 02:00)
            // EÄŸer deadline saati active saatinden kÃ¼Ã§Ã¼kse, gece yarÄ±sÄ±nÄ± geÃ§iyor demektir
            if (deadlineH < activeH) {
                deadlineMinutes += 24 * 60; // Ertesi gÃ¼ne taÅŸÄ±
            }
            
            // Gece yarÄ±sÄ±ndan sonra kontrol (maÄŸaza kapanÄ±ÅŸÄ±na kadar)
            // EÄŸer ÅŸu an gece yarÄ±sÄ±ndan sonra ve deadline ertesi gÃ¼nde ise
            const dayEndHourForHaftalik = getBusinessDayEndHour();
            if (currentHour < dayEndHourForHaftalik && deadlineH < activeH) {
                nowMinutes += 24 * 60; // Åžu anÄ± da ertesi gÃ¼ne taÅŸÄ±
            }
            
            const isInTimeWindow = nowMinutes >= activeFromMinutes && nowMinutes <= deadlineMinutes + haftalikLateWindow;
            
            // HaftalÄ±k iÃ§in canStillFill: todoCount > 0 veya cooldown > 0
            const canStillFill = (weeklySummary?.todoCount > 0 || weeklySummary?.cooldown > 0) && isInTimeWindow;
            
            branchChecks.push({
                id: 'haftalik',
                name: getChecklistTypeName(branch, 'haftalik', 'HaftalÄ±k GÃ¶revler'),
                icon: 'calendar',
                activeFrom: haftalikActiveFrom,
                deadline: haftalikDeadline,
                lateWindow: haftalikLateWindow,
                subLabel: subLabel,
                isCompleted: isAllDone,
                isActive: isActive && isInTimeWindow,
                isMissed: false,
                canStillFill: canStillFill,
                remainingText: remainingText,
                personnel: personnelTags,
                points: haftalikRules.points || { onTime: 1, late: 0, missed: -2 },
                priority: isActive ? 25 : (isAllDone ? 75 : 85),
                onClick: `goToChecklist('${branch}', 'haftalik', null)`,
                weeklySummary: weeklySummary,
                statusIcon: statusIcon // Kart iÃ§in ek ikon
            });
            totalChecks++;
            if (isAllDone) completedChecks++;
        }
        
        // Check'leri akÄ±llÄ± sÄ±rala:
        // 1. Aktif olanlar (sÃ¼re yaklaÅŸana gÃ¶re - en az kalan en Ã¼stte)
        // 2. Bekleyenler (henÃ¼z aktif olmamÄ±ÅŸ)
        // 3. TamamlanmÄ±ÅŸlar
        // 4. KaÃ§Ä±rÄ±lmÄ±ÅŸ/Doldurulamaz (en altta)
        branchChecks.sort((a, b) => {
            // Kategori Ã¶nceliÄŸi belirle
            const getCategory = (check) => {
                if (check.isCompleted) return 3; // TamamlanmÄ±ÅŸ
                if (check.isMissed) return 4;    // KaÃ§Ä±rÄ±lmÄ±ÅŸ (en altta)
                if (check.isActive) return 1;    // Aktif (en Ã¼stte)
                return 2;                        // Bekleyen
            };
            
            const catA = getCategory(a);
            const catB = getCategory(b);
            
            // Ã–nce kategoriye gÃ¶re sÄ±rala
            if (catA !== catB) return catA - catB;
            
            // AynÄ± kategorideyse:
            if (catA === 1) {
                // Aktifler iÃ§in: kalan sÃ¼re az olan Ã¼stte
                const remA = a.remainingMinutes ?? 9999;
                const remB = b.remainingMinutes ?? 9999;
                return remA - remB;
            }
            
            // DiÄŸer kategoriler iÃ§in eski priority'yi kullan
            return (a.priority || 50) - (b.priority || 50);
        });
        
        // Åžube HTML'i oluÅŸtur (tek ÅŸube olsa da gÃ¶ster)
        if (sortedBranches.length >= 1) {
            html += `
                <div class="branch-group">
                    <div class="branch-header">
                        <span class="branch-badge ${branchClass}">
                            <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>
                            ${branchShortName}
                        </span>
                    </div>
                    <div class="check-cards-grid">
            `;
        }
        
        // Check kartlarÄ±nÄ± render et
        for (const check of branchChecks) {
            const iconSvgs = {
                smartphone: `<svg width="18" height="18" fill="none" stroke="${check.isCompleted ? '#27ae60' : brandColor}" stroke-width="2" viewBox="0 0 24 24"><rect x="5" y="2" width="14" height="20" rx="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>`,
                sparkle: `<svg width="18" height="18" fill="none" stroke="${check.isCompleted ? '#27ae60' : brandColor}" stroke-width="2" viewBox="0 0 24 24"><path d="M12 3l1.5 5.5L19 10l-5.5 1.5L12 17l-1.5-5.5L5 10l5.5-1.5L12 3z"/></svg>`,
                sunrise: `<svg width="18" height="18" fill="none" stroke="${check.isCompleted ? '#27ae60' : brandColor}" stroke-width="2" viewBox="0 0 24 24"><path d="M17 18a5 5 0 00-10 0"/><line x1="12" y1="2" x2="12" y2="9"/><polyline points="8 6 12 2 16 6"/></svg>`,
                sunset: `<svg width="18" height="18" fill="none" stroke="${check.isCompleted ? '#27ae60' : brandColor}" stroke-width="2" viewBox="0 0 24 24"><path d="M17 18a5 5 0 00-10 0"/><line x1="12" y1="9" x2="12" y2="2"/><polyline points="16 6 12 10 8 6"/></svg>`,
                clipboard: `<svg width="18" height="18" fill="none" stroke="${check.isCompleted ? '#27ae60' : brandColor}" stroke-width="2" viewBox="0 0 24 24"><path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/></svg>`,
                usercheck: `<svg width="18" height="18" fill="none" stroke="${check.isCompleted ? '#27ae60' : brandColor}" stroke-width="2" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></svg>`,
                calendar: `<svg width="18" height="18" fill="none" stroke="${check.isCompleted ? '#27ae60' : brandColor}" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>`
            };
            
            // Durum belirleme - sÃ¼resi dolmuÅŸsa (0 veya negatif) yanÄ±p sÃ¶nmemeli
            const hasTimeLeft = check.remainingMinutes !== undefined && check.remainingMinutes !== null && check.remainingMinutes > 0;
            const isExpired = check.remainingMinutes !== undefined && check.remainingMinutes !== null && check.remainingMinutes <= 0 && !check.isCompleted;
            const isUrgent = check.isActive && !check.isCompleted && hasTimeLeft && check.remainingMinutes <= 15;
            const isWarning = check.isActive && !check.isCompleted && hasTimeLeft && check.remainingMinutes <= 30 && check.remainingMinutes > 15;
            const isMissedRecent = check.isMissed && !check.isCompleted && check.canStillFill;
            const isWaiting = !check.isCompleted && !check.isMissed && !check.isActive;
            const isDisabled = (check.isMissed && !check.isCompleted && !check.canStillFill) || isWaiting;
            
            // Kart sÄ±nÄ±flarÄ± - birden fazla class olabilir
            let cardClasses = [];
            if (check.isCompleted) {
                cardClasses.push('completed');
            } else if (check.isMissed) {
                cardClasses.push('missed');
                if (!check.canStillFill) {
                    cardClasses.push('disabled');
                }
            } else if (check.isActive) {
                cardClasses.push('active');
            } else {
                // HenÃ¼z aktif olmayan, bekleyen kartlar
                cardClasses.push('waiting');
                cardClasses.push('disabled');
            }
            if (isExpired && !check.isMissed) cardClasses.push('expired');
            if (isMissedRecent) cardClasses = ['missed-recent']; // Override
            
            const cardClass = cardClasses.join(' ');
            
            // YanÄ±p sÃ¶nme - sÃ¼resi dolmuÅŸsa ASLA yanÄ±p sÃ¶nme
            let pulseClass = '';
            if (!isExpired && !check.isCompleted) {
                if (isUrgent) {
                    pulseClass = 'check-pulse-urgent';
                } else if (isWarning) {
                    pulseClass = 'check-pulse-warning';
                } else if (check.isActive) {
                    pulseClass = 'check-pulse-active';
                }
            }
            
            const iconWrapClass = check.isCompleted ? 'green' : (check.isMissed ? 'red' : (isMoonberry ? 'teal' : 'coral'));
            
            // Mesaj belirleme (SYSTEM_CONFIG'den al)
            const messages = SYSTEM_CONFIG?.dashboardMessages || {};
            let statusMessage = '';
            let messageClass = '';
            
            if (check.isCompleted) {
                statusMessage = messages.completed || 'TamamlandÄ± âœ“';
                messageClass = 'completed';
            } else if (isDisabled) {
                statusMessage = 'Doldurulamaz';
                messageClass = 'expired';
            } else if (isExpired) {
                statusMessage = 'SÃ¼resi doldu!';
                messageClass = 'expired';
            } else if (check.isMissed) {
                statusMessage = messages.missed || 'KaÃ§Ä±rÄ±ldÄ±';
                messageClass = 'missed';
            } else if (check.isActive) {
                // HaftalÄ±k iÃ§in Ã¶zel mesaj - subLabel zaten detaylÄ± bilgi iÃ§eriyor
                if (check.id === 'haftalik' && check.weeklySummary) {
                    statusMessage = ''; // subLabel'da gÃ¶sterilecek
                    messageClass = 'active';
                } else {
                    statusMessage = messages.active || 'Åžimdi yapÄ±lmalÄ±!';
                    messageClass = 'active';
                }
            } else {
                statusMessage = messages.upcoming || 'YaklaÅŸÄ±yor';
                messageClass = 'upcoming';
            }
            
            // Kronometre sÄ±nÄ±fÄ±
            let countdownClass = '';
            if (check.isCompleted) {
                countdownClass = '';
            } else if (isExpired) {
                countdownClass = 'expired';
            } else if (isUrgent) {
                countdownClass = 'urgent';
            } else if (isWarning) {
                countdownClass = 'warning';
            } else if (check.isActive) {
                countdownClass = isMoonberry ? '' : 'coral';
            }
            
            // Kalan sÃ¼re hesaplama
            let countdownText = '';
            let countdownHtml = '';
            
            if (check.isCompleted) {
                countdownHtml = `<span class="check-countdown-pill done"><svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24" style="vertical-align:-2px"><polyline points="20 6 9 17 4 12"/></svg> Tamam</span>`;
            } else if (isDisabled) {
                countdownHtml = `<span class="check-countdown-pill expired"><svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="vertical-align:-2px"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg> Doldurulamaz</span>`;
            } else if (isExpired) {
                countdownHtml = `<div class="check-countdown-live expired"><svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="vertical-align:-2px"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg> SÃ¼resi doldu</div>`;
            } else if (check.deadline) {
                // Saat ve kalan sÃ¼re gÃ¶ster
                const remainingMin = check.remainingMinutes !== undefined ? check.remainingMinutes : '';
                const timeIcon = `<svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>`;
                
                if (remainingMin !== '' && remainingMin > 0 && check.isActive) {
                    const hours = Math.floor(remainingMin / 60);
                    const mins = remainingMin % 60;
                    const timeLeft = hours > 0 ? `${hours}s ${mins}dk` : `${mins}dk`;
                    countdownHtml = `
                        <div class="check-countdown-live ${countdownClass}" data-deadline="${check.deadline}" data-remaining="${remainingMin}">
                            ${timeIcon}
                            <span class="check-time">${check.deadline}</span>
                            <span class="check-separator">â€¢</span>
                            <span class="check-remaining">${timeLeft} kaldÄ±</span>
                        </div>
                    `;
                } else {
                    countdownHtml = `
                        <div class="check-countdown-live ${countdownClass}">
                            ${timeIcon}
                            <span class="check-time">${check.deadline}</span>
                        </div>
                    `;
                }
            }
            
            // Personel gÃ¶sterimi - TÃœM personel ayrÄ± badge (limit yok)
            const personnelSize = dashboardConfig.personnelFontSize || '0.85rem';
            let personnelHtml = '';
            if (check.personnel && check.personnel.length > 0) {
                personnelHtml = check.personnel.map(p => {
                    const displayName = lookupPersonelDisplay(p);
                    return `<span class="check-personnel-tag" style="font-size:${personnelSize};padding:2px 8px;background:#ff8674;color:#fff;border-radius:4px;white-space:nowrap">${displayName}</span>`;
                }).join('');
            }
            
            // Puan gÃ¶sterimi - tÃ¼m seÃ§enekler
            // Saat + Puan birleÅŸik gÃ¶sterim
            let timePointsHtml = '';
            if (check.points && check.activeFrom && check.deadline) {
                // GeÃ§ bitiÅŸ saatini hesapla
                const [dH, dM] = check.deadline.split(':').map(Number);
                const lateEndMin = dH * 60 + dM + (check.lateWindow || 30);
                const lateEndH = Math.floor(lateEndMin / 60) % 24;
                const lateEndM = lateEndMin % 60;
                const lateEndStr = `${String(lateEndH).padStart(2, '0')}:${String(lateEndM).padStart(2, '0')}`;
                
                // GeÃ§ puan 0 ise gÃ¶sterme
                const showLate = check.lateWindow > 0 && check.points.late !== undefined;
                
                timePointsHtml = `
                    <div style="display:flex;align-items:center;gap:6px;font-size:0.82rem;color:var(--tx2);flex-wrap:wrap">
                        <span style="display:flex;align-items:center;gap:4px">
                            <svg width="12" height="12" fill="none" stroke="var(--tx3)" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                            <span style="font-weight:500">${check.activeFrom}-${check.deadline}</span>
                            <span style="color:#27ae60;font-weight:600">${check.points.onTime > 0 ? '+' : ''}${check.points.onTime} puan</span>
                        </span>
                        ${showLate ? `
                            <span style="color:var(--tx3)">Â·</span>
                            <span style="display:flex;align-items:center;gap:3px">
                                <span>${lateEndStr}'e kadar</span>
                                <span style="color:#f39c12;font-weight:600">${check.points.late > 0 ? '+' : ''}${check.points.late} puan</span>
                            </span>
                        ` : ''}
                        <span style="color:var(--tx3)">Â·</span>
                        <span style="display:flex;align-items:center;gap:3px">
                            <span>Sonra</span>
                            <span style="color:#e74c3c;font-weight:600">${check.points.missed} puan</span>
                        </span>
                    </div>
                `;
            }
            
            let pointsHtml = '';
            if (!check.isCompleted && check.points) {
                pointsHtml = `
                    <div style="display:flex;flex-direction:row;gap:4px;align-items:center;font-size:.65rem;font-weight:600">
                        <span style="display:flex;align-items:center;gap:3px;padding:2px 6px;background:rgba(39,174,96,.1);color:#27ae60;border-radius:3px" title="Vaktinde doldurulursa">
                            <svg width="9" height="9" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
                            ${check.points.onTime > 0 ? '+' : ''}${check.points.onTime}
                        </span>
                        ${check.points.late !== undefined ? `
                            <span style="display:flex;align-items:center;gap:3px;padding:2px 6px;background:rgba(243,156,18,.1);color:#f39c12;border-radius:3px" title="GeÃ§ doldurulursa">
                                <svg width="9" height="9" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                ${check.points.late > 0 ? '+' : ''}${check.points.late}
                            </span>
                        ` : ''}
                        <span style="display:flex;align-items:center;gap:3px;padding:2px 6px;background:rgba(231,76,60,.1);color:#e74c3c;border-radius:3px" title="KaÃ§Ä±rÄ±lÄ±rsa">
                            <svg width="9" height="9" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                            ${check.points.missed}
                        </span>
                    </div>
                `;
            }
            
            html += `
                <div class="check-card-premium ${cardClass} ${pulseClass} ${isMoonberry ? '' : 'coral'}" 
                     onclick="${isDisabled ? '' : check.onClick}"
                     data-check-id="${check.id}"
                     data-deadline="${check.deadline || ''}"
                     data-remaining="${check.remainingMinutes || ''}">
                    <div class="check-icon-wrap ${iconWrapClass}">
                        ${iconSvgs[check.icon] || iconSvgs.sparkle}
                    </div>
                    <div class="check-info" style="flex:1;min-width:0">
                        <div class="check-name" style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
                            <span>${check.name}</span>
                            <span class="check-message ${messageClass}">${statusMessage}</span>
                        </div>
                        <div class="check-meta" style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin-top:4px">
                            ${timePointsHtml || (check.subLabel ? `<span class="check-time-badge">${check.subLabel}</span>` : '')}
                            ${personnelHtml}
                        </div>
                    </div>
                    <div class="check-status-wrap" style="display:flex;flex-direction:column;align-items:flex-end;gap:4px">
                        ${countdownHtml}
                    </div>
                </div>
            `;
        }
        
        // Åžube grubunu kapat
        if (sortedBranches.length >= 1) {
            html += `</div></div>`;
        }
    }
    
    // SonuÃ§larÄ± gÃ¶ster
    if (totalChecks > 0) {
        section.style.display = 'block';
        container.innerHTML = html;
        
        // Toplam sayaÃ§ gÃ¼ncelle
        const totalEl = document.getElementById('checksTotalCount');
        if (totalEl) {
            const progress = Math.round((completedChecks / totalChecks) * 100);
            totalEl.innerHTML = `<span style="color:${progress === 100 ? '#27ae60' : 'var(--tx2)'}">${completedChecks}/${totalChecks}</span> tamamlandÄ±`;
            
            // Motivasyon mesajÄ±
            if (progress === 100 && motivationMessages.length > 0) {
                const randomMsg = motivationMessages[Math.floor(Math.random() * motivationMessages.length)];
                totalEl.innerHTML += ` <span style="margin-left:8px">${randomMsg}</span>`;
            }
        }
        
        startDashboardCountdown();
    } else {
        section.style.display = 'none';
    }
}

// ==================== AYLIK PUAN KARTI ====================
async function loadMonthlyPoints() {
    const totalEl = document.getElementById('monthlyPointsTotal');
    const detailsEl = document.getElementById('monthlyPointsDetails');
    
    if (!totalEl || !detailsEl || !currentUser) return;
    
    try {
        // Bu ayÄ±n baÅŸlangÄ±cÄ±
        const now = new Date();
        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
        const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const monthStartStr = formatDateLocal(monthStart);
        const monthEndStr = formatDateLocal(monthEnd);
        
        // KullanÄ±cÄ±nÄ±n puantaj notlarÄ±nÄ± Ã§ek (daha gÃ¼venilir)
        const userName = currentUser.name || '';
        const userBranch = currentUser.branch || '';
        const personelId = normalizePersonelId(userName);
        
        let totalPoints = 0;
        let onTimeCount = 0;
        let lateCount = 0;
        let missedCount = 0;
        
        // puantajNotes - sadece personelId ile filtrele (index gerektirmez)
        const notesSnapshot = await db.collection('puantajNotes')
            .where('personelId', '==', personelId)
            .get();
        
        notesSnapshot.forEach(doc => {
            const data = doc.data();
            const docDate = data.date || '';
            // Tarih filtrelemesi client-side
            if (docDate < monthStartStr || docDate > monthEndStr) return;
            
            const points = data.points || 0;
            totalPoints += points;
            
            if (data.status === 'onTime') onTimeCount++;
            else if (data.status === 'late') lateCount++;
            else if (data.status === 'missed') missedCount++;
        });
        
        // 2. puantaj koleksiyonu - manuel deÄŸerlendirmeler
        let manualCount = 0;
        let personelDocId = null;
        const periodKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        
        try {
            const personelQuery = await db.collection('personel')
                .where('name', '==', userName)
                .limit(1)
                .get();
            
            if (!personelQuery.empty) {
                personelDocId = personelQuery.docs[0].id;
                
                const puantajSnapshot = await db.collection('puantaj')
                    .where('personelId', '==', personelDocId)
                    .where('period', '==', periodKey)
                    .get();
                
                puantajSnapshot.forEach(doc => {
                    const data = doc.data();
                    // score 1-5 arasÄ± yÄ±ldÄ±z, puana Ã§evir: config'den dinamik
                    const score = data.score || 3;
                    const points = getPointsFromStar(score);
                    totalPoints += points;
                    manualCount++;
                });
            }
        } catch(e) {
            console.warn('Manuel puantaj yÃ¼kleme hatasÄ±:', e);
        }
        
        // 3. EÄŸer her iki koleksiyon da boÅŸsa checklistSubmissions'dan da dene
        if (notesSnapshot.empty && manualCount === 0) {
            // Client-side filtreleme (composite index gerektirmez)
            const submissions = await db.collection('checklistSubmissions')
                .where('personName', '==', userName)
                .get();
            
            submissions.forEach(doc => {
                const data = doc.data();
                const docDate = data.date || '';
                
                // Tarih filtrelemesi client-side
                if (docDate < monthStartStr || docDate > monthEndStr) return;
                
                const points = data.points || 0;
                totalPoints += points;
                
                if (data.pointStatus === 'onTime') onTimeCount++;
                else if (data.pointStatus === 'late') lateCount++;
            });
        }
        
        const totalCompleted = onTimeCount + lateCount;
        
        // KartÄ± gÃ¶ster
        const card = document.getElementById('monthlyPointsCard');
        if (card) card.style.display = 'block';
        
        // Toplam puanÄ± gÃ¶ster
        const pointColor = totalPoints > 0 ? '#27ae60' : totalPoints < 0 ? '#e74c3c' : 'var(--tx)';
        totalEl.style.color = pointColor;
        totalEl.textContent = (totalPoints > 0 ? '+' : '') + totalPoints + ' puan';
        
        // DetaylarÄ± gÃ¶ster
        detailsEl.innerHTML = `
            <div style="text-align:center;padding:12px;background:rgba(39,174,96,.1);border-radius:10px">
                <div style="font-size:1.2rem;font-weight:700;color:#27ae60">${onTimeCount}</div>
                <div style="font-size:.7rem;color:var(--tx3)">Vaktinde</div>
            </div>
            <div style="text-align:center;padding:12px;background:rgba(243,156,18,.1);border-radius:10px">
                <div style="font-size:1.2rem;font-weight:700;color:#f39c12">${lateCount}</div>
                <div style="font-size:.7rem;color:var(--tx3)">GeÃ§</div>
            </div>
            <div style="text-align:center;padding:12px;background:${missedCount > 0 ? 'rgba(231,76,60,.1)' : 'var(--bg3)'};border-radius:10px">
                <div style="font-size:1.2rem;font-weight:700;color:${missedCount > 0 ? '#e74c3c' : 'var(--tx)'}">${missedCount > 0 ? missedCount : totalCompleted}</div>
                <div style="font-size:.7rem;color:var(--tx3)">${missedCount > 0 ? 'KaÃ§Ä±rÄ±lan' : 'Toplam'}</div>
            </div>
        `;
        
    } catch (e) {
        console.error('AylÄ±k puan yÃ¼kleme hatasÄ±:', e);
        totalEl.textContent = '-';
        detailsEl.innerHTML = '<div style="grid-column:span 3;text-align:center;color:var(--tx3);font-size:.8rem">YÃ¼klenemedi</div>';
    }
}

// ==================== LEADERBOARD (Puan SÄ±ralamasÄ±) ====================

// AylÄ±k puan detay modal
async function showMonthlyPointsModal() {
    const now = new Date();
    const monthName = now.toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' });
    const periodKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    
    const userName = currentUser?.name || '';
    const userBranch = currentUser?.branch || '';
    const personelId = normalizePersonelId(userName);
    
    // Verileri topla
    let checkData = [];
    let manualData = [];
    
    try {
        // 1. Otomatik check puanlarÄ±
        const notesSnapshot = await db.collection('puantajNotes')
            .where('personelId', '==', personelId)
            .orderBy('date', 'desc')
            .limit(50)
            .get();
        
        const monthStartStr = `${periodKey}-01`;
        const monthEndStr = `${periodKey}-31`;
        
        notesSnapshot.forEach(doc => {
            const d = doc.data();
            if (d.date >= monthStartStr && d.date <= monthEndStr) {
                checkData.push({
                    date: d.date,
                    type: d.checkType || d.type || 'check',
                    status: d.status,
                    points: d.points || 0,
                    time: d.time || ''
                });
            }
        });
        
        // 2. Manuel deÄŸerlendirmeler
        const personelQuery = await db.collection('personel').where('name', '==', userName).limit(1).get();
        if (!personelQuery.empty) {
            const docId = personelQuery.docs[0].id;
            const puantajSnap = await db.collection('puantaj')
                .where('personelId', '==', docId)
                .where('period', '==', periodKey)
                .get();
            
            puantajSnap.forEach(doc => {
                const d = doc.data();
                manualData.push({
                    date: d.date || d.createdAt?.toDate?.()?.toISOString().split('T')[0] || '',
                    score: d.score || 3,
                    points: getPointsFromStar(d.score || 3),
                    note: d.note || '',
                    by: d.createdByName || d.createdBy || ''
                });
            });
        }
    } catch (e) {
        console.error('Puan detayÄ± yÃ¼kleme hatasÄ±:', e);
    }
    
    // Ã–zet hesapla
    let totalPoints = 0;
    let onTime = 0, late = 0, missed = 0;
    
    checkData.forEach(c => {
        totalPoints += c.points;
        if (c.status === 'onTime') onTime++;
        else if (c.status === 'late') late++;
        else if (c.status === 'missed') missed++;
    });
    
    manualData.forEach(m => {
        totalPoints += m.points;
    });
    
    // Check listesi HTML
    let checkListHtml = checkData.length > 0 ? checkData.slice(0, 10).map(c => {
        const statusColor = c.status === 'onTime' ? '#27ae60' : c.status === 'late' ? '#e67e22' : '#e74c3c';
        const statusText = c.status === 'onTime' ? 'Vaktinde' : c.status === 'late' ? 'GeÃ§' : 'KaÃ§Ä±rÄ±ldÄ±';
        const dateStr = c.date ? new Date(c.date).toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' }) : '';
        return `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:var(--bg2);border-radius:6px">
                <div>
                    <div style="font-size:.75rem;font-weight:600;color:var(--tx)">${c.type}</div>
                    <div style="font-size:.6rem;color:var(--tx3)">${dateStr} ${c.time || ''}</div>
                </div>
                <div style="display:flex;align-items:center;gap:8px">
                    <span style="font-size:.6rem;color:${statusColor}">${statusText}</span>
                    <span style="font-weight:700;color:${c.points >= 0 ? '#27ae60' : '#e74c3c'};font-size:.8rem">${c.points > 0 ? '+' : ''}${c.points}</span>
                </div>
            </div>
        `;
    }).join('') : '<div style="text-align:center;padding:16px;color:var(--tx3);font-size:.75rem">Bu ay henÃ¼z check kaydÄ± yok</div>';
    
    // Manuel deÄŸerlendirme listesi
    let manualListHtml = manualData.length > 0 ? manualData.map(m => {
        const stars = 'â˜…'.repeat(m.score) + 'â˜†'.repeat(5 - m.score);
        return `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:var(--bg2);border-radius:6px">
                <div>
                    <div style="font-size:.85rem;color:#DAA520">${stars}</div>
                    <div style="font-size:.6rem;color:var(--tx3)">${m.by || 'YÃ¶netici'}</div>
                </div>
                <span style="font-weight:700;color:${m.points >= 0 ? '#27ae60' : '#e74c3c'};font-size:.8rem">${m.points > 0 ? '+' : ''}${m.points}</span>
            </div>
        `;
    }).join('') : '<div style="text-align:center;padding:16px;color:var(--tx3);font-size:.75rem">Bu ay deÄŸerlendirme yok</div>';
    
    const pointColor = totalPoints > 0 ? '#27ae60' : totalPoints < 0 ? '#e74c3c' : 'var(--tx)';
    
    const body = `
        <div style="text-align:center;margin-bottom:20px">
            <div style="font-size:2.5rem;font-weight:800;color:${pointColor}">${totalPoints > 0 ? '+' : ''}${totalPoints}</div>
            <div style="font-size:.8rem;color:var(--tx3)">Toplam Puan</div>
        </div>
        
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px">
            <div style="text-align:center;padding:12px;background:rgba(39,174,96,.1);border-radius:10px">
                <div style="font-size:1.3rem;font-weight:700;color:#27ae60">${onTime}</div>
                <div style="font-size:.65rem;color:var(--tx3)">Vaktinde</div>
            </div>
            <div style="text-align:center;padding:12px;background:rgba(230,126,34,.1);border-radius:10px">
                <div style="font-size:1.3rem;font-weight:700;color:#e67e22">${late}</div>
                <div style="font-size:.65rem;color:var(--tx3)">GeÃ§</div>
            </div>
            <div style="text-align:center;padding:12px;background:rgba(231,76,60,.1);border-radius:10px">
                <div style="font-size:1.3rem;font-weight:700;color:#e74c3c">${missed}</div>
                <div style="font-size:.65rem;color:var(--tx3)">KaÃ§Ä±rÄ±lan</div>
            </div>
        </div>
        
        <div style="margin-bottom:16px">
            <div style="font-size:.75rem;font-weight:600;color:var(--tx2);margin-bottom:8px;display:flex;align-items:center;gap:6px">
                <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/></svg>
                Check PuanlarÄ± (Son 10)
            </div>
            <div style="display:flex;flex-direction:column;gap:6px;max-height:200px;overflow-y:auto">
                ${checkListHtml}
            </div>
        </div>
        
        <div>
            <div style="font-size:.75rem;font-weight:600;color:var(--tx2);margin-bottom:8px;display:flex;align-items:center;gap:6px">
                <svg width="12" height="12" fill="#DAA520" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                Manuel DeÄŸerlendirmeler
            </div>
            <div style="display:flex;flex-direction:column;gap:6px">
                ${manualListHtml}
            </div>
        </div>
    `;
    
    showModal(`${monthName} Puan DetayÄ±`, body, `
        <button class="btn btn-ghost" onclick="closeModal()">Kapat</button>
        <button class="btn btn-primary" onclick="goTo('puantaj');closeModal()">Puantaj SayfasÄ±na Git</button>
    `);
}

async function loadLeaderboard() {
    const section = document.getElementById('leaderboardSection');
    const container = document.getElementById('leaderboardContainer');
    
    if (!section || !container) return;
    
    const isFullAdmin = ['yonetici', 'bolge_muduru'].includes(currentUser?.role);
    const isStoreManager = currentUser?.role === 'magaza_muduru';
    const isMudurYardimcisi = currentUser?.role === 'mudur_yardimcisi' || currentUser?.role === 'magaza_mudur_yardimcisi';
    
    // MÃ¼dÃ¼rler ve yardÄ±mcÄ±lar gÃ¶rebilir
    if (!isFullAdmin && !isStoreManager && !isMudurYardimcisi) {
        section.style.display = 'none';
        return;
    }
    
    const userBranch = currentUser?.branch;
    
    section.style.display = 'block';
    container.innerHTML = '<div style="padding:20px;text-align:center;color:var(--tx3)">YÃ¼kleniyor...</div>';
    
    try {
        const now = new Date();
        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
        const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const monthStartStr = formatDateLocal(monthStart);
        const monthEndStr = formatDateLocal(monthEnd);
        const periodKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        const monthName = now.toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' });
        
        // Personel listesi
        const personelSnapshot = await db.collection('personel').get();
        const activePersonel = {};
        const personelByDocId = {};
        
        personelSnapshot.forEach(doc => {
            const d = doc.data();
            // SÄ±ralamadan muaf: bÃ¶lge mÃ¼dÃ¼rÃ¼, maÄŸaza mÃ¼dÃ¼rÃ¼, yÃ¶netici
            if (d.status !== 'inactive' && d.status !== 'deleted' && 
                d.role !== 'bolge_muduru' && d.role !== 'magaza_muduru' && d.role !== 'yonetici') {
                const normalizedId = normalizePersonelId(d.name);
                activePersonel[normalizedId] = {
                    docId: doc.id,
                    name: d.name,
                    codeName: d.codeName || formatDisplayName(d.name),
                    branch: d.branch,
                    role: d.role
                };
                personelByDocId[doc.id] = activePersonel[normalizedId];
            }
        });
        
        // Personel bazÄ±nda puanlarÄ± topla
        const personelPoints = {};
        
        // puantajNotes (otomatik)
        const notesSnapshot = await db.collection('puantajNotes')
            .where('date', '>=', monthStartStr)
            .where('date', '<=', monthEndStr)
            .get();
        
        notesSnapshot.forEach(doc => {
            const data = doc.data();
            const personelId = data.personelId || '';
            const points = data.points || 0;
            const status = data.status || 'completed';
            
            const personelInfo = activePersonel[personelId];
            if (!personelInfo) return;
            
            const displayName = personelInfo.codeName;
            const branch = personelInfo.branch || 'Bilinmiyor';
            
            if (!personelPoints[displayName]) {
                personelPoints[displayName] = { 
                    fullName: personelInfo.name,
                    branch,
                    role: personelInfo.role,
                    total: 0, 
                    onTime: 0, 
                    late: 0, 
                    missed: 0,
                    completed: 0,
                    manual: 0
                };
            }
            
            personelPoints[displayName].total += points;
            personelPoints[displayName].completed++;
            if (status === 'onTime') personelPoints[displayName].onTime++;
            else if (status === 'late') personelPoints[displayName].late++;
            else if (status === 'missed') personelPoints[displayName].missed++;
        });
        
        // puantaj (manuel)
        const puantajSnapshot = await db.collection('puantaj')
            .where('period', '==', periodKey)
            .get();
        
        puantajSnapshot.forEach(doc => {
            const data = doc.data();
            const personelDocId = data.personelId;
            const score = data.score || 3;
            const points = getPointsFromStar(score);
            
            const personelInfo = personelByDocId[personelDocId];
            if (!personelInfo) return;
            
            const displayName = personelInfo.codeName;
            const branch = personelInfo.branch || 'Bilinmiyor';
            
            if (!personelPoints[displayName]) {
                personelPoints[displayName] = { 
                    fullName: personelInfo.name,
                    branch,
                    role: personelInfo.role,
                    total: 0, 
                    onTime: 0, 
                    late: 0, 
                    missed: 0,
                    completed: 0,
                    manual: 0
                };
            }
            
            personelPoints[displayName].total += points;
            personelPoints[displayName].manual++;
        });
        
        // Åžube bazlÄ± grupla
        const byBranch = {};
        Object.entries(personelPoints).forEach(([name, data]) => {
            const branch = data.branch || 'Bilinmiyor';
            if (!byBranch[branch]) byBranch[branch] = [];
            byBranch[branch].push({ name, ...data });
        });
        
        // Her ÅŸubeyi puana gÃ¶re sÄ±rala
        Object.keys(byBranch).forEach(branch => {
            byBranch[branch].sort((a, b) => b.total - a.total);
        });
        
        // GÃ¶rÃ¼ntÃ¼lenecek ÅŸubeler
        let visibleBranches = Object.keys(byBranch);
        if (!isFullAdmin) {
            // MÃ¼dÃ¼r/yardÄ±mcÄ± sadece kendi ÅŸubesini gÃ¶rÃ¼r
            visibleBranches = visibleBranches.filter(b => b === userBranch);
        }
        
        if (visibleBranches.length === 0) {
            container.innerHTML = '<div style="padding:30px;text-align:center;color:var(--tx3)">Bu ay henÃ¼z veri yok</div>';
            return;
        }
        
        // Premium SVG ikonlar
        const rankSvgs = [
            `<svg width="20" height="20" viewBox="0 0 24 24" fill="#ffd700"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg>`,
            `<svg width="18" height="18" viewBox="0 0 24 24" fill="#c0c0c0"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg>`,
            `<svg width="16" height="16" viewBox="0 0 24 24" fill="#cd7f32"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg>`
        ];
        
        let html = `
            <div style="padding:16px 20px;background:linear-gradient(135deg,rgba(0,140,149,.1),rgba(0,140,149,.05));border-bottom:1px solid var(--cardBorder)">
                <div style="font-size:.85rem;font-weight:600;color:var(--tx)">${monthName} SÄ±ralamasÄ±</div>
                <div style="font-size:.7rem;color:var(--tx3)">${visibleBranches.length} ÅŸube</div>
            </div>
        `;
        
        visibleBranches.forEach(branch => {
            const persons = byBranch[branch] || [];
            const top3 = persons.slice(0, 3);
            const remaining = persons.slice(3);
            const branchId = branch.replace(/[^a-zA-Z0-9]/g, '_');
            
            html += `
                <div style="padding:12px 20px;background:var(--bg2);border-bottom:1px solid var(--cardBorder)">
                    <div style="font-size:.8rem;font-weight:600;color:var(--tx);display:flex;align-items:center;gap:6px">
                        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                        ${branch}
                    </div>
                </div>
            `;
            
            // Ä°lk 3
            top3.forEach((person, index) => {
                const rank = index + 1;
                const pointColor = person.total > 0 ? '#27ae60' : person.total < 0 ? '#e74c3c' : 'var(--tx2)';
                const successRate = person.completed > 0 ? Math.round((person.onTime / person.completed) * 100) : 0;
                
                html += `
                    <div style="display:flex;align-items:center;gap:12px;padding:12px 20px;border-bottom:1px solid var(--cardBorder);background:${rank === 1 ? 'rgba(255,215,0,.05)' : 'transparent'}">
                        <div style="width:28px;height:28px;display:flex;align-items:center;justify-content:center">${rankSvgs[index]}</div>
                        <div style="flex:1">
                            <div style="font-weight:600;color:var(--tx);font-size:.85rem">${person.name}</div>
                            <div style="font-size:.65rem;color:var(--tx3)">${person.completed} check â€¢ %${successRate} baÅŸarÄ±</div>
                        </div>
                        <div style="text-align:right">
                            <div style="font-size:1rem;font-weight:700;color:${pointColor}">${person.total > 0 ? '+' : ''}${person.total}</div>
                            <div style="font-size:.6rem;color:var(--tx3)">puan</div>
                        </div>
                    </div>
                `;
            });
            
            // Daha fazla butonu
            if (remaining.length > 0) {
                html += `
                    <div id="leaderboard_more_${branchId}" style="display:none">
                        ${remaining.map((person, i) => {
                            const rank = i + 4;
                            const pointColor = person.total > 0 ? '#27ae60' : person.total < 0 ? '#e74c3c' : 'var(--tx2)';
                            return `
                                <div style="display:flex;align-items:center;gap:12px;padding:10px 20px;border-bottom:1px solid var(--cardBorder)">
                                    <div style="width:28px;height:28px;display:flex;align-items:center;justify-content:center;font-size:.8rem;font-weight:600;color:var(--tx3)">${rank}</div>
                                    <div style="flex:1">
                                        <div style="font-weight:500;color:var(--tx);font-size:.8rem">${person.name}</div>
                                    </div>
                                    <div style="font-size:.9rem;font-weight:600;color:${pointColor}">${person.total > 0 ? '+' : ''}${person.total}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <button onclick="toggleLeaderboardMore('${branchId}')" id="leaderboard_btn_${branchId}" style="width:100%;padding:10px;border:none;background:var(--bg3);color:var(--tx2);font-size:.75rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;border-bottom:1px solid var(--cardBorder)">
                        <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"/></svg>
                        ${remaining.length} kiÅŸi daha
                    </button>
                `;
            }
        });
        
        container.innerHTML = html;
        
    } catch (e) {
        console.error('Leaderboard yÃ¼kleme hatasÄ±:', e);
        container.innerHTML = '<div style="padding:30px;text-align:center;color:#e74c3c">YÃ¼klenirken hata oluÅŸtu</div>';
    }
}

// Daha fazla gÃ¶ster/gizle
function toggleLeaderboardMore(branchId) {
    const moreDiv = document.getElementById(`leaderboard_more_${branchId}`);
    const btn = document.getElementById(`leaderboard_btn_${branchId}`);
    if (!moreDiv || !btn) return;
    
    const isHidden = moreDiv.style.display === 'none';
    moreDiv.style.display = isHidden ? 'block' : 'none';
    btn.innerHTML = isHidden 
        ? '<svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 15l-6-6-6 6"/></svg> Gizle'
        : `<svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"/></svg> ${moreDiv.children.length} kiÅŸi daha`;
}

// Dashboard check'lerini sÄ±rala
function sortDashboardChecks(container) {
    // Her ÅŸube bloÄŸunu ayrÄ± ayrÄ± iÅŸle
    const branchHeaders = container.querySelectorAll('[style*="font-weight:600"][style*="margin"]');
    
    if (branchHeaders.length === 0) {
        // Tek ÅŸube - tÃ¼m kartlarÄ± sÄ±rala
        sortCheckCards(container);
    } else {
        // Birden fazla ÅŸube - her birini ayrÄ± sÄ±rala
        branchHeaders.forEach((header, index) => {
            const nextHeader = branchHeaders[index + 1];
            const cards = [];
            let sibling = header.nextElementSibling;
            
            while (sibling && sibling !== nextHeader) {
                if (sibling.style.borderLeft || sibling.style.border) {
                    cards.push(sibling);
                }
                sibling = sibling.nextElementSibling;
            }
            
            // KartlarÄ± sÄ±rala
            cards.sort((a, b) => {
                const priorityA = getCardPriority(a);
                const priorityB = getCardPriority(b);
                return priorityA - priorityB;
            });
            
            // Yeniden yerleÅŸtir
            cards.forEach(card => {
                if (nextHeader) {
                    container.insertBefore(card, nextHeader);
                } else {
                    container.appendChild(card);
                }
            });
        });
    }
}

// Tek container'daki kartlarÄ± sÄ±rala
function sortCheckCards(container) {
    const cards = Array.from(container.children).filter(el => 
        el.style.borderLeft || (el.style.border && !el.textContent.includes('ÅžiÅŸli') && !el.textContent.includes('Tuzla'))
    );
    
    cards.sort((a, b) => {
        const priorityA = getCardPriority(a);
        const priorityB = getCardPriority(b);
        return priorityA - priorityB;
    });
    
    cards.forEach(card => container.appendChild(card));
}

// Kart Ã¶nceliÄŸini belirle
function getCardPriority(card) {
    const text = card.textContent.toLowerCase();
    const style = card.getAttribute('style') || '';
    
    // TamamlandÄ±/Tamam - en altta
    if (text.includes('tamam') || text.includes('tamamlandÄ±') || style.includes('#27ae60')) {
        return 90;
    }
    // YapÄ±lmadÄ± - altta
    if (text.includes('yapÄ±lmadÄ±') || text.includes('sÃ¼re doldu') || style.includes('#e74c3c') || style.includes('#9ca3af')) {
        return 80;
    }
    // GeÃ§ - orta
    if (text.includes('geÃ§') || style.includes('#f39c12')) {
        return 20;
    }
    // Aktif - en Ã¼stte
    if (text.includes('aktif') || card.classList.contains('check-pulse-active')) {
        return 10;
    }
    // VarsayÄ±lan
    return 50;
}

// CanlÄ± geriye sayÄ±m gÃ¼ncelleme
let dashboardCountdownInterval = null;
function startDashboardCountdown() {
    // Ã–nceki interval'i temizle
    if (dashboardCountdownInterval) clearInterval(dashboardCountdownInterval);
    
    dashboardCountdownInterval = setInterval(() => {
        const timers = document.querySelectorAll('.countdown-timer');
        timers.forEach(timer => {
            const target = timer.dataset.target;
            if (!target) return;
            
            const now = new Date();
            const [hours, minutes] = target.split(':').map(Number);
            const targetTime = new Date(now);
            targetTime.setHours(hours, minutes, 0, 0);
            
            const diff = targetTime - now;
            if (diff <= 0) {
                timer.textContent = 'SÃ¼re doldu';
                return;
            }
            
            const mins = Math.floor(diff / 60000);
            const secs = Math.floor((diff % 60000) / 1000);
            
            if (mins >= 60) {
                const h = Math.floor(mins / 60);
                const m = mins % 60;
                timer.textContent = `${h} saat ${m} dk`;
            } else {
                timer.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            }
        });
    }, 1000);
}

// Basit check kartÄ± render (AÃ§Ä±lÄ±ÅŸ, KapanÄ±ÅŸ, Temizlik iÃ§in)
function renderSimpleCheckCard(name, deadline, branch, isCompleted, isMissed, isActive, remainingText, responsiblePersonnel, rules, iconType) {
    // Marka renkleri
    const TEAL = '#008c95';
    const CORAL = '#ff8674';
    const GREEN = '#27ae60';
    const GRAY = '#9ca3af';
    
    const missedPoints = rules?.points?.missed || -2;
    const onTimePoints = rules?.points?.onTime || 1;
    
    // Åžube rengi
    const isMoonberry = true; // TÃ¼m ÅŸubeler Moonberry teal rengi
    const brandColor = isMoonberry ? TEAL : CORAL;
    
    let bgColor, accentColor, statusText, statusBg, pulseClass = '', opacity = '1';
    
    if (isCompleted) {
        bgColor = 'var(--bg3)';
        accentColor = GREEN;
        statusText = 'Tamam';
        statusBg = 'rgba(39,174,96,.12)';
        opacity = '0.6';
    } else if (isMissed) {
        bgColor = 'var(--bg3)';
        accentColor = GRAY;
        statusText = `${missedPoints}`;
        statusBg = 'rgba(156,163,175,.12)';
        opacity = '0.5';
    } else if (isActive) {
        bgColor = isMoonberry ? 'rgba(0,140,149,.04)' : 'rgba(255,134,116,.04)';
        accentColor = brandColor;
        statusText = remainingText || 'Aktif';
        statusBg = isMoonberry ? 'rgba(0,140,149,.12)' : 'rgba(255,134,116,.12)';
        pulseClass = 'check-pulse-active';
    } else {
        bgColor = 'var(--bg3)';
        accentColor = 'var(--tx3)';
        statusText = '-';
        statusBg = 'var(--bg4)';
    }
    
    // SVG ikon
    const iconMap = {
        'sunrise': `<svg width="16" height="16" fill="none" stroke="${accentColor}" stroke-width="2" viewBox="0 0 24 24"><path d="M17 18a5 5 0 00-10 0"/><line x1="12" y1="2" x2="12" y2="9"/><polyline points="8 6 12 2 16 6"/></svg>`,
        'sunset': `<svg width="16" height="16" fill="none" stroke="${accentColor}" stroke-width="2" viewBox="0 0 24 24"><path d="M17 18a5 5 0 00-10 0"/><line x1="12" y1="9" x2="12" y2="2"/><polyline points="16 6 12 10 8 6"/></svg>`,
        'smartphone': `<svg width="16" height="16" fill="none" stroke="${accentColor}" stroke-width="2" viewBox="0 0 24 24"><rect x="5" y="2" width="14" height="20" rx="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>`,
        'calendar': `<svg width="16" height="16" fill="none" stroke="${accentColor}" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>`
    };
    const iconSvg = iconMap[iconType] || iconMap['calendar'];
    
    // Personel
    let personnelHtml = '';
    if (responsiblePersonnel && responsiblePersonnel.length > 0 && !isCompleted) {
        // lookupPersonelDisplay: codeName varsa onu, yoksa formatDisplayName kullanÄ±r
        const names = responsiblePersonnel.map(p => lookupPersonelDisplay(p)).join(', ');
        personnelHtml = `<span style="font-size:.7rem;color:var(--tx3);margin-left:auto">${names}</span>`;
    }
    
    // Puan gÃ¶sterimi (aktif ise)
    let pointsHtml = '';
    if (isActive && onTimePoints > 0) {
        pointsHtml = `<span style="font-size:.65rem;color:${GREEN};font-weight:600;margin-left:4px">+${onTimePoints}</span>`;
    }
    
    return `
        <div class="${pulseClass}" style="background:${bgColor};border-left:3px solid ${accentColor};border-radius:8px;padding:10px 14px;display:flex;align-items:center;gap:10px;cursor:pointer;transition:all .15s;opacity:${opacity}" onclick="goTo('checklist')" onmouseover="this.style.transform='translateX(4px)'" onmouseout="this.style.transform='none'">
            <span style="flex-shrink:0">${iconSvg}</span>
            <span style="font-weight:500;font-size:.85rem;color:var(--tx)">${name}</span>
            ${personnelHtml}
            <div style="display:flex;align-items:center;gap:6px;margin-left:auto">
                ${pointsHtml}
                <span style="font-size:.75rem;font-weight:600;color:${accentColor};padding:4px 10px;background:${statusBg};border-radius:6px">${statusText}</span>
            </div>
        </div>
    `;
}

// Check kartÄ± render helper - kompakt versiyon
function renderCheckCard(checkType, timeSlot, branch, isCompleted, submissionData, window, remaining, status, responsiblePersonnel) {
    // Sabit renkler - duruma gÃ¶re
    const TEAL = '#008c95';      // Moonberry - Aktif
    const CORAL = '#ff8674';     // Sunberry - YapÄ±lmadÄ±
    const ORANGE = '#f39c12';    // Turuncu - GeÃ§
    const GRAY = '#9ca3af';      // Gri - TamamlandÄ±
    const GREEN = '#27ae60';     // YeÅŸil - BaÅŸarÄ±lÄ±
    
    // Puan kurallarÄ±
    const rules = CHECK_RULES[checkType.id];
    const missedPoints = rules?.points?.missed || -2;
    const latePoints = rules?.points?.late || -2;
    const onTimePoints = rules?.points?.onTime || 1;
    
    let bgColor = 'var(--bg3)';
    let accentColor = 'var(--tx3)';
    let icon = 'â—‹';
    let statusText = '';
    let isActive = false;
    let pulseClass = '';
    let riskText = '';
    let opacity = '1';
    let statusIcon = '';
    
    if (isCompleted) {
        // TamamlandÄ± - Gri
        bgColor = 'rgba(156,163,175,.06)';
        accentColor = GRAY;
        icon = 'â—';
        statusText = 'âœ“ Tamam';
        statusIcon = 'ðŸ“—';
        opacity = '0.7';
    } else if (window?.isMissed) {
        // YapÄ±lmadÄ± - Coral/Sunberry
        bgColor = 'rgba(255,134,116,.08)';
        accentColor = CORAL;
        icon = 'â—‹';
        statusText = 'YapÄ±lmadÄ±';
        statusIcon = 'ðŸ“•';
        riskText = `${missedPoints} puan`;
        opacity = '0.6';
    } else if (window?.isLate) {
        // GeÃ§ - Turuncu
        bgColor = 'rgba(243,156,18,.06)';
        accentColor = ORANGE;
        icon = 'â—';
        statusText = 'GeÃ§!';
        statusIcon = 'ðŸ“™';
        isActive = true;
        pulseClass = 'check-pulse-warning';
        riskText = `Hemen yap â†’ ${latePoints}`;
    } else if (window?.isInWindow) {
        // Aktif - Teal/Moonberry
        bgColor = 'rgba(0,140,149,.08)';
        accentColor = TEAL;
        icon = 'â—';
        statusText = 'Aktif';
        statusIcon = 'ðŸ“—';
        isActive = true;
        pulseClass = 'check-pulse-active';
        riskText = `Tamamla â†’ +${onTimePoints}`;
    }
    
    // Sorumlu personel butonlarÄ± - ADÄ°L DAÄžITIM
    let personnelHtml = '';
    if (responsiblePersonnel && responsiblePersonnel.length > 0 && !isCompleted) {
        if (responsiblePersonnel.length === 1) {
            personnelHtml = `<span style="font-size:.7rem;color:var(--tx2);margin-left:4px">â€¢ ${lookupPersonelDisplay(responsiblePersonnel[0])}</span>`;
        } else {
            // Birden fazla personel - butonlarla seÃ§
            personnelHtml = `<div style="display:flex;gap:4px;margin-left:8px">`;
            responsiblePersonnel.slice(0, 3).forEach((p, i) => {
                const displayName = lookupPersonelDisplay(p);
                personnelHtml += `<span style="font-size:.65rem;padding:2px 6px;background:${i === 0 ? accentColor : 'var(--bg4)'};color:${i === 0 ? '#fff' : 'var(--tx2)'};border-radius:4px;cursor:pointer" onclick="event.stopPropagation()">${displayName}</span>`;
            });
            personnelHtml += `</div>`;
        }
    }
    
    // Kalan sÃ¼re ve risk bilgisi - daha iyi gÃ¶rÃ¼nÃ¼m
    let timeHtml = '';
    if (!isCompleted && remaining && !remaining.isExpired && isActive) {
        const riskBg = window?.isLate ? 'rgba(243,156,18,.15)' : 'rgba(39,174,96,.15)';
        const riskColor = window?.isLate ? ORANGE : GREEN;
        timeHtml = `<span style="font-size:.7rem;color:var(--tx2);display:flex;align-items:center;gap:4px">
            <span class="countdown-timer" data-target="${window?.end || ''}" style="font-weight:500">${remaining.text}</span>
            <span style="color:${riskColor};font-size:.65rem;font-weight:600;background:${riskBg};padding:2px 6px;border-radius:4px">${riskText}</span>
        </span>`;
    } else if (!isCompleted && window?.isMissed) {
        timeHtml = `<span style="font-size:.7rem;color:${CORAL};font-weight:600;background:rgba(255,134,116,.15);padding:2px 6px;border-radius:4px">${riskText}</span>`;
    }
    
    // Puan bilgisi - her zaman gÃ¶ster (tamamlanmadÄ±ysa)
    let pointsInfoHtml = '';
    if (!isCompleted) {
        pointsInfoHtml = `
            <div style="display:flex;gap:6px;font-size:.65rem;margin-top:6px;flex-wrap:wrap">
                <span style="display:flex;align-items:center;gap:3px;padding:3px 7px;background:rgba(39,174,96,.1);color:#27ae60;border-radius:4px;font-weight:600">
                    <svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
                    Vaktinde: ${onTimePoints > 0 ? '+' : ''}${onTimePoints}
                </span>
                <span style="display:flex;align-items:center;gap:3px;padding:3px 7px;background:rgba(243,156,18,.1);color:#f39c12;border-radius:4px;font-weight:600">
                    <svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    GeÃ§: ${latePoints > 0 ? '+' : ''}${latePoints}
                </span>
                <span style="display:flex;align-items:center;gap:3px;padding:3px 7px;background:rgba(231,76,60,.1);color:#e74c3c;border-radius:4px;font-weight:600">
                    <svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    KaÃ§Ä±rÄ±ldÄ±: ${missedPoints}
                </span>
            </div>
        `;
    }
    
    return `
        <div class="${pulseClass}" style="background:${bgColor};border-left:3px solid ${accentColor};border-radius:8px;padding:10px 14px;display:flex;flex-direction:column;cursor:pointer;margin-bottom:8px;transition:all .2s;opacity:${opacity}" onclick="goTo('checklist')">
            <div style="display:flex;align-items:center;justify-content:space-between">
                <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                    <span style="color:${accentColor};font-size:1rem;${isActive ? 'animation:pulse-dot 1.5s infinite' : ''}">${icon}</span>
                    <span style="font-weight:600;font-size:.85rem;color:var(--tx)">${checkType.name} - ${timeSlot}</span>
                    ${personnelHtml}
                </div>
                <div style="display:flex;align-items:center;gap:8px">
                    ${timeHtml}
                    <span style="font-size:.75rem;font-weight:600;color:${accentColor};padding:3px 10px;background:${isCompleted ? 'rgba(156,163,175,.1)' : accentColor === CORAL ? 'rgba(255,134,116,.1)' : bgColor};border-radius:6px">${statusText}</span>
                </div>
            </div>
            ${pointsInfoHtml}
        </div>
    `;
}

// ==================== ADMIN - TÃœM CHECKLER Ã–ZETÄ° ====================
async function loadAllChecksOverview() {
    const container = document.getElementById('allChecksOverviewContainer');
    if (!container) return;
    
    const dateFilter = document.getElementById('allChecksDateFilter')?.value || 'today';
    const branchFilter = document.getElementById('allChecksBranchFilter')?.value || 'all';
    
    container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--tx2)"><div class="loading-spinner" style="margin:0 auto 16px"></div>YÃ¼kleniyor...</div>';
    
    try {
        // Tarih aralÄ±ÄŸÄ±nÄ± belirle
        const today = new Date();
        let startDate, endDate;
        
        if (dateFilter === 'today') {
            startDate = formatDateLocal(today);  // Timezone-safe
            endDate = startDate;
        } else if (dateFilter === 'yesterday') {
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            startDate = formatDateLocal(yesterday);  // Timezone-safe
            endDate = startDate;
        } else if (dateFilter === 'week') {
            const weekStart = getWeekStart(today);
            startDate = formatDateLocal(weekStart);  // Timezone-safe
            endDate = formatDateLocal(today);  // Timezone-safe
        }
        
        // Åžubeleri belirle
        const branches = branchFilter === 'all' ? (STATE.branches || []) : [branchFilter];
        
        let allSubmissions = [];
        let expectedChecks = [];
        
        // Her ÅŸube iÃ§in beklenen checkleri hesapla
        for (const branch of branches) {
            const checkTypes = CHECKLIST_TYPES[branch] || [];
            
            for (const checkType of checkTypes) {
                if (checkType.timeSlots && checkType.timeSlots.length > 0) {
                    for (const timeSlot of checkType.timeSlots) {
                        // Tarih aralÄ±ÄŸÄ±ndaki her gÃ¼n iÃ§in
                        let currentDate = new Date(startDate);
                        const end = new Date(endDate);
                        
                        while (currentDate <= end) {
                            const dateStr = currentDate.toISOString().split('T')[0];
                            expectedChecks.push({
                                branch,
                                type: checkType.id,
                                typeName: checkType.name,
                                timeSlot,
                                date: dateStr,
                                submissionId: `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_${checkType.id}_${dateStr}_${timeSlot.replace(':', '')}`
                            });
                            currentDate.setDate(currentDate.getDate() + 1);
                        }
                    }
                }
            }
        }
        
        // GÃ¶nderilen checkleri Ã§ek
        const submissionsMap = {};
        
        for (const expected of expectedChecks) {
            try {
                const doc = await db.collection('checklistSubmissions').doc(expected.submissionId).get();
                if (doc.exists) {
                    submissionsMap[expected.submissionId] = doc.data();
                }
            } catch (e) {}
        }
        
        // Ä°statistikler
        let completed = 0;
        let missed = 0;
        let pending = 0;
        let totalPoints = 0;
        
        const now = new Date();
        const currentMinutes = now.getHours() * 60 + now.getMinutes();
        
        // HTML oluÅŸtur
        let html = '';
        
        // Ã–zet kartlarÄ±
        expectedChecks.forEach(expected => {
            const submission = submissionsMap[expected.submissionId];
            const isToday = expected.date === today.toISOString().split('T')[0];
            
            if (submission) {
                completed++;
                totalPoints += submission.points || 0;
            } else if (isToday) {
                const window = getCheckTimeWindow(expected.type, expected.timeSlot, expected.branch);
                if (window && window.isMissed) {
                    missed++;
                } else {
                    pending++;
                }
            } else {
                missed++;
            }
        });
        
        // Ã–zet kartlarÄ±
        html += `
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:16px;margin-bottom:24px">
                <div style="background:rgba(39,174,96,.1);border:1px solid rgba(39,174,96,.2);border-radius:12px;padding:20px;text-align:center">
                    <div style="font-size:2rem;font-weight:700;color:#27ae60">${completed}</div>
                    <div style="font-size:.8rem;color:#27ae60;font-weight:500">TamamlandÄ±</div>
                </div>
                <div style="background:rgba(52,152,219,.1);border:1px solid rgba(52,152,219,.2);border-radius:12px;padding:20px;text-align:center">
                    <div style="font-size:2rem;font-weight:700;color:#3498db">${pending}</div>
                    <div style="font-size:.8rem;color:#3498db;font-weight:500">Bekliyor</div>
                </div>
                <div style="background:rgba(231,76,60,.1);border:1px solid rgba(231,76,60,.2);border-radius:12px;padding:20px;text-align:center">
                    <div style="font-size:2rem;font-weight:700;color:#e74c3c">${missed}</div>
                    <div style="font-size:.8rem;color:#e74c3c;font-weight:500">YapÄ±lmadÄ±</div>
                </div>
                <div style="background:var(--bg3);border:1px solid var(--cardBorder);border-radius:12px;padding:20px;text-align:center">
                    <div style="font-size:2rem;font-weight:700;color:${totalPoints >= 0 ? '#27ae60' : '#e74c3c'}">${totalPoints >= 0 ? '+' : ''}${totalPoints}</div>
                    <div style="font-size:.8rem;color:var(--tx2);font-weight:500">Toplam Puan</div>
                </div>
            </div>
        `;
        
        // Detay tablosu
        html += `
            <div style="overflow-x:auto">
                <table style="width:100%;border-collapse:collapse;font-size:.85rem">
                    <thead>
                        <tr style="background:var(--bg3)">
                            <th style="padding:12px;text-align:left;border-bottom:1px solid var(--cardBorder)">Åžube</th>
                            <th style="padding:12px;text-align:left;border-bottom:1px solid var(--cardBorder)">Check</th>
                            <th style="padding:12px;text-align:center;border-bottom:1px solid var(--cardBorder)">Saat</th>
                            <th style="padding:12px;text-align:center;border-bottom:1px solid var(--cardBorder)">Tarih</th>
                            <th style="padding:12px;text-align:center;border-bottom:1px solid var(--cardBorder)">Durum</th>
                            <th style="padding:12px;text-align:center;border-bottom:1px solid var(--cardBorder)">Dolduran</th>
                            <th style="padding:12px;text-align:center;border-bottom:1px solid var(--cardBorder)">Puan</th>
                            <th style="padding:12px;text-align:center;border-bottom:1px solid var(--cardBorder)">Ä°ÅŸlem</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        // Tarihe gÃ¶re sÄ±rala (en yeni en Ã¼stte)
        expectedChecks.sort((a, b) => {
            if (a.date !== b.date) return b.date.localeCompare(a.date);
            return a.timeSlot.localeCompare(b.timeSlot);
        });
        
        expectedChecks.forEach(expected => {
            const submission = submissionsMap[expected.submissionId];
            const isToday = expected.date === today.toISOString().split('T')[0];
            
            let statusBadge, statusColor;
            
            if (submission) {
                const pointStatus = submission.pointStatus || 'completed';
                if (pointStatus === 'onTime') {
                    statusBadge = 'âœ… Vaktinde';
                    statusColor = '#27ae60';
                } else if (pointStatus === 'late') {
                    statusBadge = 'â° GeÃ§';
                    statusColor = '#f39c12';
                } else {
                    statusBadge = 'âœ“ TamamlandÄ±';
                    statusColor = '#27ae60';
                }
            } else if (isToday) {
                const window = getCheckTimeWindow(expected.type, expected.timeSlot, expected.branch);
                if (window && window.isMissed) {
                    statusBadge = 'âŒ YapÄ±lmadÄ±';
                    statusColor = '#e74c3c';
                } else if (window && window.isLate) {
                    statusBadge = 'âš ï¸ GeÃ§ Pencere';
                    statusColor = '#f39c12';
                } else if (window && window.isInWindow) {
                    statusBadge = 'ðŸ”µ Aktif';
                    statusColor = '#3498db';
                } else {
                    statusBadge = 'â³ Bekliyor';
                    statusColor = '#95a5a6';
                }
            } else {
                statusBadge = 'âŒ YapÄ±lmadÄ±';
                statusColor = '#e74c3c';
            }
            
            const points = submission?.points || 0;
            const pointsDisplay = `<span style="color:${points > 0 ? '#27ae60' : points < 0 ? '#e74c3c' : '#95a5a6'};font-weight:600">${points > 0 ? '+' : ''}${points}</span>`;
            
            html += `
                <tr style="border-bottom:1px solid var(--bg3)">
                    <td style="padding:12px">${expected.branch}</td>
                    <td style="padding:12px;font-weight:500">${expected.typeName}</td>
                    <td style="padding:12px;text-align:center">${expected.timeSlot}</td>
                    <td style="padding:12px;text-align:center">${expected.date}</td>
                    <td style="padding:12px;text-align:center">
                        <span style="padding:4px 10px;border-radius:12px;font-size:.75rem;font-weight:600;background:${statusColor}15;color:${statusColor}">${statusBadge}</span>
                    </td>
                    <td style="padding:12px;text-align:center">${submission?.personName || '-'}</td>
                    <td style="padding:12px;text-align:center">${pointsDisplay}</td>
                    <td style="padding:12px;text-align:center">
                        ${!submission && (isToday || dateFilter !== 'today') ? `
                            <button class="btn btn-sm btn-ghost" onclick="showManualCheckModal('${expected.branch}', '${expected.type}', '${expected.timeSlot}', '${expected.date}')" title="Manuel Ekle">
                                âž•
                            </button>
                        ` : ''}
                        ${submission ? `
                            <button class="btn btn-sm btn-ghost" onclick="viewCheckDetails('${expected.submissionId}')" title="Detay">
                                ðŸ‘ï¸
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
        
        if (expectedChecks.length === 0) {
            html = '<div style="text-align:center;padding:60px;color:var(--tx2)">Bu dÃ¶nem iÃ§in check bulunamadÄ±.</div>';
        }
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Checkler yÃ¼klenirken hata:', error);
        container.innerHTML = '<div style="text-align:center;padding:40px;color:#e74c3c">YÃ¼kleme hatasÄ±!</div>';
    }
}

// Manuel check ekleme modal'Ä±
function showManualCheckModal(branch, type, timeSlot, date) {
    const typeInfo = CHECKLIST_TYPES[branch]?.find(t => t.id === type);
    const typeName = typeInfo?.name || type;
    
    showModal('âž• Manuel Check Ekle', `
        <div style="padding:8px 0">
            <div style="background:var(--bg3);border-radius:12px;padding:16px;margin-bottom:20px">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:.9rem">
                    <div><strong>Åžube:</strong> ${branch}</div>
                    <div><strong>Check:</strong> ${typeName}</div>
                    <div><strong>Saat:</strong> ${timeSlot}</div>
                    <div><strong>Tarih:</strong> ${date}</div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Dolduran Personel</label>
                <select id="manualCheckPersonel" class="form-select">
                    <option value="">-- SeÃ§in --</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Durum</label>
                <select id="manualCheckStatus" class="form-select">
                    <option value="onTime">âœ… Vaktinde</option>
                    <option value="late">â° GeÃ§</option>
                    <option value="missed">âŒ YapÄ±lmadÄ±</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Not (Opsiyonel)</label>
                <textarea id="manualCheckNote" class="form-input" rows="2" placeholder="Manuel ekleme sebebi..."></textarea>
            </div>
        </div>
    `, `
        <button class="btn btn-ghost" onclick="closeModal()">Ä°ptal</button>
        <button class="btn btn-primary" onclick="saveManualCheck('${branch}', '${type}', '${timeSlot}', '${date}')">ðŸ’¾ Kaydet</button>
    `);
    
    // Personel listesini doldur
    loadPersonelForManualCheck(branch);
}

async function loadPersonelForManualCheck(branch) {
    const select = document.getElementById('manualCheckPersonel');
    if (!select) return;
    
    try {
        // Åžube personeli
        const snapshot = await db.collection('personel').where('branch', '==', branch).get();
        
        // BÃ¶lge mÃ¼dÃ¼rleri (branch='all' - tÃ¼m ÅŸubelerde gÃ¶rÃ¼nÃ¼rler)
        const bolgeMuduruSnap = await db.collection('personel').where('branch', '==', 'all').get();
        
        let options = '<option value="">-- SeÃ§in --</option>';
        
        // Åžube personeli
        snapshot.forEach(doc => {
            const p = doc.data();
            options += `<option value="${doc.id}" data-name="${p.name}">${p.name}</option>`;
        });
        
        // BÃ¶lge mÃ¼dÃ¼rleri
        bolgeMuduruSnap.forEach(doc => {
            const p = doc.data();
            options += `<option value="${doc.id}" data-name="${p.name}">${p.name} (BÃ¶lge Md.)</option>`;
        });
        
        select.innerHTML = options;
    } catch (e) {
        console.error('Personel yÃ¼klenemedi:', e);
    }
}

async function saveManualCheck(branch, type, timeSlot, date) {
    const personelSelect = document.getElementById('manualCheckPersonel');
    const statusSelect = document.getElementById('manualCheckStatus');
    const noteInput = document.getElementById('manualCheckNote');
    
    const personelId = personelSelect?.value;
    const personelName = personelSelect?.selectedOptions[0]?.dataset?.name;
    const status = statusSelect?.value;
    const note = noteInput?.value?.trim();
    
    if (!personelId) {
        toast('LÃ¼tfen personel seÃ§in', 'error');
        return;
    }
    
    try {
        const submissionId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_${type}_${date}_${timeSlot.replace(':', '')}`;
        const rules = CHECK_RULES[type];
        let points = 0;
        
        if (rules) {
            if (status === 'onTime') points = rules.points.onTime;
            else if (status === 'late') points = rules.points.late;
            else if (status === 'missed') points = rules.points.missed;
        }
        
        await db.collection('checklistSubmissions').doc(submissionId).set({
            branch,
            type,
            checklistType: type, // Otomatik puanlama iÃ§in
            timeSlot,
            date,
            personName: personelName,
            submittedBy: currentUser?.id,
            submittedByName: currentUser?.name,
            submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
            points,
            pointStatus: status,
            status, // Otomatik puanlama iÃ§in
            manualEntry: true,
            manualNote: note || 'YÃ¶netici tarafÄ±ndan manuel eklendi',
            items: []
        });
        
        // Puantaj notu oluÅŸtur (0 puan dahil)
        await createAutoPuantajNote(personelId, personelName, type, timeSlot, status, points, branch, date);
        
        toast('Check kaydedildi', 'success');
        closeModal();
        loadAllChecksOverview();
        
    } catch (error) {
        console.error('KayÄ±t hatasÄ±:', error);
        toast('KayÄ±t hatasÄ±!', 'error');
    }
}

// Check detaylarÄ±nÄ± gÃ¶rÃ¼ntÃ¼le
async function viewCheckDetails(submissionId) {
    try {
        const doc = await db.collection('checklistSubmissions').doc(submissionId).get();
        if (!doc.exists) {
            toast('KayÄ±t bulunamadÄ±', 'error');
            return;
        }
        
        const data = doc.data();
        const submittedAt = data.submittedAt?.toDate?.()?.toLocaleString('tr-TR') || '-';
        
        let itemsHtml = '';
        if (data.items && data.items.length > 0) {
            itemsHtml = `
                <div style="margin-top:16px;max-height:300px;overflow-y:auto">
                    <div style="font-weight:600;margin-bottom:8px">Maddeler:</div>
                    ${data.items.map(item => `
                        <div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--bg3);font-size:.85rem">
                            <span style="color:${item.checked ? '#27ae60' : '#e74c3c'}">${item.checked ? 'âœ“' : 'âœ—'}</span>
                            <span>${item.id}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        showModal('ðŸ“‹ Check DetayÄ±', `
            <div style="padding:8px 0">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
                    <div>
                        <div style="font-size:.75rem;color:var(--tx2);margin-bottom:4px">Åžube</div>
                        <div style="font-weight:600">${data.branch || '-'}</div>
                    </div>
                    <div>
                        <div style="font-size:.75rem;color:var(--tx2);margin-bottom:4px">Tarih</div>
                        <div style="font-weight:600">${data.date || '-'}</div>
                    </div>
                    <div>
                        <div style="font-size:.75rem;color:var(--tx2);margin-bottom:4px">Saat</div>
                        <div style="font-weight:600">${data.timeSlot || '-'}</div>
                    </div>
                    <div>
                        <div style="font-size:.75rem;color:var(--tx2);margin-bottom:4px">Dolduran</div>
                        <div style="font-weight:600">${data.personName || '-'}</div>
                    </div>
                    <div>
                        <div style="font-size:.75rem;color:var(--tx2);margin-bottom:4px">GÃ¶nderim ZamanÄ±</div>
                        <div style="font-weight:600">${submittedAt}</div>
                    </div>
                    <div>
                        <div style="font-size:.75rem;color:var(--tx2);margin-bottom:4px">Puan</div>
                        <div style="font-weight:600;color:${(data.points || 0) >= 0 ? '#27ae60' : '#e74c3c'}">${(data.points || 0) >= 0 ? '+' : ''}${data.points || 0}</div>
                    </div>
                </div>
                
                ${data.manualEntry ? `
                    <div style="background:rgba(243,156,18,.1);border:1px solid rgba(243,156,18,.3);border-radius:8px;padding:12px;margin-bottom:16px">
                        <div style="font-size:.8rem;color:#f39c12;font-weight:600">âš ï¸ Manuel Ekleme</div>
                        <div style="font-size:.85rem;color:var(--tx);margin-top:4px">${data.manualNote || '-'}</div>
                    </div>
                ` : ''}
                
                ${itemsHtml}
            </div>
        `, '<button class="btn btn-ghost" onclick="closeModal()">Kapat</button>');
        
    } catch (error) {
        console.error('Detay yÃ¼klenemedi:', error);
        toast('YÃ¼kleme hatasÄ±!', 'error');
    }
}

// ==================== ADMIN - MAÄžAZA SAATLERÄ° ====================
function renderBranchHoursSettings() {
    const container = document.getElementById('branchHoursContainer');
    if (!container) return;
    
    const branches = STATE.branches || [];
    const days = ['Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi', 'Pazar'];
    const dayKeys = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    
    let html = '';
    
    branches.forEach(branch => {
        const hours = BRANCH_HOURS[branch] || { opening: '10:00', closing: { default: '01:00' } };
        const isMoonberry = true; // TÃ¼m ÅŸubeler Moonberry teal rengi
        const brandColor = isMoonberry ? '#008c95' : '#ff8674';
        const brandName = isMoonberry ? 'MOONBERRY' : 'SUNBERRY';
        
        html += `
            <div style="background:var(--bg3);border-radius:12px;padding:20px;border-left:4px solid ${brandColor}">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px">
                    <div style="width:32px;height:32px;background:${brandColor};border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:.75rem">${brandName.charAt(0)}</div>
                    <div>
                        <div style="font-weight:600;color:var(--tx)">${branch}</div>
                        <div style="font-size:.75rem;color:var(--tx2)">${brandName}</div>
                    </div>
                </div>
                
                <div class="form-grid" style="margin-bottom:16px">
                    <div class="form-group">
                        <label class="form-label">AÃ§Ä±lÄ±ÅŸ Saati</label>
                        <input type="time" class="form-input" id="hours_${branch.replace(/\s/g, '_')}_opening" value="${hours.opening || '10:00'}">
                    </div>
                </div>
                
                <div style="margin-bottom:12px">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                        <input type="checkbox" id="hours_${branch.replace(/\s/g, '_')}_sameClosing" 
                            ${!hours.closing.monday ? 'checked' : ''} 
                            onchange="toggleDailyClosing('${branch.replace(/\s/g, '_')}', this.checked)">
                        <span style="font-size:.85rem;color:var(--tx2)">TÃ¼m gÃ¼nler aynÄ± kapanÄ±ÅŸ saati</span>
                    </label>
                </div>
                
                <div id="sameClosing_${branch.replace(/\s/g, '_')}" style="${hours.closing.monday ? 'display:none' : ''}">
                    <div class="form-group">
                        <label class="form-label">KapanÄ±ÅŸ Saati (TÃ¼m GÃ¼nler)</label>
                        <input type="time" class="form-input" id="hours_${branch.replace(/\s/g, '_')}_closing_default" value="${hours.closing.default || '01:00'}">
                    </div>
                </div>
                
                <div id="dailyClosing_${branch.replace(/\s/g, '_')}" style="${!hours.closing.monday ? 'display:none' : ''}">
                    <label class="form-label" style="margin-bottom:8px">GÃ¼nlÃ¼k KapanÄ±ÅŸ Saatleri</label>
                    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px">
                        ${dayKeys.map((key, i) => `
                            <div>
                                <label style="font-size:.7rem;color:var(--tx3);display:block;margin-bottom:2px">${days[i]}</label>
                                <input type="time" class="form-input" style="font-size:.8rem;padding:6px 8px" 
                                    id="hours_${branch.replace(/\s/g, '_')}_closing_${key}" 
                                    value="${hours.closing[key] || hours.closing.default || '01:00'}">
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function toggleDailyClosing(branchKey, sameForAll) {
    document.getElementById('sameClosing_' + branchKey).style.display = sameForAll ? 'block' : 'none';
    document.getElementById('dailyClosing_' + branchKey).style.display = sameForAll ? 'none' : 'block';
}

async function saveBranchHours() {
    const branches = STATE.branches || [];
    const dayKeys = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    
    const branchHours = {};
    
    branches.forEach(branch => {
        const branchKey = branch.replace(/\s/g, '_');
        const opening = document.getElementById(`hours_${branchKey}_opening`)?.value || '10:00';
        const sameClosing = document.getElementById(`hours_${branchKey}_sameClosing`)?.checked;
        
        const closing = {};
        if (sameClosing) {
            closing.default = document.getElementById(`hours_${branchKey}_closing_default`)?.value || '01:00';
        } else {
            closing.default = document.getElementById(`hours_${branchKey}_closing_monday`)?.value || '01:00';
            dayKeys.forEach(day => {
                const val = document.getElementById(`hours_${branchKey}_closing_${day}`)?.value;
                if (val) closing[day] = val;
            });
        }
        
        branchHours[branch] = { opening, closing };
    });
    
    try {
        await db.collection('config').doc('system').update({
            branchHours,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        BRANCH_HOURS = branchHours;
        toast('MaÄŸaza saatleri kaydedildi', 'success');
    } catch (e) {
        console.error('KayÄ±t hatasÄ±:', e);
        toast('KayÄ±t hatasÄ±!', 'error');
    }
}

// ==================== ADMIN - CHECKLIST TÃœRLERÄ° YÃ–NETÄ°MÄ° ====================

let selectedChecklistTypeBranch = null; // STATE.branches[0] ile init edilecek
let checklistTypesData = {};

// Checklist tÃ¼rlerini Firebase'den yÃ¼kle
async function loadChecklistTypesConfig() {
    try {
        const doc = await db.collection('config').doc('checklistTypes').get();
        if (doc.exists) {
            const data = doc.data();
            checklistTypesData = {};
            for (const [key, value] of Object.entries(data)) {
                if (Array.isArray(value)) {
                    checklistTypesData[key] = value;
                }
            }
        } else {
            // VarsayÄ±lan tÃ¼rler - STATE.branches'dan dinamik
            const defaultTypes = [
                {id: 'acilis', name: 'AÃ§Ä±lÄ±ÅŸ', icon: 'sunrise'},
                {id: 'kapanis', name: 'KapanÄ±ÅŸ', icon: 'sunset'},
                {id: 'gunluk', name: 'GÃ¼nlÃ¼k Check', icon: 'clipboard-check', timeSlots: ['14:00','18:00','22:00']},
                {id: 'mudur', name: 'MÃ¼dÃ¼r Kontrol', icon: 'user-check', managerOnly: true},
                {id: 'platform', name: 'Platform Check', icon: 'smartphone', timeSlots: ['10:00','12:00','15:00','18:00','21:00','00:00']},
                {id: 'haftalik', name: 'HaftalÄ±k GÃ¶revler', icon: 'calendar-week'},
                {id: 'aylik', name: 'Temizlik ve BakÄ±m', icon: 'calendar'}
            ];
            checklistTypesData = {};
            (STATE.branches || []).forEach(branch => {
                checklistTypesData[branch] = [...defaultTypes];
            });
        }
        renderChecklistTypeBranchTabs();
        renderChecklistTypes();
    } catch (e) {
        console.error('Checklist tÃ¼rleri yÃ¼klenemedi:', e);
        showToast('Checklist tÃ¼rleri yÃ¼klenemedi', 'error');
    }
}

// Åžube tab'larÄ±nÄ± render et (dinamik + yetki bazlÄ±)
function renderChecklistTypeBranchTabs() {
    const container = document.getElementById('checklistTypeBranchTabs');
    if (!container) return;
    
    let branches = STATE.branches || [];
    if (branches.length === 0) return;
    
    // Yetki kontrolÃ¼: Sadece YÃ¶netici ve BÃ¶lge MÃ¼dÃ¼rÃ¼ tÃ¼m ÅŸubeleri gÃ¶rsÃ¼n
    const isAdmin = currentUser?.role === 'yonetici';
    const isBolgeMuduru = currentUser?.role === 'bolge_muduru';
    const canSeeAllBranches = isAdmin || isBolgeMuduru;
    
    if (!canSeeAllBranches && currentUser?.branch && currentUser?.branch !== 'all') {
        // Sadece kendi ÅŸubesini gÃ¶ster
        branches = branches.filter(b => b === currentUser.branch);
    }
    
    // Ä°lk ÅŸubeyi seÃ§ (eÄŸer seÃ§ili deÄŸilse veya seÃ§ili ÅŸube listede yoksa)
    if (!selectedChecklistTypeBranch || !branches.includes(selectedChecklistTypeBranch)) {
        selectedChecklistTypeBranch = branches[0];
    }
    
    container.innerHTML = branches.map(branch => {
        const isActive = branch === selectedChecklistTypeBranch;
        return `
            <button class="checklist-branch-tab ${isActive ? 'active' : ''}" 
                    onclick="selectChecklistTypeBranch('${branch}')" 
                    data-branch="${branch}" 
                    style="flex:1;padding:12px 16px;border:2px solid ${isActive ? '#008c95' : 'var(--bg4)'};background:${isActive ? 'rgba(0,140,149,.1)' : 'var(--bg3)'};border-radius:10px;cursor:pointer;font-weight:600;color:var(--tx);transition:all .2s;display:flex;align-items:center;justify-content:center;gap:8px">
                <span style="width:10px;height:10px;background:#008c95;border-radius:50%"></span>
                ${branch}
            </button>
        `;
    }).join('');
}

// Åžube seÃ§imi
function selectChecklistTypeBranch(branch) {
    selectedChecklistTypeBranch = branch;
    
    // Tab stillerini gÃ¼ncelle (Moonberry teal)
    document.querySelectorAll('.checklist-branch-tab').forEach(tab => {
        const isActive = tab.dataset.branch === branch;
        tab.classList.toggle('active', isActive);
        tab.style.borderColor = isActive ? '#008c95' : 'var(--bg4)';
        tab.style.background = isActive ? 'rgba(0,140,149,.1)' : 'var(--bg3)';
    });
    
    renderChecklistTypes();
}

// Checklist tÃ¼rlerini render et
function renderChecklistTypes() {
    const container = document.getElementById('checklistTypesContainer');
    if (!container) return;
    
    const types = checklistTypesData[selectedChecklistTypeBranch] || [];
    const brandColor = '#008c95'; // Moonberry teal
    
    const iconMap = {
        'sunrise': 'ðŸŒ…',
        'sunset': 'ðŸŒ†',
        'clipboard-check': 'ðŸ“‹',
        'user-check': 'ðŸ‘¤',
        'smartphone': 'ðŸ“±',
        'calendar': 'ðŸ“†',
        'calendar-week': 'ðŸ“…',
        'sparkle': 'âœ¨'
    };
    
    if (types.length === 0) {
        container.innerHTML = `
            <div style="text-align:center;padding:40px;color:var(--tx3)">
                <div style="font-size:2rem;margin-bottom:12px">ðŸ“‹</div>
                <div>Bu ÅŸube iÃ§in checklist tÃ¼rÃ¼ tanÄ±mlanmamÄ±ÅŸ</div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = types.map((type, idx) => `
        <div class="checklist-type-card" style="background:var(--bg3);border:1px solid var(--bg4);border-radius:12px;padding:16px;display:flex;align-items:center;gap:16px;transition:all .2s" data-id="${type.id}" draggable="true">
            <div style="cursor:grab;color:var(--tx3);padding:4px" title="SÃ¼rÃ¼kle">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="9" cy="6" r="1"/><circle cx="15" cy="6" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="9" cy="18" r="1"/><circle cx="15" cy="18" r="1"/></svg>
            </div>
            <div style="width:40px;height:40px;background:linear-gradient(135deg,${brandColor}22,${brandColor}11);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0">
                ${iconMap[type.icon] || 'ðŸ“‹'}
            </div>
            <div style="flex:1">
                <input type="text" class="form-input" value="${type.name}" onchange="updateChecklistTypeName('${type.id}', this.value)" style="font-weight:600;background:transparent;border:none;padding:0;font-size:.95rem;color:var(--tx);width:100%">
                <div style="display:flex;align-items:center;gap:8px;margin-top:4px">
                    <span style="font-size:.7rem;color:var(--tx3);background:var(--bg4);padding:2px 8px;border-radius:4px">${type.id}</span>
                    ${type.managerOnly ? '<span style="font-size:.65rem;color:#f39c12;background:rgba(243,156,18,.1);padding:2px 8px;border-radius:4px">Sadece YÃ¶netici</span>' : ''}
                    ${type.timeSlots ? `<span style="font-size:.65rem;color:var(--tx3)">${type.timeSlots.length} saat dilimi</span>` : ''}
                </div>
            </div>
            <select class="form-select" style="width:130px" onchange="updateChecklistTypeIcon('${type.id}', this.value)">
                <option value="clipboard-check" ${type.icon === 'clipboard-check' ? 'selected' : ''}>ðŸ“‹ Checklist</option>
                <option value="sunrise" ${type.icon === 'sunrise' ? 'selected' : ''}>ðŸŒ… AÃ§Ä±lÄ±ÅŸ</option>
                <option value="sunset" ${type.icon === 'sunset' ? 'selected' : ''}>ðŸŒ† KapanÄ±ÅŸ</option>
                <option value="smartphone" ${type.icon === 'smartphone' ? 'selected' : ''}>ðŸ“± Platform</option>
                <option value="user-check" ${type.icon === 'user-check' ? 'selected' : ''}>ðŸ‘¤ MÃ¼dÃ¼r</option>
                <option value="calendar" ${type.icon === 'calendar' ? 'selected' : ''}>ðŸ“† Takvim</option>
                <option value="calendar-week" ${type.icon === 'calendar-week' ? 'selected' : ''}>ðŸ“… HaftalÄ±k</option>
                <option value="sparkle" ${type.icon === 'sparkle' ? 'selected' : ''}>âœ¨ Temizlik</option>
            </select>
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:.8rem;color:var(--tx2)">
                <input type="checkbox" ${type.managerOnly ? 'checked' : ''} onchange="updateChecklistTypeManager('${type.id}', this.checked)" style="width:16px;height:16px;accent-color:${brandColor}">
                YÃ¶netici
            </label>
            <button onclick="deleteChecklistType('${type.id}')" style="background:none;border:none;cursor:pointer;color:var(--tx3);padding:8px;border-radius:8px;transition:all .2s" onmouseover="this.style.background='rgba(231,76,60,.1)';this.style.color='#e74c3c'" onmouseout="this.style.background='none';this.style.color='var(--tx3)'" title="Sil">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
            </button>
        </div>
    `).join('');
}

// Checklist tÃ¼rÃ¼ adÄ±nÄ± gÃ¼ncelle
function updateChecklistTypeName(typeId, newName) {
    const types = checklistTypesData[selectedChecklistTypeBranch] || [];
    const type = types.find(t => t.id === typeId);
    if (type) {
        type.name = newName;
    }
}

// Checklist tÃ¼rÃ¼ ikonunu gÃ¼ncelle
function updateChecklistTypeIcon(typeId, newIcon) {
    const types = checklistTypesData[selectedChecklistTypeBranch] || [];
    const type = types.find(t => t.id === typeId);
    if (type) {
        type.icon = newIcon;
        renderChecklistTypes();
    }
}

// Checklist tÃ¼rÃ¼ yÃ¶netici Ã¶zelliÄŸini gÃ¼ncelle
function updateChecklistTypeManager(typeId, isManager) {
    const types = checklistTypesData[selectedChecklistTypeBranch] || [];
    const type = types.find(t => t.id === typeId);
    if (type) {
        type.managerOnly = isManager;
    }
}

// Yeni checklist tÃ¼rÃ¼ ekle
async function addNewChecklistType() {
    const name = document.getElementById('newChecklistTypeName').value.trim();
    const id = document.getElementById('newChecklistTypeId').value.trim().toLowerCase().replace(/[^a-z0-9]/g, '_');
    const icon = document.getElementById('newChecklistTypeIcon').value;
    
    if (!name || !id) {
        showToast('TÃ¼r adÄ± ve ID gerekli', 'warning');
        return;
    }
    
    if (!checklistTypesData[selectedChecklistTypeBranch]) {
        checklistTypesData[selectedChecklistTypeBranch] = [];
    }
    
    // ID kontrolÃ¼
    if (checklistTypesData[selectedChecklistTypeBranch].some(t => t.id === id)) {
        showToast('Bu ID zaten kullanÄ±lÄ±yor', 'warning');
        return;
    }
    
    const newType = {
        id: id,
        name: name,
        icon: icon
    };
    
    checklistTypesData[selectedChecklistTypeBranch].push(newType);
    
    // Firebase'e hemen kaydet
    try {
        // 1. config/checklistTypes gÃ¼ncelle
        await db.collection('config').doc('checklistTypes').set({
            ...checklistTypesData,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // 2. checklists koleksiyonuna boÅŸ belge oluÅŸtur
        const checklistDocId = `${selectedChecklistTypeBranch.replace(/[^a-zA-Z0-9]/g, '_')}_${id}`;
        await db.collection('checklists').doc(checklistDocId).set({
            branch: selectedChecklistTypeBranch,
            type: id,
            items: [], // BoÅŸ maddeler - sonra dÃ¼zenleme modundan eklenecek
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Global CHECKLIST_TYPES'Ä± gÃ¼ncelle
        CHECKLIST_TYPES[selectedChecklistTypeBranch] = checklistTypesData[selectedChecklistTypeBranch];
        
        showToast(`"${name}" tÃ¼rÃ¼ eklendi ve kaydedildi`, 'success');
    } catch (e) {
        console.error('Yeni tÃ¼r kaydedilemedi:', e);
        showToast('Kaydetme hatasÄ±: ' + e.message, 'error');
        // Hata durumunda geri al
        checklistTypesData[selectedChecklistTypeBranch].pop();
        return;
    }
    
    // InputlarÄ± temizle
    document.getElementById('newChecklistTypeName').value = '';
    document.getElementById('newChecklistTypeId').value = '';
    
    renderChecklistTypes();
}

// Checklist tÃ¼rÃ¼ sil
function deleteChecklistType(typeId) {
    if (!confirm('Bu checklist tÃ¼rÃ¼nÃ¼ silmek istediÄŸinize emin misiniz?')) return;
    
    const types = checklistTypesData[selectedChecklistTypeBranch] || [];
    const idx = types.findIndex(t => t.id === typeId);
    if (idx > -1) {
        types.splice(idx, 1);
        renderChecklistTypes();
        showToast('TÃ¼r silindi', 'success');
    }
}

// Checklist tÃ¼rlerini Firebase'e kaydet
async function saveChecklistTypesConfig() {
    try {
        // 1. config/checklistTypes gÃ¼ncelle
        await db.collection('config').doc('checklistTypes').set({
            ...checklistTypesData,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // 2. Her tÃ¼r iÃ§in checklists koleksiyonunda belge var mÄ± kontrol et, yoksa oluÅŸtur
        for (const [branch, types] of Object.entries(checklistTypesData)) {
            for (const type of types) {
                const checklistDocId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_${type.id}`;
                try {
                    const doc = await db.collection('checklists').doc(checklistDocId).get();
                    if (!doc.exists) {
                        // Belge yoksa oluÅŸtur
                        await db.collection('checklists').doc(checklistDocId).set({
                            branch: branch,
                            type: type.id,
                            items: [],
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        console.log(`Checklist belgesi oluÅŸturuldu: ${checklistDocId}`);
                    }
                } catch (e) {
                    console.warn(`Checklist belgesi kontrolÃ¼ hatasÄ±: ${checklistDocId}`, e);
                }
            }
        }
        
        // 3. Global CHECKLIST_TYPES'Ä± da gÃ¼ncelle
        for (const [branch, types] of Object.entries(checklistTypesData)) {
            CHECKLIST_TYPES[branch] = types;
        }
        
        showToast('Checklist tÃ¼rleri kaydedildi', 'success');
    } catch (e) {
        console.error('Checklist tÃ¼rleri kaydedilemedi:', e);
        showToast('Kaydetme hatasÄ±: ' + e.message, 'error');
    }
}

// Checklist tÃ¼rlerini seed.html orijinalleriyle sync et
async function syncChecklistTypesWithSeed() {
    if (!confirm('Checklist tÃ¼rleri seed.html orijinal deÄŸerlerine sÄ±fÄ±rlanacak. Devam etmek istiyor musunuz?')) return;
    
    // seed.html'deki orijinal CHECKLIST_TYPES
    const SEED_CHECKLIST_TYPES = {
        'Tuzla TRC': [
            {id: 'acilis', name: 'AÃ§Ä±lÄ±ÅŸ HazÄ±rlÄ±klarÄ±', icon: 'sunrise'},
            {id: 'kapanis', name: 'KapanÄ±ÅŸ HazÄ±rlÄ±klarÄ±', icon: 'sunset'},
            {id: 'gunluk', name: 'GÃ¼nlÃ¼k Genel Check', icon: 'clipboard-check', timeSlots: ['14:00','18:00','22:00']},
            {id: 'mudur', name: 'MÃ¼dÃ¼r Kontrol', icon: 'user-check', managerOnly: true},
            {id: 'platform', name: 'Platform Check', icon: 'smartphone', timeSlots: ['10:00','12:00','15:00','18:00','21:00','00:00']},
            {id: 'haftalik', name: 'HaftalÄ±k GÃ¶revler', icon: 'calendar-week'},
            {id: 'aylik', name: 'Temizlik ve BakÄ±m', icon: 'calendar'}
        ],
        'ÅžiÅŸli (Merkez)': [
            {id: 'acilis', name: 'AÃ§Ä±lÄ±ÅŸ HazÄ±rlÄ±klarÄ±', icon: 'sunrise'},
            {id: 'kapanis', name: 'KapanÄ±ÅŸ HazÄ±rlÄ±klarÄ±', icon: 'sunset'},
            {id: 'gunluk', name: 'GÃ¼nlÃ¼k Genel Check', icon: 'clipboard-check', timeSlots: ['14:00','18:00','22:00']},
            {id: 'mudur', name: 'MÃ¼dÃ¼r Kontrol', icon: 'user-check', managerOnly: true},
            {id: 'platform', name: 'Platform Check', icon: 'smartphone', timeSlots: ['10:00','12:00','15:00','18:00','21:00','00:00']},
            {id: 'aylik', name: 'Temizlik ve BakÄ±m', icon: 'calendar'}
        ]
    };
    
    try {
        await db.collection('config').doc('checklistTypes').set({
            ...SEED_CHECKLIST_TYPES,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Global CHECKLIST_TYPES'Ä± da gÃ¼ncelle
        for (const [branch, types] of Object.entries(SEED_CHECKLIST_TYPES)) {
            CHECKLIST_TYPES[branch] = types;
        }
        
        // UI'Ä± gÃ¼ncelle
        checklistTypesData = { ...SEED_CHECKLIST_TYPES };
        renderChecklistTypes();
        
        showToast('Checklist tÃ¼rleri orijinal deÄŸerlere sÄ±fÄ±rlandÄ±', 'success');
    } catch (e) {
        console.error('Sync hatasÄ±:', e);
        showToast('Sync hatasÄ±: ' + e.message, 'error');
    }
}

// ==================== ADMIN - CHECK KURALLARI ====================
// ============== GELÄ°ÅžMÄ°Åž CHECK KURALLARI SÄ°STEMÄ° ==============

// Aktif seÃ§ili check tÃ¼rÃ¼
let selectedCheckRuleType = 'gunluk';

// Check tÃ¼rleri varsayÄ±lan ayarlarÄ±
const DEFAULT_CHECK_RULES = {
    gunluk: { 
        name: 'GÃ¼nlÃ¼k Check', 
        description: 'GÃ¼nlÃ¼k operasyonel kontroller',
        timeSlots: ['10:00', '12:00', '15:00', '18:00', '21:00'],
        lateWindow: 30,
        points: { onTime: 1, late: 0, missed: -2 },
        supervisorPenalty: -0.5,
        responsibleShift: 'auto', // auto = saat bazlÄ± otomatik
        branches: ['all']
    },
    platform: { 
        name: 'Platform Check', 
        description: 'Trendyol, Yemeksepeti, Getir kontrolleri',
        timeSlots: ['10:00', '12:00', '15:00', '18:00', '21:00', '00:00'],
        lateWindow: 30,
        points: { onTime: 0, late: 0, missed: -1 },
        supervisorPenalty: -0.3,
        responsibleShift: 'all',
        branches: ['all']
    },
    aylik: { 
        name: 'Temizlik Ã‡izelgesi', 
        description: 'Vardiya bazlÄ± temizlik gÃ¶revleri - 48 saat cooldown',
        shifts: {
            acilisci: { deadline: '15:00', window: { start: '10:00', end: '15:00' } },
            araci: { deadline: '19:00', window: { start: '11:00', end: '19:00' } },
            kapanisci: { deadline: '02:00', window: { start: '16:00', end: '02:00' } }
        },
        lateWindow: 30,
        points: { onTime: 1, late: 0, missed: -1 },
        supervisorPenalty: -0.5,
        branches: ['all']
    },
    mudur: { 
        name: 'MÃ¼dÃ¼r Kontrol', 
        description: 'YÃ¶neticilerin gÃ¼nlÃ¼k kontrol checklist\'i',
        deadline: '23:00',
        activeFrom: '18:00',
        lateWindow: 30,
        points: { onTime: 1, late: -1, missed: -2 },
        supervisorPenalty: 0, // MÃ¼dÃ¼r kendi check'i - penalty yok
        responsibleShift: 'mudur',
        branches: ['all']
    },
    acilis: { 
        name: 'AÃ§Ä±lÄ±ÅŸ HazÄ±rlÄ±klarÄ±', 
        description: 'Sabah aÃ§Ä±lÄ±ÅŸ kontrolleri',
        deadline: '11:00',
        activeFrom: '09:00',
        lateWindow: 30,
        points: { onTime: 1, late: -1, missed: -2 },
        supervisorPenalty: -1,
        responsibleShift: 'acilis',
        branches: ['all']
    },
    kapanis: { 
        name: 'KapanÄ±ÅŸ HazÄ±rlÄ±klarÄ±', 
        description: 'Gece kapanÄ±ÅŸ kontrolleri',
        deadline: '02:00',
        activeFrom: '22:00',
        lateWindow: 30,
        points: { onTime: 1, late: 0, missed: -2 },
        supervisorPenalty: -1,
        responsibleShift: 'kapanis',
        branches: ['all']
    }
};

// Check kurallarÄ± tab'Ä±nÄ± seÃ§
function selectCheckRuleTab(type) {
    selectedCheckRuleType = type;
    
    // Tab stillerini gÃ¼ncelle
    document.querySelectorAll('.check-rule-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.type === type);
    });
    
    // DetaylarÄ± render et
    renderCheckRuleDetails(type);
}

// Check kuralÄ± detaylarÄ±nÄ± render et
function renderCheckRuleDetails(type) {
    const container = document.getElementById('checkRuleDetails');
    if (!container) return;
    
    // Ã–nce DEFAULT_CHECK_RULES'ta var mÄ± kontrol et
    const defaultRule = DEFAULT_CHECK_RULES[type] || {};
    const checkRule = CHECK_RULES[type] || {};
    const rule = { ...defaultRule, ...checkRule };
    
    // EÄŸer hiÃ§ tanÄ±m yoksa uyarÄ± gÃ¶ster
    if (!rule.name) {
        container.innerHTML = `
            <div style="text-align:center;padding:40px;color:var(--tx2)">
                <div style="font-size:1.1rem;margin-bottom:8px">âš ï¸ TanÄ±m BulunamadÄ±</div>
                <div style="font-size:.85rem">"${type}" iÃ§in kural tanÄ±mÄ± mevcut deÄŸil.</div>
            </div>
        `;
        return;
    }
    
    const branches = STATE.branches || [];
    
    // Dinamik isim al - CHECKLIST_TYPES'tan Ã¶ncelikli
    let displayName = rule.name || type;
    for (const br of branches) {
        const typeInfo = CHECKLIST_TYPES[br]?.find(t => canonicalChecklistTypeId(t.id) === canonicalChecklistTypeId(type));
        if (typeInfo?.name) {
            displayName = typeInfo.name;
            break;
        }
    }
    
    let html = `
        <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:24px">
            <div>
                <h3 style="color:var(--tx);font-size:1.2rem;font-weight:600;margin:0 0 4px 0">${displayName}</h3>
                <p style="color:var(--tx2);font-size:.85rem;margin:0">${rule.description || ''}</p>
            </div>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="checkbox" id="checkRule_${type}_enabled" ${rule.enabled !== false ? 'checked' : ''} style="width:18px;height:18px;accent-color:#008c95">
                <span style="font-size:.85rem;color:var(--tx2)">Aktif</span>
            </label>
        </div>
    `;
    
    // Saat dilimleri olan check tÃ¼rleri
    if (rule.timeSlots) {
        html += `
            <div style="margin-bottom:24px">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
                    <div style="font-weight:600;color:var(--tx);font-size:.95rem">â° Saat Dilimleri</div>
                    <span style="font-size:.75rem;color:var(--tx3)">${(rule.timeSlots || []).length} adet</span>
                </div>
                <div id="timeSlotsContainer_${type}" style="display:grid;gap:10px;margin-bottom:16px">
                    ${(rule.timeSlots || []).map((time, idx) => renderTimeSlotCard(type, time, idx, rule)).join('')}
                </div>
                <button class="add-time-slot-btn" onclick="addTimeSlot('${type}')" style="width:100%;padding:14px;border:2px dashed var(--bg4);border-radius:10px;background:transparent;color:var(--primary);font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .2s" onmouseover="this.style.borderColor='var(--primary)';this.style.background='rgba(0,140,149,.05)'" onmouseout="this.style.borderColor='var(--bg4)';this.style.background='transparent'">
                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    Yeni Saat Dilimi Ekle
                </button>
                
                <div style="margin-top:16px;background:var(--bg3);border-radius:10px;padding:14px">
                    <div style="font-size:.75rem;color:var(--tx3);margin-bottom:6px">â±ï¸ GeÃ§ ToleransÄ± (dakika)</div>
                    <input type="number" class="form-input" id="checkRule_${type}_lateWindow" value="${rule.lateWindow || 0}" min="0" max="180" onchange="autoSaveCheckRules()" style="font-size:1rem;font-weight:600;width:100px">
                    <div style="font-size:.65rem;color:var(--tx3);margin-top:4px">BitiÅŸ saatinden sonra kaÃ§ dakika geÃ§ yapÄ±labilir</div>
                </div>
            </div>
        `;
    }
    
    // Periyot bazlÄ± check tÃ¼rleri (temizlik)
    if (rule.periods) {
        html += `
            <div style="margin-bottom:24px">
                <div style="font-weight:600;color:var(--tx);font-size:.95rem;margin-bottom:12px">Ã‡alÄ±ÅŸma PeriyotlarÄ±</div>
                <div style="display:grid;gap:12px">
                    ${rule.periods.map((period, idx) => `
                        <div class="time-slot-card">
                            <div style="min-width:120px">
                                <div style="font-weight:600;color:var(--tx)">${period.name}</div>
                                <div style="font-size:.75rem;color:var(--tx3)">${period.shift === 'acilis' ? 'AÃ§Ä±lÄ±ÅŸ VardiyasÄ±' : 'KapanÄ±ÅŸ VardiyasÄ±'}</div>
                            </div>
                            <div class="time-slot-window">
                                <input type="time" class="time-slot-input" id="period_${type}_${period.id}_start" value="${period.start}" onchange="updatePeriod('${type}', '${period.id}', 'start', this.value)">
                                <span style="color:var(--tx3)">â†’</span>
                                <input type="time" class="time-slot-input" id="period_${type}_${period.id}_end" value="${period.end}" onchange="updatePeriod('${type}', '${period.id}', 'end', this.value)">
                            </div>
                            <select class="form-select" style="width:140px" onchange="updatePeriod('${type}', '${period.id}', 'shift', this.value)">
                                <option value="acilis" ${period.shift === 'acilis' ? 'selected' : ''}>AÃ§Ä±lÄ±ÅŸ VardiyasÄ±</option>
                                <option value="kapanis" ${period.shift === 'kapanis' ? 'selected' : ''}>KapanÄ±ÅŸ VardiyasÄ±</option>
                                <option value="ara" ${period.shift === 'ara' ? 'selected' : ''}>Ara Vardiya</option>
                            </select>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    // Vardiya bazlÄ± check tÃ¼rleri (temizlik Ã§izelgesi)
    if (rule.shifts && (type === 'aylik' || type === 'temizlik')) {
        const shifts = rule.shifts;
        const shiftRules = rule.shiftRules || TEMIZLIK_SHIFT_RULES || {};
        
        // Saat seÃ§enekleri
        const hours = [];
        // Tam 24 saat - gece geÃ§iÅŸi iÃ§in tÃ¼m saatler
        for (let h = 0; h <= 23; h++) {
            hours.push(`${String(h).padStart(2, '0')}:00`);
            hours.push(`${String(h).padStart(2, '0')}:30`);
        }
        
        const shiftTypes = [
            { id: 'acilisci', name: 'AÃ§Ä±lÄ±ÅŸÃ§Ä±', icon: 'ðŸŒ…', color: '#27ae60', desc: 'Sabah vardiyasÄ± (aÃ§Ä±lÄ±ÅŸ yapan)' },
            { id: 'araci', name: 'AracÄ±', icon: 'â˜€ï¸', color: '#f39c12', desc: 'Ara vardiya (gÃ¼ndÃ¼z Ã§alÄ±ÅŸan)' },
            { id: 'kapanisci', name: 'KapanÄ±ÅŸÃ§Ä±', icon: 'ðŸŒ™', color: '#9b59b6', desc: 'AkÅŸam vardiyasÄ± (kapanÄ±ÅŸ yapan)' }
        ];
        
        html += `
            <div style="margin-bottom:24px">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
                    <div>
                        <div style="font-weight:600;color:var(--tx);font-size:.95rem">ðŸ§¹ Vardiya BazlÄ± Temizlik Saatleri</div>
                        <div style="font-size:.75rem;color:var(--tx3);margin-top:2px">Her vardiya tipi iÃ§in check yapÄ±labilir zaman aralÄ±ÄŸÄ±</div>
                    </div>
                </div>
                <div style="display:grid;gap:12px">
                    ${shiftTypes.map(shiftType => {
                        const shiftData = shifts[shiftType.id] || { window: { start: '10:00', end: '18:00' } };
                        const shiftRule = shiftRules[shiftType.id] || {};
                        const windowStart = shiftData.window?.start || '10:00';
                        const windowEnd = shiftData.window?.end || shiftData.deadline || '18:00';
                        
                        const startOptions = hours.map(h => 
                            `<option value="${h}" ${h === windowStart ? 'selected' : ''}>${h}</option>`
                        ).join('');
                        
                        const endOptions = hours.map(h => 
                            `<option value="${h}" ${h === windowEnd ? 'selected' : ''}>${h}</option>`
                        ).join('');
                        
                        return `
                            <div style="background:var(--bg3);border-radius:12px;padding:16px;border-left:4px solid ${shiftType.color}">
                                <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">
                                    <div style="display:flex;align-items:center;gap:12px;min-width:160px">
                                        <span style="font-size:1.5rem">${shiftType.icon}</span>
                                        <div>
                                            <div style="font-weight:600;color:var(--tx);font-size:1rem">${shiftType.name}</div>
                                            <div style="font-size:.7rem;color:var(--tx3)">${shiftType.desc}</div>
                                        </div>
                                    </div>
                                    <div style="display:flex;align-items:center;gap:8px">
                                        <div style="display:flex;flex-direction:column;gap:2px">
                                            <span style="font-size:.65rem;color:var(--tx3);text-transform:uppercase;letter-spacing:0.5px">BaÅŸlangÄ±Ã§</span>
                                            <select class="time-slot-select" id="shift_${type}_${shiftType.id}_start" 
                                                   onchange="updateShiftWindow('${type}', '${shiftType.id}', 'start', this.value)"
                                                   style="font-size:1rem;font-weight:600;padding:8px 12px;border:1px solid var(--bg4);border-radius:8px;background:var(--bg2);color:var(--tx);cursor:pointer;min-width:85px">
                                                ${startOptions}
                                            </select>
                                        </div>
                                        <svg width="24" height="24" fill="none" stroke="${shiftType.color}" stroke-width="2" viewBox="0 0 24 24">
                                            <line x1="5" y1="12" x2="19" y2="12"/><polyline points="14 7 19 12 14 17"/>
                                        </svg>
                                        <div style="display:flex;flex-direction:column;gap:2px">
                                            <span style="font-size:.65rem;color:var(--tx3);text-transform:uppercase;letter-spacing:0.5px">Son Teslim</span>
                                            <select class="time-slot-select" id="shift_${type}_${shiftType.id}_end" 
                                                   onchange="updateShiftWindow('${type}', '${shiftType.id}', 'end', this.value)"
                                                   style="font-size:1rem;font-weight:600;padding:8px 12px;border:1px solid var(--bg4);border-radius:8px;background:var(--bg2);color:${shiftType.color};cursor:pointer;min-width:85px">
                                                ${endOptions}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <div style="margin-top:16px;background:var(--bg3);border-radius:10px;padding:14px">
                    <div style="font-size:.75rem;color:var(--tx3);margin-bottom:6px">â±ï¸ GeÃ§ ToleransÄ± (dakika)</div>
                    <input type="number" class="form-input" id="checkRule_${type}_lateWindow" value="${rule.lateWindow || 30}" min="0" max="180" onchange="autoSaveCheckRules()" style="font-size:1rem;font-weight:600;width:100px">
                    <div style="font-size:.65rem;color:var(--tx3);margin-top:4px">Son teslim saatinden sonra kaÃ§ dakika geÃ§ yapÄ±labilir</div>
                </div>
                
                <div style="margin-top:12px;padding:12px;background:rgba(0,140,149,.05);border-radius:8px;border:1px solid rgba(0,140,149,.2)">
                    <div style="font-size:.75rem;color:var(--primary)">
                        ðŸ’¡ <strong>Otomatik AlgÄ±lama:</strong> Sistem, personelin shift saatine gÃ¶re hangi kategoriye girdiÄŸini otomatik belirler.
                        AÃ§Ä±lÄ±ÅŸ vardiyasÄ± baÅŸlatan â†’ AÃ§Ä±lÄ±ÅŸÃ§Ä±, KapanÄ±ÅŸ vardiyasÄ± yapan â†’ KapanÄ±ÅŸÃ§Ä±, DiÄŸerleri â†’ AracÄ±
                    </div>
                </div>
            </div>
        `;
    }
    
    // Son saat (deadline) olan check tÃ¼rleri
    if (rule.deadline) {
        // Saat seÃ§enekleri oluÅŸtur
        const hours = [];
        for (let h = 0; h <= 23; h++) {
            hours.push(`${String(h).padStart(2, '0')}:00`);
            hours.push(`${String(h).padStart(2, '0')}:30`);
        }
        
        const activeFromOptions = hours.map(h => 
            `<option value="${h}" ${h === (rule.activeFrom || '09:00') ? 'selected' : ''}>${h}</option>`
        ).join('');
        
        const deadlineOptions = hours.map(h => 
            `<option value="${h}" ${h === rule.deadline ? 'selected' : ''}>${h}</option>`
        ).join('');
        
        html += `
            <div style="margin-bottom:24px">
                <div style="font-weight:600;color:var(--tx);font-size:.95rem;margin-bottom:12px">â° Zaman AyarlarÄ±</div>
                <div style="display:flex;gap:16px;align-items:flex-end;flex-wrap:wrap;background:var(--bg3);padding:16px;border-radius:12px;margin-bottom:16px">
                    <div style="display:flex;flex-direction:column;gap:4px">
                        <span style="font-size:.75rem;color:var(--tx3);text-transform:uppercase;letter-spacing:0.5px">Aktif Olma Saati</span>
                        <select class="time-slot-select" id="checkRule_${type}_activeFrom" 
                               onchange="autoSaveCheckRules()"
                               style="font-size:1.1rem;font-weight:600;padding:10px 14px;border:1px solid var(--bg4);border-radius:8px;background:var(--bg2);color:var(--tx);cursor:pointer;min-width:100px">
                            ${activeFromOptions}
                        </select>
                    </div>
                    <svg width="28" height="28" fill="none" stroke="var(--primary)" stroke-width="2" viewBox="0 0 24 24" style="margin-bottom:8px">
                        <line x1="5" y1="12" x2="19" y2="12"/><polyline points="14 7 19 12 14 17"/>
                    </svg>
                    <div style="display:flex;flex-direction:column;gap:4px">
                        <span style="font-size:.75rem;color:var(--tx3);text-transform:uppercase;letter-spacing:0.5px">Son Teslim Saati</span>
                        <select class="time-slot-select" id="checkRule_${type}_deadline" 
                               onchange="autoSaveCheckRules()"
                               style="font-size:1.1rem;font-weight:600;padding:10px 14px;border:1px solid var(--bg4);border-radius:8px;background:var(--bg2);color:var(--primary);cursor:pointer;min-width:100px">
                            ${deadlineOptions}
                        </select>
                    </div>
                </div>
                
                <div style="background:var(--bg3);border-radius:10px;padding:14px">
                    <div style="font-size:.75rem;color:var(--tx3);margin-bottom:6px">â±ï¸ GeÃ§ ToleransÄ± (dakika)</div>
                    <input type="number" class="form-input" id="checkRule_${type}_lateWindow" value="${rule.lateWindow || 0}" min="0" max="180" style="font-size:1rem;font-weight:600;width:100px" onchange="autoSaveCheckRules()">
                    <div style="font-size:.65rem;color:var(--tx3);margin-top:4px">Son teslim saatinden sonra kaÃ§ dakika geÃ§ yapÄ±labilir</div>
                </div>
            </div>
        `;
    }
    
    // Puanlama sistemi
    html += `
        <div style="margin-bottom:24px">
            <div style="font-weight:600;color:var(--tx);font-size:.95rem;margin-bottom:12px">Puanlama KurallarÄ±</div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
                <div style="background:rgba(39,174,96,.08);border:1px solid rgba(39,174,96,.2);border-radius:10px;padding:14px;text-align:center">
                    <div style="font-size:.75rem;color:#27ae60;font-weight:600;margin-bottom:8px">VAKTÄ°NDE</div>
                    <input type="number" class="form-input" id="checkRule_${type}_onTime" value="${rule.points?.onTime || 0}" onchange="autoSaveCheckRules()" style="font-size:1.2rem;font-weight:700;text-align:center;color:#27ae60;background:transparent;border:none">
                    <div style="font-size:.65rem;color:var(--tx3);margin-top:4px">puan</div>
                </div>
                <div style="background:rgba(243,156,18,.08);border:1px solid rgba(243,156,18,.2);border-radius:10px;padding:14px;text-align:center">
                    <div style="font-size:.75rem;color:#f39c12;font-weight:600;margin-bottom:8px">GEÃ‡</div>
                    <input type="number" class="form-input" id="checkRule_${type}_late" value="${rule.points?.late || 0}" onchange="autoSaveCheckRules()" style="font-size:1.2rem;font-weight:700;text-align:center;color:#f39c12;background:transparent;border:none">
                    <div style="font-size:.65rem;color:var(--tx3);margin-top:4px">puan</div>
                </div>
                <div style="background:rgba(231,76,60,.08);border:1px solid rgba(231,76,60,.2);border-radius:10px;padding:14px;text-align:center">
                    <div style="font-size:.75rem;color:#e74c3c;font-weight:600;margin-bottom:8px">YAPILMADI</div>
                    <input type="number" class="form-input" id="checkRule_${type}_missed" value="${rule.points?.missed || -1}" onchange="autoSaveCheckRules()" style="font-size:1.2rem;font-weight:700;text-align:center;color:#e74c3c;background:transparent;border:none">
                    <div style="font-size:.65rem;color:var(--tx3);margin-top:4px">puan</div>
                </div>
            </div>
        </div>
    `;
    
    // HaftalÄ±k gÃ¶revler iÃ§in Ã¶zel ayarlar (cooldown, hafta baÅŸlangÄ±Ã§)
    if (type === 'haftalik') {
        const cooldownHours = rule.cooldownHours || 48;
        const weekStartDay = rule.weekStartDay ?? 1; // 0=Pazar, 1=Pazartesi, ...
        const weekStartHour = rule.weekStartHour || '03:00';
        
        const days = [
            { value: 0, name: 'Pazar' },
            { value: 1, name: 'Pazartesi' },
            { value: 2, name: 'SalÄ±' },
            { value: 3, name: 'Ã‡arÅŸamba' },
            { value: 4, name: 'PerÅŸembe' },
            { value: 5, name: 'Cuma' },
            { value: 6, name: 'Cumartesi' }
        ];
        
        const hours = [];
        for (let h = 0; h <= 23; h++) {
            hours.push(`${String(h).padStart(2, '0')}:00`);
            hours.push(`${String(h).padStart(2, '0')}:30`);
        }
        
        html += `
            <div style="margin-bottom:24px">
                <div style="font-weight:600;color:var(--tx);font-size:.95rem;margin-bottom:12px">ðŸ”„ Round-Robin Atama AyarlarÄ±</div>
                
                <div style="background:var(--bg3);border-radius:12px;padding:16px;margin-bottom:12px">
                    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px">
                        
                        <!-- Cooldown SÃ¼resi -->
                        <div style="display:flex;flex-direction:column;gap:6px">
                            <label style="font-size:.75rem;color:var(--tx3);text-transform:uppercase;letter-spacing:0.5px">
                                â±ï¸ Cooldown SÃ¼resi (saat)
                            </label>
                            <input type="number" class="form-input" id="checkRule_haftalik_cooldownHours" 
                                   value="${cooldownHours}" min="1" max="168" onchange="autoSaveCheckRules()"
                                   style="font-size:1.1rem;font-weight:600;padding:10px 14px;width:100px">
                            <span style="font-size:.65rem;color:var(--tx3)">Madde tamamlandÄ±ktan sonra tekrar aktif olana kadar</span>
                        </div>
                        
                        <!-- Hafta BaÅŸlangÄ±Ã§ GÃ¼nÃ¼ -->
                        <div style="display:flex;flex-direction:column;gap:6px">
                            <label style="font-size:.75rem;color:var(--tx3);text-transform:uppercase;letter-spacing:0.5px">
                                ðŸ“… Hafta BaÅŸlangÄ±Ã§ GÃ¼nÃ¼
                            </label>
                            <select class="form-input" id="checkRule_haftalik_weekStartDay" onchange="autoSaveCheckRules()"
                                    style="font-size:1.1rem;font-weight:600;padding:10px 14px;min-width:140px">
                                ${days.map(d => `<option value="${d.value}" ${d.value === weekStartDay ? 'selected' : ''}>${d.name}</option>`).join('')}
                            </select>
                            <span style="font-size:.65rem;color:var(--tx3)">Round-robin kaymasÄ±nÄ±n yapÄ±lacaÄŸÄ± gÃ¼n</span>
                        </div>
                        
                        <!-- Hafta BaÅŸlangÄ±Ã§ Saati -->
                        <div style="display:flex;flex-direction:column;gap:6px">
                            <label style="font-size:.75rem;color:var(--tx3);text-transform:uppercase;letter-spacing:0.5px">
                                ðŸ• Hafta BaÅŸlangÄ±Ã§ Saati
                            </label>
                            <select class="form-input" id="checkRule_haftalik_weekStartHour" onchange="autoSaveCheckRules()"
                                    style="font-size:1.1rem;font-weight:600;padding:10px 14px;min-width:100px">
                                ${hours.map(h => `<option value="${h}" ${h === weekStartHour ? 'selected' : ''}>${h}</option>`).join('')}
                            </select>
                            <span style="font-size:.65rem;color:var(--tx3)">Yeni hafta dÃ¶ngÃ¼sÃ¼nÃ¼n baÅŸlayacaÄŸÄ± saat</span>
                        </div>
                        
                    </div>
                </div>
                
                <div style="padding:12px;background:rgba(0,140,149,.05);border-radius:8px;border:1px solid rgba(0,140,149,.2)">
                    <div style="font-size:.75rem;color:var(--primary)">
                        ðŸ’¡ <strong>NasÄ±l Ã‡alÄ±ÅŸÄ±r:</strong><br>
                        â€¢ Her hafta baÅŸlangÄ±cÄ±nda maddeler personele round-robin ile atanÄ±r<br>
                        â€¢ Atanan kiÅŸi maddeyi tamamladÄ±ÄŸÄ±nda cooldown sÃ¼resi baÅŸlar<br>
                        â€¢ Cooldown bitince madde tekrar aynÄ± kiÅŸiye aktif olur<br>
                        â€¢ Hafta sonunda kayma: Mehmetâ†’Aliâ†’AyÅŸe dÃ¶ner
                    </div>
                </div>
            </div>
        `;
    }
    
    // Sorumlu vardiya
    html += `
        <div style="margin-bottom:24px">
            <div style="font-weight:600;color:var(--tx);font-size:.95rem;margin-bottom:12px">Sorumlu Vardiya</div>
            <div style="display:flex;gap:10px;flex-wrap:wrap">
                ${['auto', 'acilis', 'kapanis', 'ara', 'all', 'mudur'].map(shift => `
                    <label style="display:flex;align-items:center;gap:8px;padding:10px 16px;background:var(--bg3);border:1px solid ${rule.responsibleShift === shift ? '#008c95' : 'var(--bg4)'};border-radius:8px;cursor:pointer;transition:all .2s">
                        <input type="radio" name="checkRule_${type}_shift" value="${shift}" ${rule.responsibleShift === shift ? 'checked' : ''} style="accent-color:#008c95">
                        <span style="font-size:.85rem;color:var(--tx)">${shift === 'auto' ? 'Otomatik (Saat BazlÄ±)' : shift === 'acilis' ? 'AÃ§Ä±lÄ±ÅŸ' : shift === 'kapanis' ? 'KapanÄ±ÅŸ' : shift === 'ara' ? 'Ara Vardiya' : shift === 'all' ? 'Herkese' : 'Sadece MÃ¼dÃ¼r'}</span>
                    </label>
                `).join('')}
            </div>
        </div>
    `;
    
    // Åžube seÃ§imi
    html += `
        <div>
            <div style="font-weight:600;color:var(--tx);font-size:.95rem;margin-bottom:12px">GeÃ§erli Åžubeler</div>
            <div style="display:flex;gap:10px;flex-wrap:wrap">
                <label style="display:flex;align-items:center;gap:8px;padding:10px 16px;background:var(--bg3);border:1px solid ${(rule.branches || []).includes('all') ? '#008c95' : 'var(--bg4)'};border-radius:8px;cursor:pointer">
                    <input type="checkbox" id="checkRule_${type}_branch_all" ${(rule.branches || ['all']).includes('all') ? 'checked' : ''} onchange="toggleAllBranches('${type}')" style="accent-color:#008c95">
                    <span style="font-size:.85rem;color:var(--tx)">TÃ¼m Åžubeler</span>
                </label>
                ${branches.map(branch => `
                    <label style="display:flex;align-items:center;gap:8px;padding:10px 16px;background:var(--bg3);border:1px solid var(--bg4);border-radius:8px;cursor:pointer" id="branchLabel_${type}_${branch.replace(/[^a-zA-Z]/g, '')}">
                        <input type="checkbox" class="branch-checkbox-${type}" value="${branch}" ${(rule.branches || ['all']).includes('all') || (rule.branches || []).includes(branch) ? 'checked' : ''} style="accent-color:#008c95">
                        <span style="font-size:.85rem;color:var(--tx)">${branch}</span>
                    </label>
                `).join('')}
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

// Saat dilimi kartÄ± render
function renderTimeSlotCard(type, timeOrSlot, idx, rule) {
    // timeOrSlot string olabilir (eski format "14:00") veya obje olabilir (yeni format {start, end})
    const isObject = typeof timeOrSlot === 'object' && timeOrSlot !== null;
    const start = isObject ? (timeOrSlot.start || timeOrSlot.time || '09:00') : timeOrSlot;
    const end = isObject ? (timeOrSlot.end || addHours(start, 1)) : addHours(timeOrSlot, 1);
    
    // Saat seÃ§enekleri oluÅŸtur (08:00 - 02:00 arasÄ±, yarÄ±m saat aralÄ±klarla)
    const hours = [];
    // Tam 24 saat - gece geÃ§iÅŸi iÃ§in tÃ¼m saatler
    for (let h = 0; h <= 23; h++) {
        hours.push(`${String(h).padStart(2, '0')}:00`);
        hours.push(`${String(h).padStart(2, '0')}:30`);
    }
    
    const startOptions = hours.map(h => 
        `<option value="${h}" ${h === start ? 'selected' : ''}>${h}</option>`
    ).join('');
    
    const endOptions = hours.map(h => 
        `<option value="${h}" ${h === end ? 'selected' : ''}>${h}</option>`
    ).join('');
    
    return `
        <div class="time-slot-card" id="timeSlot_${type}_${idx}" style="display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--bg3);border-radius:10px;border:1px solid var(--bg4)">
            <div style="display:flex;align-items:center;gap:8px;flex:1">
                <div style="display:flex;flex-direction:column;gap:2px">
                    <span style="font-size:.65rem;color:var(--tx3);text-transform:uppercase;letter-spacing:0.5px">BaÅŸlangÄ±Ã§</span>
                    <select class="time-slot-select" id="slot_${type}_${idx}_start" 
                           onchange="updateTimeSlotField('${type}', ${idx}, 'start', this.value)"
                           style="font-size:1.1rem;font-weight:600;padding:8px 12px;border:1px solid var(--bg4);border-radius:8px;background:var(--bg2);color:var(--tx);cursor:pointer;min-width:90px">
                        ${startOptions}
                    </select>
                </div>
                <svg width="24" height="24" fill="none" stroke="var(--primary)" stroke-width="2" viewBox="0 0 24 24" style="margin:0 4px">
                    <line x1="5" y1="12" x2="19" y2="12"/><polyline points="14 7 19 12 14 17"/>
                </svg>
                <div style="display:flex;flex-direction:column;gap:2px">
                    <span style="font-size:.65rem;color:var(--tx3);text-transform:uppercase;letter-spacing:0.5px">BitiÅŸ</span>
                    <select class="time-slot-select" id="slot_${type}_${idx}_end" 
                           onchange="updateTimeSlotField('${type}', ${idx}, 'end', this.value)"
                           style="font-size:1.1rem;font-weight:600;padding:8px 12px;border:1px solid var(--bg4);border-radius:8px;background:var(--bg2);color:var(--tx);cursor:pointer;min-width:90px">
                        ${endOptions}
                    </select>
                </div>
            </div>
            
            <button class="time-slot-delete" onclick="deleteTimeSlot('${type}', ${idx})" 
                    style="width:36px;height:36px;border-radius:8px;border:none;background:rgba(231,76,60,.1);color:#e74c3c;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s"
                    onmouseover="this.style.background='rgba(231,76,60,.2)'" 
                    onmouseout="this.style.background='rgba(231,76,60,.1)'"
                    title="Bu saati sil">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                </svg>
            </button>
        </div>
    `;
}

// Saate saat ekle helper
function addHours(timeStr, hours) {
    const [h, m] = timeStr.split(':').map(Number);
    const newH = (h + hours) % 24;
    return `${String(newH).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
}

// Saat dilimi alanÄ±nÄ± gÃ¼ncelle
function updateTimeSlotField(type, idx, field, value) {
    if (!CHECK_RULES[type]) CHECK_RULES[type] = { ...DEFAULT_CHECK_RULES[type] };
    
    // timeSlots'u obje formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼r
    let timeSlots = CHECK_RULES[type].timeSlots || [];
    
    // String array'i obje array'ine dÃ¶nÃ¼ÅŸtÃ¼r
    timeSlots = timeSlots.map((slot, i) => {
        if (typeof slot === 'string') {
            return {
                start: slot,
                end: addHours(slot, 1)
            };
        }
        return slot;
    });
    
    // Ä°lgili alanÄ± gÃ¼ncelle
    if (field === 'start' || field === 'end') {
        timeSlots[idx][field] = value;
        // BaÅŸlangÄ±Ã§ saatine gÃ¶re sÄ±rala
        timeSlots.sort((a, b) => a.start.localeCompare(b.start));
    }
    
    CHECK_RULES[type].timeSlots = timeSlots;
    
    // Otomatik kaydet
    autoSaveCheckRules();
}

// Saat dilimi ekle
function addTimeSlot(type) {
    if (!CHECK_RULES[type]) CHECK_RULES[type] = { ...DEFAULT_CHECK_RULES[type] };
    
    let timeSlots = CHECK_RULES[type].timeSlots || [];
    
    // String array'i obje array'ine dÃ¶nÃ¼ÅŸtÃ¼r
    timeSlots = timeSlots.map(slot => {
        if (typeof slot === 'string') {
            return {
                start: slot,
                end: addHours(slot, 1)
            };
        }
        return slot;
    });
    
    // Yeni baÅŸlangÄ±Ã§ saati (son bitiÅŸ saatinden sonra veya 12:00)
    let newStart = '12:00';
    if (timeSlots.length > 0) {
        const lastSlot = timeSlots[timeSlots.length - 1];
        newStart = lastSlot.end || addHours(lastSlot.start, 1);
    }
    
    // Yeni slot objesi
    const newSlot = {
        start: newStart,
        end: addHours(newStart, 1)
    };
    
    timeSlots.push(newSlot);
    timeSlots.sort((a, b) => a.start.localeCompare(b.start));
    
    CHECK_RULES[type].timeSlots = timeSlots;
    
    renderCheckRuleDetails(type);
    toast('Saat dilimi eklendi', 'success');
}

// Eski format iÃ§in geriye uyumluluk - updateTimeSlotField'a yÃ¶nlendir
function updateTimeSlot(type, idx, newTime) {
    updateTimeSlotField(type, idx, 'start', newTime);
    renderCheckRuleDetails(type);
}

// Saat dilimini sil
function deleteTimeSlot(type, idx) {
    if (!CHECK_RULES[type]) return;
    
    let timeSlots = CHECK_RULES[type].timeSlots || [];
    
    if (timeSlots.length <= 1) {
        toast('En az bir saat dilimi olmalÄ±', 'error');
        return;
    }
    
    timeSlots.splice(idx, 1);
    CHECK_RULES[type].timeSlots = timeSlots;
    
    renderCheckRuleDetails(type);
    toast('Saat dilimi silindi', 'success');
}

// Periyot gÃ¼ncelle
function updatePeriod(type, periodId, field, value) {
    if (!CHECK_RULES[type]) CHECK_RULES[type] = { ...DEFAULT_CHECK_RULES[type] };
    const periods = CHECK_RULES[type].periods || DEFAULT_CHECK_RULES[type].periods;
    const period = periods.find(p => p.id === periodId);
    if (period) {
        period[field] = value;
        CHECK_RULES[type].periods = periods;
    }
}

// Vardiya bazlÄ± check window gÃ¼ncelle (temizlik Ã§izelgesi iÃ§in)
function updateShiftWindow(type, shiftId, field, value) {
    if (!CHECK_RULES[type]) CHECK_RULES[type] = { ...DEFAULT_CHECK_RULES[type] };
    
    // shifts objesini oluÅŸtur veya al
    if (!CHECK_RULES[type].shifts) {
        CHECK_RULES[type].shifts = {
            acilisci: { deadline: '15:00', window: { start: '10:00', end: '15:00' } },
            araci: { deadline: '19:00', window: { start: '11:00', end: '19:00' } },
            kapanisci: { deadline: '02:00', window: { start: '16:00', end: '02:00' } }
        };
    }
    
    // Ä°lgili shift'i al veya oluÅŸtur
    if (!CHECK_RULES[type].shifts[shiftId]) {
        CHECK_RULES[type].shifts[shiftId] = { window: { start: '10:00', end: '18:00' } };
    }
    
    // Window objesini oluÅŸtur
    if (!CHECK_RULES[type].shifts[shiftId].window) {
        CHECK_RULES[type].shifts[shiftId].window = { start: '10:00', end: '18:00' };
    }
    
    // AlanÄ± gÃ¼ncelle
    if (field === 'start') {
        CHECK_RULES[type].shifts[shiftId].window.start = value;
    } else if (field === 'end') {
        CHECK_RULES[type].shifts[shiftId].window.end = value;
        CHECK_RULES[type].shifts[shiftId].deadline = value; // deadline de gÃ¼ncelle
    }
    
    console.log(`[CheckRules] ${type}.shifts.${shiftId} gÃ¼ncellendi:`, CHECK_RULES[type].shifts[shiftId]);
    
    // Otomatik kaydet
    autoSaveCheckRules();
}

// TÃ¼m ÅŸubeleri toggle
function toggleAllBranches(type) {
    const allChecked = document.getElementById(`checkRule_${type}_branch_all`).checked;
    document.querySelectorAll(`.branch-checkbox-${type}`).forEach(cb => {
        cb.checked = allChecked;
        cb.disabled = allChecked;
    });
}

// Otomatik kaydetme - direkt kaydet
function autoSaveCheckRules() {
    console.log('[AutoSave] Check kurallarÄ± kaydediliyor...');
    saveAdvancedCheckRules();
}

// GeliÅŸmiÅŸ check kurallarÄ±nÄ± kaydet
async function saveAdvancedCheckRules() {
    // TÃ¼m check tÃ¼rlerini dinamik olarak topla
    const allTypes = new Set();
    for (const types of Object.values(CHECKLIST_TYPES)) {
        if (Array.isArray(types)) {
            types.forEach(t => allTypes.add(t.id));
        }
    }
    Object.keys(CHECK_RULES).forEach(id => allTypes.add(id));
    Object.keys(DEFAULT_CHECK_RULES).forEach(id => allTypes.add(id));
    
    const checkRules = {};
    
    allTypes.forEach(type => {
        const baseRule = DEFAULT_CHECK_RULES[type] || {};
        const existingRule = CHECK_RULES[type] || {};
        const rule = { ...baseRule, ...existingRule };
        
        // supervisorPenalty'yi koru (Firebase'den gelmemiÅŸse default kullan)
        rule.supervisorPenalty = existingRule.supervisorPenalty ?? baseRule.supervisorPenalty ?? -0.5;
        
        // Enabled
        const enabledEl = document.getElementById(`checkRule_${type}_enabled`);
        if (enabledEl) rule.enabled = enabledEl.checked;
        
        // Time slots
        if (existingRule.timeSlots || baseRule.timeSlots) {
            // GÃ¼ncel timeSlots'Ä± al (addTimeSlot/removeTimeSlot ile gÃ¼ncelleniyor)
            rule.timeSlots = CHECK_RULES[type]?.timeSlots || baseRule.timeSlots || [];
            
            // timeSlots iÃ§in lateWindow
            const lateWindowEl = document.getElementById(`checkRule_${type}_lateWindow`);
            if (lateWindowEl) {
                rule.lateWindow = parseInt(lateWindowEl.value) || 0;
            }
        }
        
        // Periods
        if (existingRule.periods || baseRule.periods) {
            rule.periods = CHECK_RULES[type]?.periods || baseRule.periods;
        }
        
        // Shifts (vardiya bazlÄ± temizlik Ã§izelgesi iÃ§in)
        if (existingRule.shifts || baseRule.shifts) {
            // Form'dan gÃ¼ncel deÄŸerleri al
            const shifts = CHECK_RULES[type]?.shifts || { ...baseRule.shifts };
            
            // Her shift iÃ§in form deÄŸerlerini kontrol et
            ['acilisci', 'araci', 'kapanisci'].forEach(shiftId => {
                const startEl = document.getElementById(`shift_${type}_${shiftId}_start`);
                const endEl = document.getElementById(`shift_${type}_${shiftId}_end`);
                
                if (startEl || endEl) {
                    if (!shifts[shiftId]) shifts[shiftId] = { window: {} };
                    if (!shifts[shiftId].window) shifts[shiftId].window = {};
                    
                    if (startEl) shifts[shiftId].window.start = startEl.value;
                    if (endEl) {
                        shifts[shiftId].window.end = endEl.value;
                        shifts[shiftId].deadline = endEl.value;
                    }
                }
            });
            
            rule.shifts = shifts;
        }
        
        // lateWindow (tÃ¼m check tÃ¼rleri iÃ§in)
        const lateEl = document.getElementById(`checkRule_${type}_lateWindow`);
        if (lateEl) {
            rule.lateWindow = parseInt(lateEl.value) || 0;
        }
        
        // window varsa sil (artÄ±k kullanÄ±lmÄ±yor)
        if (rule.window) {
            delete rule.window;
        }
        
        // Deadline
        const deadlineEl = document.getElementById(`checkRule_${type}_deadline`);
        const activeFromEl = document.getElementById(`checkRule_${type}_activeFrom`);
        if (deadlineEl?.value) rule.deadline = deadlineEl.value;
        if (activeFromEl?.value) rule.activeFrom = activeFromEl.value;
        
        // HaftalÄ±k iÃ§in Ã¶zel ayarlar (cooldown, hafta baÅŸlangÄ±Ã§)
        if (type === 'haftalik') {
            const cooldownEl = document.getElementById('checkRule_haftalik_cooldownHours');
            const weekDayEl = document.getElementById('checkRule_haftalik_weekStartDay');
            const weekHourEl = document.getElementById('checkRule_haftalik_weekStartHour');
            
            if (cooldownEl) rule.cooldownHours = parseInt(cooldownEl.value) || 48;
            if (weekDayEl) rule.weekStartDay = parseInt(weekDayEl.value);
            if (weekHourEl) rule.weekStartHour = weekHourEl.value || '03:00';
        }
        
        // Points - HER ZAMAN form deÄŸerlerini al
        const onTimeEl = document.getElementById(`checkRule_${type}_onTime`);
        const latePointsEl = document.getElementById(`checkRule_${type}_late`);
        const missedEl = document.getElementById(`checkRule_${type}_missed`);
        
        if (onTimeEl || latePointsEl || missedEl) {
            rule.points = {
                onTime: parseInt(onTimeEl?.value) || 0,
                late: parseInt(latePointsEl?.value) || 0,
                missed: parseInt(missedEl?.value) ?? -1
            };
        } else {
            // Form elementi yoksa mevcut deÄŸerleri koru
            rule.points = existingRule.points || baseRule.points || { onTime: 0, late: 0, missed: -1 };
        }
        
        // Responsible shift
        const shiftRadio = document.querySelector(`input[name="checkRule_${type}_shift"]:checked`);
        if (shiftRadio) rule.responsibleShift = shiftRadio.value;
        
        // Branches
        const allBranches = document.getElementById(`checkRule_${type}_branch_all`)?.checked;
        if (allBranches !== undefined) {
            if (allBranches) {
                rule.branches = ['all'];
            } else {
                const checkedBranches = [];
                document.querySelectorAll(`.branch-checkbox-${type}:checked`).forEach(cb => {
                    checkedBranches.push(cb.value);
                });
                rule.branches = checkedBranches.length > 0 ? checkedBranches : ['all'];
            }
        }
        
        checkRules[type] = rule;
    });
    
    // Dashboard mesajlarÄ±
    const dashboardMessages = {
        active: document.getElementById('dashboardMsgActive')?.value || 'YapÄ±lmasÄ± gereken gÃ¶rev var!',
        upcoming: document.getElementById('dashboardMsgUpcoming')?.value || 'Birazdan aktif olacak',
        completed: document.getElementById('dashboardMsgCompleted')?.value || 'TamamlandÄ± âœ“',
        missed: document.getElementById('dashboardMsgMissed')?.value || 'KaÃ§Ä±rÄ±ldÄ±'
    };
    
    try {
        // Firebase'e kaydet
        await db.collection('config').doc('system').set({
            checkRules,
            dashboardMessages,
            // DiÄŸer mevcut ayarlarÄ± koru
            whatsappGroups: SYSTEM_CONFIG.whatsappGroups || {},
            platforms: SYSTEM_CONFIG.platforms || PLATFORMS,
            branchHours: SYSTEM_CONFIG.branchHours || {},
            shiftDuration: SYSTEM_CONFIG.shiftDuration || 9,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        
        // Global deÄŸiÅŸkenleri gÃ¼ncelle
        CHECK_RULES = checkRules;
        SYSTEM_CONFIG.dashboardMessages = dashboardMessages;
        SYSTEM_CONFIG.checkRules = checkRules;
        
        console.log('[saveAdvancedCheckRules] Kaydedildi:', Object.keys(checkRules));
        toast('Check kurallarÄ± kaydedildi! âœ“', 'success');
    } catch (e) {
        console.error('KayÄ±t hatasÄ±:', e);
        toast('KayÄ±t hatasÄ±: ' + e.message, 'error');
    }
}

// Firebase'den check kurallarÄ±nÄ± yÃ¼kle
async function loadCheckRulesFromFirebase() {
    try {
        const doc = await db.collection('config').doc('system').get();
        if (doc.exists && doc.data().checkRules) {
            const firebaseRules = doc.data().checkRules;
            
            // Firebase'den gelen kurallarÄ± mevcut CHECK_RULES ile merge et
            // supervisorPenalty yoksa default'u koru
            Object.keys(firebaseRules).forEach(key => {
                if (CHECK_RULES[key]) {
                    // Mevcut kuralÄ± gÃ¼ncelle ama supervisorPenalty'yi koru
                    const defaultPenalty = CHECK_RULES[key].supervisorPenalty ?? DEFAULT_CHECK_RULES[key]?.supervisorPenalty ?? -0.5;
                    CHECK_RULES[key] = {
                        ...CHECK_RULES[key],
                        ...firebaseRules[key],
                        supervisorPenalty: firebaseRules[key].supervisorPenalty ?? defaultPenalty
                    };
                } else {
                    CHECK_RULES[key] = firebaseRules[key];
                }
            });
            
            // Dashboard mesajlarÄ±nÄ± da yÃ¼kle
            const msgs = doc.data().dashboardMessages || {};
            if (document.getElementById('dashboardMsgActive')) {
                document.getElementById('dashboardMsgActive').value = msgs.active || 'YapÄ±lmasÄ± gereken gÃ¶rev var!';
                document.getElementById('dashboardMsgUpcoming').value = msgs.upcoming || 'Birazdan aktif olacak';
                document.getElementById('dashboardMsgCompleted').value = msgs.completed || 'TamamlandÄ± âœ“';
                document.getElementById('dashboardMsgMissed').value = msgs.missed || 'KaÃ§Ä±rÄ±ldÄ±';
            }
        }
        
        // SeÃ§ili tab'Ä± yeniden render et
        renderCheckRuleDetails(selectedCheckRuleType);
        toast('Kurallar yenilendi', 'success');
    } catch (e) {
        console.error('YÃ¼kleme hatasÄ±:', e);
        toast('YÃ¼kleme hatasÄ±', 'error');
    }
}

// Admin sayfasÄ± aÃ§Ä±ldÄ±ÄŸÄ±nda check kurallarÄ±nÄ± yÃ¼kle
function initCheckRulesUI() {
    const tabsContainer = document.getElementById('checkTypeTabs');
    if (!tabsContainer) return;
    
    // TÃ¼m checklist tÃ¼rlerini topla (unique)
    const allTypes = new Set();
    
    // CHECKLIST_TYPES'dan
    for (const types of Object.values(CHECKLIST_TYPES)) {
        if (Array.isArray(types)) {
            types.forEach(t => allTypes.add(t.id));
        }
    }
    
    // CHECK_RULES'dan
    Object.keys(CHECK_RULES).forEach(id => allTypes.add(id));
    
    // DEFAULT_CHECK_RULES'dan
    if (typeof DEFAULT_CHECK_RULES !== 'undefined') {
        Object.keys(DEFAULT_CHECK_RULES).forEach(id => allTypes.add(id));
    }
    
    // Ä°kon mapping
    const iconMap = {
        gunluk: '<rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>',
        platform: '<rect x="5" y="2" width="14" height="20" rx="2"/><line x1="12" y1="18" x2="12.01" y2="18"/>',
        aylik: '<path d="M3 6l3 1 2-3 2 3 3-1-1 3 3 2-3 2 1 3-3-1-2 3-2-3-3 1 1-3-3-2 3-2-1-3z"/>',
        haftalik: '<rect x="3" y="4" width="18" height="18" rx="2"/><line x1="3" y1="10" x2="21" y2="10"/>',
        mudur: '<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>',
        acilis: '<path d="M17 18a5 5 0 00-10 0"/><line x1="12" y1="2" x2="12" y2="9"/><polyline points="8 6 12 2 16 6"/>',
        kapanis: '<path d="M17 18a5 5 0 00-10 0"/><line x1="12" y1="9" x2="12" y2="2"/><polyline points="16 6 12 10 8 6"/>'
    };
    
    // Ä°sim mapping - CHECKLIST_TYPES'tan dinamik al, yoksa default kullan
    const defaultNames = {
        gunluk: 'GÃ¼nlÃ¼k Check',
        platform: 'Platform',
        aylik: 'Temizlik Ã‡izelgesi',
        haftalik: 'HaftalÄ±k',
        mudur: 'MÃ¼dÃ¼r Kontrol',
        acilis: 'AÃ§Ä±lÄ±ÅŸ',
        kapanis: 'KapanÄ±ÅŸ'
    };
    
    // TÃ¼m ÅŸubelerden isimleri topla (ilk bulunan geÃ§erli)
    const getDynamicName = (typeId) => {
        // Ã–nce tÃ¼m ÅŸubelerde ara
        for (const branch of Object.keys(CHECKLIST_TYPES)) {
            const typeInfo = CHECKLIST_TYPES[branch]?.find(t => canonicalChecklistTypeId(t.id) === canonicalChecklistTypeId(typeId));
            if (typeInfo?.name) return typeInfo.name;
        }
        // CHECK_RULES'ta ara
        if (CHECK_RULES[typeId]?.name) return CHECK_RULES[typeId].name;
        if (DEFAULT_CHECK_RULES[typeId]?.name) return DEFAULT_CHECK_RULES[typeId].name;
        // Default
        return defaultNames[typeId] || typeId;
    };
    
    // SÄ±ralama - temizlik kaldÄ±rÄ±ldÄ±, sadece aylik var
    const orderedTypes = ['gunluk', 'platform', 'acilis', 'kapanis', 'mudur', 'aylik', 'haftalik'];
    
    // temizlik'i listeden Ã§Ä±kar (aylik ile aynÄ±)
    allTypes.delete('temizlik');
    const sortedTypes = [...allTypes].sort((a, b) => {
        const aIdx = orderedTypes.indexOf(a);
        const bIdx = orderedTypes.indexOf(b);
        if (aIdx === -1 && bIdx === -1) return a.localeCompare(b);
        if (aIdx === -1) return 1;
        if (bIdx === -1) return 1;
        return aIdx - bIdx;
    });
    
    // Tab HTML oluÅŸtur
    let html = '';
    sortedTypes.forEach((typeId, idx) => {
        const icon = iconMap[typeId] || '<path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/><path d="M9 14l2 2 4-4"/>';
        const name = getDynamicName(typeId);
        
        html += `
            <button class="check-rule-tab ${idx === 0 ? 'active' : ''}" onclick="selectCheckRuleTab('${typeId}')" data-type="${typeId}">
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">${icon}</svg>
                ${name}
            </button>
        `;
    });
    
    tabsContainer.innerHTML = html;
    
    // Ä°lk tab'Ä± seÃ§
    if (sortedTypes.length > 0) {
        selectCheckRuleTab(sortedTypes[0]);
    }
}

// Eski fonksiyonlar (geriye uyumluluk)
function renderCheckRulesSettings() {
    initCheckRulesUI();
}

async function saveCheckRules() {
    await saveAdvancedCheckRules();
}

// Checklist zamanlama deÄŸiÅŸkenleri
let checklistStartTime = null;
let checklistFirstItemTime = null;
let checklistExpectedDuration = 0; // saniye cinsinden

// Personel-ÅŸube eÅŸleÅŸtirmesi (Firebase'den yÃ¼klenecek)
let personnelMapping = [];

// TÃ¼m config'i Firebase'den yÃ¼kle
// ==================== ADMIN EMAIL KONTROLÃœ ====================
// Config'den dinamik admin listesi - varsayÄ±lan fallback
let _adminEmails = ['admin@moonberrycoffee.com', 'tamer@moonberrycoffee.com'];

async function checkAdminEmail(email) {
    if (!email) return false;
    const emailLower = email.toLowerCase();
    
    // Ã–nce cache'den kontrol (hÄ±zlÄ±)
    if (_adminEmails.includes(emailLower)) return true;
    
    // Firebase'den gÃ¼ncel listeyi Ã§ek
    try {
        const securityDoc = await db.collection('systemConfig').doc('security').get();
        if (securityDoc.exists && securityDoc.data().adminEmails) {
            _adminEmails = securityDoc.data().adminEmails.map(e => e.toLowerCase());
        }
    } catch (e) {
        console.log('Admin email listesi yÃ¼klenemedi, varsayÄ±lan kullanÄ±lÄ±yor');
    }
    
    return _adminEmails.includes(emailLower);
}

// Admin email listesini yÃ¼kle (sadece oku - yazma iÅŸlemi yok)
async function loadAdminEmails() {
    try {
        const securityDoc = await db.collection('systemConfig').doc('security').get();
        if (securityDoc.exists && securityDoc.data().adminEmails) {
            _adminEmails = securityDoc.data().adminEmails.map(e => e.toLowerCase());
            console.log('[Config] Admin emails yÃ¼klendi:', _adminEmails.length);
        } else {
            // DokÃ¼man yok - varsayÄ±lan listeyi kullan (yazma yapmÄ±yoruz)
            console.log('[Config] Admin emails dokÃ¼manÄ± yok, varsayÄ±lan kullanÄ±lÄ±yor');
        }
    } catch (e) {
        console.log('[Config] Admin emails yÃ¼klenemedi, varsayÄ±lan kullanÄ±lÄ±yor');
    }
}

// Admin email ekle/sil (sadece yÃ¶netici Ã§aÄŸÄ±rabilir)
async function saveAdminEmails(emails) {
    try {
        const cleanEmails = emails
            .map(e => e.trim().toLowerCase())
            .filter(e => e && e.includes('@'));
        
        await db.collection('systemConfig').doc('security').set({
            adminEmails: cleanEmails,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        
        _adminEmails = cleanEmails;
        toast('Admin listesi gÃ¼ncellendi âœ“', 'success');
        return true;
    } catch (e) {
        console.error('Admin emails kaydedilemedi:', e);
        toast('Kaydetme hatasÄ±', 'error');
        return false;
    }
}

async function loadSystemConfig() {
    try {
        // Admin emails yÃ¼kle
        await loadAdminEmails();
        
        // ====== POZÄ°SYONLARI FIREBASE'DEN YÃœKLE ======
        try {
            const posDoc = await db.collection('systemConfig').doc('positions').get();
            if (posDoc.exists && posDoc.data().positions) {
                STATE.positions = posDoc.data().positions;
                console.log('[Config] Pozisyonlar Firebase\'den yÃ¼klendi:', STATE.positions.length, 'adet');
            }
        } catch (posErr) {
            console.warn('[Config] Pozisyonlar yÃ¼klenemedi, localStorage kullanÄ±lacak:', posErr.message);
        }
        
        // Sistem ayarlarÄ±
        const sysDoc = await db.collection('config').doc('system').get();
        if (sysDoc.exists) {
            SYSTEM_CONFIG = sysDoc.data();
            WHATSAPP_GROUPS = SYSTEM_CONFIG.whatsappGroups || {};
            PLATFORMS = SYSTEM_CONFIG.platforms || PLATFORMS;
            BRANCH_HOURS = SYSTEM_CONFIG.branchHours || {};
            SHIFT_DURATION = SYSTEM_CONFIG.shiftDuration || 9;
            
            // CHECK_RULES merge - Firebase'den gelen kurallarÄ± mevcut default'larla birleÅŸtir
            // supervisorPenalty gibi yeni alanlar korunur
            if (SYSTEM_CONFIG.checkRules) {
                const firebaseRules = SYSTEM_CONFIG.checkRules;
                Object.keys(firebaseRules).forEach(key => {
                    const defaultRule = CHECK_RULES[key] || DEFAULT_CHECK_RULES[key] || {};
                    CHECK_RULES[key] = {
                        ...defaultRule, // Default'larÄ± koru (supervisorPenalty dahil)
                        ...firebaseRules[key], // Firebase'den gelenleri Ã¼stÃ¼ne yaz
                        // supervisorPenalty: Firebase'de yoksa default'u kullan
                        supervisorPenalty: firebaseRules[key]?.supervisorPenalty ?? defaultRule.supervisorPenalty ?? -0.5
                    };
                });
                console.log('[Config] CHECK_RULES merged with supervisorPenalty');
            }
        }
        
        // ====== CHECK SYSTEM SETTINGS YÃœKLE ======
        try {
            const checkDoc = await db.collection('systemConfig').doc('checkRules').get();
            if (checkDoc.exists) {
                const checkData = checkDoc.data();
                
                // Åžubeleri Firebase'den yÃ¼kle (dinamik)
                if (checkData.branches && Array.isArray(checkData.branches) && checkData.branches.length > 0) {
                    STATE.branches = checkData.branches;
                    console.log('[Config] Åžubeler Firebase\'den yÃ¼klendi:', STATE.branches);
                }
                
                // Platform check saatlerini yÃ¼kle
                if (checkData.platformCheckTimes) {
                    PLATFORM_CHECK_TIMES = checkData.platformCheckTimes;
                    if (CHECK_RULES.platform) {
                        CHECK_RULES.platform.timeSlots = PLATFORM_CHECK_TIMES;
                    }
                }
                
                // Check sistem ayarlarÄ±nÄ± yÃ¼kle ve CHECK_RULES'a uygula
                if (checkData.checkSystemSettings) {
                    const settings = checkData.checkSystemSettings;
                    window.CHECK_SYSTEM_SETTINGS = settings;
                    
                    // PuanlarÄ± CHECK_RULES'a uygula
                    if (settings.points) {
                        // Platform puanlarÄ±
                        if (CHECK_RULES.platform) {
                            CHECK_RULES.platform.points = {
                                onTime: settings.points.platform || 0,
                                late: -(settings.points.platform || 1),
                                missed: -(settings.points.platform || 1)
                            };
                            CHECK_RULES.platform.lateWindow = settings.tolerance || 30;
                            CHECK_RULES.platform.window = {
                                before: settings.tolerance || 30,
                                after: settings.tolerance || 30
                            };
                        }
                        
                        // Temizlik puanlarÄ±
                        if (CHECK_RULES.aylik) {
                            CHECK_RULES.aylik.points = {
                                onTime: settings.points.cleaning || 0,
                                late: -(settings.points.cleaning || 1),
                                missed: -(settings.points.cleaning || 1)
                            };
                        }
                        
                        // AÃ§Ä±lÄ±ÅŸ/KapanÄ±ÅŸ puanlarÄ±
                        if (CHECK_RULES.acilis) {
                            CHECK_RULES.acilis.points = {
                                onTime: settings.points.shift || 1,
                                late: -Math.round((settings.points.shift || 1) * (settings.lateDeductionPercent || 50) / 100),
                                missed: -(settings.points.shift || 2)
                            };
                        }
                        if (CHECK_RULES.kapanis) {
                            CHECK_RULES.kapanis.points = {
                                onTime: settings.points.shift || 1,
                                late: -Math.round((settings.points.shift || 1) * (settings.lateDeductionPercent || 50) / 100),
                                missed: -(settings.points.shift || 2)
                            };
                        }
                    }
                    
                    console.log('[Config] Check sistem ayarlarÄ± yÃ¼klendi:', settings);
                }
                
                // Temizlik shift kurallarÄ±nÄ± yÃ¼kle
                if (checkData.temizlikShiftRules) {
                    TEMIZLIK_SHIFT_RULES = checkData.temizlikShiftRules;
                    if (CHECK_RULES.aylik) {
                        CHECK_RULES.aylik.shiftRules = TEMIZLIK_SHIFT_RULES;
                    }
                }
            }
        } catch (checkErr) {
            console.warn('[Config] Check ayarlarÄ± yÃ¼klenemedi:', checkErr.message);
        }
        
        // Checklist tÃ¼rleri
        const typesDoc = await db.collection('config').doc('checklistTypes').get();
        if (typesDoc.exists) {
            const data = typesDoc.data();
            // updatedAt gibi meta alanlarÄ± filtrele
            CHECKLIST_TYPES = {};
            for (const [key, value] of Object.entries(data)) {
                if (Array.isArray(value)) {
                    CHECKLIST_TYPES[key] = value;
                }
            }
        }
        
        // Temizlik Ã‡izelgesi tipi yoksa ekle (her ÅŸube iÃ§in)
        const branches = STATE.branches || [];
        branches.forEach(branch => {
            if (!CHECKLIST_TYPES[branch]) {
                CHECKLIST_TYPES[branch] = [];
            }
            
            // Temizlik tipi var mÄ± kontrol et
            const hasTemizlik = CHECKLIST_TYPES[branch].some(t => t.id === 'aylik');
            if (!hasTemizlik) {
                CHECKLIST_TYPES[branch].push({
                    id: 'aylik',
                    name: 'Temizlik Ã‡izelgesi',
                    icon: 'calendar',
                    description: 'GÃ¼nlÃ¼k temizlik ve bakÄ±m maddeleri',
                    managerOnly: false
                });
                console.log(`âœ… ${branch} iÃ§in Temizlik Ã‡izelgesi eklendi`);
            }
        });
        
        // Personel eÅŸleÅŸtirmesi
        const persDoc = await db.collection('config').doc('personnel').get();
        if (persDoc.exists) {
            personnelMapping = persDoc.data().list || [];
        }
        
        // === SUPERVISOR PENALTY DEFAULT ENSURE ===
        // Firebase'den yÃ¼klenmiÅŸ CHECK_RULES'da supervisorPenalty yoksa default'larÄ± ekle
        Object.keys(CHECK_RULES).forEach(key => {
            if (CHECK_RULES[key].supervisorPenalty === undefined) {
                CHECK_RULES[key].supervisorPenalty = DEFAULT_CHECK_RULES[key]?.supervisorPenalty ?? -0.5;
            }
        });
        // AyrÄ±ca DEFAULT_CHECK_RULES'da olup CHECK_RULES'da olmayan tÃ¼rler iÃ§in de ekle
        Object.keys(DEFAULT_CHECK_RULES).forEach(key => {
            if (!CHECK_RULES[key]) {
                CHECK_RULES[key] = { ...DEFAULT_CHECK_RULES[key] };
            }
        });
        
        console.log('Sistem config yÃ¼klendi:', {
            branches: Object.keys(CHECKLIST_TYPES),
            personnel: personnelMapping.length,
            branchHours: BRANCH_HOURS,
            checkRules: CHECK_RULES
        });
    } catch (e) {
        console.warn('Config yÃ¼klenemedi:', e);
        
        // Fallback - default checklist tÃ¼rleri
        const branches = STATE.branches || [];
        branches.forEach(branch => {
            if (!CHECKLIST_TYPES[branch]) {
                CHECKLIST_TYPES[branch] = [
                    { id: 'aylik', name: 'Temizlik Ã‡izelgesi', icon: 'calendar', description: 'GÃ¼nlÃ¼k temizlik ve bakÄ±m' }
                ];
            }
        });
    }
}

// Personel eÅŸleÅŸtirmesini Firebase'den yÃ¼kle (eski uyumluluk iÃ§in)
async function loadPersonnelMapping() {
    if (personnelMapping.length === 0) {
        await loadSystemConfig();
    }
}

// KullanÄ±cÄ±nÄ±n ÅŸubesini email'den al
function getUserBranchFromEmail(email) {
    const match = personnelMapping.find(p => p.email?.toLowerCase() === email?.toLowerCase());
    return match ? match.branch : null;
}

// KullanÄ±cÄ±nÄ±n adÄ±nÄ± email'den al
function getUserNameFromEmail(email) {
    const match = personnelMapping.find(p => p.email?.toLowerCase() === email?.toLowerCase());
    return match ? match.name : null;
}

// Checklist sayfasÄ± baÅŸlat
async function initChecklistPage() {
    console.log('[Checklist Init] BaÅŸlatÄ±lÄ±yor...');
    
    // Element kontrolÃ¼ (erken)
    const subeSelect = document.getElementById('checklistSube');
    if (!subeSelect) {
        console.error('[Checklist Init] subeSelect element bulunamadÄ±!');
        return;
    }
    
    // IMMEDIATE FILL - loadSystemConfig beklemeden dropdown'u doldur
    // STATE.branches DOMContentLoaded'da loadState() ile zaten dolu olmalÄ±
    let immediateBranches = STATE.branches || DEFAULT_STATE.branches || [];
    if (immediateBranches.length === 0) {
        immediateBranches = DEFAULT_STATE.branches || [];
    }
    
    if (subeSelect.options.length === 0 && immediateBranches.length > 0) {
        subeSelect.innerHTML = immediateBranches.map(b => `<option value="${b}">${b}</option>`).join('');
        // KullanÄ±cÄ±nÄ±n ÅŸubesini seÃ§ (dinamik)
        const userBranchImm = currentUser?.branch;
        if (userBranchImm && userBranchImm !== 'all') {
            const userOpt = Array.from(subeSelect.options).find(o => o.value === userBranchImm);
            if (userOpt) subeSelect.value = userOpt.value;
        }
        console.log('[Checklist Init] Immediate fill OK:', immediateBranches.length, 'ÅŸube, seÃ§ili:', subeSelect.value);
    }
    
    // Config'i timeout ile yÃ¼kle (5 saniye max)
    try {
        await Promise.race([
            loadSystemConfig(),
            new Promise((_, reject) => setTimeout(() => reject(new Error('Config timeout 5s')), 5000))
        ]);
    } catch (e) {
        console.warn('[Checklist Init] Config timeout/hata:', e.message);
    }
    
    // Config sonrasÄ± - Åžube dropdown'Ä± gÃ¼ncelle
    
    const userEmail = currentUser?.email;
    const emailBranch = getUserBranchFromEmail(userEmail);
    const userBranch = emailBranch || currentUser?.branch;
    const isAdmin = currentUser?.role === 'yonetici' || currentUser?.role === 'bolge_muduru';
    
    let branches = STATE.branches || [];
    
    // GÃ¼vence: branches hala boÅŸsa DEFAULT_STATE'den al
    if (branches.length === 0) {
        branches = DEFAULT_STATE.branches || [];
        console.warn('[Checklist Init] STATE.branches boÅŸ, fallback kullanÄ±ldÄ±');
    }
    
    // MaÄŸaza mÃ¼dÃ¼rÃ¼/barista sadece kendi ÅŸubesini gÃ¶rsÃ¼n ve deÄŸiÅŸtiremesin
    if (!isAdmin && userBranch && userBranch !== 'all') {
        branches = branches.filter(b => b === userBranch);
        subeSelect.disabled = true;
        subeSelect.style.opacity = '0.7';
        subeSelect.title = 'Åžubeniz otomatik seÃ§ilmiÅŸtir';
    } else {
        subeSelect.disabled = false;
        subeSelect.style.opacity = '1';
    }
    
    subeSelect.innerHTML = branches.map(b => `<option value="${b}">${b}</option>`).join('');
    
    // KullanÄ±cÄ±nÄ±n ÅŸubesini seÃ§
    if (userBranch && userBranch !== 'all') {
        const userOption = Array.from(subeSelect.options).find(o => o.value === userBranch);
        if (userOption) subeSelect.value = userOption.value;
    }
    // Admin iÃ§in ilk ÅŸube seÃ§ili kalsÄ±n (liste sÄ±rasÄ±na gÃ¶re)
    
    // Tarih bugÃ¼n
    document.getElementById('checklistDate').value = new Date().toISOString().split('T')[0];
    
    // Dashboard'dan parametre ile geldiyse
    if (_pendingChecklistParams) {
        const { branch, type, timeSlot } = _pendingChecklistParams;
        _pendingChecklistParams = null; // Temizle
        console.log('[Checklist Init] Dashboard parametreleri:', { branch, type, timeSlot });
        
        // Åžubeyi seÃ§
        if (branch && subeSelect) {
            const branchOption = Array.from(subeSelect.options).find(o => o.value === branch);
            if (branchOption) subeSelect.value = branch;
        }
        
        // Checklist tÃ¼rlerini yÃ¼kle ve doÄŸru tipi seÃ§
        await loadChecklistTypes();
        
        // timeSlot'u Ã–NCE ayarla (loadChecklist'in autoTimeSlot hesaplamasÄ±nÄ± override etmek iÃ§in)
        if (timeSlot) {
            const timeSlotSelect = document.getElementById('checklistTimeSlot');
            if (timeSlotSelect) {
                timeSlotSelect.value = timeSlot;
                console.log('[Checklist Init] TimeSlot ayarlandÄ±:', timeSlot);
            }
        }
        
        // KÄ±sa bir gecikme ile checklist tÃ¼rÃ¼nÃ¼ seÃ§
        setTimeout(() => {
            if (type) {
                // selectChecklistType sadece typeId alÄ±yor!
                selectChecklistType(type);
                console.log('[Checklist Init] TÃ¼r seÃ§ildi:', type);
                
                // loadChecklist yeniden Ã§aÄŸÄ±rÄ±lÄ±yor ama autoTimeSlot override edilmeli
                // Bu yÃ¼zden timeSlot'u tekrar set et
                if (timeSlot) {
                    const timeSlotSelect = document.getElementById('checklistTimeSlot');
                    if (timeSlotSelect && timeSlotSelect.value !== timeSlot) {
                        timeSlotSelect.value = timeSlot;
                        loadChecklist();
                    }
                }
            }
        }, 150);
        
        // Real-time listener baÅŸlat
        setupShiftListener(branch);
        
        return; // Early return
    }
    
    // Checklist tÃ¼rlerini yÃ¼kle
    loadChecklistTypes();
    
    // Real-time listener baÅŸlat (seÃ§ili ÅŸube iÃ§in)
    const selectedBranch = document.getElementById('checklistSube')?.value;
    if (selectedBranch) {
        setupShiftListener(selectedBranch);
    }
}

// Checklist sayfasÄ± - BugÃ¼nkÃ¼ checkler paneli
async function loadChecklistTodayPanel() {
    const panel = document.getElementById('checklistTodayPanel');
    const container = document.getElementById('checklistTodayContainer');
    if (!panel || !container) return;
    
    const today = new Date();
    const todayStr = formatDateLocal(today);  // Timezone-safe
    const isAdmin = ['yonetici', 'bolge_muduru'].includes(currentUser?.role);
    
    // Åžubeleri belirle
    let branches = [];
    if (isAdmin || currentUser?.branch === 'all') {
        branches = STATE.branches || [];
    } else {
        branches = [currentUser?.branch || STATE.branches?.[0] || 'Tuzla TRC'];
    }
    
    // Bu haftanÄ±n tarih aralÄ±ÄŸÄ±nÄ± hesapla
    const weekStart = getWeekStart(today);
    const weekKey = formatDateLocal(weekStart);
    let dayIndex = today.getDay() - 1;
    if (dayIndex < 0) dayIndex = 6;
    
    // Shift verilerini yÃ¼kle - SADECE BU HAFTANIN SHÄ°FT'Ä°
    const shiftData = {};
    
    // Ã–nce personel koleksiyonunu yÃ¼kle (tam isim + ROL eÅŸleÅŸtirme iÃ§in)
    const personelMap = {};
    const personelRoleMap = {}; // uniqueId/displayName â†’ role
    const personelDataMap = {}; // uniqueId â†’ full data
    try {
        const pSnap = await db.collection('personel').get();
        pSnap.forEach(doc => {
            const p = doc.data();
            const firstName = p.name?.split(' ')[0] || '';
            const lastName = p.name?.split(' ').slice(1).join(' ') || '';
            const lastInitial = lastName.charAt(0);
            const displayName = p.codeName || `${firstName} ${lastInitial}.`;
            
            // Full data kaydet
            personelDataMap[p.uniqueId] = { ...p, displayName };
            
            // TÃ¼m olasÄ± key formatlarÄ±nÄ± oluÅŸtur
            const keys = [
                p.uniqueId,
                p.codeName,
                p.name,
                normalizePersonelId(p.name),
                `${firstName} ${lastInitial}.`,
                `${firstName.charAt(0).toUpperCase() + firstName.slice(1).toLowerCase()} ${lastInitial.toUpperCase()}.`,
                firstName,
                firstName?.toLowerCase(),
                firstName?.toUpperCase(),
                displayName,
            ].filter(k => k);
            
            keys.forEach(k => {
                personelMap[k] = p.name;
                personelRoleMap[k] = p.role || 'barista';
                if (k?.toLowerCase) {
                    personelMap[k.toLowerCase()] = p.name;
                    personelRoleMap[k.toLowerCase()] = p.role || 'barista';
                }
            });
        });
    } catch (e) {
        console.warn('Personel map yÃ¼klenemedi:', e);
    }
    
    try {
        for (const branch of branches) {
            try {
                // Sadece branch ile sorgula
                const shiftsSnapshot = await db.collection('shifts')
                    .where('branch', '==', branch)
                    .get();
                
                // JavaScript'te sÄ±rala
                const allShifts = [];
                shiftsSnapshot.forEach(doc => allShifts.push(doc.data()));
                allShifts.sort((a, b) => (b.weekStart || '').localeCompare(a.weekStart || ''));
                
                // SADECE bu haftanÄ±n shift'ini kullan - yoksa boÅŸ bÄ±rak
                const targetShift = allShifts.find(s => s.weekStart === weekKey);
                
                if (targetShift) {
                    const personelShifts = targetShift.personelShifts || {};
                    const personelNames = targetShift.personelNames || {};       // codeName (DOÄžRU FORMAT)
                    const personelFullNames = targetShift.personelFullNames || {};
                    const acilisPersonel = [], kapanisPersonel = [], araPersonel = [];
                    
                    for (const [uniqueIdOrName, days] of Object.entries(personelShifts)) {
                        const todayShift = days[dayIndex] || '';
                        const cleanShift = todayShift.replace(/\*/g, '').trim().toUpperCase();
                        
                        // OFF veya Ä°ZÄ°NLÄ° olanlarÄ± atla
                        if (cleanShift === 'OFF' || cleanShift === 'Ä°' || cleanShift === '-' || cleanShift === 'X' || cleanShift === 'Y.Ä°') continue;
                        
                        // Ã–NCE personelNames (codeName) KULLAN - en doÄŸru format
                        const displayName = personelNames[uniqueIdOrName] 
                            || formatDisplayName(personelFullNames[uniqueIdOrName] || uniqueIdOrName.replace(/_/g, ' '));
                        
                        // Rol bilgisini al
                        const role = personelRoleMap[uniqueIdOrName] || personelRoleMap[displayName] || 'barista';
                        
                        // Personel objesi oluÅŸtur (isim + rol)
                        const personObj = { name: displayName, uniqueId: uniqueIdOrName, role: role };
                        
                        if (cleanShift === 'A' || cleanShift === 'AÃ‡ILIÅž' || cleanShift.includes('AÃ‡ILI')) acilisPersonel.push(personObj);
                        else if (cleanShift === 'K' || cleanShift === 'KAPANIÅž' || cleanShift.includes('KAPANI')) kapanisPersonel.push(personObj);
                        else if (cleanShift && cleanShift !== 'Ä°' && cleanShift !== 'OFF' && cleanShift !== '-' && cleanShift !== 'X') araPersonel.push(personObj);
                    }
                    
                    shiftData[branch] = { acilis: acilisPersonel, kapanis: kapanisPersonel, ara: araPersonel };
                    console.log(`âœ… ${branch} bu haftanÄ±n shift'i bulundu:`, weekKey);
                } else {
                    console.log(`âš ï¸ ${branch} iÃ§in bu haftanÄ±n shift'i (${weekKey}) bulunamadÄ±`);
                    shiftData[branch] = { acilis: [], kapanis: [], ara: [] };
                }
            } catch (e) {
                console.error(`${branch} shift yÃ¼kleme hatasÄ±:`, e);
            }
        }
    } catch (e) {
        console.error('Shift yÃ¼kleme hatasÄ±:', e);
    }
    
    function getShiftPersonnel(branch, shiftType) {
        const data = shiftData[branch];
        if (!data) return [];
        return data[shiftType] || [];
    }
    
    // ROL BAZLI FÄ°LTRELEME - Dashboard kartlarÄ± iÃ§in
    // checkType: 'mudur' â†’ sadece mÃ¼dÃ¼r/yardÄ±mcÄ±
    // checkType: diÄŸerleri â†’ Ã¶nce baristalar, yoksa mÃ¼dÃ¼r
    function filterPersonnelForCheck(personnelList, checkType) {
        if (!personnelList || personnelList.length === 0) return [];
        
        // MÃ¼dÃ¼r Kontrol: sadece mÃ¼dÃ¼r veya yardÄ±mcÄ±
        if (checkType === 'mudur') {
            const managers = personnelList.filter(p => 
                p.role === 'magaza_muduru' || 
                p.role === 'mudur_yardimcisi' || 
                p.role === 'magaza_mudur_yardimcisi'
            );
            // Ã–nce mÃ¼dÃ¼r, sonra yardÄ±mcÄ±
            const mudur = managers.find(p => p.role === 'magaza_muduru');
            if (mudur) return [mudur];
            const yardimci = managers.find(p => p.role === 'mudur_yardimcisi' || p.role === 'magaza_mudur_yardimcisi');
            if (yardimci) return [yardimci];
            // HiÃ§ mÃ¼dÃ¼r yoksa bÃ¶lge mÃ¼dÃ¼rÃ¼
            const bolge = personnelList.find(p => p.role === 'bolge_muduru');
            if (bolge) return [bolge];
            return [];
        }
        
        // DiÄŸer checkler: Barista Ã¶ncelikli
        const baristalar = personnelList.filter(p => 
            p.role !== 'magaza_muduru' && 
            p.role !== 'mudur_yardimcisi' && 
            p.role !== 'magaza_mudur_yardimcisi' &&
            p.role !== 'bolge_muduru'
        );
        
        // Barista varsa sadece onlarÄ± gÃ¶ster
        if (baristalar.length > 0) {
            // MÃ¼dÃ¼r yardÄ±mcÄ±sÄ±nÄ± da ekle (barista gibi Ã§alÄ±ÅŸÄ±r)
            const yardimcilar = personnelList.filter(p => 
                p.role === 'mudur_yardimcisi' || p.role === 'magaza_mudur_yardimcisi'
            );
            return [...baristalar, ...yardimcilar];
        }
        
        // Barista yoksa mÃ¼dÃ¼r yardÄ±mcÄ±sÄ±
        const yardimci = personnelList.find(p => 
            p.role === 'mudur_yardimcisi' || p.role === 'magaza_mudur_yardimcisi'
        );
        if (yardimci) return [yardimci];
        
        // O da yoksa maÄŸaza mÃ¼dÃ¼rÃ¼
        const mudur = personnelList.find(p => p.role === 'magaza_muduru');
        if (mudur) return [mudur];
        
        // En son bÃ¶lge mÃ¼dÃ¼rÃ¼ (puan almaz ama gÃ¶sterilir)
        const bolge = personnelList.find(p => p.role === 'bolge_muduru');
        if (bolge) return [bolge];
        
        return [];
    }
    
    // Personel listesinden sadece isimleri al (eski uyumluluk iÃ§in)
    function getPersonnelNames(personnelList) {
        if (!personnelList || personnelList.length === 0) return [];
        return personnelList.map(p => typeof p === 'string' ? p : p.name);
    }
    
    let html = '';
    let hasActiveChecks = false;
    
    for (const branch of branches) {
        const checkTypes = CHECKLIST_TYPES[branch] || [];
        if (checkTypes.length === 0) continue;
        
        const isMoonberry = true; // TÃ¼m ÅŸubeler Moonberry teal rengi
        const brandColor = isMoonberry ? '#008c95' : '#ff8674';
        
        for (const checkType of checkTypes) {
            // Saat bazlÄ± checkler (GÃ¼nlÃ¼k)
            if (checkType.timeSlots && checkType.timeSlots.length > 0) {
                for (const timeSlot of checkType.timeSlots) {
                    const rules = CHECK_RULES[checkType.id];
                    if (!rules) continue;
                    
                    const window = getCheckTimeWindow(checkType.id, timeSlot, branch);
                    if (!window) continue;
                    if (!isAdmin && (window.isMissed || window.isBeforeWindow)) continue;
                    
                    const submissionId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_${checkType.id}_${todayStr}_${timeSlot.replace(':', '')}`;
                    let isCompleted = false;
                    
                    try {
                        const doc = await db.collection('checklistSubmissions').doc(submissionId).get();
                        isCompleted = doc.exists;
                    } catch (e) {}
                    
                    const remaining = getRemainingTime(checkType.id, timeSlot, branch);
                    const checkHour = parseInt(timeSlot.split(':')[0]);
                    let responsiblePersonnel = checkHour < 15 ? getShiftPersonnel(branch, 'acilis') : 
                                              checkHour >= 20 ? getShiftPersonnel(branch, 'kapanis') :
                                              [...getShiftPersonnel(branch, 'acilis'), ...getShiftPersonnel(branch, 'ara')];
                    
                    hasActiveChecks = true;
                    
                    // Minimalist tasarÄ±m - marka renkleri
                    const brandBg = isMoonberry ? 'rgba(0,140,149,.06)' : 'rgba(255,134,116,.06)';
                    let bgColor = 'var(--bg3)', accentColor = 'var(--tx3)', icon = 'â—‹', statusText = '';
                    let isActive = false;
                    
                    if (isCompleted) { bgColor = 'rgba(39,174,96,.05)'; accentColor = '#27ae60'; icon = 'â—'; statusText = 'Tamam'; }
                    else if (window.isMissed) { bgColor = brandBg; accentColor = brandColor; icon = 'â—‹'; statusText = 'YapÄ±lmadÄ±'; }
                    else if (window.isLate) { bgColor = 'rgba(243,156,18,.05)'; accentColor = '#f39c12'; icon = 'â—'; statusText = 'GeÃ§'; isActive = true; }
                    else if (window.isInWindow) { bgColor = brandBg; accentColor = brandColor; icon = 'â—'; statusText = 'Aktif'; isActive = true; }
                    
                    const personnelText = responsiblePersonnel.length > 0 ? `â€¢ ${lookupPersonelDisplay(responsiblePersonnel[0])}` : '';
                    const branchLabel = isMoonberry ? 'M' : 'S';
                    
                    html += `
                        <div style="background:${bgColor};border-left:3px solid ${accentColor};border-radius:6px;padding:6px 10px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;margin-bottom:4px" onclick="selectCheckFromPanel('${branch}', '${checkType.id}', '${timeSlot}')">
                            <div style="display:flex;align-items:center;gap:6px">
                                <span style="color:${accentColor};font-size:.8rem">${icon}</span>
                                <span style="width:18px;height:18px;background:${brandColor};border-radius:4px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:.6rem;font-weight:600">${branchLabel}</span>
                                <span style="font-weight:500;font-size:.8rem;color:var(--tx)">${checkType.name} - ${timeSlot}</span>
                                <span style="font-size:.7rem;color:var(--tx3)">${personnelText}</span>
                            </div>
                            <span style="font-size:.7rem;font-weight:500;color:${accentColor}">${statusText}</span>
                        </div>
                    `;
                }
            }
            
            // Platform Check (timeSlots yok)
            if (checkType.id === 'platform') {
                const submissionId = `platform_${todayStr}`;
                let isCompleted = false;
                try {
                    const doc = await db.collection('checklistSubmissions').doc(submissionId).get();
                    isCompleted = doc.exists;
                } catch (e) {}
                
                const responsiblePersonnel = [...getShiftPersonnel(branch, 'acilis'), ...getShiftPersonnel(branch, 'ara'), ...getShiftPersonnel(branch, 'kapanis')].filter((v, i, a) => a.indexOf(v) === i);
                const personnelText = responsiblePersonnel.length > 0 ? `â€¢ ${lookupPersonelDisplay(responsiblePersonnel[0])}` : '';
                const branchLabel = isMoonberry ? 'M' : 'S';
                
                hasActiveChecks = true;
                const bgColor = isCompleted ? 'rgba(39,174,96,.05)' : (isMoonberry ? 'rgba(0,140,149,.06)' : 'rgba(255,134,116,.06)');
                const accentColor = isCompleted ? '#27ae60' : brandColor;
                const icon = isCompleted ? 'â—' : 'â—';
                const statusText = isCompleted ? 'Tamam' : 'Aktif';
                
                html += `
                    <div style="background:${bgColor};border-left:3px solid ${accentColor};border-radius:6px;padding:6px 10px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;margin-bottom:4px" onclick="selectCheckFromPanel('${branch}', 'platform', '')">
                        <div style="display:flex;align-items:center;gap:6px">
                            <span style="font-size:.8rem">ðŸ“±</span>
                            <span style="width:18px;height:18px;background:${brandColor};border-radius:4px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:.6rem;font-weight:600">${branchLabel}</span>
                            <span style="font-weight:500;font-size:.8rem;color:var(--tx)">Platform Check</span>
                            <span style="font-size:.7rem;color:var(--tx3)">${personnelText}</span>
                        </div>
                        <span style="font-size:.7rem;font-weight:500;color:${accentColor}">${statusText}</span>
                    </div>
                `;
            }
            
            // AÃ§Ä±lÄ±ÅŸ Check
            if (checkType.id === 'acilis') {
                const now = new Date();
                const currentMinutes = now.getHours() * 60 + now.getMinutes();
                const deadlineMinutes = 11 * 60; // 11:00
                if (currentMinutes <= deadlineMinutes || isAdmin) {
                    const submissionId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_acilis_${todayStr}`;
                    let isCompleted = false;
                    try {
                        const doc = await db.collection('checklistSubmissions').doc(submissionId).get();
                        isCompleted = doc.exists;
                    } catch (e) {}
                    
                    const isMissed = currentMinutes > deadlineMinutes && !isCompleted;
                    const responsiblePersonnel = getShiftPersonnel(branch, 'acilis');
                    const personnelText = responsiblePersonnel.length > 0 ? `â€¢ ${lookupPersonelDisplay(responsiblePersonnel[0])}` : '';
                    const branchLabel = isMoonberry ? 'M' : 'S';
                    
                    hasActiveChecks = true;
                    const bgColor = isCompleted ? 'rgba(39,174,96,.05)' : isMissed ? 'var(--bg3)' : (isMoonberry ? 'rgba(0,140,149,.06)' : 'rgba(255,134,116,.06)');
                    const accentColor = isCompleted ? '#27ae60' : isMissed ? '#9ca3af' : brandColor;
                    const icon = isCompleted ? 'â—' : isMissed ? 'â—‹' : 'â—';
                    const statusText = isCompleted ? 'Tamam' : isMissed ? 'YapÄ±lmadÄ±' : 'Aktif';
                    
                    html += `
                        <div style="background:${bgColor};border-left:3px solid ${accentColor};border-radius:6px;padding:6px 10px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;margin-bottom:4px;opacity:${isMissed ? '0.6' : '1'}" onclick="selectCheckFromPanel('${branch}', 'acilis', '')">
                            <div style="display:flex;align-items:center;gap:6px">
                                <span style="font-size:.8rem">ðŸŒ…</span>
                                <span style="width:18px;height:18px;background:${brandColor};border-radius:4px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:.6rem;font-weight:600">${branchLabel}</span>
                                <span style="font-weight:500;font-size:.8rem;color:var(--tx)">AÃ§Ä±lÄ±ÅŸ</span>
                                <span style="font-size:.7rem;color:var(--tx3)">${personnelText}</span>
                            </div>
                            <span style="font-size:.7rem;font-weight:500;color:${accentColor}">${statusText}</span>
                        </div>
                    `;
                }
            }
            
            // KapanÄ±ÅŸ Check
            if (checkType.id === 'kapanis') {
                const now = new Date();
                const currentHour = now.getHours();
                if (currentHour >= 18 || isAdmin) {
                    const submissionId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_kapanis_${todayStr}`;
                    let isCompleted = false;
                    try {
                        const doc = await db.collection('checklistSubmissions').doc(submissionId).get();
                        isCompleted = doc.exists;
                    } catch (e) {}
                    
                    const responsiblePersonnel = getShiftPersonnel(branch, 'kapanis');
                    const personnelText = responsiblePersonnel.length > 0 ? `â€¢ ${lookupPersonelDisplay(responsiblePersonnel[0])}` : '';
                    const branchLabel = isMoonberry ? 'M' : 'S';
                    
                    hasActiveChecks = true;
                    const bgColor = isCompleted ? 'rgba(39,174,96,.05)' : (isMoonberry ? 'rgba(0,140,149,.06)' : 'rgba(255,134,116,.06)');
                    const accentColor = isCompleted ? '#27ae60' : brandColor;
                    const icon = isCompleted ? 'â—' : 'â—';
                    const statusText = isCompleted ? 'Tamam' : 'Aktif';
                    
                    html += `
                        <div style="background:${bgColor};border-left:3px solid ${accentColor};border-radius:6px;padding:6px 10px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;margin-bottom:4px" onclick="selectCheckFromPanel('${branch}', 'kapanis', '')">
                            <div style="display:flex;align-items:center;gap:6px">
                                <span style="font-size:.8rem">ðŸŒ‡</span>
                                <span style="width:18px;height:18px;background:${brandColor};border-radius:4px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:.6rem;font-weight:600">${branchLabel}</span>
                                <span style="font-weight:500;font-size:.8rem;color:var(--tx)">KapanÄ±ÅŸ</span>
                                <span style="font-size:.7rem;color:var(--tx3)">${personnelText}</span>
                            </div>
                            <span style="font-size:.7rem;font-weight:500;color:${accentColor}">${statusText}</span>
                        </div>
                    `;
                }
            }
        }
    }
    
    if (hasActiveChecks) {
        panel.style.display = 'block';
        container.innerHTML = html;
    } else {
        panel.style.display = 'none';
    }
}

// Panelden check seÃ§me
function selectCheckFromPanel(branch, type, timeSlot) {
    const subeSelect = document.getElementById('checklistSube');
    const typeSelect = document.getElementById('checklistType');
    const timeSlotSelect = document.getElementById('checklistTimeSlot');
    
    if (subeSelect) subeSelect.value = branch;
    loadChecklistTypes().then(() => {
        if (typeSelect) {
            typeSelect.value = type;
            // Buton aktifliÄŸini gÃ¼ncelle
            document.querySelectorAll('.checklist-type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });
            loadChecklist().then(() => {
                if (timeSlotSelect && timeSlot) {
                    timeSlotSelect.value = timeSlot;
                    loadChecklist();
                }
            });
        }
    });
}

// Checklist tÃ¼rlerini yÃ¼kle
async function loadChecklistTypes() {
    const branch = document.getElementById('checklistSube')?.value;
    const typeSelect = document.getElementById('checklistType');
    const buttonsContainer = document.getElementById('checklistTypeButtons');
    if (!typeSelect || !branch) return;
    
    // Åžube deÄŸiÅŸti - real-time listener'Ä± gÃ¼ncelle
    setupShiftListener(branch);
    
    // Config yÃ¼klenmemiÅŸse yÃ¼kle
    if (Object.keys(CHECKLIST_TYPES).length === 0) {
        await loadSystemConfig();
    }
    
    const types = CHECKLIST_TYPES[branch] || [];
    const isManager = currentUser?.role === 'yonetici' || currentUser?.role === 'magaza_muduru' || currentUser?.role === 'bolge_muduru';
    
    // Debug log
    console.log('Checklist tÃ¼rleri:', branch, types.length, 'adet');
    
    // Duplicate Ã¶nleme iÃ§in seen set
    const seenIds = new Set();
    
    // Hidden select gÃ¼ncelle
    let selectHtml = '<option value="">-- Checklist SeÃ§in --</option>';
    types.forEach(t => {
        if (t.managerOnly && !isManager) return;
        const canonId = canonicalChecklistTypeId(t.id);
        if (seenIds.has(canonId)) return; // Duplicate atla
        seenIds.add(canonId);
        selectHtml += `<option value="${canonId}" data-timeslots="${t.timeSlots ? t.timeSlots.join(',') : ''}">${t.name}</option>`;
    });
    typeSelect.innerHTML = selectHtml;
    
    // Butonlar iÃ§in tekrar reset
    seenIds.clear();
    
    // ButonlarÄ± oluÅŸtur - Modern SVG ikonlar
    let buttonsHtml = '';
    types.forEach(t => {
        if (t.managerOnly && !isManager) return;
        const canonId = canonicalChecklistTypeId(t.id);
        if (seenIds.has(canonId)) return; // Duplicate atla
        seenIds.add(canonId);
        const iconSvg = getIcon(t.icon || 'clipboard-check');
        buttonsHtml += `
            <button type="button" class="checklist-type-btn" data-type="${canonId}" data-timeslots="${t.timeSlots ? t.timeSlots.join(',') : ''}"
                onclick="selectChecklistType('${canonId}')"
                style="padding:12px 18px;border:1px solid var(--cardBorder);background:var(--bg2);color:var(--tx);border-radius:10px;cursor:pointer;font-size:.9rem;font-weight:500;transition:all .2s;display:flex;align-items:center;gap:10px">
                <span style="opacity:.7">${iconSvg}</span>
                ${t.name}
            </button>
        `;
    });
    
    if (!buttonsHtml) {
        buttonsHtml = '<div style="color:var(--tx3);font-size:.9rem;padding:10px">Bu ÅŸube iÃ§in checklist bulunamadÄ±. LÃ¼tfen seed.html ile verileri yÃ¼kleyin.</div>';
    }
    buttonsContainer.innerHTML = buttonsHtml;
    
    // Formu temizle
    document.getElementById('checklistFormContainer').innerHTML = `
        <div style="text-align:center;padding:60px;color:var(--tx2)">
            <svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" style="opacity:.4;margin-bottom:16px">
                <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/>
                <rect x="9" y="3" width="6" height="4" rx="1"/>
                <path d="M9 14l2 2 4-4"/>
            </svg>
            <div style="font-size:1.1rem;margin-bottom:8px">Checklist SeÃ§in</div>
            <div style="font-size:.85rem;opacity:.6">YukarÄ±dan checklist tÃ¼rÃ¼ seÃ§erek baÅŸlayÄ±n</div>
        </div>
    `;
}

// Checklist tÃ¼rÃ¼ seÃ§ (buton)
function selectChecklistType(typeId) {
    // Canonical type id kullan
    typeId = canonicalChecklistTypeId(typeId);
    
    const typeSelect = document.getElementById('checklistType');
    typeSelect.value = typeId;
    
    // Buton stillerini gÃ¼ncelle - canonical id ile karÅŸÄ±laÅŸtÄ±r
    document.querySelectorAll('.checklist-type-btn').forEach(btn => {
        const btnType = canonicalChecklistTypeId(btn.dataset.type);
        if (btnType === typeId) {
            btn.style.background = 'linear-gradient(135deg, var(--accent), #ff6b5b)';
            btn.style.color = '#fff';
            btn.style.borderColor = 'var(--accent)';
            btn.style.boxShadow = '0 4px 12px rgba(255,134,116,.3)';
        } else {
            btn.style.background = 'var(--bg2)';
            btn.style.color = 'var(--tx)';
            btn.style.borderColor = 'var(--cardBorder)';
            btn.style.boxShadow = 'none';
        }
    });
    
    // Time slot gÃ¼ncelle
    const selectedBtn = document.querySelector(`.checklist-type-btn[data-type="${typeId}"]`);
    const timeSlots = selectedBtn?.dataset.timeslots?.split(',').filter(Boolean) || [];
    const timeSlotGroup = document.getElementById('checklistTimeSlotGroup');
    const timeSlotSelect = document.getElementById('checklistTimeSlot');
    
    if (timeSlots.length > 0) {
        timeSlotGroup.style.display = 'block';
        let tsHtml = '<option value="">-- SeÃ§in --</option>';
        timeSlots.forEach(ts => { tsHtml += `<option value="${ts}">${ts}</option>`; });
        timeSlotSelect.innerHTML = tsHtml;
    } else {
        timeSlotGroup.style.display = 'none';
        timeSlotSelect.innerHTML = '<option value="">-- SeÃ§in --</option>';
    }
    
    loadChecklist();
}

// Checklist yÃ¼kle
let checklistLoadingLock = false;
// ==================== G16: SHIFT KONTROLÃœ ====================
// KullanÄ±cÄ±nÄ±n belirtilen tarih ve ÅŸubede shift'i var mÄ± kontrol eder
async function checkCurrentUserShift(branch, date) {
    if (!currentUser?.name) return { hasShift: false, shiftType: null };
    
    const isManager = ['yonetici', 'bolge_muduru', 'magaza_muduru', 'magaza_mudur_yardimcisi'].includes(currentUser?.role);
    
    // YÃ¶neticiler her zaman eriÅŸebilir
    if (isManager) {
        return { hasShift: true, shiftType: 'manager', isManager: true };
    }
    
    try {
        const weekKey = getWeekKey(new Date(date));
        
        // DÃœZELTME: ID ile deÄŸil, query ile shift bul
        const shiftSnap = await db.collection('shifts')
            .where('branch', '==', branch)
            .where('weekStart', '==', weekKey)
            .limit(1)
            .get();
        
        if (shiftSnap.empty) {
            return { hasShift: false, shiftType: null, reason: 'no_shift_doc' };
        }
        
        const shiftData = shiftSnap.docs[0].data();
        // GÃœN Ä°NDEKSÄ°: Excel formatÄ± - 0=Pazartesi, 6=Pazar
        let dayIndex = new Date(date).getDay() - 1;
        if (dayIndex < 0) dayIndex = 6; // Pazar iÃ§in
        const dayIndexStr = String(dayIndex);
        
        const userName = currentUser.name.toLowerCase().trim();
        
        // DÃœZELTME: personelShifts + personelFullNames kullan
        const personelShifts = shiftData.personelShifts || {};
        const personelFullNames = shiftData.personelFullNames || {};
        const personelOrder = shiftData.personelOrder || Object.keys(personelShifts);
        
        for (const personId of personelOrder) {
            const fullName = personelFullNames[personId] || personId;
            const personName = fullName.toLowerCase().trim();
            
            if (personName === userName || personName.includes(userName) || userName.includes(personName)) {
                const shifts = personelShifts[personId] || {};
                const dayShift = shifts[dayIndexStr];
                
                if (dayShift && 
                    dayShift.toUpperCase() !== 'OFF' && 
                    !dayShift.toUpperCase().includes('OFF') &&
                    dayShift !== '-' && 
                    dayShift.trim() !== '') {
                    return { 
                        hasShift: true, 
                        shiftType: dayShift,
                        shiftTime: dayShift,
                        personName: fullName
                    };
                }
            }
        }
        
        return { hasShift: false, shiftType: null, reason: 'no_shift_today' };
    } catch (e) {
        console.warn('[ShiftCheck] Hata:', e);
        return { hasShift: false, shiftType: null, reason: 'error' };
    }
}

async function loadChecklist() {
    // EÅŸzamanlÄ± yÃ¼klemeleri engelle (flickering fix)
    if (checklistLoadingLock) return;
    checklistLoadingLock = true;
    
    const branch = document.getElementById('checklistSube')?.value;
    const type = document.getElementById('checklistType')?.value;
    const date = document.getElementById('checklistDate')?.value;
    const container = document.getElementById('checklistFormContainer');
    
    if (!branch || !type || !date || !container) {
        checklistLoadingLock = false;
        return;
    }
    
    // G16: KullanÄ±cÄ±nÄ±n shift durumunu kontrol et
    const userShiftStatus = await checkCurrentUserShift(branch, date);
    const isManager = userShiftStatus.isManager;
    const hasShift = userShiftStatus.hasShift;
    
    // Shift yoksa uyarÄ± gÃ¶ster ve formu disable et (yÃ¶neticiler hariÃ§)
    if (!hasShift && !isManager) {
        container.innerHTML = `
            <div style="text-align:center;padding:60px 20px">
                <div style="width:80px;height:80px;margin:0 auto 20px;background:linear-gradient(135deg,#fee2e2,#fecaca);border-radius:50%;display:flex;align-items:center;justify-content:center">
                    <svg width="40" height="40" fill="none" stroke="#ef4444" stroke-width="2" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 8v4M12 16h.01"/>
                    </svg>
                </div>
                <div style="font-size:1.2rem;font-weight:600;color:var(--tx);margin-bottom:8px">Åžu An Shift'iniz Yok</div>
                <div style="color:var(--tx2);margin-bottom:20px">Bu ÅŸubede bugÃ¼n iÃ§in aktif bir shift kaydÄ±nÄ±z bulunmuyor.</div>
                <div style="padding:16px;background:var(--bg3);border-radius:12px;text-align:left;max-width:400px;margin:0 auto">
                    <div style="font-size:.85rem;color:var(--tx2)">
                        <div style="margin-bottom:8px"><strong>Åžube:</strong> ${branch}</div>
                        <div style="margin-bottom:8px"><strong>Tarih:</strong> ${date}</div>
                        <div><strong>KullanÄ±cÄ±:</strong> ${currentUser?.name || '-'}</div>
                    </div>
                </div>
                <div style="margin-top:20px;font-size:.8rem;color:var(--tx3)">
                    Shift'iniz olduÄŸunu dÃ¼ÅŸÃ¼nÃ¼yorsanÄ±z yÃ¶neticinize baÅŸvurun.
                </div>
            </div>
        `;
        checklistLoadingLock = false;
        return;
    }
    
    // Saat dilimi kontrolÃ¼
    const typeOption = document.getElementById('checklistType')?.selectedOptions[0];
    const timeSlots = typeOption?.dataset.timeslots?.split(',').filter(Boolean) || [];
    const timeSlotGroup = document.getElementById('checklistTimeSlotGroup');
    const timeSlotSelect = document.getElementById('checklistTimeSlot');
    
    // Tarih ve saat otomatik - saat seÃ§imi TAMAMEN kaldÄ±rÄ±ldÄ±
    // TÃ¼m checkler iÃ§in saat seÃ§imi yok, sistem otomatik TÃ¼rkiye saati kullanÄ±r
    timeSlotGroup.style.display = 'none';
    
    // Platform check iÃ§in Ã¶zel iÅŸlem
    if (type === 'platform') {
        // Dashboard'dan gelen timeSlot'u kullan veya otomatik belirle
        const platformTimeSlot = timeSlotSelect?.value || null;
        await renderPlatformChecklistWithStatus(container, branch, date, platformTimeSlot);
        checklistLoadingLock = false;
        return;
    }
    
    // Temizlik Ã‡izelgesi iÃ§in Ã¶zel iÅŸlem (madde bazlÄ± daÄŸÄ±tÄ±m)
    if (type === 'aylik' || type === 'temizlik') {
        await renderTemizlikChecklist(container, branch, date);
        checklistLoadingLock = false;
        return;
    }
    
    // Otomatik saat belirleme - mevcut TÃ¼rkiye saati
    const now = new Date();
    const turkeyTime = now.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit', hour12: false });
    let autoTimeSlot = null;
    
    // EÄŸer timeSlots varsa, en yakÄ±n slot'u otomatik seÃ§
    if (timeSlots.length > 0) {
        const currentHour = now.getHours();
        const currentMinutes = currentHour * 60 + now.getMinutes();
        const dayEndHour = getBusinessDayEndHour();
        const isLateNight = currentHour >= 0 && currentHour < dayEndHour;
        
        // Gece saatlerinde son slot'u zorla seÃ§
        if (isLateNight && timeSlots.includes('22:00')) {
            autoTimeSlot = '22:00';
            console.log('[Checklist] Gece saati - 22:00 slotu seÃ§ildi');
        } else {
            let closestSlot = timeSlots[0];
            let minDiff = Infinity;
            
            timeSlots.forEach(slot => {
                const [h, m] = slot.split(':').map(Number);
                const slotMinutes = h * 60 + m;
                const diff = Math.abs(currentMinutes - slotMinutes);
                if (diff < minDiff) {
                    minDiff = diff;
                    closestSlot = slot;
                }
            });
            autoTimeSlot = closestSlot;
        }
        
        // EÄŸer timeSlotSelect zaten geÃ§erli bir deÄŸere sahipse (Dashboard'dan gelen), override etme
        if (!timeSlotSelect.value || !timeSlots.includes(timeSlotSelect.value)) {
            timeSlotSelect.value = autoTimeSlot;
        } else {
            autoTimeSlot = timeSlotSelect.value; // Mevcut deÄŸeri kullan
        }
    }
    
    // Zaman bilgisi (otomatik - TÃ¼rkiye saati)
    const timeSlot = autoTimeSlot || timeSlotSelect?.value || null;
    
    // Zaman penceresi bilgisi gÃ¶ster (sadece gunluk/guncel iÃ§in)
    let windowInfo = '';
    if (timeSlot && CHECK_RULES[type]) {
        const window = getCheckTimeWindow(type, timeSlot, branch);
        const remaining = getRemainingTime(type, timeSlot, branch);
        const rules = CHECK_RULES[type];
        
        if (window && remaining) {
            const statusClass = remaining.isExpired ? 'background:#e74c3c' : 
                               remaining.isUrgent ? 'background:#f39c12' : 
                               remaining.isWarning ? 'background:#3498db' : 'background:#27ae60';
            
            windowInfo = `
                <div style="margin-bottom:16px;padding:16px;border-radius:12px;background:var(--bg3);border:1px solid var(--cardBorder)">
                    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
                        <div>
                            <div style="font-weight:600;color:var(--tx);margin-bottom:4px">â±ï¸ ${timeSlot} Check</div>
                            <div style="font-size:.8rem;color:var(--tx2)">
                                ðŸ“— ${window.start}-${window.end} arasÄ±: <strong style="color:#27ae60">+${rules.points.onTime} puan</strong>
                                ${rules.lateWindow > 0 ? `<br>ðŸ“™ ${window.end}-${window.lateEnd} arasÄ±: <strong style="color:#f39c12">${rules.points.late} puan</strong>` : ''}
                                <br>ðŸ“• SÃ¼re sonrasÄ±: <strong style="color:#e74c3c">${rules.points.missed} puan</strong>
                            </div>
                        </div>
                        <div style="text-align:right">
                            <div style="padding:8px 16px;border-radius:20px;color:#fff;font-weight:600;${statusClass}">
                                ${remaining.isExpired ? 'â° SÃ¼re Doldu!' : `â±ï¸ ${remaining.text}`}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    }
    
    // Loading
    container.innerHTML = windowInfo + `<div style="text-align:center;padding:40px;color:var(--tx2)">
        <div class="loading-spinner" style="margin:0 auto 16px"></div>
        Checklist yÃ¼kleniyor...
    </div>`;
    
    try {
        // Type ID mapping - seed.html ve index.html arasÄ±ndaki farklarÄ± Ã§Ã¶z
        const TYPE_ID_MAP = {
            // seed.html â†’ index.html uyumu
            'guncel': 'guncel',       // seed.html'de guncel kullanÄ±lÄ±yor
            'gunluk': 'guncel',       // index.html'de gunluk deniyor ama guncel aranmalÄ±
            'gunluk_check': 'guncel',
            'gunluk_genel': 'guncel',
            'aylik_temizlik': 'aylik',
            'temizlik_acilis': 'aylik',
            'temizlik_araci': 'aylik',
            'temizlik_kapanis': 'aylik',
            'temizlik_cizelgesi': 'aylik',
            'acilis_hazirlik': 'acilis',
            'kapanis_hazirlik': 'kapanis',
            'mudur_kontrol': 'mudur',
            'platform_check': 'platform',
            'haftalik_gorev': 'haftalik'
        };
        
        // Canonical type id kullan
        const canonType = canonicalChecklistTypeId(type);
        const mappedType = TYPE_ID_MAP[canonType] || canonType;
        const checklistId = `${sanitize(branch)}_${mappedType}`;
        
        // Alternatif ID'ler - dailyDocIdCandidates helper'Ä± ile
        const alternativeIds = [
            checklistId,
            ...dailyDocIdCandidates(branch, canonType),
            `${sanitize(branch)}_${type}` // orijinal type ile de dene
        ].filter((v, i, a) => a.indexOf(v) === i); // unique
        
        let items = [];
        let foundDocId = null;
        
        // TÃ¼m alternatif ID'leri dene
        for (const docId of alternativeIds) {
            if (items.length > 0) break;
            try {
                const checklistDoc = await db.collection('checklists').doc(docId).get();
                if (checklistDoc.exists && checklistDoc.data().items?.length > 0) {
                    items = checklistDoc.data().items;
                    foundDocId = docId;
                    console.log(`âœ… Checklist yÃ¼klendi: ${docId} (${items.length} madde)`);
                }
            } catch (dbError) {
                console.warn(`Checklist bulunamadÄ±: ${docId}`);
            }
        }
        
        // Firebase'de yoksa default maddeleri kullan ve kaydet (ilk kurulum)
        if (items.length === 0) {
            items = getDefaultChecklistItems(branch, type) || getDefaultChecklistItems(branch, mappedType);
            if (items.length > 0) {
                try {
                    await db.collection('checklists').doc(checklistId).set({
                        branch,
                        type: mappedType,
                        items,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log(`Ä°lk kurulum: ${checklistId} Firebase'e kaydedildi`);
                } catch (e) {
                    console.warn('Ä°lk kayÄ±t hatasÄ±:', e);
                }
            }
        }
        
        // EÄŸer hala items boÅŸsa hata gÃ¶ster
        if (!items || items.length === 0) {
            container.innerHTML = windowInfo + `<div style="text-align:center;padding:60px;color:var(--tx2)">
                <svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" style="opacity:.4;margin-bottom:16px">
                    <circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/>
                </svg>
                <div style="font-size:1.1rem;margin-bottom:8px;color:var(--tx)">Checklist Verisi BulunamadÄ±</div>
                <div style="font-size:.85rem;margin-bottom:16px;max-width:300px;margin-left:auto;margin-right:auto">
                    <strong>${branch}</strong> ÅŸubesi iÃ§in <strong>${type}</strong> checklist'i henÃ¼z yÃ¼klenmemiÅŸ.
                </div>
                <div style="font-size:.8rem;color:var(--tx3)">
                    YÃ¶netici: <code>seed.html</code> dosyasÄ±nÄ± aÃ§Ä±p verileri yÃ¼kleyin.
                </div>
            </div>`;
            return;
        }
        
        // Daha Ã¶nce doldurulmuÅŸ mu kontrol et
        let submittedData = null;
        try {
            const submissionId = `${checklistId}_${date}${timeSlot ? '_' + timeSlot.replace(':', '') : ''}`;
            const submissionDoc = await db.collection('checklistSubmissions').doc(submissionId).get();
            if (submissionDoc.exists) {
                submittedData = submissionDoc.data();
            }
        } catch (subError) {
            console.warn('Submission kontrol hatasÄ±:', subError);
        }
        
        // Formu render et - shift personeli ile
        // Shift'ten sorumlu personeli bul ve displayName'e Ã§evir
        let shiftPersonnel = [];
        try {
            const weekStart = getWeekStart(new Date(date));
            const weekKey = formatDateLocal(weekStart);
            const currentHour = new Date().getHours();
            const dayEndHour = getBusinessDayEndHour();
            const isLateNight = currentHour >= 0 && currentHour < dayEndHour;
            
            // Gece saatlerinde son slotu kullan
            let checkHour = timeSlot ? parseInt(timeSlot.split(':')[0]) : currentHour;
            if (isLateNight && !timeSlot && ['gunluk', 'guncel'].includes(type)) {
                checkHour = 22; // Gece saatlerinde 22:00 slotu aktif
            }
            
            const dayIndex = new Date(date).getDay() - 1 < 0 ? 6 : new Date(date).getDay() - 1;
            
            const shiftsSnapshot = await db.collection('shifts')
                .where('branch', '==', branch)
                .get();
            
            const allShifts = [];
            shiftsSnapshot.forEach(doc => allShifts.push(doc.data()));
            allShifts.sort((a, b) => (b.weekStart || '').localeCompare(a.weekStart || ''));
            
            const targetShift = allShifts.find(s => s.weekStart === weekKey) || allShifts[0];
            
            if (targetShift && targetShift.personelShifts) {
                const rawPersonnel = [];
                const personelNames = targetShift.personelNames || {};      // codeName (gÃ¶rÃ¼ntÃ¼ adÄ±)
                const personelFullNames = targetShift.personelFullNames || {}; // tam isim
                
                for (const [key, days] of Object.entries(targetShift.personelShifts)) {
                    const todayShift = days[dayIndex] || '';
                    const cleanShift = todayShift.replace(/\*/g, '').trim().toUpperCase();
                    
                    // Ã–NCE personelNames (codeName), yoksa fullName'den formatla, yoksa key temizle
                    let displayName = personelNames[key];
                    if (!displayName) {
                        const fullName = personelFullNames[key];
                        displayName = fullName ? formatDisplayName(fullName) : formatDisplayName(key.replace(/_/g, ' '));
                    }
                    
                    // TÃ¼m aktif personeli topla (check tÃ¼rÃ¼ne gÃ¶re filtreleme)
                    if (cleanShift && cleanShift !== 'Ä°' && cleanShift !== 'OFF' && cleanShift !== '-' && cleanShift !== 'X') {
                        // AÃ§Ä±lÄ±ÅŸ check'i iÃ§in sadece aÃ§Ä±lÄ±ÅŸÃ§Ä±lar
                        if (type === 'acilis' && (cleanShift === 'A' || cleanShift === 'AÃ‡ILIÅž' || cleanShift.includes('AÃ‡ILI'))) {
                            rawPersonnel.push(displayName);
                        }
                        // KapanÄ±ÅŸ check'i iÃ§in sadece kapanÄ±ÅŸÃ§Ä±lar
                        else if (type === 'kapanis' && (cleanShift === 'K' || cleanShift === 'KAPANIÅž' || cleanShift.includes('KAPANI'))) {
                            rawPersonnel.push(displayName);
                        }
                        // MÃ¼dÃ¼r kontrolÃ¼ iÃ§in - shift'ten deÄŸil, rol bazlÄ± Ã§ekeceÄŸiz
                        else if (type === 'mudur') {
                            // Bu blok boÅŸ - mÃ¼dÃ¼rler aÅŸaÄŸÄ±da Firebase'den Ã§ekilecek
                        }
                        // GÃ¼nlÃ¼k/GÃ¼ncel check iÃ§in SAAT BAZLI ADALETLÄ° ATAMA
                        else if (['gunluk', 'guncel'].includes(type)) {
                            // Shift saatini parse et
                            const shiftTimeMatch = todayShift.match(/(\d{1,2}):?(\d{2})?\s*[-â€“]\s*(\d{1,2}):?(\d{2})?/);
                            let shiftStart = 10, shiftEnd = 19;
                            
                            if (shiftTimeMatch) {
                                shiftStart = parseInt(shiftTimeMatch[1]);
                                shiftEnd = parseInt(shiftTimeMatch[3]);
                            } else {
                                // Saat formatÄ± yoksa vardiya tipine gÃ¶re
                                if (cleanShift === 'A' || cleanShift === 'AÃ‡ILIÅž' || cleanShift.includes('AÃ‡ILI')) {
                                    shiftStart = 10; shiftEnd = 19;
                                } else if (cleanShift === 'K' || cleanShift === 'KAPANIÅž' || cleanShift.includes('KAPANI')) {
                                    shiftStart = 16; shiftEnd = 26; // 02:00 = 26
                                } else if (cleanShift.includes('ARA') || cleanShift === 'ORTA') {
                                    shiftStart = 12; shiftEnd = 21;
                                }
                            }
                            
                            // Gece geÃ§iÅŸi kontrolÃ¼
                            const isInShift = shiftEnd > shiftStart 
                                ? (checkHour >= shiftStart && checkHour < shiftEnd)
                                : (checkHour >= shiftStart || checkHour < (shiftEnd % 24));
                            
                            // BÃ–LGE MÃœDÃœRÃœ hariÃ§ ve shift iÃ§indeyse ekle
                            if (isInShift && !cleanShift.includes('BÃ–LGE') && !cleanShift.includes('MÃœDÃœR')) {
                                rawPersonnel.push({
                                    name: displayName,
                                    shiftStart,
                                    shiftEnd,
                                    type: cleanShift === 'A' || cleanShift.includes('AÃ‡ILI') ? 'acilis' : 
                                          cleanShift === 'K' || cleanShift.includes('KAPANI') ? 'kapanis' : 'ara'
                                });
                            }
                        }
                        // DiÄŸer tÃ¼m checkler iÃ§in tÃ¼m aktif personel (BÃ–LGE MÃœDÃœRÃœ HARÄ°Ã‡)
                        else if (!['acilis', 'kapanis', 'mudur', 'gunluk', 'guncel'].includes(type)) {
                            if (!cleanShift.includes('BÃ–LGE') && !cleanShift.includes('MÃœDÃœR')) {
                                rawPersonnel.push(displayName);
                            }
                        }
                    }
                }
                
                // MÃ¼dÃ¼r Kontrol iÃ§in Firebase'den mÃ¼dÃ¼r rolÃ¼ndeki personeli Ã§ek (OFF kontrolÃ¼ ile)
                if (type === 'mudur') {
                    try {
                        const personelSnapshot = await db.collection('personel')
                            .where('branch', 'in', [branch, 'all'])
                            .get();
                        
                        // Shift verisini Ã§ek (OFF kontrolÃ¼ iÃ§in)
                        const weekStart = getWeekStart(new Date(date));
                        const weekKey = formatDateLocal(weekStart);
                        const shiftsSnapshot = await db.collection('shifts')
                            .where('branch', '==', branch)
                            .get();
                        
                        let shiftData = null;
                        shiftsSnapshot.forEach(doc => {
                            const d = doc.data();
                            if (d.weekStart === weekKey) shiftData = d;
                        });
                        
                        // Helper: personelin bugÃ¼n OFF olup olmadÄ±ÄŸÄ±nÄ± kontrol et
                        const isPersonOff = (person) => {
                            if (!person || !shiftData) return false;
                            const personId = person.uniqueId || normalizePersonelId(person.name);
                            const possibleKeys = [personId, person.codeName, person.name?.toLowerCase().replace(/\s+/g, '_')];
                            let shift = null;
                            for (const key of possibleKeys) {
                                if (shiftData.personelShifts?.[key]) {
                                    shift = shiftData.personelShifts[key];
                                    break;
                                }
                            }
                            if (!shift) return false;
                            const dayIdx = new Date(date).getDay() - 1 < 0 ? 6 : new Date(date).getDay() - 1;
                            const todayShift = shift[dayIdx] || '';
                            const cleanShift = todayShift.replace(/\*/g, '').trim().toUpperCase();
                            return cleanShift === 'OFF' || cleanShift === 'Ä°' || cleanShift === 'Y.Ä°' || cleanShift === '-' || cleanShift === 'X';
                        };
                        
                        // MÃ¼dÃ¼rleri Ã¶ncelik sÄ±rasÄ±na gÃ¶re ekle (OFF olmayanlar)
                        let mudur = null, yardimci = null, bolgeMuduru = null;
                        personelSnapshot.forEach(doc => {
                            const data = doc.data();
                            const role = (data.role || data.pozisyon || '').toLowerCase();
                            if (role === 'magaza_muduru' && data.branch === branch) mudur = data;
                            if (role === 'magaza_mudur_yardimcisi' && data.branch === branch) yardimci = data;
                            if (role === 'bolge_muduru') bolgeMuduru = data;
                        });
                        
                        // SÄ±rayla ekle: MÃ¼dÃ¼r â†’ YardÄ±mcÄ± â†’ BÃ¶lge MÃ¼dÃ¼rÃ¼
                        if (mudur && !isPersonOff(mudur)) {
                            const displayName = getPersonelDisplayName(mudur);
                            if (displayName && !shiftPersonnel.includes(displayName)) {
                                shiftPersonnel.push(displayName);
                            }
                        }
                        if (yardimci && !isPersonOff(yardimci)) {
                            const displayName = getPersonelDisplayName(yardimci);
                            if (displayName && !shiftPersonnel.includes(displayName)) {
                                shiftPersonnel.push(displayName);
                            }
                        }
                        if (bolgeMuduru) {
                            const displayName = getPersonelDisplayName(bolgeMuduru);
                            if (displayName && !shiftPersonnel.includes(displayName)) {
                                shiftPersonnel.push(displayName);
                            }
                        }
                        
                        if (shiftPersonnel.length === 0) {
                            console.warn('MÃ¼dÃ¼r check: TÃ¼m mÃ¼dÃ¼rler OFF veya mÃ¼dÃ¼r yok');
                        }
                        console.log('MÃ¼dÃ¼r listesi (OFF hariÃ§):', shiftPersonnel);
                    } catch (e) {
                        console.warn('MÃ¼dÃ¼r listesi alÄ±namadÄ±:', e);
                    }
                } else {
                    // GÃ¼nlÃ¼k check iÃ§in ADALETLÄ° TEK KÄ°ÅžÄ° SEÃ‡Ä°MÄ°
                    if (['gunluk', 'guncel'].includes(type) && rawPersonnel.length > 0 && typeof rawPersonnel[0] === 'object') {
                        // rawPersonnel object array: {name, shiftStart, shiftEnd, type}
                        let selectedPersonnel = [];
                        
                        if (checkHour === 14) {
                            // 14:00 â†’ Ä°lk shift giren (11:00-13:00 arasÄ± baÅŸlayan)
                            const firstEntry = rawPersonnel
                                .filter(p => p.shiftStart >= 11 && p.shiftStart <= 13)
                                .sort((a, b) => a.shiftStart - b.shiftStart)[0];
                            if (firstEntry) {
                                selectedPersonnel = [firstEntry.name];
                                console.log('[Adaletli Atama] 14:00 - Ä°lk giren:', firstEntry.name);
                            } else {
                                // Ä°lk giren yoksa aÃ§Ä±lÄ±ÅŸÃ§Ä±
                                selectedPersonnel = rawPersonnel
                                    .filter(p => p.type === 'acilis')
                                    .map(p => p.name);
                                console.log('[Adaletli Atama] 14:00 - AÃ§Ä±lÄ±ÅŸÃ§Ä±lar:', selectedPersonnel);
                            }
                        } else {
                            // 18:00, 22:00 â†’ BugÃ¼nkÃ¼ check sayÄ±sÄ±na gÃ¶re adaletli daÄŸÄ±lÄ±m
                            try {
                                const todayStr = date;
                                const checkCounts = {};
                                
                                // BugÃ¼nkÃ¼ tÃ¼m submission'larÄ± Ã§ek
                                const submissions = await db.collection('checklistSubmissions')
                                    .where('branch', '==', branch)
                                    .where('date', '==', todayStr)
                                    .get();
                                
                                submissions.forEach(doc => {
                                    const d = doc.data();
                                    const personName = d.personName || d.personelId || '';
                                    if (personName) {
                                        checkCounts[personName] = (checkCounts[personName] || 0) + 1;
                                    }
                                });
                                
                                // 14:00 dolduranÄ± bul (gÃ¼n boyu muaf)
                                let filled14 = null;
                                submissions.forEach(doc => {
                                    if (doc.id.includes('_guncel_') && doc.id.includes('_1400')) {
                                        const d = doc.data();
                                        filled14 = d.personName || d.personelId;
                                    }
                                });
                                
                                // AdaylarÄ± filtrele (o saatte shift'te olanlar)
                                let candidates = rawPersonnel.map(p => p.name);
                                
                                // Gece saatleri kontrolÃ¼ (00:00-02:00) - kapanÄ±ÅŸÃ§Ä±lara ata
                                if (isLateNight && checkHour === 22) {
                                    const kapaniscilar = rawPersonnel.filter(p => p.type === 'kapanis').map(p => p.name);
                                    if (kapaniscilar.length > 0) {
                                        candidates = kapaniscilar;
                                        console.log('[Adaletli Atama] Gece saati - kapanÄ±ÅŸÃ§Ä±lara atandÄ±:', kapaniscilar);
                                    }
                                }
                                // EÄŸer 22:00 ve aday yoksa â†’ kapanÄ±ÅŸÃ§Ä±lara aktar
                                else if (checkHour >= 21 && candidates.length === 0) {
                                    const kapaniscilar = rawPersonnel.filter(p => p.type === 'kapanis').map(p => p.name);
                                    if (kapaniscilar.length > 0) {
                                        candidates = kapaniscilar;
                                        console.log('[Adaletli Atama] ' + checkHour + ':00 - Shift bitti, kapanÄ±ÅŸÃ§Ä±lara aktarÄ±ldÄ±:', kapaniscilar);
                                    }
                                }
                                
                                // 14:00 dolduranÄ± muaf tut (birden fazla kiÅŸi varsa)
                                if (filled14 && candidates.length > 1) {
                                    candidates = candidates.filter(p => p !== filled14);
                                    console.log('[Adaletli Atama] 14:00 dolduran muaf:', filled14);
                                }
                                
                                // Check sayÄ±larÄ±na gÃ¶re sÄ±rala (en az dolduran Ã¶nce)
                                candidates.sort((a, b) => (checkCounts[a] || 0) - (checkCounts[b] || 0));
                                
                                // En az check dolduran(lar)Ä± seÃ§
                                if (candidates.length > 0) {
                                    const minCount = checkCounts[candidates[0]] || 0;
                                    selectedPersonnel = candidates.filter(p => (checkCounts[p] || 0) === minCount);
                                }
                                
                                console.log('[Adaletli Atama] ' + checkHour + ':00 - Check sayÄ±larÄ±:', checkCounts);
                                console.log('[Adaletli Atama] ' + checkHour + ':00 - SeÃ§ilen:', selectedPersonnel);
                            } catch (e) {
                                // Hata durumunda tÃ¼m adaylarÄ± gÃ¶ster
                                selectedPersonnel = rawPersonnel.map(p => p.name);
                                console.warn('[Adaletli Atama] Hata, tÃ¼m adaylar gÃ¶steriliyor:', e);
                            }
                        }
                        
                        // SeÃ§ilen personeli shiftPersonnel'e ekle
                        for (const name of selectedPersonnel) {
                            if (name && !shiftPersonnel.includes(name)) {
                                shiftPersonnel.push(name);
                            }
                        }
                    } else {
                        // DiÄŸer checkler iÃ§in rawPersonnel string array
                        for (const item of rawPersonnel) {
                            const displayName = typeof item === 'object' ? item.name : item;
                            if (displayName && !shiftPersonnel.includes(displayName)) {
                                shiftPersonnel.push(displayName);
                            }
                        }
                    }
                }
            }
            
            console.log('Shift personeli bulundu:', shiftPersonnel);
        } catch (e) {
            console.warn('Shift personeli alÄ±namadÄ±:', e.message);
        }
        
        // ==================== BÃ–LGE MÃœDÃœRLERÄ°NÄ° HARÄ°Ã‡ TUT ====================
        // BÃ¶lge mÃ¼dÃ¼rleri hiÃ§bir checkliste dahil deÄŸil (shift'te saati olsa bile)
        if (shiftPersonnel.length > 0 && type !== 'mudur') {
            try {
                const bolgeMudurleri = [];
                const personelSnapshot = await db.collection('personel')
                    .where('role', '==', 'bolge_muduru')
                    .get();
                
                personelSnapshot.forEach(doc => {
                    const data = doc.data();
                    // TÃ¼m isim varyasyonlarÄ±nÄ± ekle
                    bolgeMudurleri.push(data.name);                        // Tam isim
                    bolgeMudurleri.push(formatDisplayName(data.name));     // Ad S.
                    if (data.codeName) bolgeMudurleri.push(data.codeName); // Shift Kod AdÄ±
                    bolgeMudurleri.push(data.name?.split(' ')[0]);         // Sadece ad
                });
                
                if (bolgeMudurleri.length > 0) {
                    const filteredPersonnel = shiftPersonnel.filter(p => {
                        if (!p) return false;
                        const pLower = p.toLowerCase();
                        const pNorm = normalizeTurkishChars(p);
                        return !bolgeMudurleri.some(bm => {
                            if (!bm) return false;
                            const bmLower = bm.toLowerCase();
                            const bmNorm = normalizeTurkishChars(bm);
                            return bmLower === pLower || bmNorm === pNorm;
                        });
                    });
                    
                    if (filteredPersonnel.length !== shiftPersonnel.length) {
                        console.log('BÃ¶lge mÃ¼dÃ¼rleri hariÃ§ tutuldu:', shiftPersonnel.length - filteredPersonnel.length);
                        shiftPersonnel = filteredPersonnel;
                    }
                }
            } catch (e) {
                console.warn('BÃ¶lge mÃ¼dÃ¼rÃ¼ filtreleme hatasÄ±:', e);
            }
        }
        
        // Temizlik ve BakÄ±m iÃ§in maÄŸaza mÃ¼dÃ¼rlerini hariÃ§ tut (tek kiÅŸi deÄŸilse)
        if (type === 'aylik' && shiftPersonnel.length > 1) {
            try {
                const magazaMudurleri = [];
                const mudurSnapshot = await db.collection('personel')
                    .where('branch', '==', branch)
                    .get();
                
                mudurSnapshot.forEach(doc => {
                    const data = doc.data();
                    const role = (data.role || '').toLowerCase();
                    // MaÄŸaza mÃ¼dÃ¼rÃ¼ ve yardÄ±mcÄ±sÄ±
                    if (role === 'magaza_muduru' || role === 'magaza_mudur_yardimcisi') {
                        magazaMudurleri.push(data.name);
                        magazaMudurleri.push(formatDisplayName(data.name));
                        if (data.codeName) magazaMudurleri.push(data.codeName);
                        magazaMudurleri.push(data.name?.split(' ')[0]);
                    }
                });
                
                if (magazaMudurleri.length > 0) {
                    const filteredPersonnel = shiftPersonnel.filter(p => {
                        if (!p) return false;
                        const pLower = p.toLowerCase();
                        const pNorm = normalizeTurkishChars(p);
                        return !magazaMudurleri.some(mm => {
                            if (!mm) return false;
                            const mmLower = mm.toLowerCase();
                            const mmNorm = normalizeTurkishChars(mm);
                            return mmLower === pLower || mmNorm === pNorm;
                        });
                    });
                    
                    // Sadece en az 1 kiÅŸi kalÄ±rsa filtrele
                    if (filteredPersonnel.length > 0 && filteredPersonnel.length !== shiftPersonnel.length) {
                        console.log('Temizlik: MÃ¼dÃ¼rler hariÃ§ tutuldu:', shiftPersonnel.length - filteredPersonnel.length);
                        shiftPersonnel = filteredPersonnel;
                    }
                }
            } catch (e) {
                console.warn('Temizlik mÃ¼dÃ¼r filtreleme hatasÄ±:', e);
            }
        }
        
        // HaftalÄ±k gÃ¶revler iÃ§in atama bilgisini Ã§ek
        let weeklyAssignments = null;
        let dailyAssignments = null;
        
        if (type === 'haftalik') {
            const weekStart = getWeekStart(new Date(date));
            const weekKey = formatDateLocal(weekStart);
            weeklyAssignments = await getWeeklyTaskAssignments(branch, weekKey);
            window._weeklyTaskAssignments = weeklyAssignments;
            console.log('HaftalÄ±k gÃ¶rev atamalarÄ±:', weeklyAssignments);
        } else if (['acilis', 'kapanis', 'gunluk', 'guncel'].includes(type)) {
            // GÃ¼nlÃ¼k checkler iÃ§in atama bilgisini Ã§ek veya OTOMATÄ°K OLUÅžTUR
            dailyAssignments = await getDailyTaskAssignments(branch, type, date, items, shiftPersonnel);
            window._dailyTaskAssignments = dailyAssignments;
            console.log('GÃ¼nlÃ¼k gÃ¶rev atamalarÄ±:', dailyAssignments);
        }
        
        renderChecklistForm(items, branch, type, date, timeSlot, submittedData, shiftPersonnel, weeklyAssignments, dailyAssignments);
        checklistLoadingLock = false;
        
    } catch (error) {
        console.error('Checklist yÃ¼kleme hatasÄ±:', error);
        container.innerHTML = `<div style="color:var(--red);padding:20px;text-align:center">
            <div style="font-size:2rem;margin-bottom:8px">âš ï¸</div>
            Checklist yÃ¼klenirken hata oluÅŸtu: ${error.message || 'Bilinmeyen hata'}
        </div>`;
        checklistLoadingLock = false;
    }
}

// Checklist formunu render et
let checklistEditMode = false;

// Temizlik ve BakÄ±m iÃ§in tÃ¼mÃ¼nÃ¼ gÃ¶ster flag'i
let showAllAylikItems = false;

function renderChecklistForm(items, branch, type, date, timeSlot, submittedData, shiftPersonnel = [], weeklyAssignments = null, dailyAssignments = null) {
    const container = document.getElementById('checklistFormContainer');
    const isAdmin = currentUser?.role === 'yonetici' || currentUser?.role === 'bolge_muduru';
    const isManager = currentUser?.role === 'yonetici' || currentUser?.role === 'magaza_muduru' || currentUser?.role === 'bolge_muduru';
    const isSubmitted = !!submittedData;
    const isAylik = type === 'aylik';
    const isHaftalik = type === 'haftalik';
    const isDailyShareable = type === 'haftalik'; // SADECE haftalÄ±k checklist'te gÃ¶rev paylaÅŸÄ±mÄ± var
    const hasMultiplePersonnel = shiftPersonnel && shiftPersonnel.length > 1;
    const hasDailySharing = isDailyShareable && dailyAssignments?.assignments;
    
    // Atama bilgisini sakla (global eriÅŸim iÃ§in)
    window._weeklyTaskAssignments = weeklyAssignments;
    window._dailyTaskAssignments = dailyAssignments;
    window._currentChecklistItems = items;
    window._currentShiftPersonnel = shiftPersonnel;
    
    // ==================== PERSONEL ERÄ°ÅžÄ°M KONTROLÃœ ====================
    // GiriÅŸ yapan kullanÄ±cÄ±nÄ±n displayName'ini al
    const currentUserDisplayName = getPersonelDisplayName(currentUser) || currentUser?.name || '';
    const currentUserFirstName = currentUserDisplayName.split(' ')[0]?.toLowerCase();
    
    // shiftPersonnel listesinde kendisi var mÄ± kontrol et
    let isAssignedToMe = false;
    
    if (isManager) {
        // MÃ¼dÃ¼rler tÃ¼m checklere eriÅŸebilir
        isAssignedToMe = true;
    } else if (shiftPersonnel && shiftPersonnel.length > 0) {
        // Personel listesinde kendisi var mÄ±?
        isAssignedToMe = shiftPersonnel.some(p => {
            const pLower = p.toLowerCase();
            const pFirstName = p.split(' ')[0]?.toLowerCase();
            return pLower === currentUserDisplayName.toLowerCase() ||
                   pFirstName === currentUserFirstName ||
                   p === currentUser?.name ||
                   p === currentUser?.codeName;
        });
    } else {
        // shiftPersonnel boÅŸsa herkese aÃ§Ä±k (fallback)
        isAssignedToMe = true;
    }
    
    console.log('EriÅŸim kontrolÃ¼:', { 
        currentUserDisplayName, 
        shiftPersonnel, 
        isAssignedToMe, 
        isManager 
    });
    
    // ==================== ZAMAN KONTROLÃœ ====================
    // Checklist'in aktif saatlerinde mi kontrol et
    let isInTimeWindow = true;
    let timeWindowMessage = '';
    
    if (!isManager && !isSubmitted && ['acilis', 'kapanis', 'gunluk', 'guncel', 'mudur'].includes(type)) {
        const rule = CHECK_RULES[type] || DEFAULT_CHECK_RULES[type];
        const now = new Date();
        const currentHour = now.getHours();
        const currentMinute = now.getMinutes();
        const currentTotalMinutes = currentHour * 60 + currentMinute;
        
        if (type === 'acilis') {
            // AÃ§Ä±lÄ±ÅŸ: 09:00 - 11:00 arasÄ± (BRANCH_HOURS'a gÃ¶re dinamik olabilir)
            const branchHours = BRANCH_HOURS[branch] || { open: '09:00', close: '23:00' };
            const [openHour, openMin] = branchHours.open.split(':').map(Number);
            const openTotalMinutes = openHour * 60 + openMin;
            const deadlineMinutes = openTotalMinutes + 120; // AÃ§Ä±lÄ±ÅŸtan 2 saat sonraya kadar
            
            if (currentTotalMinutes < openTotalMinutes || currentTotalMinutes > deadlineMinutes) {
                isInTimeWindow = false;
                const deadlineHour = Math.floor(deadlineMinutes / 60);
                const deadlineMin = deadlineMinutes % 60;
                timeWindowMessage = `AÃ§Ä±lÄ±ÅŸ checklisti ${branchHours.open} - ${String(deadlineHour).padStart(2,'0')}:${String(deadlineMin).padStart(2,'0')} saatleri arasÄ±nda doldurulabilir.`;
            }
        } else if (type === 'kapanis') {
            // KapanÄ±ÅŸ: KapanÄ±ÅŸtan 2 saat Ã¶nce - kapanÄ±ÅŸ saatine kadar
            const branchHours = BRANCH_HOURS[branch] || { open: '09:00', close: '23:00' };
            const [closeHour, closeMin] = branchHours.close.split(':').map(Number);
            const closeTotalMinutes = closeHour * 60 + closeMin;
            const startMinutes = closeTotalMinutes - 120; // KapanÄ±ÅŸtan 2 saat Ã¶nce
            
            if (currentTotalMinutes < startMinutes) {
                isInTimeWindow = false;
                const startHour = Math.floor(startMinutes / 60);
                const startMin = startMinutes % 60;
                timeWindowMessage = `KapanÄ±ÅŸ checklisti ${String(startHour).padStart(2,'0')}:${String(startMin).padStart(2,'0')} - ${branchHours.close} saatleri arasÄ±nda doldurulabilir.`;
            }
        }
    }
    
    // Temizlik ve haftalÄ±k iÃ§in zaman kontrolÃ¼ yok
    if (['aylik', 'haftalik'].includes(type)) {
        isInTimeWindow = true;
    }
    
    // Form doldurulabilir mi?
    const canFillForm = isAssignedToMe && isInTimeWindow && !isSubmitted;
    
    console.log('Zaman kontrolÃ¼:', { type, isInTimeWindow, timeWindowMessage, canFillForm });
    // ==================== ZAMAN KONTROLÃœ SONU ====================
    
    // ==================== ERÄ°ÅžÄ°M KONTROLÃœ SONU ====================
    
    // Temizlik ve BakÄ±m iÃ§in tarih filtreleme
    const selectedDate = new Date(date);
    const dayOfMonth = selectedDate.getDate();
    
    let filteredItems = items;
    let totalItemCount = items.length;
    
    if (isAylik && !showAllAylikItems) {
        filteredItems = items.filter(item => {
            if (!item.dates || item.dates.length === 0) return true; // Her gÃ¼n
            return item.dates.includes(dayOfMonth);
        });
    }
    
    // HaftalÄ±k iÃ§in sÄ±ralama: KiÅŸinin maddeleri en Ã¼stte
    if (isHaftalik && weeklyAssignments?.rawAssignments && !isManager) {
        const currentPersonnelId = currentUser?.personelId || currentUser?.uniqueId || currentUser?.id;
        
        filteredItems = [...filteredItems].sort((a, b) => {
            const aAssignment = weeklyAssignments.rawAssignments.find(x => x.itemId === a.id);
            const bAssignment = weeklyAssignments.rawAssignments.find(x => x.itemId === b.id);
            
            const aIsMyTask = aAssignment?.personnelId === currentPersonnelId;
            const bIsMyTask = bAssignment?.personnelId === currentPersonnelId;
            
            // KiÅŸinin maddeleri en Ã¼stte
            if (aIsMyTask && !bIsMyTask) return -1;
            if (!aIsMyTask && bIsMyTask) return 1;
            
            // AynÄ± kategorideyse orijinal sÄ±rayÄ± koru
            return 0;
        });
        
        console.log('[HaftalÄ±k] Maddeler sÄ±ralandÄ± - kiÅŸinin maddeleri Ã¼stte');
    }
    
    // Zamanlama sÄ±fÄ±rla (yeni checklist)
    if (!isSubmitted) {
        checklistStartTime = null;
        checklistFirstItemTime = null;
        
        // HaftalÄ±k iÃ§in sadece kiÅŸinin maddelerini hesapla
        if (isHaftalik && weeklyAssignments?.rawAssignments && !isManager) {
            const currentPersonnelId = currentUser?.personelId || currentUser?.uniqueId || currentUser?.id;
            const myItems = weeklyAssignments.rawAssignments.filter(a => a.personnelId === currentPersonnelId);
            
            // KiÅŸinin madde sayÄ±sÄ± * varsayÄ±lan sÃ¼re (5 dakika = 300 saniye)
            checklistExpectedDuration = myItems.length * 300;
        } else {
            // DiÄŸer checkler iÃ§in normal hesaplama
            checklistExpectedDuration = filteredItems.reduce((sum, item) => sum + (item.duration || 60), 0);
        }
    }
    
    // HaftalÄ±k iÃ§in madde sayÄ±sÄ±nÄ± da ayarla
    let displayItemCount = filteredItems.length;
    if (isHaftalik && weeklyAssignments?.rawAssignments && !isManager) {
        const currentPersonnelId = currentUser?.personelId || currentUser?.uniqueId || currentUser?.id;
        displayItemCount = weeklyAssignments.rawAssignments.filter(a => a.personnelId === currentPersonnelId).length;
    }
    
    // KullanÄ±cÄ± adÄ±nÄ± belirle - Ã¶ncelik: shift personeli > email > name
    let autoPersonName = '';
    let isAutoName = false;
    
    if (shiftPersonnel && shiftPersonnel.length > 0) {
        // Shift'ten gelen ilk sorumlu personel
        autoPersonName = shiftPersonnel[0];
        isAutoName = true;
    } else {
        // Fallback: email veya kullanÄ±cÄ± adÄ±
        autoPersonName = getUserNameFromEmail(currentUser?.email) || currentUser?.name || '';
        isAutoName = !!getUserNameFromEmail(currentUser?.email);
    }
    
    let typeInfo = CHECKLIST_TYPES[branch]?.find(t => t.id === type);
    const expectedMinutes = Math.round(checklistExpectedDuration / 60);
    const iconSvg = getIcon(typeInfo?.icon || 'clipboard-check');
    
    // Check kurallarÄ±nÄ± al
    const checkRules = CHECK_RULES[type] || {};
    const hasDeadline = checkRules.deadline || checkRules.timeSlots;
    const hasPoints = checkRules.points;
    
    let html = `
        <div class="form-section">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px">
                <div>
                    <div style="font-size:1.3rem;font-weight:700;color:var(--tx);display:flex;align-items:center;gap:10px">
                        <span style="opacity:.7">${iconSvg}</span>
                        ${typeInfo?.name || type}
                    </div>
                    <div style="font-size:.85rem;color:var(--tx2)">${branch} â€¢ ${new Date(date).toLocaleDateString('tr-TR', {weekday: 'long', day: 'numeric', month: 'long'})}${timeSlot ? ' â€¢ ' + timeSlot : ''}</div>
                </div>
                <div style="display:flex;gap:8px;align-items:center">
                    ${isAylik ? `
                        <button class="btn btn-sm btn-ghost" onclick="toggleShowAllAylikItems()" style="font-size:.8rem">
                            ${showAllAylikItems ? 'ðŸ“… BugÃ¼nÃ¼ GÃ¶ster' : 'ðŸ“‹ Hepsini GÃ¶ster'}
                        </button>
                        <span style="font-size:.75rem;color:var(--tx3);background:var(--bg3);padding:4px 10px;border-radius:12px">
                            ${filteredItems.length}/${totalItemCount} gÃ¶rev
                        </span>
                    ` : ''}
                    ${isSubmitted ? `
                        <div style="display:inline-flex;align-items:center;gap:6px;padding:8px 14px;background:rgba(39,174,96,.15);color:#27ae60;border-radius:20px;font-size:.85rem">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                            TamamlandÄ±
                        </div>
                    ` : ''}
                </div>
            </div>
            
            ${!isSubmitted && (hasDeadline || hasPoints || checkRules.note) ? `
            <!-- CHECK KURALLARI PANELÄ° -->
            <div style="margin-bottom:20px;padding:14px 18px;background:var(--bg3);border-radius:12px;border-left:4px solid #008c95">
                <div style="display:flex;flex-wrap:wrap;gap:16px;align-items:center">
                    ${checkRules.deadline ? `
                    <div style="display:flex;align-items:center;gap:8px">
                        <div style="width:32px;height:32px;background:rgba(0,140,149,.15);border-radius:8px;display:flex;align-items:center;justify-content:center">
                            <svg width="16" height="16" fill="none" stroke="#008c95" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                        </div>
                        <div>
                            <div style="font-size:.7rem;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px">Son Saat</div>
                            <div style="font-size:.95rem;font-weight:600;color:var(--tx)">${checkRules.deadline}</div>
                        </div>
                    </div>
                    ` : ''}
                    ${type === 'platform' && timeSlot ? `
                    <div style="display:flex;align-items:center;gap:8px">
                        <div style="width:32px;height:32px;background:rgba(0,140,149,.15);border-radius:8px;display:flex;align-items:center;justify-content:center">
                            <svg width="16" height="16" fill="none" stroke="#008c95" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                        </div>
                        <div>
                            <div style="font-size:.7rem;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px">Zaman Dilimi</div>
                            <div style="font-size:.95rem;font-weight:600;color:var(--tx)">${timeSlot} Â±30dk</div>
                        </div>
                    </div>
                    ` : ''}
                    ${hasPoints ? `
                    <div style="display:flex;align-items:center;gap:8px">
                        <div style="width:32px;height:32px;background:rgba(39,174,96,.15);border-radius:8px;display:flex;align-items:center;justify-content:center">
                            <svg width="16" height="16" fill="none" stroke="#27ae60" stroke-width="2" viewBox="0 0 24 24"><path d="M12 2L15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2z"/></svg>
                        </div>
                        <div>
                            <div style="font-size:.7rem;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px">Puanlar</div>
                            <div style="font-size:.85rem;display:flex;gap:8px;flex-wrap:wrap">
                                ${checkRules.points.onTime !== undefined ? `<span style="color:#27ae60;font-weight:600">âœ“ ${checkRules.points.onTime >= 0 ? '+' : ''}${checkRules.points.onTime}</span>` : ''}
                                ${checkRules.points.done !== undefined ? `<span style="color:#27ae60;font-weight:600">âœ“ ${checkRules.points.done >= 0 ? '+' : ''}${checkRules.points.done}</span>` : ''}
                                ${checkRules.points.late !== undefined ? `<span style="color:#f39c12;font-weight:600">â± ${checkRules.points.late}</span>` : ''}
                                ${checkRules.points.missed !== undefined ? `<span style="color:#e74c3c;font-weight:600">âœ— ${checkRules.points.missed}</span>` : ''}
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    ${shiftPersonnel && shiftPersonnel.length > 0 ? `
                    <div style="display:flex;align-items:center;gap:8px">
                        <div style="width:32px;height:32px;background:rgba(155,89,182,.15);border-radius:8px;display:flex;align-items:center;justify-content:center">
                            <svg width="16" height="16" fill="none" stroke="#9b59b6" stroke-width="2" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
                        </div>
                        <div>
                            <div style="font-size:.7rem;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px">Sorumlu</div>
                            <div style="font-size:.85rem;font-weight:500;color:var(--tx)">${shiftPersonnel.join(', ')}</div>
                        </div>
                    </div>
                    ` : ''}
                </div>
                ${checkRules.note ? `
                <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--cardBorder);font-size:.8rem;color:var(--tx2)">
                    <strong>Not:</strong> ${checkRules.note}
                </div>
                ` : ''}
            </div>
            ` : ''}
            
            ${isSubmitted ? `
                <div style="font-size:.75rem;color:var(--tx3);margin-bottom:16px">${submittedData.submittedByName} â€¢ ${submittedData.submittedAt?.toDate ? new Date(submittedData.submittedAt.toDate()).toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'}) : ''}</div>
            ` : ''}
            
            ${isManager && !isSubmitted ? `
                <!-- DÃ¼zenleme Toolbar - Sticky -->
                <div id="editToolbar" style="position:sticky;top:60px;z-index:99;margin-bottom:16px;padding:12px 16px;background:var(--bg);border:1px solid var(--cardBorder);border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.08)">
                    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">
                        <div style="font-size:.85rem;color:var(--tx);display:flex;align-items:center;gap:8px">
                            <button class="btn btn-sm ${checklistEditMode ? 'btn-primary' : 'btn-ghost'}" onclick="toggleChecklistEditMode('${branch}', '${type}', '${date}', '${timeSlot}')" style="display:flex;align-items:center;gap:4px">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                ${checklistEditMode ? 'DÃ¼zenlemeyi Kapat' : 'Maddeleri DÃ¼zenle'}
                            </button>
                            ${checklistEditMode ? `<span id="editedItemsCount" style="display:none;padding:4px 10px;background:#f39c12;color:#fff;border-radius:12px;font-size:.75rem">0 deÄŸiÅŸiklik</span>` : ''}
                        </div>
                        ${checklistEditMode ? `
                        <div style="display:flex;gap:8px;flex-wrap:wrap">
                            <button class="btn btn-sm" style="background:#27ae60;color:#fff;display:flex;align-items:center;gap:4px" onclick="saveAllChecklistItemEdits('${branch}', '${type}')" id="saveEditsBtn">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                                DeÄŸiÅŸiklikleri Kaydet
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="showAddChecklistItemModal()">+ Madde Ekle</button>
                            <button class="btn btn-sm btn-ghost" onclick="selectAllChecklistItems()" style="display:flex;align-items:center;gap:4px">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 12l2 2 4-4"/></svg>
                                TÃ¼mÃ¼nÃ¼ SeÃ§
                            </button>
                            <button class="btn btn-sm btn-ghost" onclick="deselectAllChecklistItems()" style="display:flex;align-items:center;gap:4px">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
                                SeÃ§imi KaldÄ±r
                            </button>
                            <button class="btn btn-sm" style="background:#e74c3c;color:#fff;display:flex;align-items:center;gap:4px" onclick="deleteSelectedChecklistItems('${branch}', '${type}')">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                                SeÃ§ilenleri Sil
                            </button>
                        </div>
                        ` : ''}
                    </div>
                </div>
            ` : ''}
            
            ${!checklistEditMode ? `
                ${!isAssignedToMe && !isSubmitted ? `
                <!-- ERÄ°ÅžÄ°M UYARISI - Bu checklist baÅŸka personele atanmÄ±ÅŸ -->
                <div style="margin-bottom:20px;padding:20px;background:linear-gradient(135deg,rgba(231,76,60,.1),rgba(231,76,60,.05));border:2px solid rgba(231,76,60,.3);border-radius:14px">
                    <div style="display:flex;align-items:flex-start;gap:14px">
                        <div style="width:44px;height:44px;background:rgba(231,76,60,.2);border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0">
                            <svg width="24" height="24" fill="none" stroke="#e74c3c" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/></svg>
                        </div>
                        <div>
                            <div style="font-weight:700;color:#e74c3c;font-size:1rem;margin-bottom:6px">Bu Checklist Size AtanmamÄ±ÅŸ</div>
                            <div style="font-size:.9rem;color:var(--tx2);line-height:1.5">
                                Bu gÃ¶revi <strong>${shiftPersonnel.join(', ')}</strong> dolduracak. 
                                YalnÄ±zca size atanan checklisti doldurabilirsiniz.
                            </div>
                            <div style="margin-top:12px;font-size:.85rem;color:var(--tx3)">
                                <strong>GiriÅŸ yapan:</strong> ${currentUserDisplayName}
                            </div>
                        </div>
                    </div>
                </div>
                ` : ''}
                
                ${!isInTimeWindow && !isSubmitted && !isManager ? `
                <!-- ZAMAN UYARISI - Checklist saatleri dÄ±ÅŸÄ±nda -->
                <div style="margin-bottom:20px;padding:20px;background:linear-gradient(135deg,rgba(243,156,18,.1),rgba(243,156,18,.05));border:2px solid rgba(243,156,18,.3);border-radius:14px">
                    <div style="display:flex;align-items:flex-start;gap:14px">
                        <div style="width:44px;height:44px;background:rgba(243,156,18,.2);border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0">
                            <svg width="24" height="24" fill="none" stroke="#f39c12" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                        </div>
                        <div>
                            <div style="font-weight:700;color:#f39c12;font-size:1rem;margin-bottom:6px">Zaman AralÄ±ÄŸÄ± DÄ±ÅŸÄ±nda</div>
                            <div style="font-size:.9rem;color:var(--tx2);line-height:1.5">
                                ${timeWindowMessage}
                            </div>
                            <div style="margin-top:12px;font-size:.85rem;color:var(--tx3)">
                                Åžu anki saat: ${new Date().toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'})}
                            </div>
                        </div>
                    </div>
                </div>
                ` : ''}
                
                ${isDailyShareable && hasMultiplePersonnel && !isSubmitted ? `
                <!-- GÃ–REV PAYLAÅžIMI PANELI - Otomatik veya Manuel -->
                <div style="margin-bottom:20px;padding:16px;background:linear-gradient(135deg,rgba(0,140,149,.08),rgba(0,140,149,.02));border:1px solid rgba(0,140,149,.2);border-radius:14px">
                    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
                        <div style="display:flex;align-items:center;gap:12px">
                            <div style="width:40px;height:40px;background:rgba(0,140,149,.15);border-radius:10px;display:flex;align-items:center;justify-content:center">
                                <svg width="20" height="20" fill="none" stroke="#008c95" stroke-width="2" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
                            </div>
                            <div>
                                <div style="font-weight:600;color:var(--tx);font-size:.95rem;display:flex;align-items:center;gap:6px">
                                    ${hasDailySharing ? 'âœ“ GÃ¶revler PaylaÅŸÄ±ldÄ±' : 'GÃ¶rev PaylaÅŸÄ±mÄ± Bekleniyor'}
                                    ${hasDailySharing && dailyAssignments?.autoGenerated ? '<span style="font-size:.7rem;padding:2px 6px;background:rgba(39,174,96,.2);color:#27ae60;border-radius:4px">Otomatik</span>' : ''}
                                </div>
                                <div style="font-size:.8rem;color:var(--tx2)">
                                    ${shiftPersonnel.length} personel: ${shiftPersonnel.join(', ')}
                                </div>
                            </div>
                        </div>
                        ${isManager ? `
                        <div style="display:flex;gap:8px">
                            ${hasDailySharing ? `
                                <button class="btn btn-sm btn-ghost" onclick="distributeDailyTasks('${branch}', '${type}', '${date}', window._currentChecklistItems, window._currentShiftPersonnel)" title="GÃ¶revleri yeniden daÄŸÄ±t">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
                                    Yeniden DaÄŸÄ±t
                                </button>
                                <button class="btn btn-sm btn-ghost" onclick="clearDailyTaskAssignments('${branch}', '${type}', '${date}')" style="color:#e74c3c">
                                    PaylaÅŸÄ±mÄ± KaldÄ±r
                                </button>
                            ` : `
                                <button class="btn btn-sm btn-primary" onclick="distributeDailyTasks('${branch}', '${type}', '${date}', window._currentChecklistItems, window._currentShiftPersonnel)">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="margin-right:4px"><path d="M8 7h12M8 12h12M8 17h12M4 7h.01M4 12h.01M4 17h.01"/></svg>
                                    GÃ¶revleri PaylaÅŸtÄ±r
                                </button>
                            `}
                        </div>
                        ` : ''}
                    </div>
                    ${hasDailySharing ? `
                        <div style="margin-top:12px;padding-top:12px;border-top:1px solid rgba(0,140,149,.15);font-size:.8rem;color:var(--tx3)">
                            Her personel sadece kendine atanan maddeleri iÅŸaretleyebilir ${isManager ? 'â€¢ MÃ¼dÃ¼r olarak tÃ¼m maddelere eriÅŸebilirsiniz' : ''}
                        </div>
                    ` : ''}
                </div>
                ` : ''}
                
                <!-- Personel ve Zaman Bilgisi -->
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px">
                    <div style="padding:16px;background:var(--bg3);border-radius:12px">
                        <label class="form-label" style="margin-bottom:8px;display:flex;align-items:center;gap:6px">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                            Sorumlu Personel
                        </label>
                        ${isSubmitted ? `
                            <div style="font-size:1.1rem;font-weight:600;color:var(--tx);padding:8px 0">${submittedData?.personName || '-'}</div>
                            <input type="hidden" id="checklistPersonName" value="${submittedData?.personName || ''}">
                        ` : `
                            <div style="font-size:1.1rem;font-weight:600;color:var(--tx);padding:8px 0">${currentUser?.name || 'Bilinmiyor'}</div>
                            <input type="hidden" id="checklistPersonName" value="${currentUser?.name || 'Bilinmiyor'}">
                            <div style="font-size:.75rem;color:#008c95;margin-top:4px">âœ“ GiriÅŸ yapan kullanÄ±cÄ±</div>
                        `}
                    </div>
                    <div style="padding:16px;background:var(--bg3);border-radius:12px">
                        <label class="form-label" style="margin-bottom:8px;display:flex;align-items:center;gap:6px">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                            Tahmini SÃ¼re
                        </label>
                        <div style="font-size:1.1rem;font-weight:600;color:var(--tx)">${expectedMinutes} dakika</div>
                        <div style="font-size:.75rem;color:var(--tx3)">${displayItemCount} madde${isHaftalik && !isManager ? ' (size atanan)' : ''}</div>
                    </div>
                </div>
                
                <!-- Checklist BaÅŸlat Butonu -->
                <div id="checklistStartOverlay" style="margin-bottom:20px;padding:24px;background:linear-gradient(135deg,rgba(0,140,149,.1),rgba(0,140,149,.03));border:2px dashed rgba(0,140,149,.4);border-radius:16px;text-align:center">
                    <div onclick="startChecklistTimer()" style="width:60px;height:60px;margin:0 auto 16px;background:linear-gradient(135deg,#008c95,#00b4a0);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 24px rgba(0,140,149,.3);cursor:pointer;transition:transform .2s,box-shadow .2s" onmouseover="this.style.transform='scale(1.1)';this.style.boxShadow='0 12px 32px rgba(0,140,149,.5)'" onmouseout="this.style.transform='scale(1)';this.style.boxShadow='0 8px 24px rgba(0,140,149,.3)'">
                        <svg width="28" height="28" fill="none" stroke="#fff" stroke-width="2.5" viewBox="0 0 24 24">
                            <polygon points="5 3 19 12 5 21 5 3"/>
                        </svg>
                    </div>
                    <div style="font-size:1.1rem;font-weight:700;color:var(--tx);margin-bottom:8px">Checklist'i BaÅŸlatmaya HazÄ±r</div>
                    <div style="font-size:.85rem;color:var(--tx2);margin-bottom:20px">BaÅŸlat butonuna tÄ±klayÄ±nca sÃ¼re sayacÄ± baÅŸlayacak</div>
                    <button onclick="startChecklistTimer()" style="padding:14px 48px;background:linear-gradient(135deg,#008c95,#00a89d);color:#fff;border:none;border-radius:12px;font-size:1rem;font-weight:600;cursor:pointer;box-shadow:0 4px 16px rgba(0,140,149,.4);transition:all .2s">
                        <span style="display:flex;align-items:center;gap:8px;justify-content:center">
                            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                            Checklist'i BaÅŸlat
                        </span>
                    </button>
                </div>
                
                <!-- BaÅŸlangÄ±Ã§ ZamanÄ± Banner (BaÅŸlatÄ±nca gÃ¶rÃ¼nÃ¼r) -->
                <div id="checklistTimerBanner" style="display:none;margin-bottom:16px;padding:16px 20px;background:linear-gradient(135deg,rgba(0,140,149,.15),rgba(0,140,149,.05));border:1px solid rgba(0,140,149,.3);border-radius:14px">
                    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
                        <div style="display:flex;align-items:center;gap:10px">
                            <div style="width:10px;height:10px;background:#27ae60;border-radius:50%;animation:pulse 1.5s infinite"></div>
                            <span style="font-weight:600;color:var(--tx)">Checklist Aktif</span>
                            <span style="font-size:.8rem;color:var(--tx3)">|</span>
                            <span style="font-size:.85rem;color:var(--tx2)">ðŸ• <span id="checklistLiveTime">--:--:--</span></span>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;background:rgba(0,140,149,.2);padding:8px 16px;border-radius:10px">
                            <svg width="18" height="18" fill="none" stroke="#008c95" stroke-width="2" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                            <span id="checklistElapsedTime" style="font-size:1.2rem;font-weight:700;color:#008c95;font-family:monospace;letter-spacing:1px">00:00:00</span>
                        </div>
                    </div>
                </div>
                
                <style>@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}</style>
            ` : ''}
            
            <div id="checklistItemsWrapper" style="${!isSubmitted && !checklistEditMode ? 'filter:blur(4px);opacity:0.6;pointer-events:none;transition:all .3s ease' : ''}">
            <div id="checklistItems">
    `;
    
    // Item'larÄ± render et
    filteredItems.forEach((item, index) => {
        const isChecked = submittedData?.items?.find(i => i.id === item.id)?.checked;
        const isNotDone = submittedData?.items?.find(i => i.id === item.id)?.notDone;
        const itemNum = index + 1;
        
        // Renk bilgisi
        const responsibleLabel = item.responsible || '';
        const itemColor = item.color || '#6b7280';
        const hasColor = isAylik && responsibleLabel;
        
        // GÃ¶rev atamasÄ± kontrolÃ¼ (haftalÄ±k veya gÃ¼nlÃ¼k)
        let assignedPersonel = '';
        let isMyTask = true; // VarsayÄ±lan: herkese aÃ§Ä±k
        let cooldownStatus = null; // HaftalÄ±k iÃ§in cooldown durumu
        
        if (isHaftalik && weeklyAssignments?.rawAssignments) {
            // HaftalÄ±k gÃ¶revler - yeni sistem (personnelId ile eÅŸleÅŸtir)
            const assignment = weeklyAssignments.rawAssignments.find(a => a.itemId === item.id);
            assignedPersonel = assignment?.personnelName || weeklyAssignments.assignments?.[item.id] || '';
            
            if (assignment && !isManager) {
                // Personel doc ID ile eÅŸleÅŸtir
                const currentPersonnelId = currentUser?.personelId || currentUser?.uniqueId || currentUser?.id;
                isMyTask = assignment.personnelId === currentPersonnelId;
                
                // Cooldown durumu
                cooldownStatus = getItemCooldownStatus(assignment);
            }
        } else if (isHaftalik && weeklyAssignments?.assignments) {
            // Eski format uyumluluÄŸu
            assignedPersonel = weeklyAssignments.assignments[item.id] || '';
            if (assignedPersonel && !isManager) {
                const currentUserDisplayName = getPersonelDisplayName(currentUser) || currentUser?.name || '';
                isMyTask = assignedPersonel.toLowerCase() === currentUserDisplayName.toLowerCase() ||
                           assignedPersonel.split(' ')[0]?.toLowerCase() === currentUserDisplayName.split(' ')[0]?.toLowerCase();
            }
        } else if (hasDailySharing && dailyAssignments?.assignments) {
            // GÃ¼nlÃ¼k checkler (aÃ§Ä±lÄ±ÅŸ, kapanÄ±ÅŸ, gÃ¼nlÃ¼k)
            assignedPersonel = dailyAssignments.assignments[item.id] || '';
            if (assignedPersonel && !isManager) {
                const currentUserDisplayName = getPersonelDisplayName(currentUser) || currentUser?.name || '';
                isMyTask = assignedPersonel.toLowerCase() === currentUserDisplayName.toLowerCase() ||
                           assignedPersonel.split(' ')[0]?.toLowerCase() === currentUserDisplayName.split(' ')[0]?.toLowerCase();
            }
        } else if (isAylik && shiftPersonnel && shiftPersonnel.length > 0) {
            // Temizlik ve BakÄ±m iÃ§in - shift personeline round-robin ile daÄŸÄ±t
            const personIndex = index % shiftPersonnel.length;
            assignedPersonel = shiftPersonnel[personIndex];
            
            // isMyTask kontrolÃ¼
            if (assignedPersonel && !isManager) {
                const currentUserDisplayName = getPersonelDisplayName(currentUser) || currentUser?.name || '';
                isMyTask = assignedPersonel.toLowerCase() === currentUserDisplayName.toLowerCase() ||
                           assignedPersonel.split(' ')[0]?.toLowerCase() === currentUserDisplayName.split(' ')[0]?.toLowerCase();
            }
        }
        
        // Tarih bilgisi
        const hasDates = item.dates && item.dates.length > 0;
        
        // Tarih kutucuklarÄ± HTML
        let datesHtml = '';
        if (isAylik) {
            if (hasDates) {
                // Tarihler beyaz arka planlÄ± kutucuklarda
                datesHtml = '<div style="display:flex;gap:4px;flex-wrap:wrap">' +
                    item.dates.map(d => 
                        '<span style="min-width:26px;height:24px;display:inline-flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700;background:rgba(255,255,255,.9);color:#1e293b;border-radius:5px;box-shadow:0 1px 2px rgba(0,0,0,.1)">' + d + '</span>'
                    ).join('') +
                '</div>';
            } else {
                // Her gÃ¼n
                datesHtml = '<span style="font-size:.8rem;padding:4px 12px;border-radius:5px;background:rgba(255,255,255,.9);color:#1e293b;font-weight:600;box-shadow:0 1px 2px rgba(0,0,0,.1)">Her gÃ¼n</span>';
            }
        }
        
        // Cooldown badge (haftalÄ±k iÃ§in)
        let cooldownBadgeHtml = '';
        if (isHaftalik && cooldownStatus) {
            if (cooldownStatus.status === 'pending_countdown') {
                // YapÄ±lmayÄ± bekliyor - geri sayÄ±m gÃ¶ster
                cooldownBadgeHtml = `
                    <span style="font-size:.75rem;padding:4px 10px;border-radius:5px;background:rgba(0,140,149,0.15);color:#008c95;font-weight:600;display:inline-flex;align-items:center;gap:4px">
                        <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                        â³ ${cooldownStatus.message}
                    </span>
                `;
            } else if (cooldownStatus.status === 'overdue') {
                // SÃ¼resi dolmuÅŸ!
                cooldownBadgeHtml = `
                    <span style="font-size:.75rem;padding:4px 10px;border-radius:5px;background:rgba(239,68,68,0.15);color:#ef4444;font-weight:600;display:inline-flex;align-items:center;gap:4px">
                        <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/></svg>
                        âš ï¸ ${cooldownStatus.message}
                    </span>
                `;
            } else if (cooldownStatus.status === 'cooldown') {
                // TamamlanmÄ±ÅŸ, cooldown'da
                cooldownBadgeHtml = `
                    <span style="font-size:.75rem;padding:4px 10px;border-radius:5px;background:rgba(39,174,96,0.15);color:#27ae60;font-weight:600;display:inline-flex;align-items:center;gap:4px">
                        <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                        âœ… ${cooldownStatus.message}
                    </span>
                `;
            } else if (cooldownStatus.status === 'active' && cooldownStatus.message === 'Tekrar yapÄ±labilir') {
                // Cooldown bitti, tekrar aktif
                cooldownBadgeHtml = `
                    <span style="font-size:.75rem;padding:4px 10px;border-radius:5px;background:rgba(243,156,18,0.15);color:#f39c12;font-weight:600;display:inline-flex;align-items:center;gap:4px">
                        ðŸ”„ Tekrar yapÄ±labilir
                    </span>
                `;
            }
        }
        
        // GÃ¶rev atama badge (haftalÄ±k veya gÃ¼nlÃ¼k paylaÅŸÄ±m)
        let assignedBadgeHtml = '';
        if (assignedPersonel) {
            // Marka renkli dolgulu badge - okunabilir
            let badgeBg = isMyTask ? '#008c95' : '#6b7280';
            let badgeColor = '#fff';
            
            // HaftalÄ±k iÃ§in cooldown durumuna gÃ¶re badge rengi
            if (isHaftalik && cooldownStatus?.status === 'cooldown') {
                badgeBg = '#9ca3af'; // Gri - cooldown'da
            } else if (isHaftalik && cooldownStatus?.status === 'completed') {
                badgeBg = '#27ae60'; // YeÅŸil - tamamlanmÄ±ÅŸ
            }
            
            // Atama deÄŸiÅŸtirme butonu iÃ§in doÄŸru fonksiyon
            let editOnClick = '';
            if (isManager && !isSubmitted) {
                if (isHaftalik) {
                    const weekStart = formatDateLocal(getWeekStart(new Date(date)));
                    editOnClick = `showTaskAssignmentModal('${item.id}', '${item.text.replace(/'/g, "\\'")}', '${assignedPersonel}', '${branch}', '${weekStart}')`;
                } else if (hasDailySharing) {
                    editOnClick = `showDailyTaskAssignmentModal('${item.id}', '${item.text.replace(/'/g, "\\'")}', '${assignedPersonel}', '${branch}', '${type}', '${date}')`;
                }
            }
            
            assignedBadgeHtml = `
                <span style="font-size:.85rem;padding:5px 12px;border-radius:6px;background:${badgeBg};color:${badgeColor};font-weight:600;display:inline-flex;align-items:center;gap:6px">
                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    ${assignedPersonel}
                    ${editOnClick ? `<span onclick="${editOnClick}" style="cursor:pointer;opacity:.7;margin-left:4px" title="DeÄŸiÅŸtir">âœï¸</span>` : ''}
                </span>
                ${cooldownBadgeHtml}
            `;
        }
        
        // HaftalÄ±k gÃ¶revler iÃ§in gÃ¼n badge'i
        let dayOfWeekBadgeHtml = '';
        const DAY_NAMES_SHORT = ['Pzt', 'Sal', 'Ã‡ar', 'Per', 'Cum', 'Cmt', 'Paz'];
        const DAY_COLORS = ['#3498db', '#9b59b6', '#e74c3c', '#f39c12', '#27ae60', '#1abc9c', '#e91e63'];
        
        if (isHaftalik && item.dayOfWeek && item.dayOfWeek.length > 0) {
            const dayBadges = item.dayOfWeek.map(d => {
                const dayName = DAY_NAMES_SHORT[d] || '?';
                const dayColor = DAY_COLORS[d] || '#6b7280';
                return `<span style="font-size:.7rem;padding:3px 8px;border-radius:4px;background:${dayColor};color:#fff;font-weight:600">${dayName}</span>`;
            }).join('');
            
            dayOfWeekBadgeHtml = `<div style="display:flex;gap:4px;flex-wrap:wrap">${dayBadges}</div>`;
        } else if (isHaftalik) {
            // GÃ¼n belirtilmemiÅŸse "Her gÃ¼n" badge'i gÃ¶sterme (opsiyonel)
        }
        
        if (checklistEditMode) {
            // DÃ¼zenleme modu - INLINE TEXT EDITING + SÃœRÃœKLE BIRAK
            html += `
                <div class="checklist-item" data-item-id="${item.id}" data-order="${index}" draggable="true"
                    ondragstart="dragStart(event)" ondragover="dragOver(event)" ondrop="dropItem(event)" ondragend="dragEnd(event)"
                    style="display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:10px;margin-bottom:8px;background:${hasColor ? itemColor : 'var(--bg2)'};box-shadow:0 2px 6px rgba(0,0,0,.08);cursor:grab;transition:transform .2s, opacity .2s">
                    
                    <!-- SÃ¼rÃ¼kle Tutacak + Numara -->
                    <div class="drag-handle" style="display:flex;align-items:center;gap:6px;cursor:grab;opacity:.7;flex-shrink:0">
                        <svg width="14" height="14" fill="${hasColor ? 'rgba(255,255,255,.6)' : 'var(--tx3)'}" viewBox="0 0 24 24">
                            <circle cx="8" cy="6" r="2"/><circle cx="16" cy="6" r="2"/>
                            <circle cx="8" cy="12" r="2"/><circle cx="16" cy="12" r="2"/>
                            <circle cx="8" cy="18" r="2"/><circle cx="16" cy="18" r="2"/>
                        </svg>
                        <span style="font-size:.9rem;font-weight:700;color:${hasColor ? 'rgba(255,255,255,.9)' : 'var(--tx2)'};min-width:20px">${itemNum}</span>
                    </div>
                    
                    <input type="checkbox" class="checklist-select-item" value="${item.id}" style="width:18px;height:18px;cursor:pointer;accent-color:#008c95;flex-shrink:0">
                    
                    <!-- INLINE TEXT EDITING -->
                    <textarea class="checklist-item-text-edit" data-item-id="${item.id}" 
                        style="flex:1;padding:8px 10px;border:1px solid ${hasColor ? 'rgba(255,255,255,.3)' : 'var(--bg4)'};border-radius:8px;background:${hasColor ? 'rgba(255,255,255,.95)' : 'var(--bg)'};color:var(--tx);font-size:.9rem;line-height:1.4;font-weight:500;resize:none;min-height:36px;max-height:80px"
                        oninput="markChecklistItemEdited('${item.id}');this.style.height='auto';this.style.height=this.scrollHeight+'px'">${item.text}</textarea>
                    
                    <!-- Sil Butonu -->
                    <button onclick="deleteChecklistItem('${item.id}')" style="background:rgba(231,76,60,.15);border:none;color:#e74c3c;cursor:pointer;padding:6px;border-radius:6px;flex-shrink:0" title="Sil">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                    </button>
                </div>
            `;
        } else {
            // Normal mod - TAM DOLGU RENGÄ°
            const canEdit = ['yonetici', 'bolge_muduru', 'magaza_muduru'].includes(currentUser?.role);
            // EriÅŸim kontrolÃ¼ - isSubmitted veya atanmamÄ±ÅŸsa disable
            // HaftalÄ±k gÃ¶revlerde: isMyTask kontrolÃ¼ + cooldown kontrolÃ¼, diÄŸerlerinde: isAssignedToMe kontrolÃ¼
            // HaftalÄ±k ve temizlik: isMyTask, diÄŸerleri: isAssignedToMe + zaman kontrolÃ¼
            
            // HaftalÄ±k iÃ§in cooldown kontrolÃ¼ - sadece "cooldown" durumunda interact edilemez
            // pending_countdown, overdue, active durumlarÄ±nda gÃ¶rev yapÄ±labilir
            let isCooldownActive = false;
            if (isHaftalik && cooldownStatus) {
                isCooldownActive = cooldownStatus.status === 'cooldown';
            }
            
            const canInteract = ((isHaftalik || isAylik) ? (isMyTask && !isCooldownActive) : (isAssignedToMe && isInTimeWindow)) && !isSubmitted;
            
            // BaÅŸkasÄ±nÄ±n gÃ¶revi ise veya cooldown'da ise uyarÄ± mesajÄ±
            let warningMessage = '';
            if (!isMyTask && assignedPersonel && (isAylik || isHaftalik) && !isManager && !isSubmitted) {
                warningMessage = `<div style="font-size:.75rem;color:#f59e0b;margin-top:6px;display:flex;align-items:center;gap:4px">
                    <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/></svg>
                    Bu maddeyi <strong style="margin:0 3px">${assignedPersonel}</strong> dolduracak
                   </div>`;
            } else if (isCooldownActive && isMyTask && cooldownStatus?.message) {
                warningMessage = `<div style="font-size:.75rem;color:#27ae60;margin-top:6px;display:flex;align-items:center;gap:4px">
                    <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                    âœ… TamamlandÄ± Â· ${cooldownStatus.message}
                   </div>`;
            } else if (isHaftalik && cooldownStatus?.status === 'overdue' && isMyTask) {
                // SÃ¼resi dolmuÅŸ uyarÄ±sÄ±
                warningMessage = `<div style="font-size:.75rem;color:#ef4444;margin-top:6px;display:flex;align-items:center;gap:4px">
                    <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/></svg>
                    âš ï¸ SÃ¼resi doldu! Hemen tamamlayÄ±n.
                   </div>`;
            }
            const otherPersonWarning = warningMessage;
            
            html += `
                <div class="checklist-item" data-item-id="${item.id}" style="display:flex;align-items:flex-start;gap:10px;padding:12px 14px;border-radius:12px;margin-bottom:10px;background:${hasColor ? itemColor : 'var(--bg2)'};box-shadow:0 2px 8px rgba(0,0,0,.08);${!canInteract ? 'opacity:0.7;' : ''}">
                    <!-- Madde NumarasÄ± -->
                    <div style="min-width:24px;height:24px;background:${hasColor ? 'rgba(255,255,255,.2)' : 'var(--bg3)'};border-radius:6px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.8rem;color:${hasColor ? 'rgba(255,255,255,.9)' : 'var(--tx2)'};flex-shrink:0">${itemNum}</div>
                    
                    <div style="display:flex;flex-direction:row;gap:6px;flex-shrink:0">
                        <label style="cursor:${canInteract ? 'pointer' : 'default'}">
                            <input type="radio" name="check_${item.id}" value="done" ${isChecked ? 'checked' : ''} ${!canInteract ? 'disabled' : ''} style="display:none">
                            <span class="check-btn done" onclick="${canInteract ? `selectCheckOption(this, '${item.id}', 'done')` : ''}"
                                style="width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;
                                background:${isChecked ? '#22c55e' : 'rgba(255,255,255,.95)'};
                                border:2px solid ${isChecked ? '#22c55e' : 'rgba(34,197,94,.4)'};
                                color:${isChecked ? '#fff' : '#22c55e'};
                                transition:all .15s;font-weight:bold;cursor:${canInteract ? 'pointer' : 'not-allowed'};box-shadow:0 1px 4px rgba(0,0,0,.08)">âœ“</span>
                        </label>
                        <label style="cursor:${canInteract ? 'pointer' : 'default'}">
                            <input type="radio" name="check_${item.id}" value="notdone" ${isNotDone ? 'checked' : ''} ${!canInteract ? 'disabled' : ''} style="display:none">
                            <span class="check-btn notdone" onclick="${canInteract ? `selectCheckOption(this, '${item.id}', 'notdone')` : ''}"
                                style="width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;
                                background:${isNotDone ? '#ef4444' : 'rgba(255,255,255,.95)'};
                                border:2px solid ${isNotDone ? '#ef4444' : 'rgba(239,68,68,.4)'};
                                color:${isNotDone ? '#fff' : '#ef4444'};
                                transition:all .15s;font-weight:bold;cursor:${canInteract ? 'pointer' : 'not-allowed'};box-shadow:0 1px 4px rgba(0,0,0,.08)">âœ—</span>
                        </label>
                    </div>
                    <div style="flex:1;min-width:0">
                        <div style="font-size:.9rem;color:${hasColor ? '#fff' : 'var(--tx)'};line-height:1.5;font-weight:500">
                            ${assignedPersonel ? `<span style="font-size:.8rem;padding:2px 8px;border-radius:4px;background:${isMyTask ? '#008c95' : '#6b7280'};color:#fff;font-weight:600;margin-right:6px">${assignedPersonel}</span>` : ''}${item.text}
                        </div>
                        <div style="display:flex;align-items:center;gap:6px;margin-top:6px;flex-wrap:wrap">
                            ${hasColor ? `<span style="font-size:.75rem;padding:3px 10px;border-radius:5px;background:rgba(255,255,255,.9);color:${itemColor};font-weight:600">${responsibleLabel}</span>` : ''}
                            ${cooldownBadgeHtml}
                            ${dayOfWeekBadgeHtml}
                            ${datesHtml}
                        </div>
                        ${otherPersonWarning}
                    </div>
                    ${canEdit && !isSubmitted ? `
                    <button onclick="showEditChecklistItemModal('${item.id}')" style="background:rgba(0,140,149,.1);border:none;color:#008c95;cursor:pointer;padding:6px;border-radius:6px;flex-shrink:0;transition:all .2s" title="DÃ¼zenle" onmouseover="this.style.background='rgba(0,140,149,.2)'" onmouseout="this.style.background='rgba(0,140,149,.1)'">
                        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                    </button>
                    ` : ''}
                </div>
            `;
        }
    });
    
    html += `
            </div>
            </div>
            
            ${!checklistEditMode && !isSubmitted && canFillForm ? `
                <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end">
                    <button class="btn btn-ghost" onclick="loadChecklist()" style="display:flex;align-items:center;gap:6px">
                        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
                        Yenile
                    </button>
                    <button class="btn btn-primary" onclick="submitChecklist('${branch}', '${type}', '${date}', '${timeSlot || ''}')" style="display:flex;align-items:center;gap:6px">
                        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
                        Checklist'i Tamamla
                    </button>
                </div>
            ` : ''}
            ${!checklistEditMode && !isSubmitted && !canFillForm ? `
                <div style="margin-top:24px;text-align:center;padding:20px;background:var(--bg3);border-radius:12px">
                    <div style="color:var(--tx3);font-size:.9rem">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="vertical-align:middle;margin-right:6px;opacity:.6"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
                        ${!isAssignedToMe ? 'Bu checklist size atanmamÄ±ÅŸ' : !isInTimeWindow ? 'Zaman aralÄ±ÄŸÄ± dÄ±ÅŸÄ±nda' : 'Bu checklist\'i doldurulamaz'}
                    </div>
                </div>
            ` : ''}
            ${!checklistEditMode && isSubmitted ? `
                <div style="margin-top:24px;text-align:center;color:var(--tx2)">
                    Bu checklist zaten tamamlanmÄ±ÅŸ
                </div>
            ` : ''}
            ${checklistEditMode ? `
                <div style="margin-top:24px;text-align:center">
                    <div style="font-size:.85rem;color:var(--tx2)">Toplam ${filteredItems.length} madde</div>
                </div>
            ` : ''}
        </div>
    `;
    
    container.innerHTML = html;
}

// Temizlik ve BakÄ±m - Hepsini/BugÃ¼nÃ¼ GÃ¶ster toggle
function toggleShowAllAylikItems() {
    showAllAylikItems = !showAllAylikItems;
    loadChecklist();
}

// DÃ¼zenleme modunu aÃ§/kapat
function toggleChecklistEditMode(branch, type, date, timeSlot) {
    checklistEditMode = !checklistEditMode;
    editedChecklistItems = new Set(); // DeÄŸiÅŸiklik takibini sÄ±fÄ±rla
    loadChecklist();
}

// ==================== INLINE EDITING ====================
let editedChecklistItems = new Set();

function markChecklistItemEdited(itemId) {
    editedChecklistItems.add(itemId);
    const countEl = document.getElementById('editedItemsCount');
    if (countEl) {
        countEl.style.display = 'inline-block';
        countEl.textContent = `${editedChecklistItems.size} deÄŸiÅŸiklik`;
    }
}

async function saveAllChecklistItemEdits(branch, type) {
    const textareas = document.querySelectorAll('.checklist-item-text-edit');
    if (textareas.length === 0) {
        toast('DÃ¼zenlenecek madde bulunamadÄ±', 'warning');
        return;
    }
    
    // Type ID mapping
    const TYPE_ID_MAP = {
        'guncel': 'guncel', 'gunluk': 'guncel',
        'aylik_temizlik': 'aylik', 'temizlik': 'aylik'
    };
    const mappedType = TYPE_ID_MAP[type] || type;
    const checklistId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_${mappedType}`;
    
    // Mevcut dokÃ¼manÄ± Ã§ek
    try {
        const doc = await db.collection('checklists').doc(checklistId).get();
        if (!doc.exists) {
            toast('Checklist bulunamadÄ±', 'error');
            return;
        }
        
        const data = doc.data();
        let items = data.items || [];
        let updateCount = 0;
        
        // Her textarea'dan deÄŸerleri al ve gÃ¼ncelle
        textareas.forEach(textarea => {
            const itemId = textarea.dataset.itemId;
            const newText = textarea.value.trim();
            
            const itemIndex = items.findIndex(i => i.id === itemId);
            if (itemIndex > -1 && items[itemIndex].text !== newText) {
                items[itemIndex].text = newText;
                updateCount++;
            }
        });
        
        if (updateCount === 0) {
            toast('DeÄŸiÅŸiklik yok', 'info');
            return;
        }
        
        // Firebase'e kaydet
        await db.collection('checklists').doc(checklistId).update({
            items: items,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        editedChecklistItems.clear();
        const countEl = document.getElementById('editedItemsCount');
        if (countEl) countEl.style.display = 'none';
        
        toast(`${updateCount} madde gÃ¼ncellendi`, 'success');
        
        // Edit mode'u kapat ve sayfayÄ± yenile
        checklistEditMode = false;
        loadChecklist();
        
    } catch (e) {
        console.error('Kaydetme hatasÄ±:', e);
        toast('Kaydetme hatasÄ±: ' + e.message, 'error');
    }
}

// ==================== VERÄ° MÄ°GRASYON VE DÃœZELTME ====================

/**
 * MASTER FIX: TÃ¼m personel ve shift verilerini dÃ¼zelt
 * - Her personele uniqueId ekle
 * - Shift key'lerini uniqueId formatÄ±na Ã§evir
 * - personelFullNames ve personelNames gÃ¼ncelle
 */
async function runDataMigration() {
    if (!confirm('âš ï¸ VERÄ° MÄ°GRASYONU\n\nBu iÅŸlem tÃ¼m personel ve shift verilerini dÃ¼zeltecek.\nDevam etmek istiyor musunuz?')) return;
    
    const log = (msg) => console.log(`[Migration] ${msg}`);
    log('BaÅŸlÄ±yor...');
    
    try {
        // 1. TÃœM PERSONELÄ° Ã‡EK VE uniqueId EKLE
        const personelSnap = await db.collection('personel').get();
        const personelMap = new Map(); // uniqueId -> {name, codeName, branch, docId}
        
        for (const doc of personelSnap.docs) {
            const data = doc.data();
            const uniqueId = normalizePersonelId(data.name);
            const codeName = data.codeName || formatDisplayName(data.name);
            
            // uniqueId yoksa veya farklÄ±ysa gÃ¼ncelle
            if (data.uniqueId !== uniqueId || !data.codeName) {
                await db.collection('personel').doc(doc.id).update({
                    uniqueId: uniqueId,
                    codeName: codeName
                });
                log(`Personel gÃ¼ncellendi: ${data.name} -> uniqueId: ${uniqueId}, codeName: ${codeName}`);
            }
            
            personelMap.set(uniqueId, {
                name: data.name,
                codeName: codeName,
                branch: data.branch,
                docId: doc.id,
                role: data.role
            });
        }
        log(`${personelMap.size} personel iÅŸlendi`);
        
        // 2. TÃœM SHIFT'LERÄ° DÃœZELT
        const shiftsSnap = await db.collection('shifts').get();
        let shiftFixCount = 0;
        
        for (const doc of shiftsSnap.docs) {
            const shift = doc.data();
            const branch = shift.branch;
            
            if (!shift.personelShifts) continue;
            
            const newPersonelShifts = {};
            const newPersonelOrder = [];
            const newPersonelNames = {};
            const newPersonelFullNames = {};
            
            // Mevcut key'leri uniqueId'ye Ã§evir
            for (const [oldKey, days] of Object.entries(shift.personelShifts)) {
                // oldKey'den personeli bul
                let matchedPersonel = null;
                let matchedUniqueId = null;
                
                // Direkt uniqueId eÅŸleÅŸmesi
                if (personelMap.has(oldKey)) {
                    matchedPersonel = personelMap.get(oldKey);
                    matchedUniqueId = oldKey;
                } else {
                    // Ä°sim bazlÄ± arama
                    const normalizedOldKey = normalizeTurkishChars(oldKey.replace(/_/g, ' ').toLowerCase());
                    
                    for (const [uid, p] of personelMap.entries()) {
                        const normalizedName = normalizeTurkishChars(p.name.toLowerCase());
                        const normalizedCodeName = normalizeTurkishChars((p.codeName || '').toLowerCase());
                        const firstName = normalizeTurkishChars(p.name.split(' ')[0].toLowerCase());
                        
                        if (normalizedName === normalizedOldKey ||
                            normalizedCodeName === normalizedOldKey ||
                            firstName === normalizedOldKey ||
                            uid === normalizedOldKey) {
                            matchedPersonel = p;
                            matchedUniqueId = uid;
                            break;
                        }
                    }
                }
                
                if (matchedPersonel && matchedUniqueId) {
                    // AynÄ± branch veya bÃ¶lge mÃ¼dÃ¼rÃ¼ ise ekle
                    if (matchedPersonel.branch === branch || matchedPersonel.branch === 'all' || matchedPersonel.role === 'bolge_muduru') {
                        newPersonelShifts[matchedUniqueId] = days;
                        newPersonelOrder.push(matchedUniqueId);
                        newPersonelNames[matchedUniqueId] = matchedPersonel.codeName;
                        newPersonelFullNames[matchedUniqueId] = matchedPersonel.name;
                    }
                } else {
                    log(`âš ï¸ EÅŸleÅŸme bulunamadÄ±: ${oldKey} (branch: ${branch})`);
                }
            }
            
            // Shift'te olmayan ama bu branch'teki personeli ekle
            for (const [uid, p] of personelMap.entries()) {
                if ((p.branch === branch || p.role === 'bolge_muduru') && !newPersonelShifts[uid]) {
                    newPersonelShifts[uid] = {};
                    newPersonelOrder.push(uid);
                    newPersonelNames[uid] = p.codeName;
                    newPersonelFullNames[uid] = p.name;
                    log(`Eksik personel eklendi: ${p.name} (${uid}) -> ${branch}`);
                }
            }
            
            // RÃœTBEYE GÃ–RE SIRALA
            const roleOrder = ['bolge_muduru', 'magaza_muduru', 'magaza_mudur_yardimcisi', 'kidemli_barista', 'barista', 'part_time'];
            newPersonelOrder.sort((a, b) => {
                const aRole = personelMap.get(a)?.role || 'barista';
                const bRole = personelMap.get(b)?.role || 'barista';
                const aIdx = roleOrder.indexOf(aRole);
                const bIdx = roleOrder.indexOf(bRole);
                return (aIdx === -1 ? 100 : aIdx) - (bIdx === -1 ? 100 : bIdx);
            });
            
            // GÃ¼ncelle
            await db.collection('shifts').doc(doc.id).update({
                personelShifts: newPersonelShifts,
                personelOrder: newPersonelOrder,
                personelNames: newPersonelNames,
                personelFullNames: newPersonelFullNames,
                migratedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            shiftFixCount++;
            log(`Shift dÃ¼zeltildi: ${branch} - ${shift.weekStart}`);
        }
        
        log(`âœ… MÄ°GRASYON TAMAMLANDI: ${personelMap.size} personel, ${shiftFixCount} shift`);
        toast(`Migrasyon tamamlandÄ±! ${personelMap.size} personel, ${shiftFixCount} shift dÃ¼zeltildi.`, 'success');
        
        // Cache'i temizle
        clearPersonelDisplayCache();
        _migrationPersonelMap = null;
        
        // SayfayÄ± yenile
        setTimeout(() => location.reload(), 2000);
        
    } catch (e) {
        console.error('Migrasyon hatasÄ±:', e);
        toast('Migrasyon hatasÄ±: ' + e.message, 'error');
    }
}

/**
 * Debug: Personel ve Shift verilerini konsola yazdÄ±r
 */
async function debugPersonelShiftData() {
    console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
    console.log('â•‘              MOONBERRY Ä°K - DEBUG RAPORU v2.0                  â•‘');
    console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    
    // 1. CHECK RULES
    console.log('\nðŸ“‹ CHECK_RULES DURUMU:');
    console.log('--------------------------------------------------');
    Object.entries(CHECK_RULES).forEach(([type, rules]) => {
        const pts = rules.points || {};
        console.log(`${type}: onTime=${pts.onTime || pts.done || 0}, late=${pts.late || 0}, missed=${pts.missed || 0}`);
    });
    
    // 2. PERSONEL VERÄ°LERÄ°
    console.log('\nðŸ‘¥ PERSONEL VERÄ°LERÄ°:');
    console.log('--------------------------------------------------');
    const personelSnap = await db.collection('personel').get();
    const personelList = [];
    personelSnap.forEach(doc => {
        const d = doc.data();
        personelList.push({ name: d.name, uniqueId: d.uniqueId, codeName: d.codeName, role: d.role, branch: d.branch });
        console.log(`${d.name} | ID: ${d.uniqueId || 'YOK'} | Code: ${d.codeName || 'YOK'} | Rol: ${d.role} | Åžube: ${d.branch}`);
    });
    
    // 3. SHIFT VERÄ°LERÄ°
    console.log('\nðŸ“… SHIFT VERÄ°LERÄ°:');
    console.log('--------------------------------------------------');
    const shiftsSnap = await db.collection('shifts').get();
    shiftsSnap.forEach(doc => {
        const s = doc.data();
        console.log(`\n${s.branch} - ${s.weekStart}:`);
        console.log('  personelShifts keys:', Object.keys(s.personelShifts || {}).join(', '));
        console.log('  personelNames:', JSON.stringify(s.personelNames || {}));
    });
    
    // 4. PUANTAJ NOTLARI (Bu ay)
    console.log('\nðŸ’¯ PUANTAJ NOTLARI (Bu Ay):');
    console.log('--------------------------------------------------');
    const now = new Date();
    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
    const monthStartStr = formatDateLocal(monthStart);
    
    try {
        const notesSnap = await db.collection('puantajNotes')
            .where('date', '>=', monthStartStr)
            .get();
        
        const notesByPerson = {};
        notesSnap.forEach(doc => {
            const d = doc.data();
            const name = d.personelName || 'Bilinmiyor';
            if (!notesByPerson[name]) notesByPerson[name] = { total: 0, count: 0 };
            notesByPerson[name].total += (d.points || 0);
            notesByPerson[name].count++;
        });
        
        console.log(`Toplam ${notesSnap.size} kayÄ±t bulundu:`);
        Object.entries(notesByPerson)
            .sort((a,b) => b[1].total - a[1].total)
            .forEach(([name, data]) => {
                console.log(`  ${name}: ${data.count} check, ${data.total} puan`);
            });
        
        if (notesSnap.size === 0) {
            console.log('âš ï¸ Bu ay hiÃ§ puantaj notu yok!');
        }
    } catch (e) {
        console.error('âŒ puantajNotes eriÅŸim hatasÄ±:', e.message);
    }
    
    // 5. BUGÃœNKÃœ CHECKLER
    console.log('\nðŸ“Š BUGÃœNKÃœ CHECKLER:');
    console.log('--------------------------------------------------');
    const todayStr = formatDateLocal(new Date());
    try {
        const todayChecks = await db.collection('checklistSubmissions')
            .where('date', '==', todayStr)
            .get();
        
        console.log(`BugÃ¼n ${todayChecks.size} check dolduruldu:`);
        todayChecks.forEach(doc => {
            const d = doc.data();
            console.log(`  [${d.type}] ${d.personName} - ${d.branch} - Puan: ${d.points || 'YOK'}`);
        });
    } catch (e) {
        console.error('âŒ BugÃ¼nkÃ¼ checkler alÄ±namadÄ±:', e.message);
    }
    
    // 6. SÄ°STEM DURUMU
    console.log('\nâš™ï¸ SÄ°STEM DURUMU:');
    console.log('--------------------------------------------------');
    console.log(`Åžubeler: ${(STATE.branches || []).join(', ')}`);
    console.log(`GiriÅŸ yapan: ${currentUser?.name || 'YOK'} (${currentUser?.role || 'rol yok'})`);
    console.log(`SYSTEM_CONFIG loaded: ${Object.keys(SYSTEM_CONFIG || {}).length > 0 ? 'EVET' : 'HAYIR'}`);
    console.log(`CHECKLIST_TYPES loaded: ${Object.keys(CHECKLIST_TYPES || {}).length > 0 ? 'EVET' : 'HAYIR'}`);
    
    console.log('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
    console.log('â•‘                    DEBUG RAPORU TAMAMLANDI                     â•‘');
    console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    
    // Toast ile bildir
    toast('Debug raporu konsola yazÄ±ldÄ± (F12)', 'info');
    
    return { personelList, notesByPerson: notesByPerson || {} };
}

/**
 * PUAN SÄ°STEMÄ° DEBUG - Ã–zel Puan KontrolÃ¼
 */
async function debugPuanSistemi() {
    console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
    console.log('â•‘              PUAN SÄ°STEMÄ° DEBUG RAPORU                         â•‘');
    console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    
    // 1. CHECK_RULES KONTROL
    console.log('\n1ï¸âƒ£ CHECK_RULES DURUMU:');
    console.log('--------------------------------------------------');
    const checkTypes = ['guncel', 'gunluk', 'platform', 'acilis', 'kapanis', 'mudur', 'aylik', 'haftalik'];
    checkTypes.forEach(type => {
        const rule = CHECK_RULES[type];
        if (rule) {
            const pts = rule.points || {};
            console.log(`âœ… ${type}: onTime=${pts.onTime || pts.done || 0}, late=${pts.late || 0}, missed=${pts.missed || 0}`);
        } else {
            console.log(`âŒ ${type}: TANIMLI DEÄžÄ°L!`);
        }
    });
    
    // 2. BUGÃœNKÃœ CHECKLER VE PUANLARI
    console.log('\n2ï¸âƒ£ BUGÃœNKÃœ CHECKLER:');
    console.log('--------------------------------------------------');
    const todayStr = formatDateLocal(new Date());
    
    try {
        const checksSnap = await db.collection('checklistSubmissions')
            .where('date', '==', todayStr)
            .get();
        
        checksSnap.forEach(doc => {
            const d = doc.data();
            const hasPoints = d.points !== undefined && d.points !== null;
            const status = hasPoints ? 'âœ…' : 'âš ï¸';
            console.log(`${status} [${d.type}/${d.timeSlot || '-'}] ${d.personName} @ ${d.branch}`);
            console.log(`   Puan: ${d.points || 'YOK'} | Status: ${d.pointStatus || 'YOK'} | docId: ${doc.id}`);
        });
        
        if (checksSnap.size === 0) {
            console.log('BugÃ¼n hiÃ§ check doldurulmamÄ±ÅŸ.');
        }
    } catch (e) {
        console.error('âŒ checklistSubmissions eriÅŸim hatasÄ±:', e.message);
    }
    
    // 3. PUANTAJ NOTLARI KONTROL
    console.log('\n3ï¸âƒ£ BUGÃœNKÃœ PUANTAJ NOTLARI:');
    console.log('--------------------------------------------------');
    
    try {
        const notesSnap = await db.collection('puantajNotes')
            .where('date', '==', todayStr)
            .get();
        
        notesSnap.forEach(doc => {
            const d = doc.data();
            console.log(`${d.autoGenerated ? 'ðŸ¤–' : 'âœï¸'} [${d.checkType}/${d.checkTime}] ${d.personelName}: ${d.points} puan (${d.status})`);
        });
        
        if (notesSnap.size === 0) {
            console.log('âš ï¸ BugÃ¼n hiÃ§ puantaj notu oluÅŸturulmamÄ±ÅŸ!');
            console.log('   OLASI SEBEPLER:');
            console.log('   - CHECK_RULES\'da ilgili type tanÄ±mlÄ± deÄŸil');
            console.log('   - points === 0 ise puantaj notu oluÅŸturulmuyor');
            console.log('   - Dolduran kiÅŸi mÃ¼dÃ¼r ise puan yazÄ±lmÄ±yor');
        }
    } catch (e) {
        console.error('âŒ puantajNotes eriÅŸim hatasÄ±:', e.message);
    }
    
    // 4. LEADERBOARD HESAPLAMA
    console.log('\n4ï¸âƒ£ LEADERBOARD HESAPLAMA:');
    console.log('--------------------------------------------------');
    const now = new Date();
    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
    const monthStartStr = formatDateLocal(monthStart);
    
    try {
        const notesSnap = await db.collection('puantajNotes')
            .where('date', '>=', monthStartStr)
            .get();
        
        const scores = {};
        notesSnap.forEach(doc => {
            const d = doc.data();
            const name = d.personelName || 'Bilinmiyor';
            if (!scores[name]) scores[name] = 0;
            scores[name] += (d.points || 0);
        });
        
        console.log(`Bu ay toplam ${notesSnap.size} puantaj notu var.`);
        Object.entries(scores)
            .sort((a,b) => b[1] - a[1])
            .forEach(([name, pts], i) => {
                console.log(`${i+1}. ${name}: ${pts} puan`);
            });
        
        if (Object.keys(scores).length === 0) {
            console.log('âš ï¸ Bu ay hiÃ§ puan kaydÄ± yok - Leaderboard boÅŸ gÃ¶rÃ¼necek!');
        }
    } catch (e) {
        console.error('âŒ Leaderboard hesaplama hatasÄ±:', e.message);
    }
    
    console.log('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
    console.log('â•‘                 PUAN DEBUG TAMAMLANDI                          â•‘');
    console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    
    toast('Puan debug raporu konsola yazÄ±ldÄ± (F12)', 'info');
}

// ==================== KPI DASHBOARD ====================
async function loadKPIDashboard() {
    const section = document.getElementById('kpiDashboardSection');
    const container = document.getElementById('kpiDashboardContainer');
    if (!section || !container) return;
    
    const isAdmin = ['yonetici', 'bolge_muduru'].includes(currentUser?.role);
    if (!isAdmin) return;
    
    section.style.display = 'block';
    
    const branches = STATE.branches || [];
    const today = new Date();
    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
    const monthStartStr = formatDateLocal(monthStart);
    const todayStr = formatDateLocal(today);
    const periodKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
    
    let html = '';
    
    for (const branch of branches) {
        let totalChecks = 0, completedChecks = 0, onTimeChecks = 0, missedChecks = 0;
        let totalPoints = 0, manualCount = 0;
        
        try {
            // 1. checklistSubmissions
            const checksSnapshot = await db.collection('checklistSubmissions')
                .where('branch', '==', branch)
                .where('date', '>=', monthStartStr)
                .get();
            
            checksSnapshot.forEach(doc => {
                totalChecks++;
                const data = doc.data();
                if (data.completionRate >= 80) completedChecks++;
                if (data.pointStatus === 'onTime') onTimeChecks++;
            });
            
            // 2. puantajNotes (otomatik puanlar)
            const notesSnapshot = await db.collection('puantajNotes')
                .where('branch', '==', branch)
                .where('date', '>=', monthStartStr)
                .get();
            
            notesSnapshot.forEach(doc => {
                const data = doc.data();
                totalPoints += (data.points || 0);
                if (data.status === 'onTime') onTimeChecks++;
                else if (data.status === 'missed') missedChecks++;
            });
            
            // 3. puantaj (manuel deÄŸerlendirmeler) - branch ile eÅŸleÅŸtir
            const puantajSnapshot = await db.collection('puantaj')
                .where('branch', '==', branch)
                .where('period', '==', periodKey)
                .get();
            
            puantajSnapshot.forEach(doc => {
                const data = doc.data();
                const score = data.score || 3;
                totalPoints += getPointsFromStar(score);
                manualCount++;
            });
            
        } catch (e) {
            console.warn('KPI veri hatasÄ±:', e);
        }
        
        const totalActivity = totalChecks + missedChecks + manualCount;
        const completionRate = totalActivity > 0 ? Math.round(((totalChecks + manualCount) / totalActivity) * 100) : 0;
        const onTimeRate = totalChecks > 0 ? Math.round((onTimeChecks / totalChecks) * 100) : 0;
        const isMoonberry = branch.toLowerCase().includes('ÅŸiÅŸli') || branch.toLowerCase().includes('sisli');
        const brandColor = isMoonberry ? '#008c95' : '#ff8674';
        const pointColor = totalPoints > 0 ? '#27ae60' : totalPoints < 0 ? '#e74c3c' : 'var(--tx2)';
        
        html += `
            <div style="background:var(--cardBg);border:1px solid var(--cardBorder);border-radius:14px;padding:16px;border-left:4px solid ${brandColor}">
                <div style="font-weight:600;color:var(--tx);margin-bottom:12px;font-size:.9rem">${branch}</div>
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;text-align:center">
                    <div>
                        <div style="font-size:1.3rem;font-weight:700;color:${brandColor}">${totalChecks}</div>
                        <div style="font-size:.65rem;color:var(--tx3)">Check</div>
                    </div>
                    <div>
                        <div style="font-size:1.3rem;font-weight:700;color:${manualCount > 0 ? '#3498db' : 'var(--tx3)'}">${manualCount}</div>
                        <div style="font-size:.65rem;color:var(--tx3)">Manuel</div>
                    </div>
                    <div>
                        <div style="font-size:1.3rem;font-weight:700;color:${onTimeRate >= 70 ? '#27ae60' : '#f39c12'}">%${onTimeRate}</div>
                        <div style="font-size:.65rem;color:var(--tx3)">Vaktinde</div>
                    </div>
                    <div>
                        <div style="font-size:1.3rem;font-weight:700;color:${pointColor}">${totalPoints > 0 ? '+' : ''}${totalPoints}</div>
                        <div style="font-size:.65rem;color:var(--tx3)">Puan</div>
                    </div>
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html || '<div style="text-align:center;color:var(--tx3);padding:20px">Veri yok</div>';
}

// ==================== HAFTALIK RAPOR ====================
async function generateWeeklyReport(branch) {
    const weekStart = getWeekStart(new Date());
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekEnd.getDate() + 6);
    
    const report = {
        branch,
        period: `${formatDateLocal(weekStart)} - ${formatDateLocal(weekEnd)}`,
        totalChecks: 0,
        completedChecks: 0,
        onTimeRate: 0,
        topPerformer: null,
        missedChecks: []
    };
    
    try {
        // Bu haftanÄ±n check kayÄ±tlarÄ±nÄ± Ã§ek
        const snapshot = await db.collection('checklistSubmissions')
            .where('branch', '==', branch)
            .where('date', '>=', formatDateLocal(weekStart))
            .where('date', '<=', formatDateLocal(weekEnd))
            .get();
        
        const personelStats = {};
        
        snapshot.forEach(doc => {
            const data = doc.data();
            report.totalChecks++;
            if (data.completionRate >= 80) report.completedChecks++;
            
            const person = data.personName || 'Bilinmiyor';
            if (!personelStats[person]) personelStats[person] = { onTime: 0, late: 0, total: 0 };
            personelStats[person].total++;
            if (data.pointStatus === 'onTime') personelStats[person].onTime++;
            else personelStats[person].late++;
        });
        
        // En iyi performansÄ± bul
        let maxOnTime = 0;
        for (const [name, stats] of Object.entries(personelStats)) {
            if (stats.onTime > maxOnTime) {
                maxOnTime = stats.onTime;
                report.topPerformer = { name, stats };
            }
        }
        
        report.onTimeRate = report.totalChecks > 0 ? Math.round((report.completedChecks / report.totalChecks) * 100) : 0;
        
    } catch (e) {
        console.error('HaftalÄ±k rapor hatasÄ±:', e);
    }
    
    return report;
}

async function showWeeklyReportModal(branch) {
    const report = await generateWeeklyReport(branch || currentUser?.branch || STATE.branches?.[0] || 'Tuzla TRC');
    
    showModal('ðŸ“Š HaftalÄ±k Rapor', `
        <div style="padding:10px 0">
            <div style="margin-bottom:16px;padding:12px;background:var(--bg3);border-radius:10px">
                <div style="font-size:.8rem;color:var(--tx3)">DÃ¶nem</div>
                <div style="font-weight:600">${report.period}</div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px">
                <div style="text-align:center;padding:16px;background:var(--bg3);border-radius:10px">
                    <div style="font-size:1.5rem;font-weight:700;color:#008c95">${report.totalChecks}</div>
                    <div style="font-size:.75rem;color:var(--tx3)">Toplam Check</div>
                </div>
                <div style="text-align:center;padding:16px;background:var(--bg3);border-radius:10px">
                    <div style="font-size:1.5rem;font-weight:700;color:#27ae60">${report.completedChecks}</div>
                    <div style="font-size:.75rem;color:var(--tx3)">Tamamlanan</div>
                </div>
                <div style="text-align:center;padding:16px;background:var(--bg3);border-radius:10px">
                    <div style="font-size:1.5rem;font-weight:700;color:${report.onTimeRate >= 80 ? '#27ae60' : '#e74c3c'}">%${report.onTimeRate}</div>
                    <div style="font-size:.75rem;color:var(--tx3)">BaÅŸarÄ± OranÄ±</div>
                </div>
            </div>
            ${report.topPerformer ? `
            <div style="padding:12px;background:linear-gradient(135deg,rgba(255,215,0,.1),rgba(255,215,0,.05));border:1px solid rgba(255,215,0,.3);border-radius:10px">
                <div style="font-size:.8rem;color:var(--tx3)">ðŸ† HaftanÄ±n YÄ±ldÄ±zÄ±</div>
                <div style="font-weight:600;color:var(--tx)">${report.topPerformer.name}</div>
                <div style="font-size:.75rem;color:var(--tx3)">${report.topPerformer.stats.onTime} vaktinde check</div>
            </div>
            ` : ''}
        </div>
    `, '<button class="btn btn-primary" onclick="closeModal()">Kapat</button>');
}

// ==================== ROZET SÄ°STEMÄ° ====================
const BADGE_DEFINITIONS = {
    ilk_check: { id: 'ilk_check', name: 'Ä°lk AdÄ±m', icon: 'ðŸŒŸ', desc: 'Ä°lk check tamamlandÄ±', color: '#ffd700' },
    streak_3: { id: 'streak_3', name: '3 GÃ¼n Serisi', icon: 'ðŸ”¥', desc: '3 gÃ¼n Ã¼st Ã¼ste vaktinde', color: '#ff6b35' },
    streak_7: { id: 'streak_7', name: 'HaftalÄ±k Åžampiyon', icon: 'ðŸ†', desc: '7 gÃ¼n Ã¼st Ã¼ste vaktinde', color: '#27ae60' },
    hizli: { id: 'hizli', name: 'HÄ±z UstasÄ±', icon: 'âš¡', desc: 'Beklenen sÃ¼renin %50 altÄ±nda', color: '#3498db' },
    kusursuz: { id: 'kusursuz', name: 'Kusursuz Hafta', icon: 'ðŸ’Ž', desc: 'Bir hafta sÄ±fÄ±r geÃ§ check', color: '#9b59b6' },
    lider: { id: 'lider', name: 'Ay Lideri', icon: 'ðŸ‘‘', desc: 'AyÄ±n en yÃ¼ksek puanÄ±', color: '#e74c3c' }
};

async function checkAndAwardBadges(personelId, personelName, checkData) {
    try {
        const badgeDocId = `${personelId}_badges`;
        const badgeRef = db.collection('badges').doc(badgeDocId);
        const badgeDoc = await badgeRef.get();
        const existingBadges = badgeDoc.exists ? (badgeDoc.data().badges || []) : [];
        const newBadges = [];
        
        // Ä°lk Check rozeti
        if (!existingBadges.includes('ilk_check')) {
            newBadges.push('ilk_check');
        }
        
        // HÄ±z rozeti (beklenen sÃ¼renin %50 altÄ±nda)
        if (checkData.actualMinutes && checkData.expectedMinutes) {
            if (checkData.actualMinutes < checkData.expectedMinutes * 0.5 && !existingBadges.includes('hizli')) {
                newBadges.push('hizli');
            }
        }
        
        // Yeni rozet varsa kaydet
        if (newBadges.length > 0) {
            const allBadges = [...existingBadges, ...newBadges];
            await badgeRef.set({
                personelId,
                personelName,
                badges: allBadges,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            
            // Bildirim gÃ¶ster
            newBadges.forEach(badgeId => {
                const badge = BADGE_DEFINITIONS[badgeId];
                if (badge) {
                    toast(`${badge.icon} Yeni Rozet: ${badge.name}!`, 'success');
                }
            });
        }
    } catch (e) {
        console.warn('Rozet kontrolÃ¼ hatasÄ±:', e);
    }
}

function renderBadges(badges) {
    if (!badges || badges.length === 0) return '';
    return badges.map(id => {
        const b = BADGE_DEFINITIONS[id];
        return b ? `<span title="${b.desc}" style="font-size:1.2rem;cursor:help">${b.icon}</span>` : '';
    }).join(' ');
}

// ==================== GÃ–REV ATAMALARINI TEMÄ°ZLE (Shift deÄŸiÅŸiminde) ====================
async function clearTaskAssignmentsForBranch(branch, weekStart) {
    try {
        const branchKey = branch.replace(/[^a-zA-Z0-9]/g, '_');
        
        // HaftalÄ±k atamalarÄ± sil
        const weeklyDocId = `${branchKey}_${weekStart}`;
        await db.collection('weeklyTaskAssignments').doc(weeklyDocId).delete().catch(() => {});
        
        // Bu haftanÄ±n gÃ¼nlÃ¼k atamalarÄ±nÄ± sil
        const weekStartDate = new Date(weekStart);
        for (let i = 0; i < 7; i++) {
            const dayDate = new Date(weekStartDate);
            dayDate.setDate(dayDate.getDate() + i);
            const dateStr = formatDateLocal(dayDate);
            
            // TÃ¼m check tÃ¼rleri iÃ§in
            const types = ['acilis', 'kapanis', 'guncel', 'platform'];
            for (const type of types) {
                const dailyDocId = `${branchKey}_${type}_${dateStr}`;
                await db.collection('dailyTaskAssignments').doc(dailyDocId).delete().catch(() => {});
            }
        }
        
        console.log(`[TaskAssignment] ${branch} iÃ§in ${weekStart} haftasÄ± atamalarÄ± temizlendi`);
    } catch (e) {
        console.warn('GÃ¶rev atamalarÄ± temizleme hatasÄ±:', e);
    }
}

// ==================== HAFTALIK GÃ–REV ROTASYON SÄ°STEMÄ° ====================

/**
 * HaftalÄ±k gÃ¶revleri personele otomatik daÄŸÄ±t
 * Algoritma:
 * 1. TÃ¼m haftalÄ±k gÃ¶revleri al
 * 2. Aktif personeli shift'ten al
 * 3. GÃ¶revleri personel sayÄ±sÄ±na eÅŸit bÃ¶l
 * 4. rotationIndex'e gÃ¶re daÄŸÄ±t (her hafta sÄ±ra kayar)
 */
async function getWeeklyTaskAssignments(branch, weekStart) {
    // Yeni round-robin sistemini kullan
    try {
        const data = await getOrCreateWeeklyAssignments(branch);
        if (!data) return null;
        
        // Eski format uyumluluÄŸu iÃ§in dÃ¶nÃ¼ÅŸtÃ¼r
        // Yeni: { assignments: [{personnelId, personnelName, itemId, ...}] }
        // Eski: { assignments: {itemId: personnelName} }
        const oldFormatAssignments = {};
        const personnelIds = {}; // itemId -> personnelId mapping
        
        (data.assignments || []).forEach(a => {
            oldFormatAssignments[a.itemId] = a.personnelName;
            personnelIds[a.itemId] = a.personnelId;
        });
        
        return {
            branch: data.branch,
            weekStart: data.weekStart,
            assignments: oldFormatAssignments,
            personnelIds: personnelIds, // Yeni alan - submit iÃ§in lazÄ±m
            personnel: data.pool?.map(p => p.name) || [],
            rotationIndex: data.rotationIndex,
            rawAssignments: data.assignments, // Tam veri
            createdAt: data.createdAt
        };
    } catch (e) {
        console.error('HaftalÄ±k gÃ¶rev atamalarÄ± alÄ±namadÄ±:', e);
        return null;
    }
}

// ==================== GÃœNLÃœK CHECKLIST GÃ–REV PAYLAÅžIMI ====================

/**
 * GÃ¼nlÃ¼k/AÃ§Ä±lÄ±ÅŸ/KapanÄ±ÅŸ checklist gÃ¶revlerini paylaÅŸtÄ±r
 * shiftPersonnel listesi varsa ve birden fazla kiÅŸi varsa aktif
 */
async function getDailyTaskAssignments(branch, type, date, items = [], personnel = []) {
    const assignmentDocId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_${type}_${date}`;
    
    try {
        const existingDoc = await db.collection('dailyTaskAssignments').doc(assignmentDocId).get();
        if (existingDoc.exists) {
            return existingDoc.data();
        }
        
        // OTOMATÄ°K OLUÅžTUR: 2+ personel varsa otomatik paylaÅŸtÄ±r
        if (personnel && personnel.length >= 2 && items && items.length > 0) {
            console.log('Otomatik gÃ¼nlÃ¼k gÃ¶rev paylaÅŸÄ±mÄ± baÅŸlatÄ±lÄ±yor:', personnel);
            
            // GÃ¶revleri eÅŸit daÄŸÄ±t
            const assignments = {};
            items.forEach((item, index) => {
                const personelIndex = index % personnel.length;
                assignments[item.id] = personnel[personelIndex];
            });
            
            const assignmentData = {
                branch,
                type,
                date,
                assignments,
                personnel,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                autoGenerated: true,
                distributedBy: 'Sistem (Otomatik)'
            };
            
            await db.collection('dailyTaskAssignments').doc(assignmentDocId).set(assignmentData);
            console.log('Otomatik gÃ¼nlÃ¼k gÃ¶rev atamalarÄ± oluÅŸturuldu:', assignmentData);
            
            return assignmentData;
        }
        
        return null; // Tek personel veya items yoksa paylaÅŸÄ±m yok
    } catch (e) {
        console.error('GÃ¼nlÃ¼k gÃ¶rev atamalarÄ± alÄ±namadÄ±:', e);
        return null;
    }
}

/**
 * GÃ¼nlÃ¼k checklist gÃ¶revlerini otomatik daÄŸÄ±t
 * MÃ¼dÃ¼r "GÃ¶revleri PaylaÅŸtÄ±r" butonuna tÄ±kladÄ±ÄŸÄ±nda Ã§aÄŸrÄ±lÄ±r
 */
async function distributeDailyTasks(branch, type, date, items, personnel) {
    if (!personnel || personnel.length < 2) {
        toast('PaylaÅŸÄ±m iÃ§in en az 2 personel gerekli', 'warning');
        return null;
    }
    
    const assignmentDocId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_${type}_${date}`;
    
    try {
        // GÃ¶revleri eÅŸit daÄŸÄ±t
        const assignments = {};
        items.forEach((item, index) => {
            const personelIndex = index % personnel.length;
            assignments[item.id] = personnel[personelIndex];
        });
        
        const assignmentData = {
            branch,
            type,
            date,
            assignments,
            personnel,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            autoGenerated: false, // MÃ¼dÃ¼r manuel daÄŸÄ±ttÄ±
            distributedBy: currentUser?.name || 'Bilinmiyor'
        };
        
        await db.collection('dailyTaskAssignments').doc(assignmentDocId).set(assignmentData);
        console.log('GÃ¼nlÃ¼k gÃ¶rev atamalarÄ± oluÅŸturuldu:', assignmentData);
        
        toast(`${items.length} gÃ¶rev ${personnel.length} kiÅŸiye paylaÅŸtÄ±rÄ±ldÄ±`, 'success');
        loadChecklist();
        
        return assignmentData;
    } catch (e) {
        console.error('GÃ¶rev daÄŸÄ±tÄ±m hatasÄ±:', e);
        toast('GÃ¶rev daÄŸÄ±tÄ±m hatasÄ±: ' + e.message, 'error');
        return null;
    }
}

/**
 * GÃ¼nlÃ¼k gÃ¶rev atamasÄ±nÄ± temizle (paylaÅŸÄ±mÄ± kaldÄ±r)
 */
async function clearDailyTaskAssignments(branch, type, date) {
    const assignmentDocId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_${type}_${date}`;
    
    try {
        await db.collection('dailyTaskAssignments').doc(assignmentDocId).delete();
        toast('GÃ¶rev paylaÅŸÄ±mÄ± kaldÄ±rÄ±ldÄ±', 'success');
        loadChecklist();
    } catch (e) {
        console.error('PaylaÅŸÄ±m kaldÄ±rma hatasÄ±:', e);
        toast('Hata: ' + e.message, 'error');
    }
}

/**
 * Tek bir gÃ¼nlÃ¼k gÃ¶revi baÅŸka personele ata
 */
async function reassignDailyTask(branch, type, date, taskId, newPersonel) {
    const assignmentDocId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_${type}_${date}`;
    
    try {
        await db.collection('dailyTaskAssignments').doc(assignmentDocId).update({
            [`assignments.${taskId}`]: newPersonel,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            autoGenerated: false
        });
        
        toast(`GÃ¶rev ${newPersonel} kiÅŸisine atandÄ±`, 'success');
        loadChecklist();
    } catch (e) {
        console.error('GÃ¶rev atama hatasÄ±:', e);
        toast('GÃ¶rev atama hatasÄ±: ' + e.message, 'error');
    }
}

async function generateWeeklyTaskAssignments(branch, weekStart) {
    const assignmentDocId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_${weekStart}`;
    
    try {
        // 1. HaftalÄ±k gÃ¶revleri al
        const checklistId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_haftalik`;
        const checklistDoc = await db.collection('checklists').doc(checklistId).get();
        
        if (!checklistDoc.exists) {
            console.warn('HaftalÄ±k gÃ¶rev listesi bulunamadÄ±');
            return { assignments: {}, rotationIndex: 0 };
        }
        
        const tasks = checklistDoc.data().items || [];
        if (tasks.length === 0) {
            return { assignments: {}, rotationIndex: 0 };
        }
        
        // 2. Aktif personeli shift'ten al
        const shiftsSnapshot = await db.collection('shifts')
            .where('branch', '==', branch)
            .get();
        
        const allShifts = [];
        shiftsSnapshot.forEach(doc => allShifts.push(doc.data()));
        allShifts.sort((a, b) => (b.weekStart || '').localeCompare(a.weekStart || ''));
        
        const targetShift = allShifts.find(s => s.weekStart === weekStart) || allShifts[0];
        
        if (!targetShift || !targetShift.personelShifts) {
            return { assignments: {}, rotationIndex: 0 };
        }
        
        // Aktif personeli topla (izinli olmayanlar)
        const personelFullNames = targetShift.personelFullNames || {};
        const activePersonnel = [];
        
        for (const [key, days] of Object.entries(targetShift.personelShifts)) {
            // Haftada en az 1 gÃ¼n Ã§alÄ±ÅŸan personeli al
            const hasWorkDay = Object.values(days).some(d => {
                const cleanShift = (d || '').replace(/\*/g, '').trim().toUpperCase();
                return cleanShift && cleanShift !== 'Ä°' && cleanShift !== 'OFF' && cleanShift !== '-' && cleanShift !== 'X';
            });
            
            if (hasWorkDay) {
                // underscore formatÄ±nÄ± temizle: "tuana_yasar" â†’ "Tuana Yasar"
                const rawName = personelFullNames[key] || key.replace(/_/g, ' ');
                const displayName = formatDisplayName(rawName);
                if (displayName && !activePersonnel.includes(displayName)) {
                    activePersonnel.push(displayName);
                }
            }
        }
        
        if (activePersonnel.length === 0) {
            return { assignments: {}, rotationIndex: 0 };
        }
        
        // 3. Ã–nceki haftanÄ±n rotationIndex'ini al
        let rotationIndex = 0;
        try {
            const prevWeekStart = new Date(weekStart);
            prevWeekStart.setDate(prevWeekStart.getDate() - 7);
            const prevDocId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_${formatDateLocal(prevWeekStart)}`;
            const prevDoc = await db.collection('weeklyTaskAssignments').doc(prevDocId).get();
            if (prevDoc.exists) {
                rotationIndex = ((prevDoc.data().rotationIndex || 0) + 1) % activePersonnel.length;
            }
        } catch (e) {}
        
        // 4. GÃ¶revleri daÄŸÄ±t
        const assignments = {};
        tasks.forEach((task, index) => {
            const personelIndex = (rotationIndex + index) % activePersonnel.length;
            assignments[task.id] = activePersonnel[personelIndex];
        });
        
        // 5. Firebase'e kaydet
        const assignmentData = {
            branch,
            weekStart,
            assignments,
            rotationIndex,
            personnel: activePersonnel,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            autoGenerated: true
        };
        
        await db.collection('weeklyTaskAssignments').doc(assignmentDocId).set(assignmentData);
        console.log('HaftalÄ±k gÃ¶rev atamalarÄ± oluÅŸturuldu:', assignmentData);
        
        return assignmentData;
        
    } catch (e) {
        console.error('HaftalÄ±k gÃ¶rev atamasÄ± oluÅŸturma hatasÄ±:', e);
        return { assignments: {}, rotationIndex: 0 };
    }
}

/**
 * Tek bir gÃ¶revi baÅŸka personele ata (mÃ¼dÃ¼r yetkisi)
 */
async function reassignWeeklyTask(branch, weekStart, taskId, newPersonel) {
    const assignmentDocId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_${weekStart}`;
    
    try {
        await db.collection('weeklyTaskAssignments').doc(assignmentDocId).update({
            [`assignments.${taskId}`]: newPersonel,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            autoGenerated: false // Manuel deÄŸiÅŸiklik yapÄ±ldÄ±
        });
        
        toast(`GÃ¶rev ${newPersonel} kiÅŸisine atandÄ±`, 'success');
        loadChecklist();
    } catch (e) {
        console.error('GÃ¶rev atama hatasÄ±:', e);
        toast('GÃ¶rev atama hatasÄ±: ' + e.message, 'error');
    }
}

/**
 * GÃ¶rev atama modalÄ±nÄ± gÃ¶ster
 */
function showTaskAssignmentModal(taskId, taskText, currentAssignee, branch, weekStart) {
    const isManager = currentUser?.role === 'yonetici' || currentUser?.role === 'magaza_muduru' || currentUser?.role === 'bolge_muduru';
    
    if (!isManager) {
        toast('Bu iÅŸlem iÃ§in yetkiniz yok', 'error');
        return;
    }
    
    // Personel listesini al
    const assignmentData = window._weeklyTaskAssignments;
    const personnel = assignmentData?.personnel || [];
    
    const personnelOptions = personnel.map(p => 
        `<option value="${p}" ${p === currentAssignee ? 'selected' : ''}>${p}</option>`
    ).join('');
    
    showModal('GÃ¶rev Ata', `
        <div class="form-group">
            <label class="form-label">GÃ¶rev</label>
            <div style="padding:12px;background:var(--bg3);border-radius:8px;font-size:.9rem;color:var(--tx)">${taskText}</div>
        </div>
        <div class="form-group">
            <label class="form-label">Atanan Personel</label>
            <select id="taskAssigneeSelect" class="form-select">
                ${personnelOptions}
            </select>
        </div>
    `, `
        <button class="btn btn-ghost" onclick="closeModal()">Ä°ptal</button>
        <button class="btn btn-primary" onclick="confirmTaskAssignment('${taskId}', '${branch}', '${weekStart}')">Ata</button>
    `);
}

function confirmTaskAssignment(taskId, branch, weekStart) {
    const newPersonel = document.getElementById('taskAssigneeSelect').value;
    closeModal();
    reassignWeeklyTask(branch, weekStart, taskId, newPersonel);
}

/**
 * GÃ¼nlÃ¼k gÃ¶rev atama modalÄ±nÄ± gÃ¶ster
 */
function showDailyTaskAssignmentModal(taskId, taskText, currentAssignee, branch, type, date) {
    const isManager = currentUser?.role === 'yonetici' || currentUser?.role === 'magaza_muduru' || currentUser?.role === 'bolge_muduru';
    
    if (!isManager) {
        toast('Bu iÅŸlem iÃ§in yetkiniz yok', 'error');
        return;
    }
    
    // Personel listesini al
    const assignmentData = window._dailyTaskAssignments;
    const personnel = assignmentData?.personnel || window._currentShiftPersonnel || [];
    
    const personnelOptions = personnel.map(p => 
        `<option value="${p}" ${p === currentAssignee ? 'selected' : ''}>${p}</option>`
    ).join('');
    
    showModal('GÃ¶rev Ata', `
        <div class="form-group">
            <label class="form-label">GÃ¶rev</label>
            <div style="padding:12px;background:var(--bg3);border-radius:8px;font-size:.9rem;color:var(--tx)">${taskText}</div>
        </div>
        <div class="form-group">
            <label class="form-label">Atanan Personel</label>
            <select id="dailyTaskAssigneeSelect" class="form-select">
                ${personnelOptions}
            </select>
        </div>
    `, `
        <button class="btn btn-ghost" onclick="closeModal()">Ä°ptal</button>
        <button class="btn btn-primary" onclick="confirmDailyTaskAssignment('${taskId}', '${branch}', '${type}', '${date}')">Ata</button>
    `);
}

function confirmDailyTaskAssignment(taskId, branch, type, date) {
    const newPersonel = document.getElementById('dailyTaskAssigneeSelect').value;
    closeModal();
    reassignDailyTask(branch, type, date, taskId, newPersonel);
}

// ==================== SÃœRÃœKLE BIRAK ====================
let draggedItem = null;
let draggedOverItem = null;

function dragStart(e) {
    draggedItem = e.target.closest('.checklist-item');
    draggedItem.style.opacity = '0.5';
    draggedItem.style.transform = 'scale(0.98)';
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', draggedItem.dataset.itemId);
}

function dragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    
    const item = e.target.closest('.checklist-item');
    if (item && item !== draggedItem) {
        // Hover efekti
        document.querySelectorAll('.checklist-item').forEach(el => {
            el.style.borderTop = 'none';
            el.style.borderBottom = 'none';
        });
        
        const rect = item.getBoundingClientRect();
        const midY = rect.top + rect.height / 2;
        
        if (e.clientY < midY) {
            item.style.borderTop = '3px solid #008c95';
            item.style.borderBottom = 'none';
        } else {
            item.style.borderBottom = '3px solid #008c95';
            item.style.borderTop = 'none';
        }
        
        draggedOverItem = item;
    }
}

function dropItem(e) {
    e.preventDefault();
    
    const item = e.target.closest('.checklist-item');
    if (item && draggedItem && item !== draggedItem) {
        const container = document.getElementById('checklistItems');
        const rect = item.getBoundingClientRect();
        const midY = rect.top + rect.height / 2;
        
        if (e.clientY < midY) {
            container.insertBefore(draggedItem, item);
        } else {
            container.insertBefore(draggedItem, item.nextSibling);
        }
        
        // SÄ±ralamayÄ± gÃ¼ncelle
        updateChecklistOrder();
    }
    
    // Hover efektlerini temizle
    document.querySelectorAll('.checklist-item').forEach(el => {
        el.style.borderTop = 'none';
        el.style.borderBottom = 'none';
    });
}

function dragEnd(e) {
    if (draggedItem) {
        draggedItem.style.opacity = '1';
        draggedItem.style.transform = 'scale(1)';
    }
    
    // TÃ¼m hover efektlerini temizle
    document.querySelectorAll('.checklist-item').forEach(el => {
        el.style.borderTop = 'none';
        el.style.borderBottom = 'none';
    });
    
    draggedItem = null;
    draggedOverItem = null;
}

// SÄ±ralama deÄŸiÅŸince numaralarÄ± gÃ¼ncelle ve Firebase'e kaydet
async function updateChecklistOrder() {
    const items = document.querySelectorAll('#checklistItems .checklist-item');
    const newOrder = [];
    
    // NumaralarÄ± gÃ¼ncelle
    items.forEach((item, index) => {
        const numEl = item.querySelector('.drag-handle span:first-child');
        if (numEl) numEl.textContent = index + 1;
        newOrder.push(item.dataset.itemId);
        item.dataset.order = index;
    });
    
    // Firebase'e kaydet
    const branch = document.getElementById('checklistSube')?.value;
    const type = document.getElementById('checklistType')?.value;
    
    if (!branch || !type) return;
    
    const checklistId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_${type}`;
    
    try {
        const checklistRef = db.collection('checklists').doc(checklistId);
        const doc = await checklistRef.get();
        
        if (doc.exists) {
            const data = doc.data();
            const orderedItems = [];
            
            // Yeni sÄ±raya gÃ¶re items dizisini yeniden oluÅŸtur
            newOrder.forEach(itemId => {
                const foundItem = data.items.find(i => i.id === itemId);
                if (foundItem) {
                    orderedItems.push(foundItem);
                }
            });
            
            await checklistRef.update({
                items: orderedItems,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            toast('SÄ±ralama kaydedildi', 'success');
        }
    } catch (error) {
        console.error('SÄ±ralama kayÄ±t hatasÄ±:', error);
        toast('SÄ±ralama kaydedilemedi', 'error');
    }
}

// TÃ¼mÃ¼nÃ¼ seÃ§
function selectAllChecklistItems() {
    document.querySelectorAll('.checklist-select-item').forEach(cb => cb.checked = true);
}

// SeÃ§imi kaldÄ±r
function deselectAllChecklistItems() {
    document.querySelectorAll('.checklist-select-item').forEach(cb => cb.checked = false);
}

// SeÃ§ilenleri sil
async function deleteSelectedChecklistItems(branch, type) {
    const selected = Array.from(document.querySelectorAll('.checklist-select-item:checked')).map(cb => cb.value);
    
    if (selected.length === 0) {
        toast('Silmek iÃ§in madde seÃ§in', 'error');
        return;
    }
    
    if (!confirm(`${selected.length} madde silinecek. Emin misiniz?`)) return;
    
    try {
        const checklistId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_${type}`;
        const checklistRef = db.collection('checklists').doc(checklistId);
        const doc = await checklistRef.get();
        
        if (doc.exists) {
            const items = doc.data().items.filter(i => !selected.includes(i.id));
            await checklistRef.update({
                items,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        toast(`${selected.length} madde silindi`, 'success');
        loadChecklist();
        
    } catch (error) {
        console.error('Toplu silme hatasÄ±:', error);
        toast('Silme hatasÄ±!', 'error');
    }
}

// Check seÃ§eneÄŸi seÃ§
function selectCheckOption(btn, itemId, value) {
    const parent = btn.closest('.checklist-item');
    const doneBtn = parent.querySelector('.check-btn.done');
    const notdoneBtn = parent.querySelector('.check-btn.notdone');
    const doneInput = parent.querySelector('input[value="done"]');
    const notdoneInput = parent.querySelector('input[value="notdone"]');
    
    if (!doneBtn || !notdoneBtn) {
        console.error('Butonlar bulunamadÄ±');
        return;
    }
    
    // Ã–nce iÅŸaretle
    if (value === 'done') {
        doneInput.checked = true;
        notdoneInput.checked = false;
        doneBtn.style.background = '#22c55e';
        doneBtn.style.borderColor = '#22c55e';
        doneBtn.style.color = '#fff';
        notdoneBtn.style.background = 'rgba(255,255,255,.95)';
        notdoneBtn.style.borderColor = 'rgba(239,68,68,.4)';
        notdoneBtn.style.color = '#ef4444';
    } else {
        notdoneInput.checked = true;
        doneInput.checked = false;
        notdoneBtn.style.background = '#ef4444';
        notdoneBtn.style.borderColor = '#ef4444';
        notdoneBtn.style.color = '#fff';
        doneBtn.style.background = 'rgba(255,255,255,.95)';
        doneBtn.style.borderColor = 'rgba(34,197,94,.4)';
        doneBtn.style.color = '#22c55e';
    }
    
    // TÃ¼m maddeler iÅŸaretlendi mi kontrol et
    checkAllItemsMarked();
}

// Checklist Timer Interval
let checklistTimerInterval = null;

// Checklist timer'Ä± baÅŸlat - butona basÄ±nca Ã§alÄ±ÅŸÄ±r
function startChecklistTimer() {
    const overlay = document.getElementById('checklistStartOverlay');
    const wrapper = document.getElementById('checklistItemsWrapper');
    const banner = document.getElementById('checklistTimerBanner');
    const liveTimeEl = document.getElementById('checklistLiveTime');
    const elapsedEl = document.getElementById('checklistElapsedTime');
    
    // Elementler yoksa Ã§Ä±k
    if (!banner || !liveTimeEl || !elapsedEl) {
        console.log('[Timer] Elementler bulunamadÄ±, timer baÅŸlatÄ±lamadÄ±');
        return;
    }
    
    // ZamanÄ± kaydet
    const now = new Date();
    checklistStartTime = now;
    checklistFirstItemTime = now;
    
    // 1. Overlay'Ä± gizle
    if (overlay) {
        overlay.style.display = 'none';
    }
    
    // 2. Blur'u kaldÄ±r
    if (wrapper) {
        wrapper.style.filter = 'none';
        wrapper.style.opacity = '1';
        wrapper.style.pointerEvents = 'auto';
    }
    
    // 3. Banner'Ä± gÃ¶ster
    banner.style.display = 'block';
    
    // Ä°lk gÃ¼ncelleme
    liveTimeEl.textContent = now.toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
    elapsedEl.textContent = '00:00:00';
    
    // Ã–nceki interval'Ä± temizle
    if (checklistTimerInterval) {
        clearInterval(checklistTimerInterval);
        checklistTimerInterval = null;
    }
    
    // CanlÄ± timer baÅŸlat - her saniye gÃ¼ncelle
    checklistTimerInterval = setInterval(() => {
        const currentTime = new Date();
        
        // 1. CanlÄ± saat gÃ¼ncelle
        if (liveTimeEl) {
            liveTimeEl.textContent = currentTime.toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
        }
        
        // 2. GeÃ§en sÃ¼re gÃ¼ncelle
        if (elapsedEl && checklistStartTime) {
            const elapsed = Math.floor((currentTime - checklistStartTime) / 1000);
            const hours = Math.floor(elapsed / 3600);
            const minutes = Math.floor((elapsed % 3600) / 60);
            const seconds = elapsed % 60;
            elapsedEl.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
    }, 1000);
    
    console.log('[Timer] BaÅŸladÄ±:', now.toLocaleTimeString('tr-TR'));
}

// Sayfa deÄŸiÅŸince interval'Ä± temizle
window.addEventListener('beforeunload', () => {
    if (checklistTimerInterval) {
        clearInterval(checklistTimerInterval);
    }
});

// Checklist baÅŸlangÄ±cÄ±nÄ± onayla
function confirmChecklistStart() {
    if (window.pendingChecklistStartTime) {
        checklistFirstItemTime = window.pendingChecklistStartTime;
        checklistStartTime = window.pendingChecklistStartTime;
        
        // Banner'Ä± gÃ¶ster ve timer'Ä± baÅŸlat
        startChecklistTimer();
        
        delete window.pendingChecklistStartTime;
    }
    closeModal();
}

// TÃ¼m maddelerin iÅŸaretlenip iÅŸaretlenmediÄŸini kontrol et
function checkAllItemsMarked() {
    const checklistType = document.getElementById('checklistType')?.value;
    const isHaftalik = checklistType === 'haftalik';
    
    // HaftalÄ±k iÃ§in sadece kiÅŸinin maddelerini say
    let items, totalItems;
    if (isHaftalik) {
        // Sadece aktif (opacity:1 veya pointer-events:auto) maddeler
        items = document.querySelectorAll('#checklistItems .checklist-item:not([style*="opacity: 0.7"]):not([style*="opacity:0.7"])');
        totalItems = items.length;
    } else {
        items = document.querySelectorAll('#checklistItems .checklist-item');
        totalItems = items.length;
    }
    
    let allMarked = true;
    let markedCount = 0;
    
    items.forEach(item => {
        const doneInput = item.querySelector('input[value="done"]');
        const notdoneInput = item.querySelector('input[value="notdone"]');
        const isDisabled = doneInput?.disabled;
        
        // Disabled maddeler (baÅŸkasÄ±nÄ±n gÃ¶revi) sayÄ±lmaz
        if (isDisabled) return;
        
        if (doneInput?.checked || notdoneInput?.checked) {
            markedCount++;
        } else {
            allMarked = false;
        }
    });
    
    // Ä°lerleme gÃ¶stergesi gÃ¼ncelle
    const progress = totalItems > 0 ? Math.round((markedCount / totalItems) * 100) : 0;
    
    // Submit butonu aktifliÄŸi
    const submitBtn = document.querySelector('button[onclick*="submitChecklist"]');
    if (submitBtn) {
        if (allMarked && markedCount > 0) {
            submitBtn.classList.remove('btn-ghost');
            submitBtn.classList.add('btn-primary');
            submitBtn.innerHTML = 'âœ… Checklist\'i Tamamla';
            
            // HaftalÄ±k iÃ§in otomatik tamamlama pop-up'Ä± gÃ¶ster
            if (isHaftalik && !window._weeklyCompletionShown) {
                window._weeklyCompletionShown = true;
                showWeeklyCompletionPopup(markedCount);
            }
        }
    }
}

// HaftalÄ±k tamamlama pop-up'Ä±
function showWeeklyCompletionPopup(taskCount) {
    const typeName = document.getElementById('checklistType')?.selectedOptions?.[0]?.text || 'HaftalÄ±k GÃ¶revler';
    
    showModal('ðŸŽ‰ GÃ¶revler TamamlandÄ±!', `
        <div style="text-align:center;padding:20px 0">
            <div style="width:80px;height:80px;margin:0 auto 20px;background:linear-gradient(135deg,#27ae60,#2ecc71);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 24px rgba(39,174,96,.3)">
                <svg width="40" height="40" fill="none" stroke="#fff" stroke-width="3" viewBox="0 0 24 24">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>
            </div>
            <div style="font-size:1.3rem;font-weight:700;color:var(--tx);margin-bottom:8px">${taskCount} gÃ¶revinizi tamamladÄ±nÄ±z!</div>
            <div style="font-size:.95rem;color:var(--tx2);margin-bottom:20px">Checklist'i kaydetmek ister misiniz?</div>
            <div style="padding:12px;background:var(--bg3);border-radius:10px;font-size:.85rem;color:var(--tx3)">
                ðŸ’¡ KaydettiÄŸinizde puanlarÄ±nÄ±z hesaplanacak ve cooldown sÃ¼releri baÅŸlayacak.
            </div>
        </div>
    `, `
        <button class="btn btn-ghost" onclick="closeModal(); window._weeklyCompletionShown = false;">Daha Sonra</button>
        <button class="btn btn-primary" onclick="closeModal(); document.querySelector('button[onclick*=\\'submitChecklist\\']')?.click();">âœ… Checklist'i Tamamla</button>
    `);
}

// Platform checklist render with status (zaman durumlu)
async function renderPlatformChecklistWithStatus(container, branch, date, activeTimeSlot = null) {
    // Aktif saat belirle
    const now = new Date();
    const currentHour = now.getHours();
    const currentMinutes = currentHour * 60 + now.getMinutes();
    const TIME_SLOTS = ['10:00', '12:00', '15:00', '18:00', '21:00', '00:00'];
    
    // Dashboard'dan gelen timeSlot kullan veya otomatik belirle
    let selectedTimeSlot = activeTimeSlot;
    if (!selectedTimeSlot) {
        // Gece saatlerinde (maÄŸaza kapanÄ±ÅŸÄ±na kadar)
        const dayEndHour = getBusinessDayEndHour();
        const isLateNight = currentHour >= 0 && currentHour < dayEndHour;
        if (isLateNight) {
            selectedTimeSlot = '00:00';
        } else {
            // En yakÄ±n slotu bul
            for (const timeStr of TIME_SLOTS) {
                const [h, m] = timeStr.split(':').map(Number);
                const slotMinutes = h * 60 + m;
                const diff = slotMinutes - currentMinutes;
                if (diff >= -15 && diff <= 75) {
                    selectedTimeSlot = timeStr;
                    break;
                }
            }
            if (!selectedTimeSlot) selectedTimeSlot = TIME_SLOTS[0];
        }
    }
    
    // Saat bazlÄ± submission ID
    const submissionId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_platform_${date}_${selectedTimeSlot.replace(':', '')}`;
    
    // Ã–nce mevcut submission'Ä± kontrol et
    let submittedData = null;
    try {
        const submissionDoc = await db.collection('checklistSubmissions').doc(submissionId).get();
        if (submissionDoc.exists) {
            submittedData = submissionDoc.data();
        }
    } catch (e) {
        console.warn('Platform submission kontrol hatasÄ±:', e);
    }
    
    // Ana render fonksiyonunu Ã§aÄŸÄ±r
    renderPlatformChecklist(container, branch, date, selectedTimeSlot, submittedData);
}

// Platform checklist render
async function renderPlatformChecklist(container, branch, date, timeSlot, submittedData) {
    const isSubmitted = !!submittedData;
    
    // G16: KullanÄ±cÄ±nÄ±n shift durumunu kontrol et
    const userShiftStatus = await checkCurrentUserShift(branch, date);
    const isManager = userShiftStatus.isManager;
    const hasShift = userShiftStatus.hasShift;
    
    // Shift yoksa uyarÄ± gÃ¶ster (yÃ¶neticiler hariÃ§)
    if (!hasShift && !isManager && !isSubmitted) {
        container.innerHTML = `
            <div style="text-align:center;padding:60px 20px">
                <div style="width:80px;height:80px;margin:0 auto 20px;background:linear-gradient(135deg,#fee2e2,#fecaca);border-radius:50%;display:flex;align-items:center;justify-content:center">
                    <svg width="40" height="40" fill="none" stroke="#ef4444" stroke-width="2" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 8v4M12 16h.01"/>
                    </svg>
                </div>
                <div style="font-size:1.2rem;font-weight:600;color:var(--tx);margin-bottom:8px">Åžu An Shift'iniz Yok</div>
                <div style="color:var(--tx2);margin-bottom:20px">Bu ÅŸubede bugÃ¼n iÃ§in aktif bir shift kaydÄ±nÄ±z bulunmuyor.</div>
                <div style="padding:16px;background:var(--bg3);border-radius:12px;text-align:left;max-width:400px;margin:0 auto">
                    <div style="font-size:.85rem;color:var(--tx2)">
                        <div style="margin-bottom:8px"><strong>Åžube:</strong> ${branch}</div>
                        <div style="margin-bottom:8px"><strong>Tarih:</strong> ${date}</div>
                        <div><strong>KullanÄ±cÄ±:</strong> ${currentUser?.name || '-'}</div>
                    </div>
                </div>
                <div style="margin-top:20px;font-size:.8rem;color:var(--tx3)">
                    Checklist'i doldurmak iÃ§in shift'inizin olduÄŸu bir gÃ¼n gelin.
                </div>
            </div>
        `;
        return;
    }
    
    // Shift'ten personel al
    let shiftPersonnel = [];
    try {
        const today = new Date(date);
        const weekStart = getWeekStart(today);
        const weekKey = formatDateLocal(weekStart);
        let dayIndex = today.getDay() - 1;
        if (dayIndex < 0) dayIndex = 6;
        
        const shiftsSnapshot = await db.collection('shifts').where('branch', '==', branch).get();
        const allShifts = [];
        shiftsSnapshot.forEach(doc => allShifts.push(doc.data()));
        allShifts.sort((a, b) => (b.weekStart || '').localeCompare(a.weekStart || ''));
        
        const targetShift = allShifts.find(s => s.weekStart === weekKey) || allShifts[0];
        
        if (targetShift && targetShift.personelShifts) {
            const personelNames = targetShift.personelNames || {};
            const personelFullNames = targetShift.personelFullNames || {};
            
            for (const [uniqueId, days] of Object.entries(targetShift.personelShifts)) {
                const todayShift = days[dayIndex] || '';
                const cleanShift = todayShift.replace(/\*/g, '').trim().toUpperCase();
                
                // BÃ–LGE MÃœDÃœRÃœ HARÄ°Ã‡
                if (cleanShift && cleanShift !== 'Ä°' && cleanShift !== 'OFF' && cleanShift !== '-' && cleanShift !== 'X' && !cleanShift.includes('BÃ–LGE') && !cleanShift.includes('MÃœDÃœR')) {
                    // personelNames (codeName) KULLAN
                    const displayName = personelNames[uniqueId] || formatDisplayName(personelFullNames[uniqueId] || uniqueId.replace(/_/g, ' '));
                    shiftPersonnel.push(displayName);
                }
            }
        }
    } catch (e) {
        console.warn('Platform check shift alÄ±namadÄ±:', e.message);
    }
    
    const autoPersonName = shiftPersonnel.length > 0 ? shiftPersonnel[0] : (currentUser?.name || 'Personel');
    
    // Saatler
    const TIME_SLOTS = ['10:00', '12:00', '15:00', '18:00', '21:00', '00:00'];
    
    // Platformlar
    const platforms = ['TRENDYOL', 'YEMEK SEPETÄ°', 'GETÄ°R YEMEK', 'MÄ°GROS'];
    
    let html = `
        <div class="form-section">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px">
                <div>
                    <div style="font-size:1.3rem;font-weight:700;color:var(--tx)">ðŸ“± Platform Check</div>
                    <div style="font-size:.85rem;color:var(--tx2)">${new Date(date).toLocaleDateString('tr-TR', {weekday: 'long', day: 'numeric', month: 'long'})}</div>
                </div>
                <div style="display:flex;gap:12px;align-items:center">
                    ${isSubmitted ? `<div style="display:inline-flex;align-items:center;gap:6px;padding:8px 14px;background:rgba(39,174,96,.15);color:#27ae60;border-radius:20px;font-size:.85rem;font-weight:600">âœ“ TamamlandÄ±</div>` : ''}
                </div>
            </div>
            
            <div style="margin-bottom:20px;padding:16px;background:var(--bg3);border-radius:12px">
                <label class="form-label" style="margin-bottom:8px">ðŸ‘¤ Sorumlu Personel</label>
                ${isSubmitted ? `
                    <div style="font-size:1.1rem;font-weight:600;color:var(--tx);padding:8px 0">${submittedData?.personName || '-'}</div>
                    <input type="hidden" id="checklistPersonName" value="${submittedData?.personName || ''}" autocomplete="off">
                ` : `
                    <div style="font-size:1.1rem;font-weight:600;color:var(--tx);padding:8px 0">${currentUser?.name || 'Bilinmiyor'}</div>
                    <input type="hidden" id="checklistPersonName" value="${currentUser?.name || 'Bilinmiyor'}" autocomplete="off">
                    <div style="font-size:.75rem;color:#008c95;margin-top:4px">âœ“ GiriÅŸ yapan kullanÄ±cÄ±</div>
                `}
            </div>
            
            <!-- Yan yana tablolar -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;overflow-x:auto">
                
                <!-- MOONBERRY (ÅžiÅŸli) -->
                <div style="border-radius:12px;overflow:hidden;border:1px solid var(--cardBorder)">
                    <table style="width:100%;border-collapse:collapse" data-brand="MOONBERRY" data-branch="ÅžiÅŸli">
                        <thead>
                            <tr>
                                <th colspan="${platforms.length + 1}" style="padding:10px;text-align:center;font-weight:700;font-size:.95rem;background:#008c95;color:#fff;letter-spacing:1px">
                                    MOONBERRY
                                </th>
                            </tr>
                            <tr style="background:#008c95">
                                <th style="padding:8px;text-align:center;font-weight:600;color:#fff;border:1px solid rgba(255,255,255,.2);font-size:.75rem;width:60px">SAAT</th>
                                ${platforms.map(p => `<th style="padding:6px 4px;text-align:center;font-weight:600;color:#fff;border:1px solid rgba(255,255,255,.2);font-size:.65rem">${p}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
    `;
    
    // Moonberry satÄ±rlarÄ±
    TIME_SLOTS.forEach(time => {
        html += `<tr><td style="padding:8px;text-align:center;font-weight:700;background:#008c95;color:#fff;border:1px solid rgba(255,255,255,.2);font-size:.8rem">${time}</td>`;
        platforms.forEach(platform => {
            const key = `moonberry_${time}_${platform.replace(/\s/g, '_')}`;
            const savedValue = submittedData?.checks?.[key];
            const isOpen = savedValue === 'open';
            const isClosed = savedValue === 'closed';
            html += `
                <td style="padding:4px;text-align:center;border:1px solid var(--cardBorder);background:var(--bg2)">
                    <div style="display:flex;gap:2px;justify-content:center">
                        <span class="platform-btn" onclick="${isSubmitted ? '' : `selectPlatformCell(this, '${key}', 'open')`}"
                            style="display:inline-flex;width:24px;height:24px;border-radius:6px;align-items:center;justify-content:center;font-size:.85rem;
                            background:${isOpen ? '#008c95' : 'var(--bg3)'};border:1px solid ${isOpen ? '#008c95' : 'var(--cardBorder)'};color:${isOpen ? '#fff' : 'var(--tx3)'};cursor:pointer">âœ“</span>
                        <span class="platform-btn" onclick="${isSubmitted ? '' : `selectPlatformCell(this, '${key}', 'closed')`}"
                            style="display:inline-flex;width:24px;height:24px;border-radius:6px;align-items:center;justify-content:center;font-size:.85rem;
                            background:${isClosed ? '#e74c3c' : 'var(--bg3)'};border:1px solid ${isClosed ? '#e74c3c' : 'var(--cardBorder)'};color:${isClosed ? '#fff' : 'var(--tx3)'};cursor:pointer">âœ—</span>
                    </div>
                    <input type="hidden" name="platform_${key}" value="${savedValue || ''}">
                </td>`;
        });
        html += `</tr>`;
    });
    
    html += `
                        </tbody>
                    </table>
                </div>
                
                <!-- SUNBERRY (Tuzla) -->
                <div style="border-radius:12px;overflow:hidden;border:1px solid var(--cardBorder)">
                    <table style="width:100%;border-collapse:collapse" data-brand="SUNBERRY" data-branch="Tuzla">
                        <thead>
                            <tr>
                                <th colspan="${platforms.length + 1}" style="padding:10px;text-align:center;font-weight:700;font-size:.95rem;background:#ff8674;color:#fff;letter-spacing:1px">
                                    SUNBERRY
                                </th>
                            </tr>
                            <tr style="background:#ff8674">
                                <th style="padding:8px;text-align:center;font-weight:600;color:#fff;border:1px solid rgba(255,255,255,.2);font-size:.75rem;width:60px">SAAT</th>
                                ${platforms.map(p => `<th style="padding:6px 4px;text-align:center;font-weight:600;color:#fff;border:1px solid rgba(255,255,255,.2);font-size:.65rem">${p}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
    `;
    
    // Sunberry satÄ±rlarÄ±
    TIME_SLOTS.forEach(time => {
        html += `<tr><td style="padding:8px;text-align:center;font-weight:700;background:#ff8674;color:#fff;border:1px solid rgba(255,255,255,.2);font-size:.8rem">${time}</td>`;
        platforms.forEach(platform => {
            const key = `sunberry_${time}_${platform.replace(/\s/g, '_')}`;
            const savedValue = submittedData?.checks?.[key];
            const isOpen = savedValue === 'open';
            const isClosed = savedValue === 'closed';
            html += `
                <td style="padding:4px;text-align:center;border:1px solid var(--cardBorder);background:var(--bg2)">
                    <div style="display:flex;gap:2px;justify-content:center">
                        <span class="platform-btn" onclick="${isSubmitted ? '' : `selectPlatformCell(this, '${key}', 'open')`}"
                            style="display:inline-flex;width:24px;height:24px;border-radius:6px;align-items:center;justify-content:center;font-size:.85rem;
                            background:${isOpen ? '#ff8674' : 'var(--bg3)'};border:1px solid ${isOpen ? '#ff8674' : 'var(--cardBorder)'};color:${isOpen ? '#fff' : 'var(--tx3)'};cursor:pointer">âœ“</span>
                        <span class="platform-btn" onclick="${isSubmitted ? '' : `selectPlatformCell(this, '${key}', 'closed')`}"
                            style="display:inline-flex;width:24px;height:24px;border-radius:6px;align-items:center;justify-content:center;font-size:.85rem;
                            background:${isClosed ? '#e74c3c' : 'var(--bg3)'};border:1px solid ${isClosed ? '#e74c3c' : 'var(--cardBorder)'};color:${isClosed ? '#fff' : 'var(--tx3)'};cursor:pointer">âœ—</span>
                    </div>
                    <input type="hidden" name="platform_${key}" value="${savedValue || ''}">
                </td>`;
        });
        html += `</tr>`;
    });
    
    html += `
                        </tbody>
                    </table>
                </div>
            </div>
            
            ${!isSubmitted ? `
                <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end">
                    <button class="btn btn-primary" onclick="submitPlatformChecklist('${branch}', '${date}', '')">
                        âœ… Platform Check'i Tamamla
                    </button>
                </div>
            ` : ''}
        </div>
    `;
    
    container.innerHTML = html;
}

// Platform hÃ¼cre seÃ§
function selectPlatformCell(btn, key, value) {
    const cell = btn.closest('td');
    const hiddenInput = cell.querySelector('input[type="hidden"]');
    const btns = cell.querySelectorAll('.platform-btn');
    const openBtn = btns[0];
    const closedBtn = btns[1];
    
    // Marka rengini belirle
    const isMoonberry = key.startsWith('moonberry');
    const brandColor = isMoonberry ? '#008c95' : '#ff8674';
    
    // Reset
    openBtn.style.background = 'var(--bg3)';
    openBtn.style.borderColor = 'var(--cardBorder)';
    openBtn.style.color = 'var(--tx3)';
    closedBtn.style.background = 'var(--bg3)';
    closedBtn.style.borderColor = 'var(--cardBorder)';
    closedBtn.style.color = 'var(--tx3)';
    
    if (value === 'open') {
        hiddenInput.value = 'open';
        openBtn.style.background = brandColor;
        openBtn.style.borderColor = brandColor;
        openBtn.style.color = '#fff';
    } else {
        hiddenInput.value = 'closed';
        closedBtn.style.background = '#e74c3c';
        closedBtn.style.borderColor = '#e74c3c';
        closedBtn.style.color = '#fff';
    }
}

// Checklist gÃ¶nder
async function submitChecklist(branch, type, date, timeSlot) {
    const personName = document.getElementById('checklistPersonName')?.value?.trim();
    if (!personName) {
        toast('LÃ¼tfen personel adÄ±nÄ± girin', 'error');
        return;
    }
    
    // YÃ–NETÄ°CÄ° KONTROLÃœ - yÃ¶neticiler her ÅŸeyi doldurabilir
    const isManager = ['yonetici', 'bolge_muduru', 'magaza_muduru'].includes(currentUser?.role);
    
    // HAFTALIK Ã–ZEL SUBMIT
    if (type === 'haftalik') {
        await submitWeeklyChecklist(branch, date, personName, isManager);
        return;
    }
    
    if (!isManager) {
        // GiriÅŸ yapan kullanÄ±cÄ±nÄ±n adÄ±
        const currentUserName = currentUser?.name?.toLowerCase() || '';
        const enteredName = personName.toLowerCase();
        
        // KullanÄ±cÄ± kendi adÄ±nÄ± mÄ± girdi?
        const isSelf = currentUserName && (
            enteredName.includes(currentUserName.split(' ')[0].toLowerCase()) ||
            currentUserName.toLowerCase().includes(enteredName.split(' ')[0])
        );
        
        if (!isSelf) {
            toast('Sadece kendi adÄ±nÄ±za checklist doldurabilirsiniz', 'error');
            return;
        }
        
        // Sorumlu personel listesini kontrol et
        const responsibleEl = document.getElementById('responsiblePersonnelList');
        const responsibleNames = responsibleEl ? 
            Array.from(responsibleEl.querySelectorAll('span[style*="background"]')).map(s => s.textContent.trim().toLowerCase()) : [];
        
        // KullanÄ±cÄ± sorumlu listesinde mi?
        const isResponsible = responsibleNames.length === 0 || responsibleNames.some(n => 
            currentUserName.includes(n.split(' ')[0]) || n.includes(currentUserName.split(' ')[0])
        );
        
        if (!isResponsible) {
            // Bu saatte shift'i yok
            toast('Bu saatte shift\'iniz bulunmuyor. Checklist dolduramÄ±yorsunuz.', 'error');
            return;
        }
    }
    
    // TÃ¼m maddelerin cevaplandÄ±ÄŸÄ±nÄ± kontrol et
    const items = document.querySelectorAll('#checklistItems .checklist-item');
    const responses = [];
    const skippedItems = []; // Ã‡arpÄ± iÅŸaretlenen maddeler (notDone)
    let allAnswered = true;
    let doneCount = 0;
    
    items.forEach(item => {
        const doneInput = item.querySelector('input[value="done"]');
        const notdoneInput = item.querySelector('input[value="notdone"]');
        const itemId = doneInput?.name?.replace('check_', '');
        
        // Madde metnini DOM'dan al
        const textDiv = item.querySelector('div[style*="line-through"]') || 
                        item.querySelector('div[style*="line-height:1.6"]') || 
                        item.querySelector('.checklist-item-text-edit');
        const itemText = textDiv?.textContent?.trim() || textDiv?.value?.trim() || '';
        
        if (!doneInput?.checked && !notdoneInput?.checked) {
            allAnswered = false;
            item.style.borderColor = '#e74c3c';
        } else {
            item.style.borderColor = 'var(--cardBorder)';
            if (doneInput?.checked) doneCount++;
            
            const response = {
                id: itemId,
                checked: doneInput?.checked || false,
                notDone: notdoneInput?.checked || false
            };
            
            // Ã‡arpÄ± iÅŸaretlenen maddelere text ekle (geÃ§miÅŸ iÃ§in Ã¶nemli)
            if (notdoneInput?.checked && itemText) {
                response.text = itemText;
                skippedItems.push({
                    id: itemId,
                    text: itemText,
                    timestamp: new Date().toISOString()
                });
            }
            
            responses.push(response);
        }
    });
    
    if (!allAnswered) {
        toast('LÃ¼tfen tÃ¼m maddeleri iÅŸaretleyin', 'error');
        return;
    }
    
    // SÃ¼re hesapla
    const endTime = new Date();
    const actualDuration = checklistStartTime ? Math.round((endTime - checklistStartTime) / 1000) : 0;
    const actualMinutes = Math.round(actualDuration / 60);
    const expectedMinutes = Math.round(checklistExpectedDuration / 60);
    const minExpectedMinutes = Math.round(expectedMinutes * 0.3); // Minimum %30
    
    // SÃ¼re uyarÄ±sÄ± gÃ¶ster
    if (actualDuration > 0 && actualMinutes < minExpectedMinutes) {
        showCompletionConfirmModal(branch, type, date, timeSlot, personName, responses, actualMinutes, expectedMinutes, doneCount, items.length, skippedItems);
        return;
    }
    
    // DoÄŸrudan kaydet
    await saveChecklistAndShare(branch, type, date, timeSlot, personName, responses, actualMinutes, expectedMinutes, doneCount, items.length, skippedItems);
}

// HAFTALIK CHECKLIST Ã–ZEL SUBMIT
async function submitWeeklyChecklist(branch, date, personName, isManager) {
    const currentPersonnelId = currentUser?.personelId || currentUser?.uniqueId || currentUser?.id;
    const weeklyAssignments = window._weeklyTaskAssignments;
    
    if (!weeklyAssignments?.rawAssignments) {
        toast('HaftalÄ±k atama bilgisi bulunamadÄ±', 'error');
        return;
    }
    
    // Sadece kiÅŸinin maddelerini bul
    const myAssignments = isManager 
        ? weeklyAssignments.rawAssignments 
        : weeklyAssignments.rawAssignments.filter(a => a.personnelId === currentPersonnelId);
    
    if (myAssignments.length === 0) {
        toast('Size atanmÄ±ÅŸ gÃ¶rev bulunmuyor', 'warning');
        return;
    }
    
    // DOM'dan iÅŸaretlenen maddeleri al
    const items = document.querySelectorAll('#checklistItems .checklist-item');
    let completedCount = 0;
    let skippedCount = 0;
    const errors = [];
    
    for (const item of items) {
        const doneInput = item.querySelector('input[value="done"]');
        const notdoneInput = item.querySelector('input[value="notdone"]');
        const itemId = doneInput?.name?.replace('check_', '');
        
        // Bu madde kiÅŸiye atanmÄ±ÅŸ mÄ±?
        const assignment = myAssignments.find(a => a.itemId === itemId);
        if (!assignment) continue; // BaÅŸkasÄ±nÄ±n maddesi, atla
        
        // Zaten tamamlanmÄ±ÅŸ mÄ±?
        if (assignment.status === 'completed') continue;
        
        // Ä°ÅŸaretlenmiÅŸ mi?
        if (doneInput?.checked) {
            // Tamamla ve cooldown baÅŸlat
            try {
                await completeWeeklyItem(branch, itemId, assignment.personnelId);
                completedCount++;
                
                // UI gÃ¼ncelle - maddeyi yeÅŸil yap
                item.style.opacity = '0.6';
                item.style.background = 'rgba(39,174,96,0.1)';
                
            } catch (e) {
                console.error('Madde tamamlama hatasÄ±:', e);
                errors.push(assignment.itemText);
            }
        } else if (notdoneInput?.checked) {
            skippedCount++;
        }
    }
    
    // SonuÃ§ mesajÄ±
    if (completedCount > 0) {
        toast(`âœ… ${completedCount} gÃ¶rev tamamlandÄ±! Cooldown baÅŸladÄ±.`, 'success');
        
        // SayfayÄ± yenile (atamalarÄ± gÃ¼ncellemek iÃ§in)
        setTimeout(() => {
            loadChecklist();
        }, 1500);
    } else if (skippedCount > 0) {
        toast(`${skippedCount} gÃ¶rev atlandÄ±`, 'info');
    } else {
        toast('LÃ¼tfen en az bir gÃ¶revi iÅŸaretleyin', 'warning');
    }
    
    if (errors.length > 0) {
        console.error('Tamamlanamayan gÃ¶revler:', errors);
    }
}

// Sorumlu olmayan personel uyarÄ±sÄ±
function showNotResponsibleWarning(branch, type, date, timeSlot, personName, responsibleNames) {
    const modal = document.createElement('div');
    modal.id = 'notResponsibleModal';
    modal.innerHTML = `
        <div style="position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px">
            <div style="background:var(--bg2);border-radius:20px;max-width:420px;width:100%;padding:32px;text-align:center;border:1px solid var(--cardBorder)">
                <div style="width:64px;height:64px;background:rgba(255,193,7,.15);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px">
                    <svg width="32" height="32" fill="none" stroke="#ffc107" stroke-width="2" viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                </div>
                <h3 style="font-size:1.3rem;font-weight:700;color:var(--tx);margin-bottom:12px">Sorumlu Personel DeÄŸilsiniz</h3>
                <p style="color:var(--tx2);margin-bottom:16px;line-height:1.6">
                    Bu checklist iÃ§in sorumlu personeller:<br>
                    <strong style="color:var(--tx)">${responsibleNames.join(', ')}</strong>
                </p>
                <p style="color:var(--tx2);font-size:.85rem;margin-bottom:24px">
                    Sadece sorumlu personeller checklist doldurabilir. YardÄ±m iÃ§in mÃ¼dÃ¼rÃ¼nÃ¼zle iletiÅŸime geÃ§in.
                </p>
                <button onclick="document.getElementById('notResponsibleModal').remove()" class="btn btn-primary" style="padding:12px 32px">
                    Tamam
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Tamamlama onay modal'Ä±
function showCompletionConfirmModal(branch, type, date, timeSlot, personName, responses, actualMinutes, expectedMinutes, doneCount, totalCount, skippedItems = []) {
    const typeInfo = CHECKLIST_TYPES[branch]?.find(t => t.id === type);
    const typeName = typeInfo?.name || type;
    
    const modal = document.createElement('div');
    modal.id = 'completionConfirmModal';
    modal.innerHTML = `
        <div style="position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px">
            <div style="background:var(--bg2);border-radius:20px;max-width:420px;width:100%;padding:32px;text-align:center;border:1px solid var(--cardBorder)">
                <div style="width:64px;height:64px;background:rgba(255,134,116,.15);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px">
                    <svg width="32" height="32" fill="none" stroke="#ff8674" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                </div>
                <h3 style="font-size:1.3rem;font-weight:700;color:var(--tx);margin-bottom:12px">SÃ¼re KontrolÃ¼</h3>
                <p style="color:var(--tx2);margin-bottom:24px;line-height:1.6">
                    <strong>${typeName}</strong> iÃ§in tahmini sÃ¼re <strong>${expectedMinutes} dakika</strong> iken, 
                    siz <strong>${actualMinutes} dakikada</strong> tamamladÄ±nÄ±z.<br><br>
                    TÃ¼m kontrolleri gerÃ§ekleÅŸtirdiÄŸinizden emin misiniz?
                </p>
                <div style="display:flex;gap:12px;justify-content:center">
                    <button onclick="document.getElementById('completionConfirmModal').remove()" class="btn btn-ghost" style="padding:12px 24px">
                        â† Geri DÃ¶n
                    </button>
                    <button onclick="confirmAndSaveChecklist('${branch}', '${type}', '${date}', '${timeSlot || ''}', '${personName}', ${actualMinutes}, ${expectedMinutes}, ${doneCount}, ${totalCount})" class="btn btn-primary" style="padding:12px 24px">
                        âœ“ Evet, Tamamla
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Responses ve skippedItems'Ä± geÃ§ici sakla
    window._pendingResponses = responses;
    window._pendingSkippedItems = skippedItems;
}

// OnaylÄ± kaydet
async function confirmAndSaveChecklist(branch, type, date, timeSlot, personName, actualMinutes, expectedMinutes, doneCount, totalCount) {
    document.getElementById('completionConfirmModal')?.remove();
    const responses = window._pendingResponses || [];
    const skippedItems = window._pendingSkippedItems || [];
    await saveChecklistAndShare(branch, type, date, timeSlot, personName, responses, actualMinutes, expectedMinutes, doneCount, totalCount, skippedItems);
}

// Checklist'i kaydet ve paylaÅŸ
async function saveChecklistAndShare(branch, type, date, timeSlot, personName, responses, actualMinutes, expectedMinutes, doneCount, totalCount, skippedItems = []) {
    try {
        const checklistId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_${type}`;
        const submissionId = `${checklistId}_${date}${timeSlot ? '_' + timeSlot.replace(':', '') : ''}`;
        
        // Puan hesaplama
        let points = 0;
        let pointStatus = 'completed';
        const rules = CHECK_RULES[type];
        
        if (rules) {
            const now = new Date();
            
            // TimeSlot varsa timeSlot bazlÄ±, yoksa deadline bazlÄ± hesapla
            if (timeSlot) {
                const status = getCheckStatus(type, timeSlot, branch, true, now);
                points = status.points;
                pointStatus = status.status;
            } else if (rules.deadline) {
                // Deadline bazlÄ± checkler (acilis, kapanis)
                const [deadlineH, deadlineM] = rules.deadline.split(':').map(Number);
                const deadlineTime = new Date(date);
                deadlineTime.setHours(deadlineH, deadlineM, 0, 0);
                
                // KapanÄ±ÅŸ iÃ§in ertesi gÃ¼n
                if (type === 'kapanis' && deadlineH < 12) {
                    deadlineTime.setDate(deadlineTime.getDate() + 1);
                }
                
                if (now <= deadlineTime) {
                    points = rules.points?.onTime || 0;
                    pointStatus = 'onTime';
                } else {
                    // GeÃ§ penceresi kontrolÃ¼
                    const lateWindow = rules.lateWindow || 30;
                    const lateDeadline = new Date(deadlineTime.getTime() + lateWindow * 60000);
                    
                    if (now <= lateDeadline) {
                        points = rules.points?.late || 0;
                        pointStatus = 'late';
                    } else {
                        points = rules.points?.missed || -1;
                        pointStatus = 'missed';
                    }
                }
            } else {
                // Deadline yoksa vaktinde sayÄ±lÄ±r
                points = rules.points?.onTime || 0;
                pointStatus = 'onTime';
            }
            
            // MÃ¼dÃ¼r hariÃ§ puan kaydÄ± yap
            let isPersonMudur = false;
            try {
                const personelSnap = await db.collection('personel')
                    .where('name', '==', personName)
                    .limit(1)
                    .get();
                if (!personelSnap.empty) {
                    const personRole = personelSnap.docs[0].data().role || '';
                    isPersonMudur = ['magaza_muduru', 'bolge_muduru', 'yonetici'].includes(personRole);
                }
            } catch (e) { console.warn('Personel rol kontrolÃ¼ hatasÄ±:', e); }
            
            // Her durumda puan kaydÄ± yap (onTime dahil)
            if (!isPersonMudur) {
                await createAutoPuantajNote(
                    normalizePersonelId(personName),
                    personName,
                    type,
                    timeSlot || rules.deadline || 'manual',
                    pointStatus,
                    points,
                    branch,
                    date
                );
            }
        }
        
        // startTime null ise ÅŸimdiki zamandan actualMinutes Ã§Ä±kar
        const now = new Date();
        let startTimeStr = checklistStartTime?.toISOString() || null;
        if (!startTimeStr && actualMinutes > 0) {
            const estimatedStart = new Date(now.getTime() - actualMinutes * 60000);
            startTimeStr = estimatedStart.toISOString();
        } else if (!startTimeStr) {
            startTimeStr = now.toISOString(); // Fallback: ÅŸimdiki zaman
        }
        
        const submissionData = {
            checklistId,
            branch,
            type,
            checklistType: type, // Otomatik puanlama iÃ§in
            date,
            timeSlot: timeSlot || null,
            personName,
            submittedBy: currentUser?.id,
            submittedByName: currentUser?.name || personName,
            submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
            startTime: startTimeStr,
            endTime: now.toISOString(),
            actualDurationMinutes: actualMinutes,
            expectedDurationMinutes: expectedMinutes,
            completionRate: Math.round((doneCount / totalCount) * 100),
            items: responses,
            // Ã‡arpÄ± iÅŸaretlenen (yapÄ±lmayan) maddeler - geÃ§miÅŸ iÃ§in Ã¶nemli
            skippedItems: skippedItems.length > 0 ? skippedItems : null,
            // Puan bilgileri
            points,
            pointStatus,
            status: pointStatus, // Otomatik puanlama iÃ§in
            userRole: currentUser?.role
        };
        
        await db.collection('checklistSubmissions').doc(submissionId).set(submissionData);
        
        // Rozet kontrolÃ¼
        checkAndAwardBadges(normalizePersonelId(personName), personName, {
            actualMinutes, expectedMinutes, pointStatus, type
        }).catch(() => {});
        
        // BaÅŸarÄ± modal'Ä± gÃ¶ster
        showChecklistCompleteModal(branch, type, date, timeSlot, personName, actualMinutes, expectedMinutes, doneCount, totalCount, points, pointStatus);
        
    } catch (error) {
        console.error('Checklist kayÄ±t hatasÄ±:', error);
        toast('KayÄ±t hatasÄ±!', 'error');
    }
}

// Checklist tamamlandÄ± modal'Ä± - WhatsApp paylaÅŸÄ±mÄ± ile
function showChecklistCompleteModal(branch, type, date, timeSlot, personName, actualMinutes, expectedMinutes, doneCount, totalCount, points = 0, pointStatus = 'completed') {
    const typeInfo = CHECKLIST_TYPES[branch]?.find(t => t.id === type);
    const typeName = typeInfo?.name || type;
    const completionRate = Math.round((doneCount / totalCount) * 100);
    const dateStr = new Date(date).toLocaleDateString('tr-TR', {day: 'numeric', month: 'long', year: 'numeric'});
    const timeStr = new Date().toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'});
    
    // Puan bilgisi
    let pointsHtml = '';
    if (points !== 0 || pointStatus !== 'completed') {
        const pointColor = points > 0 ? '#27ae60' : points < 0 ? '#e74c3c' : '#95a5a6';
        const pointIcon = points > 0 ? 'ðŸŽ‰' : points < 0 ? 'âš ï¸' : 'âœ“';
        const pointLabel = pointStatus === 'onTime' ? 'Vaktinde' : pointStatus === 'late' ? 'GeÃ§' : '';
        pointsHtml = `
            <div style="background:${points > 0 ? 'rgba(39,174,96,.1)' : points < 0 ? 'rgba(231,76,60,.1)' : 'var(--bg3)'};border-radius:12px;padding:16px;margin-bottom:20px;display:flex;align-items:center;justify-content:center;gap:12px">
                <span style="font-size:1.5rem">${pointIcon}</span>
                <div>
                    <div style="font-size:.85rem;color:var(--tx2)">${pointLabel} dolduruldu</div>
                    <div style="font-size:1.3rem;font-weight:700;color:${pointColor}">${points > 0 ? '+' : ''}${points} Puan</div>
                </div>
            </div>
        `;
    }
    
    const modal = document.createElement('div');
    modal.id = 'checklistCompleteModal';
    modal.innerHTML = `
        <div style="position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px">
            <div style="background:var(--bg2);border-radius:20px;max-width:480px;width:100%;padding:32px;text-align:center;border:1px solid var(--cardBorder)">
                <div style="width:80px;height:80px;background:linear-gradient(135deg,rgba(39,174,96,.2),rgba(39,174,96,.1));border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 24px">
                    <svg width="40" height="40" fill="none" stroke="#27ae60" stroke-width="2.5" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                </div>
                <h3 style="font-size:1.5rem;font-weight:700;color:var(--tx);margin-bottom:8px">Checklist TamamlandÄ±!</h3>
                <p style="color:var(--tx2);margin-bottom:24px">${typeName} â€¢ ${branch}</p>
                
                ${pointsHtml}
                
                <div style="background:var(--bg3);border-radius:12px;padding:20px;margin-bottom:24px;text-align:left">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                        <div>
                            <div style="font-size:.75rem;color:var(--tx3);margin-bottom:4px">Personel</div>
                            <div style="font-weight:600;color:var(--tx)">${personName}</div>
                        </div>
                        <div>
                            <div style="font-size:.75rem;color:var(--tx3);margin-bottom:4px">Tarih</div>
                            <div style="font-weight:600;color:var(--tx)">${dateStr}</div>
                        </div>
                        <div>
                            <div style="font-size:.75rem;color:var(--tx3);margin-bottom:4px">SÃ¼re</div>
                            <div style="font-weight:600;color:var(--tx)">${actualMinutes} dk <span style="color:var(--tx3);font-weight:400">(tahmini ${expectedMinutes} dk)</span></div>
                        </div>
                        <div>
                            <div style="font-size:.75rem;color:var(--tx3);margin-bottom:4px">Tamamlama</div>
                            <div style="font-weight:600;color:#27ae60">${completionRate}% (${doneCount}/${totalCount})</div>
                        </div>
                    </div>
                </div>
                
                <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
                    <button onclick="closeCompleteModalAndRefresh()" class="btn btn-ghost" style="padding:12px 20px">
                        âœ“ Tamam
                    </button>
                    <button onclick="shareChecklistToWhatsApp('${branch}', '${typeName}', '${personName}', '${dateStr}', '${timeStr}', ${actualMinutes}, ${completionRate}, ${doneCount}, ${totalCount})" class="btn btn-primary" style="padding:12px 20px;background:linear-gradient(135deg,#25D366,#128C7E)">
                        <svg width="18" height="18" fill="#fff" viewBox="0 0 24 24" style="margin-right:6px"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                        WhatsApp'ta PaylaÅŸ
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Modal kapat ve yenile
function closeCompleteModalAndRefresh() {
    document.getElementById('checklistCompleteModal')?.remove();
    loadChecklist();
}

// WhatsApp'ta paylaÅŸ
function shareChecklistToWhatsApp(branch, typeName, personName, dateStr, timeStr, duration, rate, done, total) {
    const whatsappLink = WHATSAPP_GROUPS[branch];
    
    const message = `âœ… *CHECKLIST TAMAMLANDI*

ðŸ“‹ *${typeName}*
ðŸ“ ${branch}
ðŸ‘¤ ${personName}
ðŸ“… ${dateStr} - ${timeStr}

â±ï¸ SÃ¼re: ${duration} dakika
âœ“ Tamamlanan: ${done}/${total} (%${rate})

_Moonberry Ä°K Sistemi_`;

    const encodedMessage = encodeURIComponent(message);
    
    // WhatsApp grup linkini aÃ§
    if (whatsappLink) {
        // Ã–nce mesajÄ± kopyala
        navigator.clipboard?.writeText(message).then(() => {
            toast('Mesaj kopyalandÄ±! WhatsApp grubu aÃ§Ä±lÄ±yor...', 'success');
        }).catch(() => {});
        
        // Grup linkini aÃ§
        setTimeout(() => {
            window.open(whatsappLink, '_blank');
        }, 500);
    } else {
        // Genel WhatsApp paylaÅŸÄ±mÄ±
        window.open(`https://wa.me/?text=${encodedMessage}`, '_blank');
    }
    
    document.getElementById('checklistCompleteModal')?.remove();
    loadChecklist();
}

// Platform checklist gÃ¶nder
async function submitPlatformChecklist(branch, date, timeSlot) {
    const personName = document.getElementById('checklistPersonName')?.value?.trim();
    if (!personName) {
        toast('LÃ¼tfen personel adÄ±nÄ± girin', 'error');
        return;
    }
    
    // Saatler ve platformlar
    const TIME_SLOTS = ['10:00', '12:00', '15:00', '18:00', '21:00', '00:00'];
    const platforms = ['TRENDYOL', 'YEMEK SEPETÄ°', 'GETÄ°R YEMEK', 'MÄ°GROS'];
    const brands = ['moonberry', 'sunberry'];
    
    const checks = {};
    let allAnswered = true;
    let moonberryOpen = 0, moonberryClosed = 0;
    let sunberryOpen = 0, sunberryClosed = 0;
    
    brands.forEach(brand => {
        TIME_SLOTS.forEach(time => {
            platforms.forEach(platform => {
                const key = `${brand}_${time}_${platform.replace(/\s/g, '_')}`;
                const hiddenInput = document.querySelector(`input[name="platform_${key}"]`);
                const value = hiddenInput?.value;
                
                if (!value) {
                    allAnswered = false;
                } else {
                    checks[key] = value;
                    if (brand === 'moonberry') {
                        value === 'open' ? moonberryOpen++ : moonberryClosed++;
                    } else {
                        value === 'open' ? sunberryOpen++ : sunberryClosed++;
                    }
                }
            });
        });
    });
    
    if (!allAnswered) {
        toast('LÃ¼tfen tÃ¼m platformlarÄ± iÅŸaretleyin', 'error');
        return;
    }
    
    try {
        const submissionId = `platform_${date}`;
        const now = new Date();
        
        // Puan hesaplama - Platform check vaktinde = 0, dolduruldu = 0
        // MÃ¼dÃ¼r hariÃ§ herkes iÃ§in kaydedilir
        const isMudur = ['magaza_muduru', 'bolge_muduru', 'yonetici'].includes(currentUser?.role);
        
        await db.collection('checklistSubmissions').doc(submissionId).set({
            type: 'platform',
            checklistType: 'platform', // Otomatik puanlama iÃ§in
            date,
            personName,
            submittedBy: currentUser?.id,
            submittedByName: currentUser?.name || personName,
            submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
            checks,
            summary: {
                moonberry: { open: moonberryOpen, closed: moonberryClosed },
                sunberry: { open: sunberryOpen, closed: sunberryClosed }
            },
            points: 0,
            pointStatus: 'completed',
            status: 'completed', // Otomatik puanlama iÃ§in
            userRole: currentUser?.role
        });
        
        // BaÅŸarÄ± mesajÄ± ve modal
        showPlatformCompleteModal(date, personName, moonberryOpen, moonberryClosed, sunberryOpen, sunberryClosed);
        
    } catch (error) {
        console.error('Platform check kayÄ±t hatasÄ±:', error);
        toast('KayÄ±t hatasÄ±!', 'error');
    }
}

// Platform check tamamlandÄ± modal'Ä±
function showPlatformCompleteModal(date, personName, moonberryOpen, moonberryClosed, sunberryOpen, sunberryClosed) {
    const dateStr = new Date(date).toLocaleDateString('tr-TR', {day: 'numeric', month: 'long', year: 'numeric'});
    const timeStr = new Date().toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'});
    
    const modal = document.createElement('div');
    modal.id = 'platformCompleteModal';
    modal.innerHTML = `
        <div style="position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px">
            <div style="background:var(--bg2);border-radius:20px;max-width:480px;width:100%;padding:32px;text-align:center;border:1px solid var(--cardBorder)">
                <div style="width:80px;height:80px;background:linear-gradient(135deg,rgba(39,174,96,.2),rgba(39,174,96,.1));border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 24px">
                    <svg width="40" height="40" fill="none" stroke="#27ae60" stroke-width="2.5" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                </div>
                <h3 style="font-size:1.4rem;font-weight:700;color:var(--tx);margin-bottom:8px">Platform Check TamamlandÄ±!</h3>
                <p style="color:var(--tx2);margin-bottom:24px">${dateStr} â€¢ ${timeStr}</p>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px">
                    <div style="background:#008c95;border-radius:12px;padding:16px;color:#fff">
                        <div style="font-weight:700;margin-bottom:8px">MOONBERRY</div>
                        <div style="font-size:.9rem">âœ“ AÃ§Ä±k: ${moonberryOpen}</div>
                        <div style="font-size:.9rem">âœ— KapalÄ±: ${moonberryClosed}</div>
                    </div>
                    <div style="background:#ff8674;border-radius:12px;padding:16px;color:#fff">
                        <div style="font-weight:700;margin-bottom:8px">SUNBERRY</div>
                        <div style="font-size:.9rem">âœ“ AÃ§Ä±k: ${sunberryOpen}</div>
                        <div style="font-size:.9rem">âœ— KapalÄ±: ${sunberryClosed}</div>
                    </div>
                </div>
                
                <button onclick="document.getElementById('platformCompleteModal').remove(); loadChecklist();" class="btn btn-primary" style="padding:14px 32px">
                    âœ“ Tamam
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Checklist madde ekle modal
// Yeni checklist tÃ¼rÃ¼ ekleme modal
function showAddChecklistTypeModal() {
    const branch = document.getElementById('checklistSube')?.value;
    
    if (!branch) {
        toast('Ã–nce ÅŸube seÃ§in', 'error');
        return;
    }
    
    showModal('Yeni Checklist TÃ¼rÃ¼ Ekle', `
        <div class="form-group">
            <label class="form-label">Åžube</label>
            <input type="text" class="form-input" value="${branch}" disabled>
        </div>
        <div class="form-group">
            <label class="form-label">TÃ¼r ID *</label>
            <input type="text" id="newChecklistTypeId" class="form-input" placeholder="Ã¶rn: ogle_kontrol">
            <div style="font-size:.75rem;color:var(--tx3);margin-top:4px">KÃ¼Ã§Ã¼k harf, boÅŸluksuz, TÃ¼rkÃ§e karakter olmadan</div>
        </div>
        <div class="form-group">
            <label class="form-label">TÃ¼r AdÄ± *</label>
            <input type="text" id="newChecklistTypeName" class="form-input" placeholder="Ã¶rn: Ã–ÄŸle Kontrol">
        </div>
        <div class="form-group">
            <label class="form-label">Ä°kon</label>
            <select id="newChecklistTypeIcon" class="form-select">
                <option value="clipboard-check">ðŸ“‹ Checklist</option>
                <option value="sun">â˜€ï¸ GÃ¼neÅŸ (AÃ§Ä±lÄ±ÅŸ)</option>
                <option value="moon">ðŸŒ™ Ay (KapanÄ±ÅŸ)</option>
                <option value="clock">ðŸ• Saat</option>
                <option value="calendar">ðŸ“… Takvim</option>
                <option value="refresh-cw">ðŸ”„ GÃ¼ncel</option>
                <option value="coffee">â˜• Kahve</option>
                <option value="truck">ðŸšš AraÃ§</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Saat Dilimleri (opsiyonel)</label>
            <input type="text" id="newChecklistTypeTimeSlots" class="form-input" placeholder="Ã¶rn: 10:00,14:00,18:00">
            <div style="font-size:.75rem;color:var(--tx3);margin-top:4px">VirgÃ¼lle ayÄ±rÄ±n, boÅŸ bÄ±rakÄ±lÄ±rsa saat dilimi olmaz</div>
        </div>
    `, `
        <button class="btn btn-ghost" onclick="closeModal()">Ä°ptal</button>
        <button class="btn btn-primary" onclick="addChecklistType('${branch}')">Ekle</button>
    `);
}

// Yeni checklist tÃ¼rÃ¼ ekle
async function addChecklistType(branch) {
    const typeId = document.getElementById('newChecklistTypeId')?.value?.trim().toLowerCase().replace(/\s+/g, '_');
    const typeName = document.getElementById('newChecklistTypeName')?.value?.trim();
    const icon = document.getElementById('newChecklistTypeIcon')?.value || 'clipboard-check';
    const timeSlotsRaw = document.getElementById('newChecklistTypeTimeSlots')?.value?.trim();
    
    if (!typeId || !typeName) {
        toast('TÃ¼r ID ve adÄ± gerekli', 'error');
        return;
    }
    
    if (!/^[a-z0-9_]+$/.test(typeId)) {
        toast('TÃ¼r ID sadece kÃ¼Ã§Ã¼k harf, rakam ve alt Ã§izgi iÃ§erebilir', 'error');
        return;
    }
    
    const timeSlots = timeSlotsRaw ? timeSlotsRaw.split(',').map(t => t.trim()).filter(Boolean) : [];
    
    try {
        const configRef = db.collection('config').doc('checklistTypes');
        const configDoc = await configRef.get();
        
        let checklistTypes = configDoc.exists ? configDoc.data() : {};
        
        if (!checklistTypes[branch] || !Array.isArray(checklistTypes[branch])) {
            checklistTypes[branch] = [];
        }
        
        if (checklistTypes[branch].some(t => t.id === typeId)) {
            toast('Bu ID zaten mevcut', 'error');
            return;
        }
        
        const newType = { id: typeId, name: typeName, icon };
        if (timeSlots.length > 0) {
            newType.timeSlots = timeSlots;
        }
        
        checklistTypes[branch].push(newType);
        await configRef.set(checklistTypes);
        
        CHECKLIST_TYPES[branch] = checklistTypes[branch];
        
        // CHECK_RULES'a da ekle (yoksa)
        if (!CHECK_RULES[typeId]) {
            CHECK_RULES[typeId] = {
                name: typeName,
                description: `${typeName} kontrol listesi`,
                enabled: true,
                timeSlots: timeSlots.length > 0 ? timeSlots : null,
                deadline: timeSlots.length === 0 ? '23:59' : null,
                window: { before: 30, after: 30 },
                lateWindow: 30,
                points: { onTime: 0, late: 0, missed: -1 },
                responsibleShift: 'auto'
            };
            
            // Firebase'e de kaydet
            try {
                const sysDoc = await db.collection('config').doc('system').get();
                const sysData = sysDoc.exists ? sysDoc.data() : {};
                sysData.checkRules = CHECK_RULES;
                await db.collection('config').doc('system').set(sysData, { merge: true });
                console.log(`[CHECK_RULES] Yeni tÃ¼r eklendi: ${typeId}`);
            } catch (e) {
                console.warn('CHECK_RULES kayÄ±t hatasÄ±:', e);
            }
        }
        
        closeModal();
        toast('Checklist tÃ¼rÃ¼ eklendi', 'success');
        loadChecklistTypes();
        
    } catch (error) {
        console.error('TÃ¼r ekleme hatasÄ±:', error);
        toast('Ekleme hatasÄ±!', 'error');
    }
}

function showAddChecklistItemModal() {
    const branch = document.getElementById('checklistSube')?.value;
    const type = document.getElementById('checklistType')?.value;
    
    if (!branch || !type) {
        toast('Ã–nce checklist seÃ§in', 'error');
        return;
    }
    
    const isAylik = type === 'aylik';
    
    // Tarih seÃ§enekleri (1-31)
    let dateOptions = '';
    for (let i = 1; i <= 31; i++) {
        dateOptions += `<label style="display:inline-flex;align-items:center;gap:4px;padding:4px 8px;background:var(--bg3);border-radius:6px;cursor:pointer;font-size:.8rem">
            <input type="checkbox" class="newItemDate" value="${i}" style="accent-color:#008c95"> ${i}
        </label>`;
    }
    
    showModal('Yeni Madde Ekle', `
        <div class="form-group">
            <label class="form-label">Madde Metni</label>
            <textarea id="newChecklistItemText" class="form-input" rows="3" placeholder="Kontrol maddesi..."></textarea>
        </div>
        ${isAylik ? `
        <div class="form-group">
            <label class="form-label">Sorumlu</label>
            <select id="newChecklistItemResponsible" class="form-input" onchange="updateResponsibleColor()">
                <option value="">SeÃ§in...</option>
                <option value="AÃ‡ILIÅžÃ‡I" data-color="#0ea5e9">ðŸ”µ AÃ§Ä±lÄ±ÅŸÃ§Ä±</option>
                <option value="HER SHIFT" data-color="#eab308">ðŸŸ¡ Her Shift</option>
                <option value="ARACI" data-color="#dc2626">ðŸ”´ AracÄ±</option>
                <option value="KAPANIÅžÃ‡I" data-color="#f97316">ðŸŸ  KapanÄ±ÅŸÃ§Ä±</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Tarihler</label>
            <div style="margin-bottom:8px">
                <button type="button" class="btn btn-sm btn-ghost" onclick="selectAllDates()">TÃ¼mÃ¼nÃ¼ SeÃ§</button>
                <button type="button" class="btn btn-sm btn-ghost" onclick="selectOddDates()">Tek GÃ¼nler (1,3,5...)</button>
                <button type="button" class="btn btn-sm btn-ghost" onclick="selectEvenDates()">Ã‡ift GÃ¼nler (2,4,6...)</button>
                <button type="button" class="btn btn-sm btn-ghost" onclick="clearAllDates()">Temizle</button>
            </div>
            <div style="display:flex;flex-wrap:wrap;gap:6px;max-height:200px;overflow-y:auto;padding:8px;background:var(--bg2);border-radius:8px">
                ${dateOptions}
            </div>
            <div style="margin-top:8px">
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                    <input type="checkbox" id="newItemEveryDay" onchange="toggleEveryDay()" style="accent-color:#008c95">
                    <span style="font-weight:600">Her gÃ¼n (tarih seÃ§meden)</span>
                </label>
            </div>
        </div>
        ` : ``}
    `, `
        <button class="btn btn-ghost" onclick="closeModal()">Ä°ptal</button>
        <button class="btn btn-primary" onclick="addChecklistItem('${branch}', '${type}')">Ekle</button>
    `);
}

// Tarih seÃ§im yardÄ±mcÄ±larÄ±
function selectAllDates() {
    document.querySelectorAll('.newItemDate').forEach(cb => cb.checked = true);
    document.getElementById('newItemEveryDay').checked = false;
}
function selectOddDates() {
    document.querySelectorAll('.newItemDate').forEach(cb => {
        cb.checked = parseInt(cb.value) % 2 === 1;
    });
    document.getElementById('newItemEveryDay').checked = false;
}
function selectEvenDates() {
    document.querySelectorAll('.newItemDate').forEach(cb => {
        cb.checked = parseInt(cb.value) % 2 === 0;
    });
    document.getElementById('newItemEveryDay').checked = false;
}
function clearAllDates() {
    document.querySelectorAll('.newItemDate').forEach(cb => cb.checked = false);
}
function toggleEveryDay() {
    const everyDay = document.getElementById('newItemEveryDay').checked;
    if (everyDay) {
        document.querySelectorAll('.newItemDate').forEach(cb => cb.checked = false);
    }
}

// Sorumlu renk gÃ¼ncelle
function updateResponsibleColor() {
    const select = document.getElementById('newChecklistItemResponsible');
    const option = select.options[select.selectedIndex];
    const color = option.dataset.color || '#6b7280';
    select.style.borderColor = color;
    select.style.borderWidth = '2px';
}

// Checklist madde ekle
async function addChecklistItem(branch, type) {
    const text = document.getElementById('newChecklistItemText')?.value?.trim();
    const isAylik = type === 'aylik';
    
    if (!text) {
        toast('Madde metni gerekli', 'error');
        return;
    }
    
    // Aylik iÃ§in ek alanlar
    let responsible = '';
    let color = '';
    let dates = [];
    
    if (isAylik) {
        const responsibleSelect = document.getElementById('newChecklistItemResponsible');
        responsible = responsibleSelect?.value || '';
        const option = responsibleSelect?.options[responsibleSelect.selectedIndex];
        color = option?.dataset?.color || '#6b7280';
        
        const everyDay = document.getElementById('newItemEveryDay')?.checked;
        if (!everyDay) {
            document.querySelectorAll('.newItemDate:checked').forEach(cb => {
                dates.push(parseInt(cb.value));
            });
        }
        
        if (!responsible) {
            toast('Sorumlu seÃ§in', 'error');
            return;
        }
    }
    
    const penalty = document.getElementById('newChecklistItemPenalty')?.value?.trim();
    
    try {
        const checklistId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_${type}`;
        const checklistRef = db.collection('checklists').doc(checklistId);
        const doc = await checklistRef.get();
        
        const newItem = {
            id: 'item_' + Date.now(),
            text,
            penalty: penalty || null,
            order: (doc.exists ? doc.data().items?.length : 0) + 1
        };
        
        // Aylik iÃ§in ek alanlar
        if (isAylik) {
            newItem.responsible = responsible;
            newItem.color = color;
            newItem.dates = dates;
        }
        
        if (doc.exists) {
            await checklistRef.update({
                items: firebase.firestore.FieldValue.arrayUnion(newItem),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        } else {
            await checklistRef.set({
                branch,
                type,
                items: [newItem],
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        closeModal();
        toast('Madde eklendi', 'success');
        loadChecklist();
        
    } catch (error) {
        console.error('Madde ekleme hatasÄ±:', error);
        toast('Ekleme hatasÄ±!', 'error');
    }
}

// Checklist madde sil
async function deleteChecklistItem(itemId) {
    if (!confirm('Bu maddeyi silmek istediÄŸinize emin misiniz?')) return;
    
    const branch = document.getElementById('checklistSube')?.value;
    const type = document.getElementById('checklistType')?.value;
    
    try {
        const checklistId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_${type}`;
        const checklistRef = db.collection('checklists').doc(checklistId);
        const doc = await checklistRef.get();
        
        if (doc.exists) {
            const items = doc.data().items.filter(i => i.id !== itemId);
            await checklistRef.update({
                items,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        toast('Madde silindi', 'success');
        loadChecklist();
        
    } catch (error) {
        console.error('Madde silme hatasÄ±:', error);
        toast('Silme hatasÄ±!', 'error');
    }
}

// Checklist madde dÃ¼zenle modal
async function showEditChecklistItemModal(itemId) {
    const branch = document.getElementById('checklistSube')?.value;
    const type = document.getElementById('checklistType')?.value;
    
    if (!branch || !type) {
        toast('Checklist bulunamadÄ±', 'error');
        return;
    }
    
    try {
        const checklistId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_${type}`;
        const checklistRef = db.collection('checklists').doc(checklistId);
        const doc = await checklistRef.get();
        
        if (!doc.exists) {
            toast('Checklist bulunamadÄ±', 'error');
            return;
        }
        
        const item = doc.data().items.find(i => i.id === itemId);
        if (!item) {
            toast('Madde bulunamadÄ±', 'error');
            return;
        }
        
        const isAylik = type === 'aylik';
        
        // Tarih checkboxlarÄ± (aylik iÃ§in)
        let dateOptions = '';
        if (isAylik) {
            for (let i = 1; i <= 31; i++) {
                const checked = item.dates && item.dates.includes(i) ? 'checked' : '';
                dateOptions += `<label style="display:inline-flex;align-items:center;gap:4px;padding:4px 8px;background:var(--bg3);border-radius:6px;cursor:pointer;font-size:.8rem">
                    <input type="checkbox" class="editItemDate" value="${i}" ${checked} style="accent-color:#008c95"> ${i}
                </label>`;
            }
        }
        
        const everyDay = isAylik && (!item.dates || item.dates.length === 0);
        
        showModal('Madde DÃ¼zenle', `
            <div class="form-group">
                <label class="form-label">Madde Metni</label>
                <textarea id="editChecklistItemText" class="form-input" rows="3">${item.text || ''}</textarea>
            </div>
            ${isAylik ? `
            <div class="form-group">
                <label class="form-label">Sorumlu</label>
                <select id="editChecklistItemResponsible" class="form-input">
                    <option value="">SeÃ§in...</option>
                    <option value="AÃ‡ILIÅžÃ‡I" data-color="#0ea5e9" ${item.responsible === 'AÃ‡ILIÅžÃ‡I' ? 'selected' : ''}>ðŸ”µ AÃ§Ä±lÄ±ÅŸÃ§Ä±</option>
                    <option value="HER SHIFT" data-color="#eab308" ${item.responsible === 'HER SHIFT' ? 'selected' : ''}>ðŸŸ¡ Her Shift</option>
                    <option value="ARACI" data-color="#dc2626" ${item.responsible === 'ARACI' ? 'selected' : ''}>ðŸ”´ AracÄ±</option>
                    <option value="KAPANIÅžÃ‡I" data-color="#f97316" ${item.responsible === 'KAPANIÅžÃ‡I' ? 'selected' : ''}>ðŸŸ  KapanÄ±ÅŸÃ§Ä±</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Tarihler</label>
                <div style="margin-bottom:8px">
                    <button type="button" class="btn btn-sm btn-ghost" onclick="editSelectAllDates()">TÃ¼mÃ¼nÃ¼ SeÃ§</button>
                    <button type="button" class="btn btn-sm btn-ghost" onclick="editSelectOddDates()">Tek GÃ¼nler</button>
                    <button type="button" class="btn btn-sm btn-ghost" onclick="editSelectEvenDates()">Ã‡ift GÃ¼nler</button>
                    <button type="button" class="btn btn-sm btn-ghost" onclick="editClearAllDates()">Temizle</button>
                </div>
                <div style="display:flex;flex-wrap:wrap;gap:6px;max-height:180px;overflow-y:auto;padding:8px;background:var(--bg2);border-radius:8px">
                    ${dateOptions}
                </div>
                <div style="margin-top:8px">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                        <input type="checkbox" id="editItemEveryDay" ${everyDay ? 'checked' : ''} onchange="editToggleEveryDay()" style="accent-color:#008c95">
                        <span style="font-weight:600">Her gÃ¼n (tarih seÃ§meden)</span>
                    </label>
                </div>
            </div>
            ` : ``}
            ${type === 'haftalik' ? `
            <div class="form-group">
                <label class="form-label">Hangi GÃ¼nlerde YapÄ±lsÄ±n?</label>
                <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px">
                    ${['Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi', 'Pazar'].map((day, i) => {
                        const checked = item.dayOfWeek && item.dayOfWeek.includes(i) ? 'checked' : '';
                        const colors = ['#3498db', '#9b59b6', '#e74c3c', '#f39c12', '#27ae60', '#1abc9c', '#e91e63'];
                        return `<label style="display:flex;align-items:center;gap:6px;padding:8px 14px;background:var(--bg3);border-radius:8px;cursor:pointer;transition:all .2s">
                            <input type="checkbox" class="editItemDayOfWeek" value="${i}" ${checked} style="accent-color:${colors[i]}">
                            <span style="font-weight:500">${day}</span>
                        </label>`;
                    }).join('')}
                </div>
                <div style="margin-top:12px;font-size:.8rem;color:var(--tx3)">
                    <strong>Ä°pucu:</strong> HiÃ§bir gÃ¼n seÃ§ilmezse her gÃ¼n yapÄ±labilir. Belirli gÃ¼nler seÃ§erseniz sadece o gÃ¼nlerde gÃ¶sterilir.
                </div>
            </div>
            ` : ''}
        `, `
            <button class="btn btn-ghost" onclick="closeModal()">Ä°ptal</button>
            <button class="btn btn-primary" onclick="editChecklistItem('${itemId}', '${branch}', '${type}')">Kaydet</button>
        `);
        
    } catch (error) {
        console.error('Madde yÃ¼kleme hatasÄ±:', error);
        toast('YÃ¼kleme hatasÄ±!', 'error');
    }
}

// Edit modal tarih yardÄ±mcÄ±larÄ±
function editSelectAllDates() {
    document.querySelectorAll('.editItemDate').forEach(cb => cb.checked = true);
    document.getElementById('editItemEveryDay').checked = false;
}
function editSelectOddDates() {
    document.querySelectorAll('.editItemDate').forEach(cb => {
        cb.checked = parseInt(cb.value) % 2 === 1;
    });
    document.getElementById('editItemEveryDay').checked = false;
}
function editSelectEvenDates() {
    document.querySelectorAll('.editItemDate').forEach(cb => {
        cb.checked = parseInt(cb.value) % 2 === 0;
    });
    document.getElementById('editItemEveryDay').checked = false;
}
function editClearAllDates() {
    document.querySelectorAll('.editItemDate').forEach(cb => cb.checked = false);
}
function editToggleEveryDay() {
    const everyDay = document.getElementById('editItemEveryDay').checked;
    if (everyDay) {
        document.querySelectorAll('.editItemDate').forEach(cb => cb.checked = false);
    }
}

// Checklist madde gÃ¼ncelle
async function editChecklistItem(itemId, branch, type) {
    const text = document.getElementById('editChecklistItemText')?.value?.trim();
    const isAylik = type === 'aylik';
    
    if (!text) {
        toast('Madde metni gerekli', 'error');
        return;
    }
    
    try {
        const checklistId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_${type}`;
        const checklistRef = db.collection('checklists').doc(checklistId);
        const doc = await checklistRef.get();
        
        if (!doc.exists) {
            toast('Checklist bulunamadÄ±', 'error');
            return;
        }
        
        const items = doc.data().items.map(item => {
            if (item.id === itemId) {
                const updated = { ...item, text };
                
                if (isAylik) {
                    const responsibleSelect = document.getElementById('editChecklistItemResponsible');
                    updated.responsible = responsibleSelect?.value || '';
                    const option = responsibleSelect?.options[responsibleSelect.selectedIndex];
                    updated.color = option?.dataset?.color || '#6b7280';
                    
                    const everyDay = document.getElementById('editItemEveryDay')?.checked;
                    if (everyDay) {
                        updated.dates = [];
                    } else {
                        updated.dates = [];
                        document.querySelectorAll('.editItemDate:checked').forEach(cb => {
                            updated.dates.push(parseInt(cb.value));
                        });
                    }
                } else if (type === 'haftalik') {
                    // HaftalÄ±k gÃ¶revler iÃ§in gÃ¼n seÃ§imi
                    updated.dayOfWeek = [];
                    document.querySelectorAll('.editItemDayOfWeek:checked').forEach(cb => {
                        updated.dayOfWeek.push(parseInt(cb.value));
                    });
                    updated.penalty = document.getElementById('editChecklistItemPenalty')?.value?.trim() || null;
                } else {
                    updated.penalty = document.getElementById('editChecklistItemPenalty')?.value?.trim() || null;
                }
                
                return updated;
            }
            return item;
        });
        
        await checklistRef.update({
            items,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        closeModal();
        toast('Madde gÃ¼ncellendi', 'success');
        loadChecklist();
        
    } catch (error) {
        console.error('Madde gÃ¼ncelleme hatasÄ±:', error);
        toast('GÃ¼ncelleme hatasÄ±!', 'error');
    }
}

// Checklist geÃ§miÅŸi gÃ¶ster
async function showChecklistHistory() {
    const branch = document.getElementById('checklistSube')?.value;
    const type = document.getElementById('checklistType')?.value;
    
    if (!branch) {
        toast('Ã–nce ÅŸube seÃ§in', 'error');
        return;
    }
    
    try {
        // INDEX OLMADAN - sadece branch ile sorgula
        const snapshot = await db.collection('checklistSubmissions')
            .where('branch', '==', branch)
            .get();
        
        // JavaScript'te filtrele ve sÄ±rala
        let submissions = [];
        snapshot.forEach(doc => {
            const data = doc.data();
            // Type filtresi
            if (type && data.type !== type) return;
            submissions.push({ id: doc.id, ...data });
        });
        
        // Tarihe gÃ¶re sÄ±rala (en yeni Ã¶nce)
        submissions.sort((a, b) => {
            const dateA = a.submittedAt?.toDate?.() || new Date(0);
            const dateB = b.submittedAt?.toDate?.() || new Date(0);
            return dateB - dateA;
        });
        
        // Ä°lk 50'yi al
        submissions = submissions.slice(0, 50);
        
        let html = '<div style="max-height:400px;overflow-y:auto">';
        
        if (submissions.length === 0) {
            html += '<p style="color:var(--tx2);text-align:center;padding:20px">HenÃ¼z checklist kaydÄ± yok</p>';
        } else {
            submissions.forEach(data => {
                const typeInfo = CHECKLIST_TYPES[branch]?.find(t => t.id === data.type);
                const date = data.submittedAt?.toDate ? new Date(data.submittedAt.toDate()) : new Date();
                
                // Tamamlanma oranÄ±
                let completionRate = 100;
                if (data.items) {
                    const done = data.items.filter(i => i.checked).length;
                    completionRate = Math.round((done / data.items.length) * 100);
                }
                
                html += `
                    <div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg2);border-radius:10px;margin-bottom:8px">
                        <div style="width:44px;height:44px;background:${completionRate === 100 ? 'rgba(39,174,96,.15)' : 'rgba(243,156,18,.15)'};border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.2rem">
                            ${typeInfo?.icon || 'ðŸ“‹'}
                        </div>
                        <div style="flex:1">
                            <div style="font-weight:600;color:var(--tx)">${typeInfo?.name || data.type}</div>
                            <div style="font-size:.8rem;color:var(--tx2)">${data.personName} â€¢ ${date.toLocaleDateString('tr-TR')} ${date.toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'})}</div>
                        </div>
                        <div style="text-align:right">
                            <div style="font-weight:600;color:${completionRate === 100 ? '#27ae60' : '#f39c12'}">${completionRate}%</div>
                            <div style="font-size:.75rem;color:var(--tx3)">${data.timeSlot || ''}</div>
                        </div>
                    </div>
                `;
            });
        }
        
        html += '</div>';
        
        showModal('ðŸ“Š Checklist GeÃ§miÅŸi', html, '<button class="btn btn-ghost" onclick="closeModal()">Kapat</button>');
        
    } catch (error) {
        console.error('GeÃ§miÅŸ yÃ¼kleme hatasÄ±:', error);
        toast('GeÃ§miÅŸ yÃ¼klenemedi', 'error');
    }
}

// Checklist ayarlarÄ±
function showChecklistSettings() {
    const branch = document.getElementById('checklistSube')?.value;
    if (!branch) {
        toast('Ã–nce ÅŸube seÃ§in', 'error');
        return;
    }
    
    const types = CHECKLIST_TYPES[branch] || [];
    
    let html = `
        <p style="color:var(--tx2);margin-bottom:16px">${branch} iÃ§in checklist ayarlarÄ±</p>
        <div style="display:flex;flex-direction:column;gap:12px">
    `;
    
    types.forEach(t => {
        html += `
            <div style="display:flex;align-items:center;justify-content:space-between;padding:12px;background:var(--bg3);border-radius:10px">
                <div style="display:flex;align-items:center;gap:10px">
                    <span style="font-size:1.2rem">${t.icon}</span>
                    <span style="font-weight:500">${t.name}</span>
                </div>
                <div style="font-size:.8rem;color:var(--tx2)">
                    ${t.timeSlots ? t.timeSlots.join(', ') : 'Tek seferlik'}
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    showModal('âš™ï¸ Checklist AyarlarÄ±', html, '<button class="btn btn-ghost" onclick="closeModal()">Kapat</button>');
}

// ==================== TEMÄ°ZLÄ°K Ã‡Ä°ZELGESÄ° YÃ–NETÄ°M SÄ°STEMÄ° ====================

// Temizlik maddelerini shiftteki personele dinamik daÄŸÄ±t
async function distributeTemizlikItems(branch, date) {
    const weekKey = getWeekKey(new Date(date));
    
    // Shift verilerini al
    const shiftSnap = await db.collection('shifts')
        .where('branch', '==', branch)
        .where('weekStart', '==', weekKey)
        .limit(1)
        .get();
    
    if (shiftSnap.empty) {
        console.warn('[Temizlik] Shift bulunamadÄ±:', branch, weekKey);
        return null;
    }
    
    const shiftData = shiftSnap.docs[0].data();
    const personelShifts = shiftData.personelShifts || {};
    const personelFullNames = shiftData.personelFullNames || {};
    
    // GÃ¼n indeksini hesapla (0=Pazartesi)
    let dayIndex = new Date(date).getDay() - 1;
    if (dayIndex < 0) dayIndex = 6;
    const dayKey = String(dayIndex);
    
    // BugÃ¼n Ã§alÄ±ÅŸan personeli kategorize et
    const personnel = {
        acilis: [],
        araci: [],
        kapanis: []
    };
    
    Object.entries(personelShifts).forEach(([personId, shifts]) => {
        const todayShift = shifts[dayKey];
        if (!todayShift || todayShift.toUpperCase() === 'OFF' || todayShift === '-') return;
        
        const personName = personelFullNames[personId] || personId;
        const shiftUpper = todayShift.toUpperCase();
        
        // BÃ–LGE MÃœDÃœRÃœ checklist doldurmaz (tek baÅŸÄ±na deÄŸilse)
        if (shiftUpper.includes('BÃ–LGE') || shiftUpper.includes('BOLGE')) {
            // BÃ¶lge mÃ¼dÃ¼rÃ¼ - sonra kontrol edilecek
            personnel._bolgeMuduru = personnel._bolgeMuduru || [];
            personnel._bolgeMuduru.push({ id: personId, name: personName, shift: todayShift });
            return;
        }
        
        if (shiftUpper.includes('AÃ‡ILIÅž') || shiftUpper.includes('ACILIS')) {
            personnel.acilis.push({ id: personId, name: personName, shift: todayShift });
        } else if (shiftUpper.includes('KAPANIÅž') || shiftUpper.includes('KAPANIS')) {
            personnel.kapanis.push({ id: personId, name: personName, shift: todayShift });
        } else if (shiftUpper.includes('ARA') || shiftUpper === 'ARA') {
            personnel.araci.push({ id: personId, name: personName, shift: todayShift });
        }
        // DiÄŸer shiftler (bilinmeyen) dahil edilmez
    });
    
    // BÃ¶lge mÃ¼dÃ¼rÃ¼ SADECE tek baÅŸÄ±naysa dahil et (hiÃ§ personel yoksa)
    const totalPersonnel = personnel.acilis.length + personnel.araci.length + personnel.kapanis.length;
    if (totalPersonnel === 0 && personnel._bolgeMuduru?.length > 0) {
        // HiÃ§ personel yok, bÃ¶lge mÃ¼dÃ¼rÃ¼ aracÄ± olarak Ã§alÄ±ÅŸsÄ±n
        personnel.araci = personnel._bolgeMuduru;
        console.log('[Temizlik] Sadece bÃ¶lge mÃ¼dÃ¼rÃ¼ var, aracÄ± olarak atandÄ±');
    }
    delete personnel._bolgeMuduru;
    
    // Temizlik maddelerini Firebase'den al
    let allItems = [];
    const docId = sanitize(branch) + '_aylik';
    try {
        const checklistDoc = await db.collection('checklists').doc(docId).get();
        if (checklistDoc.exists && checklistDoc.data().items?.length > 0) {
            allItems = checklistDoc.data().items;
            console.log('[Temizlik] Firebase\'den yÃ¼klendi:', docId, allItems.length, 'madde');
        } else {
            console.warn('[Temizlik] Firebase\'de madde bulunamadÄ±:', docId);
            allItems = getDefaultChecklistItems(branch, 'aylik'); // fallback
        }
    } catch (e) {
        console.error('[Temizlik] Firebase hatasÄ±:', e);
        allItems = getDefaultChecklistItems(branch, 'aylik'); // fallback
    }
    
    // responsible alanÄ±nÄ± shift'e Ã§evir (Firebase'deki format: AÃ‡ILIÅžÃ‡I, ARACI, KAPANIÅžÃ‡I, HER SHIFT)
    const responsibleToShift = {
        'AÃ‡ILIÅžÃ‡I': 'acilis',
        'ACILISCI': 'acilis',
        'ARACI': 'araci',
        'KAPANIÅžÃ‡I': 'kapanis',
        'KAPANISCI': 'kapanis',
        'HER SHIFT': 'hershift'
    };
    
    allItems = allItems.map(item => {
        if (!item.shift && item.responsible) {
            const shiftType = responsibleToShift[item.responsible.toUpperCase()] || 'hershift';
            return { ...item, shift: shiftType };
        }
        return item;
    });
    
    // "HER SHIFT" maddelerini tÃ¼m kategorilere ekle
    const herShiftItems = allItems.filter(i => i.shift === 'hershift');
    
    // Maddeleri shift kategorisine gÃ¶re grupla
    const itemsByShift = {
        acilis: [...allItems.filter(i => i.shift === 'acilis'), ...herShiftItems.map(i => ({...i, shift: 'acilis'}))],
        araci: [...allItems.filter(i => i.shift === 'araci'), ...herShiftItems.map(i => ({...i, shift: 'araci'}))],
        kapanis: [...allItems.filter(i => i.shift === 'kapanis'), ...herShiftItems.map(i => ({...i, shift: 'kapanis'}))]
    };
    
    // AracÄ± yoksa maddelerini aÃ§Ä±lÄ±ÅŸ ve kapanÄ±ÅŸa daÄŸÄ±t
    if (personnel.araci.length === 0 && itemsByShift.araci.length > 0) {
        const araciItems = itemsByShift.araci;
        const half = Math.ceil(araciItems.length / 2);
        
        // YarÄ±sÄ±nÄ± aÃ§Ä±lÄ±ÅŸa, yarÄ±sÄ±nÄ± kapanÄ±ÅŸa
        araciItems.slice(0, half).forEach(item => {
            item.shift = 'acilis';
            itemsByShift.acilis.push(item);
        });
        araciItems.slice(half).forEach(item => {
            item.shift = 'kapanis';
            itemsByShift.kapanis.push(item);
        });
        itemsByShift.araci = [];
        console.log('[Temizlik] AracÄ± yok, maddeler daÄŸÄ±tÄ±ldÄ±:', half, 'aÃ§Ä±lÄ±ÅŸa,', araciItems.length - half, 'kapanÄ±ÅŸa');
    }
    
    // Her kategorideki maddeleri personele eÅŸit daÄŸÄ±t
    const assignments = {}; // { personId: [item1, item2, ...] }
    
    ['acilis', 'araci', 'kapanis'].forEach(shiftType => {
        const items = itemsByShift[shiftType];
        const people = personnel[shiftType];
        
        if (items.length === 0 || people.length === 0) return;
        
        // Maddeleri eÅŸit daÄŸÄ±t
        items.forEach((item, idx) => {
            const personIdx = idx % people.length;
            const person = people[personIdx];
            
            if (!assignments[person.id]) {
                assignments[person.id] = {
                    name: person.name,
                    shift: shiftType,
                    items: []
                };
            }
            assignments[person.id].items.push({
                ...item,
                assignedTo: person.id,
                assignedName: person.name
            });
        });
    });
    
    return {
        branch,
        date,
        weekKey,
        personnel,
        itemsByShift,
        assignments,
        totalItems: allItems.length
    };
}

// Temizlik maddesi iÃ§in 48 saat cooldown kontrolÃ¼
async function checkTemizlikCooldown(branch, itemId, currentDate) {
    const cooldownHours = 48;
    const cooldownMs = cooldownHours * 60 * 60 * 1000;
    
    try {
        // Son tamamlanma zamanÄ±nÄ± bul
        const snap = await db.collection('temizlikCompletions')
            .where('branch', '==', branch)
            .where('itemId', '==', itemId)
            .orderBy('completedAt', 'desc')
            .limit(1)
            .get();
        
        if (snap.empty) {
            return { canComplete: true, lastCompleted: null, nextAvailable: null };
        }
        
        const lastDoc = snap.docs[0].data();
        const lastCompletedAt = lastDoc.completedAt?.toDate() || new Date(lastDoc.completedAt);
        const now = new Date();
        const elapsed = now - lastCompletedAt;
        
        if (elapsed >= cooldownMs) {
            return { 
                canComplete: true, 
                lastCompleted: lastCompletedAt,
                lastCompletedBy: lastDoc.completedByName,
                nextAvailable: null 
            };
        }
        
        const nextAvailable = new Date(lastCompletedAt.getTime() + cooldownMs);
        const remainingHours = Math.ceil((cooldownMs - elapsed) / (60 * 60 * 1000));
        
        return { 
            canComplete: false, 
            lastCompleted: lastCompletedAt,
            lastCompletedBy: lastDoc.completedByName,
            nextAvailable,
            remainingHours
        };
    } catch (e) {
        // Index yoksa veya baÅŸka hata - basit sorgu dene
        try {
            const snap = await db.collection('temizlikCompletions')
                .where('branch', '==', branch)
                .where('itemId', '==', itemId)
                .get();
            
            if (snap.empty) {
                return { canComplete: true, lastCompleted: null, nextAvailable: null };
            }
            
            // En son tarihi manuel bul
            let latest = null;
            let latestDoc = null;
            snap.forEach(doc => {
                const d = doc.data();
                const completedAt = d.completedAt?.toDate() || new Date(d.completedAt || d.date);
                if (!latest || completedAt > latest) {
                    latest = completedAt;
                    latestDoc = d;
                }
            });
            
            if (!latest) {
                return { canComplete: true, lastCompleted: null, nextAvailable: null };
            }
            
            const now = new Date();
            const elapsed = now - latest;
            
            if (elapsed >= cooldownMs) {
                return { 
                    canComplete: true, 
                    lastCompleted: latest,
                    lastCompletedBy: latestDoc?.completedByName,
                    nextAvailable: null 
                };
            }
            
            const nextAvailable = new Date(latest.getTime() + cooldownMs);
            const remainingHours = Math.ceil((cooldownMs - elapsed) / (60 * 60 * 1000));
            
            return { 
                canComplete: false, 
                lastCompleted: latest,
                lastCompletedBy: latestDoc?.completedByName,
                nextAvailable,
                remainingHours
            };
        } catch (e2) {
            console.warn('[Temizlik] Cooldown kontrolÃ¼ hatasÄ±:', e2);
            return { canComplete: true, lastCompleted: null, nextAvailable: null };
        }
    }
}

// Temizlik Ã§izelgesi render fonksiyonu
async function renderTemizlikChecklist(container, branch, date) {
    container.innerHTML = `<div style="text-align:center;padding:40px;color:var(--tx2)">
        <div class="loading-spinner" style="margin:0 auto 16px"></div>
        Temizlik Ã§izelgesi yÃ¼kleniyor...
    </div>`;
    
    try {
        // Shift verilerini Ã§ek
        const distribution = await distributeTemizlikItems(branch, date);
        
        if (!distribution) {
            container.innerHTML = `
                <div style="text-align:center;padding:60px 20px">
                    <div style="width:80px;height:80px;margin:0 auto 20px;background:linear-gradient(135deg,#fee2e2,#fecaca);border-radius:50%;display:flex;align-items:center;justify-content:center">
                        <svg width="40" height="40" fill="none" stroke="#ef4444" stroke-width="2" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 8v4M12 16h.01"/>
                        </svg>
                    </div>
                    <div style="font-size:1.2rem;font-weight:600;color:var(--tx);margin-bottom:8px">Shift Verisi BulunamadÄ±</div>
                    <div style="color:var(--tx2)">Bu hafta iÃ§in shift kaydÄ± yok.</div>
                </div>
            `;
            return;
        }
        
        // Mevcut kullanÄ±cÄ±nÄ±n ID'sini bul
        const currentUserId = currentUser?.uniqueId || normalizePersonelId(currentUser?.name || '');
        const isManager = ['yonetici', 'bolge_muduru', 'magaza_muduru', 'mudur', 'admin'].includes(currentUser?.role);
        
        // Vardiya renkleri
        const shiftColors = {
            acilis: { bg: 'rgba(39,174,96,.1)', border: '#27ae60', icon: 'ðŸŒ…', label: 'AÃ§Ä±lÄ±ÅŸ' },
            araci: { bg: 'rgba(243,156,18,.1)', border: '#f39c12', icon: 'â˜€ï¸', label: 'Ara Vardiya' },
            kapanis: { bg: 'rgba(155,89,182,.1)', border: '#9b59b6', icon: 'ðŸŒ™', label: 'KapanÄ±ÅŸ' }
        };
        
        // Checklist ismini dinamik al
        const checklistName = getChecklistTypeName(branch, 'aylik', 'Temizlik Ã‡izelgesi');
        
        let html = `
            <div style="margin-bottom:20px">
                <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">
                    <div>
                        <h3 style="color:var(--tx);font-size:1.1rem;font-weight:600;margin:0">ðŸ§¹ ${checklistName}</h3>
                        <div style="font-size:.85rem;color:var(--tx2);margin-top:4px">${branch} - ${date}</div>
                    </div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
                        ${isManager ? `
                            <button class="btn btn-sm btn-ghost" onclick="toggleChecklistEditMode('${branch}', 'aylik', '${date}', null)" style="display:flex;align-items:center;gap:4px">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                Maddeleri DÃ¼zenle
                            </button>
                        ` : ''}
                        ${Object.entries(shiftColors).map(([key, val]) => {
                            const count = distribution.personnel[key]?.length || 0;
                            return `<span style="font-size:.75rem;padding:4px 10px;border-radius:12px;background:${val.bg};color:${val.border};border:1px solid ${val.border}">${val.icon} ${val.label}: ${count} kiÅŸi</span>`;
                        }).join('')}
                    </div>
                </div>
            </div>
            
            <div style="background:rgba(0,140,149,.05);border:1px solid rgba(0,140,149,.2);border-radius:12px;padding:14px;margin-bottom:20px">
                <div style="font-size:.85rem;color:var(--primary)">
                    ðŸ’¡ Her madde <strong>48 saat</strong> cooldown sÃ¼resine sahiptir. YapÄ±lan madde 48 saat sonra tekrar aktif olur.
                    ${isManager ? '<br>ðŸ‘¤ YÃ¶netici olarak tÃ¼m personelin maddelerini gÃ¶rebilir ve iÅŸaretleyebilirsiniz.' : ''}
                </div>
            </div>
        `;
        
        // Her vardiya tipi iÃ§in bÃ¶lÃ¼m oluÅŸtur
        for (const [shiftType, shiftConfig] of Object.entries(shiftColors)) {
            const people = distribution.personnel[shiftType] || [];
            const items = distribution.itemsByShift[shiftType] || [];
            
            if (items.length === 0) continue;
            
            html += `
                <div style="margin-bottom:24px">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid ${shiftConfig.border}">
                        <span style="font-size:1.3rem">${shiftConfig.icon}</span>
                        <div style="font-weight:600;color:var(--tx)">${shiftConfig.label} Maddeleri</div>
                        <span style="font-size:.8rem;color:var(--tx3)">(${items.length} madde)</span>
                    </div>
            `;
            
            if (people.length === 0) {
                html += `
                    <div style="padding:20px;background:var(--bg3);border-radius:10px;text-align:center;color:var(--tx2)">
                        âš ï¸ Bu vardiyada personel yok. Maddeler diÄŸer vardiyalara daÄŸÄ±tÄ±ldÄ±.
                    </div>
                `;
            } else {
                // Maddeleri personele daÄŸÄ±t ve gÃ¶ster
                const itemsPerPerson = Math.ceil(items.length / people.length);
                
                for (let pIdx = 0; pIdx < people.length; pIdx++) {
                    const person = people[pIdx];
                    const personItems = items.slice(pIdx * itemsPerPerson, (pIdx + 1) * itemsPerPerson);
                    
                    if (personItems.length === 0) continue;
                    
                    const canEdit = isManager || 
                                   person.id === currentUserId || 
                                   normalizePersonelId(person.name) === currentUserId ||
                                   normalizePersonelId(person.name) === normalizePersonelId(currentUser?.name || '');
                    
                    // GÃ¼venli escape iÃ§in (person bilgileri)
                    const safePersonName = person.name.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                    const safePersonId = person.id.replace(/'/g, "\\'");
                    
                    html += `
                        <div style="background:${shiftConfig.bg};border:1px solid ${shiftConfig.border}33;border-radius:12px;padding:16px;margin-bottom:12px">
                            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
                                <div style="display:flex;align-items:center;gap:10px">
                                    <div style="width:40px;height:40px;border-radius:50%;background:${shiftConfig.border};color:#fff;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:.9rem">
                                        ${person.name.split(' ').map(n => n[0]).join('').substring(0,2).toUpperCase()}
                                    </div>
                                    <div>
                                        <div style="font-weight:600;color:var(--tx)">${person.name}</div>
                                        <div style="font-size:.75rem;color:var(--tx3)">${person.shift} - ${personItems.length} madde</div>
                                    </div>
                                </div>
                                ${canEdit ? `<span style="font-size:.7rem;padding:4px 8px;background:#27ae60;color:#fff;border-radius:6px">âœï¸ DÃ¼zenleyebilirsin</span>` : ''}
                            </div>
                            
                            <div style="display:grid;gap:8px">
                    `;
                    
                    for (const item of personItems) {
                        const cooldown = await checkTemizlikCooldown(branch, item.id, new Date());
                        const isCompleted = !cooldown.canComplete;
                        const points = item.points?.done || 1;
                        const safeItemText = (item.text || '').replace(/'/g, "\\'").replace(/"/g, "&quot;");
                        
                        html += `
                            <div class="temizlik-item ${isCompleted ? 'completed' : ''}" 
                                 style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg2);border-radius:8px;border:1px solid ${isCompleted ? '#27ae60' : 'var(--bg4)'};${isCompleted ? 'opacity:.7' : ''}">
                                
                                <div style="flex:1">
                                    <div style="font-size:.9rem;color:var(--tx);${isCompleted ? 'text-decoration:line-through' : ''}">${item.text}</div>
                                    <div style="font-size:.7rem;color:var(--tx3);margin-top:2px">
                                        ${item.category} â€¢ <span style="color:${points > 0 ? '#27ae60' : '#e74c3c'}">${points > 0 ? '+' : ''}${points} puan</span>
                                        ${isCompleted && cooldown.lastCompletedBy ? ` â€¢ âœ… ${cooldown.lastCompletedBy}` : ''}
                                        ${isCompleted && cooldown.remainingHours ? ` â€¢ â° ${cooldown.remainingHours}s sonra aktif` : ''}
                                    </div>
                                </div>
                                
                                ${canEdit ? `
                                    <button class="btn btn-sm ${isCompleted ? 'btn-ghost' : 'btn-primary'}" 
                                            onclick="handleTemizlikItemClick('${branch}', '${item.id}', '${safeItemText}', '${safePersonId}', '${safePersonName}')"
                                            ${isCompleted ? 'disabled' : ''}
                                            style="min-width:80px;font-size:.75rem">
                                        ${isCompleted ? 'âœ… YapÄ±ldÄ±' : 'â˜ Tamamla'}
                                    </button>
                                ` : `
                                    <div style="min-width:80px;text-align:center;font-size:.75rem;color:var(--tx3)">
                                        ${isCompleted ? 'âœ… YapÄ±ldÄ±' : 'â³ Bekliyor'}
                                    </div>
                                `}
                            </div>
                        `;
                    }
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
            }
            
            html += `</div>`;
        }
        
        container.innerHTML = html;
        
    } catch (e) {
        console.error('[Temizlik] Render hatasÄ±:', e);
        container.innerHTML = `
            <div style="text-align:center;padding:60px 20px;color:#e74c3c">
                <div style="font-size:1.1rem;margin-bottom:8px">Hata oluÅŸtu</div>
                <div style="font-size:.85rem">${e.message}</div>
            </div>
        `;
    }
}

// Temizlik maddesi tÄ±klama handler
async function handleTemizlikItemClick(branch, itemId, itemText, personId, personName) {
    // Onay iste
    const confirmed = confirm(`"${itemText}" maddesini tamamlamak istiyor musunuz?\n\nSorumlu: ${personName}`);
    if (!confirmed) return;
    
    // Tamamla
    const success = await completeTemizlikItem(branch, itemId, itemText, personId, personName);
    
    if (success) {
        // SayfayÄ± yenile
        loadChecklist();
    }
}

// Temizlik maddesini tamamla
async function completeTemizlikItem(branch, itemId, itemText, personId, personName) {
    const now = new Date();
    const docId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_${itemId}_${formatDateLocal(now)}_${Date.now()}`;
    
    try {
        // Cooldown kontrolÃ¼
        const cooldown = await checkTemizlikCooldown(branch, itemId, now);
        if (!cooldown.canComplete) {
            toast(`Bu madde ${cooldown.remainingHours} saat sonra tekrar yapÄ±labilir`, 'warning');
            return false;
        }
        
        // Tamamlama kaydÄ±
        await db.collection('temizlikCompletions').doc(docId).set({
            branch,
            itemId,
            itemText,
            completedBy: personId,
            completedByName: personName,
            completedAt: firebase.firestore.FieldValue.serverTimestamp(),
            date: formatDateLocal(now)
        });
        
        // Puan ekle
        const items = getDefaultChecklistItems(branch, 'aylik');
        const item = items.find(i => i.id === itemId);
        const points = item?.points?.done || 1;
        
        const noteId = `temizlik_${normalizePersonelId(personName)}_${formatDateLocal(now)}_${itemId}`;
        await db.collection('puantajNotes').doc(noteId).set({
            personelId: normalizePersonelId(personName),
            personelName: personName,
            branch,
            date: formatDateLocal(now),
            checkType: 'temizlik',
            itemId,
            status: 'done',
            points,
            note: `Temizlik: ${itemText}`,
            autoGenerated: true,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log(`[Temizlik] âœ… ${personName}: ${itemText} (+${points} puan)`);
        toast(`âœ… ${itemText} tamamlandÄ± (+${points} puan)`, 'success');
        return true;
    } catch (e) {
        console.error('[Temizlik] Tamamlama hatasÄ±:', e);
        toast('Hata oluÅŸtu: ' + e.message, 'error');
        return false;
    }
}

// Default checklist maddeleri - TÃœM MADDELER FIREBASE'DEN GELÄ°YOR
// Bu fonksiyon sadece fallback olarak boÅŸ array dÃ¶ndÃ¼rÃ¼r
// Maddeler seed.html ile Firebase'e yÃ¼klenir
function getDefaultChecklistItems(branch, type) {
    console.warn(`[Checklist] Firebase'de madde bulunamadÄ±: ${branch}/${type} - seed.html ile yÃ¼kleyin`);
    return [];
}

// ============================================
// HAFTALIK GÃ–REVLER - ROUND-ROBIN ATAMA SÄ°STEMÄ°
// ============================================

// Hafta baÅŸlangÄ±Ã§ tarihini hesapla
function getWeekStartDate(date = new Date()) {
    const rules = CHECK_RULES.haftalik || {};
    const weekStartDay = rules.weekStartDay ?? 1; // 0=Pazar, 1=Pazartesi (varsayÄ±lan)
    const weekStartHour = rules.weekStartHour || '03:00';
    const [startH, startM] = weekStartHour.split(':').map(Number);
    
    const d = new Date(date);
    const currentDay = d.getDay();
    const currentHour = d.getHours();
    const currentMinute = d.getMinutes();
    
    // KaÃ§ gÃ¼n geriye gitmemiz gerekiyor?
    let daysBack = (currentDay - weekStartDay + 7) % 7;
    
    // EÄŸer bugÃ¼n baÅŸlangÄ±Ã§ gÃ¼nÃ¼ ama henÃ¼z baÅŸlangÄ±Ã§ saatine gelmediyse, geÃ§en haftaya git
    if (daysBack === 0 && (currentHour < startH || (currentHour === startH && currentMinute < startM))) {
        daysBack = 7;
    }
    
    d.setDate(d.getDate() - daysBack);
    d.setHours(startH, startM, 0, 0);
    
    return d;
}

// Hafta ID'si oluÅŸtur (YYYY-WW formatÄ±nda)
function getWeekId(date = new Date()) {
    const weekStart = getWeekStartDate(date);
    return weekStart.toISOString().split('T')[0]; // YYYY-MM-DD
}

// ==================== ROL VE SORUMLULUK SÄ°STEMÄ° ====================

/**
 * Verilen zaman diliminde personelin TEK BAÅžINA olup olmadÄ±ÄŸÄ±nÄ± tespit eder
 * @param {Object} shiftData - Shift verisi (personelShifts, dayIndex iÃ§ermeli)
 * @param {string} personId - Kontrol edilecek personel ID
 * @param {string} timeSlot - Zaman dilimi: 'acilis', 'kapanis', 'araci', 'all'
 * @param {Object} personnelRoles - Personel rolleri map'i {personId: role}
 * @returns {boolean} Tek baÅŸÄ±na ise true
 */
function isPersonAloneInShift(shiftData, personId, timeSlot, personnelRoles = {}) {
    if (!shiftData || !shiftData.personelShifts) return false;
    
    const dayIndex = shiftData.dayIndex ?? ((new Date().getDay() + 6) % 7);
    const personelShifts = shiftData.personelShifts;
    
    // Bu zaman diliminde Ã§alÄ±ÅŸan personeli bul
    const workingPersonnel = [];
    
    Object.entries(personelShifts).forEach(([pId, shifts]) => {
        const todayShift = shifts[dayIndex] || '';
        if (!todayShift || todayShift === '-') return;
        
        const shiftUpper = todayShift.replace(/\*/g, '').trim().toUpperCase();
        
        // OFF kontrolÃ¼
        if (shiftUpper === 'OFF' || shiftUpper === 'Ä°' || shiftUpper === 'Y.Ä°' || shiftUpper === 'X') return;
        
        // BÃ¶lge mÃ¼dÃ¼rÃ¼ kontrolÃ¼ - saat yoksa dahil etme
        const role = personnelRoles[pId];
        if (role === 'bolge_muduru') {
            // Sadece "BÃ–LGE MÃœDÃœRÃœ" yazÄ±yorsa (saat yok) - dahil etme
            if (shiftUpper.includes('BÃ–LGE') || shiftUpper.includes('BOLGE')) {
                if (!/\d{1,2}:\d{2}/.test(todayShift)) return; // Saat yoksa atla
            }
        }
        
        // Zaman dilimine gÃ¶re filtrele
        if (timeSlot === 'all') {
            workingPersonnel.push(pId);
        } else if (timeSlot === 'acilis' && (shiftUpper.includes('AÃ‡ILIÅž') || shiftUpper.includes('ACILIS'))) {
            workingPersonnel.push(pId);
        } else if (timeSlot === 'kapanis' && (shiftUpper.includes('KAPANIÅž') || shiftUpper.includes('KAPANIS'))) {
            workingPersonnel.push(pId);
        } else if (timeSlot === 'araci') {
            // AracÄ± = ne aÃ§Ä±lÄ±ÅŸ ne kapanÄ±ÅŸ (ara saatler veya saat formatÄ±)
            if (!shiftUpper.includes('AÃ‡ILIÅž') && !shiftUpper.includes('ACILIS') && 
                !shiftUpper.includes('KAPANIÅž') && !shiftUpper.includes('KAPANIS') &&
                !shiftUpper.includes('BÃ–LGE') && !shiftUpper.includes('BOLGE')) {
                if (/\d{1,2}:\d{2}/.test(todayShift) || shiftUpper === 'ARA' || shiftUpper.includes('ARA')) {
                    workingPersonnel.push(pId);
                }
            }
        }
    });
    
    // Tek baÅŸÄ±na kontrolÃ¼
    return workingPersonnel.length === 1 && workingPersonnel[0] === personId;
}

/**
 * O gÃ¼n shiftte hiÃ§ baÅŸka personel var mÄ± kontrol eder (tÃ¼m zaman dilimleri)
 * @param {Object} shiftData - Shift verisi
 * @param {string} excludePersonId - HariÃ§ tutulacak personel (kendisi)
 * @param {Object} personnelRoles - Personel rolleri map'i
 * @returns {boolean} BaÅŸka personel yoksa true (tek baÅŸÄ±na)
 */
function isPersonAloneAllDay(shiftData, excludePersonId, personnelRoles = {}) {
    if (!shiftData || !shiftData.personelShifts) return true;
    
    const dayIndex = shiftData.dayIndex ?? ((new Date().getDay() + 6) % 7);
    const personelShifts = shiftData.personelShifts;
    
    let otherWorkingCount = 0;
    
    Object.entries(personelShifts).forEach(([pId, shifts]) => {
        if (pId === excludePersonId) return; // Kendisini say ma
        
        const todayShift = shifts[dayIndex] || '';
        if (!todayShift || todayShift === '-') return;
        
        const shiftUpper = todayShift.replace(/\*/g, '').trim().toUpperCase();
        
        // OFF kontrolÃ¼
        if (shiftUpper === 'OFF' || shiftUpper === 'Ä°' || shiftUpper === 'Y.Ä°' || shiftUpper === 'X' || /^\*+$/.test(shiftUpper)) return;
        
        // BÃ¶lge mÃ¼dÃ¼rÃ¼ - saat yoksa sayma
        const role = personnelRoles[pId];
        if (role === 'bolge_muduru') {
            if ((shiftUpper.includes('BÃ–LGE') || shiftUpper.includes('BOLGE')) && !/\d{1,2}:\d{2}/.test(todayShift)) {
                return;
            }
        }
        
        otherWorkingCount++;
    });
    
    return otherWorkingCount === 0;
}

/**
 * Puan gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ kontrolÃ¼
 * @param {string} viewerRole - PuanÄ± gÃ¶rmeye Ã§alÄ±ÅŸan kiÅŸinin rolÃ¼
 * @param {string} targetRole - PuanÄ± gÃ¶rÃ¼lecek kiÅŸinin rolÃ¼
 * @param {string} viewerId - GÃ¶rmeye Ã§alÄ±ÅŸan kiÅŸinin ID'si
 * @param {string} targetId - PuanÄ± gÃ¶rÃ¼lecek kiÅŸinin ID'si
 * @param {string} pointType - 'positive' veya 'negative'
 * @returns {boolean} GÃ¶rÃ¼lebilir ise true
 */
function canViewPoints(viewerRole, targetRole, viewerId, targetId, pointType = 'all') {
    // Herkes kendi puanÄ±nÄ± gÃ¶rebilir
    if (viewerId === targetId) return true;
    
    // Rol hiyerarÅŸisi: yonetici > bolge_muduru > magaza_muduru > mudur_yardimcisi > barista
    const roleHierarchy = {
        'yonetici': 5,
        'bolge_muduru': 4,
        'magaza_muduru': 3,
        'mudur_yardimcisi': 2,
        'barista': 1
    };
    
    const viewerLevel = roleHierarchy[viewerRole] || 0;
    const targetLevel = roleHierarchy[targetRole] || 0;
    
    // BÃ¶lge mÃ¼dÃ¼rÃ¼ puanÄ± sadece yÃ¶netici gÃ¶rebilir
    if (targetRole === 'bolge_muduru') {
        return viewerRole === 'yonetici';
    }
    
    // MaÄŸaza mÃ¼dÃ¼rÃ¼ eksi puanÄ± sadece Ã¼stleri gÃ¶rebilir (bolge_muduru, yonetici)
    if (targetRole === 'magaza_muduru' && pointType === 'negative') {
        return viewerLevel >= roleHierarchy['bolge_muduru'];
    }
    
    // DiÄŸer durumlarda Ã¼stler astlarÄ±n puanÄ±nÄ± gÃ¶rebilir
    return viewerLevel > targetLevel;
}

/**
 * BÃ¶lge mÃ¼dÃ¼rÃ¼ eksi puan alabilir mi?
 * @param {string} role - KiÅŸinin rolÃ¼
 * @returns {boolean} Eksi puan alabilirse true
 */
function canReceiveNegativePoints(role) {
    // BÃ¶lge mÃ¼dÃ¼rÃ¼ eksi puan ALAMAZ
    if (role === 'bolge_muduru') return false;
    return true;
}

/**
 * MÃ¼dÃ¼r yardÄ±mcÄ±sÄ±nÄ±n sorumluluÄŸunu belirle
 * @param {Object} shiftData - Shift verisi
 * @param {Object} mudur - MÃ¼dÃ¼r bilgisi {uniqueId, ...}
 * @param {Object} yardimci - YardÄ±mcÄ± bilgisi {uniqueId, ...}
 * @param {Object} personnelRoles - Personel rolleri
 * @returns {string} 'barista_like' | 'mudur_like' | 'all_responsible'
 */
function getMudurYardimcisiResponsibility(shiftData, mudur, yardimci, personnelRoles = {}) {
    if (!shiftData || !yardimci) return 'barista_like';
    
    const dayIndex = shiftData.dayIndex ?? ((new Date().getDay() + 6) % 7);
    const personelShifts = shiftData.personelShifts || {};
    
    // YardÄ±mcÄ± shiftte mi?
    const yardimciId = yardimci.uniqueId || yardimci.id;
    const yardimciShift = personelShifts[yardimciId]?.[dayIndex] || '';
    const yardimciShiftClean = yardimciShift.replace(/\*/g, '').trim().toUpperCase();
    
    if (!yardimciShift || yardimciShiftClean === 'OFF' || yardimciShiftClean === 'Ä°') {
        return 'not_working'; // YardÄ±mcÄ± Ã§alÄ±ÅŸmÄ±yor
    }
    
    // YardÄ±mcÄ± tek baÅŸÄ±na mÄ±?
    if (isPersonAloneAllDay(shiftData, yardimciId, personnelRoles)) {
        return 'all_responsible'; // TÃœM checklistlerden sorumlu
    }
    
    // MÃ¼dÃ¼r shiftte mi?
    if (!mudur) return 'mudur_like'; // MÃ¼dÃ¼r yok, yardÄ±mcÄ± mÃ¼dÃ¼r gibi
    
    const mudurId = mudur.uniqueId || mudur.id;
    const mudurShift = personelShifts[mudurId]?.[dayIndex] || '';
    const mudurShiftClean = mudurShift.replace(/\*/g, '').trim().toUpperCase();
    
    if (!mudurShift || mudurShiftClean === 'OFF' || mudurShiftClean === 'Ä°') {
        return 'mudur_like'; // MÃ¼dÃ¼r izinli, yardÄ±mcÄ± mÃ¼dÃ¼r gibi
    }
    
    // MÃ¼dÃ¼r de yardÄ±mcÄ± da Ã§alÄ±ÅŸÄ±yor - yardÄ±mcÄ± barista gibi
    return 'barista_like';
}

/**
 * MaÄŸaza mÃ¼dÃ¼rÃ¼nÃ¼n sorumluluÄŸunu belirle
 * @param {Object} shiftData - Shift verisi
 * @param {Object} mudur - MÃ¼dÃ¼r bilgisi {uniqueId, ...}
 * @param {Object} personnelRoles - Personel rolleri
 * @returns {string} 'mudur_only' | 'all_responsible'
 */
function getMudurResponsibility(shiftData, mudur, personnelRoles = {}) {
    if (!shiftData || !mudur) return 'mudur_only';
    
    const mudurId = mudur.uniqueId || mudur.id;
    
    // MÃ¼dÃ¼r tek baÅŸÄ±na mÄ±?
    if (isPersonAloneAllDay(shiftData, mudurId, personnelRoles)) {
        return 'all_responsible'; // TÃœM checklistlerden sorumlu
    }
    
    return 'mudur_only'; // Sadece mÃ¼dÃ¼r checklistinden sorumlu
}

// ==================== HAFTALIK GÃ–REV SÄ°STEMÄ° ====================

// Atama havuzundaki personeli al (yÃ¶neticiler ve mÃ¼dÃ¼rler hariÃ§)
async function getAssignmentPool(branch) {
    const pool = [];
    
    try {
        // Bu haftanÄ±n shift verisinden personel havuzunu al
        const weekStart = getWeekStart(new Date());
        const weekKey = formatDateLocal(weekStart);
        
        // Shift'te olan personel ID'lerini topla
        const personnelInShift = new Set();
        
        try {
            // shifts koleksiyonundan bu haftanÄ±n verisini Ã§ek
            const shiftSnap = await db.collection('shifts')
                .where('branch', '==', branch)
                .where('weekStart', '==', weekKey)
                .limit(1)
                .get();
            
            if (!shiftSnap.empty) {
                const shiftData = shiftSnap.docs[0].data();
                const personelShifts = shiftData.personelShifts || {};
                
                // Her personel iÃ§in en az bir Ã§alÄ±ÅŸma gÃ¼nÃ¼ var mÄ± kontrol et
                Object.entries(personelShifts).forEach(([personId, days]) => {
                    if (days && typeof days === 'object') {
                        // En az bir gÃ¼n Ã§alÄ±ÅŸÄ±yor mu? (OFF, ****, boÅŸ deÄŸil)
                        const hasWorkDay = Object.values(days).some(shift => {
                            if (!shift || shift === '') return false;
                            const normalizedShift = shift.replace(/^\*+/, '').trim().toUpperCase();
                            if (normalizedShift === 'OFF' || normalizedShift === '****' || normalizedShift === '') return false;
                            return true;
                        });
                        
                        if (hasWorkDay) {
                            personnelInShift.add(personId.toLowerCase());
                        }
                    }
                });
                
                console.log('[HaftalÄ±k] Bu hafta shiftte olan personel:', [...personnelInShift]);
            } else {
                console.log('[HaftalÄ±k] Bu haftanÄ±n shift verisi bulunamadÄ±:', weekKey);
            }
        } catch (e) {
            console.warn('[HaftalÄ±k] Shift verisi okunamadÄ±:', e.message);
        }
        
        // TÃ¼m personeli al
        const snap = await db.collection('personel')
            .where('branch', '==', branch)
            .get();
        
        snap.forEach(doc => {
            const d = doc.data();
            const uniqueId = (d.uniqueId || doc.id || '').toLowerCase();
            
            // Bu hafta shiftte yoksa atla (shift verisi varsa)
            if (personnelInShift.size > 0) {
                // Sadece uniqueId ile tam eÅŸleÅŸme
                if (!personnelInShift.has(uniqueId)) {
                    console.log('[HaftalÄ±k] Shiftte yok, atlanÄ±yor:', d.displayName || d.name, '(uniqueId:', uniqueId, ')');
                    return;
                }
            }
            
            // Aktif olmayan personeli atla
            if (d.aktif === false || d.active === false || d.isActive === false) return;
            
            // YÃ¶neticileri hariÃ§ tut (bÃ¶lge mÃ¼dÃ¼rÃ¼, genel yÃ¶netici)
            if (['yonetici', 'bolge_muduru'].includes(d.role)) return;
            
            // MaÄŸaza mÃ¼dÃ¼rÃ¼nÃ¼ hariÃ§ tut
            if (d.role === 'magaza_muduru') return;
            
            // NOT: MÃ¼dÃ¼r yardÄ±mcÄ±sÄ± normal personel gibi havuza dahil edilir
            
            pool.push({
                id: doc.id,
                uniqueId: d.uniqueId || doc.id,
                name: d.name,
                displayName: d.displayName,
                codeName: d.codeName || d.displayName || d.name,
                role: d.role,
                position: d.position
            });
        });
        
        // Ä°sme gÃ¶re sÄ±rala (tutarlÄ± sÄ±ralama iÃ§in)
        pool.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'tr'));
        
        console.log('[HaftalÄ±k] Final havuz:', pool.map(p => p.displayName || p.name));
        
    } catch (e) {
        console.error('[HaftalÄ±k] Personel havuzu alÄ±namadÄ±:', e);
    }
    
    return pool;
}

// HaftalÄ±k atama oluÅŸtur veya mevcut atamayÄ± al (migration + shift sync)
async function getOrCreateWeeklyAssignments(branch) {
    const weekId = getWeekId();
    const docId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_${weekId}`;
    
    try {
        // Mevcut atamayÄ± kontrol et
        const doc = await db.collection('weeklyAssignments').doc(docId).get();
        
        if (doc.exists) {
            console.log('[HaftalÄ±k] Mevcut atama bulundu:', docId);
            let existingData = doc.data();
            
            // Personel koleksiyonundan docId â†” uniqueId map'i oluÅŸtur
            const personnelSnap = await db.collection('personel')
                .where('branch', '==', branch)
                .get();
            
            const docIdToUniqueId = {};
            const uniqueIdToDocId = {};
            const uniqueIdToPersonnel = {};
            
            personnelSnap.docs.forEach(pDoc => {
                const pData = pDoc.data();
                const uniqueId = (pData.uniqueId || pDoc.id || '').toLowerCase();
                docIdToUniqueId[pDoc.id] = uniqueId;
                docIdToUniqueId[pDoc.id.toLowerCase()] = uniqueId;
                uniqueIdToDocId[uniqueId] = pDoc.id;
                uniqueIdToPersonnel[uniqueId] = {
                    id: pDoc.id,
                    uniqueId: pData.uniqueId || pDoc.id,
                    name: pData.name,
                    displayName: pData.displayName,
                    codeName: pData.codeName || pData.displayName || pData.name
                };
            });
            
            // === MIGRATION: docId â†’ uniqueId ===
            let needsMigration = false;
            const migratedAssignments = (existingData.assignments || []).map(a => {
                const pid = a.personnelId || '';
                
                // Bu ID bir docId mi? (uniqueId genelde underscore iÃ§erir, docId uzun random string)
                const isDocId = pid.length > 15 && !pid.includes('_');
                
                if (isDocId && docIdToUniqueId[pid]) {
                    const newUniqueId = docIdToUniqueId[pid];
                    const personnel = uniqueIdToPersonnel[newUniqueId];
                    
                    console.log(`[Migration] ${pid} â†’ ${newUniqueId}`);
                    needsMigration = true;
                    
                    return {
                        ...a,
                        personnelId: personnel?.uniqueId || newUniqueId,
                        personnelName: personnel?.codeName || a.personnelName,
                        personnelFullName: personnel?.name || a.personnelFullName,
                        migratedAt: new Date().toISOString()
                    };
                }
                return a;
            });
            
            // Migration gerekiyorsa kaydet
            if (needsMigration) {
                console.log('[Migration] ID\'ler migrate ediliyor...');
                existingData = {
                    ...existingData,
                    assignments: migratedAssignments,
                    lastMigrationAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                await db.collection('weeklyAssignments').doc(docId).update(existingData);
                console.log('[Migration] TamamlandÄ±!');
            }
            
            // === SHIFT SYNC ===
            // Shift deÄŸiÅŸikliÄŸi kontrolÃ¼ - havuzu gÃ¼ncel al
            const currentPool = await getAssignmentPool(branch);
            const currentPoolUniqueIds = new Set(currentPool.map(p => (p.uniqueId || p.id || '').toLowerCase()));
            
            // Mevcut atamalardaki personel uniqueId'lerini topla
            const assignedUniqueIds = new Set();
            (existingData.assignments || []).forEach(a => {
                const pid = a.personnelId || '';
                const uniqueId = (pid.includes('_') ? pid : docIdToUniqueId[pid] || pid).toLowerCase();
                assignedUniqueIds.add(uniqueId);
            });
            
            // Ã‡Ä±kan ve giren personeli tespit et (uniqueId bazÄ±nda)
            const removedUniqueIds = [...assignedUniqueIds].filter(id => !currentPoolUniqueIds.has(id));
            const addedUniqueIds = [...currentPoolUniqueIds].filter(id => !assignedUniqueIds.has(id));
            
            // DeÄŸiÅŸiklik varsa sync yap
            if (removedUniqueIds.length > 0 || addedUniqueIds.length > 0) {
                console.log('[HaftalÄ±k] Shift deÄŸiÅŸikliÄŸi tespit edildi!');
                console.log('   Ã‡Ä±kan:', removedUniqueIds);
                console.log('   Giren:', addedUniqueIds);
                
                return await syncWeeklyAssignmentsWithShift(branch, existingData, currentPool, removedUniqueIds, addedUniqueIds, docIdToUniqueId, uniqueIdToDocId, uniqueIdToPersonnel);
            }
            
            return existingData;
        }
        
        // Yeni atama oluÅŸtur
        console.log('[HaftalÄ±k] Yeni atama oluÅŸturuluyor:', docId);
        return await createWeeklyAssignments(branch, weekId);
        
    } catch (e) {
        console.error('[HaftalÄ±k] Atama alÄ±namadÄ±:', e);
        return null;
    }
}

// Shift deÄŸiÅŸikliklerinde atamalarÄ± sync et
async function syncWeeklyAssignmentsWithShift(branch, existingData, currentPool, removedUniqueIds, addedUniqueIds, docIdToUniqueId, uniqueIdToDocId, uniqueIdToPersonnel) {
    const weekId = getWeekId();
    const docId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_${weekId}`;
    
    let assignments = [...(existingData.assignments || [])];
    
    // Havuzdaki personel map (uniqueId bazÄ±nda)
    const poolByUniqueId = {};
    currentPool.forEach(p => {
        const uniqueId = (p.uniqueId || p.id || '').toLowerCase();
        poolByUniqueId[uniqueId] = p;
    });
    
    // Helper: personnelId'den uniqueId'ye Ã§evir
    const toUniqueId = (pid) => {
        if (!pid) return '';
        if (pid.includes('_')) return pid.toLowerCase();
        return (docIdToUniqueId[pid] || docIdToUniqueId[pid.toLowerCase()] || pid).toLowerCase();
    };
    
    // 1. Ã‡Ä±kan personelin gÃ¶revlerini yeniden daÄŸÄ±t
    if (removedUniqueIds.length > 0) {
        const tasksToReassign = assignments.filter(a => {
            const uniqueId = toUniqueId(a.personnelId);
            return removedUniqueIds.includes(uniqueId);
        });
        
        if (tasksToReassign.length > 0) {
            console.log('[HaftalÄ±k] Yeniden daÄŸÄ±tÄ±lacak gÃ¶rev sayÄ±sÄ±:', tasksToReassign.length);
            
            const activeUniqueIds = currentPool.map(p => (p.uniqueId || p.id || '').toLowerCase());
            
            if (activeUniqueIds.length > 0) {
                // Her personelin mevcut gÃ¶rev sayÄ±sÄ±nÄ± hesapla
                const taskCounts = {};
                activeUniqueIds.forEach(id => taskCounts[id] = 0);
                
                assignments.forEach(a => {
                    const uniqueId = toUniqueId(a.personnelId);
                    if (activeUniqueIds.includes(uniqueId)) {
                        taskCounts[uniqueId] = (taskCounts[uniqueId] || 0) + 1;
                    }
                });
                
                // Yeniden atanacak gÃ¶revleri en az gÃ¶revi olana ver
                tasksToReassign.forEach(task => {
                    let minUniqueId = activeUniqueIds[0];
                    let minCount = taskCounts[minUniqueId] || 0;
                    
                    activeUniqueIds.forEach(uid => {
                        if ((taskCounts[uid] || 0) < minCount) {
                            minCount = taskCounts[uid] || 0;
                            minUniqueId = uid;
                        }
                    });
                    
                    const assignee = poolByUniqueId[minUniqueId];
                    if (assignee) {
                        task.personnelId = assignee.uniqueId || assignee.id;
                        task.personnelName = assignee.codeName || assignee.displayName || assignee.name;
                        task.personnelFullName = assignee.name;
                        task.reassignedAt = new Date().toISOString();
                        task.reassignReason = 'shift_removed';
                        
                        taskCounts[minUniqueId] = (taskCounts[minUniqueId] || 0) + 1;
                        console.log(`[HaftalÄ±k] GÃ¶rev yeniden atandÄ±: "${task.itemText?.substring(0, 30)}" â†’ ${assignee.codeName || assignee.name}`);
                    }
                });
            }
        }
    }
    
    // 2. Giren personele gÃ¶rev aktar (en Ã§ok gÃ¶revi olanlardan)
    if (addedUniqueIds.length > 0 && currentPool.length > 1) {
        const activeUniqueIds = currentPool.map(p => (p.uniqueId || p.id || '').toLowerCase());
        
        const taskCounts = {};
        activeUniqueIds.forEach(id => taskCounts[id] = 0);
        
        assignments.forEach(a => {
            const uniqueId = toUniqueId(a.personnelId);
            if (taskCounts.hasOwnProperty(uniqueId)) {
                taskCounts[uniqueId]++;
            }
        });
        
        const totalTasks = assignments.length;
        const targetPerPerson = Math.floor(totalTasks / activeUniqueIds.length);
        
        addedUniqueIds.forEach(newUniqueId => {
            const newPerson = poolByUniqueId[newUniqueId];
            if (!newPerson) return;
            
            const tasksToGive = Math.max(1, targetPerPerson);
            let given = 0;
            
            while (given < tasksToGive) {
                let maxUniqueId = null;
                let maxCount = 0;
                
                Object.entries(taskCounts).forEach(([uid, count]) => {
                    if (uid !== newUniqueId && count > maxCount) {
                        maxCount = count;
                        maxUniqueId = uid;
                    }
                });
                
                if (!maxUniqueId || maxCount <= targetPerPerson) break;
                
                const taskToMove = assignments.find(a => {
                    const uniqueId = toUniqueId(a.personnelId);
                    return uniqueId === maxUniqueId && a.status !== 'completed';
                });
                
                if (taskToMove) {
                    taskToMove.personnelId = newPerson.uniqueId || newPerson.id;
                    taskToMove.personnelName = newPerson.codeName || newPerson.displayName || newPerson.name;
                    taskToMove.personnelFullName = newPerson.name;
                    taskToMove.reassignedAt = new Date().toISOString();
                    taskToMove.reassignReason = 'shift_added';
                    
                    taskCounts[maxUniqueId]--;
                    taskCounts[newUniqueId] = (taskCounts[newUniqueId] || 0) + 1;
                    given++;
                    
                    console.log(`[HaftalÄ±k] GÃ¶rev aktarÄ±ldÄ±: "${taskToMove.itemText?.substring(0, 30)}" â†’ ${newPerson.codeName || newPerson.name}`);
                } else {
                    break;
                }
            }
        });
    }
    
    // Firebase'e gÃ¼ncelle
    const updatedData = {
        ...existingData,
        assignments,
        pool: currentPool.map(p => ({ id: p.uniqueId || p.id, name: p.codeName || p.displayName || p.name })),
        lastSyncAt: firebase.firestore.FieldValue.serverTimestamp(),
        syncReason: removedUniqueIds.length > 0 ? 'personnel_removed' : 'personnel_added'
    };
    
    await db.collection('weeklyAssignments').doc(docId).update(updatedData);
    console.log('[HaftalÄ±k] Atamalar sync edildi:', docId);
    
    return updatedData;
}

// Yeni haftalÄ±k atama oluÅŸtur (round-robin)
async function createWeeklyAssignments(branch, weekId) {
    const branchKey = branch.replace(/[^a-zA-Z0-9]/g, '_');
    const docId = `${branchKey}_${weekId}`;
    
    try {
        // Personel havuzunu al
        const pool = await getAssignmentPool(branch);
        
        if (pool.length === 0) {
            console.warn('[HaftalÄ±k] Atama havuzu boÅŸ!');
            return null;
        }
        
        console.log('[HaftalÄ±k] Atama havuzu:', pool.map(p => p.codeName));
        
        // Checklist maddelerini al
        const checklistDoc = await db.collection('checklists').doc(`${branchKey}_haftalik`).get();
        if (!checklistDoc.exists) {
            console.warn('[HaftalÄ±k] Checklist bulunamadÄ±!');
            return null;
        }
        
        const items = checklistDoc.data().items || [];
        if (items.length === 0) {
            console.warn('[HaftalÄ±k] Checklist maddeleri boÅŸ!');
            return null;
        }
        
        // Ã–nceki haftanÄ±n rotationIndex'ini al (kayma iÃ§in)
        let rotationIndex = 0;
        const prevWeekStart = new Date(getWeekStartDate());
        prevWeekStart.setDate(prevWeekStart.getDate() - 7);
        const prevWeekId = prevWeekStart.toISOString().split('T')[0];
        const prevDocId = `${branchKey}_${prevWeekId}`;
        
        try {
            const prevDoc = await db.collection('weeklyAssignments').doc(prevDocId).get();
            if (prevDoc.exists) {
                rotationIndex = ((prevDoc.data().rotationIndex || 0) + 1) % pool.length;
                console.log('[HaftalÄ±k] Ã–nceki rotationIndex:', prevDoc.data().rotationIndex, 'â†’ Yeni:', rotationIndex);
            }
        } catch (e) {
            console.log('[HaftalÄ±k] Ã–nceki hafta verisi yok, rotationIndex=0');
        }
        
        // Round-robin atama yap
        const assignments = [];
        const rules = CHECK_RULES.haftalik || {};
        const cooldownHours = rules.cooldownHours || 48;
        
        items.forEach((item, idx) => {
            // Madde iÃ§in uygun roller (eÄŸer tanÄ±mlanmÄ±ÅŸsa)
            const allowedRoles = item.roles || null; // null = tÃ¼mÃ¼
            
            // Uygun personeli filtrele
            let eligiblePool = pool;
            if (allowedRoles && allowedRoles.length > 0 && allowedRoles[0] !== 'all') {
                eligiblePool = pool.filter(p => 
                    allowedRoles.includes(p.role) || 
                    allowedRoles.includes(p.position)
                );
            }
            
            if (eligiblePool.length === 0) {
                console.warn(`[HaftalÄ±k] Madde "${item.text?.substring(0, 30)}" iÃ§in uygun personel yok!`);
                eligiblePool = pool; // Fallback: tÃ¼m havuz
            }
            
            // Round-robin ile ata (rotationIndex kaydÄ±rma ile)
            const assigneeIndex = (idx + rotationIndex) % eligiblePool.length;
            const assignee = eligiblePool[assigneeIndex];
            
            assignments.push({
                itemId: item.id || `item_${idx}`,
                itemText: item.text || '',
                personnelId: assignee.uniqueId || assignee.id, // uniqueId kullan (tutarlÄ±lÄ±k iÃ§in)
                personnelName: assignee.codeName || assignee.displayName || assignee.name,
                personnelFullName: assignee.name,
                assignedAt: new Date().toISOString(),
                cooldownHours: cooldownHours,
                status: 'pending', // pending, completed, missed
                completedAt: null,
                nextActiveAt: null // Cooldown sonrasÄ± tekrar aktif olacaÄŸÄ± zaman
            });
        });
        
        // Firebase'e kaydet
        const data = {
            branch,
            weekStart: weekId,
            rotationIndex,
            assignments,
            pool: pool.map(p => ({ id: p.uniqueId || p.id, name: p.codeName || p.displayName || p.name })),
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await db.collection('weeklyAssignments').doc(docId).set(data);
        console.log('[HaftalÄ±k] Atama oluÅŸturuldu:', docId, `(${assignments.length} madde, ${pool.length} personel)`);
        
        return data;
        
    } catch (e) {
        console.error('[HaftalÄ±k] Atama oluÅŸturma hatasÄ±:', e);
        return null;
    }
}

// Bir maddeyi tamamla
async function completeWeeklyItem(branch, itemId, personnelId) {
    const weekId = getWeekId();
    const docId = `${branch.replace(/[^a-zA-Z0-9]/g, '_')}_${weekId}`;
    
    try {
        const doc = await db.collection('weeklyAssignments').doc(docId).get();
        if (!doc.exists) {
            console.error('[HaftalÄ±k] Atama bulunamadÄ±:', docId);
            return false;
        }
        
        const data = doc.data();
        const assignments = data.assignments || [];
        const rules = CHECK_RULES.haftalik || {};
        const cooldownHours = rules.cooldownHours || 48;
        
        // Ä°lgili maddeyi bul
        const assignment = assignments.find(a => a.itemId === itemId && a.personnelId === personnelId);
        if (!assignment) {
            console.error('[HaftalÄ±k] Atama bulunamadÄ±:', itemId, personnelId);
            return false;
        }
        
        // Tamamla
        const now = new Date();
        assignment.status = 'completed';
        assignment.completedAt = now.toISOString();
        assignment.nextActiveAt = new Date(now.getTime() + cooldownHours * 60 * 60 * 1000).toISOString();
        
        // GÃ¼ncelle
        await db.collection('weeklyAssignments').doc(docId).update({
            assignments,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log(`[HaftalÄ±k] âœ… Madde tamamlandÄ±: ${assignment.itemText?.substring(0, 30)} (${assignment.personnelName})`);
        
        // Puan ekle
        const points = rules.points?.onTime || 1;
        await addWeeklyPoints(branch, personnelId, assignment.personnelName, itemId, points, 'completed');
        
        return true;
        
    } catch (e) {
        console.error('[HaftalÄ±k] Tamamlama hatasÄ±:', e);
        return false;
    }
}

// HaftalÄ±k puan ekle
async function addWeeklyPoints(branch, personnelId, personnelName, itemId, points, status) {
    const todayStr = new Date().toISOString().split('T')[0];
    const noteId = `haftalik_${personnelId}_${todayStr}_${itemId}`;
    
    try {
        await db.collection('puantajNotes').doc(noteId).set({
            personelId: personnelId,
            personelName: personnelName,
            branch,
            date: todayStr,
            checkType: 'haftalik',
            itemId,
            status,
            points,
            note: `HaftalÄ±k gÃ¶rev ${status === 'completed' ? 'tamamlandÄ±' : 'kaÃ§Ä±rÄ±ldÄ±'}`,
            autoGenerated: true,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log(`[HaftalÄ±k] Puan eklendi: ${personnelName} ${points > 0 ? '+' : ''}${points}`);
    } catch (e) {
        console.error('[HaftalÄ±k] Puan ekleme hatasÄ±:', e);
    }
}

// Cooldown kontrolÃ¼ - aktif maddeler iÃ§in geri sayÄ±m
function getItemCooldownStatus(assignment) {
    if (!assignment) return { status: 'unknown', remainingMs: 0 };
    
    const now = new Date();
    const cooldownHours = assignment.cooldownHours || 48;
    const cooldownMs = cooldownHours * 60 * 60 * 1000;
    
    // PENDING durumu - atandÄ±ÄŸÄ± andan itibaren cooldown baÅŸlar
    if (assignment.status === 'pending') {
        const assignedAt = assignment.assignedAt ? new Date(assignment.assignedAt) : now;
        const deadline = new Date(assignedAt.getTime() + cooldownMs);
        const remainingMs = deadline.getTime() - now.getTime();
        
        if (remainingMs > 0) {
            // SÃ¼re devam ediyor - yapÄ±lmayÄ± bekliyor
            const hours = Math.floor(remainingMs / (1000 * 60 * 60));
            const minutes = Math.floor((remainingMs % (1000 * 60 * 60)) / (1000 * 60));
            return {
                status: 'pending_countdown',
                remainingMs,
                message: `${hours}s ${minutes}dk kaldÄ±`,
                deadline: deadline.toISOString()
            };
        } else {
            // SÃ¼re doldu ama yapÄ±lmadÄ±
            return { 
                status: 'overdue', 
                remainingMs: 0, 
                message: 'SÃ¼resi doldu!',
                isOverdue: true
            };
        }
    }
    
    // COMPLETED durumu - tamamlandÄ±ktan sonra cooldown
    if (assignment.status === 'completed' && assignment.nextActiveAt) {
        const nextActive = new Date(assignment.nextActiveAt);
        const remainingMs = nextActive.getTime() - now.getTime();
        
        if (remainingMs > 0) {
            // Cooldown devam ediyor
            const hours = Math.floor(remainingMs / (1000 * 60 * 60));
            const minutes = Math.floor((remainingMs % (1000 * 60 * 60)) / (1000 * 60));
            return {
                status: 'cooldown',
                remainingMs,
                message: `${hours}s ${minutes}dk sonra aktif`,
                nextActiveAt: assignment.nextActiveAt
            };
        } else {
            // Cooldown bitti, tekrar aktif
            return { status: 'active', remainingMs: 0, message: 'Tekrar yapÄ±labilir' };
        }
    }
    
    // COMPLETED ama nextActiveAt yok (eski kayÄ±t)
    if (assignment.status === 'completed') {
        return { status: 'completed_no_cooldown', remainingMs: 0, message: 'TamamlandÄ± âœ“' };
    }
    
    if (assignment.status === 'missed') {
        return { status: 'missed', remainingMs: 0, message: 'KaÃ§Ä±rÄ±ldÄ±' };
    }
    
    return { status: 'unknown', remainingMs: 0 };
}

// Personelin haftalÄ±k gÃ¶revlerini al
async function getPersonnelWeeklyTasks(branch, personnelId) {
    const assignments = await getOrCreateWeeklyAssignments(branch);
    if (!assignments) return [];
    
    return (assignments.assignments || [])
        .filter(a => a.personnelId === personnelId)
        .map(a => ({
            ...a,
            cooldownStatus: getItemCooldownStatus(a)
        }));
}

// Dashboard iÃ§in haftalÄ±k Ã¶zet
async function getWeeklyDashboardSummary(branch, personnelId) {
    const tasks = await getPersonnelWeeklyTasks(branch, personnelId);
    
    const total = tasks.length;
    
    // Yeni durum hesaplamalarÄ±
    const pending = tasks.filter(t => t.cooldownStatus.status === 'pending_countdown').length;
    const overdue = tasks.filter(t => t.cooldownStatus.status === 'overdue').length;
    const cooldown = tasks.filter(t => t.cooldownStatus.status === 'cooldown').length;
    const completed = tasks.filter(t => t.status === 'completed').length;
    const active = tasks.filter(t => t.cooldownStatus.status === 'active').length; // Tekrar yapÄ±labilir
    
    // YapÄ±lmasÄ± gereken gÃ¶revler = pending + overdue + active (tekrar yapÄ±labilir)
    const todoCount = pending + overdue + active;
    
    // En yakÄ±n deadline (pending gÃ¶revler iÃ§in)
    let nearestDeadline = null;
    tasks.filter(t => t.cooldownStatus.status === 'pending_countdown')
        .forEach(t => {
            if (!nearestDeadline || t.cooldownStatus.remainingMs < nearestDeadline.remainingMs) {
                nearestDeadline = t.cooldownStatus;
            }
        });
    
    // En yakÄ±n aktif olacak madde (cooldown'daki gÃ¶revler iÃ§in)
    let nearestCooldown = null;
    tasks.filter(t => t.cooldownStatus.status === 'cooldown')
        .forEach(t => {
            if (!nearestCooldown || t.cooldownStatus.remainingMs < nearestCooldown.remainingMs) {
                nearestCooldown = t.cooldownStatus;
            }
        });
    
    return {
        total,
        pending,       // YapÄ±lmayÄ± bekliyor (geri sayÄ±mlÄ±)
        overdue,       // SÃ¼resi dolmuÅŸ
        cooldown,      // TamamlanmÄ±ÅŸ, bekleme sÃ¼resi
        completed,     // Toplam tamamlanan
        active,        // Tekrar yapÄ±labilir
        todoCount,     // YapÄ±lmasÄ± gereken toplam
        nearestDeadline, // En yakÄ±n deadline
        nearestCooldown, // En yakÄ±n aktif olacak
        tasks
    };
}

// ==================== MOTÄ°VASYON SÃ–ZLERÄ° ====================
// Fallback sÃ¶zler - Firebase'e eriÅŸilemezse kullanÄ±lÄ±r
const MOTIVATION_QUOTES = [
    // BaÅŸarÄ± & Hedef
    { text: "BaÅŸarÄ±, her gÃ¼n tekrarlanan kÃ¼Ã§Ã¼k Ã§abalarÄ±n toplamÄ±dÄ±r.", author: "Robert Collier" },
    { text: "BaÅŸarÄ±nÄ±n sÄ±rrÄ±, baÅŸlamaktÄ±r.", author: "Mark Twain" },
    { text: "Hayal edebiliyorsan, yapabilirsin.", author: "Walt Disney" },
    { text: "BaÅŸarÄ±, hazÄ±rlÄ±k ile fÄ±rsatÄ±n buluÅŸtuÄŸu yerdir.", author: "Bobby Unser" },
    { text: "BÃ¼yÃ¼k iÅŸler, kÃ¼Ã§Ã¼k adÄ±mlarla baÅŸlar.", author: "Lao Tzu" },
    { text: "Her baÅŸarÄ±, bir karar ile baÅŸlar.", author: "Tony Robbins" },
    { text: "Hedefsiz bir gemi iÃ§in hiÃ§bir rÃ¼zgar uygun deÄŸildir.", author: "Seneca" },
    { text: "BaÅŸarÄ±, dÃ¼ÅŸmeden kalkmaktan geÃ§er.", author: "Vince Lombardi" },
    { text: "BÃ¼yÃ¼k dÃ¼ÅŸÃ¼n, kÃ¼Ã§Ã¼k baÅŸla, hemen baÅŸla.", author: "Robin Sharma" },
    { text: "BaÅŸarÄ±, yaptÄ±ÄŸÄ±n iÅŸi severek yapmaktÄ±r.", author: "Steve Jobs" },
    
    // Ã‡alÄ±ÅŸma & Emek
    { text: "Ã‡alÄ±ÅŸmak, baÅŸarÄ±nÄ±n tek reÃ§etesidir.", author: "Thomas Edison" },
    { text: "BugÃ¼n yapabileceÄŸin iÅŸi yarÄ±na bÄ±rakma.", author: "Benjamin Franklin" },
    { text: "Zor iÅŸler bizi gÃ¼Ã§lendirir.", author: "Seneca" },
    { text: "Emek olmadan baÅŸarÄ± olmaz.", author: "Thomas Jefferson" },
    { text: "Disiplin, Ã¶zgÃ¼rlÃ¼ÄŸe giden kÃ¶prÃ¼dÃ¼r.", author: "Jocko Willink" },
    { text: "MÃ¼kemmellik, alÄ±ÅŸkanlÄ±klarÄ±n sonucudur.", author: "Aristoteles" },
    { text: "SabÄ±r ve azim, tÃ¼m zorluklarÄ± yener.", author: "Benjamin Franklin" },
    { text: "BaÅŸarÄ±, konfor alanÄ±nÄ±n dÄ±ÅŸÄ±nda yaÅŸar.", author: "Neale Donald Walsch" },
    
    // Olumlu DÃ¼ÅŸÃ¼nce
    { text: "Pozitif dÃ¼ÅŸÃ¼nce, pozitif sonuÃ§lar doÄŸurur.", author: "Norman Vincent Peale" },
    { text: "DÃ¼ÅŸÃ¼ncelerinizi deÄŸiÅŸtirin, hayatÄ±nÄ±z deÄŸiÅŸsin.", author: "Wayne Dyer" },
    { text: "Her yeni gÃ¼n, yeni bir baÅŸlangÄ±Ã§tÄ±r.", author: "Eleanor Roosevelt" },
    { text: "Ä°yimserlik, baÅŸarÄ±nÄ±n temelidir.", author: "Helen Keller" },
    { text: "Zorluklar, karakteri ÅŸekillendirir.", author: "Helen Keller" },
    { text: "Mutluluk bir karar meselesidir.", author: "Abraham Lincoln" },
    { text: "Umut, karanlÄ±ktaki Ä±ÅŸÄ±ktÄ±r.", author: "Desmond Tutu" },
    
    // Azim & Ä°rade
    { text: "Asla pes etme, her ÅŸey mÃ¼mkÃ¼n.", author: "Muhammad Ali" },
    { text: "KararlÄ±lÄ±k, tÃ¼m engelleri aÅŸar.", author: "Leonardo da Vinci" },
    { text: "Her baÅŸarÄ±sÄ±zlÄ±k, baÅŸarÄ±ya bir adÄ±m daha yaklaÅŸtÄ±rÄ±r.", author: "Thomas Edison" },
    { text: "SabÄ±r acÄ±dÄ±r, meyvesi tatlÄ±dÄ±r.", author: "Jean-Jacques Rousseau" },
    { text: "Zorlu gÃ¼nler, gÃ¼Ã§lÃ¼ insanlar yaratÄ±r.", author: "Robert H. Schuller" },
    
    // Kendine GÃ¼ven
    { text: "Kendine inan, geri kalanÄ± gelir.", author: "Venus Williams" },
    { text: "Kendinize yatÄ±rÄ±m yapÄ±n, en iyi yatÄ±rÄ±mdÄ±r.", author: "Warren Buffett" },
    { text: "Cesaret, korkunun yokluÄŸu deÄŸil, korkuya raÄŸmen devam etmektir.", author: "Nelson Mandela" },
    { text: "Ã–zgÃ¼ven, baÅŸarÄ±nÄ±n anahtarÄ±dÄ±r.", author: "Ralph Waldo Emerson" },
    { text: "SÄ±nÄ±rlarÄ±nÄ±zÄ± siz belirlersiniz.", author: "Carol Burnett" },
    
    // Zaman YÃ¶netimi
    { text: "Zaman altÄ±ndan deÄŸerlidir, iyi kullanÄ±n.", author: "Benjamin Franklin" },
    { text: "DÃ¼n tarihtir, yarÄ±n gizemdir, bugÃ¼n bir armaÄŸandÄ±r.", author: "Eleanor Roosevelt" },
    { text: "ZamanÄ± deÄŸil, iÅŸi yÃ¶netin.", author: "Peter Drucker" },
    
    // GeliÅŸim & Ã–ÄŸrenme
    { text: "Bilgi gÃ¼Ã§tÃ¼r.", author: "Francis Bacon" },
    { text: "HatalarÄ±ndan Ã¶ÄŸren, onlardan bÃ¼yÃ¼.", author: "John C. Maxwell" },
    { text: "MeraklÄ± ol, keÅŸfetmeye devam et.", author: "Steve Jobs" },
    { text: "Ã–ÄŸrenmek asla bitmez.", author: "Leonardo da Vinci" },
    { text: "DeÄŸiÅŸim kaÃ§Ä±nÄ±lmazdÄ±r, geliÅŸim bir seÃ§imdir.", author: "John C. Maxwell" },
    
    // FizikÃ§iler & Bilim Ä°nsanlarÄ±
    { text: "Hayal gÃ¼cÃ¼ bilgiden daha Ã¶nemlidir.", author: "Albert Einstein" },
    { text: "Delilik aynÄ± ÅŸeyi yapÄ±p farklÄ± sonuÃ§ beklemektir.", author: "Albert Einstein" },
    { text: "Hayat bisiklete binmek gibidir, dengede kalmak iÃ§in hareket etmelisin.", author: "Albert Einstein" },
    { text: "Evrende en gÃ¼Ã§lÃ¼ gÃ¼Ã§ bileÅŸik faizdir.", author: "Albert Einstein" },
    { text: "Basit tutun, mÃ¼kemmel yapÄ±n.", author: "Richard Feynman" },
    { text: "DoÄŸa basitliÄŸi sever.", author: "Isaac Newton" },
    { text: "Daha ileri gÃ¶rebildiysem, devlerin omuzlarÄ±nda durduÄŸum iÃ§indir.", author: "Isaac Newton" },
    { text: "Her ÅŸey mÃ¼mkÃ¼ndÃ¼r, imkansÄ±z sadece daha uzun sÃ¼rer.", author: "Marie Curie" },
    { text: "Hayatta korkacak bir ÅŸey yok, sadece anlaÅŸÄ±lacak ÅŸeyler var.", author: "Marie Curie" },
    { text: "Evreni anlamaya Ã§alÄ±ÅŸÄ±rken, kendimizi de anlÄ±yoruz.", author: "Carl Sagan" },
    
    // Filozoflar
    { text: "Kendini bil.", author: "Sokrates" },
    { text: "EÄŸitim, Ã¶zgÃ¼rlÃ¼ÄŸÃ¼n anahtarÄ±dÄ±r.", author: "Epictetus" },
    { text: "Mutluluk, erdemli bir yaÅŸamÄ±n Ã¼rÃ¼nÃ¼dÃ¼r.", author: "Aristoteles" },
    { text: "En bÃ¼yÃ¼k zafer, kendini yenmektir.", author: "Platon" },
    { text: "DeÄŸiÅŸim tek sabit olandÄ±r.", author: "Herakleitos" },
    { text: "GÃ¼Ã§lÃ¼ olan galip gelmez, galip gelen gÃ¼Ã§lÃ¼ olur.", author: "Franz Kafka" },
    
    // Modern Liderler
    { text: "Ä°novasyon, liderliÄŸi tanÄ±mlar.", author: "Steve Jobs" },
    { text: "MÃ¼ÅŸteriye aÅŸÄ±k ol, Ã¼rÃ¼ne deÄŸil.", author: "Jeff Bezos" },
    { text: "Her baÅŸarÄ±sÄ±zlÄ±k, bir Ã¶ÄŸrenme fÄ±rsatÄ±dÄ±r.", author: "Elon Musk" },
    { text: "Uzun vadeli dÃ¼ÅŸÃ¼n.", author: "Jeff Bezos" },
    { text: "BÃ¼yÃ¼k iÅŸler, bÃ¼yÃ¼k takÄ±mlarla yapÄ±lÄ±r.", author: "Bill Gates" },
    { text: "Hata yapmaktan korkma, tekrarlamaktan kork.", author: "Warren Buffett" },
    { text: "Risk almadan kazanÄ±lmaz.", author: "Mark Zuckerberg" },
    { text: "Basitlik, karmaÅŸÄ±klÄ±ÄŸÄ±n Ã¶tesindedir.", author: "Steve Jobs" },
    
    // Ekip & Ä°ÅŸ
    { text: "YalnÄ±z hÄ±zlÄ± gidersin, birlikte uzaÄŸa.", author: "Afrika AtasÃ¶zÃ¼" },
    { text: "TakÄ±m oyunu, en gÃ¼Ã§lÃ¼ oyundur.", author: "Michael Jordan" },
    { text: "Liderlik, hizmet etmektir.", author: "Robert K. Greenleaf" },
    { text: "Ã–rnek ol, sÃ¶zle deÄŸil davranÄ±ÅŸla.", author: "Albert Einstein" },
    
    // Sakinlik
    { text: "Sakinlik, gÃ¼cÃ¼n iÅŸaretidir.", author: "Lao Tzu" },
    { text: "KontrolÃ¼n dÄ±ÅŸÄ±ndakileri bÄ±rak.", author: "Epictetus" },
    { text: "Åžu anÄ± yaÅŸa, endiÅŸeyi bÄ±rak.", author: "Buddha" },
    
    // Motivasyon
    { text: "Ä°mkansÄ±z, olasÄ± deÄŸil demektir.", author: "Audrey Hepburn" },
    { text: "DeÄŸiÅŸim seninle baÅŸlar.", author: "Mahatma Gandhi" },
    { text: "YÄ±lmadan devam et.", author: "Winston Churchill" },
    { text: "Tutku, baÅŸarÄ±nÄ±n yakÄ±tÄ±dÄ±r.", author: "Oprah Winfrey" },
    { text: "Her zorluk, bir Ã¶ÄŸretmendir.", author: "Paulo Coelho" },
    { text: "GÃ¼Ã§ iÃ§inde.", author: "Yoda" }
];

async function loadMotivationQuote() {
    const quoteEl = document.getElementById('motivationQuote');
    if (!quoteEl) return;
    
    try {
        // Firestore'dan rastgele sÃ¶z Ã§ek
        const snapshot = await db.collection('motivationQuotes').get();
        
        if (!snapshot.empty) {
            // Firestore'dan rastgele seÃ§
            const quotes = snapshot.docs.map(doc => doc.data());
            const randomIndex = Math.floor(Math.random() * quotes.length);
            const quote = quotes[randomIndex];
            quoteEl.innerHTML = `"${quote.text}" <span style="color:var(--accent);font-weight:500">â€” ${quote.author}</span>`;
            return;
        }
    } catch (error) {
        console.log('Firestore sÃ¶zleri yÃ¼klenemedi, yerel sÃ¶zler kullanÄ±lÄ±yor');
    }
    
    // Fallback - yerel sÃ¶zler (gerÃ§ek random)
    const randomIndex = Math.floor(Math.random() * MOTIVATION_QUOTES.length);
    const quote = MOTIVATION_QUOTES[randomIndex];
    quoteEl.innerHTML = `"${quote.text}" <span style="color:var(--accent);font-weight:500">â€” ${quote.author}</span>`;
}

// ==================== DUYURU SÄ°STEMÄ° ====================
let announcementsData = [];
let announcementsLimit = 3;
let allAnnouncementsLoaded = false;

// DuyurularÄ± yÃ¼kle
async function loadAnnouncements() {
    const section = document.getElementById('announcementsSection');
    const container = document.getElementById('announcementsContainer');
    const addBtn = document.getElementById('addAnnouncementBtn');
    const loadMoreBtn = document.getElementById('loadMoreAnnouncements');
    
    if (!section || !container) return;
    
    // Yetki kontrolÃ¼ - yÃ¶netici veya add_announcement yetkisi olanlar ekleyebilir
    const canAdd = currentUser?.role === 'yonetici' || 
                   window.userAdvancedPermissions?.special?.add_announcement === true;
    if (addBtn) {
        addBtn.style.display = canAdd ? 'flex' : 'none';
    }
    
    try {
        // Firebase'den duyurularÄ± Ã§ek (son 20)
        const snapshot = await db.collection('announcements')
            .orderBy('createdAt', 'desc')
            .limit(20)
            .get();
        
        announcementsData = [];
        const userBranch = currentUser?.branch || '';
        const now = new Date();
        
        for (const doc of snapshot.docs) {
            const data = { id: doc.id, ...doc.data() };
            
            // SÃ¼resi dolmuÅŸ duyurularÄ± sil
            if (data.expiresAt) {
                const expiresDate = data.expiresAt.toDate ? data.expiresAt.toDate() : new Date(data.expiresAt);
                if (expiresDate < now) {
                    // SÃ¼resi dolmuÅŸ - sil
                    try {
                        await db.collection('announcements').doc(doc.id).delete();
                        console.log('SÃ¼resi dolmuÅŸ duyuru silindi:', doc.id);
                    } catch (e) {
                        console.error('Duyuru silinemedi:', e);
                    }
                    continue; // Bu duyuruyu listeye ekleme
                }
            }
            
            // Åžube filtresi - 'all' ise herkes gÃ¶rÃ¼r, deÄŸilse sadece o ÅŸubedekiler
            const targetBranches = data.branches || ['all'];
            if (targetBranches.includes('all') || targetBranches.includes(userBranch) || currentUser?.role === 'yonetici') {
                announcementsData.push(data);
            }
        }
        
        // Duyuru yoksa ve ekleme yetkisi de yoksa gizle
        if (announcementsData.length === 0 && !canAdd) {
            section.style.display = 'none';
            return;
        }
        
        // Yetkisi varsa veya duyuru varsa gÃ¶ster
        section.style.display = 'block';
        renderAnnouncements();
        
        // Daha fazla gÃ¶ster butonu
        if (loadMoreBtn) {
            loadMoreBtn.style.display = announcementsData.length > announcementsLimit ? 'block' : 'none';
        }
    } catch (e) {
        console.error('Duyurular yÃ¼klenemedi:', e);
    }
}

// DuyurularÄ± render et
function renderAnnouncements() {
    const container = document.getElementById('announcementsContainer');
    if (!container) return;
    
    // Duyuru yoksa boÅŸ mesaj
    if (announcementsData.length === 0) {
        container.innerHTML = `
            <div style="text-align:center;padding:20px;color:var(--tx3);font-size:.85rem">
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" style="margin:0 auto 8px;opacity:.5"><path d="M22 17H2a3 3 0 003-3V9a7 7 0 0114 0v5a3 3 0 003 3zM8.5 17v1a3.5 3.5 0 007 0v-1"/></svg>
                <div>HenÃ¼z duyuru yok</div>
            </div>
        `;
        return;
    }
    
    const visibleAnnouncements = announcementsData.slice(0, announcementsLimit);
    const canEdit = currentUser?.role === 'yonetici' || 
                    window.userAdvancedPermissions?.special?.add_announcement === true;
    
    // Duyuru tÃ¼rleri iÃ§in ikon ve renkler
    const typeConfig = {
        info: { 
            icon: '<svg width="16" height="16" fill="none" stroke="#3498db" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>',
            color: '#3498db',
            bgColor: 'rgba(52,152,219,.08)',
            borderColor: 'rgba(52,152,219,.2)'
        },
        success: { 
            icon: '<svg width="16" height="16" fill="none" stroke="#27ae60" stroke-width="2" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
            color: '#27ae60',
            bgColor: 'rgba(39,174,96,.08)',
            borderColor: 'rgba(39,174,96,.2)'
        },
        warning: { 
            icon: '<svg width="16" height="16" fill="none" stroke="#f39c12" stroke-width="2" viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
            color: '#f39c12',
            bgColor: 'rgba(243,156,18,.08)',
            borderColor: 'rgba(243,156,18,.2)'
        },
        urgent: { 
            icon: '<svg width="16" height="16" fill="none" stroke="#e74c3c" stroke-width="2" viewBox="0 0 24 24"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',
            color: '#e74c3c',
            bgColor: 'rgba(231,76,60,.1)',
            borderColor: 'rgba(231,76,60,.3)'
        },
        celebration: { 
            icon: '<svg width="16" height="16" fill="none" stroke="#9b59b6" stroke-width="2" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>',
            color: '#9b59b6',
            bgColor: 'rgba(155,89,182,.08)',
            borderColor: 'rgba(155,89,182,.2)'
        }
    };
    
    // Animasyon CSS mapping (toplam 12)
    const animationCSS = {
        none: '',
        pulse: 'animation:ann-pulse 2s ease-in-out infinite',
        shake: 'animation:ann-shake 1s ease-in-out infinite',
        glow: 'animation:ann-glow 2s ease-in-out infinite',
        bounce: 'animation:ann-bounce 1s ease-in-out infinite',
        slide: 'animation:ann-slide 1.5s ease-in-out infinite',
        blink: 'animation:ann-blink 1s ease-in-out infinite',
        heartbeat: 'animation:ann-heartbeat 1.5s ease-in-out infinite',
        swing: 'animation:ann-swing 1s ease-in-out infinite',
        tada: 'animation:ann-tada 1.5s ease-in-out infinite',
        rubber: 'animation:ann-rubber 1s ease-in-out infinite',
        flash: 'animation:ann-flash 1.5s ease-in-out infinite'
    };
    
    container.innerHTML = visibleAnnouncements.map(ann => {
        const date = ann.createdAt?.toDate ? ann.createdAt.toDate() : new Date(ann.createdAt);
        const dateStr = date.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
        const branchText = ann.branches?.includes('all') ? 'TÃ¼m Åžubeler' : (ann.branches?.join(', ') || '');
        
        // TÃ¼r bilgisini al (eski format uyumluluÄŸu iÃ§in priority'yi de kontrol et)
        const annType = ann.type || (ann.priority === 'urgent' ? 'urgent' : 'info');
        const config = typeConfig[annType] || typeConfig.info;
        const animation = animationCSS[ann.animation] || '';
        
        return `
            <div class="announcement-card" style="background:${config.bgColor};border-color:${config.borderColor};border-left-color:${config.color};${animation}">
                <div class="announcement-header">
                    <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;flex:1;min-width:0">
                        <div class="announcement-title" style="display:flex;align-items:center;gap:6px">
                            ${config.icon}
                            <span>${ann.title || 'Duyuru'}</span>
                        </div>
                        <span style="font-size:.6rem;color:var(--tx3)">â€¢</span>
                        <span style="font-size:.65rem;color:var(--tx3)">${branchText}</span>
                        <span style="font-size:.6rem;color:var(--tx3)">â€¢</span>
                        <span style="font-size:.65rem;color:var(--tx3)">${ann.createdByName || 'YÃ¶netici'}</span>
                        <span style="font-size:.6rem;color:var(--tx3)">â€¢</span>
                        <span style="font-size:.65rem;color:var(--tx3)">${dateStr}</span>
                    </div>
                    ${canEdit ? `
                        <div style="display:flex;gap:4px;flex-shrink:0">
                            <button class="announcement-edit" onclick="showAddAnnouncementModal('${ann.id}')" title="DÃ¼zenle">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                            </button>
                            <button class="announcement-delete" onclick="deleteAnnouncement('${ann.id}')" title="Sil">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                            </button>
                        </div>
                    ` : ''}
                </div>
                <div class="announcement-content">${ann.content || ''}</div>
            </div>
        `;
    }).join('');
}

// Daha fazla duyuru yÃ¼kle
function loadMoreAnnouncements() {
    announcementsLimit += 5;
    renderAnnouncements();
    
    const loadMoreBtn = document.getElementById('loadMoreAnnouncements');
    if (loadMoreBtn && announcementsLimit >= announcementsData.length) {
        loadMoreBtn.style.display = 'none';
    }
}

// GÃ¶sterilen duyuru sayÄ±sÄ±nÄ± deÄŸiÅŸtir
function changeAnnouncementLimit(value) {
    announcementsLimit = parseInt(value) || 5;
    renderAnnouncements();
    
    // Daha fazla butonu gÃ¼ncelle
    const loadMoreBtn = document.getElementById('loadMoreAnnouncements');
    if (loadMoreBtn) {
        loadMoreBtn.style.display = announcementsData.length > announcementsLimit ? 'block' : 'none';
    }
}

// Duyuru ekleme/dÃ¼zenleme modalÄ±
function showAddAnnouncementModal(editId = null) {
    const branches = STATE.branches || [];
    const isEdit = !!editId;
    
    // DÃ¼zenleme modunda mevcut veriyi al
    let editData = null;
    if (isEdit) {
        editData = announcementsData.find(a => a.id === editId);
        if (!editData) {
            toast('Duyuru bulunamadÄ±', 'error');
            return;
        }
    }
    
    const currentType = editData?.type || 'info';
    const currentBranches = editData?.branches || ['all'];
    const currentAnimation = editData?.animation || 'none';
    const isAllBranches = currentBranches.includes('all');
    
    const bodyHtml = `
        <div style="margin-bottom:16px">
            <label style="display:block;font-size:.8rem;font-weight:600;color:var(--tx2);margin-bottom:6px">BaÅŸlÄ±k</label>
            <input type="text" id="announcementTitle" placeholder="Duyuru baÅŸlÄ±ÄŸÄ±..." value="${editData?.title || ''}"
                style="width:100%;padding:12px;border:1px solid var(--cardBorder);border-radius:8px;font-size:.9rem;background:var(--bg2);color:var(--tx)">
        </div>
        
        <div style="margin-bottom:16px">
            <label style="display:block;font-size:.8rem;font-weight:600;color:var(--tx2);margin-bottom:6px">Ä°Ã§erik</label>
            <textarea id="announcementContent" rows="3" placeholder="Duyuru iÃ§eriÄŸi..." 
                style="width:100%;padding:12px;border:1px solid var(--cardBorder);border-radius:8px;font-size:.9rem;background:var(--bg2);color:var(--tx);resize:vertical">${editData?.content || ''}</textarea>
        </div>
        
        <div style="margin-bottom:16px">
            <label style="display:block;font-size:.8rem;font-weight:600;color:var(--tx2);margin-bottom:6px">Duyuru TÃ¼rÃ¼</label>
            <div style="display:flex;flex-wrap:wrap;gap:8px">
                <label class="announcement-type-option" data-type="info" style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--bg3);border:2px solid var(--bg4);border-radius:10px;cursor:pointer;transition:all .2s">
                    <input type="radio" name="announcementType" value="info" ${currentType === 'info' ? 'checked' : ''} style="display:none">
                    <svg width="18" height="18" fill="none" stroke="#3498db" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                    <span style="font-size:.85rem;font-weight:500">Bilgilendirme</span>
                </label>
                <label class="announcement-type-option" data-type="success" style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--bg3);border:2px solid var(--bg4);border-radius:10px;cursor:pointer;transition:all .2s">
                    <input type="radio" name="announcementType" value="success" ${currentType === 'success' ? 'checked' : ''} style="display:none">
                    <svg width="18" height="18" fill="none" stroke="#27ae60" stroke-width="2" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                    <span style="font-size:.85rem;font-weight:500">Ä°yi Haber</span>
                </label>
                <label class="announcement-type-option" data-type="warning" style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--bg3);border:2px solid var(--bg4);border-radius:10px;cursor:pointer;transition:all .2s">
                    <input type="radio" name="announcementType" value="warning" ${currentType === 'warning' ? 'checked' : ''} style="display:none">
                    <svg width="18" height="18" fill="none" stroke="#f39c12" stroke-width="2" viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                    <span style="font-size:.85rem;font-weight:500">UyarÄ±</span>
                </label>
                <label class="announcement-type-option" data-type="urgent" style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--bg3);border:2px solid var(--bg4);border-radius:10px;cursor:pointer;transition:all .2s">
                    <input type="radio" name="announcementType" value="urgent" ${currentType === 'urgent' ? 'checked' : ''} style="display:none">
                    <svg width="18" height="18" fill="none" stroke="#e74c3c" stroke-width="2" viewBox="0 0 24 24"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                    <span style="font-size:.85rem;font-weight:500">Acil</span>
                </label>
                <label class="announcement-type-option" data-type="celebration" style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--bg3);border:2px solid var(--bg4);border-radius:10px;cursor:pointer;transition:all .2s">
                    <input type="radio" name="announcementType" value="celebration" ${currentType === 'celebration' ? 'checked' : ''} style="display:none">
                    <svg width="18" height="18" fill="none" stroke="#9b59b6" stroke-width="2" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                    <span style="font-size:.85rem;font-weight:500">Kutlama</span>
                </label>
            </div>
        </div>
        
        <div style="margin-bottom:16px">
            <label style="display:block;font-size:.8rem;font-weight:600;color:var(--tx2);margin-bottom:6px">Animasyon</label>
            <div style="display:flex;flex-wrap:wrap;gap:8px">
                <button type="button" class="animation-option ${currentAnimation === 'none' ? 'selected' : ''}" data-animation="none" 
                    style="padding:8px 14px;background:var(--bg3);border:2px solid ${currentAnimation === 'none' ? '#008c95' : 'var(--bg4)'};border-radius:8px;cursor:pointer;font-size:.8rem;color:var(--tx)">
                    Yok
                </button>
                <button type="button" class="animation-option ${currentAnimation === 'pulse' ? 'selected' : ''}" data-animation="pulse" 
                    style="padding:8px 14px;background:var(--bg3);border:2px solid ${currentAnimation === 'pulse' ? '#008c95' : 'var(--bg4)'};border-radius:8px;cursor:pointer;font-size:.8rem;color:var(--tx);animation:ann-pulse 2s ease-in-out infinite">
                    NabÄ±z
                </button>
                <button type="button" class="animation-option ${currentAnimation === 'shake' ? 'selected' : ''}" data-animation="shake" 
                    style="padding:8px 14px;background:var(--bg3);border:2px solid ${currentAnimation === 'shake' ? '#008c95' : 'var(--bg4)'};border-radius:8px;cursor:pointer;font-size:.8rem;color:var(--tx);animation:ann-shake 1s ease-in-out infinite">
                    Sallama
                </button>
                <button type="button" class="animation-option ${currentAnimation === 'glow' ? 'selected' : ''}" data-animation="glow" 
                    style="padding:8px 14px;background:var(--bg3);border:2px solid ${currentAnimation === 'glow' ? '#008c95' : 'var(--bg4)'};border-radius:8px;cursor:pointer;font-size:.8rem;color:var(--tx);animation:ann-glow 2s ease-in-out infinite">
                    Parlama
                </button>
                <button type="button" class="animation-option ${currentAnimation === 'bounce' ? 'selected' : ''}" data-animation="bounce" 
                    style="padding:8px 14px;background:var(--bg3);border:2px solid ${currentAnimation === 'bounce' ? '#008c95' : 'var(--bg4)'};border-radius:8px;cursor:pointer;font-size:.8rem;color:var(--tx);animation:ann-bounce 1s ease-in-out infinite">
                    ZÄ±plama
                </button>
                <button type="button" class="animation-option ${currentAnimation === 'slide' ? 'selected' : ''}" data-animation="slide" 
                    style="padding:8px 14px;background:var(--bg3);border:2px solid ${currentAnimation === 'slide' ? '#008c95' : 'var(--bg4)'};border-radius:8px;cursor:pointer;font-size:.8rem;color:var(--tx);animation:ann-slide 1.5s ease-in-out infinite">
                    Kayma
                </button>
                <button type="button" class="animation-option ${currentAnimation === 'blink' ? 'selected' : ''}" data-animation="blink" 
                    style="padding:8px 14px;background:var(--bg3);border:2px solid ${currentAnimation === 'blink' ? '#008c95' : 'var(--bg4)'};border-radius:8px;cursor:pointer;font-size:.8rem;color:var(--tx);animation:ann-blink 1s ease-in-out infinite">
                    YanÄ±p SÃ¶nme
                </button>
                <button type="button" class="animation-option ${currentAnimation === 'heartbeat' ? 'selected' : ''}" data-animation="heartbeat" 
                    style="padding:8px 14px;background:var(--bg3);border:2px solid ${currentAnimation === 'heartbeat' ? '#008c95' : 'var(--bg4)'};border-radius:8px;cursor:pointer;font-size:.8rem;color:var(--tx);animation:ann-heartbeat 1.5s ease-in-out infinite">
                    Kalp AtÄ±ÅŸÄ±
                </button>
                <button type="button" class="animation-option ${currentAnimation === 'swing' ? 'selected' : ''}" data-animation="swing" 
                    style="padding:8px 14px;background:var(--bg3);border:2px solid ${currentAnimation === 'swing' ? '#008c95' : 'var(--bg4)'};border-radius:8px;cursor:pointer;font-size:.8rem;color:var(--tx);animation:ann-swing 1s ease-in-out infinite">
                    Sallanma
                </button>
                <button type="button" class="animation-option ${currentAnimation === 'tada' ? 'selected' : ''}" data-animation="tada" 
                    style="padding:8px 14px;background:var(--bg3);border:2px solid ${currentAnimation === 'tada' ? '#008c95' : 'var(--bg4)'};border-radius:8px;cursor:pointer;font-size:.8rem;color:var(--tx);animation:ann-tada 1.5s ease-in-out infinite">
                    Tada
                </button>
                <button type="button" class="animation-option ${currentAnimation === 'rubber' ? 'selected' : ''}" data-animation="rubber" 
                    style="padding:8px 14px;background:var(--bg3);border:2px solid ${currentAnimation === 'rubber' ? '#008c95' : 'var(--bg4)'};border-radius:8px;cursor:pointer;font-size:.8rem;color:var(--tx);animation:ann-rubber 1s ease-in-out infinite">
                    Esnek
                </button>
                <button type="button" class="animation-option ${currentAnimation === 'flash' ? 'selected' : ''}" data-animation="flash" 
                    style="padding:8px 14px;background:var(--bg3);border:2px solid ${currentAnimation === 'flash' ? '#008c95' : 'var(--bg4)'};border-radius:8px;cursor:pointer;font-size:.8rem;color:var(--tx);animation:ann-flash 1.5s ease-in-out infinite">
                    FlaÅŸ
                </button>
            </div>
            <input type="hidden" id="announcementAnimation" value="${currentAnimation}">
        </div>
        
        <div style="margin-bottom:16px">
            <label style="display:block;font-size:.8rem;font-weight:600;color:var(--tx2);margin-bottom:6px">Otomatik Silinme</label>
            <div style="display:flex;align-items:center;gap:10px">
                <select id="announcementAutoDelete" style="padding:8px 12px;border:1px solid var(--cardBorder);border-radius:8px;font-size:.85rem;background:var(--bg2);color:var(--tx);cursor:pointer">
                    <option value="0" ${!editData?.expiresAt ? 'selected' : ''}>Silinmesin</option>
                    <option value="1" ${editData?.expiresDays === 1 ? 'selected' : ''}>1 gÃ¼n sonra</option>
                    <option value="3" ${editData?.expiresDays === 3 ? 'selected' : ''}>3 gÃ¼n sonra</option>
                    <option value="7" ${editData?.expiresDays === 7 ? 'selected' : ''}>7 gÃ¼n sonra</option>
                    <option value="14" ${editData?.expiresDays === 14 ? 'selected' : ''}>14 gÃ¼n sonra</option>
                    <option value="30" ${editData?.expiresDays === 30 ? 'selected' : ''}>30 gÃ¼n sonra</option>
                </select>
                <span style="font-size:.75rem;color:var(--tx3)">SÃ¼re dolunca duyuru otomatik silinir</span>
            </div>
        </div>
        
        <div style="margin-bottom:16px">
            <label style="display:block;font-size:.8rem;font-weight:600;color:var(--tx2);margin-bottom:6px">Hedef Åžubeler</label>
            <div id="branchSelectionContainer" style="display:flex;flex-wrap:wrap;gap:8px">
                <label class="branch-option ${isAllBranches ? 'selected' : ''}" data-branch="all" 
                    style="display:flex;align-items:center;gap:6px;padding:8px 12px;background:${isAllBranches ? 'rgba(0,140,149,.1)' : 'var(--bg3)'};border:2px solid ${isAllBranches ? '#008c95' : 'var(--bg4)'};border-radius:8px;cursor:pointer;font-size:.85rem;transition:all .2s">
                    <span>TÃ¼m Åžubeler</span>
                </label>
                ${branches.map(b => `
                    <label class="branch-option ${!isAllBranches && currentBranches.includes(b) ? 'selected' : ''}" data-branch="${b}" 
                        style="display:flex;align-items:center;gap:6px;padding:8px 12px;background:${!isAllBranches && currentBranches.includes(b) ? 'rgba(0,140,149,.1)' : 'var(--bg3)'};border:2px solid ${!isAllBranches && currentBranches.includes(b) ? '#008c95' : 'var(--bg4)'};border-radius:8px;cursor:pointer;font-size:.85rem;transition:all .2s">
                        <span>${b}</span>
                    </label>
                `).join('')}
            </div>
        </div>
    `;
    
    const footerHtml = `
        <button class="btn btn-ghost" onclick="closeModal()">Ä°ptal</button>
        <button class="btn btn-primary" onclick="saveAnnouncement('${editId || ''}')" style="background:linear-gradient(135deg,#ff8674,#ff6b5b);border:none">${isEdit ? 'Kaydet' : 'Duyuru Ekle'}</button>
    `;
    
    showModal(isEdit ? 'Duyuruyu DÃ¼zenle' : 'Yeni Duyuru', bodyHtml, footerHtml);
    
    // Event listener'larÄ± ekle
    setTimeout(() => {
        // Duyuru tÃ¼rÃ¼ seÃ§imi
        document.querySelectorAll('.announcement-type-option').forEach(opt => {
            opt.addEventListener('click', function() {
                document.querySelectorAll('.announcement-type-option').forEach(o => {
                    o.style.borderColor = 'var(--bg4)';
                    o.style.background = 'var(--bg3)';
                });
                this.style.borderColor = '#008c95';
                this.style.background = 'rgba(0,140,149,.1)';
                this.querySelector('input').checked = true;
            });
            if (opt.querySelector('input:checked')) {
                opt.style.borderColor = '#008c95';
                opt.style.background = 'rgba(0,140,149,.1)';
            }
        });
        
        // Animasyon seÃ§imi
        document.querySelectorAll('.animation-option').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.animation-option').forEach(b => {
                    b.style.borderColor = 'var(--bg4)';
                    b.classList.remove('selected');
                });
                this.style.borderColor = '#008c95';
                this.classList.add('selected');
                document.getElementById('announcementAnimation').value = this.dataset.animation;
            });
        });
        
        // Åžube seÃ§imi
        document.querySelectorAll('.branch-option').forEach(label => {
            label.addEventListener('click', function() {
                const branch = this.dataset.branch;
                const allOption = document.querySelector('.branch-option[data-branch="all"]');
                
                if (branch === 'all') {
                    // TÃ¼m ÅŸubeler seÃ§ildi - diÄŸerlerini kaldÄ±r
                    document.querySelectorAll('.branch-option').forEach(l => {
                        l.classList.remove('selected');
                        l.style.borderColor = 'var(--bg4)';
                        l.style.background = 'var(--bg3)';
                    });
                    this.classList.add('selected');
                    this.style.borderColor = '#008c95';
                    this.style.background = 'rgba(0,140,149,.1)';
                } else {
                    // Tek ÅŸube seÃ§ildi
                    if (allOption.classList.contains('selected')) {
                        // TÃ¼m ÅŸubeler seÃ§iliydi - kaldÄ±r
                        allOption.classList.remove('selected');
                        allOption.style.borderColor = 'var(--bg4)';
                        allOption.style.background = 'var(--bg3)';
                    }
                    // Bu ÅŸubeyi toggle et
                    this.classList.toggle('selected');
                    if (this.classList.contains('selected')) {
                        this.style.borderColor = '#008c95';
                        this.style.background = 'rgba(0,140,149,.1)';
                    } else {
                        this.style.borderColor = 'var(--bg4)';
                        this.style.background = 'var(--bg3)';
                    }
                    
                    // HiÃ§ ÅŸube seÃ§ili deÄŸilse "TÃ¼m Åžubeler"i seÃ§
                    const selectedBranches = document.querySelectorAll('.branch-option.selected:not([data-branch="all"])');
                    if (selectedBranches.length === 0) {
                        allOption.classList.add('selected');
                        allOption.style.borderColor = '#008c95';
                        allOption.style.background = 'rgba(0,140,149,.1)';
                    }
                }
            });
        });
    }, 100);
}

// Duyuru kaydet (ekleme veya dÃ¼zenleme)
async function saveAnnouncement(editId = '') {
    const title = document.getElementById('announcementTitle')?.value?.trim();
    const content = document.getElementById('announcementContent')?.value?.trim();
    const announcementType = document.querySelector('input[name="announcementType"]:checked')?.value || 'info';
    const animation = document.getElementById('announcementAnimation')?.value || 'none';
    const autoDeleteDays = parseInt(document.getElementById('announcementAutoDelete')?.value) || 0;
    
    if (!title) {
        toast('BaÅŸlÄ±k gerekli', 'error');
        return;
    }
    
    // SeÃ§ili ÅŸubeleri al (yeni label-based seÃ§im)
    const allSelected = document.querySelector('.branch-option[data-branch="all"].selected');
    let branches = ['all'];
    if (!allSelected) {
        branches = Array.from(document.querySelectorAll('.branch-option.selected:not([data-branch="all"])')).map(l => l.dataset.branch);
        if (branches.length === 0) {
            toast('En az bir ÅŸube seÃ§in', 'error');
            return;
        }
    }
    
    const data = {
        title,
        content,
        branches,
        type: announcementType,
        animation,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    // Otomatik silinme
    if (autoDeleteDays > 0) {
        const expiresAt = new Date();
        expiresAt.setDate(expiresAt.getDate() + autoDeleteDays);
        data.expiresAt = firebase.firestore.Timestamp.fromDate(expiresAt);
        data.expiresDays = autoDeleteDays;
    } else {
        data.expiresAt = null;
        data.expiresDays = null;
    }
    
    try {
        if (editId) {
            // DÃ¼zenleme
            await db.collection('announcements').doc(editId).update(data);
            toast('Duyuru gÃ¼ncellendi', 'success');
        } else {
            // Yeni ekleme
            data.createdBy = currentUser?.id || 'unknown';
            data.createdByName = currentUser?.codeName?.split(' ')[0] || currentUser?.name?.split(' ')[0] || 'YÃ¶netici';
            data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            await db.collection('announcements').add(data);
            toast('Duyuru eklendi', 'success');
        }
        
        closeModal();
        loadAnnouncements();
    } catch (e) {
        console.error('Duyuru kaydedilemedi:', e);
        toast('Duyuru kaydedilemedi', 'error');
    }
}

// Duyuru sil
async function deleteAnnouncement(id) {
    if (!confirm('Bu duyuruyu silmek istediÄŸinizden emin misiniz?')) return;
    
    try {
        await db.collection('announcements').doc(id).delete();
        toast('Duyuru silindi', 'success');
        loadAnnouncements();
    } catch (e) {
        console.error('Duyuru silinemedi:', e);
        toast('Duyuru silinemedi', 'error');
    }
}
    </script>
</body>
</html>
