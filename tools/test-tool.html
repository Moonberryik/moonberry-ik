<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ª Moonberry Ä°K - Test Tool v2</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <style>
        :root{--bg:#0d1117;--cardBg:#161b22;--tx:#e6edf3;--tx2:#8b949e;--accent:#008c95;--success:#27ae60;--error:#e74c3c;--warn:#f39c12}
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:'Segoe UI',sans-serif;background:var(--bg);color:var(--tx);padding:20px;min-height:100vh}
        h1{font-size:1.5rem;margin-bottom:20px;display:flex;align-items:center;gap:10px}
        .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:30px}
        .card{background:var(--cardBg);border-radius:12px;padding:20px}
        .card h3{font-size:1rem;margin-bottom:15px;display:flex;align-items:center;gap:8px}
        .btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-size:.9rem;transition:all .2s;display:inline-flex;align-items:center;gap:8px;margin:5px}
        .btn-primary{background:var(--accent);color:#fff}
        .btn-success{background:var(--success);color:#fff}
        .btn-error{background:var(--error);color:#fff}
        .btn-warn{background:var(--warn);color:#000}
        .btn:hover{filter:brightness(1.1)}
        .log{background:#0d1117;border:1px solid #30363d;border-radius:8px;padding:15px;font-family:monospace;font-size:.85rem;max-height:400px;overflow-y:auto;white-space:pre-wrap}
        .log-entry{padding:5px 0;border-bottom:1px solid #21262d}
        .log-entry.success{color:var(--success)}
        .log-entry.error{color:var(--error)}
        .log-entry.warn{color:var(--warn)}
        .log-entry.info{color:var(--accent)}
        .status{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:4px;font-size:.8rem}
        .status.ok{background:rgba(39,174,96,.2);color:var(--success)}
        .status.fail{background:rgba(231,76,60,.2);color:var(--error)}
        .status.pending{background:rgba(139,148,158,.2);color:var(--tx2)}
        .test-list{display:flex;flex-direction:column;gap:8px}
        .test-item{display:flex;justify-content:space-between;align-items:center;padding:10px;background:#21262d;border-radius:6px}
        .summary{display:flex;gap:20px;margin-bottom:20px}
        .summary-item{text-align:center;padding:15px;background:var(--cardBg);border-radius:10px;flex:1}
        .summary-value{font-size:2rem;font-weight:700}
        .summary-value.success{color:var(--success)}
        .summary-value.error{color:var(--error)}
    </style>
</head>
<body>
    <h1>ğŸ§ª Moonberry Ä°K - Test Tool v2 (ModÃ¼ler)</h1>
    
    <div class="summary">
        <div class="summary-item"><div class="summary-value" id="totalTests">0</div><div>Toplam</div></div>
        <div class="summary-item"><div class="summary-value success" id="passedTests">0</div><div>BaÅŸarÄ±lÄ±</div></div>
        <div class="summary-item"><div class="summary-value error" id="failedTests">0</div><div>BaÅŸarÄ±sÄ±z</div></div>
    </div>
    
    <div class="grid">
        <div class="card">
            <h3>ğŸ”¥ Firebase</h3>
            <div class="test-list" id="firebaseTests">
                <div class="test-item">Firebase Init <span class="status pending">â³</span></div>
                <div class="test-item">Firestore <span class="status pending">â³</span></div>
                <div class="test-item">Auth <span class="status pending">â³</span></div>
            </div>
            <button class="btn btn-primary" onclick="testFirebase()">â–¶ï¸ Test</button>
        </div>
        
        <div class="card">
            <h3>ğŸ“¦ JS ModÃ¼ller</h3>
            <div class="test-list" id="moduleTests">
                <div class="test-item">utils.js <span class="status pending">â³</span></div>
                <div class="test-item">dashboard.js <span class="status pending">â³</span></div>
                <div class="test-item">checklist.js <span class="status pending">â³</span></div>
                <div class="test-item">shift.js <span class="status pending">â³</span></div>
                <div class="test-item">puantaj.js <span class="status pending">â³</span></div>
                <div class="test-item">personel.js <span class="status pending">â³</span></div>
                <div class="test-item">belgeler.js <span class="status pending">â³</span></div>
                <div class="test-item">admin.js <span class="status pending">â³</span></div>
            </div>
            <button class="btn btn-primary" onclick="testModules()">â–¶ï¸ Test</button>
        </div>
        
        <div class="card">
            <h3>ğŸ“„ HTML Åablonlar</h3>
            <div class="test-list" id="pageTests">
                <div class="test-item">dashboard.html <span class="status pending">â³</span></div>
                <div class="test-item">checklist.html <span class="status pending">â³</span></div>
                <div class="test-item">shift.html <span class="status pending">â³</span></div>
                <div class="test-item">puantaj.html <span class="status pending">â³</span></div>
                <div class="test-item">personel.html <span class="status pending">â³</span></div>
                <div class="test-item">admin.html <span class="status pending">â³</span></div>
            </div>
            <button class="btn btn-primary" onclick="testPages()">â–¶ï¸ Test</button>
        </div>
        
        <div class="card">
            <h3>âš¡ Fonksiyonlar</h3>
            <div class="test-list" id="functionTests">
                <div class="test-item">formatDateLocal <span class="status pending">â³</span></div>
                <div class="test-item">normalizePersonelId <span class="status pending">â³</span></div>
                <div class="test-item">getPersonelDisplayName <span class="status pending">â³</span></div>
                <div class="test-item">isManager <span class="status pending">â³</span></div>
                <div class="test-item">showToast <span class="status pending">â³</span></div>
            </div>
            <button class="btn btn-primary" onclick="testFunctions()">â–¶ï¸ Test</button>
        </div>
    </div>
    
    <div class="card">
        <button class="btn btn-success" onclick="runAllTests()">ğŸš€ TÃœM TESTLER</button>
        <button class="btn btn-warn" onclick="clearLog()">ğŸ—‘ï¸ Temizle</button>
        <button class="btn btn-primary" onclick="exportResults()">ğŸ“‹ Kopyala</button>
    </div>
    
    <div class="card" style="margin-top:20px">
        <h3>ğŸ“‹ Log</h3>
        <div class="log" id="testLog"></div>
    </div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyCbc-8oWwOj2eR0J19f3T-UYT9vGI8PL7M",
    authDomain: "moonberry-ik.firebaseapp.com",
    projectId: "moonberry-ik",
    storageBucket: "moonberry-ik.firebasestorage.app",
    messagingSenderId: "4872042742",
    appId: "1:4872042742:web:24a9e5935e2b5591a794d7"
};

let db = null;
let testResults = { total: 0, passed: 0, failed: 0 };

function log(msg, type = 'info') {
    const logEl = document.getElementById('testLog');
    const time = new Date().toLocaleTimeString('tr-TR');
    logEl.innerHTML += `<div class="log-entry ${type}">[${time}] ${msg}</div>`;
    logEl.scrollTop = logEl.scrollHeight;
}

function updateTestResult(container, index, passed) {
    const items = document.querySelectorAll(`#${container} .test-item`);
    if (items[index]) {
        const status = items[index].querySelector('.status');
        status.className = `status ${passed ? 'ok' : 'fail'}`;
        status.textContent = passed ? 'âœ“' : 'âœ•';
    }
    testResults.total++;
    if (passed) testResults.passed++; else testResults.failed++;
    document.getElementById('totalTests').textContent = testResults.total;
    document.getElementById('passedTests').textContent = testResults.passed;
    document.getElementById('failedTests').textContent = testResults.failed;
}

async function testFirebase() {
    log('ğŸ”¥ Firebase testleri...', 'info');
    try {
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        updateTestResult('firebaseTests', 0, true);
        log('  âœ“ Firebase Init', 'success');
    } catch (e) {
        updateTestResult('firebaseTests', 0, false);
        log('  âœ• Firebase Init: ' + e.message, 'error');
        return;
    }
    try {
        await db.collection('systemConfig').doc('general').get();
        updateTestResult('firebaseTests', 1, true);
        log('  âœ“ Firestore', 'success');
    } catch (e) {
        updateTestResult('firebaseTests', 1, false);
        log('  âœ• Firestore: ' + e.message, 'error');
    }
    try {
        firebase.auth();
        updateTestResult('firebaseTests', 2, true);
        log('  âœ“ Auth', 'success');
    } catch (e) {
        updateTestResult('firebaseTests', 2, false);
        log('  âœ• Auth: ' + e.message, 'error');
    }
}

async function testModules() {
    log('ğŸ“¦ ModÃ¼l testleri...', 'info');
    const modules = [
        { path: '../js/modules/utils.js', check: () => typeof formatDateLocal === 'function' },
        { path: '../js/modules/dashboard.js', check: () => typeof initDashboardPage === 'function' },
        { path: '../js/modules/checklist.js', check: () => typeof initChecklistPage === 'function' },
        { path: '../js/modules/shift.js', check: () => typeof initShiftPage === 'function' },
        { path: '../js/modules/puantaj.js', check: () => typeof initPuantajPage === 'function' },
        { path: '../js/modules/personel.js', check: () => typeof initPersonelPage === 'function' },
        { path: '../js/modules/belgeler.js', check: () => typeof initSozlesmePage === 'function' },
        { path: '../js/modules/admin.js', check: () => typeof initAdminPage === 'function' },
    ];
    for (let i = 0; i < modules.length; i++) {
        const mod = modules[i];
        try {
            if (!mod.check()) {
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = mod.path;
                    script.onload = () => setTimeout(resolve, 50);
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            }
            const passed = mod.check();
            updateTestResult('moduleTests', i, passed);
            log(`  ${passed ? 'âœ“' : 'âœ•'} ${mod.path.split('/').pop()}`, passed ? 'success' : 'error');
        } catch (e) {
            updateTestResult('moduleTests', i, false);
            log(`  âœ• ${mod.path.split('/').pop()}: ${e.message}`, 'error');
        }
    }
}

async function testPages() {
    log('ğŸ“„ Sayfa testleri...', 'info');
    const pages = ['dashboard', 'checklist', 'shift', 'puantaj', 'personel', 'admin'];
    for (let i = 0; i < pages.length; i++) {
        try {
            const response = await fetch(`../pages/${pages[i]}.html`);
            const passed = response.ok;
            updateTestResult('pageTests', i, passed);
            log(`  ${passed ? 'âœ“' : 'âœ•'} ${pages[i]}.html`, passed ? 'success' : 'error');
        } catch (e) {
            updateTestResult('pageTests', i, false);
            log(`  âœ• ${pages[i]}.html: ${e.message}`, 'error');
        }
    }
}

async function testFunctions() {
    log('âš¡ Fonksiyon testleri...', 'info');
    if (typeof formatDateLocal !== 'function') await testModules();
    const tests = [
        () => formatDateLocal(new Date()).match(/^\d{4}-\d{2}-\d{2}$/),
        () => normalizePersonelId('BÃœÅRA SÃ–ÄÃœT') === 'busra_sogut',
        () => getPersonelDisplayName({ name: 'BÃœÅRA SÃ–ÄÃœT' }) === 'BÃ¼ÅŸra S.',
        () => isManager('yonetici') === true && isManager('barista') === false,
        () => typeof showToast === 'function',
    ];
    for (let i = 0; i < tests.length; i++) {
        try {
            const passed = tests[i]();
            updateTestResult('functionTests', i, passed);
            log(`  ${passed ? 'âœ“' : 'âœ•'} Fonksiyon ${i+1}`, passed ? 'success' : 'error');
        } catch (e) {
            updateTestResult('functionTests', i, false);
            log(`  âœ• Fonksiyon ${i+1}: ${e.message}`, 'error');
        }
    }
}

async function runAllTests() {
    testResults = { total: 0, passed: 0, failed: 0 };
    log('ğŸš€ TÃœM TESTLER BAÅLIYOR...', 'info');
    await testFirebase();
    await testModules();
    await testPages();
    await testFunctions();
    const pct = Math.round(testResults.passed / testResults.total * 100);
    log(`ğŸ“Š SONUÃ‡: ${testResults.passed}/${testResults.total} (%${pct})`, testResults.failed === 0 ? 'success' : 'warn');
}

function clearLog() {
    document.getElementById('testLog').innerHTML = '';
    testResults = { total: 0, passed: 0, failed: 0 };
    document.getElementById('totalTests').textContent = 0;
    document.getElementById('passedTests').textContent = 0;
    document.getElementById('failedTests').textContent = 0;
    document.querySelectorAll('.status').forEach(s => { s.className = 'status pending'; s.textContent = 'â³'; });
}

function exportResults() {
    const log = document.getElementById('testLog').innerText;
    navigator.clipboard.writeText(`Test SonuÃ§larÄ±: ${testResults.passed}/${testResults.total}\n\n${log}`);
    alert('KopyalandÄ±!');
}

log('ğŸ§ª Test Tool v2 hazÄ±r', 'info');
</script>
</body>
</html>
